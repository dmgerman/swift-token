begin_unit
comment|'# Copyright (c) 2013 OpenStack Foundation'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
nl|'\n'
name|'import'
name|'eventlet'
newline|'\n'
name|'import'
name|'eventlet'
op|'.'
name|'wsgi'
newline|'\n'
name|'import'
name|'eventlet'
op|'.'
name|'greenio'
newline|'\n'
name|'from'
name|'six'
op|'.'
name|'moves'
name|'import'
name|'urllib'
newline|'\n'
nl|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'exceptions'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'http'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'swob'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'utils'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'request_helpers'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'Timestamp'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|decode_missing
name|'def'
name|'decode_missing'
op|'('
name|'line'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Parse a string of the form generated by\n    :py:func:`~swift.obj.ssync_sender.encode_missing` and return a dict\n    with keys ``object_hash``, ``ts_data``, ``ts_meta``, ``ts_ctype``.\n\n    The encoder for this line is\n    :py:func:`~swift.obj.ssync_sender.encode_missing`\n    """'
newline|'\n'
name|'result'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'parts'
op|'='
name|'line'
op|'.'
name|'split'
op|'('
op|')'
newline|'\n'
name|'result'
op|'['
string|"'object_hash'"
op|']'
op|'='
name|'urllib'
op|'.'
name|'parse'
op|'.'
name|'unquote'
op|'('
name|'parts'
op|'['
number|'0'
op|']'
op|')'
newline|'\n'
name|'t_data'
op|'='
name|'urllib'
op|'.'
name|'parse'
op|'.'
name|'unquote'
op|'('
name|'parts'
op|'['
number|'1'
op|']'
op|')'
newline|'\n'
name|'result'
op|'['
string|"'ts_data'"
op|']'
op|'='
name|'Timestamp'
op|'('
name|'t_data'
op|')'
newline|'\n'
name|'result'
op|'['
string|"'ts_meta'"
op|']'
op|'='
name|'result'
op|'['
string|"'ts_ctype'"
op|']'
op|'='
name|'result'
op|'['
string|"'ts_data'"
op|']'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'parts'
op|')'
op|'>'
number|'2'
op|':'
newline|'\n'
comment|'# allow for a comma separated list of k:v pairs to future-proof'
nl|'\n'
indent|'        '
name|'subparts'
op|'='
name|'urllib'
op|'.'
name|'parse'
op|'.'
name|'unquote'
op|'('
name|'parts'
op|'['
number|'2'
op|']'
op|')'
op|'.'
name|'split'
op|'('
string|"','"
op|')'
newline|'\n'
name|'for'
name|'item'
name|'in'
op|'['
name|'subpart'
name|'for'
name|'subpart'
name|'in'
name|'subparts'
name|'if'
string|"':'"
name|'in'
name|'subpart'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'k'
op|','
name|'v'
op|'='
name|'item'
op|'.'
name|'split'
op|'('
string|"':'"
op|')'
newline|'\n'
name|'if'
name|'k'
op|'=='
string|"'m'"
op|':'
newline|'\n'
indent|'                '
name|'result'
op|'['
string|"'ts_meta'"
op|']'
op|'='
name|'Timestamp'
op|'('
name|'t_data'
op|','
name|'delta'
op|'='
name|'int'
op|'('
name|'v'
op|','
number|'16'
op|')'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'k'
op|'=='
string|"'t'"
op|':'
newline|'\n'
indent|'                '
name|'result'
op|'['
string|"'ts_ctype'"
op|']'
op|'='
name|'Timestamp'
op|'('
name|'t_data'
op|','
name|'delta'
op|'='
name|'int'
op|'('
name|'v'
op|','
number|'16'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'return'
name|'result'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|encode_wanted
dedent|''
name|'def'
name|'encode_wanted'
op|'('
name|'remote'
op|','
name|'local'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Compare a remote and local results and generate a wanted line.\n\n    :param remote: a dict, with ts_data and ts_meta keys in the form\n                   returned by :py:func:`decode_missing`\n    :param local: a dict, possibly empty, with ts_data and ts_meta keys\n                  in the form returned :py:meth:`Receiver._check_local`\n\n    The decoder for this line is\n    :py:func:`~swift.obj.ssync_sender.decode_wanted`\n    """'
newline|'\n'
name|'want'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'if'
string|"'ts_data'"
name|'in'
name|'local'
op|':'
newline|'\n'
comment|"# we have something, let's get just the right stuff"
nl|'\n'
indent|'        '
name|'if'
name|'remote'
op|'['
string|"'ts_data'"
op|']'
op|'>'
name|'local'
op|'['
string|"'ts_data'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'want'
op|'['
string|"'data'"
op|']'
op|'='
name|'True'
newline|'\n'
dedent|''
name|'if'
string|"'ts_meta'"
name|'in'
name|'local'
name|'and'
name|'remote'
op|'['
string|"'ts_meta'"
op|']'
op|'>'
name|'local'
op|'['
string|"'ts_meta'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'want'
op|'['
string|"'meta'"
op|']'
op|'='
name|'True'
newline|'\n'
dedent|''
name|'if'
op|'('
string|"'ts_ctype'"
name|'in'
name|'local'
name|'and'
name|'remote'
op|'['
string|"'ts_ctype'"
op|']'
op|'>'
name|'local'
op|'['
string|"'ts_ctype'"
op|']'
nl|'\n'
name|'and'
name|'remote'
op|'['
string|"'ts_ctype'"
op|']'
op|'>'
name|'remote'
op|'['
string|"'ts_data'"
op|']'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'want'
op|'['
string|"'meta'"
op|']'
op|'='
name|'True'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
comment|"# we got nothing, so we'll take whatever the remote has"
nl|'\n'
indent|'        '
name|'want'
op|'['
string|"'data'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'want'
op|'['
string|"'meta'"
op|']'
op|'='
name|'True'
newline|'\n'
dedent|''
name|'if'
name|'want'
op|':'
newline|'\n'
comment|"# this is the inverse of _decode_wanted's key_map"
nl|'\n'
indent|'        '
name|'key_map'
op|'='
name|'dict'
op|'('
name|'data'
op|'='
string|"'d'"
op|','
name|'meta'
op|'='
string|"'m'"
op|')'
newline|'\n'
name|'parts'
op|'='
string|"''"
op|'.'
name|'join'
op|'('
name|'v'
name|'for'
name|'k'
op|','
name|'v'
name|'in'
name|'sorted'
op|'('
name|'key_map'
op|'.'
name|'items'
op|'('
op|')'
op|')'
name|'if'
name|'want'
op|'.'
name|'get'
op|'('
name|'k'
op|')'
op|')'
newline|'\n'
name|'return'
string|"'%s %s'"
op|'%'
op|'('
name|'urllib'
op|'.'
name|'parse'
op|'.'
name|'quote'
op|'('
name|'remote'
op|'['
string|"'object_hash'"
op|']'
op|')'
op|','
name|'parts'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'None'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|Receiver
dedent|''
name|'class'
name|'Receiver'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Handles incoming SSYNC requests to the object server.\n\n    These requests come from the object-replicator daemon that uses\n    :py:mod:`.ssync_sender`.\n\n    The number of concurrent SSYNC requests is restricted by\n    use of a replication_semaphore and can be configured with the\n    object-server.conf [object-server] replication_concurrency\n    setting.\n\n    An SSYNC request is really just an HTTP conduit for\n    sender/receiver replication communication. The overall\n    SSYNC request should always succeed, but it will contain\n    multiple requests within its request and response bodies. This\n    "hack" is done so that replication concurrency can be managed.\n\n    The general process inside an SSYNC request is:\n\n        1. Initialize the request: Basic request validation, mount check,\n           acquire semaphore lock, etc..\n\n        2. Missing check: Sender sends the hashes and timestamps of\n           the object information it can send, receiver sends back\n           the hashes it wants (doesn\'t have or has an older\n           timestamp).\n\n        3. Updates: Sender sends the object information requested.\n\n        4. Close down: Release semaphore lock, etc.\n    """'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'app'
op|','
name|'request'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'app'
op|'='
name|'app'
newline|'\n'
name|'self'
op|'.'
name|'request'
op|'='
name|'request'
newline|'\n'
name|'self'
op|'.'
name|'device'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'partition'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'fp'
op|'='
name|'None'
newline|'\n'
comment|'# We default to dropping the connection in case there is any exception'
nl|'\n'
comment|'# raised during processing because otherwise the sender could send for'
nl|'\n'
comment|'# quite some time before realizing it was all in vain.'
nl|'\n'
name|'self'
op|'.'
name|'disconnect'
op|'='
name|'True'
newline|'\n'
name|'self'
op|'.'
name|'initialize_request'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|__call__
dedent|''
name|'def'
name|'__call__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Processes an SSYNC request.\n\n        Acquires a semaphore lock and then proceeds through the steps\n        of the SSYNC process.\n        """'
newline|'\n'
comment|'# The general theme for functions __call__ calls is that they should'
nl|'\n'
comment|'# raise exceptions.MessageTimeout for client timeouts (logged locally),'
nl|'\n'
comment|'# swob.HTTPException classes for exceptions to return to the caller but'
nl|'\n'
comment|'# not log locally (unmounted, for example), and any other Exceptions'
nl|'\n'
comment|'# will be logged with a full stack trace.'
nl|'\n'
comment|'#       This is because the client is never just some random user but'
nl|'\n'
comment|'# is instead also our code and we definitely want to know if our code'
nl|'\n'
comment|'# is broken or doing something unexpected.'
nl|'\n'
name|'try'
op|':'
newline|'\n'
comment|'# Double try blocks in case our main error handlers fail.'
nl|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
comment|'# Need to send something to trigger wsgi to return response'
nl|'\n'
comment|'# headers and kick off the ssync exchange.'
nl|'\n'
indent|'                '
name|'yield'
string|"'\\r\\n'"
newline|'\n'
comment|'# If semaphore is in use, try to acquire it, non-blocking, and'
nl|'\n'
comment|'# return a 503 if it fails.'
nl|'\n'
name|'if'
name|'self'
op|'.'
name|'app'
op|'.'
name|'replication_semaphore'
op|':'
newline|'\n'
indent|'                    '
name|'if'
name|'not'
name|'self'
op|'.'
name|'app'
op|'.'
name|'replication_semaphore'
op|'.'
name|'acquire'
op|'('
name|'False'
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'raise'
name|'swob'
op|'.'
name|'HTTPServiceUnavailable'
op|'('
op|')'
newline|'\n'
dedent|''
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'with'
name|'self'
op|'.'
name|'diskfile_mgr'
op|'.'
name|'replication_lock'
op|'('
name|'self'
op|'.'
name|'device'
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'for'
name|'data'
name|'in'
name|'self'
op|'.'
name|'missing_check'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                            '
name|'yield'
name|'data'
newline|'\n'
dedent|''
name|'for'
name|'data'
name|'in'
name|'self'
op|'.'
name|'updates'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                            '
name|'yield'
name|'data'
newline|'\n'
comment|"# We didn't raise an exception, so end the request"
nl|'\n'
comment|'# normally.'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'disconnect'
op|'='
name|'False'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'                    '
name|'if'
name|'self'
op|'.'
name|'app'
op|'.'
name|'replication_semaphore'
op|':'
newline|'\n'
indent|'                        '
name|'self'
op|'.'
name|'app'
op|'.'
name|'replication_semaphore'
op|'.'
name|'release'
op|'('
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'except'
name|'exceptions'
op|'.'
name|'ReplicationLockTimeout'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'debug'
op|'('
nl|'\n'
string|"'%s/%s/%s SSYNC LOCK TIMEOUT: %s'"
op|'%'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'request'
op|'.'
name|'remote_addr'
op|','
name|'self'
op|'.'
name|'device'
op|','
name|'self'
op|'.'
name|'partition'
op|','
nl|'\n'
name|'err'
op|')'
op|')'
newline|'\n'
name|'yield'
string|"':ERROR: %d %r\\n'"
op|'%'
op|'('
number|'0'
op|','
name|'str'
op|'('
name|'err'
op|')'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'exceptions'
op|'.'
name|'MessageTimeout'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'('
nl|'\n'
string|"'%s/%s/%s TIMEOUT in replication.Receiver: %s'"
op|'%'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'request'
op|'.'
name|'remote_addr'
op|','
name|'self'
op|'.'
name|'device'
op|','
name|'self'
op|'.'
name|'partition'
op|','
nl|'\n'
name|'err'
op|')'
op|')'
newline|'\n'
name|'yield'
string|"':ERROR: %d %r\\n'"
op|'%'
op|'('
number|'408'
op|','
name|'str'
op|'('
name|'err'
op|')'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'swob'
op|'.'
name|'HTTPException'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'body'
op|'='
string|"''"
op|'.'
name|'join'
op|'('
name|'err'
op|'('
op|'{'
op|'}'
op|','
name|'lambda'
op|'*'
name|'args'
op|':'
name|'None'
op|')'
op|')'
newline|'\n'
name|'yield'
string|"':ERROR: %d %r\\n'"
op|'%'
op|'('
name|'err'
op|'.'
name|'status_int'
op|','
name|'body'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'exception'
op|'('
nl|'\n'
string|"'%s/%s/%s EXCEPTION in replication.Receiver'"
op|'%'
nl|'\n'
op|'('
name|'self'
op|'.'
name|'request'
op|'.'
name|'remote_addr'
op|','
name|'self'
op|'.'
name|'device'
op|','
name|'self'
op|'.'
name|'partition'
op|')'
op|')'
newline|'\n'
name|'yield'
string|"':ERROR: %d %r\\n'"
op|'%'
op|'('
number|'0'
op|','
name|'str'
op|'('
name|'err'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'exception'
op|'('
string|"'EXCEPTION in replication.Receiver'"
op|')'
newline|'\n'
dedent|''
name|'if'
name|'self'
op|'.'
name|'disconnect'
op|':'
newline|'\n'
comment|"# This makes the socket close early so the remote side doesn't have"
nl|'\n'
comment|'# to send its whole request while the lower Eventlet-level just'
nl|'\n'
comment|'# reads it and throws it away. Instead, the connection is dropped'
nl|'\n'
comment|'# and the remote side will get a broken-pipe exception.'
nl|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'socket'
op|'='
name|'self'
op|'.'
name|'request'
op|'.'
name|'environ'
op|'['
string|"'wsgi.input'"
op|']'
op|'.'
name|'get_socket'
op|'('
op|')'
newline|'\n'
name|'eventlet'
op|'.'
name|'greenio'
op|'.'
name|'shutdown_safe'
op|'('
name|'socket'
op|')'
newline|'\n'
name|'socket'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'                '
name|'pass'
comment|"# We're okay with the above failing."
newline|'\n'
nl|'\n'
DECL|member|initialize_request
dedent|''
dedent|''
dedent|''
name|'def'
name|'initialize_request'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Basic validation of request and mount check.\n\n        This function will be called before attempting to acquire a\n        replication semaphore lock, so contains only quick checks.\n        """'
newline|'\n'
comment|'# This environ override has been supported since eventlet 0.14:'
nl|'\n'
comment|'# https://bitbucket.org/eventlet/eventlet/commits/ \\'
nl|'\n'
comment|'#     4bd654205a4217970a57a7c4802fed7ff2c8b770'
nl|'\n'
name|'self'
op|'.'
name|'request'
op|'.'
name|'environ'
op|'['
string|"'eventlet.minimum_write_chunk_size'"
op|']'
op|'='
number|'0'
newline|'\n'
name|'self'
op|'.'
name|'device'
op|','
name|'self'
op|'.'
name|'partition'
op|','
name|'self'
op|'.'
name|'policy'
op|'='
name|'request_helpers'
op|'.'
name|'get_name_and_placement'
op|'('
name|'self'
op|'.'
name|'request'
op|','
number|'2'
op|','
number|'2'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'frag_index'
op|'='
name|'self'
op|'.'
name|'node_index'
op|'='
name|'None'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'request'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Backend-Ssync-Frag-Index'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'frag_index'
op|'='
name|'int'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'request'
op|'.'
name|'headers'
op|'['
string|"'X-Backend-Ssync-Frag-Index'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'swob'
op|'.'
name|'HTTPBadRequest'
op|'('
nl|'\n'
string|"'Invalid X-Backend-Ssync-Frag-Index %r'"
op|'%'
nl|'\n'
name|'self'
op|'.'
name|'request'
op|'.'
name|'headers'
op|'['
string|"'X-Backend-Ssync-Frag-Index'"
op|']'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'self'
op|'.'
name|'request'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Backend-Ssync-Node-Index'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'node_index'
op|'='
name|'int'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'request'
op|'.'
name|'headers'
op|'['
string|"'X-Backend-Ssync-Node-Index'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'swob'
op|'.'
name|'HTTPBadRequest'
op|'('
nl|'\n'
string|"'Invalid X-Backend-Ssync-Node-Index %r'"
op|'%'
nl|'\n'
name|'self'
op|'.'
name|'request'
op|'.'
name|'headers'
op|'['
string|"'X-Backend-Ssync-Node-Index'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'self'
op|'.'
name|'node_index'
op|'!='
name|'self'
op|'.'
name|'frag_index'
op|':'
newline|'\n'
comment|"# a primary node should only receive it's own fragments"
nl|'\n'
indent|'                '
name|'raise'
name|'swob'
op|'.'
name|'HTTPBadRequest'
op|'('
nl|'\n'
string|"'Frag-Index (%s) != Node-Index (%s)'"
op|'%'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'frag_index'
op|','
name|'self'
op|'.'
name|'node_index'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'utils'
op|'.'
name|'validate_device_partition'
op|'('
name|'self'
op|'.'
name|'device'
op|','
name|'self'
op|'.'
name|'partition'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'diskfile_mgr'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'_diskfile_router'
op|'['
name|'self'
op|'.'
name|'policy'
op|']'
newline|'\n'
name|'if'
name|'not'
name|'self'
op|'.'
name|'diskfile_mgr'
op|'.'
name|'get_dev_path'
op|'('
name|'self'
op|'.'
name|'device'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'swob'
op|'.'
name|'HTTPInsufficientStorage'
op|'('
name|'drive'
op|'='
name|'self'
op|'.'
name|'device'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'fp'
op|'='
name|'self'
op|'.'
name|'request'
op|'.'
name|'environ'
op|'['
string|"'wsgi.input'"
op|']'
newline|'\n'
nl|'\n'
DECL|member|_check_local
dedent|''
name|'def'
name|'_check_local'
op|'('
name|'self'
op|','
name|'remote'
op|','
name|'make_durable'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Parse local diskfile and return results of current\n        representative for comparison to remote.\n\n        :param object_hash: the hash of the remote object being offered\n        """'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'df'
op|'='
name|'self'
op|'.'
name|'diskfile_mgr'
op|'.'
name|'get_diskfile_from_hash'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'device'
op|','
name|'self'
op|'.'
name|'partition'
op|','
name|'remote'
op|'['
string|"'object_hash'"
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'policy'
op|','
name|'frag_index'
op|'='
name|'self'
op|'.'
name|'frag_index'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'exceptions'
op|'.'
name|'DiskFileNotExist'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
op|'}'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'df'
op|'.'
name|'open'
op|'('
op|')'
newline|'\n'
dedent|''
name|'except'
name|'exceptions'
op|'.'
name|'DiskFileDeleted'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'result'
op|'='
op|'{'
string|"'ts_data'"
op|':'
name|'err'
op|'.'
name|'timestamp'
op|'}'
newline|'\n'
dedent|''
name|'except'
name|'exceptions'
op|'.'
name|'DiskFileError'
op|':'
newline|'\n'
indent|'            '
name|'result'
op|'='
op|'{'
op|'}'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'result'
op|'='
op|'{'
nl|'\n'
string|"'ts_data'"
op|':'
name|'df'
op|'.'
name|'data_timestamp'
op|','
nl|'\n'
string|"'ts_meta'"
op|':'
name|'df'
op|'.'
name|'timestamp'
op|','
nl|'\n'
string|"'ts_ctype'"
op|':'
name|'df'
op|'.'
name|'content_type_timestamp'
op|','
nl|'\n'
op|'}'
newline|'\n'
dedent|''
name|'if'
op|'('
name|'make_durable'
name|'and'
name|'df'
op|'.'
name|'fragments'
name|'and'
nl|'\n'
name|'remote'
op|'['
string|"'ts_data'"
op|']'
name|'in'
name|'df'
op|'.'
name|'fragments'
name|'and'
nl|'\n'
name|'self'
op|'.'
name|'frag_index'
name|'in'
name|'df'
op|'.'
name|'fragments'
op|'['
name|'remote'
op|'['
string|"'ts_data'"
op|']'
op|']'
name|'and'
nl|'\n'
op|'('
name|'df'
op|'.'
name|'durable_timestamp'
name|'is'
name|'None'
name|'or'
nl|'\n'
name|'df'
op|'.'
name|'durable_timestamp'
op|'<'
name|'remote'
op|'['
string|"'ts_data'"
op|']'
op|')'
op|')'
op|':'
newline|'\n'
comment|'# We have the frag, just missing a .durable, so try to create the'
nl|'\n'
comment|'# .durable now. Try this just once to avoid looping if it fails.'
nl|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'with'
name|'df'
op|'.'
name|'create'
op|'('
op|')'
name|'as'
name|'writer'
op|':'
newline|'\n'
indent|'                    '
name|'writer'
op|'.'
name|'commit'
op|'('
name|'remote'
op|'['
string|"'ts_data'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'_check_local'
op|'('
name|'remote'
op|','
name|'make_durable'
op|'='
name|'False'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
comment|'# if commit fails then log exception and fall back to wanting'
nl|'\n'
comment|'# a full update'
nl|'\n'
indent|'                '
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'exception'
op|'('
nl|'\n'
string|"'%s/%s/%s EXCEPTION in replication.Receiver while '"
nl|'\n'
string|"'attempting commit of %s'"
nl|'\n'
op|'%'
op|'('
name|'self'
op|'.'
name|'request'
op|'.'
name|'remote_addr'
op|','
name|'self'
op|'.'
name|'device'
op|','
name|'self'
op|'.'
name|'partition'
op|','
nl|'\n'
name|'df'
op|'.'
name|'_datadir'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'result'
newline|'\n'
nl|'\n'
DECL|member|_check_missing
dedent|''
name|'def'
name|'_check_missing'
op|'('
name|'self'
op|','
name|'line'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Parse offered object from sender, and compare to local diskfile,\n        responding with proper protocol line to represented needed data\n        or None if in sync.\n\n        Anchor point for tests to mock legacy protocol changes.\n        """'
newline|'\n'
name|'remote'
op|'='
name|'decode_missing'
op|'('
name|'line'
op|')'
newline|'\n'
name|'local'
op|'='
name|'self'
op|'.'
name|'_check_local'
op|'('
name|'remote'
op|')'
newline|'\n'
name|'return'
name|'encode_wanted'
op|'('
name|'remote'
op|','
name|'local'
op|')'
newline|'\n'
nl|'\n'
DECL|member|missing_check
dedent|''
name|'def'
name|'missing_check'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Handles the receiver-side of the MISSING_CHECK step of a\n        SSYNC request.\n\n        Receives a list of hashes and timestamps of object\n        information the sender can provide and responds with a list\n        of hashes desired, either because they\'re missing or have an\n        older timestamp locally.\n\n        The process is generally:\n\n            1. Sender sends `:MISSING_CHECK: START` and begins\n               sending `hash timestamp` lines.\n\n            2. Receiver gets `:MISSING_CHECK: START` and begins\n               reading the `hash timestamp` lines, collecting the\n               hashes of those it desires.\n\n            3. Sender sends `:MISSING_CHECK: END`.\n\n            4. Receiver gets `:MISSING_CHECK: END`, responds with\n               `:MISSING_CHECK: START`, followed by the list of\n               <wanted_hash> specifiers it collected as being wanted\n               (one per line), `:MISSING_CHECK: END`, and flushes any\n               buffers.\n\n               Each <wanted_hash> specifier has the form <hash>[ <parts>] where\n               <parts> is a string containing characters \'d\' and/or \'m\'\n               indicating that only data or meta part of object respectively is\n               required to be sync\'d.\n\n            5. Sender gets `:MISSING_CHECK: START` and reads the list\n               of hashes desired by the receiver until reading\n               `:MISSING_CHECK: END`.\n\n        The collection and then response is so the sender doesn\'t\n        have to read while it writes to ensure network buffers don\'t\n        fill up and block everything.\n        """'
newline|'\n'
name|'with'
name|'exceptions'
op|'.'
name|'MessageTimeout'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'client_timeout'
op|','
string|"'missing_check start'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'line'
op|'='
name|'self'
op|'.'
name|'fp'
op|'.'
name|'readline'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'network_chunk_size'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'line'
op|'.'
name|'strip'
op|'('
op|')'
op|'!='
string|"':MISSING_CHECK: START'"
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'Exception'
op|'('
nl|'\n'
string|"'Looking for :MISSING_CHECK: START got %r'"
op|'%'
name|'line'
op|'['
op|':'
number|'1024'
op|']'
op|')'
newline|'\n'
dedent|''
name|'object_hashes'
op|'='
op|'['
op|']'
newline|'\n'
name|'while'
name|'True'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'exceptions'
op|'.'
name|'MessageTimeout'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'client_timeout'
op|','
string|"'missing_check line'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'line'
op|'='
name|'self'
op|'.'
name|'fp'
op|'.'
name|'readline'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'network_chunk_size'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'line'
name|'or'
name|'line'
op|'.'
name|'strip'
op|'('
op|')'
op|'=='
string|"':MISSING_CHECK: END'"
op|':'
newline|'\n'
indent|'                '
name|'break'
newline|'\n'
dedent|''
name|'want'
op|'='
name|'self'
op|'.'
name|'_check_missing'
op|'('
name|'line'
op|')'
newline|'\n'
name|'if'
name|'want'
op|':'
newline|'\n'
indent|'                '
name|'object_hashes'
op|'.'
name|'append'
op|'('
name|'want'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'yield'
string|"':MISSING_CHECK: START\\r\\n'"
newline|'\n'
name|'if'
name|'object_hashes'
op|':'
newline|'\n'
indent|'            '
name|'yield'
string|"'\\r\\n'"
op|'.'
name|'join'
op|'('
name|'object_hashes'
op|')'
newline|'\n'
dedent|''
name|'yield'
string|"'\\r\\n'"
newline|'\n'
name|'yield'
string|"':MISSING_CHECK: END\\r\\n'"
newline|'\n'
nl|'\n'
DECL|member|updates
dedent|''
name|'def'
name|'updates'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Handles the UPDATES step of an SSYNC request.\n\n        Receives a set of PUT and DELETE subrequests that will be\n        routed to the object server itself for processing. These\n        contain the information requested by the MISSING_CHECK step.\n\n        The PUT and DELETE subrequests are formatted pretty much\n        exactly like regular HTTP requests, excepting the HTTP\n        version on the first request line.\n\n        The process is generally:\n\n            1. Sender sends `:UPDATES: START` and begins sending the\n               PUT and DELETE subrequests.\n\n            2. Receiver gets `:UPDATES: START` and begins routing the\n               subrequests to the object server.\n\n            3. Sender sends `:UPDATES: END`.\n\n            4. Receiver gets `:UPDATES: END` and sends `:UPDATES:\n               START` and `:UPDATES: END` (assuming no errors).\n\n            5. Sender gets `:UPDATES: START` and `:UPDATES: END`.\n\n        If too many subrequests fail, as configured by\n        replication_failure_threshold and replication_failure_ratio,\n        the receiver will hang up the request early so as to not\n        waste any more time.\n\n        At step 4, the receiver will send back an error if there were\n        any failures (that didn\'t cause a hangup due to the above\n        thresholds) so the sender knows the whole was not entirely a\n        success. This is so the sender knows if it can remove an out\n        of place partition, for example.\n        """'
newline|'\n'
name|'with'
name|'exceptions'
op|'.'
name|'MessageTimeout'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'client_timeout'
op|','
string|"'updates start'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'line'
op|'='
name|'self'
op|'.'
name|'fp'
op|'.'
name|'readline'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'network_chunk_size'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'line'
op|'.'
name|'strip'
op|'('
op|')'
op|'!='
string|"':UPDATES: START'"
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'Exception'
op|'('
string|"'Looking for :UPDATES: START got %r'"
op|'%'
name|'line'
op|'['
op|':'
number|'1024'
op|']'
op|')'
newline|'\n'
dedent|''
name|'successes'
op|'='
number|'0'
newline|'\n'
name|'failures'
op|'='
number|'0'
newline|'\n'
name|'while'
name|'True'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'exceptions'
op|'.'
name|'MessageTimeout'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'client_timeout'
op|','
string|"'updates line'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'line'
op|'='
name|'self'
op|'.'
name|'fp'
op|'.'
name|'readline'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'network_chunk_size'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'line'
name|'or'
name|'line'
op|'.'
name|'strip'
op|'('
op|')'
op|'=='
string|"':UPDATES: END'"
op|':'
newline|'\n'
indent|'                '
name|'break'
newline|'\n'
comment|'# Read first line METHOD PATH of subrequest.'
nl|'\n'
dedent|''
name|'method'
op|','
name|'path'
op|'='
name|'line'
op|'.'
name|'strip'
op|'('
op|')'
op|'.'
name|'split'
op|'('
string|"' '"
op|','
number|'1'
op|')'
newline|'\n'
name|'subreq'
op|'='
name|'swob'
op|'.'
name|'Request'
op|'.'
name|'blank'
op|'('
nl|'\n'
string|"'/%s/%s%s'"
op|'%'
op|'('
name|'self'
op|'.'
name|'device'
op|','
name|'self'
op|'.'
name|'partition'
op|','
name|'path'
op|')'
op|','
nl|'\n'
name|'environ'
op|'='
op|'{'
string|"'REQUEST_METHOD'"
op|':'
name|'method'
op|'}'
op|')'
newline|'\n'
comment|'# Read header lines.'
nl|'\n'
name|'content_length'
op|'='
name|'None'
newline|'\n'
name|'replication_headers'
op|'='
op|'['
op|']'
newline|'\n'
name|'while'
name|'True'
op|':'
newline|'\n'
indent|'                '
name|'with'
name|'exceptions'
op|'.'
name|'MessageTimeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'client_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'line'
op|'='
name|'self'
op|'.'
name|'fp'
op|'.'
name|'readline'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'network_chunk_size'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'line'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'Exception'
op|'('
nl|'\n'
string|"'Got no headers for %s %s'"
op|'%'
op|'('
name|'method'
op|','
name|'path'
op|')'
op|')'
newline|'\n'
dedent|''
name|'line'
op|'='
name|'line'
op|'.'
name|'strip'
op|'('
op|')'
newline|'\n'
name|'if'
name|'not'
name|'line'
op|':'
newline|'\n'
indent|'                    '
name|'break'
newline|'\n'
dedent|''
name|'header'
op|','
name|'value'
op|'='
name|'line'
op|'.'
name|'split'
op|'('
string|"':'"
op|','
number|'1'
op|')'
newline|'\n'
name|'header'
op|'='
name|'header'
op|'.'
name|'strip'
op|'('
op|')'
op|'.'
name|'lower'
op|'('
op|')'
newline|'\n'
name|'value'
op|'='
name|'value'
op|'.'
name|'strip'
op|'('
op|')'
newline|'\n'
name|'subreq'
op|'.'
name|'headers'
op|'['
name|'header'
op|']'
op|'='
name|'value'
newline|'\n'
name|'if'
name|'header'
op|'!='
string|"'etag'"
op|':'
newline|'\n'
comment|"# make sure ssync doesn't cause 'Etag' to be added to"
nl|'\n'
comment|"# obj metadata in addition to 'ETag' which object server"
nl|'\n'
comment|'# sets (note capitalization)'
nl|'\n'
indent|'                    '
name|'replication_headers'
op|'.'
name|'append'
op|'('
name|'header'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'header'
op|'=='
string|"'content-length'"
op|':'
newline|'\n'
indent|'                    '
name|'content_length'
op|'='
name|'int'
op|'('
name|'value'
op|')'
newline|'\n'
comment|'# Establish subrequest body, if needed.'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'method'
name|'in'
op|'('
string|"'DELETE'"
op|','
string|"'POST'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'content_length'
name|'not'
name|'in'
op|'('
name|'None'
op|','
number|'0'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'Exception'
op|'('
nl|'\n'
string|"'%s subrequest with content-length %s'"
nl|'\n'
op|'%'
op|'('
name|'method'
op|','
name|'path'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'elif'
name|'method'
op|'=='
string|"'PUT'"
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'content_length'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'Exception'
op|'('
nl|'\n'
string|"'No content-length sent for %s %s'"
op|'%'
op|'('
name|'method'
op|','
name|'path'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|subreq_iter
dedent|''
name|'def'
name|'subreq_iter'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'left'
op|'='
name|'content_length'
newline|'\n'
name|'while'
name|'left'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'                        '
name|'with'
name|'exceptions'
op|'.'
name|'MessageTimeout'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'client_timeout'
op|','
nl|'\n'
string|"'updates content'"
op|')'
op|':'
newline|'\n'
indent|'                            '
name|'chunk'
op|'='
name|'self'
op|'.'
name|'fp'
op|'.'
name|'read'
op|'('
nl|'\n'
name|'min'
op|'('
name|'left'
op|','
name|'self'
op|'.'
name|'app'
op|'.'
name|'network_chunk_size'
op|')'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'chunk'
op|':'
newline|'\n'
indent|'                            '
name|'raise'
name|'Exception'
op|'('
nl|'\n'
string|"'Early termination for %s %s'"
op|'%'
op|'('
name|'method'
op|','
name|'path'
op|')'
op|')'
newline|'\n'
dedent|''
name|'left'
op|'-='
name|'len'
op|'('
name|'chunk'
op|')'
newline|'\n'
name|'yield'
name|'chunk'
newline|'\n'
dedent|''
dedent|''
name|'subreq'
op|'.'
name|'environ'
op|'['
string|"'wsgi.input'"
op|']'
op|'='
name|'utils'
op|'.'
name|'FileLikeIter'
op|'('
nl|'\n'
name|'subreq_iter'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'Exception'
op|'('
string|"'Invalid subrequest method %s'"
op|'%'
name|'method'
op|')'
newline|'\n'
dedent|''
name|'subreq'
op|'.'
name|'headers'
op|'['
string|"'X-Backend-Storage-Policy-Index'"
op|']'
op|'='
name|'int'
op|'('
name|'self'
op|'.'
name|'policy'
op|')'
newline|'\n'
name|'subreq'
op|'.'
name|'headers'
op|'['
string|"'X-Backend-Replication'"
op|']'
op|'='
string|"'True'"
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'node_index'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
comment|'# primary node should not 409 if it has a non-primary fragment'
nl|'\n'
indent|'                '
name|'subreq'
op|'.'
name|'headers'
op|'['
string|"'X-Backend-Ssync-Frag-Index'"
op|']'
op|'='
name|'self'
op|'.'
name|'node_index'
newline|'\n'
dedent|''
name|'if'
name|'replication_headers'
op|':'
newline|'\n'
indent|'                '
name|'subreq'
op|'.'
name|'headers'
op|'['
string|"'X-Backend-Replication-Headers'"
op|']'
op|'='
string|"' '"
op|'.'
name|'join'
op|'('
name|'replication_headers'
op|')'
newline|'\n'
comment|'# Route subrequest and translate response.'
nl|'\n'
dedent|''
name|'resp'
op|'='
name|'subreq'
op|'.'
name|'get_response'
op|'('
name|'self'
op|'.'
name|'app'
op|')'
newline|'\n'
name|'if'
name|'http'
op|'.'
name|'is_success'
op|'('
name|'resp'
op|'.'
name|'status_int'
op|')'
name|'or'
name|'resp'
op|'.'
name|'status_int'
op|'=='
name|'http'
op|'.'
name|'HTTP_NOT_FOUND'
op|':'
newline|'\n'
indent|'                '
name|'successes'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'failures'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'if'
name|'failures'
op|'>='
name|'self'
op|'.'
name|'app'
op|'.'
name|'replication_failure_threshold'
name|'and'
op|'('
nl|'\n'
name|'not'
name|'successes'
name|'or'
nl|'\n'
name|'float'
op|'('
name|'failures'
op|')'
op|'/'
name|'successes'
op|'>'
nl|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'replication_failure_ratio'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'Exception'
op|'('
nl|'\n'
string|"'Too many %d failures to %d successes'"
op|'%'
nl|'\n'
op|'('
name|'failures'
op|','
name|'successes'
op|')'
op|')'
newline|'\n'
comment|'# The subreq may have failed, but we want to read the rest of the'
nl|'\n'
comment|'# body from the remote side so we can continue on with the next'
nl|'\n'
comment|'# subreq.'
nl|'\n'
dedent|''
name|'for'
name|'junk'
name|'in'
name|'subreq'
op|'.'
name|'environ'
op|'['
string|"'wsgi.input'"
op|']'
op|':'
newline|'\n'
indent|'                '
name|'pass'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'failures'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'swob'
op|'.'
name|'HTTPInternalServerError'
op|'('
nl|'\n'
string|"'ERROR: With :UPDATES: %d failures to %d successes'"
op|'%'
nl|'\n'
op|'('
name|'failures'
op|','
name|'successes'
op|')'
op|')'
newline|'\n'
dedent|''
name|'yield'
string|"':UPDATES: START\\r\\n'"
newline|'\n'
name|'yield'
string|"':UPDATES: END\\r\\n'"
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit

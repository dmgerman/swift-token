begin_unit
comment|'# Copyright (c) 2010-2012 OpenStack Foundation'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'copy'
newline|'\n'
name|'import'
name|'errno'
newline|'\n'
name|'import'
name|'mock'
newline|'\n'
name|'import'
name|'operator'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'unittest'
newline|'\n'
name|'import'
name|'six'
op|'.'
name|'moves'
op|'.'
name|'cPickle'
name|'as'
name|'pickle'
newline|'\n'
name|'from'
name|'array'
name|'import'
name|'array'
newline|'\n'
name|'from'
name|'collections'
name|'import'
name|'defaultdict'
newline|'\n'
name|'from'
name|'math'
name|'import'
name|'ceil'
newline|'\n'
name|'from'
name|'tempfile'
name|'import'
name|'mkdtemp'
newline|'\n'
name|'from'
name|'shutil'
name|'import'
name|'rmtree'
newline|'\n'
name|'import'
name|'random'
newline|'\n'
nl|'\n'
name|'from'
name|'six'
op|'.'
name|'moves'
name|'import'
name|'range'
newline|'\n'
nl|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'exceptions'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'ring'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'ring'
name|'import'
name|'utils'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'ring'
op|'.'
name|'builder'
name|'import'
name|'MAX_BALANCE'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|TestRingBuilder
name|'class'
name|'TestRingBuilder'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'testdir'
op|'='
name|'mkdtemp'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|tearDown
dedent|''
name|'def'
name|'tearDown'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rmtree'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'ignore_errors'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_partition_counts
dedent|''
name|'def'
name|'_partition_counts'
op|'('
name|'self'
op|','
name|'builder'
op|','
name|'key'
op|'='
string|"'id'"
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Returns a dictionary mapping the given device key to (number of\n        partitions assigned to to that key).\n        """'
newline|'\n'
name|'counts'
op|'='
name|'defaultdict'
op|'('
name|'int'
op|')'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'builder'
op|'.'
name|'_replica2part2dev'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'builder'
op|'.'
name|'devs'
op|'['
name|'dev_id'
op|']'
op|'['
name|'key'
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'counts'
newline|'\n'
nl|'\n'
DECL|member|_get_population_by_region
dedent|''
name|'def'
name|'_get_population_by_region'
op|'('
name|'self'
op|','
name|'builder'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Returns a dictionary mapping region to number of partitions in that\n        region.\n        """'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'builder'
op|','
name|'key'
op|'='
string|"'region'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_init
dedent|''
name|'def'
name|'test_init'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'part_power'
op|','
number|'8'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|','
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'min_part_hours'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'parts'
op|','
number|'2'
op|'**'
number|'8'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'devs'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'devs_changed'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'version'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_overlarge_part_powers
dedent|''
name|'def'
name|'test_overlarge_part_powers'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'32'
op|','
number|'3'
op|','
number|'1'
op|')'
comment|'# passes by not crashing'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'ring'
op|'.'
name|'RingBuilder'
op|','
number|'33'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_insufficient_replicas
dedent|''
name|'def'
name|'test_insufficient_replicas'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'1.0'
op|','
number|'1'
op|')'
comment|'# passes by not crashing'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'ring'
op|'.'
name|'RingBuilder'
op|','
number|'8'
op|','
number|'0.999'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_negative_min_part_hours
dedent|''
name|'def'
name|'test_negative_min_part_hours'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'0'
op|')'
comment|'# passes by not crashing'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'ring'
op|'.'
name|'RingBuilder'
op|','
number|'8'
op|','
number|'3'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_deepcopy
dedent|''
name|'def'
name|'test_deepcopy'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# more devices in zone #1'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb_copy'
op|'='
name|'copy'
op|'.'
name|'deepcopy'
op|'('
name|'rb'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'to_dict'
op|'('
op|')'
op|','
name|'rb_copy'
op|'.'
name|'to_dict'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'rb'
op|'.'
name|'devs'
name|'is'
name|'not'
name|'rb_copy'
op|'.'
name|'devs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'rb'
op|'.'
name|'_replica2part2dev'
name|'is'
name|'not'
name|'rb_copy'
op|'.'
name|'_replica2part2dev'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'rb'
op|'.'
name|'_last_part_moves'
name|'is'
name|'not'
name|'rb_copy'
op|'.'
name|'_last_part_moves'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'rb'
op|'.'
name|'_remove_devs'
name|'is'
name|'not'
name|'rb_copy'
op|'.'
name|'_remove_devs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'rb'
op|'.'
name|'_dispersion_graph'
name|'is'
name|'not'
name|'rb_copy'
op|'.'
name|'_dispersion_graph'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_ring
dedent|''
name|'def'
name|'test_get_ring'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'isinstance'
op|'('
name|'r'
op|','
name|'ring'
op|'.'
name|'RingData'
op|')'
op|')'
newline|'\n'
name|'r2'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'r'
name|'is'
name|'r2'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'r3'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'r3'
name|'is'
name|'not'
name|'r2'
op|')'
newline|'\n'
name|'r4'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'r3'
name|'is'
name|'r4'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebalance_with_seed
dedent|''
name|'def'
name|'test_rebalance_with_seed'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'devs'
op|'='
op|'['
op|'('
number|'0'
op|','
number|'10000'
op|')'
op|','
op|'('
number|'1'
op|','
number|'10001'
op|')'
op|','
op|'('
number|'2'
op|','
number|'10002'
op|')'
op|','
op|'('
number|'1'
op|','
number|'10003'
op|')'
op|']'
newline|'\n'
name|'ring_builders'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'n'
name|'in'
name|'range'
op|'('
number|'3'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'idx'
op|'='
number|'0'
newline|'\n'
name|'for'
name|'zone'
op|','
name|'port'
name|'in'
name|'devs'
op|':'
newline|'\n'
indent|'                '
name|'for'
name|'d'
name|'in'
op|'('
string|"'sda1'"
op|','
string|"'sdb1'"
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
name|'idx'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
name|'zone'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
name|'port'
op|','
nl|'\n'
string|"'device'"
op|':'
name|'d'
op|','
string|"'weight'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'idx'
op|'+='
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'ring_builders'
op|'.'
name|'append'
op|'('
name|'rb'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'rb0'
op|'='
name|'ring_builders'
op|'['
number|'0'
op|']'
newline|'\n'
name|'rb1'
op|'='
name|'ring_builders'
op|'['
number|'1'
op|']'
newline|'\n'
name|'rb2'
op|'='
name|'ring_builders'
op|'['
number|'2'
op|']'
newline|'\n'
nl|'\n'
name|'r0'
op|'='
name|'rb0'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'rb0'
op|'.'
name|'get_ring'
op|'('
op|')'
name|'is'
name|'r0'
op|')'
newline|'\n'
nl|'\n'
name|'rb0'
op|'.'
name|'rebalance'
op|'('
op|')'
comment|'# NO SEED'
newline|'\n'
name|'rb1'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'10'
op|')'
newline|'\n'
name|'rb2'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'10'
op|')'
newline|'\n'
nl|'\n'
name|'r1'
op|'='
name|'rb1'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'r2'
op|'='
name|'rb2'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'rb0'
op|'.'
name|'get_ring'
op|'('
op|')'
name|'is'
name|'r0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'r0'
op|'.'
name|'to_dict'
op|'('
op|')'
op|','
name|'r1'
op|'.'
name|'to_dict'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'r1'
op|'.'
name|'to_dict'
op|'('
op|')'
op|','
name|'r2'
op|'.'
name|'to_dict'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebalance_part_on_deleted_other_part_on_drained
dedent|''
name|'def'
name|'test_rebalance_part_on_deleted_other_part_on_drained'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10005'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
comment|'# We want a partition where 1 replica is on a removed device, 1'
nl|'\n'
comment|'# replica is on a 0-weight device, and 1 on a normal device. To'
nl|'\n'
comment|'# guarantee we have one, we see where partition 123 is, then'
nl|'\n'
comment|'# manipulate its devices accordingly.'
nl|'\n'
name|'zero_weight_dev_id'
op|'='
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'1'
op|']'
op|'['
number|'123'
op|']'
newline|'\n'
name|'delete_dev_id'
op|'='
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'2'
op|']'
op|'['
number|'123'
op|']'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
name|'zero_weight_dev_id'
op|','
number|'0.0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
name|'delete_dev_id'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_replicas
dedent|''
name|'def'
name|'test_set_replicas'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3.2'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'devs_changed'
op|'='
name|'False'
newline|'\n'
name|'rb'
op|'.'
name|'set_replicas'
op|'('
number|'3.25'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'rb'
op|'.'
name|'devs_changed'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'devs_changed'
op|'='
name|'False'
newline|'\n'
name|'rb'
op|'.'
name|'set_replicas'
op|'('
number|'3.2500001'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'rb'
op|'.'
name|'devs_changed'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_dev
dedent|''
name|'def'
name|'test_add_dev'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'dev'
op|'='
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|'}'
newline|'\n'
name|'dev_id'
op|'='
name|'rb'
op|'.'
name|'add_dev'
op|'('
name|'dev'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'DuplicateDeviceError'
op|','
name|'rb'
op|'.'
name|'add_dev'
op|','
name|'dev'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# test add new dev with no id'
nl|'\n'
name|'dev_id'
op|'='
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'zone'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'6000'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'devs'
op|'['
number|'0'
op|']'
op|'['
string|"'id'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
newline|'\n'
comment|'# test add another dev with no id'
nl|'\n'
name|'dev_id'
op|'='
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'zone'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'6000'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'devs'
op|'['
number|'1'
op|']'
op|'['
string|"'id'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev_id'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_dev_weight
dedent|''
name|'def'
name|'test_set_dev_weight'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'dev_id'
op|']'
op|'='
name|'counts'
op|'.'
name|'get'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'128'
op|','
number|'1'
op|':'
number|'128'
op|','
number|'2'
op|':'
number|'256'
op|','
number|'3'
op|':'
number|'256'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'0'
op|','
number|'0.75'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'1'
op|','
number|'0.25'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'dev_id'
op|']'
op|'='
name|'counts'
op|'.'
name|'get'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'192'
op|','
number|'1'
op|':'
number|'64'
op|','
number|'2'
op|':'
number|'256'
op|','
number|'3'
op|':'
number|'256'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_dev
dedent|''
name|'def'
name|'test_remove_dev'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'dev_id'
op|']'
op|'='
name|'counts'
op|'.'
name|'get'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'192'
op|','
number|'1'
op|':'
number|'192'
op|','
number|'2'
op|':'
number|'192'
op|','
number|'3'
op|':'
number|'192'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'dev_id'
op|']'
op|'='
name|'counts'
op|'.'
name|'get'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'256'
op|','
number|'2'
op|':'
number|'256'
op|','
number|'3'
op|':'
number|'256'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_a_lot
dedent|''
name|'def'
name|'test_remove_a_lot'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'3'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'device'"
op|':'
string|"'d0'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'device'"
op|':'
string|"'d1'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'device'"
op|':'
string|"'d2'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'device'"
op|':'
string|"'d3'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'device'"
op|':'
string|"'d4'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'device'"
op|':'
string|"'d5'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# this has to put more than 1/3 of the partitions in the'
nl|'\n'
comment|'# cluster on removed devices in order to ensure that at least'
nl|'\n'
comment|'# one partition has multiple replicas that need to move.'
nl|'\n'
comment|'#'
nl|'\n'
comment|"# (for an N-replica ring, it's more than 1/N of the"
nl|'\n'
comment|'# partitions, of course)'
nl|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'3'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'4'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'5'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_zero_weighted
dedent|''
name|'def'
name|'test_remove_zero_weighted'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'device'"
op|':'
string|"'d0'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'device'"
op|':'
string|"'d1'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'0.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'device'"
op|':'
string|"'d2'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'device'"
op|':'
string|"'d3'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'1'
op|')'
newline|'\n'
name|'parts'
op|','
name|'balance'
op|','
name|'removed'
op|'='
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'removed'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_shuffled_gather
dedent|''
name|'def'
name|'test_shuffled_gather'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'_shuffled_gather_helper'
op|'('
op|')'
name|'and'
name|'self'
op|'.'
name|'_shuffled_gather_helper'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
string|"'It is highly likely the ring is no '"
nl|'\n'
string|"'longer shuffling the set of partitions '"
nl|'\n'
string|"'to reassign on a rebalance.'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|_shuffled_gather_helper
dedent|''
dedent|''
name|'def'
name|'_shuffled_gather_helper'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'replica_plan'
op|'='
name|'rb'
op|'.'
name|'_build_replica_plan'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'_set_parts_wanted'
op|'('
name|'replica_plan'
op|')'
newline|'\n'
name|'for'
name|'dev'
name|'in'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'dev'
op|'['
string|"'tiers'"
op|']'
op|'='
name|'utils'
op|'.'
name|'tiers_for_dev'
op|'('
name|'dev'
op|')'
newline|'\n'
dedent|''
name|'assign_parts'
op|'='
name|'defaultdict'
op|'('
name|'list'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'_gather_parts_for_balance'
op|'('
name|'assign_parts'
op|','
name|'replica_plan'
op|')'
newline|'\n'
name|'max_run'
op|'='
number|'0'
newline|'\n'
name|'run'
op|'='
number|'0'
newline|'\n'
name|'last_part'
op|'='
number|'0'
newline|'\n'
name|'for'
name|'part'
op|','
name|'_'
name|'in'
name|'assign_parts'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'part'
op|'>'
name|'last_part'
op|':'
newline|'\n'
indent|'                '
name|'run'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'run'
op|'>'
name|'max_run'
op|':'
newline|'\n'
indent|'                    '
name|'max_run'
op|'='
name|'run'
newline|'\n'
dedent|''
name|'run'
op|'='
number|'0'
newline|'\n'
dedent|''
name|'last_part'
op|'='
name|'part'
newline|'\n'
dedent|''
name|'if'
name|'run'
op|'>'
name|'max_run'
op|':'
newline|'\n'
indent|'            '
name|'max_run'
op|'='
name|'run'
newline|'\n'
dedent|''
name|'return'
name|'max_run'
op|'>'
name|'len'
op|'('
name|'assign_parts'
op|')'
op|'/'
number|'2'
newline|'\n'
nl|'\n'
DECL|member|test_initial_balance
dedent|''
name|'def'
name|'test_initial_balance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# 2 boxes, 2 drives each in zone 1'
nl|'\n'
comment|'# 1 box, 2 drives in zone 2'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# This is balanceable, but there used to be some nondeterminism in'
nl|'\n'
comment|'# rebalance() that would sometimes give you an imbalanced ring.'
nl|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'4000.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'4000.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'4000.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'4000.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'4000.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'4000.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'_'
op|','
name|'balance'
op|','
name|'_'
op|'='
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
nl|'\n'
comment|'# maybe not *perfect*, but should be close'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'balance'
op|'<='
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multitier_partial
dedent|''
name|'def'
name|'test_multitier_partial'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Multitier test, nothing full'
nl|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'2'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'3'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'counts'
op|'='
name|'defaultdict'
op|'('
name|'lambda'
op|':'
name|'defaultdict'
op|'('
name|'int'
op|')'
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'='
name|'rb'
op|'.'
name|'devs'
op|'['
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|']'
newline|'\n'
name|'counts'
op|'['
string|"'region'"
op|']'
op|'['
name|'dev'
op|'['
string|"'region'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'['
name|'dev'
op|'['
string|"'zone'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'any'
op|'('
name|'c'
op|'>'
number|'1'
name|'for'
name|'c'
name|'in'
name|'counts'
op|'['
string|"'region'"
op|']'
op|'.'
name|'values'
op|'('
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d not evenly region-distributed (got %r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'counts'
op|'['
string|"'region'"
op|']'
op|')'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'any'
op|'('
name|'c'
op|'>'
number|'1'
name|'for'
name|'c'
name|'in'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'.'
name|'values'
op|'('
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d not evenly zone-distributed (got %r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'counts'
op|'['
string|"'zone'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# Multitier test, zones full, nodes not full'
nl|'\n'
dedent|''
dedent|''
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'6'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdg'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdh'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdi'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'counts'
op|'='
name|'defaultdict'
op|'('
name|'lambda'
op|':'
name|'defaultdict'
op|'('
name|'int'
op|')'
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'='
name|'rb'
op|'.'
name|'devs'
op|'['
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|']'
newline|'\n'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'['
name|'dev'
op|'['
string|"'zone'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'['
name|'dev'
op|'['
string|"'id'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'if'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'!='
op|'{'
number|'0'
op|':'
number|'2'
op|','
number|'1'
op|':'
number|'2'
op|','
number|'2'
op|':'
number|'2'
op|'}'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d not evenly distributed (got %r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'counts'
op|'['
string|"'zone'"
op|']'
op|')'
op|')'
newline|'\n'
dedent|''
name|'for'
name|'dev_id'
op|','
name|'replica_count'
name|'in'
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'replica_count'
op|'>'
number|'1'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d is on device %d more than once (%r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'dev_id'
op|','
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multitier_full
dedent|''
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_multitier_full'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Multitier test, #replicas == #devs'
nl|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'6'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'counts'
op|'='
name|'defaultdict'
op|'('
name|'lambda'
op|':'
name|'defaultdict'
op|'('
name|'int'
op|')'
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'='
name|'rb'
op|'.'
name|'devs'
op|'['
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|']'
newline|'\n'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'['
name|'dev'
op|'['
string|"'zone'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'['
name|'dev'
op|'['
string|"'id'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'if'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'!='
op|'{'
number|'0'
op|':'
number|'2'
op|','
number|'1'
op|':'
number|'2'
op|','
number|'2'
op|':'
number|'2'
op|'}'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d not evenly distributed (got %r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'counts'
op|'['
string|"'zone'"
op|']'
op|')'
op|')'
newline|'\n'
dedent|''
name|'for'
name|'dev_id'
op|','
name|'replica_count'
name|'in'
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'replica_count'
op|'!='
number|'1'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d is on device %d %d times, not 1 (%r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'dev_id'
op|','
name|'replica_count'
op|','
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multitier_overfull
dedent|''
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_multitier_overfull'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Multitier test, #replicas > #zones (to prove even distribution)'
nl|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'8'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdg'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdh'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdi'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'counts'
op|'='
name|'defaultdict'
op|'('
name|'lambda'
op|':'
name|'defaultdict'
op|'('
name|'int'
op|')'
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'='
name|'rb'
op|'.'
name|'devs'
op|'['
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|']'
newline|'\n'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'['
name|'dev'
op|'['
string|"'zone'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'['
name|'dev'
op|'['
string|"'id'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'8'
op|','
name|'sum'
op|'('
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'.'
name|'values'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'for'
name|'zone'
op|','
name|'replica_count'
name|'in'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'replica_count'
name|'not'
name|'in'
op|'('
number|'2'
op|','
number|'3'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d not evenly distributed (got %r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'counts'
op|'['
string|"'zone'"
op|']'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'for'
name|'dev_id'
op|','
name|'replica_count'
name|'in'
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'replica_count'
name|'not'
name|'in'
op|'('
number|'1'
op|','
number|'2'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d is on device %d %d times, "'
nl|'\n'
string|'"not 1 or 2 (%r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'dev_id'
op|','
name|'replica_count'
op|','
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multitier_expansion_more_devices
dedent|''
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_multitier_expansion_more_devices'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'6'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'10'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'11'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'_'
name|'in'
name|'range'
op|'('
number|'5'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'counts'
op|'='
name|'dict'
op|'('
name|'zone'
op|'='
name|'defaultdict'
op|'('
name|'int'
op|')'
op|','
nl|'\n'
name|'dev_id'
op|'='
name|'defaultdict'
op|'('
name|'int'
op|')'
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'='
name|'rb'
op|'.'
name|'devs'
op|'['
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|']'
newline|'\n'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'['
name|'dev'
op|'['
string|"'zone'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'['
name|'dev'
op|'['
string|"'id'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'{'
number|'0'
op|':'
number|'2'
op|','
number|'1'
op|':'
number|'2'
op|','
number|'2'
op|':'
number|'2'
op|'}'
op|','
name|'dict'
op|'('
name|'counts'
op|'['
string|"'zone'"
op|']'
op|')'
op|')'
newline|'\n'
comment|'# each part is assigned once to six unique devices'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'('
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'.'
name|'values'
op|'('
op|')'
op|')'
op|','
op|'['
number|'1'
op|']'
op|'*'
number|'6'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'set'
op|'('
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'.'
name|'keys'
op|'('
op|')'
op|')'
op|')'
op|','
number|'6'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multitier_part_moves_with_0_min_part_hours
dedent|''
dedent|''
name|'def'
name|'test_multitier_part_moves_with_0_min_part_hours'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|"# min_part_hours is 0, so we're clear to move 2 replicas to"
nl|'\n'
comment|'# new devs'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'devs'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'devs'
op|'.'
name|'add'
op|'('
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'devs'
op|')'
op|'!='
number|'3'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d not on 3 devs (got %r)"'
op|'%'
op|'('
name|'part'
op|','
name|'devs'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multitier_part_moves_with_positive_min_part_hours
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_multitier_part_moves_with_positive_min_part_hours'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'99'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|"# min_part_hours is >0, so we'll only be able to move 1"
nl|'\n'
comment|'# replica to a new home'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'devs'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'devs'
op|'.'
name|'add'
op|'('
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'any'
op|'('
name|'rb'
op|'.'
name|'devs'
op|'['
name|'dev_id'
op|']'
op|'['
string|"'zone'"
op|']'
op|'=='
number|'1'
name|'for'
name|'dev_id'
name|'in'
name|'devs'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d did not move (got %r)"'
op|'%'
op|'('
name|'part'
op|','
name|'devs'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multitier_dont_move_too_many_replicas
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_multitier_dont_move_too_many_replicas'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
comment|"# there'll be at least one replica in z0 and z1"
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# only 1 replica should move'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'4'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdf1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'zones'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'zones'
op|'.'
name|'add'
op|'('
name|'rb'
op|'.'
name|'devs'
op|'['
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|']'
op|'['
string|"'zone'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'zones'
op|')'
op|'!='
number|'3'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d not in 3 zones (got %r)"'
op|'%'
op|'('
name|'part'
op|','
name|'zones'
op|')'
op|')'
newline|'\n'
dedent|''
name|'if'
number|'0'
name|'not'
name|'in'
name|'zones'
name|'or'
number|'1'
name|'not'
name|'in'
name|'zones'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d not in zones 0 and 1 (got %r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'zones'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_min_part_hours_zero_will_move_whatever_it_takes
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_min_part_hours_zero_will_move_whatever_it_takes'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'0'
op|')'
newline|'\n'
comment|"# there'll be at least one replica in z0 and z1"
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'4'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdf1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'3'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'rb'
op|'.'
name|'dispersion'
op|')'
newline|'\n'
comment|"# a balance of w/i a 1% isn't too bad for 3 replicas on 7"
nl|'\n'
comment|'# devices when part power is only 8'
nl|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
name|'rb'
op|'.'
name|'get_balance'
op|'('
op|')'
op|','
number|'0'
op|','
name|'delta'
op|'='
number|'0.5'
op|')'
newline|'\n'
nl|'\n'
comment|'# every zone has either 153 or 154 parts'
nl|'\n'
name|'for'
name|'zone'
op|','
name|'count'
name|'in'
name|'self'
op|'.'
name|'_partition_counts'
op|'('
nl|'\n'
name|'rb'
op|','
name|'key'
op|'='
string|"'zone'"
op|')'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
number|'153.5'
op|','
name|'count'
op|','
name|'delta'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'parts_with_moved_count'
op|'='
name|'defaultdict'
op|'('
name|'int'
op|')'
newline|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'zones'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'zones'
op|'.'
name|'add'
op|'('
name|'rb'
op|'.'
name|'devs'
op|'['
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|']'
op|'['
string|"'zone'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'moved_replicas'
op|'='
name|'len'
op|'('
name|'zones'
op|'-'
op|'{'
number|'0'
op|','
number|'1'
op|'}'
op|')'
newline|'\n'
name|'parts_with_moved_count'
op|'['
name|'moved_replicas'
op|']'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
comment|'# as usual, the real numbers depend on the seed, but we want to'
nl|'\n'
comment|'# validate a few things here:'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# 1) every part had to move one replica to hit dispersion (so no'
nl|'\n'
comment|'# one can have a moved count 0)'
nl|'\n'
comment|'#'
nl|'\n'
comment|"# 2) it's quite reasonable that some small percent of parts will"
nl|'\n'
comment|'# have a replica in {0, 1, X} (meaning only one replica of the'
nl|'\n'
comment|'# part moved)'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# 3) when min_part_hours is 0, more than one replica of a part'
nl|'\n'
comment|'# can move in a rebalance, and since that movement would get to'
nl|'\n'
comment|'# better dispersion faster we expect to observe most parts in'
nl|'\n'
comment|'# {[0,1], X, X} (meaning *two* replicas of the part moved)'
nl|'\n'
comment|'#'
nl|'\n'
comment|"# 4) there's plenty of weight in z0 & z1 to hold a whole"
nl|'\n'
comment|'# replicanth, so there is no reason for any part to have to move'
nl|'\n'
comment|'# all three replicas out of those zones (meaning no one can have'
nl|'\n'
comment|'# a moved count 3)'
nl|'\n'
comment|'#'
nl|'\n'
dedent|''
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'1'
op|':'
number|'52'
op|','
nl|'\n'
number|'2'
op|':'
number|'204'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'parts_with_moved_count'
op|','
name|'expected'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rerebalance
dedent|''
name|'def'
name|'test_rerebalance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'256'
op|','
number|'1'
op|':'
number|'256'
op|','
number|'2'
op|':'
number|'256'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'192'
op|','
number|'1'
op|':'
number|'192'
op|','
number|'2'
op|':'
number|'192'
op|','
number|'3'
op|':'
number|'192'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'3'
op|','
number|'100'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|'['
number|'3'
op|']'
op|','
number|'256'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_rebalance_add_rebalance_delete_rebalance
dedent|''
name|'def'
name|'test_add_rebalance_add_rebalance_delete_rebalance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test for https://bugs.launchpad.net/swift/+bug/845952'
nl|'\n'
comment|'# min_part of 0 to allow for rapid rebalancing'
nl|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10005'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'1'
op|')'
newline|'\n'
nl|'\n'
comment|'# well now we have only one device in z0'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.5'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_last_partition_from_zero_weight
dedent|''
name|'def'
name|'test_remove_last_partition_from_zero_weight'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'4'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'0.4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'zero'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'zero_weight_dev'
op|'='
number|'3'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
comment|'# We want at least one partition with replicas only in zone 2 and 3'
nl|'\n'
comment|'# due to device weights. It would *like* to spread out into zone 1,'
nl|'\n'
comment|"# but can't, due to device weight."
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Also, we want such a partition to have a replica on device 3,'
nl|'\n'
comment|'# which we will then reduce to zero weight. This should cause the'
nl|'\n'
comment|'# removal of the replica from device 3.'
nl|'\n'
comment|'#'
nl|'\n'
comment|"# Getting this to happen by chance is hard, so let's just set up a"
nl|'\n'
comment|"# builder so that it's in the state we want. This is a synthetic"
nl|'\n'
comment|'# example; while the bug has happened on a real cluster, that'
nl|'\n'
comment|'# builder file had a part_power of 16, so its contents are much too'
nl|'\n'
comment|'# big to include here.'
nl|'\n'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'='
op|'['
nl|'\n'
comment|'#                            these are the relevant ones'
nl|'\n'
comment|'#                                   |  |  |'
nl|'\n'
comment|'#                                   v  v  v'
nl|'\n'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'2'
op|','
number|'5'
op|','
number|'6'
op|','
number|'2'
op|','
number|'5'
op|','
number|'6'
op|','
number|'2'
op|','
number|'5'
op|','
number|'6'
op|','
number|'2'
op|','
number|'5'
op|','
number|'6'
op|','
number|'2'
op|','
number|'5'
op|','
number|'6'
op|','
number|'2'
op|']'
op|')'
op|','
nl|'\n'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'1'
op|','
number|'4'
op|','
number|'1'
op|','
number|'4'
op|','
number|'1'
op|','
number|'4'
op|','
number|'1'
op|','
number|'4'
op|','
number|'1'
op|','
number|'4'
op|','
number|'1'
op|','
number|'4'
op|','
number|'1'
op|','
number|'4'
op|','
number|'1'
op|','
number|'4'
op|']'
op|')'
op|','
nl|'\n'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'3'
op|','
number|'3'
op|','
number|'3'
op|','
number|'5'
op|','
number|'6'
op|','
number|'2'
op|','
number|'5'
op|','
number|'6'
op|']'
op|')'
op|']'
newline|'\n'
nl|'\n'
comment|'# fix up bookkeeping'
nl|'\n'
name|'new_dev_parts'
op|'='
name|'defaultdict'
op|'('
name|'int'
op|')'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'new_dev_parts'
op|'['
name|'dev_id'
op|']'
op|'+='
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'for'
name|'dev'
name|'in'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'dev'
op|'['
string|"'parts'"
op|']'
op|'='
name|'new_dev_parts'
op|'['
name|'dev'
op|'['
string|"'id'"
op|']'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
name|'zero_weight_dev'
op|','
number|'0.0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'node_counts'
op|'='
name|'defaultdict'
op|'('
name|'int'
op|')'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'node_counts'
op|'['
name|'dev_id'
op|']'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'node_counts'
op|'['
name|'zero_weight_dev'
op|']'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|"# it's as balanced as it gets, so nothing moves anymore"
nl|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'parts_moved'
op|','
name|'_balance'
op|','
name|'_removed'
op|'='
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'new_node_counts'
op|'='
name|'defaultdict'
op|'('
name|'int'
op|')'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'new_node_counts'
op|'['
name|'dev_id'
op|']'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'del'
name|'node_counts'
op|'['
name|'zero_weight_dev'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'node_counts'
op|','
name|'new_node_counts'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'parts_moved'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_part_swapping_problem
dedent|''
name|'def'
name|'test_part_swapping_problem'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'4'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# 127.0.0.1 (2 devs)'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
comment|'# 127.0.0.2 (3 devs)'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'127.0.0.1'"
op|':'
number|'1.2'
op|','
nl|'\n'
string|"'127.0.0.2'"
op|':'
number|'1.7999999999999998'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'for'
name|'wr'
name|'in'
op|'('
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
op|','
nl|'\n'
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
op|','
nl|'\n'
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'t'
op|'['
op|'-'
number|'1'
op|']'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'wr'
op|'.'
name|'items'
op|'('
op|')'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'3'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'3'
op|')'
newline|'\n'
comment|'# so 127.0.0.1 ended up with...'
nl|'\n'
name|'tier'
op|'='
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|')'
newline|'\n'
comment|'# ... 6 parts with 1 replicas'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'_dispersion_graph'
op|'['
name|'tier'
op|']'
op|'['
number|'1'
op|']'
op|','
number|'12'
op|')'
newline|'\n'
comment|'# ... 4 parts with 2 replicas'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'_dispersion_graph'
op|'['
name|'tier'
op|']'
op|'['
number|'2'
op|']'
op|','
number|'4'
op|')'
newline|'\n'
comment|'# but since we only have two tiers, this is *totally* dispersed'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'rb'
op|'.'
name|'dispersion'
op|')'
newline|'\n'
nl|'\n'
comment|'# small rings are hard to balance...'
nl|'\n'
name|'expected'
op|'='
op|'{'
number|'0'
op|':'
number|'10'
op|','
number|'1'
op|':'
number|'10'
op|','
number|'2'
op|':'
number|'10'
op|','
number|'3'
op|':'
number|'9'
op|','
number|'4'
op|':'
number|'9'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'d'
op|'['
string|"'id'"
op|']'
op|':'
name|'d'
op|'['
string|"'parts'"
op|']'
nl|'\n'
name|'for'
name|'d'
name|'in'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|'}'
op|')'
newline|'\n'
comment|'# everyone wants 9.6 parts'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'4.166666666666671'
op|','
nl|'\n'
number|'1'
op|':'
number|'4.166666666666671'
op|','
nl|'\n'
number|'2'
op|':'
number|'4.166666666666671'
op|','
nl|'\n'
number|'3'
op|':'
op|'-'
number|'6.25'
op|','
nl|'\n'
number|'4'
op|':'
op|'-'
number|'6.25'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
name|'rb'
op|'.'
name|'_build_balance_per_dev'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# original sorted _replica2part2dev'
nl|'\n'
string|'"""\n        rb._replica2part2dev = [\n            array(\'H\', [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1]),\n            array(\'H\', [1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 2, 2, 2, 3, 3, 3]),\n            array(\'H\', [2, 2, 2, 2, 3, 3, 4, 4, 4, 4, 3, 4, 4, 4, 4, 4])]\n        """'
newline|'\n'
nl|'\n'
comment|'# now imagine if we came along this _replica2part2dev through no'
nl|'\n'
comment|'# fault of our own; if instead of the 12 parts with only one'
nl|'\n'
comment|"# replica on 127.0.0.1 being split evenly (6 and 6) on device's"
nl|'\n'
comment|'# 0 and 1 - device 1 inexplicitly had 3 extra parts'
nl|'\n'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'='
op|'['
nl|'\n'
comment|"#                    these are the relevant one's here"
nl|'\n'
comment|'#                                |  |  |'
nl|'\n'
comment|'#                                v  v  v'
nl|'\n'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'1'
op|','
number|'1'
op|','
number|'1'
op|','
number|'1'
op|','
number|'1'
op|','
number|'1'
op|','
number|'1'
op|','
number|'1'
op|','
number|'1'
op|']'
op|')'
op|','
nl|'\n'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'1'
op|','
number|'1'
op|','
number|'1'
op|','
number|'1'
op|','
number|'2'
op|','
number|'2'
op|','
number|'2'
op|','
number|'3'
op|','
number|'3'
op|','
number|'3'
op|','
number|'2'
op|','
number|'2'
op|','
number|'2'
op|','
number|'3'
op|','
number|'3'
op|','
number|'3'
op|']'
op|')'
op|','
nl|'\n'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'2'
op|','
number|'2'
op|','
number|'2'
op|','
number|'2'
op|','
number|'3'
op|','
number|'3'
op|','
number|'4'
op|','
number|'4'
op|','
number|'4'
op|','
number|'4'
op|','
number|'3'
op|','
number|'4'
op|','
number|'4'
op|','
number|'4'
op|','
number|'4'
op|','
number|'4'
op|']'
op|')'
op|']'
newline|'\n'
nl|'\n'
comment|'# fix up bookkeeping'
nl|'\n'
name|'new_dev_parts'
op|'='
name|'defaultdict'
op|'('
name|'int'
op|')'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'new_dev_parts'
op|'['
name|'dev_id'
op|']'
op|'+='
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'for'
name|'dev'
name|'in'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'dev'
op|'['
string|"'parts'"
op|']'
op|'='
name|'new_dev_parts'
op|'['
name|'dev'
op|'['
string|"'id'"
op|']'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'4.166666666666671'
op|','
nl|'\n'
number|'1'
op|':'
number|'4.166666666666671'
op|','
nl|'\n'
number|'2'
op|':'
number|'4.166666666666671'
op|','
nl|'\n'
number|'3'
op|':'
op|'-'
number|'6.25'
op|','
nl|'\n'
number|'4'
op|':'
op|'-'
number|'6.25'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
name|'rb'
op|'.'
name|'_build_balance_per_dev'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'get_balance'
op|'('
op|')'
op|','
number|'6.25'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_wrong_tier_with_no_where_to_go
dedent|''
name|'def'
name|'test_wrong_tier_with_no_where_to_go'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'4'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
comment|'# 127.0.0.1 (even devices)'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'900'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'900'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'900'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
comment|'# 127.0.0.2 (odd devices)'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'500'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'500'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'500'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'500'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'127.0.0.1'"
op|':'
number|'1.75'
op|','
nl|'\n'
string|"'127.0.0.2'"
op|':'
number|'1.25'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'for'
name|'wr'
name|'in'
op|'('
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
op|','
nl|'\n'
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
op|','
nl|'\n'
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'t'
op|'['
op|'-'
number|'1'
op|']'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'wr'
op|'.'
name|'items'
op|'('
op|')'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'3'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'3'
op|')'
newline|'\n'
comment|'# so 127.0.0.1 ended up with...'
nl|'\n'
name|'tier'
op|'='
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|')'
newline|'\n'
comment|'# ... 4 parts with 1 replicas'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'_dispersion_graph'
op|'['
name|'tier'
op|']'
op|'['
number|'1'
op|']'
op|','
number|'4'
op|')'
newline|'\n'
comment|'# ... 12 parts with 2 replicas'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'_dispersion_graph'
op|'['
name|'tier'
op|']'
op|'['
number|'2'
op|']'
op|','
number|'12'
op|')'
newline|'\n'
comment|'# ... and of course 0 parts with 3 replicas'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'_dispersion_graph'
op|'['
name|'tier'
op|']'
op|'['
number|'3'
op|']'
op|','
number|'0'
op|')'
newline|'\n'
comment|'# but since we only have two tiers, this is *totally* dispersed'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'rb'
op|'.'
name|'dispersion'
op|')'
newline|'\n'
nl|'\n'
comment|"# small rings are hard to balance, but it's possible when"
nl|'\n'
comment|'# part-replicas (3 * 2 ** 4) can go evenly into device weights'
nl|'\n'
comment|"# (4800) like we've done here"
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'1'
op|','
nl|'\n'
number|'2'
op|':'
number|'9'
op|','
nl|'\n'
number|'4'
op|':'
number|'9'
op|','
nl|'\n'
number|'6'
op|':'
number|'9'
op|','
nl|'\n'
number|'1'
op|':'
number|'5'
op|','
nl|'\n'
number|'3'
op|':'
number|'5'
op|','
nl|'\n'
number|'5'
op|':'
number|'5'
op|','
nl|'\n'
number|'7'
op|':'
number|'5'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'d'
op|'['
string|"'id'"
op|']'
op|':'
name|'d'
op|'['
string|"'parts'"
op|']'
nl|'\n'
name|'for'
name|'d'
name|'in'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|'}'
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'0.0'
op|','
nl|'\n'
number|'1'
op|':'
number|'0.0'
op|','
nl|'\n'
number|'2'
op|':'
number|'0.0'
op|','
nl|'\n'
number|'3'
op|':'
number|'0.0'
op|','
nl|'\n'
number|'4'
op|':'
number|'0.0'
op|','
nl|'\n'
number|'5'
op|':'
number|'0.0'
op|','
nl|'\n'
number|'6'
op|':'
number|'0.0'
op|','
nl|'\n'
number|'7'
op|':'
number|'0.0'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
name|'rb'
op|'.'
name|'_build_balance_per_dev'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# all devices have exactly the # of parts they want'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'0'
op|','
nl|'\n'
number|'2'
op|':'
number|'0'
op|','
nl|'\n'
number|'4'
op|':'
number|'0'
op|','
nl|'\n'
number|'6'
op|':'
number|'0'
op|','
nl|'\n'
number|'1'
op|':'
number|'0'
op|','
nl|'\n'
number|'3'
op|':'
number|'0'
op|','
nl|'\n'
number|'5'
op|':'
number|'0'
op|','
nl|'\n'
number|'7'
op|':'
number|'0'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'d'
op|'['
string|"'id'"
op|']'
op|':'
name|'d'
op|'['
string|"'parts_wanted'"
op|']'
nl|'\n'
name|'for'
name|'d'
name|'in'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# original sorted _replica2part2dev'
nl|'\n'
string|'"""\n        rb._replica2part2dev = [\n            array(\'H\', [0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 4, 4, 4, 4, 4, 4, ]),\n            array(\'H\', [4, 4, 4, 6, 6, 6, 6, 6, 6, 6, 6, 6, 1, 1, 1, 1, ]),\n            array(\'H\', [1, 3, 3, 3, 3, 3, 5, 5, 5, 5, 5, 7, 7, 7, 7, 7, ])]\n        """'
newline|'\n'
comment|'# now imagine if we came along this _replica2part2dev through no'
nl|'\n'
comment|'# fault of our own; and device 0 had extra parts, but both'
nl|'\n'
comment|'# copies of the other replicas were already in the other tier!'
nl|'\n'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'='
op|'['
nl|'\n'
comment|"#                          these are the relevant one's here"
nl|'\n'
comment|'#                                                     |  |'
nl|'\n'
comment|'#                                                     v  v'
nl|'\n'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'2'
op|','
number|'2'
op|','
number|'2'
op|','
number|'2'
op|','
number|'2'
op|','
number|'2'
op|','
number|'2'
op|','
number|'2'
op|','
number|'2'
op|','
number|'4'
op|','
number|'4'
op|','
number|'4'
op|','
number|'4'
op|','
number|'4'
op|','
number|'0'
op|','
number|'0'
op|']'
op|')'
op|','
nl|'\n'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'4'
op|','
number|'4'
op|','
number|'4'
op|','
number|'4'
op|','
number|'6'
op|','
number|'6'
op|','
number|'6'
op|','
number|'6'
op|','
number|'6'
op|','
number|'6'
op|','
number|'6'
op|','
number|'6'
op|','
number|'6'
op|','
number|'1'
op|','
number|'1'
op|','
number|'1'
op|']'
op|')'
op|','
nl|'\n'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'1'
op|','
number|'1'
op|','
number|'3'
op|','
number|'3'
op|','
number|'3'
op|','
number|'3'
op|','
number|'5'
op|','
number|'5'
op|','
number|'5'
op|','
number|'5'
op|','
number|'5'
op|','
number|'7'
op|','
number|'7'
op|','
number|'7'
op|','
number|'7'
op|','
number|'7'
op|']'
op|')'
op|']'
newline|'\n'
nl|'\n'
comment|'# fix up bookkeeping'
nl|'\n'
name|'new_dev_parts'
op|'='
name|'defaultdict'
op|'('
name|'int'
op|')'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'new_dev_parts'
op|'['
name|'dev_id'
op|']'
op|'+='
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'for'
name|'dev'
name|'in'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'dev'
op|'['
string|"'parts'"
op|']'
op|'='
name|'new_dev_parts'
op|'['
name|'dev'
op|'['
string|"'id'"
op|']'
op|']'
newline|'\n'
dedent|''
name|'replica_plan'
op|'='
name|'rb'
op|'.'
name|'_build_replica_plan'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'_set_parts_wanted'
op|'('
name|'replica_plan'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
op|'-'
number|'1'
op|','
comment|'# this device wants to shed'
nl|'\n'
number|'2'
op|':'
number|'0'
op|','
nl|'\n'
number|'4'
op|':'
number|'0'
op|','
nl|'\n'
number|'6'
op|':'
number|'0'
op|','
nl|'\n'
number|'1'
op|':'
number|'0'
op|','
nl|'\n'
number|'3'
op|':'
number|'1'
op|','
comment|"# there's devices with room on the other server"
nl|'\n'
number|'5'
op|':'
number|'0'
op|','
nl|'\n'
number|'7'
op|':'
number|'0'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'d'
op|'['
string|"'id'"
op|']'
op|':'
name|'d'
op|'['
string|"'parts_wanted'"
op|']'
nl|'\n'
name|'for'
name|'d'
name|'in'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'get_balance'
op|'('
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_region_fullness_with_balanceable_ring
dedent|''
name|'def'
name|'test_region_fullness_with_balanceable_ring'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'2'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10005'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'2'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10006'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'3'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10007'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'3'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10008'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
nl|'\n'
name|'population_by_region'
op|'='
name|'self'
op|'.'
name|'_get_population_by_region'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'population_by_region'
op|','
nl|'\n'
op|'{'
number|'0'
op|':'
number|'192'
op|','
number|'1'
op|':'
number|'192'
op|','
number|'2'
op|':'
number|'192'
op|','
number|'3'
op|':'
number|'192'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_region_fullness_with_unbalanceable_ring
dedent|''
name|'def'
name|'test_region_fullness_with_unbalanceable_ring'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
nl|'\n'
name|'population_by_region'
op|'='
name|'self'
op|'.'
name|'_get_population_by_region'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'population_by_region'
op|','
op|'{'
number|'0'
op|':'
number|'512'
op|','
number|'1'
op|':'
number|'256'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_adding_region_slowly_with_unbalanceable_ring
dedent|''
name|'def'
name|'test_adding_region_slowly_with_unbalanceable_ring'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.25'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.25'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'changed_parts'
op|','
name|'_balance'
op|','
name|'_removed'
op|'='
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
nl|'\n'
comment|"# there's not enough room in r1 for every partition to have a replica"
nl|'\n'
comment|"# in it, so only 86 assignments occur in r1 (that's ~1/5 of the total,"
nl|'\n'
comment|'# since r1 has 1/5 of the weight).'
nl|'\n'
name|'population_by_region'
op|'='
name|'self'
op|'.'
name|'_get_population_by_region'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'population_by_region'
op|','
op|'{'
number|'0'
op|':'
number|'682'
op|','
number|'1'
op|':'
number|'86'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# really 86 parts *should* move (to the new region) but to avoid'
nl|'\n'
comment|'# accidentally picking up too many and causing some parts to randomly'
nl|'\n'
comment|'# flop around devices in the original region - our gather algorithm'
nl|'\n'
comment|'# is conservative when picking up only from devices that are for sure'
nl|'\n'
comment|'# holding more parts than they want (math.ceil() of the replica_plan)'
nl|'\n'
comment|'# which guarantees any parts picked up will have new homes in a better'
nl|'\n'
comment|'# tier or failure_domain.'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'86'
op|','
name|'changed_parts'
op|')'
newline|'\n'
nl|'\n'
comment|"# and since there's not enough room, subsequent rebalances will not"
nl|'\n'
comment|'# cause additional assignments to r1'
nl|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
name|'population_by_region'
op|'='
name|'self'
op|'.'
name|'_get_population_by_region'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'population_by_region'
op|','
op|'{'
number|'0'
op|':'
number|'682'
op|','
number|'1'
op|':'
number|'86'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# after you add more weight, more partition assignments move'
nl|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'2'
op|','
number|'0.5'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'3'
op|','
number|'0.5'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
name|'population_by_region'
op|'='
name|'self'
op|'.'
name|'_get_population_by_region'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'population_by_region'
op|','
op|'{'
number|'0'
op|':'
number|'614'
op|','
number|'1'
op|':'
number|'154'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'2'
op|','
number|'1.0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'3'
op|','
number|'1.0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
name|'population_by_region'
op|'='
name|'self'
op|'.'
name|'_get_population_by_region'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'population_by_region'
op|','
op|'{'
number|'0'
op|':'
number|'512'
op|','
number|'1'
op|':'
number|'256'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_avoid_tier_change_new_region
dedent|''
name|'def'
name|'test_avoid_tier_change_new_region'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
number|'5'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
name|'i'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
name|'i'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
nl|'\n'
comment|'# Add a new device in new region to a balanced ring'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.5'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# Increase the weight of region 1 slowly'
nl|'\n'
name|'moved_partitions'
op|'='
op|'['
op|']'
newline|'\n'
name|'errors'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'weight'
name|'in'
name|'range'
op|'('
number|'0'
op|','
number|'101'
op|','
number|'10'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'5'
op|','
name|'weight'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'changed_parts'
op|','
name|'_balance'
op|','
name|'_removed'
op|'='
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
name|'moved_partitions'
op|'.'
name|'append'
op|'('
name|'changed_parts'
op|')'
newline|'\n'
comment|'# Ensure that the second region has enough partitions'
nl|'\n'
comment|'# Otherwise there will be replicas at risk'
nl|'\n'
name|'min_parts_for_r1'
op|'='
name|'ceil'
op|'('
name|'weight'
op|'/'
op|'('
number|'500.0'
op|'+'
name|'weight'
op|')'
op|'*'
number|'768'
op|')'
newline|'\n'
name|'parts_for_r1'
op|'='
name|'self'
op|'.'
name|'_get_population_by_region'
op|'('
name|'rb'
op|')'
op|'.'
name|'get'
op|'('
number|'1'
op|','
number|'0'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'min_parts_for_r1'
op|','
name|'parts_for_r1'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'AssertionError'
op|':'
newline|'\n'
indent|'                '
name|'errors'
op|'.'
name|'append'
op|'('
string|"'weight %s got %s parts but expected %s'"
op|'%'
op|'('
nl|'\n'
name|'weight'
op|','
name|'parts_for_r1'
op|','
name|'min_parts_for_r1'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'errors'
op|')'
newline|'\n'
nl|'\n'
comment|'# Number of partitions moved on each rebalance'
nl|'\n'
comment|'# 10/510 * 768 ~ 15.06 -> move at least 15 partitions in first step'
nl|'\n'
name|'ref'
op|'='
op|'['
number|'0'
op|','
number|'16'
op|','
number|'14'
op|','
number|'14'
op|','
number|'13'
op|','
number|'13'
op|','
number|'13'
op|','
number|'12'
op|','
number|'11'
op|','
number|'12'
op|','
number|'10'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'ref'
op|','
name|'moved_partitions'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_replicas_increase
dedent|''
name|'def'
name|'test_set_replicas_increase'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'2'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'replicas'
op|'='
number|'2.1'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'len'
op|'('
name|'p2d'
op|')'
name|'for'
name|'p2d'
name|'in'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|']'
op|','
nl|'\n'
op|'['
number|'256'
op|','
number|'256'
op|','
number|'25'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'replicas'
op|'='
number|'2.2'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'len'
op|'('
name|'p2d'
op|')'
name|'for'
name|'p2d'
name|'in'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|']'
op|','
nl|'\n'
op|'['
number|'256'
op|','
number|'256'
op|','
number|'51'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_replicas_decrease
dedent|''
name|'def'
name|'test_set_replicas_decrease'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'4'
op|','
number|'5'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'replicas'
op|'='
number|'4.9'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'len'
op|'('
name|'p2d'
op|')'
name|'for'
name|'p2d'
name|'in'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|']'
op|','
nl|'\n'
op|'['
number|'16'
op|','
number|'16'
op|','
number|'16'
op|','
number|'16'
op|','
number|'14'
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# cross a couple of integer thresholds (4 and 3)'
nl|'\n'
name|'rb'
op|'.'
name|'replicas'
op|'='
number|'2.5'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'len'
op|'('
name|'p2d'
op|')'
name|'for'
name|'p2d'
name|'in'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|']'
op|','
nl|'\n'
op|'['
number|'16'
op|','
number|'16'
op|','
number|'8'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_fractional_replicas_rebalance
dedent|''
name|'def'
name|'test_fractional_replicas_rebalance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'2.5'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
comment|'# passes by not crashing'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
comment|'# also passes by not crashing'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'len'
op|'('
name|'p2d'
op|')'
name|'for'
name|'p2d'
name|'in'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|']'
op|','
nl|'\n'
op|'['
number|'256'
op|','
number|'256'
op|','
number|'128'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_add_dev_add_replica_rebalance
dedent|''
name|'def'
name|'test_create_add_dev_add_replica_rebalance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_replicas'
op|'('
number|'4'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
comment|'# this would crash since parts_wanted was not set'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebalance_post_upgrade
dedent|''
name|'def'
name|'test_rebalance_post_upgrade'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# 5 devices: 5 is the smallest number that does not divide 3 * 2^8,'
nl|'\n'
comment|'# which forces some rounding to happen.'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# Older versions of the ring builder code would round down when'
nl|'\n'
comment|'# computing parts_wanted, while the new code rounds up. Make sure we'
nl|'\n'
comment|'# can handle a ring built by the old method.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# This code mimics the old _set_parts_wanted.'
nl|'\n'
name|'weight_of_one_part'
op|'='
name|'rb'
op|'.'
name|'weight_of_one_part'
op|'('
op|')'
newline|'\n'
name|'for'
name|'dev'
name|'in'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'dev'
op|'['
string|"'weight'"
op|']'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'['
string|"'parts_wanted'"
op|']'
op|'='
op|'-'
name|'rb'
op|'.'
name|'parts'
op|'*'
name|'rb'
op|'.'
name|'replicas'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'['
string|"'parts_wanted'"
op|']'
op|'='
op|'('
nl|'\n'
name|'int'
op|'('
name|'weight_of_one_part'
op|'*'
name|'dev'
op|'['
string|"'weight'"
op|']'
op|')'
op|'-'
nl|'\n'
name|'dev'
op|'['
string|"'parts'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
comment|'# this crashes unless rebalance resets parts_wanted'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_replicas_then_rebalance_respects_weight
dedent|''
name|'def'
name|'test_add_replicas_then_rebalance_respects_weight'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdg'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdh'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdi'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdj'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'10'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdk'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'11'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdl'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'dev_id'
op|']'
op|'='
name|'counts'
op|'.'
name|'get'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'96'
op|','
number|'1'
op|':'
number|'96'
op|','
nl|'\n'
number|'2'
op|':'
number|'32'
op|','
number|'3'
op|':'
number|'32'
op|','
nl|'\n'
number|'4'
op|':'
number|'96'
op|','
number|'5'
op|':'
number|'96'
op|','
nl|'\n'
number|'6'
op|':'
number|'32'
op|','
number|'7'
op|':'
number|'32'
op|','
nl|'\n'
number|'8'
op|':'
number|'96'
op|','
number|'9'
op|':'
number|'96'
op|','
nl|'\n'
number|'10'
op|':'
number|'32'
op|','
number|'11'
op|':'
number|'32'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'replicas'
op|'*='
number|'2'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'dev_id'
op|']'
op|'='
name|'counts'
op|'.'
name|'get'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'192'
op|','
number|'1'
op|':'
number|'192'
op|','
nl|'\n'
number|'2'
op|':'
number|'64'
op|','
number|'3'
op|':'
number|'64'
op|','
nl|'\n'
number|'4'
op|':'
number|'192'
op|','
number|'5'
op|':'
number|'192'
op|','
nl|'\n'
number|'6'
op|':'
number|'64'
op|','
number|'7'
op|':'
number|'64'
op|','
nl|'\n'
number|'8'
op|':'
number|'192'
op|','
number|'9'
op|':'
number|'192'
op|','
nl|'\n'
number|'10'
op|':'
number|'64'
op|','
number|'11'
op|':'
number|'64'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_overload
dedent|''
name|'def'
name|'test_overload'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdg'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdh'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdi'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdj'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'10'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdk'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'11'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdl'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# sanity check: balance respects weights, so default'
nl|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'zone'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'0'
op|']'
op|','
number|'192'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'1'
op|']'
op|','
number|'192'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'2'
op|']'
op|','
number|'384'
op|')'
newline|'\n'
nl|'\n'
comment|'# Devices 0 and 1 take 10% more than their fair shares by weight since'
nl|'\n'
comment|'# overload is 10% (0.1).'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'zone'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'0'
op|']'
op|','
number|'212'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'1'
op|']'
op|','
number|'211'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'2'
op|']'
op|','
number|'345'
op|')'
newline|'\n'
nl|'\n'
comment|'# Now, devices 0 and 1 take 50% more than their fair shares by'
nl|'\n'
comment|'# weight.'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.5'
op|')'
newline|'\n'
name|'for'
name|'_'
name|'in'
name|'range'
op|'('
number|'3'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'zone'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'0'
op|']'
op|','
number|'256'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'1'
op|']'
op|','
number|'256'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'2'
op|']'
op|','
number|'256'
op|')'
newline|'\n'
nl|'\n'
comment|'# Devices 0 and 1 may take up to 75% over their fair share, but the'
nl|'\n'
comment|'# placement algorithm only wants to spread things out evenly between'
nl|'\n'
comment|'# all drives, so the devices stay at 50% more.'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.75'
op|')'
newline|'\n'
name|'for'
name|'_'
name|'in'
name|'range'
op|'('
number|'3'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'zone'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'0'
op|']'
op|','
number|'256'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'1'
op|']'
op|','
number|'256'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'2'
op|']'
op|','
number|'256'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_unoverload
dedent|''
name|'def'
name|'test_unoverload'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Start off needing overload to balance, then add capacity until we'
nl|'\n'
comment|"# don't need overload any more and see that things still balance."
nl|'\n'
comment|"# Overload doesn't prevent optimal balancing."
nl|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.125'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'10'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'11'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
nl|'\n'
comment|'# sanity check: our overload is big enough to balance things'
nl|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'ip'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.1'"
op|']'
op|','
number|'216'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.2'"
op|']'
op|','
number|'216'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.3'"
op|']'
op|','
number|'336'
op|')'
newline|'\n'
nl|'\n'
comment|'# Add some weight: balance improves'
nl|'\n'
name|'for'
name|'dev'
name|'in'
name|'rb'
op|'.'
name|'devs'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'dev'
op|'['
string|"'ip'"
op|']'
name|'in'
op|'('
string|"'127.0.0.1'"
op|','
string|"'127.0.0.2'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
name|'dev'
op|'['
string|"'id'"
op|']'
op|','
number|'1.22'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
nl|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'ip'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.1'"
op|']'
op|','
number|'238'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.2'"
op|']'
op|','
number|'237'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.3'"
op|']'
op|','
number|'293'
op|')'
newline|'\n'
nl|'\n'
comment|'# Even out the weights: balance becomes perfect'
nl|'\n'
name|'for'
name|'dev'
name|'in'
name|'rb'
op|'.'
name|'devs'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'dev'
op|'['
string|"'ip'"
op|']'
name|'in'
op|'('
string|"'127.0.0.1'"
op|','
string|"'127.0.0.2'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
name|'dev'
op|'['
string|"'id'"
op|']'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
nl|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'ip'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.1'"
op|']'
op|','
number|'256'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.2'"
op|']'
op|','
number|'256'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.3'"
op|']'
op|','
number|'256'
op|')'
newline|'\n'
nl|'\n'
comment|'# Add a new server: balance stays optimal'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'12'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'13'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'14'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'15'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|"# we're moving more than 1/3 of the replicas but fewer than 2/3, so"
nl|'\n'
comment|'# we have to do this twice'
nl|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'127.0.0.1'"
op|':'
number|'192'
op|','
nl|'\n'
string|"'127.0.0.2'"
op|':'
number|'192'
op|','
nl|'\n'
string|"'127.0.0.3'"
op|':'
number|'192'
op|','
nl|'\n'
string|"'127.0.0.4'"
op|':'
number|'192'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'ip'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|','
name|'expected'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_overload_keeps_balanceable_things_balanced_initially
dedent|''
name|'def'
name|'test_overload_keeps_balanceable_things_balanced_initially'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'8'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'8'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.5'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.5'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'99999'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
nl|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|','
op|'{'
nl|'\n'
number|'0'
op|':'
number|'128'
op|','
nl|'\n'
number|'1'
op|':'
number|'128'
op|','
nl|'\n'
number|'2'
op|':'
number|'64'
op|','
nl|'\n'
number|'3'
op|':'
number|'64'
op|','
nl|'\n'
number|'4'
op|':'
number|'64'
op|','
nl|'\n'
number|'5'
op|':'
number|'64'
op|','
nl|'\n'
number|'6'
op|':'
number|'64'
op|','
nl|'\n'
number|'7'
op|':'
number|'64'
op|','
nl|'\n'
number|'8'
op|':'
number|'64'
op|','
nl|'\n'
number|'9'
op|':'
number|'64'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_overload_keeps_balanceable_things_balanced_on_rebalance
dedent|''
name|'def'
name|'test_overload_keeps_balanceable_things_balanced_on_rebalance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'8'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'8'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.5'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.5'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'99999'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'123'
op|')'
newline|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|','
op|'{'
nl|'\n'
number|'0'
op|':'
number|'128'
op|','
nl|'\n'
number|'1'
op|':'
number|'128'
op|','
nl|'\n'
number|'2'
op|':'
number|'64'
op|','
nl|'\n'
number|'3'
op|':'
number|'64'
op|','
nl|'\n'
number|'4'
op|':'
number|'64'
op|','
nl|'\n'
number|'5'
op|':'
number|'64'
op|','
nl|'\n'
number|'6'
op|':'
number|'64'
op|','
nl|'\n'
number|'7'
op|':'
number|'64'
op|','
nl|'\n'
number|'8'
op|':'
number|'64'
op|','
nl|'\n'
number|'9'
op|':'
number|'64'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# swap weights between 10.0.0.1 and 10.0.0.2'
nl|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'0'
op|','
number|'4'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'1'
op|','
number|'4'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'2'
op|','
number|'8'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'1'
op|','
number|'8'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'456'
op|')'
newline|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|','
op|'{'
nl|'\n'
number|'0'
op|':'
number|'128'
op|','
nl|'\n'
number|'1'
op|':'
number|'128'
op|','
nl|'\n'
number|'2'
op|':'
number|'64'
op|','
nl|'\n'
number|'3'
op|':'
number|'64'
op|','
nl|'\n'
number|'4'
op|':'
number|'64'
op|','
nl|'\n'
number|'5'
op|':'
number|'64'
op|','
nl|'\n'
number|'6'
op|':'
number|'64'
op|','
nl|'\n'
number|'7'
op|':'
number|'64'
op|','
nl|'\n'
number|'8'
op|':'
number|'64'
op|','
nl|'\n'
number|'9'
op|':'
number|'64'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_server_per_port
dedent|''
name|'def'
name|'test_server_per_port'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# 3 servers, 3 disks each, with each disk on its own port'
nl|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdx'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdy'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdx'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdy'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdx'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdy'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdz'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdz'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdz'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'poorly_dispersed'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'on_nodes'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'dev_id'
op|'='
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
newline|'\n'
name|'on_nodes'
op|'.'
name|'add'
op|'('
name|'rb'
op|'.'
name|'devs'
op|'['
name|'dev_id'
op|']'
op|'['
string|"'ip'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'on_nodes'
op|')'
op|'<'
name|'rb'
op|'.'
name|'replicas'
op|':'
newline|'\n'
indent|'                '
name|'poorly_dispersed'
op|'.'
name|'append'
op|'('
name|'part'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'poorly_dispersed'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_load
dedent|''
name|'def'
name|'test_load'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'devs'
op|'='
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta0'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta1'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta2'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|']'
newline|'\n'
name|'for'
name|'d'
name|'in'
name|'devs'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'add_dev'
op|'('
name|'d'
op|')'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'real_pickle'
op|'='
name|'pickle'
op|'.'
name|'load'
newline|'\n'
name|'fake_open'
op|'='
name|'mock'
op|'.'
name|'mock_open'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'io_error_not_found'
op|'='
name|'IOError'
op|'('
op|')'
newline|'\n'
name|'io_error_not_found'
op|'.'
name|'errno'
op|'='
name|'errno'
op|'.'
name|'ENOENT'
newline|'\n'
nl|'\n'
name|'io_error_no_perm'
op|'='
name|'IOError'
op|'('
op|')'
newline|'\n'
name|'io_error_no_perm'
op|'.'
name|'errno'
op|'='
name|'errno'
op|'.'
name|'EPERM'
newline|'\n'
nl|'\n'
name|'io_error_generic'
op|'='
name|'IOError'
op|'('
op|')'
newline|'\n'
name|'io_error_generic'
op|'.'
name|'errno'
op|'='
name|'errno'
op|'.'
name|'EOPNOTSUPP'
newline|'\n'
name|'try'
op|':'
newline|'\n'
comment|'# test a legit builder'
nl|'\n'
indent|'            '
name|'fake_pickle'
op|'='
name|'mock'
op|'.'
name|'Mock'
op|'('
name|'return_value'
op|'='
name|'rb'
op|')'
newline|'\n'
name|'pickle'
op|'.'
name|'load'
op|'='
name|'fake_pickle'
newline|'\n'
name|'builder'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|'('
string|"'fake.builder'"
op|','
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fake_pickle'
op|'.'
name|'call_count'
op|','
number|'1'
op|')'
newline|'\n'
name|'fake_open'
op|'.'
name|'assert_has_calls'
op|'('
op|'['
name|'mock'
op|'.'
name|'call'
op|'('
string|"'fake.builder'"
op|','
string|"'rb'"
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'builder'
op|','
name|'rb'
op|')'
newline|'\n'
name|'fake_pickle'
op|'.'
name|'reset_mock'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# test old style builder'
nl|'\n'
name|'fake_pickle'
op|'.'
name|'return_value'
op|'='
name|'rb'
op|'.'
name|'to_dict'
op|'('
op|')'
newline|'\n'
name|'pickle'
op|'.'
name|'load'
op|'='
name|'fake_pickle'
newline|'\n'
name|'builder'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|'('
string|"'fake.builder'"
op|','
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
name|'fake_open'
op|'.'
name|'assert_has_calls'
op|'('
op|'['
name|'mock'
op|'.'
name|'call'
op|'('
string|"'fake.builder'"
op|','
string|"'rb'"
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'builder'
op|'.'
name|'devs'
op|','
name|'rb'
op|'.'
name|'devs'
op|')'
newline|'\n'
name|'fake_pickle'
op|'.'
name|'reset_mock'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# test old devs but no meta'
nl|'\n'
name|'no_meta_builder'
op|'='
name|'rb'
newline|'\n'
name|'for'
name|'dev'
name|'in'
name|'no_meta_builder'
op|'.'
name|'devs'
op|':'
newline|'\n'
indent|'                '
name|'del'
op|'('
name|'dev'
op|'['
string|"'meta'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'fake_pickle'
op|'.'
name|'return_value'
op|'='
name|'no_meta_builder'
newline|'\n'
name|'pickle'
op|'.'
name|'load'
op|'='
name|'fake_pickle'
newline|'\n'
name|'builder'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|'('
string|"'fake.builder'"
op|','
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
name|'fake_open'
op|'.'
name|'assert_has_calls'
op|'('
op|'['
name|'mock'
op|'.'
name|'call'
op|'('
string|"'fake.builder'"
op|','
string|"'rb'"
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'builder'
op|'.'
name|'devs'
op|','
name|'rb'
op|'.'
name|'devs'
op|')'
newline|'\n'
nl|'\n'
comment|'# test an empty builder'
nl|'\n'
name|'fake_pickle'
op|'.'
name|'side_effect'
op|'='
name|'EOFError'
newline|'\n'
name|'pickle'
op|'.'
name|'load'
op|'='
name|'fake_pickle'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'UnPicklingError'
op|','
nl|'\n'
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|','
string|"'fake.builder'"
op|','
nl|'\n'
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
nl|'\n'
comment|'# test a corrupted builder'
nl|'\n'
name|'fake_pickle'
op|'.'
name|'side_effect'
op|'='
name|'pickle'
op|'.'
name|'UnpicklingError'
newline|'\n'
name|'pickle'
op|'.'
name|'load'
op|'='
name|'fake_pickle'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'UnPicklingError'
op|','
nl|'\n'
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|','
string|"'fake.builder'"
op|','
nl|'\n'
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
nl|'\n'
comment|'# test some error'
nl|'\n'
name|'fake_pickle'
op|'.'
name|'side_effect'
op|'='
name|'AttributeError'
newline|'\n'
name|'pickle'
op|'.'
name|'load'
op|'='
name|'fake_pickle'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'UnPicklingError'
op|','
nl|'\n'
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|','
string|"'fake.builder'"
op|','
nl|'\n'
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'pickle'
op|'.'
name|'load'
op|'='
name|'real_pickle'
newline|'\n'
nl|'\n'
comment|'# test non existent builder file'
nl|'\n'
dedent|''
name|'fake_open'
op|'.'
name|'side_effect'
op|'='
name|'io_error_not_found'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'FileNotFoundError'
op|','
nl|'\n'
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|','
string|"'fake.builder'"
op|','
nl|'\n'
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
nl|'\n'
comment|'# test non accessible builder file'
nl|'\n'
name|'fake_open'
op|'.'
name|'side_effect'
op|'='
name|'io_error_no_perm'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'PermissionError'
op|','
nl|'\n'
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|','
string|"'fake.builder'"
op|','
nl|'\n'
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
nl|'\n'
comment|'# test an error other then ENOENT and ENOPERM'
nl|'\n'
name|'fake_open'
op|'.'
name|'side_effect'
op|'='
name|'io_error_generic'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'IOError'
op|','
nl|'\n'
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|','
string|"'fake.builder'"
op|','
nl|'\n'
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_save_load
dedent|''
name|'def'
name|'test_save_load'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'devs'
op|'='
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'replication_port'"
op|':'
number|'10000'
op|','
nl|'\n'
string|"'device'"
op|':'
string|"'sda1'"
op|','
string|"'meta'"
op|':'
string|"'meta0'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'replication_port'"
op|':'
number|'10001'
op|','
nl|'\n'
string|"'device'"
op|':'
string|"'sdb1'"
op|','
string|"'meta'"
op|':'
string|"'meta1'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'replication_port'"
op|':'
number|'10002'
op|','
nl|'\n'
string|"'device'"
op|':'
string|"'sdc1'"
op|','
string|"'meta'"
op|':'
string|"'meta2'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'replication_port'"
op|':'
number|'10003'
op|','
nl|'\n'
string|"'device'"
op|':'
string|"'sdd1'"
op|','
string|"'meta'"
op|':'
string|"''"
op|'}'
op|']'
newline|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'3.14159'
op|')'
newline|'\n'
name|'for'
name|'d'
name|'in'
name|'devs'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'add_dev'
op|'('
name|'d'
op|')'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'builder_file'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
string|"'test_save.builder'"
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'save'
op|'('
name|'builder_file'
op|')'
newline|'\n'
name|'loaded_rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|'('
name|'builder_file'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'maxDiff'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'loaded_rb'
op|'.'
name|'to_dict'
op|'('
op|')'
op|','
name|'rb'
op|'.'
name|'to_dict'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'loaded_rb'
op|'.'
name|'overload'
op|','
number|'3.14159'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'six.moves.builtins.open'"
op|','
name|'autospec'
op|'='
name|'True'
op|')'
newline|'\n'
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.common.ring.builder.pickle.dump'"
op|','
name|'autospec'
op|'='
name|'True'
op|')'
newline|'\n'
DECL|member|test_save
name|'def'
name|'test_save'
op|'('
name|'self'
op|','
name|'mock_pickle_dump'
op|','
name|'mock_open'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_open'
op|'.'
name|'return_value'
op|'='
name|'mock_fh'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'devs'
op|'='
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta0'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta1'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta2'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|']'
newline|'\n'
name|'for'
name|'d'
name|'in'
name|'devs'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'add_dev'
op|'('
name|'d'
op|')'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'save'
op|'('
string|"'some.builder'"
op|')'
newline|'\n'
name|'mock_open'
op|'.'
name|'assert_called_once_with'
op|'('
string|"'some.builder'"
op|','
string|"'wb'"
op|')'
newline|'\n'
name|'mock_pickle_dump'
op|'.'
name|'assert_called_once_with'
op|'('
name|'rb'
op|'.'
name|'to_dict'
op|'('
op|')'
op|','
nl|'\n'
name|'mock_fh'
op|'.'
name|'__enter__'
op|'('
op|')'
op|','
nl|'\n'
name|'protocol'
op|'='
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_search_devs
dedent|''
name|'def'
name|'test_search_devs'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'devs'
op|'='
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta0'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta1'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta2'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta3'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'2'
op|','
string|"'zone'"
op|':'
number|'4'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sde1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta4'"
op|','
string|"'replication_ip'"
op|':'
string|"'127.0.0.10'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'20000'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'2'
op|','
string|"'zone'"
op|':'
number|'5'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.5'"
op|','
string|"'port'"
op|':'
number|'10005'
op|','
string|"'device'"
op|':'
string|"'sdf1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta5'"
op|','
string|"'replication_ip'"
op|':'
string|"'127.0.0.11'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'20001'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'2'
op|','
string|"'zone'"
op|':'
number|'6'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.6'"
op|','
string|"'port'"
op|':'
number|'10006'
op|','
string|"'device'"
op|':'
string|"'sdg1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta6'"
op|','
string|"'replication_ip'"
op|':'
string|"'127.0.0.12'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'20002'
op|'}'
op|']'
newline|'\n'
name|'for'
name|'d'
name|'in'
name|'devs'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'add_dev'
op|'('
name|'d'
op|')'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'region'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'0'
op|']'
op|','
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'region'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'2'
op|']'
op|','
name|'devs'
op|'['
number|'3'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'2'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'2'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'zone'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'port'"
op|':'
number|'10001'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'replication_ip'"
op|':'
string|"'127.0.0.10'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'4'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'replication_ip'"
op|':'
string|"'127.0.0.10'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'20000'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'4'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'replication_port'"
op|':'
number|'20000'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'4'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'meta'"
op|':'
string|"'meta1'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate
dedent|''
name|'def'
name|'test_validate'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'10'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'11'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'12'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'13'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'14'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'15'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# Degenerate case: devices added but not rebalanced yet'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'RingValidationError'
op|','
name|'rb'
op|'.'
name|'validate'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'zone'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'128'
op|','
number|'1'
op|':'
number|'128'
op|','
number|'2'
op|':'
number|'256'
op|','
number|'3'
op|':'
number|'256'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'dev_usage'
op|','
name|'worst'
op|'='
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'dev_usage'
name|'is'
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'worst'
name|'is'
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'dev_usage'
op|','
name|'worst'
op|'='
name|'rb'
op|'.'
name|'validate'
op|'('
name|'stats'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'list'
op|'('
name|'dev_usage'
op|')'
op|','
op|'['
number|'32'
op|','
number|'32'
op|','
number|'64'
op|','
number|'64'
op|','
nl|'\n'
number|'32'
op|','
number|'32'
op|','
number|'32'
op|','
comment|'# added zone0'
nl|'\n'
number|'32'
op|','
number|'32'
op|','
number|'32'
op|','
comment|'# added zone1'
nl|'\n'
number|'64'
op|','
number|'64'
op|','
number|'64'
op|','
comment|'# added zone2'
nl|'\n'
number|'64'
op|','
number|'64'
op|','
number|'64'
op|','
comment|'# added zone3'
nl|'\n'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'int'
op|'('
name|'worst'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# min part hours should pin all the parts assigned to this zero'
nl|'\n'
comment|'# weight device onto it such that the balance will look horrible'
nl|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'2'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'validate'
op|'('
name|'stats'
op|'='
name|'True'
op|')'
op|'['
number|'1'
op|']'
op|','
name|'MAX_BALANCE'
op|')'
newline|'\n'
nl|'\n'
comment|'# Test not all partitions doubly accounted for'
nl|'\n'
name|'rb'
op|'.'
name|'devs'
op|'['
number|'1'
op|']'
op|'['
string|"'parts'"
op|']'
op|'-='
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'RingValidationError'
op|','
name|'rb'
op|'.'
name|'validate'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'devs'
op|'['
number|'1'
op|']'
op|'['
string|"'parts'"
op|']'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
comment|'# Test non-numeric port'
nl|'\n'
name|'rb'
op|'.'
name|'devs'
op|'['
number|'1'
op|']'
op|'['
string|"'port'"
op|']'
op|'='
string|"'10001'"
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'RingValidationError'
op|','
name|'rb'
op|'.'
name|'validate'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'devs'
op|'['
number|'1'
op|']'
op|'['
string|"'port'"
op|']'
op|'='
number|'10001'
newline|'\n'
nl|'\n'
comment|'# Test partition on nonexistent device'
nl|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'orig_dev_id'
op|'='
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|'='
name|'len'
op|'('
name|'rb'
op|'.'
name|'devs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'RingValidationError'
op|','
name|'rb'
op|'.'
name|'validate'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|'='
name|'orig_dev_id'
newline|'\n'
nl|'\n'
comment|"# Tests that validate can handle 'holes' in .devs"
nl|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'2'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
name|'stats'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
comment|'# Test partition assigned to a hole'
nl|'\n'
name|'if'
name|'rb'
op|'.'
name|'devs'
op|'['
number|'2'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'2'
op|')'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'orig_dev_id'
op|'='
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|'='
number|'2'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'RingValidationError'
op|','
name|'rb'
op|'.'
name|'validate'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|'='
name|'orig_dev_id'
newline|'\n'
nl|'\n'
comment|"# Validate that zero weight devices with no partitions don't count on"
nl|'\n'
comment|"# the 'worst' value."
nl|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'rb'
op|'.'
name|'validate'
op|'('
name|'stats'
op|'='
name|'True'
op|')'
op|'['
number|'1'
op|']'
op|','
name|'MAX_BALANCE'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'16'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'rb'
op|'.'
name|'validate'
op|'('
name|'stats'
op|'='
name|'True'
op|')'
op|'['
number|'1'
op|']'
op|','
name|'MAX_BALANCE'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate_partial_replica
dedent|''
name|'def'
name|'test_validate_partial_replica'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'2.5'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
comment|'# sanity'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'0'
op|']'
op|')'
op|','
number|'256'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'1'
op|']'
op|')'
op|','
number|'256'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'2'
op|']'
op|')'
op|','
number|'128'
op|')'
newline|'\n'
nl|'\n'
comment|'# now swap partial replica part maps'
nl|'\n'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'1'
op|']'
op|','
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'2'
op|']'
op|'='
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'2'
op|']'
op|','
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'RingValidationError'
op|','
name|'rb'
op|'.'
name|'validate'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate_duplicate_part_assignment
dedent|''
name|'def'
name|'test_validate_duplicate_part_assignment'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
comment|'# sanity'
newline|'\n'
comment|'# now double up a device assignment'
nl|'\n'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'1'
op|']'
op|'['
number|'200'
op|']'
op|'='
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'2'
op|']'
op|'['
number|'200'
op|']'
newline|'\n'
nl|'\n'
DECL|class|SubStringMatcher
name|'class'
name|'SubStringMatcher'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
DECL|member|__init__
indent|'            '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'substr'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'substr'
op|'='
name|'substr'
newline|'\n'
nl|'\n'
DECL|member|__eq__
dedent|''
name|'def'
name|'__eq__'
op|'('
name|'self'
op|','
name|'other'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'self'
op|'.'
name|'substr'
name|'in'
name|'other'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'with'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'RingValidationError'
op|')'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'expected'
op|'='
string|"'The partition 200 has been assigned to duplicate devices'"
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'expected'
op|','
name|'str'
op|'('
name|'e'
op|'.'
name|'exception'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_part_devices
dedent|''
name|'def'
name|'test_get_part_devices'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'get_part_devices'
op|'('
number|'0'
op|')'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'part_devs'
op|'='
name|'sorted'
op|'('
name|'rb'
op|'.'
name|'get_part_devices'
op|'('
number|'0'
op|')'
op|','
nl|'\n'
name|'key'
op|'='
name|'operator'
op|'.'
name|'itemgetter'
op|'('
string|"'id'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_devs'
op|','
op|'['
name|'rb'
op|'.'
name|'devs'
op|'['
number|'0'
op|']'
op|','
name|'rb'
op|'.'
name|'devs'
op|'['
number|'1'
op|']'
op|','
name|'rb'
op|'.'
name|'devs'
op|'['
number|'2'
op|']'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_part_devices_partial_replicas
dedent|''
name|'def'
name|'test_get_part_devices_partial_replicas'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'2.5'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'4'
op|')'
newline|'\n'
nl|'\n'
comment|'# note: partition 255 will only have 2 replicas'
nl|'\n'
name|'part_devs'
op|'='
name|'sorted'
op|'('
name|'rb'
op|'.'
name|'get_part_devices'
op|'('
number|'255'
op|')'
op|','
nl|'\n'
name|'key'
op|'='
name|'operator'
op|'.'
name|'itemgetter'
op|'('
string|"'id'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_devs'
op|','
op|'['
name|'rb'
op|'.'
name|'devs'
op|'['
number|'1'
op|']'
op|','
name|'rb'
op|'.'
name|'devs'
op|'['
number|'2'
op|']'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_dispersion_with_zero_weight_devices
dedent|''
name|'def'
name|'test_dispersion_with_zero_weight_devices'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3.0'
op|','
number|'0'
op|')'
newline|'\n'
comment|'# add two devices to a single server in a single zone'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
comment|'# and a zero weight device'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'dispersion'
op|','
number|'0.0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'_dispersion_graph'
op|','
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'0'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'256'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'1'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'256'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'2'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'256'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_dispersion_with_zero_weight_devices_with_parts
dedent|''
name|'def'
name|'test_dispersion_with_zero_weight_devices_with_parts'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3.0'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# add four devices to a single server in a single zone'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'dispersion'
op|','
number|'0.0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'_dispersion_graph'
op|','
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'0'
op|')'
op|':'
op|'['
number|'64'
op|','
number|'192'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'1'
op|')'
op|':'
op|'['
number|'64'
op|','
number|'192'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'2'
op|')'
op|':'
op|'['
number|'64'
op|','
number|'192'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'3'
op|')'
op|':'
op|'['
number|'64'
op|','
number|'192'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
comment|'# now mark a device 2 for decom'
nl|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'2'
op|','
number|'0.0'
op|')'
newline|'\n'
comment|"# we'll rebalance but can't move any parts"
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
comment|'# zero weight tier has one copy of 1/4 part-replica'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'dispersion'
op|','
number|'75.0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'_dispersion_graph'
op|','
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'0'
op|')'
op|':'
op|'['
number|'64'
op|','
number|'192'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'1'
op|')'
op|':'
op|'['
number|'64'
op|','
number|'192'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'2'
op|')'
op|':'
op|'['
number|'64'
op|','
number|'192'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'3'
op|')'
op|':'
op|'['
number|'64'
op|','
number|'192'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
comment|'# unlock the stuck parts'
nl|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'dispersion'
op|','
number|'0.0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'_dispersion_graph'
op|','
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'0'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'256'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'1'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'256'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'3'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'256'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_effective_overload
dedent|''
name|'def'
name|'test_effective_overload'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# z0'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
comment|'# z1'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
comment|'# z2'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# this ring requires overload'
nl|'\n'
name|'required'
op|'='
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertGreater'
op|'('
name|'required'
op|','
number|'0.1'
op|')'
newline|'\n'
nl|'\n'
comment|"# and we'll use a little bit"
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.1'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'7'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|"# but with-out enough overload we're not dispersed"
nl|'\n'
name|'self'
op|'.'
name|'assertGreater'
op|'('
name|'rb'
op|'.'
name|'dispersion'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# add the other dev to z2'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
comment|'# but also fail another device in the same!'
nl|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'6'
op|')'
newline|'\n'
nl|'\n'
comment|'# we still require overload'
nl|'\n'
name|'required'
op|'='
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertGreater'
op|'('
name|'required'
op|','
number|'0.1'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'7'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|"# ... and without enough we're full dispersed"
nl|'\n'
name|'self'
op|'.'
name|'assertGreater'
op|'('
name|'rb'
op|'.'
name|'dispersion'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|"# ok, let's fix z2's weight for real"
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# ... technically, we no longer require overload'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'0.0'
op|')'
newline|'\n'
nl|'\n'
comment|"# so let's rebalance w/o resetting min_part_hours"
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'7'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# ... and that got it in one pass boo-yah!'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'dispersion'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|zone_weights_over_device_count
dedent|''
name|'def'
name|'zone_weights_over_device_count'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# z0'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
comment|'# z1'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
comment|'# z2'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'200'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'7'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'dispersion'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
name|'rb'
op|'.'
name|'get_balance'
op|'('
op|')'
op|','
op|'('
number|'1.0'
op|'/'
number|'3.0'
op|')'
op|'*'
number|'100'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_more_devices_than_replicas_validation_when_removed_dev
dedent|''
name|'def'
name|'test_more_devices_than_replicas_validation_when_removed_dev'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'2'
op|')'
newline|'\n'
name|'with'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|')'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'2'
op|','
number|'1'
op|')'
newline|'\n'
dedent|''
name|'msg'
op|'='
string|'"Can not set weight of dev_id 2 because it is marked "'
string|'"for removal"'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'msg'
op|','
name|'str'
op|'('
name|'e'
op|'.'
name|'exception'
op|')'
op|')'
newline|'\n'
name|'with'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'RingValidationError'
op|')'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
dedent|''
name|'msg'
op|'='
string|"'Replica count of 3 requires more than 2 devices'"
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'msg'
op|','
name|'str'
op|'('
name|'e'
op|'.'
name|'exception'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|TestGetRequiredOverload
dedent|''
dedent|''
name|'class'
name|'TestGetRequiredOverload'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|variable|maxDiff
indent|'    '
name|'maxDiff'
op|'='
name|'None'
newline|'\n'
nl|'\n'
DECL|member|test_none_needed
name|'def'
name|'test_none_needed'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# 4 equal-weight devs and 3 replicas: this can be balanced without'
nl|'\n'
comment|'# resorting to overload at all'
nl|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'0'
op|')'
op|':'
number|'0.75'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'1'
op|')'
op|':'
number|'0.75'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'2'
op|')'
op|':'
number|'0.75'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'3'
op|')'
op|':'
number|'0.75'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
nl|'\n'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# since no overload is needed, target_replicas is the same'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.10'
op|')'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# ... no matter how high you go!'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'100.0'
op|')'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# 3 equal-weight devs and 3 replicas: this can also be balanced'
nl|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'0'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'1'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'2'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# ... still no overload'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'100.0'
op|')'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_equal_replica_and_devices_count_ignore_weights
dedent|''
name|'def'
name|'test_equal_replica_and_devices_count_ignore_weights'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'7.47'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'5.91'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'6.44'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'1.0'
op|','
nl|'\n'
number|'1'
op|':'
number|'1.0'
op|','
nl|'\n'
number|'2'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'}'
newline|'\n'
comment|'# simplicity itself'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
nl|'\n'
name|'t'
op|'['
op|'-'
number|'1'
op|']'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
nl|'\n'
name|'t'
op|'['
op|'-'
number|'1'
op|']'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
nl|'\n'
name|'t'
op|'['
op|'-'
number|'1'
op|']'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
comment|'# ... no overload required!'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'256'
op|','
nl|'\n'
number|'1'
op|':'
number|'256'
op|','
nl|'\n'
number|'2'
op|':'
number|'256'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'d'
op|'['
string|"'id'"
op|']'
op|':'
name|'d'
op|'['
string|"'parts'"
op|']'
name|'for'
name|'d'
name|'in'
nl|'\n'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_small_zone
dedent|''
name|'def'
name|'test_small_zone'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'1.0434782608695652'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'1.0434782608695652'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
number|'0.9130434782608695'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# the device tier is interesting because one of the devices in zone'
nl|'\n'
comment|'# two has a different weight'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'0.5217391304347826'
op|','
nl|'\n'
number|'1'
op|':'
number|'0.5217391304347826'
op|','
nl|'\n'
number|'2'
op|':'
number|'0.5217391304347826'
op|','
nl|'\n'
number|'3'
op|':'
number|'0.5217391304347826'
op|','
nl|'\n'
number|'4'
op|':'
number|'0.5217391304347826'
op|','
nl|'\n'
number|'5'
op|':'
number|'0.3913043478260869'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|'['
number|'3'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# ... but, each pair of devices still needs to hold a whole'
nl|'\n'
comment|"# replicanth; which we'll try distribute fairly among devices in"
nl|'\n'
comment|'# zone 2, so that they can share the burden and ultimately the'
nl|'\n'
comment|'# required overload will be as small as possible.'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'0.5'
op|','
nl|'\n'
number|'1'
op|':'
number|'0.5'
op|','
nl|'\n'
number|'2'
op|':'
number|'0.5'
op|','
nl|'\n'
number|'3'
op|':'
number|'0.5'
op|','
nl|'\n'
number|'4'
op|':'
number|'0.5714285714285715'
op|','
nl|'\n'
number|'5'
op|':'
number|'0.42857142857142855'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|'['
number|'3'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|"# full dispersion requires zone two's devices to eat more than"
nl|'\n'
comment|"# they're weighted for"
nl|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'0.095238'
op|','
nl|'\n'
name|'delta'
op|'='
number|'1e-5'
op|')'
newline|'\n'
nl|'\n'
comment|'# so... if we give it enough overload it we should get full dispersion'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.1'
op|')'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|'['
number|'3'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multiple_small_zones
dedent|''
name|'def'
name|'test_multiple_small_zones'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'500'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'500'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'500'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'500'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'150'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'150'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'10'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'150'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'2.1052631578947367'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'0.47368421052631576'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
number|'0.21052631578947367'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'3'
op|')'
op|':'
number|'0.21052631578947367'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# without any overload, we get weight'
nl|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'r'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'r'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
number|'0.49999999999999994'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'3'
op|')'
op|':'
number|'0.49999999999999994'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'t'
op|':'
name|'r'
nl|'\n'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1.3750000000000002'
op|','
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# with enough overload we get the full dispersion'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'1.5'
op|')'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'r'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'r'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# with not enough overload, we get somewhere in the middle'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'1.0'
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'1.3014354066985647'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'0.8564593301435406'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
number|'0.4210526315789473'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'3'
op|')'
op|':'
number|'0.4210526315789473'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'r'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'r'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_big_zone
dedent|''
name|'def'
name|'test_big_zone'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'1.0714285714285714'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'0.6428571428571429'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
number|'0.6428571428571429'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'3'
op|')'
op|':'
number|'0.6428571428571429'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'0.6666666666666667'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
number|'0.6666666666666667'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'3'
op|')'
op|':'
number|'0.6666666666666667'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# when all the devices and servers in a zone are evenly weighted'
nl|'\n'
comment|'# it will accurately proxy their required overload, all the'
nl|'\n'
comment|'# zones besides 0 require the same overload'
nl|'\n'
name|'t'
op|'='
name|'random'
op|'.'
name|'choice'
op|'('
op|'['
name|'t'
name|'for'
name|'t'
name|'in'
name|'weighted_replicas'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'2'
nl|'\n'
name|'and'
name|'t'
op|'['
number|'1'
op|']'
op|'!='
number|'0'
op|']'
op|')'
newline|'\n'
name|'expected_overload'
op|'='
op|'('
op|'('
name|'wanted_replicas'
op|'['
name|'t'
op|']'
op|'-'
name|'weighted_replicas'
op|'['
name|'t'
op|']'
op|')'
nl|'\n'
op|'/'
name|'weighted_replicas'
op|'['
name|'t'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
nl|'\n'
name|'expected_overload'
op|')'
newline|'\n'
nl|'\n'
comment|'# but if you only give it out half of that'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
name|'expected_overload'
op|'/'
number|'2.0'
op|')'
newline|'\n'
comment|"# ... you can expect it's not going to full disperse"
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'1.0357142857142856'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'0.6547619047619049'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
number|'0.6547619047619049'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'3'
op|')'
op|':'
number|'0.6547619047619049'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_enormous_zone
dedent|''
name|'def'
name|'test_enormous_zone'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'500'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'500'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'500'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'500'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'2.542372881355932'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'0.15254237288135591'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
number|'0.15254237288135591'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'3'
op|')'
op|':'
number|'0.15254237288135591'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'0.6666666666666667'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
number|'0.6666666666666667'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'3'
op|')'
op|':'
number|'0.6666666666666667'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# ouch, those "tiny" devices need to hold 3x more than their'
nl|'\n'
comment|'# weighted for!'
nl|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'3.370370'
op|','
nl|'\n'
name|'delta'
op|'='
number|'1e-5'
op|')'
newline|'\n'
nl|'\n'
comment|"# let's get a little crazy, and let devices eat up to 1x more than"
nl|'\n'
comment|'# their capacity is weighted for - see how far that gets us...'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'1'
op|')'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'2.084745762711864'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'0.30508474576271183'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
number|'0.30508474576271183'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'3'
op|')'
op|':'
number|'0.30508474576271183'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_two_big_two_small
dedent|''
name|'def'
name|'test_two_big_two_small'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'45'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'45'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'35'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'35'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'1.0714285714285714'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'1.0714285714285714'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
number|'0.48214285714285715'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'3'
op|')'
op|':'
number|'0.375'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
number|'0.5625'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'3'
op|')'
op|':'
number|'0.43749999999999994'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|"# I'm not sure it's significant or coincidental that the devices"
nl|'\n'
comment|'# in zone 2 & 3 who end up splitting the 3rd replica turn out to'
nl|'\n'
comment|'# need to eat ~1/6th extra replicanths'
nl|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'1.0'
op|'/'
number|'6.0'
op|')'
newline|'\n'
nl|'\n'
comment|"# ... *so* 10% isn't *quite* enough"
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.1'
op|')'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'1.0285714285714285'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'1.0285714285714285'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
number|'0.5303571428571429'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'3'
op|')'
op|':'
number|'0.4125'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# ... but 20% will do the trick!'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.2'
op|')'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
number|'0.5625'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'3'
op|')'
op|':'
number|'0.43749999999999994'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multiple_replicas_each
dedent|''
name|'def'
name|'test_multiple_replicas_each'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'7'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'80'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'80'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'80'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'80'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'80'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'70'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'70'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'70'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'70'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'4.117647058823529'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'2.8823529411764706'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'4.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'3.0'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# I guess 2.88 => 3.0 is about a 4% increase'
nl|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
nl|'\n'
number|'0.040816326530612256'
op|')'
newline|'\n'
nl|'\n'
comment|'# ... 10% is plenty enough here'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.1'
op|')'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_small_extra_server_in_zone_with_multiple_replicas
dedent|''
name|'def'
name|'test_small_extra_server_in_zone_with_multiple_replicas'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'5'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
comment|'# z0'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'1000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'weight'"
op|':'
number|'1000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|','
string|"'weight'"
op|':'
number|'1000'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# z1'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'1000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'weight'"
op|':'
number|'1000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|','
string|"'weight'"
op|':'
number|'1000'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# z1 - extra small server'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'50'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'2.479338842975207'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'2.5206611570247937'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'t'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# dispersion is fine with this at the zone tier'
nl|'\n'
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'t'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# ... but not ok with that tiny server'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'127.0.0.1'"
op|':'
number|'2.479338842975207'
op|','
nl|'\n'
string|"'127.0.0.2'"
op|':'
number|'1.5206611570247937'
op|','
nl|'\n'
string|"'127.0.0.3'"
op|':'
number|'1.0'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'t'
op|'['
op|'-'
number|'1'
op|']'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'3'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
number|'23.2'
op|','
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multiple_replicas_in_zone_with_single_device
dedent|''
name|'def'
name|'test_multiple_replicas_in_zone_with_single_device'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'5'
op|','
number|'0'
op|')'
newline|'\n'
comment|'# z0'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
comment|'# z1'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.1.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.1.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.1.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.1.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# first things first, make sure we do this right'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|"# each device get's a sing replica of every part"
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'256'
op|','
nl|'\n'
number|'1'
op|':'
number|'256'
op|','
nl|'\n'
number|'2'
op|':'
number|'256'
op|','
nl|'\n'
number|'3'
op|':'
number|'256'
op|','
nl|'\n'
number|'4'
op|':'
number|'256'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'d'
op|'['
string|"'id'"
op|']'
op|':'
name|'d'
op|'['
string|"'parts'"
op|']'
nl|'\n'
name|'for'
name|'d'
name|'in'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|"# but let's make sure we're thinking about it right too"
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'1.0'
op|','
nl|'\n'
number|'1'
op|':'
number|'1.0'
op|','
nl|'\n'
number|'2'
op|':'
number|'1.0'
op|','
nl|'\n'
number|'3'
op|':'
number|'1.0'
op|','
nl|'\n'
number|'4'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
comment|'# by weight everyone is equal'
nl|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'t'
op|'['
op|'-'
number|'1'
op|']'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# wanted might have liked to have fewer replicas in z1, but the'
nl|'\n'
comment|'# single device in z0 limits us one replica per device'
nl|'\n'
name|'with'
name|'rb'
op|'.'
name|'debug'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'t'
op|'['
op|'-'
number|'1'
op|']'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# even with some overload - still one replica per device'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'1.0'
op|')'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'t'
op|'['
op|'-'
number|'1'
op|']'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# when overload can not change the outcome none is required'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0.0'
op|','
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|')'
newline|'\n'
comment|'# even though dispersion is terrible (in z1 particularly)'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'100.0'
op|','
name|'rb'
op|'.'
name|'dispersion'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_one_big_guy_does_not_spoil_his_buddy
dedent|''
name|'def'
name|'test_one_big_guy_does_not_spoil_his_buddy'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# z0'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
comment|'# z1'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.1.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.1.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
comment|'# z2'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'ip'"
op|':'
string|"'127.0.2.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'ip'"
op|':'
string|"'127.0.2.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'10000'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# obviously d5 gets one whole replica; the other two replicas'
nl|'\n'
comment|'# are split evenly among the five other devices'
nl|'\n'
comment|'# (i.e. ~0.4 replicanths for each 100 units of weight)'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'0.39999999999999997'
op|','
nl|'\n'
number|'1'
op|':'
number|'0.39999999999999997'
op|','
nl|'\n'
number|'2'
op|':'
number|'0.39999999999999997'
op|','
nl|'\n'
number|'3'
op|':'
number|'0.39999999999999997'
op|','
nl|'\n'
number|'4'
op|':'
number|'0.39999999999999997'
op|','
nl|'\n'
number|'5'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'t'
op|'['
op|'-'
number|'1'
op|']'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# with no overload we get the "balanced" placement'
nl|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'t'
op|'['
op|'-'
number|'1'
op|']'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# but in reality, these devices having such disparate weights'
nl|'\n'
comment|'# leads to a *terrible* balance even w/o overload!'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'9'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'get_balance'
op|'('
op|')'
op|','
number|'1308.2031249999998'
op|')'
newline|'\n'
nl|'\n'
comment|'# even though part assignment is pretty reasonable'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'103'
op|','
nl|'\n'
number|'1'
op|':'
number|'102'
op|','
nl|'\n'
number|'2'
op|':'
number|'103'
op|','
nl|'\n'
number|'3'
op|':'
number|'102'
op|','
nl|'\n'
number|'4'
op|':'
number|'102'
op|','
nl|'\n'
number|'5'
op|':'
number|'256'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
nl|'\n'
name|'d'
op|'['
string|"'id'"
op|']'
op|':'
name|'d'
op|'['
string|"'parts'"
op|']'
name|'for'
name|'d'
name|'in'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# so whats happening is the small devices are holding *way* more'
nl|'\n'
comment|'# *real* parts than their *relative* portion of the weight would'
nl|'\n'
comment|'# like them too!'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'1308.2031249999998'
op|','
nl|'\n'
number|'1'
op|':'
number|'1294.5312499999998'
op|','
nl|'\n'
number|'2'
op|':'
number|'1308.2031249999998'
op|','
nl|'\n'
number|'3'
op|':'
number|'1294.5312499999998'
op|','
nl|'\n'
number|'4'
op|':'
number|'1294.5312499999998'
op|','
nl|'\n'
number|'5'
op|':'
op|'-'
number|'65.0'
op|','
nl|'\n'
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
name|'rb'
op|'.'
name|'_build_balance_per_dev'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# increasing overload moves towards one replica in each tier'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.20'
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'0.48'
op|','
nl|'\n'
number|'1'
op|':'
number|'0.48'
op|','
nl|'\n'
number|'2'
op|':'
number|'0.48'
op|','
nl|'\n'
number|'3'
op|':'
number|'0.48'
op|','
nl|'\n'
number|'4'
op|':'
number|'0.30857142857142855'
op|','
nl|'\n'
number|'5'
op|':'
number|'0.7714285714285714'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'t'
op|'['
op|'-'
number|'1'
op|']'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# ... and as always increasing overload makes balance *worse*'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'17'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'get_balance'
op|'('
op|')'
op|','
number|'1581.6406249999998'
op|')'
newline|'\n'
nl|'\n'
comment|'# but despite the overall trend toward imbalance, in the tier'
nl|'\n'
comment|'# with the huge device, the small device is trying to shed parts'
nl|'\n'
comment|'# as effectively as it can (which would be useful if it was the'
nl|'\n'
comment|'# only small device isolated in a tier with other huge devices'
nl|'\n'
comment|'# trying to gobble up all the replicanths in the tier - see'
nl|'\n'
comment|'# `test_one_small_guy_does_not_spoil_his_buddy`!)'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'123'
op|','
nl|'\n'
number|'1'
op|':'
number|'123'
op|','
nl|'\n'
number|'2'
op|':'
number|'123'
op|','
nl|'\n'
number|'3'
op|':'
number|'123'
op|','
nl|'\n'
number|'4'
op|':'
number|'79'
op|','
nl|'\n'
number|'5'
op|':'
number|'197'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
nl|'\n'
name|'d'
op|'['
string|"'id'"
op|']'
op|':'
name|'d'
op|'['
string|"'parts'"
op|']'
name|'for'
name|'d'
name|'in'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# *see*, at least *someones* balance is getting better!'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'1581.6406249999998'
op|','
nl|'\n'
number|'1'
op|':'
number|'1581.6406249999998'
op|','
nl|'\n'
number|'2'
op|':'
number|'1581.6406249999998'
op|','
nl|'\n'
number|'3'
op|':'
number|'1581.6406249999998'
op|','
nl|'\n'
number|'4'
op|':'
number|'980.078125'
op|','
nl|'\n'
number|'5'
op|':'
op|'-'
number|'73.06640625'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
name|'rb'
op|'.'
name|'_build_balance_per_dev'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_one_small_guy_does_not_spoil_his_buddy
dedent|''
name|'def'
name|'test_one_small_guy_does_not_spoil_his_buddy'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# z0'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'10000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'10000'
op|'}'
op|')'
newline|'\n'
comment|'# z1'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.1.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'10000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.1.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'10000'
op|'}'
op|')'
newline|'\n'
comment|'# z2'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'ip'"
op|':'
string|"'127.0.2.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'10000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'ip'"
op|':'
string|"'127.0.2.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|"# it's almost like 3.0 / 5 ~= 0.6, but that one little guy get's"
nl|'\n'
comment|'# his fair share'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'0.5988023952095808'
op|','
nl|'\n'
number|'1'
op|':'
number|'0.5988023952095808'
op|','
nl|'\n'
number|'2'
op|':'
number|'0.5988023952095808'
op|','
nl|'\n'
number|'3'
op|':'
number|'0.5988023952095808'
op|','
nl|'\n'
number|'4'
op|':'
number|'0.5988023952095808'
op|','
nl|'\n'
number|'5'
op|':'
number|'0.005988023952095809'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'t'
op|'['
op|'-'
number|'1'
op|']'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# with no overload we get a nice balanced placement'
nl|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'t'
op|'['
op|'-'
number|'1'
op|']'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'9'
op|')'
newline|'\n'
nl|'\n'
comment|'# part placement looks goods'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'154'
op|','
nl|'\n'
number|'1'
op|':'
number|'153'
op|','
nl|'\n'
number|'2'
op|':'
number|'153'
op|','
nl|'\n'
number|'3'
op|':'
number|'153'
op|','
nl|'\n'
number|'4'
op|':'
number|'153'
op|','
nl|'\n'
number|'5'
op|':'
number|'2'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
nl|'\n'
name|'d'
op|'['
string|"'id'"
op|']'
op|':'
name|'d'
op|'['
string|"'parts'"
op|']'
name|'for'
name|'d'
name|'in'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# ... balance is a little lumpy on the small guy since he wants'
nl|'\n'
comment|'# one and a half parts :\\'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'0.4609375000000142'
op|','
nl|'\n'
number|'1'
op|':'
op|'-'
number|'0.1914062499999858'
op|','
nl|'\n'
number|'2'
op|':'
op|'-'
number|'0.1914062499999858'
op|','
nl|'\n'
number|'3'
op|':'
op|'-'
number|'0.1914062499999858'
op|','
nl|'\n'
number|'4'
op|':'
op|'-'
number|'0.1914062499999858'
op|','
nl|'\n'
number|'5'
op|':'
number|'30.46875'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
name|'rb'
op|'.'
name|'_build_balance_per_dev'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'get_balance'
op|'('
op|')'
op|','
number|'30.46875'
op|')'
newline|'\n'
nl|'\n'
comment|'# increasing overload moves towards one replica in each tier'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.5'
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'0.5232035928143712'
op|','
nl|'\n'
number|'1'
op|':'
number|'0.5232035928143712'
op|','
nl|'\n'
number|'2'
op|':'
number|'0.5232035928143712'
op|','
nl|'\n'
number|'3'
op|':'
number|'0.5232035928143712'
op|','
nl|'\n'
number|'4'
op|':'
number|'0.8982035928143712'
op|','
nl|'\n'
number|'5'
op|':'
number|'0.008982035928143714'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'t'
op|'['
op|'-'
number|'1'
op|']'
op|':'
name|'r'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# ... and as always increasing overload makes balance *worse*'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'17'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'get_balance'
op|'('
op|')'
op|','
number|'95.703125'
op|')'
newline|'\n'
nl|'\n'
comment|'# but despite the overall trend toward imbalance, the little guy'
nl|'\n'
comment|"# isn't really taking on many new parts!"
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'134'
op|','
nl|'\n'
number|'1'
op|':'
number|'134'
op|','
nl|'\n'
number|'2'
op|':'
number|'134'
op|','
nl|'\n'
number|'3'
op|':'
number|'133'
op|','
nl|'\n'
number|'4'
op|':'
number|'230'
op|','
nl|'\n'
number|'5'
op|':'
number|'3'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
nl|'\n'
name|'d'
op|'['
string|"'id'"
op|']'
op|':'
name|'d'
op|'['
string|"'parts'"
op|']'
name|'for'
name|'d'
name|'in'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|"# *see*, at everyone's balance is getting worse *together*!"
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
op|'-'
number|'12.585937499999986'
op|','
nl|'\n'
number|'1'
op|':'
op|'-'
number|'12.585937499999986'
op|','
nl|'\n'
number|'2'
op|':'
op|'-'
number|'12.585937499999986'
op|','
nl|'\n'
number|'3'
op|':'
op|'-'
number|'13.238281249999986'
op|','
nl|'\n'
number|'4'
op|':'
number|'50.0390625'
op|','
nl|'\n'
number|'5'
op|':'
number|'95.703125'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
name|'rb'
op|'.'
name|'_build_balance_per_dev'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_two_servers_with_more_than_one_replica
dedent|''
name|'def'
name|'test_two_servers_with_more_than_one_replica'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'0'
op|')'
newline|'\n'
comment|'# z0'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'60'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'60'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'60'
op|'}'
op|')'
newline|'\n'
comment|'# z1'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.1.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'80'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.1.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'128'
op|'}'
op|')'
newline|'\n'
comment|'# z2'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'ip'"
op|':'
string|"'127.0.2.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'80'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'ip'"
op|':'
string|"'127.0.2.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'240'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'12.161458333333343'
op|','
name|'rb'
op|'.'
name|'get_balance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'replica_plan'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'for'
name|'dev'
name|'in'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'tier'
op|'='
op|'('
name|'dev'
op|'['
string|"'region'"
op|']'
op|','
name|'dev'
op|'['
string|"'zone'"
op|']'
op|','
name|'dev'
op|'['
string|"'ip'"
op|']'
op|','
name|'dev'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'expected_parts'
op|'='
name|'replica_plan'
op|'['
name|'tier'
op|']'
op|'*'
name|'rb'
op|'.'
name|'parts'
newline|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
name|'dev'
op|'['
string|"'parts'"
op|']'
op|','
name|'expected_parts'
op|','
nl|'\n'
name|'delta'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multi_zone_with_failed_device
dedent|''
dedent|''
name|'def'
name|'test_multi_zone_with_failed_device'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'2000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'weight'"
op|':'
number|'2000'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'2000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'weight'"
op|':'
number|'2000'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'2000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'weight'"
op|':'
number|'2000'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# sanity, balanced and dispersed'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'0.0'
op|')'
newline|'\n'
nl|'\n'
comment|'# fail a device in zone 2'
nl|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'4'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'0.6'
op|','
nl|'\n'
number|'1'
op|':'
number|'0.6'
op|','
nl|'\n'
number|'2'
op|':'
number|'0.6'
op|','
nl|'\n'
number|'3'
op|':'
number|'0.6'
op|','
nl|'\n'
number|'5'
op|':'
number|'0.6'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|'['
number|'3'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'0.5'
op|','
nl|'\n'
number|'1'
op|':'
number|'0.5'
op|','
nl|'\n'
number|'2'
op|':'
number|'0.5'
op|','
nl|'\n'
number|'3'
op|':'
number|'0.5'
op|','
nl|'\n'
number|'5'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|'['
number|'3'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# does this make sense?  every zone was holding 1/3rd of the'
nl|'\n'
comment|'# replicas, so each device was 1/6th, remove a device and'
nl|'\n'
comment|"# suddenly it's holding *both* sixths which is 2/3rds?"
nl|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'2.0'
op|'/'
number|'3.0'
op|')'
newline|'\n'
nl|'\n'
comment|"# 10% isn't nearly enough"
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.1'
op|')'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'0.585'
op|','
nl|'\n'
number|'1'
op|':'
number|'0.585'
op|','
nl|'\n'
number|'2'
op|':'
number|'0.585'
op|','
nl|'\n'
number|'3'
op|':'
number|'0.585'
op|','
nl|'\n'
number|'5'
op|':'
number|'0.6599999999999999'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|'['
number|'3'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|"# 50% isn't even enough"
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.5'
op|')'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'0.525'
op|','
nl|'\n'
number|'1'
op|':'
number|'0.525'
op|','
nl|'\n'
number|'2'
op|':'
number|'0.525'
op|','
nl|'\n'
number|'3'
op|':'
number|'0.525'
op|','
nl|'\n'
number|'5'
op|':'
number|'0.8999999999999999'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|'['
number|'3'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|"# even 65% isn't enough (but it's getting closer)"
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.65'
op|')'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'0.5025000000000001'
op|','
nl|'\n'
number|'1'
op|':'
number|'0.5025000000000001'
op|','
nl|'\n'
number|'2'
op|':'
number|'0.5025000000000001'
op|','
nl|'\n'
number|'3'
op|':'
number|'0.5025000000000001'
op|','
nl|'\n'
number|'5'
op|':'
number|'0.99'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|'['
number|'3'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_balanced_zones_unbalanced_servers
dedent|''
name|'def'
name|'test_balanced_zones_unbalanced_servers'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# zone 0 server 127.0.0.1'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'3000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'weight'"
op|':'
number|'3000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'3000'
op|'}'
op|')'
newline|'\n'
comment|'# zone 1 server 127.0.0.2'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'4000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'weight'"
op|':'
number|'4000'
op|'}'
op|')'
newline|'\n'
comment|'# zone 1 (again) server 127.0.0.3'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'1000'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# zones are evenly weighted'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'1.5'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'1.5'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# ... but servers are not'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'127.0.0.1'"
op|':'
number|'1.5'
op|','
nl|'\n'
string|"'127.0.0.2'"
op|':'
number|'1.3333333333333333'
op|','
nl|'\n'
string|"'127.0.0.3'"
op|':'
number|'0.16666666666666666'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|'['
number|'2'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'3'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# make sure wanted will even it out'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'127.0.0.1'"
op|':'
number|'1.5'
op|','
nl|'\n'
string|"'127.0.0.2'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'127.0.0.3'"
op|':'
number|'0.4999999999999999'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|'['
number|'2'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'3'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|"# so it wants 1/6th and eats 1/2 - that's 2/6ths more than it"
nl|'\n'
comment|'# wants which is a 200% increase'
nl|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'2.0'
op|')'
newline|'\n'
nl|'\n'
comment|"# the overload doesn't effect the tiers that are already dispersed"
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'1'
op|')'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'127.0.0.1'"
op|':'
number|'1.5'
op|','
nl|'\n'
comment|'# notice with half the overload 1/6th replicanth swapped servers'
nl|'\n'
string|"'127.0.0.2'"
op|':'
number|'1.1666666666666665'
op|','
nl|'\n'
string|"'127.0.0.3'"
op|':'
number|'0.3333333333333333'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|'['
number|'2'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'3'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_adding_second_zone
dedent|''
name|'def'
name|'test_adding_second_zone'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'3'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# zone 0 server 127.0.0.1'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'2000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'weight'"
op|':'
number|'2000'
op|'}'
op|')'
newline|'\n'
comment|'# zone 0 server 127.0.0.2'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'2000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'weight'"
op|':'
number|'2000'
op|'}'
op|')'
newline|'\n'
comment|'# zone 0 server 127.0.0.3'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'2000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'weight'"
op|':'
number|'2000'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# sanity, balanced and dispersed'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'127.0.0.1'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'127.0.0.2'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'127.0.0.3'"
op|':'
number|'1.0'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|'['
number|'2'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'3'
op|'}'
op|')'
newline|'\n'
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|'['
number|'2'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'3'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# start adding a second zone'
nl|'\n'
nl|'\n'
comment|'# zone 1 server 127.0.1.1'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.1.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.1.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
comment|'# zone 1 server 127.0.1.2'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.1.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.1.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
comment|'# zone 1 server 127.0.1.3'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'10'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.1.3'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'11'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.1.3'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'weight'"
op|':'
number|'100'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# this messes things up pretty royally'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'127.0.0.1'"
op|':'
number|'0.9523809523809523'
op|','
nl|'\n'
string|"'127.0.0.2'"
op|':'
number|'0.9523809523809523'
op|','
nl|'\n'
string|"'127.0.0.3'"
op|':'
number|'0.9523809523809523'
op|','
nl|'\n'
string|"'127.0.1.1'"
op|':'
number|'0.047619047619047616'
op|','
nl|'\n'
string|"'127.0.1.2'"
op|':'
number|'0.047619047619047616'
op|','
nl|'\n'
string|"'127.0.1.3'"
op|':'
number|'0.047619047619047616'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|'['
number|'2'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'3'
op|'}'
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'127.0.0.1'"
op|':'
number|'0.6666666666666667'
op|','
nl|'\n'
string|"'127.0.0.2'"
op|':'
number|'0.6666666666666667'
op|','
nl|'\n'
string|"'127.0.0.3'"
op|':'
number|'0.6666666666666667'
op|','
nl|'\n'
string|"'127.0.1.1'"
op|':'
number|'0.3333333333333333'
op|','
nl|'\n'
string|"'127.0.1.2'"
op|':'
number|'0.3333333333333333'
op|','
nl|'\n'
string|"'127.0.1.3'"
op|':'
number|'0.3333333333333333'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|'['
number|'2'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'3'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# so dispersion would require these devices hold 6x more than'
nl|'\n'
comment|'# prescribed by weight, defeating any attempt at gradually'
nl|'\n'
comment|'# anything'
nl|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'6.0'
op|')'
newline|'\n'
nl|'\n'
comment|"# so let's suppose we only allow for 10% overload"
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.10'
op|')'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
comment|'# we expect servers in zone 0 to be between 0.952 and 0.666'
nl|'\n'
string|"'127.0.0.1'"
op|':'
number|'0.9476190476190476'
op|','
nl|'\n'
string|"'127.0.0.2'"
op|':'
number|'0.9476190476190476'
op|','
nl|'\n'
string|"'127.0.0.3'"
op|':'
number|'0.9476190476190476'
op|','
nl|'\n'
comment|'# we expect servers in zone 1 to be between 0.0476 and 0.333'
nl|'\n'
comment|'# and in fact its ~10% increase (very little compared to 6x!)'
nl|'\n'
string|"'127.0.1.1'"
op|':'
number|'0.052380952380952375'
op|','
nl|'\n'
string|"'127.0.1.2'"
op|':'
number|'0.052380952380952375'
op|','
nl|'\n'
string|"'127.0.1.3'"
op|':'
number|'0.052380952380952375'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
op|'{'
name|'tier'
op|'['
number|'2'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'3'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_gradual_replica_count
dedent|''
name|'def'
name|'test_gradual_replica_count'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'3'
op|','
number|'2.5'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'2000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'weight'"
op|':'
number|'2000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'weight'"
op|':'
number|'2000'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'weight'"
op|':'
number|'2000'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
number|'0'
op|':'
number|'0.625'
op|','
nl|'\n'
number|'1'
op|':'
number|'0.625'
op|','
nl|'\n'
number|'2'
op|':'
number|'0.625'
op|','
nl|'\n'
number|'3'
op|':'
number|'0.625'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
nl|'\n'
name|'tier'
op|'['
number|'3'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
nl|'\n'
name|'tier'
op|'['
number|'3'
op|']'
op|':'
name|'wanted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'wanted'
op|')'
name|'in'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# server 127.0.0.2 will have only one device'
nl|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'2'
op|')'
newline|'\n'
nl|'\n'
comment|'# server 127.0.0.1 has twice the capacity of 127.0.0.2'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'127.0.0.1'"
op|':'
number|'1.6666666666666667'
op|','
nl|'\n'
string|"'127.0.0.2'"
op|':'
number|'0.8333333333333334'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'weighted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
nl|'\n'
name|'tier'
op|'['
number|'2'
op|']'
op|':'
name|'weighted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'weighted'
op|')'
name|'in'
name|'weighted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'3'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# dispersion requirements extend only to whole replicas'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'127.0.0.1'"
op|':'
number|'1.4999999999999998'
op|','
nl|'\n'
string|"'127.0.0.2'"
op|':'
number|'1.0'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'wanted_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_wanted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
nl|'\n'
name|'tier'
op|'['
number|'2'
op|']'
op|':'
name|'wanted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'wanted'
op|')'
name|'in'
name|'wanted_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'3'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# 5/6ths to a whole replicanth is a 20% increase'
nl|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'0.2'
op|')'
newline|'\n'
nl|'\n'
comment|"# so let's suppose we only allow for 10% overload"
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.1'
op|')'
newline|'\n'
name|'target_replicas'
op|'='
name|'rb'
op|'.'
name|'_build_target_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'127.0.0.1'"
op|':'
number|'1.5833333333333333'
op|','
nl|'\n'
string|"'127.0.0.2'"
op|':'
number|'0.9166666666666667'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
nl|'\n'
name|'tier'
op|'['
number|'2'
op|']'
op|':'
name|'wanted'
nl|'\n'
name|'for'
op|'('
name|'tier'
op|','
name|'wanted'
op|')'
name|'in'
name|'target_replicas'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'3'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_perfect_four_zone_four_replica_bad_placement
dedent|''
name|'def'
name|'test_perfect_four_zone_four_replica_bad_placement'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'4'
op|','
number|'4'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
comment|"# this weight is sorta nuts, but it's really just to help the"
nl|'\n'
comment|'# weight_of_one_part hit a magic number where floats mess up'
nl|'\n'
comment|"# like they would on ring with a part power of 19 and 100's of"
nl|'\n'
comment|"# 1000's of units of weight."
nl|'\n'
name|'weight'
op|'='
number|'21739130434795e-11'
newline|'\n'
nl|'\n'
comment|'# r0z0'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
name|'weight'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
name|'weight'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
comment|'# r0z1'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
name|'weight'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.1.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
name|'weight'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.1.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
comment|'# r1z0'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
name|'weight'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.1.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
name|'weight'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.1.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
comment|'# r1z1'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
name|'weight'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.1.1.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
name|'weight'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.1.1.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# the replica plan is sound'
nl|'\n'
name|'expectations'
op|'='
op|'{'
nl|'\n'
comment|'# tier_len => expected replicas'
nl|'\n'
number|'1'
op|':'
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
op|')'
op|':'
number|'2.0'
op|','
nl|'\n'
op|'('
number|'1'
op|','
op|')'
op|':'
number|'2.0'
op|','
nl|'\n'
op|'}'
op|','
nl|'\n'
number|'2'
op|':'
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'1'
op|','
number|'0'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'('
number|'1'
op|','
number|'1'
op|')'
op|':'
number|'1.0'
op|','
nl|'\n'
op|'}'
nl|'\n'
op|'}'
newline|'\n'
name|'wr'
op|'='
name|'rb'
op|'.'
name|'_build_replica_plan'
op|'('
op|')'
newline|'\n'
name|'for'
name|'tier_len'
op|','
name|'expected'
name|'in'
name|'expectations'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'t'
op|':'
name|'r'
op|'['
string|"'max'"
op|']'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'wr'
op|'.'
name|'items'
op|'('
op|')'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
name|'tier_len'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# even thought a naive ceil of weights is surprisingly wrong'
nl|'\n'
dedent|''
name|'expectations'
op|'='
op|'{'
nl|'\n'
comment|'# tier_len => expected replicas'
nl|'\n'
number|'1'
op|':'
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
op|')'
op|':'
number|'3.0'
op|','
nl|'\n'
op|'('
number|'1'
op|','
op|')'
op|':'
number|'3.0'
op|','
nl|'\n'
op|'}'
op|','
nl|'\n'
number|'2'
op|':'
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
number|'2.0'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'1'
op|')'
op|':'
number|'2.0'
op|','
nl|'\n'
op|'('
number|'1'
op|','
number|'0'
op|')'
op|':'
number|'2.0'
op|','
nl|'\n'
op|'('
number|'1'
op|','
number|'1'
op|')'
op|':'
number|'2.0'
op|','
nl|'\n'
op|'}'
nl|'\n'
op|'}'
newline|'\n'
name|'wr'
op|'='
name|'rb'
op|'.'
name|'_build_weighted_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'for'
name|'tier_len'
op|','
name|'expected'
name|'in'
name|'expectations'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
op|'{'
name|'t'
op|':'
name|'ceil'
op|'('
name|'r'
op|')'
name|'for'
op|'('
name|'t'
op|','
name|'r'
op|')'
name|'in'
nl|'\n'
name|'wr'
op|'.'
name|'items'
op|'('
op|')'
name|'if'
name|'len'
op|'('
name|'t'
op|')'
op|'=='
name|'tier_len'
op|'}'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
name|'if'
name|'__name__'
op|'=='
string|"'__main__'"
op|':'
newline|'\n'
indent|'    '
name|'unittest'
op|'.'
name|'main'
op|'('
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit

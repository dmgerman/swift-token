begin_unit
comment|'# Licensed under the Apache License, Version 2.0 (the "License"); you may not'
nl|'\n'
comment|'# use this file except in compliance with the License. You may obtain a copy'
nl|'\n'
comment|'# of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#     http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'# License for the specific language governing permissions and limitations'
nl|'\n'
comment|'# under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'sqlite3'
newline|'\n'
name|'from'
name|'datetime'
name|'import'
name|'datetime'
newline|'\n'
nl|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'hash_path'
op|','
name|'storage_directory'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'ring'
name|'import'
name|'Ring'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'request_helpers'
name|'import'
name|'is_sys_meta'
op|','
name|'is_user_meta'
op|','
name|'strip_sys_meta_prefix'
op|','
name|'strip_user_meta_prefix'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'account'
op|'.'
name|'backend'
name|'import'
name|'AccountBroker'
op|','
name|'DATADIR'
name|'as'
name|'ABDATADIR'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'container'
op|'.'
name|'backend'
name|'import'
name|'ContainerBroker'
op|','
name|'DATADIR'
name|'as'
name|'CBDATADIR'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|InfoSystemExit
name|'class'
name|'InfoSystemExit'
op|'('
name|'Exception'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Indicates to the caller that a sys.exit(1) should be performed.\n    """'
newline|'\n'
name|'pass'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|print_ring_locations
dedent|''
name|'def'
name|'print_ring_locations'
op|'('
name|'ring'
op|','
name|'datadir'
op|','
name|'account'
op|','
name|'container'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    print out ring locations of specified type\n\n    :param ring: ring instance\n    :param datadir: high level directory to store account/container/objects\n    :param acount: account name\n    :param container: container name\n    """'
newline|'\n'
name|'if'
name|'ring'
name|'is'
name|'None'
name|'or'
name|'datadir'
name|'is'
name|'None'
name|'or'
name|'account'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'ValueError'
op|'('
string|"'None type'"
op|')'
newline|'\n'
dedent|''
name|'storage_type'
op|'='
string|"'account'"
newline|'\n'
name|'if'
name|'container'
op|':'
newline|'\n'
indent|'        '
name|'storage_type'
op|'='
string|"'container'"
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'part'
op|','
name|'nodes'
op|'='
name|'ring'
op|'.'
name|'get_nodes'
op|'('
name|'account'
op|','
name|'container'
op|','
name|'None'
op|')'
newline|'\n'
dedent|''
name|'except'
op|'('
name|'ValueError'
op|','
name|'AttributeError'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'ValueError'
op|'('
string|"'Ring error'"
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'path_hash'
op|'='
name|'hash_path'
op|'('
name|'account'
op|','
name|'container'
op|','
name|'None'
op|')'
newline|'\n'
name|'print'
string|"'\\nRing locations:'"
newline|'\n'
name|'for'
name|'node'
name|'in'
name|'nodes'
op|':'
newline|'\n'
indent|'            '
name|'print'
op|'('
string|"'  %s:%s - /srv/node/%s/%s/%s.db'"
op|'%'
nl|'\n'
op|'('
name|'node'
op|'['
string|"'ip'"
op|']'
op|','
name|'node'
op|'['
string|"'port'"
op|']'
op|','
name|'node'
op|'['
string|"'device'"
op|']'
op|','
nl|'\n'
name|'storage_directory'
op|'('
name|'datadir'
op|','
name|'part'
op|','
name|'path_hash'
op|')'
op|','
nl|'\n'
name|'path_hash'
op|')'
op|')'
newline|'\n'
dedent|''
name|'print'
string|"'\\nnote: /srv/node is used as default value of `devices`, the '"
string|"'real value is set in the %s config file on each storage node.'"
op|'%'
name|'storage_type'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|print_db_info_metadata
dedent|''
dedent|''
name|'def'
name|'print_db_info_metadata'
op|'('
name|'db_type'
op|','
name|'info'
op|','
name|'metadata'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    print out data base info/metadata based on its type\n\n    :param db_type: database type, account or container\n    :param info: dict of data base info\n    :param metadata: dict of data base metadata\n    """'
newline|'\n'
name|'if'
name|'info'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'ValueError'
op|'('
string|"'DB info is None'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'db_type'
name|'not'
name|'in'
op|'['
string|"'container'"
op|','
string|"'account'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'ValueError'
op|'('
string|"'Wrong DB type'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'account'
op|'='
name|'info'
op|'['
string|"'account'"
op|']'
newline|'\n'
name|'container'
op|'='
name|'None'
newline|'\n'
nl|'\n'
name|'if'
name|'db_type'
op|'=='
string|"'container'"
op|':'
newline|'\n'
indent|'            '
name|'container'
op|'='
name|'info'
op|'['
string|"'container'"
op|']'
newline|'\n'
name|'path'
op|'='
string|"'/%s/%s'"
op|'%'
op|'('
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'path'
op|'='
string|"'/%s'"
op|'%'
name|'account'
newline|'\n'
nl|'\n'
dedent|''
name|'print'
string|"'Path: %s'"
op|'%'
name|'path'
newline|'\n'
name|'print'
string|"'  Account: %s'"
op|'%'
name|'account'
newline|'\n'
nl|'\n'
name|'if'
name|'db_type'
op|'=='
string|"'container'"
op|':'
newline|'\n'
indent|'            '
name|'print'
string|"'  Container: %s'"
op|'%'
name|'container'
newline|'\n'
nl|'\n'
dedent|''
name|'path_hash'
op|'='
name|'hash_path'
op|'('
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'if'
name|'db_type'
op|'=='
string|"'container'"
op|':'
newline|'\n'
indent|'            '
name|'print'
string|"'  Container Hash: %s'"
op|'%'
name|'path_hash'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'print'
string|"'  Account Hash: %s'"
op|'%'
name|'path_hash'
newline|'\n'
nl|'\n'
dedent|''
name|'print'
string|"'Metadata:'"
newline|'\n'
name|'print'
op|'('
string|"'  Created at: %s (%s)'"
op|'%'
nl|'\n'
op|'('
name|'datetime'
op|'.'
name|'utcfromtimestamp'
op|'('
name|'float'
op|'('
name|'info'
op|'['
string|"'created_at'"
op|']'
op|')'
op|')'
op|','
nl|'\n'
name|'info'
op|'['
string|"'created_at'"
op|']'
op|')'
op|')'
newline|'\n'
name|'print'
op|'('
string|"'  Put Timestamp: %s (%s)'"
op|'%'
nl|'\n'
op|'('
name|'datetime'
op|'.'
name|'utcfromtimestamp'
op|'('
name|'float'
op|'('
name|'info'
op|'['
string|"'put_timestamp'"
op|']'
op|')'
op|')'
op|','
nl|'\n'
name|'info'
op|'['
string|"'put_timestamp'"
op|']'
op|')'
op|')'
newline|'\n'
name|'print'
op|'('
string|"'  Delete Timestamp: %s (%s)'"
op|'%'
nl|'\n'
op|'('
name|'datetime'
op|'.'
name|'utcfromtimestamp'
op|'('
name|'float'
op|'('
name|'info'
op|'['
string|"'delete_timestamp'"
op|']'
op|')'
op|')'
op|','
nl|'\n'
name|'info'
op|'['
string|"'delete_timestamp'"
op|']'
op|')'
op|')'
newline|'\n'
name|'if'
name|'db_type'
op|'=='
string|"'account'"
op|':'
newline|'\n'
indent|'            '
name|'print'
string|"'  Container Count: %s'"
op|'%'
name|'info'
op|'['
string|"'container_count'"
op|']'
newline|'\n'
dedent|''
name|'print'
string|"'  Object Count: %s'"
op|'%'
name|'info'
op|'['
string|"'object_count'"
op|']'
newline|'\n'
name|'print'
string|"'  Bytes Used: %s'"
op|'%'
name|'info'
op|'['
string|"'bytes_used'"
op|']'
newline|'\n'
name|'if'
name|'db_type'
op|'=='
string|"'container'"
op|':'
newline|'\n'
indent|'            '
name|'print'
op|'('
string|"'  Reported Put Timestamp: %s (%s)'"
op|'%'
nl|'\n'
op|'('
name|'datetime'
op|'.'
name|'utcfromtimestamp'
op|'('
nl|'\n'
name|'float'
op|'('
name|'info'
op|'['
string|"'reported_put_timestamp'"
op|']'
op|')'
op|')'
op|','
nl|'\n'
name|'info'
op|'['
string|"'reported_put_timestamp'"
op|']'
op|')'
op|')'
newline|'\n'
name|'print'
op|'('
string|"'  Reported Delete Timestamp: %s (%s)'"
op|'%'
nl|'\n'
op|'('
name|'datetime'
op|'.'
name|'utcfromtimestamp'
nl|'\n'
op|'('
name|'float'
op|'('
name|'info'
op|'['
string|"'reported_delete_timestamp'"
op|']'
op|')'
op|')'
op|','
nl|'\n'
name|'info'
op|'['
string|"'reported_delete_timestamp'"
op|']'
op|')'
op|')'
newline|'\n'
name|'print'
string|"'  Reported Object Count: %s'"
op|'%'
name|'info'
op|'['
string|"'reported_object_count'"
op|']'
newline|'\n'
name|'print'
string|"'  Reported Bytes Used: %s'"
op|'%'
name|'info'
op|'['
string|"'reported_bytes_used'"
op|']'
newline|'\n'
dedent|''
name|'print'
string|"'  Chexor: %s'"
op|'%'
name|'info'
op|'['
string|"'hash'"
op|']'
newline|'\n'
name|'print'
string|"'  UUID: %s'"
op|'%'
name|'info'
op|'['
string|"'id'"
op|']'
newline|'\n'
dedent|''
name|'except'
name|'KeyError'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'ValueError'
op|'('
string|"'Info is incomplete'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'meta_prefix'
op|'='
string|"'x_'"
op|'+'
name|'db_type'
op|'+'
string|"'_'"
newline|'\n'
name|'for'
name|'key'
op|','
name|'value'
name|'in'
name|'info'
op|'.'
name|'iteritems'
op|'('
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
op|'.'
name|'startswith'
op|'('
name|'meta_prefix'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'title'
op|'='
name|'key'
op|'.'
name|'replace'
op|'('
string|"'_'"
op|','
string|"'-'"
op|')'
op|'.'
name|'title'
op|'('
op|')'
newline|'\n'
name|'print'
string|"'  %s: %s'"
op|'%'
op|'('
name|'title'
op|','
name|'value'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'user_metadata'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'sys_metadata'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'key'
op|','
op|'('
name|'value'
op|','
name|'timestamp'
op|')'
name|'in'
name|'metadata'
op|'.'
name|'iteritems'
op|'('
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'is_user_meta'
op|'('
name|'db_type'
op|','
name|'key'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'user_metadata'
op|'['
name|'strip_user_meta_prefix'
op|'('
name|'db_type'
op|','
name|'key'
op|')'
op|']'
op|'='
name|'value'
newline|'\n'
dedent|''
name|'elif'
name|'is_sys_meta'
op|'('
name|'db_type'
op|','
name|'key'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'sys_metadata'
op|'['
name|'strip_sys_meta_prefix'
op|'('
name|'db_type'
op|','
name|'key'
op|')'
op|']'
op|'='
name|'value'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'title'
op|'='
name|'key'
op|'.'
name|'replace'
op|'('
string|"'_'"
op|','
string|"'-'"
op|')'
op|'.'
name|'title'
op|'('
op|')'
newline|'\n'
name|'print'
string|"'  %s: %s'"
op|'%'
op|'('
name|'title'
op|','
name|'value'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'sys_metadata'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|"'  System Metadata: %s'"
op|'%'
name|'sys_metadata'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|"'No system metadata found in db file'"
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'user_metadata'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|"'  User Metadata: %s'"
op|'%'
name|'user_metadata'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|"'No user metadata found in db file'"
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|print_info
dedent|''
dedent|''
name|'def'
name|'print_info'
op|'('
name|'db_type'
op|','
name|'db_file'
op|','
name|'swift_dir'
op|'='
string|"'/etc/swift'"
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'db_type'
name|'not'
name|'in'
op|'('
string|"'account'"
op|','
string|"'container'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|'"Unrecognized DB type: internal error"'
newline|'\n'
name|'raise'
name|'InfoSystemExit'
op|'('
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'db_file'
op|')'
name|'or'
name|'not'
name|'db_file'
op|'.'
name|'endswith'
op|'('
string|"'.db'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|'"DB file doesn\'t exist"'
newline|'\n'
name|'raise'
name|'InfoSystemExit'
op|'('
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'db_file'
op|'.'
name|'startswith'
op|'('
op|'('
string|"'/'"
op|','
string|"'./'"
op|')'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'db_file'
op|'='
string|"'./'"
op|'+'
name|'db_file'
comment|"# don't break if the bare db file is given"
newline|'\n'
dedent|''
name|'if'
name|'db_type'
op|'=='
string|"'account'"
op|':'
newline|'\n'
indent|'        '
name|'broker'
op|'='
name|'AccountBroker'
op|'('
name|'db_file'
op|')'
newline|'\n'
name|'datadir'
op|'='
name|'ABDATADIR'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'broker'
op|'='
name|'ContainerBroker'
op|'('
name|'db_file'
op|')'
newline|'\n'
name|'datadir'
op|'='
name|'CBDATADIR'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
dedent|''
name|'except'
name|'sqlite3'
op|'.'
name|'OperationalError'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'        '
name|'if'
string|"'no such table'"
name|'in'
name|'str'
op|'('
name|'err'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'print'
string|'"Does not appear to be a DB of type \\"%s\\": %s"'
op|'%'
op|'('
nl|'\n'
name|'db_type'
op|','
name|'db_file'
op|')'
newline|'\n'
name|'raise'
name|'InfoSystemExit'
op|'('
op|')'
newline|'\n'
dedent|''
name|'raise'
newline|'\n'
dedent|''
name|'account'
op|'='
name|'info'
op|'['
string|"'account'"
op|']'
newline|'\n'
name|'container'
op|'='
name|'info'
op|'['
string|"'container'"
op|']'
name|'if'
name|'db_type'
op|'=='
string|"'container'"
name|'else'
name|'None'
newline|'\n'
name|'print_db_info_metadata'
op|'('
name|'db_type'
op|','
name|'info'
op|','
name|'broker'
op|'.'
name|'metadata'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'ring'
op|'='
name|'Ring'
op|'('
name|'swift_dir'
op|','
name|'ring_name'
op|'='
name|'db_type'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'        '
name|'ring'
op|'='
name|'None'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'print_ring_locations'
op|'('
name|'ring'
op|','
name|'datadir'
op|','
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit

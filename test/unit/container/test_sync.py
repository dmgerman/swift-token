begin_unit
comment|'# Copyright (c) 2010-2012 OpenStack Foundation'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'re'
newline|'\n'
name|'import'
name|'unittest'
newline|'\n'
name|'from'
name|'contextlib'
name|'import'
name|'nested'
newline|'\n'
nl|'\n'
name|'import'
name|'mock'
newline|'\n'
nl|'\n'
name|'from'
name|'test'
op|'.'
name|'unit'
name|'import'
name|'FakeLogger'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'container'
name|'import'
name|'sync'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'utils'
newline|'\n'
name|'from'
name|'swiftclient'
name|'import'
name|'ClientException'
newline|'\n'
nl|'\n'
nl|'\n'
name|'utils'
op|'.'
name|'HASH_PATH_SUFFIX'
op|'='
string|"'endcap'"
newline|'\n'
name|'utils'
op|'.'
name|'HASH_PATH_PREFIX'
op|'='
string|"'endcap'"
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|FakeRing
name|'class'
name|'FakeRing'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'devs'
op|'='
op|'['
op|'{'
string|"'ip'"
op|':'
string|"'10.0.0.%s'"
op|'%'
name|'x'
op|','
string|"'port'"
op|':'
number|'1000'
op|'+'
name|'x'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
nl|'\n'
name|'for'
name|'x'
name|'in'
name|'xrange'
op|'('
number|'3'
op|')'
op|']'
newline|'\n'
nl|'\n'
DECL|member|get_nodes
dedent|''
name|'def'
name|'get_nodes'
op|'('
name|'self'
op|','
name|'account'
op|','
name|'container'
op|'='
name|'None'
op|','
name|'obj'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
number|'1'
op|','
name|'list'
op|'('
name|'self'
op|'.'
name|'devs'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|FakeContainerBroker
dedent|''
dedent|''
name|'class'
name|'FakeContainerBroker'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'path'
op|','
name|'metadata'
op|'='
name|'None'
op|','
name|'info'
op|'='
name|'None'
op|','
name|'deleted'
op|'='
name|'False'
op|','
nl|'\n'
name|'items_since'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'db_file'
op|'='
name|'path'
newline|'\n'
name|'self'
op|'.'
name|'metadata'
op|'='
name|'metadata'
name|'if'
name|'metadata'
name|'else'
op|'{'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'info'
op|'='
name|'info'
name|'if'
name|'info'
name|'else'
op|'{'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'deleted'
op|'='
name|'deleted'
newline|'\n'
name|'self'
op|'.'
name|'items_since'
op|'='
name|'items_since'
name|'if'
name|'items_since'
name|'else'
op|'['
op|']'
newline|'\n'
name|'self'
op|'.'
name|'sync_point1'
op|'='
op|'-'
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'sync_point2'
op|'='
op|'-'
number|'1'
newline|'\n'
nl|'\n'
DECL|member|get_info
dedent|''
name|'def'
name|'get_info'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'info'
newline|'\n'
nl|'\n'
DECL|member|is_deleted
dedent|''
name|'def'
name|'is_deleted'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'deleted'
newline|'\n'
nl|'\n'
DECL|member|get_items_since
dedent|''
name|'def'
name|'get_items_since'
op|'('
name|'self'
op|','
name|'sync_point'
op|','
name|'limit'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'sync_point'
op|'<'
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'sync_point'
op|'='
number|'0'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'items_since'
op|'['
name|'sync_point'
op|':'
name|'sync_point'
op|'+'
name|'limit'
op|']'
newline|'\n'
nl|'\n'
DECL|member|set_x_container_sync_points
dedent|''
name|'def'
name|'set_x_container_sync_points'
op|'('
name|'self'
op|','
name|'sync_point1'
op|','
name|'sync_point2'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'sync_point1'
op|'='
name|'sync_point1'
newline|'\n'
name|'self'
op|'.'
name|'sync_point2'
op|'='
name|'sync_point2'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|TestContainerSync
dedent|''
dedent|''
name|'class'
name|'TestContainerSync'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|test_FileLikeIter
indent|'    '
name|'def'
name|'test_FileLikeIter'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Retained test to show new FileLikeIter acts just like the removed'
nl|'\n'
comment|'# _Iter2FileLikeObject did.'
nl|'\n'
indent|'        '
name|'flo'
op|'='
name|'sync'
op|'.'
name|'FileLikeIter'
op|'('
name|'iter'
op|'('
op|'['
string|"'123'"
op|','
string|"'4567'"
op|','
string|"'89'"
op|','
string|"'0'"
op|']'
op|')'
op|')'
newline|'\n'
name|'expect'
op|'='
string|"'1234567890'"
newline|'\n'
nl|'\n'
name|'got'
op|'='
name|'flo'
op|'.'
name|'read'
op|'('
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'len'
op|'('
name|'got'
op|')'
op|'<='
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'got'
op|','
name|'expect'
op|'['
op|':'
name|'len'
op|'('
name|'got'
op|')'
op|']'
op|')'
newline|'\n'
name|'expect'
op|'='
name|'expect'
op|'['
name|'len'
op|'('
name|'got'
op|')'
op|':'
op|']'
newline|'\n'
nl|'\n'
name|'got'
op|'='
name|'flo'
op|'.'
name|'read'
op|'('
number|'5'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'len'
op|'('
name|'got'
op|')'
op|'<='
number|'5'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'got'
op|','
name|'expect'
op|'['
op|':'
name|'len'
op|'('
name|'got'
op|')'
op|']'
op|')'
newline|'\n'
name|'expect'
op|'='
name|'expect'
op|'['
name|'len'
op|'('
name|'got'
op|')'
op|':'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'flo'
op|'.'
name|'read'
op|'('
op|')'
op|','
name|'expect'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'flo'
op|'.'
name|'read'
op|'('
op|')'
op|','
string|"''"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'flo'
op|'.'
name|'read'
op|'('
number|'2'
op|')'
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
name|'flo'
op|'='
name|'sync'
op|'.'
name|'FileLikeIter'
op|'('
name|'iter'
op|'('
op|'['
string|"'123'"
op|','
string|"'4567'"
op|','
string|"'89'"
op|','
string|"'0'"
op|']'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'flo'
op|'.'
name|'read'
op|'('
op|')'
op|','
string|"'1234567890'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'flo'
op|'.'
name|'read'
op|'('
op|')'
op|','
string|"''"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'flo'
op|'.'
name|'read'
op|'('
number|'2'
op|')'
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_init
dedent|''
name|'def'
name|'test_init'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'oring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|','
name|'object_ring'
op|'='
name|'oring'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'cs'
op|'.'
name|'container_ring'
name|'is'
name|'cring'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'cs'
op|'.'
name|'object_ring'
name|'is'
name|'oring'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_forever
dedent|''
name|'def'
name|'test_run_forever'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# This runs runs_forever with fakes to succeed for two loops, the first'
nl|'\n'
comment|'# causing a report but no interval sleep, the second no report but an'
nl|'\n'
comment|'# interval sleep.'
nl|'\n'
indent|'        '
name|'time_calls'
op|'='
op|'['
number|'0'
op|']'
newline|'\n'
name|'sleep_calls'
op|'='
op|'['
op|']'
newline|'\n'
name|'audit_location_generator_calls'
op|'='
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_time
name|'def'
name|'fake_time'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'time_calls'
op|'['
number|'0'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'returns'
op|'='
op|'['
number|'1'
op|','
comment|'# Initialized reported time'
nl|'\n'
number|'1'
op|','
comment|'# Start time'
nl|'\n'
number|'3602'
op|','
comment|'# Is it report time (yes)'
nl|'\n'
number|'3602'
op|','
comment|'# Report time'
nl|'\n'
number|'3602'
op|','
comment|'# Elapsed time for "under interval" (no)'
nl|'\n'
number|'3602'
op|','
comment|'# Start time'
nl|'\n'
number|'3603'
op|','
comment|'# Is it report time (no)'
nl|'\n'
number|'3603'
op|']'
comment|'# Elapsed time for "under interval" (yes)'
newline|'\n'
name|'if'
name|'time_calls'
op|'['
number|'0'
op|']'
op|'=='
name|'len'
op|'('
name|'returns'
op|')'
op|'+'
number|'1'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'Exception'
op|'('
string|"'we are now done'"
op|')'
newline|'\n'
dedent|''
name|'return'
name|'returns'
op|'['
name|'time_calls'
op|'['
number|'0'
op|']'
op|'-'
number|'1'
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_sleep
dedent|''
name|'def'
name|'fake_sleep'
op|'('
name|'amount'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'sleep_calls'
op|'.'
name|'append'
op|'('
name|'amount'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_audit_location_generator
dedent|''
name|'def'
name|'fake_audit_location_generator'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'audit_location_generator_calls'
op|'['
number|'0'
op|']'
op|'+='
number|'1'
newline|'\n'
comment|'# Makes .container_sync() short-circuit'
nl|'\n'
name|'yield'
string|"'container.db'"
op|','
string|"'device'"
op|','
string|"'partition'"
newline|'\n'
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'orig_time'
op|'='
name|'sync'
op|'.'
name|'time'
newline|'\n'
name|'orig_sleep'
op|'='
name|'sync'
op|'.'
name|'sleep'
newline|'\n'
name|'orig_audit_location_generator'
op|'='
name|'sync'
op|'.'
name|'audit_location_generator'
newline|'\n'
name|'orig_ContainerBroker'
op|'='
name|'sync'
op|'.'
name|'ContainerBroker'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|'}'
op|')'
newline|'\n'
name|'sync'
op|'.'
name|'time'
op|'='
name|'fake_time'
newline|'\n'
name|'sync'
op|'.'
name|'sleep'
op|'='
name|'fake_sleep'
newline|'\n'
name|'sync'
op|'.'
name|'audit_location_generator'
op|'='
name|'fake_audit_location_generator'
newline|'\n'
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
op|','
nl|'\n'
name|'object_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'run_forever'
op|'('
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'str'
op|'('
name|'err'
op|')'
op|'!='
string|"'we are now done'"
op|':'
newline|'\n'
indent|'                '
name|'raise'
newline|'\n'
dedent|''
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'time'
op|'='
name|'orig_time'
newline|'\n'
name|'sync'
op|'.'
name|'sleep'
op|'='
name|'orig_sleep'
newline|'\n'
name|'sync'
op|'.'
name|'audit_location_generator'
op|'='
name|'orig_audit_location_generator'
newline|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'orig_ContainerBroker'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'time_calls'
op|','
op|'['
number|'9'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'sleep_calls'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'sleep_calls'
op|'['
number|'0'
op|']'
op|'<='
name|'cs'
op|'.'
name|'interval'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'sleep_calls'
op|'['
number|'1'
op|']'
op|'=='
name|'cs'
op|'.'
name|'interval'
op|'-'
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'audit_location_generator_calls'
op|','
op|'['
number|'2'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'reported'
op|','
number|'3602'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_once
dedent|''
name|'def'
name|'test_run_once'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# This runs runs_once with fakes twice, the first causing an interim'
nl|'\n'
comment|'# report, the second with no interim report.'
nl|'\n'
indent|'        '
name|'time_calls'
op|'='
op|'['
number|'0'
op|']'
newline|'\n'
name|'audit_location_generator_calls'
op|'='
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_time
name|'def'
name|'fake_time'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'time_calls'
op|'['
number|'0'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'returns'
op|'='
op|'['
number|'1'
op|','
comment|'# Initialized reported time'
nl|'\n'
number|'1'
op|','
comment|'# Start time'
nl|'\n'
number|'3602'
op|','
comment|'# Is it report time (yes)'
nl|'\n'
number|'3602'
op|','
comment|'# Report time'
nl|'\n'
number|'3602'
op|','
comment|'# End report time'
nl|'\n'
number|'3602'
op|','
comment|'# For elapsed'
nl|'\n'
number|'3602'
op|','
comment|'# Start time'
nl|'\n'
number|'3603'
op|','
comment|'# Is it report time (no)'
nl|'\n'
number|'3604'
op|','
comment|'# End report time'
nl|'\n'
number|'3605'
op|']'
comment|'# For elapsed'
newline|'\n'
name|'if'
name|'time_calls'
op|'['
number|'0'
op|']'
op|'=='
name|'len'
op|'('
name|'returns'
op|')'
op|'+'
number|'1'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'Exception'
op|'('
string|"'we are now done'"
op|')'
newline|'\n'
dedent|''
name|'return'
name|'returns'
op|'['
name|'time_calls'
op|'['
number|'0'
op|']'
op|'-'
number|'1'
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_audit_location_generator
dedent|''
name|'def'
name|'fake_audit_location_generator'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'audit_location_generator_calls'
op|'['
number|'0'
op|']'
op|'+='
number|'1'
newline|'\n'
comment|'# Makes .container_sync() short-circuit'
nl|'\n'
name|'yield'
string|"'container.db'"
op|','
string|"'device'"
op|','
string|"'partition'"
newline|'\n'
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'orig_time'
op|'='
name|'sync'
op|'.'
name|'time'
newline|'\n'
name|'orig_audit_location_generator'
op|'='
name|'sync'
op|'.'
name|'audit_location_generator'
newline|'\n'
name|'orig_ContainerBroker'
op|'='
name|'sync'
op|'.'
name|'ContainerBroker'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|'}'
op|')'
newline|'\n'
name|'sync'
op|'.'
name|'time'
op|'='
name|'fake_time'
newline|'\n'
name|'sync'
op|'.'
name|'audit_location_generator'
op|'='
name|'fake_audit_location_generator'
newline|'\n'
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
op|','
nl|'\n'
name|'object_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'run_once'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'time_calls'
op|','
op|'['
number|'6'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'audit_location_generator_calls'
op|','
op|'['
number|'1'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'reported'
op|','
number|'3602'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'run_once'
op|'('
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'str'
op|'('
name|'err'
op|')'
op|'!='
string|"'we are now done'"
op|':'
newline|'\n'
indent|'                '
name|'raise'
newline|'\n'
dedent|''
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'time'
op|'='
name|'orig_time'
newline|'\n'
name|'sync'
op|'.'
name|'audit_location_generator'
op|'='
name|'orig_audit_location_generator'
newline|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'orig_ContainerBroker'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'time_calls'
op|','
op|'['
number|'10'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'audit_location_generator_calls'
op|','
op|'['
number|'2'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'reported'
op|','
number|'3604'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_container_sync_not_db
dedent|''
name|'def'
name|'test_container_sync_not_db'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'oring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|','
name|'object_ring'
op|'='
name|'oring'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_container_sync_missing_db
dedent|''
name|'def'
name|'test_container_sync_missing_db'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'oring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|','
name|'object_ring'
op|'='
name|'oring'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_container_sync_not_my_db
dedent|''
name|'def'
name|'test_container_sync_not_my_db'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Db could be there due to handoff replication so test that we ignore'
nl|'\n'
comment|'# those.'
nl|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'oring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|','
name|'object_ring'
op|'='
name|'oring'
op|')'
newline|'\n'
name|'orig_ContainerBroker'
op|'='
name|'sync'
op|'.'
name|'ContainerBroker'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|'}'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
comment|'# No match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1'
comment|'# No match'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1'
comment|'# No match'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
comment|'# No match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
comment|'# This complete match will cause the 1 container failure since the'
nl|'\n'
comment|"# broker's info doesn't contain sync point keys"
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'orig_ContainerBroker'
newline|'\n'
nl|'\n'
DECL|member|test_container_sync_deleted
dedent|''
dedent|''
name|'def'
name|'test_container_sync_deleted'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'oring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|','
name|'object_ring'
op|'='
name|'oring'
op|')'
newline|'\n'
name|'orig_ContainerBroker'
op|'='
name|'sync'
op|'.'
name|'ContainerBroker'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|'}'
op|','
name|'deleted'
op|'='
name|'False'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
comment|'# This complete match will cause the 1 container failure since the'
nl|'\n'
comment|"# broker's info doesn't contain sync point keys"
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|'}'
op|','
name|'deleted'
op|'='
name|'True'
op|')'
newline|'\n'
comment|'# This complete match will not cause any more container failures'
nl|'\n'
comment|'# since the broker indicates deletion'
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'orig_ContainerBroker'
newline|'\n'
nl|'\n'
DECL|member|test_container_sync_no_to_or_key
dedent|''
dedent|''
name|'def'
name|'test_container_sync_no_to_or_key'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'oring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|','
name|'object_ring'
op|'='
name|'oring'
op|')'
newline|'\n'
name|'orig_ContainerBroker'
op|'='
name|'sync'
op|'.'
name|'ContainerBroker'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
comment|"# This complete match will be skipped since the broker's metadata"
nl|'\n'
comment|'# has no x-container-sync-to or x-container-sync-key'
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|'}'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
comment|"# This complete match will be skipped since the broker's metadata"
nl|'\n'
comment|'# has no x-container-sync-key'
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
comment|"# This complete match will be skipped since the broker's metadata"
nl|'\n'
comment|'# has no x-container-sync-to'
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'3'
op|')'
newline|'\n'
nl|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
op|']'
newline|'\n'
comment|'# This complete match will cause a container failure since the'
nl|'\n'
comment|"# sync-to won't validate as allowed."
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'3'
op|')'
newline|'\n'
nl|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
comment|'# This complete match will succeed completely since the broker'
nl|'\n'
comment|'# get_items_since will return no new rows.'
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'3'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'orig_ContainerBroker'
newline|'\n'
nl|'\n'
DECL|member|test_container_stop_at
dedent|''
dedent|''
name|'def'
name|'test_container_stop_at'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'oring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|','
name|'object_ring'
op|'='
name|'oring'
op|')'
newline|'\n'
name|'orig_ContainerBroker'
op|'='
name|'sync'
op|'.'
name|'ContainerBroker'
newline|'\n'
name|'orig_time'
op|'='
name|'sync'
op|'.'
name|'time'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
string|"'erroneous data'"
op|']'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
comment|'# This sync will fail since the items_since data is bad.'
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# Set up fake times to make the sync short-circuit as having taken'
nl|'\n'
comment|'# too long'
nl|'\n'
name|'fake_times'
op|'='
op|'['
nl|'\n'
number|'1.0'
op|','
comment|'# Compute the time to move on'
nl|'\n'
number|'100000.0'
op|','
comment|"# Compute if it's time to move on from first loop"
nl|'\n'
number|'100000.0'
op|']'
comment|"# Compute if it's time to move on from second loop"
newline|'\n'
nl|'\n'
DECL|function|fake_time
name|'def'
name|'fake_time'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'fake_times'
op|'.'
name|'pop'
op|'('
number|'0'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'time'
op|'='
name|'fake_time'
newline|'\n'
comment|"# This same sync won't fail since it will look like it took so long"
nl|'\n'
comment|'# as to be time to move on (before it ever actually tries to do'
nl|'\n'
comment|'# anything).'
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'orig_ContainerBroker'
newline|'\n'
name|'sync'
op|'.'
name|'time'
op|'='
name|'orig_time'
newline|'\n'
nl|'\n'
DECL|member|test_container_first_loop
dedent|''
dedent|''
name|'def'
name|'test_container_first_loop'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'oring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|','
name|'object_ring'
op|'='
name|'oring'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_hash_path
name|'def'
name|'fake_hash_path'
op|'('
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|','
name|'raw_digest'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
comment|'# Ensures that no rows match for full syncing, ordinal is 0 and'
nl|'\n'
comment|'# all hashes are 0'
nl|'\n'
indent|'            '
name|'return'
string|"'\\x00'"
op|'*'
number|'16'
newline|'\n'
dedent|''
name|'fcb'
op|'='
name|'FakeContainerBroker'
op|'('
nl|'\n'
string|"'path'"
op|','
nl|'\n'
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
op|'{'
string|"'ROWID'"
op|':'
number|'1'
op|','
string|"'name'"
op|':'
string|"'o'"
op|'}'
op|']'
op|')'
newline|'\n'
name|'with'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.ContainerBroker'"
op|','
nl|'\n'
name|'lambda'
name|'p'
op|':'
name|'fcb'
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.hash_path'"
op|','
name|'fake_hash_path'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
comment|'# Succeeds because no rows match'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'fcb'
op|'.'
name|'sync_point1'
op|','
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'fcb'
op|'.'
name|'sync_point2'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_hash_path
dedent|''
name|'def'
name|'fake_hash_path'
op|'('
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|','
name|'raw_digest'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
comment|'# Ensures that all rows match for full syncing, ordinal is 0'
nl|'\n'
comment|'# and all hashes are 1'
nl|'\n'
indent|'            '
name|'return'
string|"'\\x01'"
op|'*'
number|'16'
newline|'\n'
dedent|''
name|'fcb'
op|'='
name|'FakeContainerBroker'
op|'('
string|"'path'"
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
nl|'\n'
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
nl|'\n'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
nl|'\n'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
op|'{'
string|"'ROWID'"
op|':'
number|'1'
op|','
string|"'name'"
op|':'
string|"'o'"
op|'}'
op|']'
op|')'
newline|'\n'
name|'with'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.ContainerBroker'"
op|','
nl|'\n'
name|'lambda'
name|'p'
op|':'
name|'fcb'
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.hash_path'"
op|','
name|'fake_hash_path'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
comment|"# Succeeds because the two sync points haven't deviated yet"
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'fcb'
op|'.'
name|'sync_point1'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'fcb'
op|'.'
name|'sync_point2'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'fcb'
op|'='
name|'FakeContainerBroker'
op|'('
nl|'\n'
string|"'path'"
op|','
nl|'\n'
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
op|'{'
string|"'ROWID'"
op|':'
number|'1'
op|','
string|"'name'"
op|':'
string|"'o'"
op|'}'
op|']'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.ContainerBroker'"
op|','
name|'lambda'
name|'p'
op|':'
name|'fcb'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
comment|'# Fails because container_sync_row will fail since the row has no'
nl|'\n'
comment|"# 'deleted' key"
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'fcb'
op|'.'
name|'sync_point1'
op|','
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'fcb'
op|'.'
name|'sync_point2'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_delete_object
dedent|''
name|'def'
name|'fake_delete_object'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'ClientException'
newline|'\n'
dedent|''
name|'fcb'
op|'='
name|'FakeContainerBroker'
op|'('
nl|'\n'
string|"'path'"
op|','
nl|'\n'
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
op|'{'
string|"'ROWID'"
op|':'
number|'1'
op|','
string|"'name'"
op|':'
string|"'o'"
op|','
string|"'created_at'"
op|':'
string|"'1.2'"
op|','
nl|'\n'
string|"'deleted'"
op|':'
name|'True'
op|'}'
op|']'
op|')'
newline|'\n'
name|'with'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.ContainerBroker'"
op|','
nl|'\n'
name|'lambda'
name|'p'
op|':'
name|'fcb'
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.delete_object'"
op|','
nl|'\n'
name|'fake_delete_object'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
comment|'# Fails because delete_object fails'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'fcb'
op|'.'
name|'sync_point1'
op|','
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'fcb'
op|'.'
name|'sync_point2'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'fcb'
op|'='
name|'FakeContainerBroker'
op|'('
nl|'\n'
string|"'path'"
op|','
nl|'\n'
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
op|'{'
string|"'ROWID'"
op|':'
number|'1'
op|','
string|"'name'"
op|':'
string|"'o'"
op|','
string|"'created_at'"
op|':'
string|"'1.2'"
op|','
nl|'\n'
string|"'deleted'"
op|':'
name|'True'
op|'}'
op|']'
op|')'
newline|'\n'
name|'with'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.ContainerBroker'"
op|','
nl|'\n'
name|'lambda'
name|'p'
op|':'
name|'fcb'
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.delete_object'"
op|','
nl|'\n'
name|'lambda'
op|'*'
name|'x'
op|','
op|'**'
name|'y'
op|':'
name|'None'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
comment|'# Succeeds because delete_object succeeds'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'fcb'
op|'.'
name|'sync_point1'
op|','
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'fcb'
op|'.'
name|'sync_point2'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_container_second_loop
dedent|''
dedent|''
name|'def'
name|'test_container_second_loop'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'oring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|','
name|'object_ring'
op|'='
name|'oring'
op|')'
newline|'\n'
name|'orig_ContainerBroker'
op|'='
name|'sync'
op|'.'
name|'ContainerBroker'
newline|'\n'
name|'orig_hash_path'
op|'='
name|'sync'
op|'.'
name|'hash_path'
newline|'\n'
name|'orig_delete_object'
op|'='
name|'sync'
op|'.'
name|'delete_object'
newline|'\n'
name|'try'
op|':'
newline|'\n'
comment|"# We'll ensure the first loop is always skipped by keeping the two"
nl|'\n'
comment|'# sync points equal'
nl|'\n'
nl|'\n'
DECL|function|fake_hash_path
indent|'            '
name|'def'
name|'fake_hash_path'
op|'('
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|','
name|'raw_digest'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
comment|'# Ensures that no rows match for second loop, ordinal is 0 and'
nl|'\n'
comment|'# all hashes are 1'
nl|'\n'
indent|'                '
name|'return'
string|"'\\x01'"
op|'*'
number|'16'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'hash_path'
op|'='
name|'fake_hash_path'
newline|'\n'
name|'fcb'
op|'='
name|'FakeContainerBroker'
op|'('
nl|'\n'
string|"'path'"
op|','
nl|'\n'
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
op|'{'
string|"'ROWID'"
op|':'
number|'1'
op|','
string|"'name'"
op|':'
string|"'o'"
op|'}'
op|']'
op|')'
newline|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'fcb'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
comment|'# Succeeds because no rows match'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'fcb'
op|'.'
name|'sync_point1'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'fcb'
op|'.'
name|'sync_point2'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_hash_path
name|'def'
name|'fake_hash_path'
op|'('
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|','
name|'raw_digest'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
comment|'# Ensures that all rows match for second loop, ordinal is 0 and'
nl|'\n'
comment|'# all hashes are 0'
nl|'\n'
indent|'                '
name|'return'
string|"'\\x00'"
op|'*'
number|'16'
newline|'\n'
nl|'\n'
DECL|function|fake_delete_object
dedent|''
name|'def'
name|'fake_delete_object'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'hash_path'
op|'='
name|'fake_hash_path'
newline|'\n'
name|'sync'
op|'.'
name|'delete_object'
op|'='
name|'fake_delete_object'
newline|'\n'
name|'fcb'
op|'='
name|'FakeContainerBroker'
op|'('
nl|'\n'
string|"'path'"
op|','
nl|'\n'
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
op|'{'
string|"'ROWID'"
op|':'
number|'1'
op|','
string|"'name'"
op|':'
string|"'o'"
op|'}'
op|']'
op|')'
newline|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'fcb'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
comment|"# Fails because row is missing 'deleted' key"
nl|'\n'
comment|'# Nevertheless the fault is skipped'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'fcb'
op|'.'
name|'sync_point1'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'fcb'
op|'.'
name|'sync_point2'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'fcb'
op|'='
name|'FakeContainerBroker'
op|'('
nl|'\n'
string|"'path'"
op|','
nl|'\n'
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
op|'{'
string|"'ROWID'"
op|':'
number|'1'
op|','
string|"'name'"
op|':'
string|"'o'"
op|','
string|"'created_at'"
op|':'
string|"'1.2'"
op|','
nl|'\n'
string|"'deleted'"
op|':'
name|'True'
op|'}'
op|']'
op|')'
newline|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'fcb'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
comment|"# Succeeds because row now has 'deleted' key and delete_object"
nl|'\n'
comment|'# succeeds'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'fcb'
op|'.'
name|'sync_point1'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'fcb'
op|'.'
name|'sync_point2'
op|','
name|'None'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'orig_ContainerBroker'
newline|'\n'
name|'sync'
op|'.'
name|'hash_path'
op|'='
name|'orig_hash_path'
newline|'\n'
name|'sync'
op|'.'
name|'delete_object'
op|'='
name|'orig_delete_object'
newline|'\n'
nl|'\n'
DECL|member|test_container_sync_row_delete
dedent|''
dedent|''
name|'def'
name|'test_container_sync_row_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'orig_delete_object'
op|'='
name|'sync'
op|'.'
name|'delete_object'
newline|'\n'
name|'try'
op|':'
newline|'\n'
nl|'\n'
DECL|function|fake_delete_object
indent|'            '
name|'def'
name|'fake_delete_object'
op|'('
name|'path'
op|','
name|'name'
op|'='
name|'None'
op|','
name|'headers'
op|'='
name|'None'
op|','
name|'proxy'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'path'
op|','
string|"'http://sync/to/path'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'name'
op|','
string|"'object'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
nl|'\n'
name|'headers'
op|','
nl|'\n'
op|'{'
string|"'x-container-sync-key'"
op|':'
string|"'key'"
op|','
string|"'x-timestamp'"
op|':'
string|"'1.2'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'proxy'
op|','
string|"'http://proxy'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'delete_object'
op|'='
name|'fake_delete_object'
newline|'\n'
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
op|','
nl|'\n'
name|'object_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'proxy'
op|'='
string|"'http://proxy'"
newline|'\n'
comment|'# Success'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'True'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
string|"'1.2'"
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
string|"'info'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_deletes'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'exc'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_delete_object
name|'def'
name|'fake_delete_object'
op|'('
name|'path'
op|','
name|'name'
op|'='
name|'None'
op|','
name|'headers'
op|'='
name|'None'
op|','
name|'proxy'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'exc'
op|'.'
name|'append'
op|'('
name|'Exception'
op|'('
string|"'test exception'"
op|')'
op|')'
newline|'\n'
name|'raise'
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'delete_object'
op|'='
name|'fake_delete_object'
newline|'\n'
comment|'# Failure because of delete_object exception'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'True'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
string|"'1.2'"
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
string|"'info'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_deletes'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'exc'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'str'
op|'('
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
op|')'
op|','
string|"'test exception'"
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_delete_object
name|'def'
name|'fake_delete_object'
op|'('
name|'path'
op|','
name|'name'
op|'='
name|'None'
op|','
name|'headers'
op|'='
name|'None'
op|','
name|'proxy'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'exc'
op|'.'
name|'append'
op|'('
name|'ClientException'
op|'('
string|"'test client exception'"
op|')'
op|')'
newline|'\n'
name|'raise'
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'delete_object'
op|'='
name|'fake_delete_object'
newline|'\n'
comment|'# Failure because of delete_object exception'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'True'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
string|"'1.2'"
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
string|"'info'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_deletes'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'exc'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'str'
op|'('
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
op|')'
op|','
string|"'test client exception'"
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_delete_object
name|'def'
name|'fake_delete_object'
op|'('
name|'path'
op|','
name|'name'
op|'='
name|'None'
op|','
name|'headers'
op|'='
name|'None'
op|','
name|'proxy'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'exc'
op|'.'
name|'append'
op|'('
name|'ClientException'
op|'('
string|"'test client exception'"
op|','
nl|'\n'
name|'http_status'
op|'='
number|'404'
op|')'
op|')'
newline|'\n'
name|'raise'
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'delete_object'
op|'='
name|'fake_delete_object'
newline|'\n'
comment|"# Success because the object wasn't even found"
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'True'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
string|"'1.2'"
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
string|"'info'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_deletes'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'exc'
op|')'
op|','
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'str'
op|'('
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
op|')'
op|','
string|"'test client exception: 404'"
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'delete_object'
op|'='
name|'orig_delete_object'
newline|'\n'
nl|'\n'
DECL|member|test_container_sync_row_put
dedent|''
dedent|''
name|'def'
name|'test_container_sync_row_put'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'orig_shuffle'
op|'='
name|'sync'
op|'.'
name|'shuffle'
newline|'\n'
name|'orig_put_object'
op|'='
name|'sync'
op|'.'
name|'put_object'
newline|'\n'
name|'orig_direct_get_object'
op|'='
name|'sync'
op|'.'
name|'direct_get_object'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'shuffle'
op|'='
name|'lambda'
name|'x'
op|':'
name|'x'
newline|'\n'
nl|'\n'
DECL|function|fake_put_object
name|'def'
name|'fake_put_object'
op|'('
name|'sync_to'
op|','
name|'name'
op|'='
name|'None'
op|','
name|'headers'
op|'='
name|'None'
op|','
nl|'\n'
name|'contents'
op|'='
name|'None'
op|','
name|'proxy'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'sync_to'
op|','
string|"'http://sync/to/path'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'name'
op|','
string|"'object'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'headers'
op|','
op|'{'
nl|'\n'
string|"'x-container-sync-key'"
op|':'
string|"'key'"
op|','
nl|'\n'
string|"'x-timestamp'"
op|':'
string|"'1.2'"
op|','
nl|'\n'
string|"'other-header'"
op|':'
string|"'other header value'"
op|','
nl|'\n'
string|"'etag'"
op|':'
string|"'etagvalue'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'contents'
op|'.'
name|'read'
op|'('
op|')'
op|','
string|"'contents'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'proxy'
op|','
string|"'http://proxy'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'put_object'
op|'='
name|'fake_put_object'
newline|'\n'
nl|'\n'
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
op|','
nl|'\n'
name|'object_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'proxy'
op|'='
string|"'http://proxy'"
newline|'\n'
nl|'\n'
DECL|function|fake_direct_get_object
name|'def'
name|'fake_direct_get_object'
op|'('
name|'node'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|','
nl|'\n'
name|'resp_chunk_size'
op|'='
number|'1'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'('
op|'{'
string|"'other-header'"
op|':'
string|"'other header value'"
op|','
nl|'\n'
string|"'etag'"
op|':'
string|'\'"etagvalue"\''
op|','
string|"'x-timestamp'"
op|':'
string|"'1.2'"
op|'}'
op|','
nl|'\n'
name|'iter'
op|'('
string|"'contents'"
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'direct_get_object'
op|'='
name|'fake_direct_get_object'
newline|'\n'
comment|'# Success as everything says it worked'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
string|"'1.2'"
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
op|'{'
nl|'\n'
string|"'account'"
op|':'
string|"'a'"
op|','
nl|'\n'
string|"'container'"
op|':'
string|"'c'"
op|'}'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_puts'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_direct_get_object
name|'def'
name|'fake_direct_get_object'
op|'('
name|'node'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|','
nl|'\n'
name|'resp_chunk_size'
op|'='
number|'1'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'('
op|'{'
string|"'date'"
op|':'
string|"'date value'"
op|','
nl|'\n'
string|"'last-modified'"
op|':'
string|"'last modified value'"
op|','
nl|'\n'
string|"'x-timestamp'"
op|':'
string|"'1.2'"
op|','
nl|'\n'
string|"'other-header'"
op|':'
string|"'other header value'"
op|','
nl|'\n'
string|"'etag'"
op|':'
string|'\'"etagvalue"\''
op|'}'
op|','
nl|'\n'
name|'iter'
op|'('
string|"'contents'"
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'direct_get_object'
op|'='
name|'fake_direct_get_object'
newline|'\n'
comment|"# Success as everything says it worked, also checks 'date' and"
nl|'\n'
comment|"# 'last-modified' headers are removed and that 'etag' header is"
nl|'\n'
comment|'# stripped of double quotes.'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
string|"'1.2'"
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
op|'{'
nl|'\n'
string|"'account'"
op|':'
string|"'a'"
op|','
nl|'\n'
string|"'container'"
op|':'
string|"'c'"
op|'}'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_puts'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
name|'exc'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_direct_get_object
name|'def'
name|'fake_direct_get_object'
op|'('
name|'node'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|','
nl|'\n'
name|'resp_chunk_size'
op|'='
number|'1'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'exc'
op|'.'
name|'append'
op|'('
name|'Exception'
op|'('
string|"'test exception'"
op|')'
op|')'
newline|'\n'
name|'raise'
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'direct_get_object'
op|'='
name|'fake_direct_get_object'
newline|'\n'
comment|'# Fail due to completely unexpected exception'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
string|"'1.2'"
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
op|'{'
nl|'\n'
string|"'account'"
op|':'
string|"'a'"
op|','
nl|'\n'
string|"'container'"
op|':'
string|"'c'"
op|'}'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_puts'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'exc'
op|')'
op|','
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'str'
op|'('
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
op|')'
op|','
string|"'test exception'"
op|')'
newline|'\n'
nl|'\n'
name|'exc'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_direct_get_object
name|'def'
name|'fake_direct_get_object'
op|'('
name|'node'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|','
nl|'\n'
name|'resp_chunk_size'
op|'='
number|'1'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'exc'
op|'.'
name|'append'
op|'('
name|'ClientException'
op|'('
string|"'test client exception'"
op|')'
op|')'
newline|'\n'
name|'raise'
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'direct_get_object'
op|'='
name|'fake_direct_get_object'
newline|'\n'
comment|'# Fail due to all direct_get_object calls failing'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
string|"'1.2'"
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
op|'{'
nl|'\n'
string|"'account'"
op|':'
string|"'a'"
op|','
nl|'\n'
string|"'container'"
op|':'
string|"'c'"
op|'}'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_puts'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'exc'
op|')'
op|','
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'str'
op|'('
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
op|')'
op|','
string|"'test client exception'"
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_direct_get_object
name|'def'
name|'fake_direct_get_object'
op|'('
name|'node'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|','
nl|'\n'
name|'resp_chunk_size'
op|'='
number|'1'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'('
op|'{'
string|"'other-header'"
op|':'
string|"'other header value'"
op|','
nl|'\n'
string|"'x-timestamp'"
op|':'
string|"'1.2'"
op|','
string|"'etag'"
op|':'
string|'\'"etagvalue"\''
op|'}'
op|','
nl|'\n'
name|'iter'
op|'('
string|"'contents'"
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_put_object
dedent|''
name|'def'
name|'fake_put_object'
op|'('
name|'sync_to'
op|','
name|'name'
op|'='
name|'None'
op|','
name|'headers'
op|'='
name|'None'
op|','
nl|'\n'
name|'contents'
op|'='
name|'None'
op|','
name|'proxy'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'ClientException'
op|'('
string|"'test client exception'"
op|','
name|'http_status'
op|'='
number|'401'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'direct_get_object'
op|'='
name|'fake_direct_get_object'
newline|'\n'
name|'sync'
op|'.'
name|'put_object'
op|'='
name|'fake_put_object'
newline|'\n'
name|'cs'
op|'.'
name|'logger'
op|'='
name|'FakeLogger'
op|'('
op|')'
newline|'\n'
comment|'# Fail due to 401'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
string|"'1.2'"
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
op|'{'
nl|'\n'
string|"'account'"
op|':'
string|"'a'"
op|','
nl|'\n'
string|"'container'"
op|':'
string|"'c'"
op|'}'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_puts'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assert_'
op|'('
name|'re'
op|'.'
name|'match'
op|'('
string|"'Unauth '"
op|','
nl|'\n'
name|'cs'
op|'.'
name|'logger'
op|'.'
name|'log_dict'
op|'['
string|"'info'"
op|']'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_put_object
name|'def'
name|'fake_put_object'
op|'('
name|'sync_to'
op|','
name|'name'
op|'='
name|'None'
op|','
name|'headers'
op|'='
name|'None'
op|','
nl|'\n'
name|'contents'
op|'='
name|'None'
op|','
name|'proxy'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'ClientException'
op|'('
string|"'test client exception'"
op|','
name|'http_status'
op|'='
number|'404'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'put_object'
op|'='
name|'fake_put_object'
newline|'\n'
comment|'# Fail due to 404'
nl|'\n'
name|'cs'
op|'.'
name|'logger'
op|'='
name|'FakeLogger'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
string|"'1.2'"
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
op|'{'
nl|'\n'
string|"'account'"
op|':'
string|"'a'"
op|','
nl|'\n'
string|"'container'"
op|':'
string|"'c'"
op|'}'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_puts'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assert_'
op|'('
name|'re'
op|'.'
name|'match'
op|'('
string|"'Not found '"
op|','
nl|'\n'
name|'cs'
op|'.'
name|'logger'
op|'.'
name|'log_dict'
op|'['
string|"'info'"
op|']'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_put_object
name|'def'
name|'fake_put_object'
op|'('
name|'sync_to'
op|','
name|'name'
op|'='
name|'None'
op|','
name|'headers'
op|'='
name|'None'
op|','
nl|'\n'
name|'contents'
op|'='
name|'None'
op|','
name|'proxy'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'ClientException'
op|'('
string|"'test client exception'"
op|','
name|'http_status'
op|'='
number|'503'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'put_object'
op|'='
name|'fake_put_object'
newline|'\n'
comment|'# Fail due to 503'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
string|"'1.2'"
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
op|'{'
nl|'\n'
string|"'account'"
op|':'
string|"'a'"
op|','
nl|'\n'
string|"'container'"
op|':'
string|"'c'"
op|'}'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'cs'
op|'.'
name|'container_puts'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
nl|'\n'
name|'cs'
op|'.'
name|'logger'
op|'.'
name|'log_dict'
op|'['
string|"'exception'"
op|']'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|'.'
name|'startswith'
op|'('
nl|'\n'
string|"'ERROR Syncing '"
op|')'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'shuffle'
op|'='
name|'orig_shuffle'
newline|'\n'
name|'sync'
op|'.'
name|'put_object'
op|'='
name|'orig_put_object'
newline|'\n'
name|'sync'
op|'.'
name|'direct_get_object'
op|'='
name|'orig_direct_get_object'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
name|'if'
name|'__name__'
op|'=='
string|"'__main__'"
op|':'
newline|'\n'
indent|'    '
name|'unittest'
op|'.'
name|'main'
op|'('
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit

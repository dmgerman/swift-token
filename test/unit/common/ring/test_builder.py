begin_unit
comment|'# Copyright (c) 2010-2012 OpenStack Foundation'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'copy'
newline|'\n'
name|'import'
name|'errno'
newline|'\n'
name|'import'
name|'mock'
newline|'\n'
name|'import'
name|'operator'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'unittest'
newline|'\n'
name|'import'
name|'six'
op|'.'
name|'moves'
op|'.'
name|'cPickle'
name|'as'
name|'pickle'
newline|'\n'
name|'from'
name|'array'
name|'import'
name|'array'
newline|'\n'
name|'from'
name|'collections'
name|'import'
name|'defaultdict'
newline|'\n'
name|'from'
name|'math'
name|'import'
name|'ceil'
newline|'\n'
name|'from'
name|'tempfile'
name|'import'
name|'mkdtemp'
newline|'\n'
name|'from'
name|'shutil'
name|'import'
name|'rmtree'
newline|'\n'
name|'import'
name|'warnings'
newline|'\n'
nl|'\n'
name|'from'
name|'six'
op|'.'
name|'moves'
name|'import'
name|'range'
newline|'\n'
nl|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'exceptions'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'ring'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'ring'
op|'.'
name|'builder'
name|'import'
name|'MAX_BALANCE'
op|','
name|'RingValidationWarning'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|TestRingBuilder
name|'class'
name|'TestRingBuilder'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'testdir'
op|'='
name|'mkdtemp'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|tearDown
dedent|''
name|'def'
name|'tearDown'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rmtree'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'ignore_errors'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_partition_counts
dedent|''
name|'def'
name|'_partition_counts'
op|'('
name|'self'
op|','
name|'builder'
op|','
name|'key'
op|'='
string|"'id'"
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Returns a dictionary mapping the given device key to (number of\n        partitions assigned to to that key).\n        """'
newline|'\n'
name|'counts'
op|'='
name|'defaultdict'
op|'('
name|'int'
op|')'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'builder'
op|'.'
name|'_replica2part2dev'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'builder'
op|'.'
name|'devs'
op|'['
name|'dev_id'
op|']'
op|'['
name|'key'
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'counts'
newline|'\n'
nl|'\n'
DECL|member|_get_population_by_region
dedent|''
name|'def'
name|'_get_population_by_region'
op|'('
name|'self'
op|','
name|'builder'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Returns a dictionary mapping region to number of partitions in that\n        region.\n        """'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'builder'
op|','
name|'key'
op|'='
string|"'region'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_init
dedent|''
name|'def'
name|'test_init'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'part_power'
op|','
number|'8'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|','
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'min_part_hours'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'parts'
op|','
number|'2'
op|'**'
number|'8'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'devs'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'devs_changed'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'version'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_overlarge_part_powers
dedent|''
name|'def'
name|'test_overlarge_part_powers'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'32'
op|','
number|'3'
op|','
number|'1'
op|')'
comment|'# passes by not crashing'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'ring'
op|'.'
name|'RingBuilder'
op|','
number|'33'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_insufficient_replicas
dedent|''
name|'def'
name|'test_insufficient_replicas'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'1.0'
op|','
number|'1'
op|')'
comment|'# passes by not crashing'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'ring'
op|'.'
name|'RingBuilder'
op|','
number|'8'
op|','
number|'0.999'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_negative_min_part_hours
dedent|''
name|'def'
name|'test_negative_min_part_hours'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'0'
op|')'
comment|'# passes by not crashing'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'ring'
op|'.'
name|'RingBuilder'
op|','
number|'8'
op|','
number|'3'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_deepcopy
dedent|''
name|'def'
name|'test_deepcopy'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# more devices in zone #1'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb_copy'
op|'='
name|'copy'
op|'.'
name|'deepcopy'
op|'('
name|'rb'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'to_dict'
op|'('
op|')'
op|','
name|'rb_copy'
op|'.'
name|'to_dict'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'rb'
op|'.'
name|'devs'
name|'is'
name|'not'
name|'rb_copy'
op|'.'
name|'devs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'rb'
op|'.'
name|'_replica2part2dev'
name|'is'
name|'not'
name|'rb_copy'
op|'.'
name|'_replica2part2dev'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'rb'
op|'.'
name|'_last_part_moves'
name|'is'
name|'not'
name|'rb_copy'
op|'.'
name|'_last_part_moves'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'rb'
op|'.'
name|'_remove_devs'
name|'is'
name|'not'
name|'rb_copy'
op|'.'
name|'_remove_devs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'rb'
op|'.'
name|'_dispersion_graph'
name|'is'
name|'not'
name|'rb_copy'
op|'.'
name|'_dispersion_graph'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_ring
dedent|''
name|'def'
name|'test_get_ring'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'isinstance'
op|'('
name|'r'
op|','
name|'ring'
op|'.'
name|'RingData'
op|')'
op|')'
newline|'\n'
name|'r2'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'r'
name|'is'
name|'r2'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'r3'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'r3'
name|'is'
name|'not'
name|'r2'
op|')'
newline|'\n'
name|'r4'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'r3'
name|'is'
name|'r4'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebalance_with_seed
dedent|''
name|'def'
name|'test_rebalance_with_seed'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'devs'
op|'='
op|'['
op|'('
number|'0'
op|','
number|'10000'
op|')'
op|','
op|'('
number|'1'
op|','
number|'10001'
op|')'
op|','
op|'('
number|'2'
op|','
number|'10002'
op|')'
op|','
op|'('
number|'1'
op|','
number|'10003'
op|')'
op|']'
newline|'\n'
name|'ring_builders'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'n'
name|'in'
name|'range'
op|'('
number|'3'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'idx'
op|'='
number|'0'
newline|'\n'
name|'for'
name|'zone'
op|','
name|'port'
name|'in'
name|'devs'
op|':'
newline|'\n'
indent|'                '
name|'for'
name|'d'
name|'in'
op|'('
string|"'sda1'"
op|','
string|"'sdb1'"
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
name|'idx'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
name|'zone'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
name|'port'
op|','
nl|'\n'
string|"'device'"
op|':'
name|'d'
op|','
string|"'weight'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'idx'
op|'+='
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'ring_builders'
op|'.'
name|'append'
op|'('
name|'rb'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'rb0'
op|'='
name|'ring_builders'
op|'['
number|'0'
op|']'
newline|'\n'
name|'rb1'
op|'='
name|'ring_builders'
op|'['
number|'1'
op|']'
newline|'\n'
name|'rb2'
op|'='
name|'ring_builders'
op|'['
number|'2'
op|']'
newline|'\n'
nl|'\n'
name|'r0'
op|'='
name|'rb0'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'rb0'
op|'.'
name|'get_ring'
op|'('
op|')'
name|'is'
name|'r0'
op|')'
newline|'\n'
nl|'\n'
name|'rb0'
op|'.'
name|'rebalance'
op|'('
op|')'
comment|'# NO SEED'
newline|'\n'
name|'rb1'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'10'
op|')'
newline|'\n'
name|'rb2'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'10'
op|')'
newline|'\n'
nl|'\n'
name|'r1'
op|'='
name|'rb1'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'r2'
op|'='
name|'rb2'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'rb0'
op|'.'
name|'get_ring'
op|'('
op|')'
name|'is'
name|'r0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'r0'
op|'.'
name|'to_dict'
op|'('
op|')'
op|','
name|'r1'
op|'.'
name|'to_dict'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'r1'
op|'.'
name|'to_dict'
op|'('
op|')'
op|','
name|'r2'
op|'.'
name|'to_dict'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebalance_part_on_deleted_other_part_on_drained
dedent|''
name|'def'
name|'test_rebalance_part_on_deleted_other_part_on_drained'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10005'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
comment|'# We want a partition where 1 replica is on a removed device, 1'
nl|'\n'
comment|'# replica is on a 0-weight device, and 1 on a normal device. To'
nl|'\n'
comment|'# guarantee we have one, we see where partition 123 is, then'
nl|'\n'
comment|'# manipulate its devices accordingly.'
nl|'\n'
name|'zero_weight_dev_id'
op|'='
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'1'
op|']'
op|'['
number|'123'
op|']'
newline|'\n'
name|'delete_dev_id'
op|'='
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'2'
op|']'
op|'['
number|'123'
op|']'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
name|'zero_weight_dev_id'
op|','
number|'0.0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
name|'delete_dev_id'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_replicas
dedent|''
name|'def'
name|'test_set_replicas'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3.2'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'devs_changed'
op|'='
name|'False'
newline|'\n'
name|'rb'
op|'.'
name|'set_replicas'
op|'('
number|'3.25'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'rb'
op|'.'
name|'devs_changed'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'devs_changed'
op|'='
name|'False'
newline|'\n'
name|'rb'
op|'.'
name|'set_replicas'
op|'('
number|'3.2500001'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'rb'
op|'.'
name|'devs_changed'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_dev
dedent|''
name|'def'
name|'test_add_dev'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'dev'
op|'='
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|'}'
newline|'\n'
name|'dev_id'
op|'='
name|'rb'
op|'.'
name|'add_dev'
op|'('
name|'dev'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'DuplicateDeviceError'
op|','
name|'rb'
op|'.'
name|'add_dev'
op|','
name|'dev'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# test add new dev with no id'
nl|'\n'
name|'dev_id'
op|'='
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'zone'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'6000'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'devs'
op|'['
number|'0'
op|']'
op|'['
string|"'id'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
newline|'\n'
comment|'# test add another dev with no id'
nl|'\n'
name|'dev_id'
op|'='
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'zone'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'6000'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'devs'
op|'['
number|'1'
op|']'
op|'['
string|"'id'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev_id'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_dev_weight
dedent|''
name|'def'
name|'test_set_dev_weight'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'dev_id'
op|']'
op|'='
name|'counts'
op|'.'
name|'get'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'128'
op|','
number|'1'
op|':'
number|'128'
op|','
number|'2'
op|':'
number|'256'
op|','
number|'3'
op|':'
number|'256'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'0'
op|','
number|'0.75'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'1'
op|','
number|'0.25'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'dev_id'
op|']'
op|'='
name|'counts'
op|'.'
name|'get'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'192'
op|','
number|'1'
op|':'
number|'64'
op|','
number|'2'
op|':'
number|'256'
op|','
number|'3'
op|':'
number|'256'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_dev
dedent|''
name|'def'
name|'test_remove_dev'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'dev_id'
op|']'
op|'='
name|'counts'
op|'.'
name|'get'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'192'
op|','
number|'1'
op|':'
number|'192'
op|','
number|'2'
op|':'
number|'192'
op|','
number|'3'
op|':'
number|'192'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'dev_id'
op|']'
op|'='
name|'counts'
op|'.'
name|'get'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'256'
op|','
number|'2'
op|':'
number|'256'
op|','
number|'3'
op|':'
number|'256'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_a_lot
dedent|''
name|'def'
name|'test_remove_a_lot'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'3'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'device'"
op|':'
string|"'d0'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'device'"
op|':'
string|"'d1'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'device'"
op|':'
string|"'d2'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'device'"
op|':'
string|"'d3'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'device'"
op|':'
string|"'d4'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'device'"
op|':'
string|"'d5'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# this has to put more than 1/3 of the partitions in the'
nl|'\n'
comment|'# cluster on removed devices in order to ensure that at least'
nl|'\n'
comment|'# one partition has multiple replicas that need to move.'
nl|'\n'
comment|'#'
nl|'\n'
comment|"# (for an N-replica ring, it's more than 1/N of the"
nl|'\n'
comment|'# partitions, of course)'
nl|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'3'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'4'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'5'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_zero_weighted
dedent|''
name|'def'
name|'test_remove_zero_weighted'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'device'"
op|':'
string|"'d0'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'device'"
op|':'
string|"'d1'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'0.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'device'"
op|':'
string|"'d2'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'device'"
op|':'
string|"'d3'"
op|','
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6002'
op|','
string|"'weight'"
op|':'
number|'1000.0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'1'
op|')'
newline|'\n'
name|'parts'
op|','
name|'balance'
op|','
name|'removed'
op|'='
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'removed'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_shuffled_gather
dedent|''
name|'def'
name|'test_shuffled_gather'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'_shuffled_gather_helper'
op|'('
op|')'
name|'and'
name|'self'
op|'.'
name|'_shuffled_gather_helper'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
string|"'It is highly likely the ring is no '"
nl|'\n'
string|"'longer shuffling the set of partitions '"
nl|'\n'
string|"'to reassign on a rebalance.'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|_shuffled_gather_helper
dedent|''
dedent|''
name|'def'
name|'_shuffled_gather_helper'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'parts'
op|'='
name|'rb'
op|'.'
name|'_gather_reassign_parts'
op|'('
op|')'
newline|'\n'
name|'max_run'
op|'='
number|'0'
newline|'\n'
name|'run'
op|'='
number|'0'
newline|'\n'
name|'last_part'
op|'='
number|'0'
newline|'\n'
name|'for'
name|'part'
op|','
name|'_'
name|'in'
name|'parts'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'part'
op|'>'
name|'last_part'
op|':'
newline|'\n'
indent|'                '
name|'run'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'run'
op|'>'
name|'max_run'
op|':'
newline|'\n'
indent|'                    '
name|'max_run'
op|'='
name|'run'
newline|'\n'
dedent|''
name|'run'
op|'='
number|'0'
newline|'\n'
dedent|''
name|'last_part'
op|'='
name|'part'
newline|'\n'
dedent|''
name|'if'
name|'run'
op|'>'
name|'max_run'
op|':'
newline|'\n'
indent|'            '
name|'max_run'
op|'='
name|'run'
newline|'\n'
dedent|''
name|'return'
name|'max_run'
op|'>'
name|'len'
op|'('
name|'parts'
op|')'
op|'/'
number|'2'
newline|'\n'
nl|'\n'
DECL|member|test_initial_balance
dedent|''
name|'def'
name|'test_initial_balance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# 2 boxes, 2 drives each in zone 1'
nl|'\n'
comment|'# 1 box, 2 drives in zone 2'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# This is balanceable, but there used to be some nondeterminism in'
nl|'\n'
comment|'# rebalance() that would sometimes give you an imbalanced ring.'
nl|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'4000.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'4000.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'4000.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'4000.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'4000.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'4000.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'_'
op|','
name|'balance'
op|','
name|'_'
op|'='
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
nl|'\n'
comment|'# maybe not *perfect*, but should be close'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'balance'
op|'<='
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multitier_partial
dedent|''
name|'def'
name|'test_multitier_partial'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Multitier test, nothing full'
nl|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'2'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'3'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'counts'
op|'='
name|'defaultdict'
op|'('
name|'lambda'
op|':'
name|'defaultdict'
op|'('
name|'int'
op|')'
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'='
name|'rb'
op|'.'
name|'devs'
op|'['
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|']'
newline|'\n'
name|'counts'
op|'['
string|"'region'"
op|']'
op|'['
name|'dev'
op|'['
string|"'region'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'['
name|'dev'
op|'['
string|"'zone'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'any'
op|'('
name|'c'
op|'>'
number|'1'
name|'for'
name|'c'
name|'in'
name|'counts'
op|'['
string|"'region'"
op|']'
op|'.'
name|'values'
op|'('
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d not evenly region-distributed (got %r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'counts'
op|'['
string|"'region'"
op|']'
op|')'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'any'
op|'('
name|'c'
op|'>'
number|'1'
name|'for'
name|'c'
name|'in'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'.'
name|'values'
op|'('
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d not evenly zone-distributed (got %r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'counts'
op|'['
string|"'zone'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# Multitier test, zones full, nodes not full'
nl|'\n'
dedent|''
dedent|''
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'6'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdg'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdh'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdi'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'counts'
op|'='
name|'defaultdict'
op|'('
name|'lambda'
op|':'
name|'defaultdict'
op|'('
name|'int'
op|')'
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'='
name|'rb'
op|'.'
name|'devs'
op|'['
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|']'
newline|'\n'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'['
name|'dev'
op|'['
string|"'zone'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'['
name|'dev'
op|'['
string|"'id'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'if'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'!='
op|'{'
number|'0'
op|':'
number|'2'
op|','
number|'1'
op|':'
number|'2'
op|','
number|'2'
op|':'
number|'2'
op|'}'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d not evenly distributed (got %r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'counts'
op|'['
string|"'zone'"
op|']'
op|')'
op|')'
newline|'\n'
dedent|''
name|'for'
name|'dev_id'
op|','
name|'replica_count'
name|'in'
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'replica_count'
op|'>'
number|'1'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d is on device %d more than once (%r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'dev_id'
op|','
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multitier_full
dedent|''
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_multitier_full'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Multitier test, #replicas == #devs'
nl|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'6'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'counts'
op|'='
name|'defaultdict'
op|'('
name|'lambda'
op|':'
name|'defaultdict'
op|'('
name|'int'
op|')'
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'='
name|'rb'
op|'.'
name|'devs'
op|'['
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|']'
newline|'\n'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'['
name|'dev'
op|'['
string|"'zone'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'['
name|'dev'
op|'['
string|"'id'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'if'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'!='
op|'{'
number|'0'
op|':'
number|'2'
op|','
number|'1'
op|':'
number|'2'
op|','
number|'2'
op|':'
number|'2'
op|'}'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d not evenly distributed (got %r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'counts'
op|'['
string|"'zone'"
op|']'
op|')'
op|')'
newline|'\n'
dedent|''
name|'for'
name|'dev_id'
op|','
name|'replica_count'
name|'in'
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'replica_count'
op|'!='
number|'1'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d is on device %d %d times, not 1 (%r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'dev_id'
op|','
name|'replica_count'
op|','
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multitier_overfull
dedent|''
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_multitier_overfull'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Multitier test, #replicas > #zones (to prove even distribution)'
nl|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'8'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdg'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdh'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdi'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'counts'
op|'='
name|'defaultdict'
op|'('
name|'lambda'
op|':'
name|'defaultdict'
op|'('
name|'int'
op|')'
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'='
name|'rb'
op|'.'
name|'devs'
op|'['
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|']'
newline|'\n'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'['
name|'dev'
op|'['
string|"'zone'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'['
name|'dev'
op|'['
string|"'id'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'8'
op|','
name|'sum'
op|'('
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'.'
name|'values'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'for'
name|'zone'
op|','
name|'replica_count'
name|'in'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'replica_count'
name|'not'
name|'in'
op|'('
number|'2'
op|','
number|'3'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d not evenly distributed (got %r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'counts'
op|'['
string|"'zone'"
op|']'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'for'
name|'dev_id'
op|','
name|'replica_count'
name|'in'
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'replica_count'
name|'not'
name|'in'
op|'('
number|'1'
op|','
number|'2'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d is on device %d %d times, "'
nl|'\n'
string|'"not 1 or 2 (%r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'dev_id'
op|','
name|'replica_count'
op|','
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multitier_expansion_more_devices
dedent|''
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_multitier_expansion_more_devices'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'6'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'10'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'11'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'_'
name|'in'
name|'range'
op|'('
number|'5'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'counts'
op|'='
name|'dict'
op|'('
name|'zone'
op|'='
name|'defaultdict'
op|'('
name|'int'
op|')'
op|','
nl|'\n'
name|'dev_id'
op|'='
name|'defaultdict'
op|'('
name|'int'
op|')'
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'='
name|'rb'
op|'.'
name|'devs'
op|'['
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|']'
newline|'\n'
name|'counts'
op|'['
string|"'zone'"
op|']'
op|'['
name|'dev'
op|'['
string|"'zone'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'['
name|'dev'
op|'['
string|"'id'"
op|']'
op|']'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'{'
number|'0'
op|':'
number|'2'
op|','
number|'1'
op|':'
number|'2'
op|','
number|'2'
op|':'
number|'2'
op|'}'
op|','
name|'dict'
op|'('
name|'counts'
op|'['
string|"'zone'"
op|']'
op|')'
op|')'
newline|'\n'
comment|'# each part is assigned once to six unique devices'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'('
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'.'
name|'values'
op|'('
op|')'
op|')'
op|','
op|'['
number|'1'
op|']'
op|'*'
number|'6'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'set'
op|'('
name|'counts'
op|'['
string|"'dev_id'"
op|']'
op|'.'
name|'keys'
op|'('
op|')'
op|')'
op|')'
op|','
number|'6'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multitier_part_moves_with_0_min_part_hours
dedent|''
dedent|''
name|'def'
name|'test_multitier_part_moves_with_0_min_part_hours'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|"# min_part_hours is 0, so we're clear to move 2 replicas to"
nl|'\n'
comment|'# new devs'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'devs'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'devs'
op|'.'
name|'add'
op|'('
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'devs'
op|')'
op|'!='
number|'3'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d not on 3 devs (got %r)"'
op|'%'
op|'('
name|'part'
op|','
name|'devs'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multitier_part_moves_with_positive_min_part_hours
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_multitier_part_moves_with_positive_min_part_hours'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'99'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|"# min_part_hours is >0, so we'll only be able to move 1"
nl|'\n'
comment|'# replica to a new home'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'devs'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'devs'
op|'.'
name|'add'
op|'('
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'any'
op|'('
name|'rb'
op|'.'
name|'devs'
op|'['
name|'dev_id'
op|']'
op|'['
string|"'zone'"
op|']'
op|'=='
number|'1'
name|'for'
name|'dev_id'
name|'in'
name|'devs'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d did not move (got %r)"'
op|'%'
op|'('
name|'part'
op|','
name|'devs'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multitier_dont_move_too_many_replicas
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_multitier_dont_move_too_many_replicas'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'0'
op|')'
newline|'\n'
comment|"# there'll be at least one replica in z0 and z1"
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# only 1 replica should move'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'4'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdf1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'zones'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'zones'
op|'.'
name|'add'
op|'('
name|'rb'
op|'.'
name|'devs'
op|'['
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
op|']'
op|'['
string|"'zone'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'zones'
op|')'
op|'!='
number|'3'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d not in 3 zones (got %r)"'
op|'%'
op|'('
name|'part'
op|','
name|'zones'
op|')'
op|')'
newline|'\n'
dedent|''
name|'if'
number|'0'
name|'not'
name|'in'
name|'zones'
name|'or'
number|'1'
name|'not'
name|'in'
name|'zones'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'AssertionError'
op|'('
nl|'\n'
string|'"Partition %d not in zones 0 and 1 (got %r)"'
op|'%'
nl|'\n'
op|'('
name|'part'
op|','
name|'zones'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rerebalance
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_rerebalance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'dev_id'
op|']'
op|'='
name|'counts'
op|'.'
name|'get'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'256'
op|','
number|'1'
op|':'
number|'256'
op|','
number|'2'
op|':'
number|'256'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'dev_id'
op|']'
op|'='
name|'counts'
op|'.'
name|'get'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'192'
op|','
number|'1'
op|':'
number|'192'
op|','
number|'2'
op|':'
number|'192'
op|','
number|'3'
op|':'
number|'192'
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'3'
op|','
number|'100'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'dev_id'
op|']'
op|'='
name|'counts'
op|'.'
name|'get'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|'['
number|'3'
op|']'
op|','
number|'256'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_rebalance_add_rebalance_delete_rebalance
dedent|''
name|'def'
name|'test_add_rebalance_add_rebalance_delete_rebalance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test for https://bugs.launchpad.net/swift/+bug/845952'
nl|'\n'
comment|'# min_part of 0 to allow for rapid rebalancing'
nl|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10005'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'1'
op|')'
newline|'\n'
nl|'\n'
comment|'# well now we have only one device in z0'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.5'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_last_partition_from_zero_weight
dedent|''
name|'def'
name|'test_remove_last_partition_from_zero_weight'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'4'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'zero'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'zero_weight_dev'
op|'='
number|'3'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# We want at least one partition with replicas only in zone 2 and 3'
nl|'\n'
comment|'# due to device weights. It would *like* to spread out into zone 1,'
nl|'\n'
comment|"# but can't, due to device weight."
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Also, we want such a partition to have a replica on device 3,'
nl|'\n'
comment|'# which we will then reduce to zero weight. This should cause the'
nl|'\n'
comment|'# removal of the replica from device 3.'
nl|'\n'
comment|'#'
nl|'\n'
comment|"# Getting this to happen by chance is hard, so let's just set up a"
nl|'\n'
comment|"# builder so that it's in the state we want. This is a synthetic"
nl|'\n'
comment|'# example; while the bug has happened on a real cluster, that'
nl|'\n'
comment|'# builder file had a part_power of 16, so its contents are much too'
nl|'\n'
comment|'# big to include here.'
nl|'\n'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'='
op|'['
nl|'\n'
comment|'#                            these are the relevant ones'
nl|'\n'
comment|'#                                   |  |  |'
nl|'\n'
comment|'#                                   v  v  v'
nl|'\n'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'2'
op|','
number|'5'
op|','
number|'6'
op|','
number|'2'
op|','
number|'5'
op|','
number|'6'
op|','
number|'2'
op|','
number|'5'
op|','
number|'6'
op|','
number|'2'
op|','
number|'5'
op|','
number|'6'
op|','
number|'2'
op|','
number|'5'
op|','
number|'6'
op|','
number|'2'
op|']'
op|')'
op|','
nl|'\n'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'1'
op|','
number|'4'
op|','
number|'1'
op|','
number|'4'
op|','
number|'1'
op|','
number|'4'
op|','
number|'1'
op|','
number|'4'
op|','
number|'1'
op|','
number|'4'
op|','
number|'1'
op|','
number|'4'
op|','
number|'1'
op|','
number|'4'
op|','
number|'1'
op|','
number|'4'
op|']'
op|')'
op|','
nl|'\n'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'3'
op|','
number|'3'
op|','
number|'3'
op|','
number|'5'
op|','
number|'6'
op|','
number|'2'
op|','
number|'5'
op|','
number|'6'
op|']'
op|')'
op|']'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
name|'zero_weight_dev'
op|','
number|'0.0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'node_counts'
op|'='
name|'defaultdict'
op|'('
name|'int'
op|')'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'node_counts'
op|'['
name|'dev_id'
op|']'
op|'+='
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'node_counts'
op|'['
name|'zero_weight_dev'
op|']'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|"# it's as balanced as it gets, so nothing moves anymore"
nl|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'parts_moved'
op|','
name|'_balance'
op|','
name|'_removed'
op|'='
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'parts_moved'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_region_fullness_with_balanceable_ring
dedent|''
name|'def'
name|'test_region_fullness_with_balanceable_ring'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'2'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10005'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'2'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10006'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'3'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10007'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'3'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10008'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
nl|'\n'
name|'population_by_region'
op|'='
name|'self'
op|'.'
name|'_get_population_by_region'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'population_by_region'
op|','
nl|'\n'
op|'{'
number|'0'
op|':'
number|'192'
op|','
number|'1'
op|':'
number|'192'
op|','
number|'2'
op|':'
number|'192'
op|','
number|'3'
op|':'
number|'192'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_region_fullness_with_unbalanceable_ring
dedent|''
name|'def'
name|'test_region_fullness_with_unbalanceable_ring'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
nl|'\n'
name|'population_by_region'
op|'='
name|'self'
op|'.'
name|'_get_population_by_region'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'population_by_region'
op|','
op|'{'
number|'0'
op|':'
number|'512'
op|','
number|'1'
op|':'
number|'256'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_adding_region_slowly_with_unbalanceable_ring
dedent|''
name|'def'
name|'test_adding_region_slowly_with_unbalanceable_ring'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.5'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0.25'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'0.25'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'changed_parts'
op|','
name|'_balance'
op|','
name|'_removed'
op|'='
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
nl|'\n'
comment|"# there's not enough room in r1 for every partition to have a replica"
nl|'\n'
comment|"# in it, so only 86 assignments occur in r1 (that's ~1/5 of the total,"
nl|'\n'
comment|'# since r1 has 1/5 of the weight).'
nl|'\n'
name|'population_by_region'
op|'='
name|'self'
op|'.'
name|'_get_population_by_region'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'population_by_region'
op|','
op|'{'
number|'0'
op|':'
number|'682'
op|','
number|'1'
op|':'
number|'86'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# only 86 parts *should* move (to the new region) but randomly some'
nl|'\n'
comment|'# parts will flop around devices in the original region too'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'90'
op|','
name|'changed_parts'
op|')'
newline|'\n'
nl|'\n'
comment|"# and since there's not enough room, subsequent rebalances will not"
nl|'\n'
comment|'# cause additional assignments to r1'
nl|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
name|'population_by_region'
op|'='
name|'self'
op|'.'
name|'_get_population_by_region'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'population_by_region'
op|','
op|'{'
number|'0'
op|':'
number|'682'
op|','
number|'1'
op|':'
number|'86'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# after you add more weight, more partition assignments move'
nl|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'2'
op|','
number|'0.5'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'3'
op|','
number|'0.5'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
name|'population_by_region'
op|'='
name|'self'
op|'.'
name|'_get_population_by_region'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'population_by_region'
op|','
op|'{'
number|'0'
op|':'
number|'614'
op|','
number|'1'
op|':'
number|'154'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'2'
op|','
number|'1.0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'3'
op|','
number|'1.0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
name|'population_by_region'
op|'='
name|'self'
op|'.'
name|'_get_population_by_region'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'population_by_region'
op|','
op|'{'
number|'0'
op|':'
number|'512'
op|','
number|'1'
op|':'
number|'256'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_avoid_tier_change_new_region
dedent|''
name|'def'
name|'test_avoid_tier_change_new_region'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
number|'5'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
name|'i'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
name|'i'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
nl|'\n'
comment|'# Add a new device in new region to a balanced ring'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.5'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# Increase the weight of region 1 slowly'
nl|'\n'
name|'moved_partitions'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'weight'
name|'in'
name|'range'
op|'('
number|'0'
op|','
number|'101'
op|','
number|'10'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'5'
op|','
name|'weight'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'changed_parts'
op|','
name|'_balance'
op|','
name|'_removed'
op|'='
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
name|'moved_partitions'
op|'.'
name|'append'
op|'('
name|'changed_parts'
op|')'
newline|'\n'
comment|'# Ensure that the second region has enough partitions'
nl|'\n'
comment|'# Otherwise there will be replicas at risk'
nl|'\n'
name|'min_parts_for_r1'
op|'='
name|'ceil'
op|'('
name|'weight'
op|'/'
op|'('
number|'500.0'
op|'+'
name|'weight'
op|')'
op|'*'
number|'768'
op|')'
newline|'\n'
name|'parts_for_r1'
op|'='
name|'self'
op|'.'
name|'_get_population_by_region'
op|'('
name|'rb'
op|')'
op|'.'
name|'get'
op|'('
number|'1'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'min_parts_for_r1'
op|','
name|'parts_for_r1'
op|')'
newline|'\n'
nl|'\n'
comment|'# Number of partitions moved on each rebalance'
nl|'\n'
comment|'# 10/510 * 768 ~ 15.06 -> move at least 15 partitions in first step'
nl|'\n'
dedent|''
name|'ref'
op|'='
op|'['
number|'0'
op|','
number|'17'
op|','
number|'16'
op|','
number|'17'
op|','
number|'13'
op|','
number|'15'
op|','
number|'13'
op|','
number|'12'
op|','
number|'11'
op|','
number|'13'
op|','
number|'13'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'ref'
op|','
name|'moved_partitions'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_replicas_increase
dedent|''
name|'def'
name|'test_set_replicas_increase'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'2'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'replicas'
op|'='
number|'2.1'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'len'
op|'('
name|'p2d'
op|')'
name|'for'
name|'p2d'
name|'in'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|']'
op|','
nl|'\n'
op|'['
number|'256'
op|','
number|'256'
op|','
number|'25'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'replicas'
op|'='
number|'2.2'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'len'
op|'('
name|'p2d'
op|')'
name|'for'
name|'p2d'
name|'in'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|']'
op|','
nl|'\n'
op|'['
number|'256'
op|','
number|'256'
op|','
number|'51'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_replicas_decrease
dedent|''
name|'def'
name|'test_set_replicas_decrease'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'4'
op|','
number|'5'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'replicas'
op|'='
number|'4.9'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'len'
op|'('
name|'p2d'
op|')'
name|'for'
name|'p2d'
name|'in'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|']'
op|','
nl|'\n'
op|'['
number|'16'
op|','
number|'16'
op|','
number|'16'
op|','
number|'16'
op|','
number|'14'
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# cross a couple of integer thresholds (4 and 3)'
nl|'\n'
name|'rb'
op|'.'
name|'replicas'
op|'='
number|'2.5'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'len'
op|'('
name|'p2d'
op|')'
name|'for'
name|'p2d'
name|'in'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|']'
op|','
nl|'\n'
op|'['
number|'16'
op|','
number|'16'
op|','
number|'8'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_fractional_replicas_rebalance
dedent|''
name|'def'
name|'test_fractional_replicas_rebalance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'2.5'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
comment|'# passes by not crashing'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
comment|'# also passes by not crashing'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'len'
op|'('
name|'p2d'
op|')'
name|'for'
name|'p2d'
name|'in'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|']'
op|','
nl|'\n'
op|'['
number|'256'
op|','
number|'256'
op|','
number|'128'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_add_dev_add_replica_rebalance
dedent|''
name|'def'
name|'test_create_add_dev_add_replica_rebalance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_replicas'
op|'('
number|'4'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
comment|'# this would crash since parts_wanted was not set'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebalance_post_upgrade
dedent|''
name|'def'
name|'test_rebalance_post_upgrade'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# 5 devices: 5 is the smallest number that does not divide 3 * 2^8,'
nl|'\n'
comment|'# which forces some rounding to happen.'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# Older versions of the ring builder code would round down when'
nl|'\n'
comment|'# computing parts_wanted, while the new code rounds up. Make sure we'
nl|'\n'
comment|'# can handle a ring built by the old method.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# This code mimics the old _set_parts_wanted.'
nl|'\n'
name|'weight_of_one_part'
op|'='
name|'rb'
op|'.'
name|'weight_of_one_part'
op|'('
op|')'
newline|'\n'
name|'for'
name|'dev'
name|'in'
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'dev'
op|'['
string|"'weight'"
op|']'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'['
string|"'parts_wanted'"
op|']'
op|'='
op|'-'
name|'rb'
op|'.'
name|'parts'
op|'*'
name|'rb'
op|'.'
name|'replicas'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'['
string|"'parts_wanted'"
op|']'
op|'='
op|'('
nl|'\n'
name|'int'
op|'('
name|'weight_of_one_part'
op|'*'
name|'dev'
op|'['
string|"'weight'"
op|']'
op|')'
op|'-'
nl|'\n'
name|'dev'
op|'['
string|"'parts'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
comment|'# this crashes unless rebalance resets parts_wanted'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_replicas_then_rebalance_respects_weight
dedent|''
name|'def'
name|'test_add_replicas_then_rebalance_respects_weight'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdg'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdh'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdi'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdj'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'10'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdk'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'11'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdl'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'dev_id'
op|']'
op|'='
name|'counts'
op|'.'
name|'get'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'96'
op|','
number|'1'
op|':'
number|'96'
op|','
nl|'\n'
number|'2'
op|':'
number|'32'
op|','
number|'3'
op|':'
number|'32'
op|','
nl|'\n'
number|'4'
op|':'
number|'96'
op|','
number|'5'
op|':'
number|'96'
op|','
nl|'\n'
number|'6'
op|':'
number|'32'
op|','
number|'7'
op|':'
number|'32'
op|','
nl|'\n'
number|'8'
op|':'
number|'96'
op|','
number|'9'
op|':'
number|'96'
op|','
nl|'\n'
number|'10'
op|':'
number|'32'
op|','
number|'11'
op|':'
number|'32'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'replicas'
op|'*='
number|'2'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'r'
op|'='
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'part2dev_id'
name|'in'
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'dev_id'
name|'in'
name|'part2dev_id'
op|':'
newline|'\n'
indent|'                '
name|'counts'
op|'['
name|'dev_id'
op|']'
op|'='
name|'counts'
op|'.'
name|'get'
op|'('
name|'dev_id'
op|','
number|'0'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'192'
op|','
number|'1'
op|':'
number|'192'
op|','
nl|'\n'
number|'2'
op|':'
number|'64'
op|','
number|'3'
op|':'
number|'64'
op|','
nl|'\n'
number|'4'
op|':'
number|'192'
op|','
number|'5'
op|':'
number|'192'
op|','
nl|'\n'
number|'6'
op|':'
number|'64'
op|','
number|'7'
op|':'
number|'64'
op|','
nl|'\n'
number|'8'
op|':'
number|'192'
op|','
number|'9'
op|':'
number|'192'
op|','
nl|'\n'
number|'10'
op|':'
number|'64'
op|','
number|'11'
op|':'
number|'64'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_overload
dedent|''
name|'def'
name|'test_overload'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdg'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdh'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdi'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdj'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'10'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdk'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'11'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdl'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# sanity check: balance respects weights, so default'
nl|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'zone'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'0'
op|']'
op|','
number|'192'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'1'
op|']'
op|','
number|'192'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'2'
op|']'
op|','
number|'384'
op|')'
newline|'\n'
nl|'\n'
comment|'# Devices 0 and 1 take 10% more than their fair shares by weight since'
nl|'\n'
comment|'# overload is 10% (0.1).'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.1'
op|')'
newline|'\n'
name|'for'
name|'_'
name|'in'
name|'range'
op|'('
number|'2'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'zone'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'0'
op|']'
op|','
number|'212'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'1'
op|']'
op|','
number|'212'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'2'
op|']'
op|','
number|'344'
op|')'
newline|'\n'
nl|'\n'
comment|'# Now, devices 0 and 1 take 50% more than their fair shares by'
nl|'\n'
comment|'# weight.'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.5'
op|')'
newline|'\n'
name|'for'
name|'_'
name|'in'
name|'range'
op|'('
number|'3'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'zone'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'0'
op|']'
op|','
number|'256'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'1'
op|']'
op|','
number|'256'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'2'
op|']'
op|','
number|'256'
op|')'
newline|'\n'
nl|'\n'
comment|'# Devices 0 and 1 may take up to 75% over their fair share, but the'
nl|'\n'
comment|'# placement algorithm only wants to spread things out evenly between'
nl|'\n'
comment|'# all drives, so the devices stay at 50% more.'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.75'
op|')'
newline|'\n'
name|'for'
name|'_'
name|'in'
name|'range'
op|'('
number|'3'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'zone'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'0'
op|']'
op|','
number|'256'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'1'
op|']'
op|','
number|'256'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
number|'2'
op|']'
op|','
number|'256'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_unoverload
dedent|''
name|'def'
name|'test_unoverload'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Start off needing overload to balance, then add capacity until we'
nl|'\n'
comment|"# don't need overload any more and see that things still balance."
nl|'\n'
comment|"# Overload doesn't prevent optimal balancing."
nl|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.125'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'10'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'11'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
nl|'\n'
comment|'# sanity check: our overload is big enough to balance things'
nl|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'ip'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.1'"
op|']'
op|','
number|'216'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.2'"
op|']'
op|','
number|'216'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.3'"
op|']'
op|','
number|'336'
op|')'
newline|'\n'
nl|'\n'
comment|'# Add some weight: balance improves'
nl|'\n'
name|'for'
name|'dev'
name|'in'
name|'rb'
op|'.'
name|'devs'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'dev'
op|'['
string|"'ip'"
op|']'
name|'in'
op|'('
string|"'127.0.0.1'"
op|','
string|"'127.0.0.2'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
name|'dev'
op|'['
string|"'id'"
op|']'
op|','
number|'1.5'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
nl|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'ip'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.1'"
op|']'
op|','
number|'236'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.2'"
op|']'
op|','
number|'236'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.3'"
op|']'
op|','
number|'296'
op|')'
newline|'\n'
nl|'\n'
comment|'# Even out the weights: balance becomes perfect'
nl|'\n'
name|'for'
name|'dev'
name|'in'
name|'rb'
op|'.'
name|'devs'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'dev'
op|'['
string|"'ip'"
op|']'
name|'in'
op|'('
string|"'127.0.0.1'"
op|','
string|"'127.0.0.2'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
name|'dev'
op|'['
string|"'id'"
op|']'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
nl|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'ip'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.1'"
op|']'
op|','
number|'256'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.2'"
op|']'
op|','
number|'256'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.3'"
op|']'
op|','
number|'256'
op|')'
newline|'\n'
nl|'\n'
comment|'# Add a new server: balance stays optimal'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'12'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'13'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sde'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'14'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'15'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdf'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|"# we're moving more than 1/3 of the replicas but fewer than 2/3, so"
nl|'\n'
comment|'# we have to do this twice'
nl|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
nl|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'ip'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.1'"
op|']'
op|','
number|'192'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.2'"
op|']'
op|','
number|'192'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.3'"
op|']'
op|','
number|'192'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|'['
string|"'127.0.0.4'"
op|']'
op|','
number|'192'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_overload_keeps_balanceable_things_balanced_initially
dedent|''
name|'def'
name|'test_overload_keeps_balanceable_things_balanced_initially'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'8'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'8'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.5'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.5'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'99999'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'12345'
op|')'
newline|'\n'
nl|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|','
op|'{'
nl|'\n'
number|'0'
op|':'
number|'128'
op|','
nl|'\n'
number|'1'
op|':'
number|'128'
op|','
nl|'\n'
number|'2'
op|':'
number|'64'
op|','
nl|'\n'
number|'3'
op|':'
number|'64'
op|','
nl|'\n'
number|'4'
op|':'
number|'64'
op|','
nl|'\n'
number|'5'
op|':'
number|'64'
op|','
nl|'\n'
number|'6'
op|':'
number|'64'
op|','
nl|'\n'
number|'7'
op|':'
number|'64'
op|','
nl|'\n'
number|'8'
op|':'
number|'64'
op|','
nl|'\n'
number|'9'
op|':'
number|'64'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_overload_keeps_balanceable_things_balanced_on_rebalance
dedent|''
name|'def'
name|'test_overload_keeps_balanceable_things_balanced_on_rebalance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'8'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'8'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.5'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.5'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'99999'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'123'
op|')'
newline|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|','
op|'{'
nl|'\n'
number|'0'
op|':'
number|'128'
op|','
nl|'\n'
number|'1'
op|':'
number|'128'
op|','
nl|'\n'
number|'2'
op|':'
number|'64'
op|','
nl|'\n'
number|'3'
op|':'
number|'64'
op|','
nl|'\n'
number|'4'
op|':'
number|'64'
op|','
nl|'\n'
number|'5'
op|':'
number|'64'
op|','
nl|'\n'
number|'6'
op|':'
number|'64'
op|','
nl|'\n'
number|'7'
op|':'
number|'64'
op|','
nl|'\n'
number|'8'
op|':'
number|'64'
op|','
nl|'\n'
number|'9'
op|':'
number|'64'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# swap weights between 10.0.0.1 and 10.0.0.2'
nl|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'0'
op|','
number|'4'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'1'
op|','
number|'4'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'2'
op|','
number|'8'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'1'
op|','
number|'8'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'456'
op|')'
newline|'\n'
name|'part_counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_counts'
op|','
op|'{'
nl|'\n'
number|'0'
op|':'
number|'128'
op|','
nl|'\n'
number|'1'
op|':'
number|'128'
op|','
nl|'\n'
number|'2'
op|':'
number|'64'
op|','
nl|'\n'
number|'3'
op|':'
number|'64'
op|','
nl|'\n'
number|'4'
op|':'
number|'64'
op|','
nl|'\n'
number|'5'
op|':'
number|'64'
op|','
nl|'\n'
number|'6'
op|':'
number|'64'
op|','
nl|'\n'
number|'7'
op|':'
number|'64'
op|','
nl|'\n'
number|'8'
op|':'
number|'64'
op|','
nl|'\n'
number|'9'
op|':'
number|'64'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_server_per_port
dedent|''
name|'def'
name|'test_server_per_port'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# 3 servers, 3 disks each, with each disk on its own port'
nl|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdx'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdy'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdx'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdy'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdx'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdy'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdz'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdz'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdz'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'poorly_dispersed'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'parts'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'on_nodes'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'replica'
name|'in'
name|'range'
op|'('
name|'rb'
op|'.'
name|'replicas'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'dev_id'
op|'='
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
name|'replica'
op|']'
op|'['
name|'part'
op|']'
newline|'\n'
name|'on_nodes'
op|'.'
name|'add'
op|'('
name|'rb'
op|'.'
name|'devs'
op|'['
name|'dev_id'
op|']'
op|'['
string|"'ip'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'on_nodes'
op|')'
op|'<'
name|'rb'
op|'.'
name|'replicas'
op|':'
newline|'\n'
indent|'                '
name|'poorly_dispersed'
op|'.'
name|'append'
op|'('
name|'part'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'poorly_dispersed'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_load
dedent|''
name|'def'
name|'test_load'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'devs'
op|'='
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta0'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta1'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta2'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|']'
newline|'\n'
name|'for'
name|'d'
name|'in'
name|'devs'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'add_dev'
op|'('
name|'d'
op|')'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'real_pickle'
op|'='
name|'pickle'
op|'.'
name|'load'
newline|'\n'
name|'fake_open'
op|'='
name|'mock'
op|'.'
name|'mock_open'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'io_error_not_found'
op|'='
name|'IOError'
op|'('
op|')'
newline|'\n'
name|'io_error_not_found'
op|'.'
name|'errno'
op|'='
name|'errno'
op|'.'
name|'ENOENT'
newline|'\n'
nl|'\n'
name|'io_error_no_perm'
op|'='
name|'IOError'
op|'('
op|')'
newline|'\n'
name|'io_error_no_perm'
op|'.'
name|'errno'
op|'='
name|'errno'
op|'.'
name|'EPERM'
newline|'\n'
nl|'\n'
name|'io_error_generic'
op|'='
name|'IOError'
op|'('
op|')'
newline|'\n'
name|'io_error_generic'
op|'.'
name|'errno'
op|'='
name|'errno'
op|'.'
name|'EOPNOTSUPP'
newline|'\n'
name|'try'
op|':'
newline|'\n'
comment|'# test a legit builder'
nl|'\n'
indent|'            '
name|'fake_pickle'
op|'='
name|'mock'
op|'.'
name|'Mock'
op|'('
name|'return_value'
op|'='
name|'rb'
op|')'
newline|'\n'
name|'pickle'
op|'.'
name|'load'
op|'='
name|'fake_pickle'
newline|'\n'
name|'builder'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|'('
string|"'fake.builder'"
op|','
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fake_pickle'
op|'.'
name|'call_count'
op|','
number|'1'
op|')'
newline|'\n'
name|'fake_open'
op|'.'
name|'assert_has_calls'
op|'('
op|'['
name|'mock'
op|'.'
name|'call'
op|'('
string|"'fake.builder'"
op|','
string|"'rb'"
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'builder'
op|','
name|'rb'
op|')'
newline|'\n'
name|'fake_pickle'
op|'.'
name|'reset_mock'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# test old style builder'
nl|'\n'
name|'fake_pickle'
op|'.'
name|'return_value'
op|'='
name|'rb'
op|'.'
name|'to_dict'
op|'('
op|')'
newline|'\n'
name|'pickle'
op|'.'
name|'load'
op|'='
name|'fake_pickle'
newline|'\n'
name|'builder'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|'('
string|"'fake.builder'"
op|','
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
name|'fake_open'
op|'.'
name|'assert_has_calls'
op|'('
op|'['
name|'mock'
op|'.'
name|'call'
op|'('
string|"'fake.builder'"
op|','
string|"'rb'"
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'builder'
op|'.'
name|'devs'
op|','
name|'rb'
op|'.'
name|'devs'
op|')'
newline|'\n'
name|'fake_pickle'
op|'.'
name|'reset_mock'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# test old devs but no meta'
nl|'\n'
name|'no_meta_builder'
op|'='
name|'rb'
newline|'\n'
name|'for'
name|'dev'
name|'in'
name|'no_meta_builder'
op|'.'
name|'devs'
op|':'
newline|'\n'
indent|'                '
name|'del'
op|'('
name|'dev'
op|'['
string|"'meta'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'fake_pickle'
op|'.'
name|'return_value'
op|'='
name|'no_meta_builder'
newline|'\n'
name|'pickle'
op|'.'
name|'load'
op|'='
name|'fake_pickle'
newline|'\n'
name|'builder'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|'('
string|"'fake.builder'"
op|','
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
name|'fake_open'
op|'.'
name|'assert_has_calls'
op|'('
op|'['
name|'mock'
op|'.'
name|'call'
op|'('
string|"'fake.builder'"
op|','
string|"'rb'"
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'builder'
op|'.'
name|'devs'
op|','
name|'rb'
op|'.'
name|'devs'
op|')'
newline|'\n'
nl|'\n'
comment|'# test an empty builder'
nl|'\n'
name|'fake_pickle'
op|'.'
name|'side_effect'
op|'='
name|'EOFError'
newline|'\n'
name|'pickle'
op|'.'
name|'load'
op|'='
name|'fake_pickle'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'UnPicklingError'
op|','
nl|'\n'
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|','
string|"'fake.builder'"
op|','
nl|'\n'
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
nl|'\n'
comment|'# test a corrupted builder'
nl|'\n'
name|'fake_pickle'
op|'.'
name|'side_effect'
op|'='
name|'pickle'
op|'.'
name|'UnpicklingError'
newline|'\n'
name|'pickle'
op|'.'
name|'load'
op|'='
name|'fake_pickle'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'UnPicklingError'
op|','
nl|'\n'
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|','
string|"'fake.builder'"
op|','
nl|'\n'
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
nl|'\n'
comment|'# test some error'
nl|'\n'
name|'fake_pickle'
op|'.'
name|'side_effect'
op|'='
name|'AttributeError'
newline|'\n'
name|'pickle'
op|'.'
name|'load'
op|'='
name|'fake_pickle'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'UnPicklingError'
op|','
nl|'\n'
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|','
string|"'fake.builder'"
op|','
nl|'\n'
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'pickle'
op|'.'
name|'load'
op|'='
name|'real_pickle'
newline|'\n'
nl|'\n'
comment|'# test non existent builder file'
nl|'\n'
dedent|''
name|'fake_open'
op|'.'
name|'side_effect'
op|'='
name|'io_error_not_found'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'FileNotFoundError'
op|','
nl|'\n'
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|','
string|"'fake.builder'"
op|','
nl|'\n'
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
nl|'\n'
comment|'# test non accessible builder file'
nl|'\n'
name|'fake_open'
op|'.'
name|'side_effect'
op|'='
name|'io_error_no_perm'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'PermissionError'
op|','
nl|'\n'
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|','
string|"'fake.builder'"
op|','
nl|'\n'
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
nl|'\n'
comment|'# test an error other then ENOENT and ENOPERM'
nl|'\n'
name|'fake_open'
op|'.'
name|'side_effect'
op|'='
name|'io_error_generic'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'IOError'
op|','
nl|'\n'
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|','
string|"'fake.builder'"
op|','
nl|'\n'
name|'open'
op|'='
name|'fake_open'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_save_load
dedent|''
name|'def'
name|'test_save_load'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'devs'
op|'='
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'replication_port'"
op|':'
number|'10000'
op|','
nl|'\n'
string|"'device'"
op|':'
string|"'sda1'"
op|','
string|"'meta'"
op|':'
string|"'meta0'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'replication_port'"
op|':'
number|'10001'
op|','
nl|'\n'
string|"'device'"
op|':'
string|"'sdb1'"
op|','
string|"'meta'"
op|':'
string|"'meta1'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'replication_port'"
op|':'
number|'10002'
op|','
nl|'\n'
string|"'device'"
op|':'
string|"'sdc1'"
op|','
string|"'meta'"
op|':'
string|"'meta2'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'replication_port'"
op|':'
number|'10003'
op|','
nl|'\n'
string|"'device'"
op|':'
string|"'sdd1'"
op|','
string|"'meta'"
op|':'
string|"''"
op|'}'
op|']'
newline|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'3.14159'
op|')'
newline|'\n'
name|'for'
name|'d'
name|'in'
name|'devs'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'add_dev'
op|'('
name|'d'
op|')'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'builder_file'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
string|"'test_save.builder'"
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'save'
op|'('
name|'builder_file'
op|')'
newline|'\n'
name|'loaded_rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'.'
name|'load'
op|'('
name|'builder_file'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'maxDiff'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'loaded_rb'
op|'.'
name|'to_dict'
op|'('
op|')'
op|','
name|'rb'
op|'.'
name|'to_dict'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'loaded_rb'
op|'.'
name|'overload'
op|','
number|'3.14159'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'six.moves.builtins.open'"
op|','
name|'autospec'
op|'='
name|'True'
op|')'
newline|'\n'
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.common.ring.builder.pickle.dump'"
op|','
name|'autospec'
op|'='
name|'True'
op|')'
newline|'\n'
DECL|member|test_save
name|'def'
name|'test_save'
op|'('
name|'self'
op|','
name|'mock_pickle_dump'
op|','
name|'mock_open'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_open'
op|'.'
name|'return_value'
op|'='
name|'mock_fh'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'devs'
op|'='
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta0'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta1'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta2'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|'}'
op|']'
newline|'\n'
name|'for'
name|'d'
name|'in'
name|'devs'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'add_dev'
op|'('
name|'d'
op|')'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'save'
op|'('
string|"'some.builder'"
op|')'
newline|'\n'
name|'mock_open'
op|'.'
name|'assert_called_once_with'
op|'('
string|"'some.builder'"
op|','
string|"'wb'"
op|')'
newline|'\n'
name|'mock_pickle_dump'
op|'.'
name|'assert_called_once_with'
op|'('
name|'rb'
op|'.'
name|'to_dict'
op|'('
op|')'
op|','
nl|'\n'
name|'mock_fh'
op|'.'
name|'__enter__'
op|'('
op|')'
op|','
nl|'\n'
name|'protocol'
op|'='
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_search_devs
dedent|''
name|'def'
name|'test_search_devs'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'devs'
op|'='
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta0'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta1'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta2'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sdd1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta3'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'2'
op|','
string|"'zone'"
op|':'
number|'4'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.4'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sde1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta4'"
op|','
string|"'replication_ip'"
op|':'
string|"'127.0.0.10'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'20000'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'2'
op|','
string|"'zone'"
op|':'
number|'5'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.5'"
op|','
string|"'port'"
op|':'
number|'10005'
op|','
string|"'device'"
op|':'
string|"'sdf1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta5'"
op|','
string|"'replication_ip'"
op|':'
string|"'127.0.0.11'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'20001'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'2'
op|','
string|"'zone'"
op|':'
number|'6'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.6'"
op|','
string|"'port'"
op|':'
number|'10006'
op|','
string|"'device'"
op|':'
string|"'sdg1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'meta6'"
op|','
string|"'replication_ip'"
op|':'
string|"'127.0.0.12'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'20002'
op|'}'
op|']'
newline|'\n'
name|'for'
name|'d'
name|'in'
name|'devs'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'add_dev'
op|'('
name|'d'
op|')'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'region'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'0'
op|']'
op|','
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'region'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'2'
op|']'
op|','
name|'devs'
op|'['
number|'3'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'2'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'2'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'zone'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'port'"
op|':'
number|'10001'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'replication_ip'"
op|':'
string|"'127.0.0.10'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'4'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'replication_ip'"
op|':'
string|"'127.0.0.10'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'20000'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'4'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'replication_port'"
op|':'
number|'20000'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'4'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
name|'res'
op|'='
name|'rb'
op|'.'
name|'search_devs'
op|'('
op|'{'
string|"'meta'"
op|':'
string|"'meta1'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate
dedent|''
name|'def'
name|'test_validate'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'9'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'10'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'11'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'12'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10002'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'13'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'14'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'15'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10003'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# Degenerate case: devices added but not rebalanced yet'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'RingValidationError'
op|','
name|'rb'
op|'.'
name|'validate'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'counts'
op|'='
name|'self'
op|'.'
name|'_partition_counts'
op|'('
name|'rb'
op|','
name|'key'
op|'='
string|"'zone'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'counts'
op|','
op|'{'
number|'0'
op|':'
number|'128'
op|','
number|'1'
op|':'
number|'128'
op|','
number|'2'
op|':'
number|'256'
op|','
number|'3'
op|':'
number|'256'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'dev_usage'
op|','
name|'worst'
op|'='
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'dev_usage'
name|'is'
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'worst'
name|'is'
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'dev_usage'
op|','
name|'worst'
op|'='
name|'rb'
op|'.'
name|'validate'
op|'('
name|'stats'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'list'
op|'('
name|'dev_usage'
op|')'
op|','
op|'['
number|'32'
op|','
number|'32'
op|','
number|'64'
op|','
number|'64'
op|','
nl|'\n'
number|'32'
op|','
number|'32'
op|','
number|'32'
op|','
comment|'# added zone0'
nl|'\n'
number|'32'
op|','
number|'32'
op|','
number|'32'
op|','
comment|'# added zone1'
nl|'\n'
number|'64'
op|','
number|'64'
op|','
number|'64'
op|','
comment|'# added zone2'
nl|'\n'
number|'64'
op|','
number|'64'
op|','
number|'64'
op|','
comment|'# added zone3'
nl|'\n'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'int'
op|'('
name|'worst'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'2'
op|','
number|'0'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'validate'
op|'('
name|'stats'
op|'='
name|'True'
op|')'
op|'['
number|'1'
op|']'
op|','
name|'MAX_BALANCE'
op|')'
newline|'\n'
nl|'\n'
comment|'# Test not all partitions doubly accounted for'
nl|'\n'
name|'rb'
op|'.'
name|'devs'
op|'['
number|'1'
op|']'
op|'['
string|"'parts'"
op|']'
op|'-='
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'RingValidationError'
op|','
name|'rb'
op|'.'
name|'validate'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'devs'
op|'['
number|'1'
op|']'
op|'['
string|"'parts'"
op|']'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
comment|'# Test non-numeric port'
nl|'\n'
name|'rb'
op|'.'
name|'devs'
op|'['
number|'1'
op|']'
op|'['
string|"'port'"
op|']'
op|'='
string|"'10001'"
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'RingValidationError'
op|','
name|'rb'
op|'.'
name|'validate'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'devs'
op|'['
number|'1'
op|']'
op|'['
string|"'port'"
op|']'
op|'='
number|'10001'
newline|'\n'
nl|'\n'
comment|'# Test partition on nonexistent device'
nl|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'orig_dev_id'
op|'='
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|'='
name|'len'
op|'('
name|'rb'
op|'.'
name|'devs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'RingValidationError'
op|','
name|'rb'
op|'.'
name|'validate'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|'='
name|'orig_dev_id'
newline|'\n'
nl|'\n'
comment|"# Tests that validate can handle 'holes' in .devs"
nl|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'2'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
name|'stats'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
comment|'# Test partition assigned to a hole'
nl|'\n'
name|'if'
name|'rb'
op|'.'
name|'devs'
op|'['
number|'2'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'2'
op|')'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'orig_dev_id'
op|'='
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|'='
number|'2'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'RingValidationError'
op|','
name|'rb'
op|'.'
name|'validate'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|'='
name|'orig_dev_id'
newline|'\n'
nl|'\n'
comment|"# Validate that zero weight devices with no partitions don't count on"
nl|'\n'
comment|"# the 'worst' value."
nl|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'rb'
op|'.'
name|'validate'
op|'('
name|'stats'
op|'='
name|'True'
op|')'
op|'['
number|'1'
op|']'
op|','
name|'MAX_BALANCE'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'16'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10004'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'rb'
op|'.'
name|'validate'
op|'('
name|'stats'
op|'='
name|'True'
op|')'
op|'['
number|'1'
op|']'
op|','
name|'MAX_BALANCE'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate_partial_replica
dedent|''
name|'def'
name|'test_validate_partial_replica'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'2.5'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
comment|'# sanity'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'0'
op|']'
op|')'
op|','
number|'256'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'1'
op|']'
op|')'
op|','
number|'256'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'2'
op|']'
op|')'
op|','
number|'128'
op|')'
newline|'\n'
nl|'\n'
comment|'# now swap partial replica part maps'
nl|'\n'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'1'
op|']'
op|','
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'2'
op|']'
op|'='
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'2'
op|']'
op|','
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exceptions'
op|'.'
name|'RingValidationError'
op|','
name|'rb'
op|'.'
name|'validate'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate_duplicate_part_assignment
dedent|''
name|'def'
name|'test_validate_duplicate_part_assignment'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
comment|'# sanity'
newline|'\n'
comment|'# now double up a device assignment'
nl|'\n'
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'1'
op|']'
op|'['
number|'200'
op|']'
op|'='
name|'rb'
op|'.'
name|'_replica2part2dev'
op|'['
number|'2'
op|']'
op|'['
number|'200'
op|']'
newline|'\n'
nl|'\n'
DECL|class|SubStringMatcher
name|'class'
name|'SubStringMatcher'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
DECL|member|__init__
indent|'            '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'substr'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'substr'
op|'='
name|'substr'
newline|'\n'
nl|'\n'
DECL|member|__eq__
dedent|''
name|'def'
name|'__eq__'
op|'('
name|'self'
op|','
name|'other'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'self'
op|'.'
name|'substr'
name|'in'
name|'other'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'with'
name|'warnings'
op|'.'
name|'catch_warnings'
op|'('
op|')'
op|':'
newline|'\n'
comment|"# we're firing the warning twice in this test and resetwarnings"
nl|'\n'
comment|"# doesn't work - https://bugs.python.org/issue4180"
nl|'\n'
indent|'            '
name|'warnings'
op|'.'
name|'simplefilter'
op|'('
string|"'always'"
op|')'
newline|'\n'
nl|'\n'
comment|'# by default things will work, but log a warning'
nl|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'sys.stderr'"
op|')'
name|'as'
name|'mock_stderr'
op|':'
newline|'\n'
indent|'                '
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
DECL|variable|expected
dedent|''
name|'expected'
op|'='
name|'SubStringMatcher'
op|'('
nl|'\n'
string|"'RingValidationWarning: The partition 200 has been assigned '"
nl|'\n'
string|"'to duplicate devices'"
op|')'
newline|'\n'
comment|'# ... but the warning is written to stderr'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'mock_stderr'
op|'.'
name|'method_calls'
op|','
nl|'\n'
op|'['
name|'mock'
op|'.'
name|'call'
op|'.'
name|'write'
op|'('
name|'expected'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# if you make warnings errors it blows up'
nl|'\n'
name|'with'
name|'warnings'
op|'.'
name|'catch_warnings'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'warnings'
op|'.'
name|'filterwarnings'
op|'('
string|"'error'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'RingValidationWarning'
op|','
name|'rb'
op|'.'
name|'validate'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_part_devices
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_get_part_devices'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'get_part_devices'
op|'('
number|'0'
op|')'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'part_devs'
op|'='
name|'sorted'
op|'('
name|'rb'
op|'.'
name|'get_part_devices'
op|'('
number|'0'
op|')'
op|','
nl|'\n'
name|'key'
op|'='
name|'operator'
op|'.'
name|'itemgetter'
op|'('
string|"'id'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_devs'
op|','
op|'['
name|'rb'
op|'.'
name|'devs'
op|'['
number|'0'
op|']'
op|','
name|'rb'
op|'.'
name|'devs'
op|'['
number|'1'
op|']'
op|','
name|'rb'
op|'.'
name|'devs'
op|'['
number|'2'
op|']'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_part_devices_partial_replicas
dedent|''
name|'def'
name|'test_get_part_devices_partial_replicas'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'2.5'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10001'
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'9'
op|')'
newline|'\n'
nl|'\n'
comment|'# note: partition 255 will only have 2 replicas'
nl|'\n'
name|'part_devs'
op|'='
name|'sorted'
op|'('
name|'rb'
op|'.'
name|'get_part_devices'
op|'('
number|'255'
op|')'
op|','
nl|'\n'
name|'key'
op|'='
name|'operator'
op|'.'
name|'itemgetter'
op|'('
string|"'id'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_devs'
op|','
op|'['
name|'rb'
op|'.'
name|'devs'
op|'['
number|'0'
op|']'
op|','
name|'rb'
op|'.'
name|'devs'
op|'['
number|'1'
op|']'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_dispersion_with_zero_weight_devices
dedent|''
name|'def'
name|'test_dispersion_with_zero_weight_devices'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3.0'
op|','
number|'0'
op|')'
newline|'\n'
comment|'# add two devices to a single server in a single zone'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
comment|'# and a zero weight device'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'dispersion'
op|','
number|'0.0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'_dispersion_graph'
op|','
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'0'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'256'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'1'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'256'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'2'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'256'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_dispersion_with_zero_weight_devices_with_parts
dedent|''
name|'def'
name|'test_dispersion_with_zero_weight_devices_with_parts'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3.0'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# add four devices to a single server in a single zone'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'dispersion'
op|','
number|'0.0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'_dispersion_graph'
op|','
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'0'
op|')'
op|':'
op|'['
number|'64'
op|','
number|'192'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'1'
op|')'
op|':'
op|'['
number|'64'
op|','
number|'192'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'2'
op|')'
op|':'
op|'['
number|'64'
op|','
number|'192'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'3'
op|')'
op|':'
op|'['
number|'64'
op|','
number|'192'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
comment|'# now mark a device 2 for decom'
nl|'\n'
name|'rb'
op|'.'
name|'set_dev_weight'
op|'('
number|'2'
op|','
number|'0.0'
op|')'
newline|'\n'
comment|"# we'll rebalance but can't move any parts"
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
comment|'# zero weight tier has one copy of 1/4 part-replica'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'dispersion'
op|','
number|'75.0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'_dispersion_graph'
op|','
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'0'
op|')'
op|':'
op|'['
number|'64'
op|','
number|'192'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'1'
op|')'
op|':'
op|'['
number|'64'
op|','
number|'192'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'2'
op|')'
op|':'
op|'['
number|'64'
op|','
number|'192'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'3'
op|')'
op|':'
op|'['
number|'64'
op|','
number|'192'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
comment|'# unlock the stuck parts'
nl|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'dispersion'
op|','
number|'0.0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'_dispersion_graph'
op|','
op|'{'
nl|'\n'
op|'('
number|'0'
op|','
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|')'
op|':'
op|'['
number|'0'
op|','
number|'0'
op|','
number|'0'
op|','
number|'256'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'0'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'256'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'1'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'256'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'('
number|'0'
op|','
number|'0'
op|','
string|"'127.0.0.1'"
op|','
number|'3'
op|')'
op|':'
op|'['
number|'0'
op|','
number|'256'
op|','
number|'0'
op|','
number|'0'
op|']'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_effective_overload
dedent|''
name|'def'
name|'test_effective_overload'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# z0'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
comment|'# z1'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
comment|'# z2'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# this ring requires overload'
nl|'\n'
name|'required'
op|'='
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertGreater'
op|'('
name|'required'
op|','
number|'0.1'
op|')'
newline|'\n'
nl|'\n'
comment|"# and we'll use a little bit"
nl|'\n'
name|'rb'
op|'.'
name|'set_overload'
op|'('
number|'0.1'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'7'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|"# but with-out enough overload we're not dispersed"
nl|'\n'
name|'self'
op|'.'
name|'assertGreater'
op|'('
name|'rb'
op|'.'
name|'dispersion'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# add the other dev to z2'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'8'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
comment|'# but also fail another device in the same!'
nl|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'6'
op|')'
newline|'\n'
nl|'\n'
comment|'# we still require overload'
nl|'\n'
name|'required'
op|'='
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertGreater'
op|'('
name|'required'
op|','
number|'0.1'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'7'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|"# ... and without enough we're full dispersed"
nl|'\n'
name|'self'
op|'.'
name|'assertGreater'
op|'('
name|'rb'
op|'.'
name|'dispersion'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|"# ok, let's fix z2's weight for real"
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# ... technically, we no longer require overload'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'0.0'
op|')'
newline|'\n'
nl|'\n'
comment|"# so let's rebalance w/o resetting min_part_hours"
nl|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'7'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|"# ok, we didn't quite disperse"
nl|'\n'
name|'self'
op|'.'
name|'assertGreater'
op|'('
name|'rb'
op|'.'
name|'dispersion'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|"# ... but let's unlock some parts"
nl|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'7'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# ... and that got it!'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rb'
op|'.'
name|'dispersion'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|strawman_test
dedent|''
name|'def'
name|'strawman_test'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        This test demonstrates a trivial failure of part-replica placement.\n\n        If you turn warnings into errors this will fail.\n\n        i.e.\n\n            export PYTHONWARNINGS=error:::swift.common.ring.builder\n\n        N.B. try not to get *too* hung up on doing something silly to make\n        this particular case pass w/o warnings - it\'s trivial to write up a\n        dozen more.\n        """'
newline|'\n'
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# z0'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
comment|'# z1'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
comment|'# z2'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'200'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'with'
name|'warnings'
op|'.'
name|'catch_warnings'
op|'('
name|'record'
op|'='
name|'True'
op|')'
name|'as'
name|'w'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'7'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'validate'
op|'('
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'w'
op|')'
op|','
number|'65'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|TestGetRequiredOverload
dedent|''
dedent|''
name|'class'
name|'TestGetRequiredOverload'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
DECL|member|assertApproximately
indent|'    '
name|'def'
name|'assertApproximately'
op|'('
name|'self'
op|','
name|'a'
op|','
name|'b'
op|','
name|'error'
op|'='
number|'1e-6'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'abs'
op|'('
name|'a'
op|'-'
name|'b'
op|')'
op|'<'
name|'error'
op|','
nl|'\n'
string|'"%f and %f differ by more than %f"'
op|'%'
op|'('
name|'a'
op|','
name|'b'
op|','
name|'error'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_none_needed
dedent|''
name|'def'
name|'test_none_needed'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# 4 equal-weight devs and 3 replicas: this can be balanced without'
nl|'\n'
comment|'# resorting to overload at all'
nl|'\n'
name|'self'
op|'.'
name|'assertApproximately'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# 3 equal-weight devs and 3 replicas: this can also be balanced'
nl|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertApproximately'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_small_zone
dedent|''
name|'def'
name|'test_small_zone'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'4'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdc'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdd'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# Zone 2 has 7/8 of the capacity of the other two zones, so an'
nl|'\n'
comment|'# overload of 1/7 will allow things to balance out.'
nl|'\n'
name|'self'
op|'.'
name|'assertApproximately'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'1.0'
op|'/'
number|'7'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_big_zone
dedent|''
name|'def'
name|'test_big_zone'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# Zone 1 has weight 200, while zones 2, 3, and 4 together have only'
nl|'\n'
comment|'# 360. The small zones would need to go from 360 to 400 to balance'
nl|'\n'
comment|'# out zone 1, for an overload of 40/360 = 1/9.'
nl|'\n'
name|'self'
op|'.'
name|'assertApproximately'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'1.0'
op|'/'
number|'9'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_enormous_zone
dedent|''
name|'def'
name|'test_enormous_zone'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1000'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1000'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'60'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# Zone 1 has weight 2000, while zones 2, 3, and 4 together have only'
nl|'\n'
comment|'# 360. The small zones would need to go from 360 to 4000 to balance'
nl|'\n'
comment|'# out zone 1, for an overload of 3640/360.'
nl|'\n'
name|'self'
op|'.'
name|'assertApproximately'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'3640.0'
op|'/'
number|'360'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_two_big_two_small
dedent|''
name|'def'
name|'test_two_big_two_small'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'45'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'45'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'35'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'7'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'35'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# Zones 1 and 2 each have weight 200, while zones 3 and 4 together'
nl|'\n'
comment|'# have only 160. The small zones would need to go from 160 to 200 to'
nl|'\n'
comment|'# balance out the big zones, for an overload of 40/160 = 1/4.'
nl|'\n'
name|'self'
op|'.'
name|'assertApproximately'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'1.0'
op|'/'
number|'4'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multiple_replicas_each
dedent|''
name|'def'
name|'test_multiple_replicas_each'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'7'
op|','
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'100'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'70'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'weight'"
op|':'
number|'70'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'10000'
op|','
string|"'device'"
op|':'
string|"'sdb'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|"# Zone 0 has more than 4/7 of the weight, so we'll need to bring"
nl|'\n'
comment|'# zone 1 up to a total of 150 so it can take 3 replicas, so the'
nl|'\n'
comment|'# overload should be 10/140.'
nl|'\n'
name|'self'
op|'.'
name|'assertApproximately'
op|'('
name|'rb'
op|'.'
name|'get_required_overload'
op|'('
op|')'
op|','
number|'10.0'
op|'/'
number|'140'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'__name__'
op|'=='
string|"'__main__'"
op|':'
newline|'\n'
indent|'    '
name|'unittest'
op|'.'
name|'main'
op|'('
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit

begin_unit
comment|'# Copyright (c) 2014 Christian Schwede <christian.schwede@enovance.com>'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'mock'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'tempfile'
newline|'\n'
name|'import'
name|'unittest'
newline|'\n'
name|'import'
name|'uuid'
newline|'\n'
nl|'\n'
name|'import'
name|'swift'
op|'.'
name|'cli'
op|'.'
name|'ringbuilder'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'exceptions'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'ring'
name|'import'
name|'RingBuilder'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|TestCommands
name|'class'
name|'TestCommands'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'TestCommands'
op|','
name|'self'
op|')'
op|'.'
name|'__init__'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
nl|'\n'
comment|'# List of search values for various actions'
nl|'\n'
comment|'# These should all match the first device in the sample ring'
nl|'\n'
comment|'# (see below) but not the second device'
nl|'\n'
name|'self'
op|'.'
name|'search_values'
op|'='
op|'['
string|'"d0"'
op|','
string|'"/sda1"'
op|','
string|'"r0"'
op|','
string|'"z0"'
op|','
string|'"z0-127.0.0.1"'
op|','
nl|'\n'
string|'"127.0.0.1"'
op|','
string|'"z0:6000"'
op|','
string|'":6000"'
op|','
string|'"R127.0.0.1"'
op|','
nl|'\n'
string|'"127.0.0.1R127.0.0.1"'
op|','
string|'"R:6000"'
op|','
nl|'\n'
string|'"_some meta data"'
op|']'
newline|'\n'
name|'tmpf'
op|'='
name|'tempfile'
op|'.'
name|'NamedTemporaryFile'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'tmpfile'
op|'='
name|'tmpf'
op|'.'
name|'name'
newline|'\n'
nl|'\n'
DECL|member|tearDown
dedent|''
name|'def'
name|'tearDown'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'os'
op|'.'
name|'remove'
op|'('
name|'self'
op|'.'
name|'tmpfile'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'OSError'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
DECL|member|create_sample_ring
dedent|''
dedent|''
name|'def'
name|'create_sample_ring'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'""" Create a sample ring with two devices\n\n        At least two devices are needed to test removing\n        a device, since removing the last device of a ring\n        is not allowed """'
newline|'\n'
nl|'\n'
comment|'# Ensure there is no existing test builder file because'
nl|'\n'
comment|'# create_sample_ring() might be used more than once in a single test'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'os'
op|'.'
name|'remove'
op|'('
name|'self'
op|'.'
name|'tmpfile'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'OSError'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'ring'
op|'='
name|'RingBuilder'
op|'('
number|'6'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'ring'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'weight'"
op|':'
number|'100.0'
op|','
nl|'\n'
string|"'region'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'zone'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6000'
op|','
nl|'\n'
string|"'device'"
op|':'
string|"'sda1'"
op|','
nl|'\n'
string|"'meta'"
op|':'
string|"'some meta data'"
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'ring'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'weight'"
op|':'
number|'100.0'
op|','
nl|'\n'
string|"'region'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'zone'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6001'
op|','
nl|'\n'
string|"'device'"
op|':'
string|"'sda2'"
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'ring'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'tmpfile'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_ring
dedent|''
name|'def'
name|'test_create_ring'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'argv'
op|'='
op|'['
string|'""'
op|','
name|'self'
op|'.'
name|'tmpfile'
op|','
string|'"create"'
op|','
string|'"6"'
op|','
string|'"3.14159265359"'
op|','
string|'"1"'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'SystemExit'
op|','
name|'swift'
op|'.'
name|'cli'
op|'.'
name|'ringbuilder'
op|'.'
name|'main'
op|','
name|'argv'
op|')'
newline|'\n'
name|'ring'
op|'='
name|'RingBuilder'
op|'.'
name|'load'
op|'('
name|'self'
op|'.'
name|'tmpfile'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'ring'
op|'.'
name|'part_power'
op|','
number|'6'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'ring'
op|'.'
name|'replicas'
op|','
number|'3.14159265359'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'ring'
op|'.'
name|'min_part_hours'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_device
dedent|''
name|'def'
name|'test_add_device'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'create_sample_ring'
op|'('
op|')'
newline|'\n'
name|'argv'
op|'='
op|'['
string|'""'
op|','
name|'self'
op|'.'
name|'tmpfile'
op|','
string|'"add"'
op|','
nl|'\n'
string|'"r2z3-127.0.0.1:6000/sda3_some meta data"'
op|','
string|'"3.14159265359"'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'SystemExit'
op|','
name|'swift'
op|'.'
name|'cli'
op|'.'
name|'ringbuilder'
op|'.'
name|'main'
op|','
name|'argv'
op|')'
newline|'\n'
nl|'\n'
comment|'# Check that device was created with given data'
nl|'\n'
name|'ring'
op|'='
name|'RingBuilder'
op|'.'
name|'load'
op|'('
name|'self'
op|'.'
name|'tmpfile'
op|')'
newline|'\n'
name|'dev'
op|'='
op|'['
name|'d'
name|'for'
name|'d'
name|'in'
name|'ring'
op|'.'
name|'devs'
name|'if'
name|'d'
op|'['
string|"'id'"
op|']'
op|'=='
number|'2'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'region'"
op|']'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'zone'"
op|']'
op|','
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'ip'"
op|']'
op|','
string|"'127.0.0.1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'port'"
op|']'
op|','
number|'6000'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'device'"
op|']'
op|','
string|"'sda3'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'weight'"
op|']'
op|','
number|'3.14159265359'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'replication_ip'"
op|']'
op|','
string|"'127.0.0.1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'replication_port'"
op|']'
op|','
number|'6000'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'meta'"
op|']'
op|','
string|"'some meta data'"
op|')'
newline|'\n'
nl|'\n'
comment|'# Final check, rebalance and check ring is ok'
nl|'\n'
name|'ring'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'ring'
op|'.'
name|'validate'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_device
dedent|''
name|'def'
name|'test_remove_device'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'search_value'
name|'in'
name|'self'
op|'.'
name|'search_values'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'create_sample_ring'
op|'('
op|')'
newline|'\n'
name|'argv'
op|'='
op|'['
string|'""'
op|','
name|'self'
op|'.'
name|'tmpfile'
op|','
string|'"remove"'
op|','
name|'search_value'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'SystemExit'
op|','
name|'swift'
op|'.'
name|'cli'
op|'.'
name|'ringbuilder'
op|'.'
name|'main'
op|','
name|'argv'
op|')'
newline|'\n'
name|'ring'
op|'='
name|'RingBuilder'
op|'.'
name|'load'
op|'('
name|'self'
op|'.'
name|'tmpfile'
op|')'
newline|'\n'
nl|'\n'
comment|'# Check that weight was set to 0'
nl|'\n'
name|'dev'
op|'='
op|'['
name|'d'
name|'for'
name|'d'
name|'in'
name|'ring'
op|'.'
name|'devs'
name|'if'
name|'d'
op|'['
string|"'id'"
op|']'
op|'=='
number|'0'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'weight'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# Check that device is in list of devices to be removed'
nl|'\n'
name|'dev'
op|'='
op|'['
name|'d'
name|'for'
name|'d'
name|'in'
name|'ring'
op|'.'
name|'_remove_devs'
name|'if'
name|'d'
op|'['
string|"'id'"
op|']'
op|'=='
number|'0'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'region'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'zone'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'ip'"
op|']'
op|','
string|"'127.0.0.1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'port'"
op|']'
op|','
number|'6000'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'device'"
op|']'
op|','
string|"'sda1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'weight'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'replication_ip'"
op|']'
op|','
string|"'127.0.0.1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'replication_port'"
op|']'
op|','
number|'6000'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'meta'"
op|']'
op|','
string|"'some meta data'"
op|')'
newline|'\n'
nl|'\n'
comment|'# Check that second device in ring is not affected'
nl|'\n'
name|'dev'
op|'='
op|'['
name|'d'
name|'for'
name|'d'
name|'in'
name|'ring'
op|'.'
name|'devs'
name|'if'
name|'d'
op|'['
string|"'id'"
op|']'
op|'=='
number|'1'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'weight'"
op|']'
op|','
number|'100'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
op|'['
name|'d'
name|'for'
name|'d'
name|'in'
name|'ring'
op|'.'
name|'_remove_devs'
name|'if'
name|'d'
op|'['
string|"'id'"
op|']'
op|'=='
number|'1'
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# Final check, rebalance and check ring is ok'
nl|'\n'
name|'ring'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'ring'
op|'.'
name|'validate'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_weight
dedent|''
dedent|''
name|'def'
name|'test_set_weight'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'search_value'
name|'in'
name|'self'
op|'.'
name|'search_values'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'create_sample_ring'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'argv'
op|'='
op|'['
string|'""'
op|','
name|'self'
op|'.'
name|'tmpfile'
op|','
string|'"set_weight"'
op|','
nl|'\n'
name|'search_value'
op|','
string|'"3.14159265359"'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'SystemExit'
op|','
name|'swift'
op|'.'
name|'cli'
op|'.'
name|'ringbuilder'
op|'.'
name|'main'
op|','
name|'argv'
op|')'
newline|'\n'
name|'ring'
op|'='
name|'RingBuilder'
op|'.'
name|'load'
op|'('
name|'self'
op|'.'
name|'tmpfile'
op|')'
newline|'\n'
nl|'\n'
comment|'# Check that weight was changed'
nl|'\n'
name|'dev'
op|'='
op|'['
name|'d'
name|'for'
name|'d'
name|'in'
name|'ring'
op|'.'
name|'devs'
name|'if'
name|'d'
op|'['
string|"'id'"
op|']'
op|'=='
number|'0'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'weight'"
op|']'
op|','
number|'3.14159265359'
op|')'
newline|'\n'
nl|'\n'
comment|'# Check that second device in ring is not affected'
nl|'\n'
name|'dev'
op|'='
op|'['
name|'d'
name|'for'
name|'d'
name|'in'
name|'ring'
op|'.'
name|'devs'
name|'if'
name|'d'
op|'['
string|"'id'"
op|']'
op|'=='
number|'1'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'weight'"
op|']'
op|','
number|'100'
op|')'
newline|'\n'
nl|'\n'
comment|'# Final check, rebalance and check ring is ok'
nl|'\n'
name|'ring'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'ring'
op|'.'
name|'validate'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_info
dedent|''
dedent|''
name|'def'
name|'test_set_info'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'search_value'
name|'in'
name|'self'
op|'.'
name|'search_values'
op|':'
newline|'\n'
nl|'\n'
indent|'            '
name|'self'
op|'.'
name|'create_sample_ring'
op|'('
op|')'
newline|'\n'
name|'argv'
op|'='
op|'['
string|'""'
op|','
name|'self'
op|'.'
name|'tmpfile'
op|','
string|'"set_info"'
op|','
name|'search_value'
op|','
nl|'\n'
string|'"127.0.1.1:8000/sda1_other meta data"'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'SystemExit'
op|','
name|'swift'
op|'.'
name|'cli'
op|'.'
name|'ringbuilder'
op|'.'
name|'main'
op|','
name|'argv'
op|')'
newline|'\n'
nl|'\n'
comment|'# Check that device was created with given data'
nl|'\n'
name|'ring'
op|'='
name|'RingBuilder'
op|'.'
name|'load'
op|'('
name|'self'
op|'.'
name|'tmpfile'
op|')'
newline|'\n'
name|'dev'
op|'='
op|'['
name|'d'
name|'for'
name|'d'
name|'in'
name|'ring'
op|'.'
name|'devs'
name|'if'
name|'d'
op|'['
string|"'id'"
op|']'
op|'=='
number|'0'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'ip'"
op|']'
op|','
string|"'127.0.1.1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'port'"
op|']'
op|','
number|'8000'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'device'"
op|']'
op|','
string|"'sda1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'meta'"
op|']'
op|','
string|"'other meta data'"
op|')'
newline|'\n'
nl|'\n'
comment|'# Check that second device in ring is not affected'
nl|'\n'
name|'dev'
op|'='
op|'['
name|'d'
name|'for'
name|'d'
name|'in'
name|'ring'
op|'.'
name|'devs'
name|'if'
name|'d'
op|'['
string|"'id'"
op|']'
op|'=='
number|'1'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'ip'"
op|']'
op|','
string|"'127.0.0.2'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'port'"
op|']'
op|','
number|'6001'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'device'"
op|']'
op|','
string|"'sda2'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev'
op|'['
string|"'meta'"
op|']'
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
comment|'# Final check, rebalance and check ring is ok'
nl|'\n'
name|'ring'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'ring'
op|'.'
name|'validate'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_min_part_hours
dedent|''
dedent|''
name|'def'
name|'test_set_min_part_hours'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'create_sample_ring'
op|'('
op|')'
newline|'\n'
name|'argv'
op|'='
op|'['
string|'""'
op|','
name|'self'
op|'.'
name|'tmpfile'
op|','
string|'"set_min_part_hours"'
op|','
string|'"24"'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'SystemExit'
op|','
name|'swift'
op|'.'
name|'cli'
op|'.'
name|'ringbuilder'
op|'.'
name|'main'
op|','
name|'argv'
op|')'
newline|'\n'
name|'ring'
op|'='
name|'RingBuilder'
op|'.'
name|'load'
op|'('
name|'self'
op|'.'
name|'tmpfile'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'ring'
op|'.'
name|'min_part_hours'
op|','
number|'24'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_replicas
dedent|''
name|'def'
name|'test_set_replicas'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'create_sample_ring'
op|'('
op|')'
newline|'\n'
name|'argv'
op|'='
op|'['
string|'""'
op|','
name|'self'
op|'.'
name|'tmpfile'
op|','
string|'"set_replicas"'
op|','
string|'"3.14159265359"'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'SystemExit'
op|','
name|'swift'
op|'.'
name|'cli'
op|'.'
name|'ringbuilder'
op|'.'
name|'main'
op|','
name|'argv'
op|')'
newline|'\n'
name|'ring'
op|'='
name|'RingBuilder'
op|'.'
name|'load'
op|'('
name|'self'
op|'.'
name|'tmpfile'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'ring'
op|'.'
name|'replicas'
op|','
number|'3.14159265359'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate
dedent|''
name|'def'
name|'test_validate'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'create_sample_ring'
op|'('
op|')'
newline|'\n'
name|'ring'
op|'='
name|'RingBuilder'
op|'.'
name|'load'
op|'('
name|'self'
op|'.'
name|'tmpfile'
op|')'
newline|'\n'
name|'ring'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'ring'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'tmpfile'
op|')'
newline|'\n'
name|'argv'
op|'='
op|'['
string|'""'
op|','
name|'self'
op|'.'
name|'tmpfile'
op|','
string|'"validate"'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'SystemExit'
op|','
name|'swift'
op|'.'
name|'cli'
op|'.'
name|'ringbuilder'
op|'.'
name|'main'
op|','
name|'argv'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate_empty_file
dedent|''
name|'def'
name|'test_validate_empty_file'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'open'
op|'('
name|'self'
op|'.'
name|'tmpfile'
op|','
string|"'a'"
op|')'
op|'.'
name|'close'
newline|'\n'
name|'argv'
op|'='
op|'['
string|'""'
op|','
name|'self'
op|'.'
name|'tmpfile'
op|','
string|'"validate"'
op|']'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'swift'
op|'.'
name|'cli'
op|'.'
name|'ringbuilder'
op|'.'
name|'main'
op|'('
name|'argv'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'SystemExit'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'e'
op|'.'
name|'code'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate_corrupted_file
dedent|''
dedent|''
name|'def'
name|'test_validate_corrupted_file'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'create_sample_ring'
op|'('
op|')'
newline|'\n'
name|'ring'
op|'='
name|'RingBuilder'
op|'.'
name|'load'
op|'('
name|'self'
op|'.'
name|'tmpfile'
op|')'
newline|'\n'
name|'ring'
op|'.'
name|'rebalance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'ring'
op|'.'
name|'validate'
op|'('
op|')'
op|')'
comment|'# ring is valid until now'
newline|'\n'
name|'ring'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'tmpfile'
op|')'
newline|'\n'
name|'argv'
op|'='
op|'['
string|'""'
op|','
name|'self'
op|'.'
name|'tmpfile'
op|','
string|'"validate"'
op|']'
newline|'\n'
nl|'\n'
comment|'# corrupt the file'
nl|'\n'
name|'with'
name|'open'
op|'('
name|'self'
op|'.'
name|'tmpfile'
op|','
string|"'wb'"
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'            '
name|'f'
op|'.'
name|'write'
op|'('
name|'os'
op|'.'
name|'urandom'
op|'('
number|'1024'
op|')'
op|')'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'swift'
op|'.'
name|'cli'
op|'.'
name|'ringbuilder'
op|'.'
name|'main'
op|'('
name|'argv'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'SystemExit'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'e'
op|'.'
name|'code'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate_non_existent_file
dedent|''
dedent|''
name|'def'
name|'test_validate_non_existent_file'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rand_file'
op|'='
string|"'%s/%s'"
op|'%'
op|'('
string|"'/tmp'"
op|','
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'argv'
op|'='
op|'['
string|'""'
op|','
name|'rand_file'
op|','
string|'"validate"'
op|']'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'swift'
op|'.'
name|'cli'
op|'.'
name|'ringbuilder'
op|'.'
name|'main'
op|'('
name|'argv'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'SystemExit'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'e'
op|'.'
name|'code'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate_non_accessible_file
dedent|''
dedent|''
name|'def'
name|'test_validate_non_accessible_file'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
nl|'\n'
name|'RingBuilder'
op|','
string|"'load'"
op|','
nl|'\n'
name|'mock'
op|'.'
name|'Mock'
op|'('
name|'side_effect'
op|'='
name|'exceptions'
op|'.'
name|'PermissionError'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'argv'
op|'='
op|'['
string|'""'
op|','
name|'self'
op|'.'
name|'tmpfile'
op|','
string|'"validate"'
op|']'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'swift'
op|'.'
name|'cli'
op|'.'
name|'ringbuilder'
op|'.'
name|'main'
op|'('
name|'argv'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'SystemExit'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'e'
op|'.'
name|'code'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate_generic_error
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_validate_generic_error'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'RingBuilder'
op|','
string|"'load'"
op|','
nl|'\n'
name|'mock'
op|'.'
name|'Mock'
op|'('
name|'side_effect'
op|'='
nl|'\n'
name|'IOError'
op|'('
string|"'Generic error occurred'"
op|')'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'argv'
op|'='
op|'['
string|'""'
op|','
name|'self'
op|'.'
name|'tmpfile'
op|','
string|'"validate"'
op|']'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'swift'
op|'.'
name|'cli'
op|'.'
name|'ringbuilder'
op|'.'
name|'main'
op|'('
name|'argv'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'SystemExit'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'e'
op|'.'
name|'code'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
dedent|''
name|'if'
name|'__name__'
op|'=='
string|"'__main__'"
op|':'
newline|'\n'
indent|'    '
name|'unittest'
op|'.'
name|'main'
op|'('
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit

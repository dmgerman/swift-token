begin_unit
comment|'# Copyright (c) 2010-2012 OpenStack, LLC.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
name|'from'
name|'__future__'
name|'import'
name|'with_statement'
newline|'\n'
nl|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'time'
newline|'\n'
name|'import'
name|'traceback'
newline|'\n'
name|'from'
name|'datetime'
name|'import'
name|'datetime'
newline|'\n'
name|'from'
name|'gettext'
name|'import'
name|'gettext'
name|'as'
name|'_'
newline|'\n'
name|'from'
name|'xml'
op|'.'
name|'etree'
op|'.'
name|'cElementTree'
name|'import'
name|'Element'
op|','
name|'SubElement'
op|','
name|'tostring'
newline|'\n'
nl|'\n'
name|'from'
name|'eventlet'
name|'import'
name|'Timeout'
newline|'\n'
nl|'\n'
name|'import'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'db'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'db'
name|'import'
name|'ContainerBroker'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'request_helpers'
name|'import'
name|'get_param'
op|','
name|'get_listing_content_type'
op|','
name|'split_and_validate_path'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'get_logger'
op|','
name|'hash_path'
op|','
name|'public'
op|','
name|'normalize_timestamp'
op|','
name|'storage_directory'
op|','
name|'validate_sync_to'
op|','
name|'config_true_value'
op|','
name|'json'
op|','
name|'timing_stats'
op|','
name|'replication'
op|','
name|'parse_content_type'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'constraints'
name|'import'
name|'CONTAINER_LISTING_LIMIT'
op|','
name|'check_mount'
op|','
name|'check_float'
op|','
name|'check_utf8'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'bufferedhttp'
name|'import'
name|'http_connect'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'exceptions'
name|'import'
name|'ConnectionTimeout'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'db_replicator'
name|'import'
name|'ReplicatorRpc'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'http'
name|'import'
name|'HTTP_NOT_FOUND'
op|','
name|'is_success'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'swob'
name|'import'
name|'HTTPAccepted'
op|','
name|'HTTPBadRequest'
op|','
name|'HTTPConflict'
op|','
name|'HTTPCreated'
op|','
name|'HTTPInternalServerError'
op|','
name|'HTTPNoContent'
op|','
name|'HTTPNotFound'
op|','
name|'HTTPPreconditionFailed'
op|','
name|'HTTPMethodNotAllowed'
op|','
name|'Request'
op|','
name|'Response'
op|','
name|'HTTPInsufficientStorage'
op|','
name|'HTTPException'
op|','
name|'HeaderKeyDict'
newline|'\n'
nl|'\n'
DECL|variable|DATADIR
name|'DATADIR'
op|'='
string|"'containers'"
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ContainerController
name|'class'
name|'ContainerController'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""WSGI Controller for the container server."""'
newline|'\n'
nl|'\n'
comment|'# Ensure these are all lowercase'
nl|'\n'
DECL|variable|save_headers
name|'save_headers'
op|'='
op|'['
string|"'x-container-read'"
op|','
string|"'x-container-write'"
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|','
string|"'x-container-sync-to'"
op|']'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'conf'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'logger'
op|'='
name|'get_logger'
op|'('
name|'conf'
op|','
name|'log_route'
op|'='
string|"'container-server'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'root'
op|'='
name|'conf'
op|'.'
name|'get'
op|'('
string|"'devices'"
op|','
string|"'/srv/node/'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mount_check'
op|'='
name|'config_true_value'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'mount_check'"
op|','
string|"'true'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'node_timeout'
op|'='
name|'int'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'node_timeout'"
op|','
number|'3'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'conn_timeout'
op|'='
name|'float'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'conn_timeout'"
op|','
number|'0.5'
op|')'
op|')'
newline|'\n'
name|'replication_server'
op|'='
name|'conf'
op|'.'
name|'get'
op|'('
string|"'replication_server'"
op|','
name|'None'
op|')'
newline|'\n'
name|'if'
name|'replication_server'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'replication_server'
op|'='
name|'config_true_value'
op|'('
name|'replication_server'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'replication_server'
op|'='
name|'replication_server'
newline|'\n'
name|'self'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
nl|'\n'
name|'h'
op|'.'
name|'strip'
op|'('
op|')'
nl|'\n'
name|'for'
name|'h'
name|'in'
name|'conf'
op|'.'
name|'get'
op|'('
string|"'allowed_sync_hosts'"
op|','
string|"'127.0.0.1'"
op|')'
op|'.'
name|'split'
op|'('
string|"','"
op|')'
nl|'\n'
name|'if'
name|'h'
op|'.'
name|'strip'
op|'('
op|')'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'replicator_rpc'
op|'='
name|'ReplicatorRpc'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'root'
op|','
name|'DATADIR'
op|','
name|'ContainerBroker'
op|','
name|'self'
op|'.'
name|'mount_check'
op|','
nl|'\n'
name|'logger'
op|'='
name|'self'
op|'.'
name|'logger'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'auto_create_account_prefix'
op|'='
name|'conf'
op|'.'
name|'get'
op|'('
string|"'auto_create_account_prefix'"
op|')'
name|'or'
string|"'.'"
newline|'\n'
name|'if'
name|'config_true_value'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'allow_versions'"
op|','
string|"'f'"
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'save_headers'
op|'.'
name|'append'
op|'('
string|"'x-versions-location'"
op|')'
newline|'\n'
dedent|''
name|'swift'
op|'.'
name|'common'
op|'.'
name|'db'
op|'.'
name|'DB_PREALLOCATION'
op|'='
name|'config_true_value'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'db_preallocation'"
op|','
string|"'f'"
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_container_broker
dedent|''
name|'def'
name|'_get_container_broker'
op|'('
name|'self'
op|','
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Get a DB broker for the container.\n\n        :param drive: drive that holds the container\n        :param part: partition the container is in\n        :param account: account name\n        :param container: container name\n        :returns: ContainerBroker object\n        """'
newline|'\n'
name|'hsh'
op|'='
name|'hash_path'
op|'('
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'db_dir'
op|'='
name|'storage_directory'
op|'('
name|'DATADIR'
op|','
name|'part'
op|','
name|'hsh'
op|')'
newline|'\n'
name|'db_path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|','
name|'db_dir'
op|','
name|'hsh'
op|'+'
string|"'.db'"
op|')'
newline|'\n'
name|'kwargs'
op|'.'
name|'setdefault'
op|'('
string|"'account'"
op|','
name|'account'
op|')'
newline|'\n'
name|'kwargs'
op|'.'
name|'setdefault'
op|'('
string|"'container'"
op|','
name|'container'
op|')'
newline|'\n'
name|'kwargs'
op|'.'
name|'setdefault'
op|'('
string|"'logger'"
op|','
name|'self'
op|'.'
name|'logger'
op|')'
newline|'\n'
name|'return'
name|'ContainerBroker'
op|'('
name|'db_path'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
nl|'\n'
DECL|member|account_update
dedent|''
name|'def'
name|'account_update'
op|'('
name|'self'
op|','
name|'req'
op|','
name|'account'
op|','
name|'container'
op|','
name|'broker'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Update the account server(s) with latest container info.\n\n        :param req: swob.Request object\n        :param account: account name\n        :param container: container name\n        :param broker: container DB broker object\n        :returns: if all the account requests return a 404 error code,\n                  HTTPNotFound response object,\n                  if the account cannot be updated due to a malformed header,\n                  an HTTPBadRequest response object,\n                  otherwise None.\n        """'
newline|'\n'
name|'account_hosts'
op|'='
op|'['
name|'h'
op|'.'
name|'strip'
op|'('
op|')'
name|'for'
name|'h'
name|'in'
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Account-Host'"
op|','
string|"''"
op|')'
op|'.'
name|'split'
op|'('
string|"','"
op|')'
op|']'
newline|'\n'
name|'account_devices'
op|'='
op|'['
name|'d'
op|'.'
name|'strip'
op|'('
op|')'
name|'for'
name|'d'
name|'in'
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Account-Device'"
op|','
string|"''"
op|')'
op|'.'
name|'split'
op|'('
string|"','"
op|')'
op|']'
newline|'\n'
name|'account_partition'
op|'='
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Account-Partition'"
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'account_hosts'
op|')'
op|'!='
name|'len'
op|'('
name|'account_devices'
op|')'
op|':'
newline|'\n'
comment|"# This shouldn't happen unless there's a bug in the proxy,"
nl|'\n'
comment|'# but if there is, we want to know about it.'
nl|'\n'
indent|'            '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|"'ERROR Account update failed: different  '"
nl|'\n'
string|"'numbers of hosts and devices in request: '"
nl|'\n'
string|'\'"%s" vs "%s"\''
op|'%'
nl|'\n'
op|'('
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Account-Host'"
op|','
string|"''"
op|')'
op|','
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Account-Device'"
op|','
string|"''"
op|')'
op|')'
op|')'
op|')'
newline|'\n'
name|'return'
name|'HTTPBadRequest'
op|'('
name|'req'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'account_partition'
op|':'
newline|'\n'
indent|'            '
name|'updates'
op|'='
name|'zip'
op|'('
name|'account_hosts'
op|','
name|'account_devices'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'updates'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'account_404s'
op|'='
number|'0'
newline|'\n'
nl|'\n'
name|'for'
name|'account_host'
op|','
name|'account_device'
name|'in'
name|'updates'
op|':'
newline|'\n'
indent|'            '
name|'account_ip'
op|','
name|'account_port'
op|'='
name|'account_host'
op|'.'
name|'rsplit'
op|'('
string|"':'"
op|','
number|'1'
op|')'
newline|'\n'
name|'new_path'
op|'='
string|"'/'"
op|'+'
string|"'/'"
op|'.'
name|'join'
op|'('
op|'['
name|'account'
op|','
name|'container'
op|']'
op|')'
newline|'\n'
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'account_headers'
op|'='
name|'HeaderKeyDict'
op|'('
op|'{'
nl|'\n'
string|"'x-put-timestamp'"
op|':'
name|'info'
op|'['
string|"'put_timestamp'"
op|']'
op|','
nl|'\n'
string|"'x-delete-timestamp'"
op|':'
name|'info'
op|'['
string|"'delete_timestamp'"
op|']'
op|','
nl|'\n'
string|"'x-object-count'"
op|':'
name|'info'
op|'['
string|"'object_count'"
op|']'
op|','
nl|'\n'
string|"'x-bytes-used'"
op|':'
name|'info'
op|'['
string|"'bytes_used'"
op|']'
op|','
nl|'\n'
string|"'x-trans-id'"
op|':'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-trans-id'"
op|','
string|"'-'"
op|')'
op|','
nl|'\n'
string|"'user-agent'"
op|':'
string|"'container-server %s'"
op|'%'
name|'os'
op|'.'
name|'getpid'
op|'('
op|')'
op|','
nl|'\n'
string|"'referer'"
op|':'
name|'req'
op|'.'
name|'as_referer'
op|'('
op|')'
op|'}'
op|')'
newline|'\n'
name|'if'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-account-override-deleted'"
op|','
string|"'no'"
op|')'
op|'.'
name|'lower'
op|'('
op|')'
op|'=='
string|"'yes'"
op|':'
newline|'\n'
indent|'                '
name|'account_headers'
op|'['
string|"'x-account-override-deleted'"
op|']'
op|'='
string|"'yes'"
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'with'
name|'ConnectionTimeout'
op|'('
name|'self'
op|'.'
name|'conn_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'conn'
op|'='
name|'http_connect'
op|'('
nl|'\n'
name|'account_ip'
op|','
name|'account_port'
op|','
name|'account_device'
op|','
nl|'\n'
name|'account_partition'
op|','
string|"'PUT'"
op|','
name|'new_path'
op|','
name|'account_headers'
op|')'
newline|'\n'
dedent|''
name|'with'
name|'Timeout'
op|'('
name|'self'
op|'.'
name|'node_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'account_response'
op|'='
name|'conn'
op|'.'
name|'getresponse'
op|'('
op|')'
newline|'\n'
name|'account_response'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'if'
name|'account_response'
op|'.'
name|'status'
op|'=='
name|'HTTP_NOT_FOUND'
op|':'
newline|'\n'
indent|'                        '
name|'account_404s'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'elif'
name|'not'
name|'is_success'
op|'('
name|'account_response'
op|'.'
name|'status'
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
nl|'\n'
string|"'ERROR Account update failed '"
nl|'\n'
string|"'with %(ip)s:%(port)s/%(device)s (will retry '"
nl|'\n'
string|"'later): Response %(status)s %(reason)s'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'ip'"
op|':'
name|'account_ip'
op|','
string|"'port'"
op|':'
name|'account_port'
op|','
nl|'\n'
string|"'device'"
op|':'
name|'account_device'
op|','
nl|'\n'
string|"'status'"
op|':'
name|'account_response'
op|'.'
name|'status'
op|','
nl|'\n'
string|"'reason'"
op|':'
name|'account_response'
op|'.'
name|'reason'
op|'}'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'except'
op|'('
name|'Exception'
op|','
name|'Timeout'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'exception'
op|'('
name|'_'
op|'('
nl|'\n'
string|"'ERROR account update failed with '"
nl|'\n'
string|"'%(ip)s:%(port)s/%(device)s (will retry later)'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'ip'"
op|':'
name|'account_ip'
op|','
string|"'port'"
op|':'
name|'account_port'
op|','
nl|'\n'
string|"'device'"
op|':'
name|'account_device'
op|'}'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'updates'
name|'and'
name|'account_404s'
op|'=='
name|'len'
op|'('
name|'updates'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'req'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'public'
newline|'\n'
op|'@'
name|'timing_stats'
op|'('
op|')'
newline|'\n'
DECL|member|DELETE
name|'def'
name|'DELETE'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handle HTTP DELETE request."""'
newline|'\n'
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|'='
name|'split_and_validate_path'
op|'('
nl|'\n'
name|'req'
op|','
number|'4'
op|','
number|'5'
op|','
name|'True'
op|')'
newline|'\n'
name|'if'
string|"'x-timestamp'"
name|'not'
name|'in'
name|'req'
op|'.'
name|'headers'
name|'or'
name|'not'
name|'check_float'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-timestamp'"
op|']'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'body'
op|'='
string|"'Missing timestamp'"
op|','
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'content_type'
op|'='
string|"'text/plain'"
op|')'
newline|'\n'
dedent|''
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPInsufficientStorage'
op|'('
name|'drive'
op|'='
name|'drive'
op|','
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_container_broker'
op|'('
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'if'
name|'account'
op|'.'
name|'startswith'
op|'('
name|'self'
op|'.'
name|'auto_create_account_prefix'
op|')'
name|'and'
name|'obj'
name|'and'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'broker'
op|'.'
name|'db_file'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'normalize_timestamp'
op|'('
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-timestamp'"
op|')'
name|'or'
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'db'
op|'.'
name|'DatabaseAlreadyExists'
op|':'
newline|'\n'
indent|'                '
name|'pass'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'broker'
op|'.'
name|'db_file'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
op|')'
newline|'\n'
dedent|''
name|'if'
name|'obj'
op|':'
comment|'# delete object'
newline|'\n'
indent|'            '
name|'broker'
op|'.'
name|'delete_object'
op|'('
name|'obj'
op|','
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-timestamp'"
op|')'
op|')'
newline|'\n'
name|'return'
name|'HTTPNoContent'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|'# delete container'
nl|'\n'
indent|'            '
name|'if'
name|'not'
name|'broker'
op|'.'
name|'empty'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPConflict'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'existed'
op|'='
name|'float'
op|'('
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
op|'['
string|"'put_timestamp'"
op|']'
op|')'
name|'and'
name|'not'
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'delete_db'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'X-Timestamp'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPConflict'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'resp'
op|'='
name|'self'
op|'.'
name|'account_update'
op|'('
name|'req'
op|','
name|'account'
op|','
name|'container'
op|','
name|'broker'
op|')'
newline|'\n'
name|'if'
name|'resp'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'resp'
newline|'\n'
dedent|''
name|'if'
name|'existed'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPNoContent'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'HTTPNotFound'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'public'
newline|'\n'
op|'@'
name|'timing_stats'
op|'('
op|')'
newline|'\n'
DECL|member|PUT
name|'def'
name|'PUT'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handle HTTP PUT request."""'
newline|'\n'
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|'='
name|'split_and_validate_path'
op|'('
nl|'\n'
name|'req'
op|','
number|'4'
op|','
number|'5'
op|','
name|'True'
op|')'
newline|'\n'
name|'if'
string|"'x-timestamp'"
name|'not'
name|'in'
name|'req'
op|'.'
name|'headers'
name|'or'
name|'not'
name|'check_float'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-timestamp'"
op|']'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'body'
op|'='
string|"'Missing timestamp'"
op|','
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'content_type'
op|'='
string|"'text/plain'"
op|')'
newline|'\n'
dedent|''
name|'if'
string|"'x-container-sync-to'"
name|'in'
name|'req'
op|'.'
name|'headers'
op|':'
newline|'\n'
indent|'            '
name|'err'
op|'='
name|'validate_sync_to'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-container-sync-to'"
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'allowed_sync_hosts'
op|')'
newline|'\n'
name|'if'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'err'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPInsufficientStorage'
op|'('
name|'drive'
op|'='
name|'drive'
op|','
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'timestamp'
op|'='
name|'normalize_timestamp'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-timestamp'"
op|']'
op|')'
newline|'\n'
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_container_broker'
op|'('
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'if'
name|'obj'
op|':'
comment|'# put container object'
newline|'\n'
indent|'            '
name|'if'
name|'account'
op|'.'
name|'startswith'
op|'('
name|'self'
op|'.'
name|'auto_create_account_prefix'
op|')'
name|'and'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'broker'
op|'.'
name|'db_file'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'timestamp'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'db'
op|'.'
name|'DatabaseAlreadyExists'
op|':'
newline|'\n'
indent|'                    '
name|'pass'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'broker'
op|'.'
name|'db_file'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPNotFound'
op|'('
op|')'
newline|'\n'
dedent|''
name|'broker'
op|'.'
name|'put_object'
op|'('
name|'obj'
op|','
name|'timestamp'
op|','
name|'int'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-size'"
op|']'
op|')'
op|','
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-content-type'"
op|']'
op|','
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-etag'"
op|']'
op|')'
newline|'\n'
name|'return'
name|'HTTPCreated'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
comment|'# put container'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'broker'
op|'.'
name|'db_file'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'timestamp'
op|')'
newline|'\n'
name|'created'
op|'='
name|'True'
newline|'\n'
dedent|''
name|'except'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'db'
op|'.'
name|'DatabaseAlreadyExists'
op|':'
newline|'\n'
indent|'                    '
name|'pass'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'created'
op|'='
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'update_put_timestamp'
op|'('
name|'timestamp'
op|')'
newline|'\n'
name|'if'
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'return'
name|'HTTPConflict'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'metadata'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'metadata'
op|'.'
name|'update'
op|'('
nl|'\n'
op|'('
name|'key'
op|','
op|'('
name|'value'
op|','
name|'timestamp'
op|')'
op|')'
nl|'\n'
name|'for'
name|'key'
op|','
name|'value'
name|'in'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'iteritems'
op|'('
op|')'
nl|'\n'
name|'if'
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
name|'in'
name|'self'
op|'.'
name|'save_headers'
name|'or'
nl|'\n'
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
op|'.'
name|'startswith'
op|'('
string|"'x-container-meta-'"
op|')'
op|')'
newline|'\n'
name|'if'
name|'metadata'
op|':'
newline|'\n'
indent|'                '
name|'if'
string|"'X-Container-Sync-To'"
name|'in'
name|'metadata'
op|':'
newline|'\n'
indent|'                    '
name|'if'
string|"'X-Container-Sync-To'"
name|'not'
name|'in'
name|'broker'
op|'.'
name|'metadata'
name|'or'
name|'metadata'
op|'['
string|"'X-Container-Sync-To'"
op|']'
op|'['
number|'0'
op|']'
op|'!='
name|'broker'
op|'.'
name|'metadata'
op|'['
string|"'X-Container-Sync-To'"
op|']'
op|'['
number|'0'
op|']'
op|':'
newline|'\n'
indent|'                        '
name|'broker'
op|'.'
name|'set_x_container_sync_points'
op|'('
op|'-'
number|'1'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'broker'
op|'.'
name|'update_metadata'
op|'('
name|'metadata'
op|')'
newline|'\n'
dedent|''
name|'resp'
op|'='
name|'self'
op|'.'
name|'account_update'
op|'('
name|'req'
op|','
name|'account'
op|','
name|'container'
op|','
name|'broker'
op|')'
newline|'\n'
name|'if'
name|'resp'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'resp'
newline|'\n'
dedent|''
name|'if'
name|'created'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPCreated'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPAccepted'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
op|'@'
name|'public'
newline|'\n'
op|'@'
name|'timing_stats'
op|'('
name|'sample_rate'
op|'='
number|'0.1'
op|')'
newline|'\n'
DECL|member|HEAD
name|'def'
name|'HEAD'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handle HTTP HEAD request."""'
newline|'\n'
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|'='
name|'split_and_validate_path'
op|'('
nl|'\n'
name|'req'
op|','
number|'4'
op|','
number|'5'
op|','
name|'True'
op|')'
newline|'\n'
name|'out_content_type'
op|'='
name|'get_listing_content_type'
op|'('
name|'req'
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPInsufficientStorage'
op|'('
name|'drive'
op|'='
name|'drive'
op|','
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_container_broker'
op|'('
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
nl|'\n'
name|'pending_timeout'
op|'='
number|'0.1'
op|','
nl|'\n'
name|'stale_reads_ok'
op|'='
name|'True'
op|')'
newline|'\n'
name|'if'
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'headers'
op|'='
op|'{'
nl|'\n'
string|"'X-Container-Object-Count'"
op|':'
name|'info'
op|'['
string|"'object_count'"
op|']'
op|','
nl|'\n'
string|"'X-Container-Bytes-Used'"
op|':'
name|'info'
op|'['
string|"'bytes_used'"
op|']'
op|','
nl|'\n'
string|"'X-Timestamp'"
op|':'
name|'info'
op|'['
string|"'created_at'"
op|']'
op|','
nl|'\n'
string|"'X-PUT-Timestamp'"
op|':'
name|'info'
op|'['
string|"'put_timestamp'"
op|']'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'headers'
op|'.'
name|'update'
op|'('
nl|'\n'
op|'('
name|'key'
op|','
name|'value'
op|')'
nl|'\n'
name|'for'
name|'key'
op|','
op|'('
name|'value'
op|','
name|'timestamp'
op|')'
name|'in'
name|'broker'
op|'.'
name|'metadata'
op|'.'
name|'iteritems'
op|'('
op|')'
nl|'\n'
name|'if'
name|'value'
op|'!='
string|"''"
name|'and'
op|'('
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
name|'in'
name|'self'
op|'.'
name|'save_headers'
name|'or'
nl|'\n'
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
op|'.'
name|'startswith'
op|'('
string|"'x-container-meta-'"
op|')'
op|')'
op|')'
newline|'\n'
name|'headers'
op|'['
string|"'Content-Type'"
op|']'
op|'='
name|'out_content_type'
newline|'\n'
name|'return'
name|'HTTPNoContent'
op|'('
name|'request'
op|'='
name|'req'
op|','
name|'headers'
op|'='
name|'headers'
op|','
name|'charset'
op|'='
string|"'utf-8'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|update_data_record
dedent|''
name|'def'
name|'update_data_record'
op|'('
name|'self'
op|','
name|'record'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Perform any mutations to container listing records that are common to\n        all serialization formats, and returns it as a dict.\n\n        Converts created time to iso timestamp.\n        Replaces size with \'swift_bytes\' content type parameter.\n\n        :params record: object entry record\n        :returns: modified record\n        """'
newline|'\n'
op|'('
name|'name'
op|','
name|'created'
op|','
name|'size'
op|','
name|'content_type'
op|','
name|'etag'
op|')'
op|'='
name|'record'
newline|'\n'
name|'if'
name|'content_type'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'subdir'"
op|':'
name|'name'
op|'}'
newline|'\n'
dedent|''
name|'response'
op|'='
op|'{'
string|"'bytes'"
op|':'
name|'size'
op|','
string|"'hash'"
op|':'
name|'etag'
op|','
string|"'name'"
op|':'
name|'name'
op|'}'
newline|'\n'
name|'last_modified'
op|'='
name|'datetime'
op|'.'
name|'utcfromtimestamp'
op|'('
name|'float'
op|'('
name|'created'
op|')'
op|')'
op|'.'
name|'isoformat'
op|'('
op|')'
newline|'\n'
comment|"# python isoformat() doesn't include msecs when zero"
nl|'\n'
name|'if'
name|'len'
op|'('
name|'last_modified'
op|')'
op|'<'
name|'len'
op|'('
string|'"1970-01-01T00:00:00.000000"'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'last_modified'
op|'+='
string|'".000000"'
newline|'\n'
dedent|''
name|'response'
op|'['
string|"'last_modified'"
op|']'
op|'='
name|'last_modified'
newline|'\n'
name|'content_type'
op|','
name|'params'
op|'='
name|'parse_content_type'
op|'('
name|'content_type'
op|')'
newline|'\n'
name|'for'
name|'key'
op|','
name|'value'
name|'in'
name|'params'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'key'
op|'=='
string|"'swift_bytes'"
op|':'
newline|'\n'
indent|'                '
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'response'
op|'['
string|"'bytes'"
op|']'
op|'='
name|'int'
op|'('
name|'value'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'exception'
op|'('
string|'"Invalid swift_bytes"'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'content_type'
op|'+='
string|"';%s=%s'"
op|'%'
op|'('
name|'key'
op|','
name|'value'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'response'
op|'['
string|"'content_type'"
op|']'
op|'='
name|'content_type'
newline|'\n'
name|'return'
name|'response'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
op|'@'
name|'timing_stats'
op|'('
op|')'
newline|'\n'
DECL|member|GET
name|'def'
name|'GET'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handle HTTP GET request."""'
newline|'\n'
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|'='
name|'split_and_validate_path'
op|'('
nl|'\n'
name|'req'
op|','
number|'4'
op|','
number|'5'
op|','
name|'True'
op|')'
newline|'\n'
name|'path'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'path'"
op|')'
newline|'\n'
name|'prefix'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'prefix'"
op|')'
newline|'\n'
name|'delimiter'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'delimiter'"
op|')'
newline|'\n'
name|'if'
name|'delimiter'
name|'and'
op|'('
name|'len'
op|'('
name|'delimiter'
op|')'
op|'>'
number|'1'
name|'or'
name|'ord'
op|'('
name|'delimiter'
op|')'
op|'>'
number|'254'
op|')'
op|':'
newline|'\n'
comment|'# delimiters can be made more flexible later'
nl|'\n'
indent|'            '
name|'return'
name|'HTTPPreconditionFailed'
op|'('
name|'body'
op|'='
string|"'Bad delimiter'"
op|')'
newline|'\n'
dedent|''
name|'marker'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'marker'"
op|','
string|"''"
op|')'
newline|'\n'
name|'end_marker'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'end_marker'"
op|')'
newline|'\n'
name|'limit'
op|'='
name|'CONTAINER_LISTING_LIMIT'
newline|'\n'
name|'given_limit'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'limit'"
op|')'
newline|'\n'
name|'if'
name|'given_limit'
name|'and'
name|'given_limit'
op|'.'
name|'isdigit'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'limit'
op|'='
name|'int'
op|'('
name|'given_limit'
op|')'
newline|'\n'
name|'if'
name|'limit'
op|'>'
name|'CONTAINER_LISTING_LIMIT'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPPreconditionFailed'
op|'('
nl|'\n'
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'body'
op|'='
string|"'Maximum limit is %d'"
op|'%'
name|'CONTAINER_LISTING_LIMIT'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'out_content_type'
op|'='
name|'get_listing_content_type'
op|'('
name|'req'
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPInsufficientStorage'
op|'('
name|'drive'
op|'='
name|'drive'
op|','
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_container_broker'
op|'('
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
nl|'\n'
name|'pending_timeout'
op|'='
number|'0.1'
op|','
nl|'\n'
name|'stale_reads_ok'
op|'='
name|'True'
op|')'
newline|'\n'
name|'if'
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'resp_headers'
op|'='
op|'{'
nl|'\n'
string|"'X-Container-Object-Count'"
op|':'
name|'info'
op|'['
string|"'object_count'"
op|']'
op|','
nl|'\n'
string|"'X-Container-Bytes-Used'"
op|':'
name|'info'
op|'['
string|"'bytes_used'"
op|']'
op|','
nl|'\n'
string|"'X-Timestamp'"
op|':'
name|'info'
op|'['
string|"'created_at'"
op|']'
op|','
nl|'\n'
string|"'X-PUT-Timestamp'"
op|':'
name|'info'
op|'['
string|"'put_timestamp'"
op|']'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'for'
name|'key'
op|','
op|'('
name|'value'
op|','
name|'timestamp'
op|')'
name|'in'
name|'broker'
op|'.'
name|'metadata'
op|'.'
name|'iteritems'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'value'
name|'and'
op|'('
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
name|'in'
name|'self'
op|'.'
name|'save_headers'
name|'or'
nl|'\n'
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
op|'.'
name|'startswith'
op|'('
string|"'x-container-meta-'"
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'resp_headers'
op|'['
name|'key'
op|']'
op|'='
name|'value'
newline|'\n'
dedent|''
dedent|''
name|'ret'
op|'='
name|'Response'
op|'('
name|'request'
op|'='
name|'req'
op|','
name|'headers'
op|'='
name|'resp_headers'
op|','
nl|'\n'
name|'content_type'
op|'='
name|'out_content_type'
op|','
name|'charset'
op|'='
string|"'utf-8'"
op|')'
newline|'\n'
name|'container_list'
op|'='
name|'broker'
op|'.'
name|'list_objects_iter'
op|'('
name|'limit'
op|','
name|'marker'
op|','
name|'end_marker'
op|','
nl|'\n'
name|'prefix'
op|','
name|'delimiter'
op|','
name|'path'
op|')'
newline|'\n'
name|'if'
name|'out_content_type'
op|'=='
string|"'application/json'"
op|':'
newline|'\n'
indent|'            '
name|'ret'
op|'.'
name|'body'
op|'='
name|'json'
op|'.'
name|'dumps'
op|'('
op|'['
name|'self'
op|'.'
name|'update_data_record'
op|'('
name|'record'
op|')'
nl|'\n'
name|'for'
name|'record'
name|'in'
name|'container_list'
op|']'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'out_content_type'
op|'.'
name|'endswith'
op|'('
string|"'/xml'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'doc'
op|'='
name|'Element'
op|'('
string|"'container'"
op|','
name|'name'
op|'='
name|'container'
op|'.'
name|'decode'
op|'('
string|"'utf-8'"
op|')'
op|')'
newline|'\n'
name|'for'
name|'obj'
name|'in'
name|'container_list'
op|':'
newline|'\n'
indent|'                '
name|'record'
op|'='
name|'self'
op|'.'
name|'update_data_record'
op|'('
name|'obj'
op|')'
newline|'\n'
name|'if'
string|"'subdir'"
name|'in'
name|'record'
op|':'
newline|'\n'
indent|'                    '
name|'name'
op|'='
name|'record'
op|'['
string|"'subdir'"
op|']'
op|'.'
name|'decode'
op|'('
string|"'utf-8'"
op|')'
newline|'\n'
name|'sub'
op|'='
name|'SubElement'
op|'('
name|'doc'
op|','
string|"'subdir'"
op|','
name|'name'
op|'='
name|'name'
op|')'
newline|'\n'
name|'SubElement'
op|'('
name|'sub'
op|','
string|"'name'"
op|')'
op|'.'
name|'text'
op|'='
name|'name'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'obj_element'
op|'='
name|'SubElement'
op|'('
name|'doc'
op|','
string|"'object'"
op|')'
newline|'\n'
name|'for'
name|'field'
name|'in'
op|'['
string|'"name"'
op|','
string|'"hash"'
op|','
string|'"bytes"'
op|','
string|'"content_type"'
op|','
nl|'\n'
string|'"last_modified"'
op|']'
op|':'
newline|'\n'
indent|'                        '
name|'SubElement'
op|'('
name|'obj_element'
op|','
name|'field'
op|')'
op|'.'
name|'text'
op|'='
name|'str'
op|'('
nl|'\n'
name|'record'
op|'.'
name|'pop'
op|'('
name|'field'
op|')'
op|')'
op|'.'
name|'decode'
op|'('
string|"'utf-8'"
op|')'
newline|'\n'
dedent|''
name|'for'
name|'field'
name|'in'
name|'sorted'
op|'('
name|'record'
op|'.'
name|'keys'
op|'('
op|')'
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'SubElement'
op|'('
name|'obj_element'
op|','
name|'field'
op|')'
op|'.'
name|'text'
op|'='
name|'str'
op|'('
nl|'\n'
name|'record'
op|'['
name|'field'
op|']'
op|')'
op|'.'
name|'decode'
op|'('
string|"'utf-8'"
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'ret'
op|'.'
name|'body'
op|'='
name|'tostring'
op|'('
name|'doc'
op|','
name|'encoding'
op|'='
string|"'UTF-8'"
op|')'
op|'.'
name|'replace'
op|'('
nl|'\n'
string|'"<?xml version=\'1.0\' encoding=\'UTF-8\'?>"'
op|','
nl|'\n'
string|'\'<?xml version="1.0" encoding="UTF-8"?>\''
op|','
number|'1'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'container_list'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPNoContent'
op|'('
name|'request'
op|'='
name|'req'
op|','
name|'headers'
op|'='
name|'resp_headers'
op|')'
newline|'\n'
dedent|''
name|'ret'
op|'.'
name|'body'
op|'='
string|"'\\n'"
op|'.'
name|'join'
op|'('
name|'rec'
op|'['
number|'0'
op|']'
name|'for'
name|'rec'
name|'in'
name|'container_list'
op|')'
op|'+'
string|"'\\n'"
newline|'\n'
dedent|''
name|'return'
name|'ret'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
op|'@'
name|'replication'
newline|'\n'
op|'@'
name|'timing_stats'
op|'('
name|'sample_rate'
op|'='
number|'0.01'
op|')'
newline|'\n'
DECL|member|REPLICATE
name|'def'
name|'REPLICATE'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Handle HTTP REPLICATE request (json-encoded RPC calls for replication.)\n        """'
newline|'\n'
name|'post_args'
op|'='
name|'split_and_validate_path'
op|'('
name|'req'
op|','
number|'3'
op|')'
newline|'\n'
name|'drive'
op|','
name|'partition'
op|','
name|'hash'
op|'='
name|'post_args'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPInsufficientStorage'
op|'('
name|'drive'
op|'='
name|'drive'
op|','
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'args'
op|'='
name|'json'
op|'.'
name|'load'
op|'('
name|'req'
op|'.'
name|'environ'
op|'['
string|"'wsgi.input'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'body'
op|'='
name|'str'
op|'('
name|'err'
op|')'
op|','
name|'content_type'
op|'='
string|"'text/plain'"
op|')'
newline|'\n'
dedent|''
name|'ret'
op|'='
name|'self'
op|'.'
name|'replicator_rpc'
op|'.'
name|'dispatch'
op|'('
name|'post_args'
op|','
name|'args'
op|')'
newline|'\n'
name|'ret'
op|'.'
name|'request'
op|'='
name|'req'
newline|'\n'
name|'return'
name|'ret'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
op|'@'
name|'timing_stats'
op|'('
op|')'
newline|'\n'
DECL|member|POST
name|'def'
name|'POST'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handle HTTP POST request."""'
newline|'\n'
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|'='
name|'split_and_validate_path'
op|'('
name|'req'
op|','
number|'4'
op|')'
newline|'\n'
name|'if'
string|"'x-timestamp'"
name|'not'
name|'in'
name|'req'
op|'.'
name|'headers'
name|'or'
name|'not'
name|'check_float'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-timestamp'"
op|']'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'body'
op|'='
string|"'Missing or bad timestamp'"
op|','
nl|'\n'
name|'request'
op|'='
name|'req'
op|','
name|'content_type'
op|'='
string|"'text/plain'"
op|')'
newline|'\n'
dedent|''
name|'if'
string|"'x-container-sync-to'"
name|'in'
name|'req'
op|'.'
name|'headers'
op|':'
newline|'\n'
indent|'            '
name|'err'
op|'='
name|'validate_sync_to'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-container-sync-to'"
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'allowed_sync_hosts'
op|')'
newline|'\n'
name|'if'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'err'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPInsufficientStorage'
op|'('
name|'drive'
op|'='
name|'drive'
op|','
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_container_broker'
op|'('
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'if'
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'timestamp'
op|'='
name|'normalize_timestamp'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-timestamp'"
op|']'
op|')'
newline|'\n'
name|'metadata'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'metadata'
op|'.'
name|'update'
op|'('
nl|'\n'
op|'('
name|'key'
op|','
op|'('
name|'value'
op|','
name|'timestamp'
op|')'
op|')'
name|'for'
name|'key'
op|','
name|'value'
name|'in'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'iteritems'
op|'('
op|')'
nl|'\n'
name|'if'
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
name|'in'
name|'self'
op|'.'
name|'save_headers'
name|'or'
nl|'\n'
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
op|'.'
name|'startswith'
op|'('
string|"'x-container-meta-'"
op|')'
op|')'
newline|'\n'
name|'if'
name|'metadata'
op|':'
newline|'\n'
indent|'            '
name|'if'
string|"'X-Container-Sync-To'"
name|'in'
name|'metadata'
op|':'
newline|'\n'
indent|'                '
name|'if'
string|"'X-Container-Sync-To'"
name|'not'
name|'in'
name|'broker'
op|'.'
name|'metadata'
name|'or'
name|'metadata'
op|'['
string|"'X-Container-Sync-To'"
op|']'
op|'['
number|'0'
op|']'
op|'!='
name|'broker'
op|'.'
name|'metadata'
op|'['
string|"'X-Container-Sync-To'"
op|']'
op|'['
number|'0'
op|']'
op|':'
newline|'\n'
indent|'                    '
name|'broker'
op|'.'
name|'set_x_container_sync_points'
op|'('
op|'-'
number|'1'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'broker'
op|'.'
name|'update_metadata'
op|'('
name|'metadata'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'HTTPNoContent'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__call__
dedent|''
name|'def'
name|'__call__'
op|'('
name|'self'
op|','
name|'env'
op|','
name|'start_response'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'start_time'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'req'
op|'='
name|'Request'
op|'('
name|'env'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'logger'
op|'.'
name|'txn_id'
op|'='
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-trans-id'"
op|','
name|'None'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'check_utf8'
op|'('
name|'req'
op|'.'
name|'path_info'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'res'
op|'='
name|'HTTPPreconditionFailed'
op|'('
name|'body'
op|'='
string|"'Invalid UTF8 or contains NULL'"
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
comment|"# disallow methods which have not been marked 'public'"
nl|'\n'
indent|'                '
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'method'
op|'='
name|'getattr'
op|'('
name|'self'
op|','
name|'req'
op|'.'
name|'method'
op|')'
newline|'\n'
name|'getattr'
op|'('
name|'method'
op|','
string|"'publicly_accessible'"
op|')'
newline|'\n'
name|'replication_method'
op|'='
name|'getattr'
op|'('
name|'method'
op|','
string|"'replication'"
op|','
name|'False'
op|')'
newline|'\n'
name|'if'
op|'('
name|'self'
op|'.'
name|'replication_server'
name|'is'
name|'not'
name|'None'
name|'and'
nl|'\n'
name|'self'
op|'.'
name|'replication_server'
op|'!='
name|'replication_method'
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'raise'
name|'AttributeError'
op|'('
string|"'Not allowed method.'"
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'AttributeError'
op|':'
newline|'\n'
indent|'                    '
name|'res'
op|'='
name|'HTTPMethodNotAllowed'
op|'('
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'res'
op|'='
name|'method'
op|'('
name|'req'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'HTTPException'
name|'as'
name|'error_response'
op|':'
newline|'\n'
indent|'                '
name|'res'
op|'='
name|'error_response'
newline|'\n'
dedent|''
name|'except'
op|'('
name|'Exception'
op|','
name|'Timeout'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'exception'
op|'('
name|'_'
op|'('
nl|'\n'
string|"'ERROR __call__ error with %(method)s %(path)s '"
op|')'
op|','
nl|'\n'
op|'{'
string|"'method'"
op|':'
name|'req'
op|'.'
name|'method'
op|','
string|"'path'"
op|':'
name|'req'
op|'.'
name|'path'
op|'}'
op|')'
newline|'\n'
name|'res'
op|'='
name|'HTTPInternalServerError'
op|'('
name|'body'
op|'='
name|'traceback'
op|'.'
name|'format_exc'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'trans_time'
op|'='
string|"'%.4f'"
op|'%'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'-'
name|'start_time'
op|')'
newline|'\n'
name|'log_message'
op|'='
string|'\'%s - - [%s] "%s %s" %s %s "%s" "%s" "%s" %s\''
op|'%'
op|'('
nl|'\n'
name|'req'
op|'.'
name|'remote_addr'
op|','
nl|'\n'
name|'time'
op|'.'
name|'strftime'
op|'('
string|"'%d/%b/%Y:%H:%M:%S +0000'"
op|','
nl|'\n'
name|'time'
op|'.'
name|'gmtime'
op|'('
op|')'
op|')'
op|','
nl|'\n'
name|'req'
op|'.'
name|'method'
op|','
name|'req'
op|'.'
name|'path'
op|','
nl|'\n'
name|'res'
op|'.'
name|'status'
op|'.'
name|'split'
op|'('
op|')'
op|'['
number|'0'
op|']'
op|','
name|'res'
op|'.'
name|'content_length'
name|'or'
string|"'-'"
op|','
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-trans-id'"
op|','
string|"'-'"
op|')'
op|','
nl|'\n'
name|'req'
op|'.'
name|'referer'
name|'or'
string|"'-'"
op|','
name|'req'
op|'.'
name|'user_agent'
name|'or'
string|"'-'"
op|','
nl|'\n'
name|'trans_time'
op|')'
newline|'\n'
name|'if'
name|'req'
op|'.'
name|'method'
op|'.'
name|'upper'
op|'('
op|')'
op|'=='
string|"'REPLICATE'"
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'debug'
op|'('
name|'log_message'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'info'
op|'('
name|'log_message'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'res'
op|'('
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|app_factory
dedent|''
dedent|''
name|'def'
name|'app_factory'
op|'('
name|'global_conf'
op|','
op|'**'
name|'local_conf'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""paste.deploy app factory for creating WSGI container server apps"""'
newline|'\n'
name|'conf'
op|'='
name|'global_conf'
op|'.'
name|'copy'
op|'('
op|')'
newline|'\n'
name|'conf'
op|'.'
name|'update'
op|'('
name|'local_conf'
op|')'
newline|'\n'
name|'return'
name|'ContainerController'
op|'('
name|'conf'
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit

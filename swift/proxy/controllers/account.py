begin_unit
comment|'# Copyright (c) 2010-2012 OpenStack, LLC.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
comment|'# NOTE: swift_conn'
nl|'\n'
comment|"# You'll see swift_conn passed around a few places in this file. This is the"
nl|'\n'
comment|'# source httplib connection of whatever it is attached to.'
nl|'\n'
comment|'#   It is used when early termination of reading from the connection should'
nl|'\n'
comment|"# happen, such as when a range request is satisfied but there's still more the"
nl|'\n'
comment|'# source connection would like to send. To prevent having to read all the data'
nl|'\n'
comment|'# that could be left, the source connection can be .close() and then reads'
nl|'\n'
comment|'# commence to empty out any buffers.'
nl|'\n'
comment|'#   These shenanigans are to ensure all related objects can be garbage'
nl|'\n'
comment|"# collected. We've seen objects hang around forever otherwise."
nl|'\n'
nl|'\n'
name|'import'
name|'time'
newline|'\n'
name|'from'
name|'urllib'
name|'import'
name|'unquote'
newline|'\n'
nl|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'normalize_timestamp'
op|','
name|'public'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'constraints'
name|'import'
name|'check_metadata'
op|','
name|'MAX_ACCOUNT_NAME_LENGTH'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'http'
name|'import'
name|'is_success'
op|','
name|'HTTP_NOT_FOUND'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'proxy'
op|'.'
name|'controllers'
op|'.'
name|'base'
name|'import'
name|'Controller'
op|','
name|'get_account_memcache_key'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'swob'
name|'import'
name|'HTTPBadRequest'
op|','
name|'HTTPMethodNotAllowed'
op|','
name|'Request'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|AccountController
name|'class'
name|'AccountController'
op|'('
name|'Controller'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""WSGI controller for account requests"""'
newline|'\n'
DECL|variable|server_type
name|'server_type'
op|'='
string|"'Account'"
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'app'
op|','
name|'account_name'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'Controller'
op|'.'
name|'__init__'
op|'('
name|'self'
op|','
name|'app'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'account_name'
op|'='
name|'unquote'
op|'('
name|'account_name'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'self'
op|'.'
name|'app'
op|'.'
name|'allow_account_management'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'allowed_methods'
op|'.'
name|'remove'
op|'('
string|"'PUT'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'allowed_methods'
op|'.'
name|'remove'
op|'('
string|"'DELETE'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|GETorHEAD
dedent|''
dedent|''
name|'def'
name|'GETorHEAD'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handler for HTTP GET/HEAD requests."""'
newline|'\n'
name|'partition'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|'.'
name|'get_nodes'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
newline|'\n'
name|'resp'
op|'='
name|'self'
op|'.'
name|'GETorHEAD_base'
op|'('
nl|'\n'
name|'req'
op|','
name|'_'
op|'('
string|"'Account'"
op|')'
op|','
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|','
name|'partition'
op|','
nl|'\n'
name|'req'
op|'.'
name|'path_info'
op|'.'
name|'rstrip'
op|'('
string|"'/'"
op|')'
op|')'
newline|'\n'
name|'if'
name|'resp'
op|'.'
name|'status_int'
op|'=='
name|'HTTP_NOT_FOUND'
name|'and'
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_autocreate'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'len'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
op|'>'
name|'MAX_ACCOUNT_NAME_LENGTH'
op|':'
newline|'\n'
indent|'                '
name|'resp'
op|'='
name|'HTTPBadRequest'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
name|'resp'
op|'.'
name|'body'
op|'='
string|"'Account name length of %d longer than %d'"
op|'%'
op|'('
name|'len'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
op|','
name|'MAX_ACCOUNT_NAME_LENGTH'
op|')'
newline|'\n'
name|'return'
name|'resp'
newline|'\n'
dedent|''
name|'headers'
op|'='
op|'{'
string|"'X-Timestamp'"
op|':'
name|'normalize_timestamp'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|','
nl|'\n'
string|"'X-Trans-Id'"
op|':'
name|'self'
op|'.'
name|'trans_id'
op|','
nl|'\n'
string|"'Connection'"
op|':'
string|"'close'"
op|'}'
newline|'\n'
name|'resp'
op|'='
name|'self'
op|'.'
name|'make_requests'
op|'('
nl|'\n'
name|'Request'
op|'.'
name|'blank'
op|'('
string|"'/v1/'"
op|'+'
name|'self'
op|'.'
name|'account_name'
op|')'
op|','
nl|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|','
name|'partition'
op|','
string|"'PUT'"
op|','
nl|'\n'
string|"'/'"
op|'+'
name|'self'
op|'.'
name|'account_name'
op|','
op|'['
name|'headers'
op|']'
op|'*'
name|'len'
op|'('
name|'nodes'
op|')'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'is_success'
op|'('
name|'resp'
op|'.'
name|'status_int'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'warning'
op|'('
string|"'Could not autocreate account %r'"
op|'%'
nl|'\n'
name|'self'
op|'.'
name|'account_name'
op|')'
newline|'\n'
name|'return'
name|'resp'
newline|'\n'
dedent|''
name|'resp'
op|'='
name|'self'
op|'.'
name|'GETorHEAD_base'
op|'('
nl|'\n'
name|'req'
op|','
name|'_'
op|'('
string|"'Account'"
op|')'
op|','
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|','
name|'partition'
op|','
nl|'\n'
name|'req'
op|'.'
name|'path_info'
op|'.'
name|'rstrip'
op|'('
string|"'/'"
op|')'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'resp'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
DECL|member|PUT
name|'def'
name|'PUT'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""HTTP PUT request handler."""'
newline|'\n'
name|'if'
name|'not'
name|'self'
op|'.'
name|'app'
op|'.'
name|'allow_account_management'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPMethodNotAllowed'
op|'('
nl|'\n'
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'headers'
op|'='
op|'{'
string|"'Allow'"
op|':'
string|"', '"
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'allowed_methods'
op|')'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'error_response'
op|'='
name|'check_metadata'
op|'('
name|'req'
op|','
string|"'account'"
op|')'
newline|'\n'
name|'if'
name|'error_response'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'error_response'
newline|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
op|'>'
name|'MAX_ACCOUNT_NAME_LENGTH'
op|':'
newline|'\n'
indent|'            '
name|'resp'
op|'='
name|'HTTPBadRequest'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
name|'resp'
op|'.'
name|'body'
op|'='
string|"'Account name length of %d longer than %d'"
op|'%'
op|'('
name|'len'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
op|','
name|'MAX_ACCOUNT_NAME_LENGTH'
op|')'
newline|'\n'
name|'return'
name|'resp'
newline|'\n'
dedent|''
name|'account_partition'
op|','
name|'accounts'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|'.'
name|'get_nodes'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
newline|'\n'
name|'headers'
op|'='
op|'{'
string|"'X-Timestamp'"
op|':'
name|'normalize_timestamp'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|','
nl|'\n'
string|"'x-trans-id'"
op|':'
name|'self'
op|'.'
name|'trans_id'
op|','
nl|'\n'
string|"'Connection'"
op|':'
string|"'close'"
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'transfer_headers'
op|'('
name|'req'
op|'.'
name|'headers'
op|','
name|'headers'
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'app'
op|'.'
name|'memcache'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'app'
op|'.'
name|'memcache'
op|'.'
name|'delete'
op|'('
nl|'\n'
name|'get_account_memcache_key'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
op|')'
newline|'\n'
dedent|''
name|'resp'
op|'='
name|'self'
op|'.'
name|'make_requests'
op|'('
nl|'\n'
name|'req'
op|','
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|','
name|'account_partition'
op|','
string|"'PUT'"
op|','
nl|'\n'
name|'req'
op|'.'
name|'path_info'
op|','
op|'['
name|'headers'
op|']'
op|'*'
name|'len'
op|'('
name|'accounts'
op|')'
op|')'
newline|'\n'
name|'return'
name|'resp'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
DECL|member|POST
name|'def'
name|'POST'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""HTTP POST request handler."""'
newline|'\n'
name|'error_response'
op|'='
name|'check_metadata'
op|'('
name|'req'
op|','
string|"'account'"
op|')'
newline|'\n'
name|'if'
name|'error_response'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'error_response'
newline|'\n'
dedent|''
name|'account_partition'
op|','
name|'accounts'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|'.'
name|'get_nodes'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
newline|'\n'
name|'headers'
op|'='
op|'{'
string|"'X-Timestamp'"
op|':'
name|'normalize_timestamp'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|','
nl|'\n'
string|"'X-Trans-Id'"
op|':'
name|'self'
op|'.'
name|'trans_id'
op|','
nl|'\n'
string|"'Connection'"
op|':'
string|"'close'"
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'transfer_headers'
op|'('
name|'req'
op|'.'
name|'headers'
op|','
name|'headers'
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'app'
op|'.'
name|'memcache'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'app'
op|'.'
name|'memcache'
op|'.'
name|'delete'
op|'('
nl|'\n'
name|'get_account_memcache_key'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
op|')'
newline|'\n'
dedent|''
name|'resp'
op|'='
name|'self'
op|'.'
name|'make_requests'
op|'('
nl|'\n'
name|'req'
op|','
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|','
name|'account_partition'
op|','
string|"'POST'"
op|','
nl|'\n'
name|'req'
op|'.'
name|'path_info'
op|','
op|'['
name|'headers'
op|']'
op|'*'
name|'len'
op|'('
name|'accounts'
op|')'
op|')'
newline|'\n'
name|'if'
name|'resp'
op|'.'
name|'status_int'
op|'=='
name|'HTTP_NOT_FOUND'
name|'and'
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_autocreate'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'len'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
op|'>'
name|'MAX_ACCOUNT_NAME_LENGTH'
op|':'
newline|'\n'
indent|'                '
name|'resp'
op|'='
name|'HTTPBadRequest'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
name|'resp'
op|'.'
name|'body'
op|'='
string|"'Account name length of %d longer than %d'"
op|'%'
op|'('
name|'len'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
op|','
name|'MAX_ACCOUNT_NAME_LENGTH'
op|')'
newline|'\n'
name|'return'
name|'resp'
newline|'\n'
dedent|''
name|'resp'
op|'='
name|'self'
op|'.'
name|'make_requests'
op|'('
nl|'\n'
name|'Request'
op|'.'
name|'blank'
op|'('
string|"'/v1/'"
op|'+'
name|'self'
op|'.'
name|'account_name'
op|')'
op|','
nl|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|','
name|'account_partition'
op|','
string|"'PUT'"
op|','
nl|'\n'
string|"'/'"
op|'+'
name|'self'
op|'.'
name|'account_name'
op|','
op|'['
name|'headers'
op|']'
op|'*'
name|'len'
op|'('
name|'accounts'
op|')'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'is_success'
op|'('
name|'resp'
op|'.'
name|'status_int'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'warning'
op|'('
string|"'Could not autocreate account %r'"
op|'%'
nl|'\n'
name|'self'
op|'.'
name|'account_name'
op|')'
newline|'\n'
name|'return'
name|'resp'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'resp'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
DECL|member|DELETE
name|'def'
name|'DELETE'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""HTTP DELETE request handler."""'
newline|'\n'
comment|'# Extra safety in case someone typos a query string for an'
nl|'\n'
comment|'# account-level DELETE request that was really meant to be caught by'
nl|'\n'
comment|'# some middleware.'
nl|'\n'
name|'if'
name|'req'
op|'.'
name|'query_string'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'self'
op|'.'
name|'app'
op|'.'
name|'allow_account_management'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPMethodNotAllowed'
op|'('
nl|'\n'
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'headers'
op|'='
op|'{'
string|"'Allow'"
op|':'
string|"', '"
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'allowed_methods'
op|')'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'account_partition'
op|','
name|'accounts'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|'.'
name|'get_nodes'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
newline|'\n'
name|'headers'
op|'='
op|'{'
string|"'X-Timestamp'"
op|':'
name|'normalize_timestamp'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|','
nl|'\n'
string|"'X-Trans-Id'"
op|':'
name|'self'
op|'.'
name|'trans_id'
op|','
nl|'\n'
string|"'Connection'"
op|':'
string|"'close'"
op|'}'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'app'
op|'.'
name|'memcache'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'app'
op|'.'
name|'memcache'
op|'.'
name|'delete'
op|'('
nl|'\n'
name|'get_account_memcache_key'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
op|')'
newline|'\n'
dedent|''
name|'resp'
op|'='
name|'self'
op|'.'
name|'make_requests'
op|'('
nl|'\n'
name|'req'
op|','
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|','
name|'account_partition'
op|','
string|"'DELETE'"
op|','
nl|'\n'
name|'req'
op|'.'
name|'path_info'
op|','
op|'['
name|'headers'
op|']'
op|'*'
name|'len'
op|'('
name|'accounts'
op|')'
op|')'
newline|'\n'
name|'return'
name|'resp'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit

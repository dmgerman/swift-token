#!/usr/bin/python
# Copyright (c) 2010 OpenStack, LLC.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
# implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import sys
from ConfigParser import ConfigParser
import logging
import time

from eventlet import sleep, hubs
hubs.use_hub('poll')

from swift.obj.replicator import ObjectReplicator
from swift.common.utils import get_logger, drop_privileges, LoggerFileObject

TRUE_VALUES = set(('true', '1', 'yes', 'True', 'Yes'))

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print "Usage: object-replicator CONFIG_FILE [once]"
        sys.exit()
    c = ConfigParser()
    if not c.read(conf_file):
        print "Unable to read config file: %s" % conf_file
        sys.exit(1)
    if c.has_section('object-replicator'):
        conf = dict(c.items('object-replicator'))
    else:
        print "Unable to find object-replicator config section in %s" % \
            sys.argv[1]
        sys.exit(1)

    once = len(sys.argv) > 2 and sys.argv[2] == 'once'
    logger = get_logger(conf)
    # log uncaught exceptions
    sys.excepthook = lambda *exc_info: \
                logger.critical('UNCAUGHT EXCEPTION', exc_info=exc_info)
    sys.stdout = sys.stderr = LoggerFileObject(logger)
    drop_privileges(conf.get('user', 'swift'))
    if not once and conf.get('daemonize', 'true') in TRUE_VALUES:
        logger.info("Starting object replicator in daemon mode.")
        # Run the replicator continually
        while True:
            start = time.time()
            logger.info("Starting object replication pass.")
            # Run the replicator
            replicator = ObjectReplicator(conf, logger)
            replicator.run()
            total = (time.time() - start)/60
            # Reload the config
            logger.info("Object replication complete. (%.02f minutes)" % total)
            conf = read_configs(sys.argv[1])
            if conf.get('daemonize', 'true') not in TRUE_VALUES:
                # Stop running
                logger.info("Daemon mode turned off in config, stopping.")
                break
            logger.debug('Replication sleeping for %s seconds.' %
                conf['run_pause'])
            sleep(int(conf['run_pause']))
    else:
        start = time.time()
        logger.info("Running object replicator in script mode.")
        replicator = ObjectReplicator(conf, logger)
        replicator.run()
        total = (time.time() - start)/60
        logger.info("Object replication complete. (%.02f minutes)" % total)

begin_unit
comment|'# Copyright (c) 2010-2012 OpenStack Foundation'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'time'
newline|'\n'
name|'import'
name|'shutil'
newline|'\n'
name|'import'
name|'itertools'
newline|'\n'
name|'import'
name|'unittest'
newline|'\n'
name|'import'
name|'mock'
newline|'\n'
name|'import'
name|'random'
newline|'\n'
name|'import'
name|'sqlite3'
newline|'\n'
nl|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'db_replicator'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'container'
name|'import'
name|'replicator'
op|','
name|'backend'
op|','
name|'server'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'container'
op|'.'
name|'reconciler'
name|'import'
op|'('
nl|'\n'
name|'MISPLACED_OBJECTS_ACCOUNT'
op|','
name|'get_reconciler_container_name'
op|')'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'Timestamp'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'storage_policy'
name|'import'
name|'POLICIES'
newline|'\n'
nl|'\n'
name|'from'
name|'test'
op|'.'
name|'unit'
op|'.'
name|'common'
name|'import'
name|'test_db_replicator'
newline|'\n'
name|'from'
name|'test'
op|'.'
name|'unit'
name|'import'
name|'patch_policies'
op|','
name|'make_timestamp_iter'
newline|'\n'
name|'from'
name|'contextlib'
name|'import'
name|'contextmanager'
newline|'\n'
nl|'\n'
nl|'\n'
op|'@'
name|'patch_policies'
newline|'\n'
DECL|class|TestReplicatorSync
name|'class'
name|'TestReplicatorSync'
op|'('
name|'test_db_replicator'
op|'.'
name|'TestReplicatorSync'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|variable|backend
indent|'    '
name|'backend'
op|'='
name|'backend'
op|'.'
name|'ContainerBroker'
newline|'\n'
DECL|variable|datadir
name|'datadir'
op|'='
name|'server'
op|'.'
name|'DATADIR'
newline|'\n'
DECL|variable|replicator_daemon
name|'replicator_daemon'
op|'='
name|'replicator'
op|'.'
name|'ContainerReplicator'
newline|'\n'
DECL|variable|replicator_rpc
name|'replicator_rpc'
op|'='
name|'replicator'
op|'.'
name|'ContainerReplicatorRpc'
newline|'\n'
nl|'\n'
DECL|member|test_report_up_to_date
name|'def'
name|'test_report_up_to_date'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'Timestamp'
op|'('
number|'1'
op|')'
op|'.'
name|'internal'
op|','
name|'int'
op|'('
name|'POLICIES'
op|'.'
name|'default'
op|')'
op|')'
newline|'\n'
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'reported'
op|'('
name|'info'
op|'['
string|"'put_timestamp'"
op|']'
op|','
nl|'\n'
name|'info'
op|'['
string|"'delete_timestamp'"
op|']'
op|','
nl|'\n'
name|'info'
op|'['
string|"'object_count'"
op|']'
op|','
nl|'\n'
name|'info'
op|'['
string|"'bytes_used'"
op|']'
op|')'
newline|'\n'
name|'full_info'
op|'='
name|'broker'
op|'.'
name|'get_replication_info'
op|'('
op|')'
newline|'\n'
name|'expected_info'
op|'='
op|'{'
string|"'put_timestamp'"
op|':'
name|'Timestamp'
op|'('
number|'1'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
string|"'delete_timestamp'"
op|':'
string|"'0'"
op|','
nl|'\n'
string|"'count'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'bytes_used'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'reported_put_timestamp'"
op|':'
name|'Timestamp'
op|'('
number|'1'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
string|"'reported_delete_timestamp'"
op|':'
string|"'0'"
op|','
nl|'\n'
string|"'reported_object_count'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'reported_bytes_used'"
op|':'
number|'0'
op|'}'
newline|'\n'
name|'for'
name|'key'
op|','
name|'value'
name|'in'
name|'expected_info'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'msg'
op|'='
string|"'expected value for %r, %r != %r'"
op|'%'
op|'('
nl|'\n'
name|'key'
op|','
name|'full_info'
op|'['
name|'key'
op|']'
op|','
name|'value'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'full_info'
op|'['
name|'key'
op|']'
op|','
name|'value'
op|','
name|'msg'
op|')'
newline|'\n'
dedent|''
name|'repl'
op|'='
name|'replicator'
op|'.'
name|'ContainerReplicator'
op|'('
op|'{'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'repl'
op|'.'
name|'report_up_to_date'
op|'('
name|'full_info'
op|')'
op|')'
newline|'\n'
name|'full_info'
op|'['
string|"'delete_timestamp'"
op|']'
op|'='
name|'Timestamp'
op|'('
number|'2'
op|')'
op|'.'
name|'internal'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'repl'
op|'.'
name|'report_up_to_date'
op|'('
name|'full_info'
op|')'
op|')'
newline|'\n'
name|'full_info'
op|'['
string|"'reported_delete_timestamp'"
op|']'
op|'='
name|'Timestamp'
op|'('
number|'2'
op|')'
op|'.'
name|'internal'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'repl'
op|'.'
name|'report_up_to_date'
op|'('
name|'full_info'
op|')'
op|')'
newline|'\n'
name|'full_info'
op|'['
string|"'count'"
op|']'
op|'='
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'repl'
op|'.'
name|'report_up_to_date'
op|'('
name|'full_info'
op|')'
op|')'
newline|'\n'
name|'full_info'
op|'['
string|"'reported_object_count'"
op|']'
op|'='
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'repl'
op|'.'
name|'report_up_to_date'
op|'('
name|'full_info'
op|')'
op|')'
newline|'\n'
name|'full_info'
op|'['
string|"'bytes_used'"
op|']'
op|'='
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'repl'
op|'.'
name|'report_up_to_date'
op|'('
name|'full_info'
op|')'
op|')'
newline|'\n'
name|'full_info'
op|'['
string|"'reported_bytes_used'"
op|']'
op|'='
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'repl'
op|'.'
name|'report_up_to_date'
op|'('
name|'full_info'
op|')'
op|')'
newline|'\n'
name|'full_info'
op|'['
string|"'put_timestamp'"
op|']'
op|'='
name|'Timestamp'
op|'('
number|'3'
op|')'
op|'.'
name|'internal'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'repl'
op|'.'
name|'report_up_to_date'
op|'('
name|'full_info'
op|')'
op|')'
newline|'\n'
name|'full_info'
op|'['
string|"'reported_put_timestamp'"
op|']'
op|'='
name|'Timestamp'
op|'('
number|'3'
op|')'
op|'.'
name|'internal'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'repl'
op|'.'
name|'report_up_to_date'
op|'('
name|'full_info'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_remote_in_sync
dedent|''
name|'def'
name|'test_sync_remote_in_sync'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# setup a local container'
nl|'\n'
indent|'        '
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'put_timestamp'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'put_timestamp'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# "replicate" to same database'
nl|'\n'
name|'node'
op|'='
op|'{'
string|"'device'"
op|':'
string|"'sdb'"
op|','
string|"'replication_ip'"
op|':'
string|"'127.0.0.1'"
op|'}'
newline|'\n'
name|'daemon'
op|'='
name|'replicator'
op|'.'
name|'ContainerReplicator'
op|'('
op|'{'
op|'}'
op|')'
newline|'\n'
comment|'# replicate'
nl|'\n'
name|'part'
op|','
name|'node'
op|'='
name|'self'
op|'.'
name|'_get_broker_part_node'
op|'('
name|'broker'
op|')'
newline|'\n'
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_replication_info'
op|'('
op|')'
newline|'\n'
name|'success'
op|'='
name|'daemon'
op|'.'
name|'_repl_to_node'
op|'('
name|'node'
op|','
name|'broker'
op|','
name|'part'
op|','
name|'info'
op|')'
newline|'\n'
comment|'# nothing to do'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'success'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'no_change'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_remote_with_timings
dedent|''
name|'def'
name|'test_sync_remote_with_timings'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ts_iter'
op|'='
name|'make_timestamp_iter'
op|'('
op|')'
newline|'\n'
comment|'# setup a local container'
nl|'\n'
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'put_timestamp'
op|'='
name|'next'
op|'('
name|'ts_iter'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'put_timestamp'
op|'.'
name|'internal'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'update_metadata'
op|'('
nl|'\n'
op|'{'
string|"'x-container-meta-test'"
op|':'
op|'('
string|"'foo'"
op|','
name|'put_timestamp'
op|'.'
name|'internal'
op|')'
op|'}'
op|')'
newline|'\n'
comment|'# setup remote container'
nl|'\n'
name|'remote_broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts_iter'
op|')'
op|'.'
name|'internal'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
name|'timestamp'
op|'='
name|'next'
op|'('
name|'ts_iter'
op|')'
newline|'\n'
name|'for'
name|'db'
name|'in'
op|'('
name|'broker'
op|','
name|'remote_broker'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'put_object'
op|'('
nl|'\n'
string|"'/a/c/o'"
op|','
name|'timestamp'
op|'.'
name|'internal'
op|','
number|'0'
op|','
string|"'content-type'"
op|','
string|"'etag'"
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
name|'db'
op|'.'
name|'storage_policy_index'
op|')'
newline|'\n'
comment|'# replicate'
nl|'\n'
dedent|''
name|'daemon'
op|'='
name|'replicator'
op|'.'
name|'ContainerReplicator'
op|'('
op|'{'
op|'}'
op|')'
newline|'\n'
name|'part'
op|','
name|'node'
op|'='
name|'self'
op|'.'
name|'_get_broker_part_node'
op|'('
name|'remote_broker'
op|')'
newline|'\n'
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_replication_info'
op|'('
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'db_replicator'
op|','
string|"'DEBUG_TIMINGS_THRESHOLD'"
op|','
op|'-'
number|'1'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'success'
op|'='
name|'daemon'
op|'.'
name|'_repl_to_node'
op|'('
name|'node'
op|','
name|'broker'
op|','
name|'part'
op|','
name|'info'
op|')'
newline|'\n'
comment|'# nothing to do'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'success'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'no_change'"
op|']'
op|')'
newline|'\n'
name|'expected_timings'
op|'='
op|'('
string|"'info'"
op|','
string|"'update_metadata'"
op|','
string|"'merge_timestamps'"
op|','
nl|'\n'
string|"'get_sync'"
op|','
string|"'merge_syncs'"
op|')'
newline|'\n'
name|'debug_lines'
op|'='
name|'self'
op|'.'
name|'rpc'
op|'.'
name|'logger'
op|'.'
name|'logger'
op|'.'
name|'get_lines_for_level'
op|'('
string|"'debug'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'expected_timings'
op|')'
op|','
name|'len'
op|'('
name|'debug_lines'
op|')'
op|','
nl|'\n'
string|"'Expected %s debug lines but only got %s: %s'"
op|'%'
nl|'\n'
op|'('
name|'len'
op|'('
name|'expected_timings'
op|')'
op|','
name|'len'
op|'('
name|'debug_lines'
op|')'
op|','
nl|'\n'
name|'debug_lines'
op|')'
op|')'
newline|'\n'
name|'for'
name|'metric'
name|'in'
name|'expected_timings'
op|':'
newline|'\n'
indent|'            '
name|'expected'
op|'='
string|"'replicator-rpc-sync time for %s:'"
op|'%'
name|'metric'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'any'
op|'('
name|'expected'
name|'in'
name|'line'
name|'for'
name|'line'
name|'in'
name|'debug_lines'
op|')'
op|','
nl|'\n'
string|"'debug timing %r was not in %r'"
op|'%'
op|'('
nl|'\n'
name|'expected'
op|','
name|'debug_lines'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_remote_missing
dedent|''
dedent|''
name|'def'
name|'test_sync_remote_missing'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'put_timestamp'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'put_timestamp'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
nl|'\n'
comment|'# "replicate"'
nl|'\n'
name|'part'
op|','
name|'node'
op|'='
name|'self'
op|'.'
name|'_get_broker_part_node'
op|'('
name|'broker'
op|')'
newline|'\n'
name|'daemon'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
name|'node'
op|')'
newline|'\n'
nl|'\n'
comment|'# complete rsync to all other nodes'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'rsync'"
op|']'
op|')'
newline|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
number|'1'
op|','
number|'3'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'remote_broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
name|'i'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'remote_broker'
op|'.'
name|'db_file'
op|')'
op|')'
newline|'\n'
name|'remote_info'
op|'='
name|'remote_broker'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'local_info'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
nl|'\n'
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'for'
name|'k'
op|','
name|'v'
name|'in'
name|'local_info'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'k'
op|'=='
string|"'id'"
op|':'
newline|'\n'
indent|'                    '
name|'continue'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'remote_info'
op|'['
name|'k'
op|']'
op|','
name|'v'
op|','
nl|'\n'
string|'"mismatch remote %s %r != %r"'
op|'%'
op|'('
nl|'\n'
name|'k'
op|','
name|'remote_info'
op|'['
name|'k'
op|']'
op|','
name|'v'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rsync_failure
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_rsync_failure'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'put_timestamp'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'put_timestamp'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# "replicate" to different device'
nl|'\n'
name|'daemon'
op|'='
name|'replicator'
op|'.'
name|'ContainerReplicator'
op|'('
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_rsync_file
name|'def'
name|'_rsync_file'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'False'
newline|'\n'
dedent|''
name|'daemon'
op|'.'
name|'_rsync_file'
op|'='
name|'_rsync_file'
newline|'\n'
nl|'\n'
comment|'# replicate'
nl|'\n'
name|'part'
op|','
name|'local_node'
op|'='
name|'self'
op|'.'
name|'_get_broker_part_node'
op|'('
name|'broker'
op|')'
newline|'\n'
name|'node'
op|'='
name|'random'
op|'.'
name|'choice'
op|'('
op|'['
name|'n'
name|'for'
name|'n'
name|'in'
name|'self'
op|'.'
name|'_ring'
op|'.'
name|'devs'
nl|'\n'
name|'if'
name|'n'
op|'['
string|"'id'"
op|']'
op|'!='
name|'local_node'
op|'['
string|"'id'"
op|']'
op|']'
op|')'
newline|'\n'
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_replication_info'
op|'('
op|')'
newline|'\n'
name|'success'
op|'='
name|'daemon'
op|'.'
name|'_repl_to_node'
op|'('
name|'node'
op|','
name|'broker'
op|','
name|'part'
op|','
name|'info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'success'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_remote_missing_most_rows
dedent|''
name|'def'
name|'test_sync_remote_missing_most_rows'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'put_timestamp'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'put_timestamp'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'put_timestamp'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# add a row to "local" db'
nl|'\n'
name|'broker'
op|'.'
name|'put_object'
op|'('
string|"'/a/c/o'"
op|','
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|','
number|'0'
op|','
string|"'content-type'"
op|','
string|"'etag'"
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
name|'broker'
op|'.'
name|'storage_policy_index'
op|')'
newline|'\n'
comment|'# replicate'
nl|'\n'
name|'node'
op|'='
op|'{'
string|"'device'"
op|':'
string|"'sdc'"
op|','
string|"'replication_ip'"
op|':'
string|"'127.0.0.1'"
op|'}'
newline|'\n'
name|'daemon'
op|'='
name|'replicator'
op|'.'
name|'ContainerReplicator'
op|'('
op|'{'
string|"'per_diff'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_rsync_file
name|'def'
name|'_rsync_file'
op|'('
name|'db_file'
op|','
name|'remote_file'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'remote_server'
op|','
name|'remote_path'
op|'='
name|'remote_file'
op|'.'
name|'split'
op|'('
string|"'/'"
op|','
number|'1'
op|')'
newline|'\n'
name|'dest_path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'remote_path'
op|')'
newline|'\n'
name|'shutil'
op|'.'
name|'copy'
op|'('
name|'db_file'
op|','
name|'dest_path'
op|')'
newline|'\n'
name|'return'
name|'True'
newline|'\n'
dedent|''
name|'daemon'
op|'.'
name|'_rsync_file'
op|'='
name|'_rsync_file'
newline|'\n'
name|'part'
op|','
name|'node'
op|'='
name|'self'
op|'.'
name|'_get_broker_part_node'
op|'('
name|'remote_broker'
op|')'
newline|'\n'
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_replication_info'
op|'('
op|')'
newline|'\n'
name|'success'
op|'='
name|'daemon'
op|'.'
name|'_repl_to_node'
op|'('
name|'node'
op|','
name|'broker'
op|','
name|'part'
op|','
name|'info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'success'
op|')'
newline|'\n'
comment|'# row merge'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'remote_merge'"
op|']'
op|')'
newline|'\n'
name|'local_info'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
nl|'\n'
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'remote_info'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
nl|'\n'
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'for'
name|'k'
op|','
name|'v'
name|'in'
name|'local_info'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'k'
op|'=='
string|"'id'"
op|':'
newline|'\n'
indent|'                '
name|'continue'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'remote_info'
op|'['
name|'k'
op|']'
op|','
name|'v'
op|','
nl|'\n'
string|'"mismatch remote %s %r != %r"'
op|'%'
op|'('
nl|'\n'
name|'k'
op|','
name|'remote_info'
op|'['
name|'k'
op|']'
op|','
name|'v'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_remote_missing_one_rows
dedent|''
dedent|''
name|'def'
name|'test_sync_remote_missing_one_rows'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'put_timestamp'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'put_timestamp'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'put_timestamp'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# add some rows to both db'
nl|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
number|'10'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'put_timestamp'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'for'
name|'db'
name|'in'
op|'('
name|'broker'
op|','
name|'remote_broker'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'path'
op|'='
string|"'/a/c/o_%s'"
op|'%'
name|'i'
newline|'\n'
name|'db'
op|'.'
name|'put_object'
op|'('
name|'path'
op|','
name|'put_timestamp'
op|','
number|'0'
op|','
string|"'content-type'"
op|','
string|"'etag'"
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
name|'db'
op|'.'
name|'storage_policy_index'
op|')'
newline|'\n'
comment|'# now a row to the "local" broker only'
nl|'\n'
dedent|''
dedent|''
name|'broker'
op|'.'
name|'put_object'
op|'('
string|"'/a/c/o_missing'"
op|','
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|','
number|'0'
op|','
nl|'\n'
string|"'content-type'"
op|','
string|"'etag'"
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
name|'broker'
op|'.'
name|'storage_policy_index'
op|')'
newline|'\n'
comment|'# replicate'
nl|'\n'
name|'daemon'
op|'='
name|'replicator'
op|'.'
name|'ContainerReplicator'
op|'('
op|'{'
op|'}'
op|')'
newline|'\n'
name|'part'
op|','
name|'node'
op|'='
name|'self'
op|'.'
name|'_get_broker_part_node'
op|'('
name|'remote_broker'
op|')'
newline|'\n'
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_replication_info'
op|'('
op|')'
newline|'\n'
name|'success'
op|'='
name|'daemon'
op|'.'
name|'_repl_to_node'
op|'('
name|'node'
op|','
name|'broker'
op|','
name|'part'
op|','
name|'info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'success'
op|')'
newline|'\n'
comment|'# row merge'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'diff'"
op|']'
op|')'
newline|'\n'
name|'local_info'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
nl|'\n'
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'remote_info'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
nl|'\n'
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'for'
name|'k'
op|','
name|'v'
name|'in'
name|'local_info'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'k'
op|'=='
string|"'id'"
op|':'
newline|'\n'
indent|'                '
name|'continue'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'remote_info'
op|'['
name|'k'
op|']'
op|','
name|'v'
op|','
nl|'\n'
string|'"mismatch remote %s %r != %r"'
op|'%'
op|'('
nl|'\n'
name|'k'
op|','
name|'remote_info'
op|'['
name|'k'
op|']'
op|','
name|'v'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_remote_can_not_keep_up
dedent|''
dedent|''
name|'def'
name|'test_sync_remote_can_not_keep_up'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'put_timestamp'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'put_timestamp'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'put_timestamp'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|"# add some rows to both db's"
nl|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
number|'10'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'put_timestamp'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'for'
name|'db'
name|'in'
op|'('
name|'broker'
op|','
name|'remote_broker'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'obj_name'
op|'='
string|"'o_%s'"
op|'%'
name|'i'
newline|'\n'
name|'db'
op|'.'
name|'put_object'
op|'('
name|'obj_name'
op|','
name|'put_timestamp'
op|','
number|'0'
op|','
nl|'\n'
string|"'content-type'"
op|','
string|"'etag'"
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
name|'db'
op|'.'
name|'storage_policy_index'
op|')'
newline|'\n'
comment|'# setup REPLICATE callback to simulate adding rows during merge_items'
nl|'\n'
dedent|''
dedent|''
name|'missing_counter'
op|'='
name|'itertools'
op|'.'
name|'count'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|put_more_objects
name|'def'
name|'put_more_objects'
op|'('
name|'op'
op|','
op|'*'
name|'args'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'op'
op|'!='
string|"'merge_items'"
op|':'
newline|'\n'
indent|'                '
name|'return'
newline|'\n'
dedent|''
name|'path'
op|'='
string|"'/a/c/o_missing_%s'"
op|'%'
name|'next'
op|'('
name|'missing_counter'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'put_object'
op|'('
name|'path'
op|','
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|','
number|'0'
op|','
string|"'content-type'"
op|','
string|"'etag'"
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
name|'db'
op|'.'
name|'storage_policy_index'
op|')'
newline|'\n'
dedent|''
name|'test_db_replicator'
op|'.'
name|'FakeReplConnection'
op|'='
name|'test_db_replicator'
op|'.'
name|'attach_fake_replication_rpc'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'rpc'
op|','
name|'replicate_hook'
op|'='
name|'put_more_objects'
op|')'
newline|'\n'
name|'db_replicator'
op|'.'
name|'ReplConnection'
op|'='
name|'test_db_replicator'
op|'.'
name|'FakeReplConnection'
newline|'\n'
comment|'# and add one extra to local db to trigger merge_items'
nl|'\n'
name|'put_more_objects'
op|'('
string|"'merge_items'"
op|')'
newline|'\n'
comment|"# limit number of times we'll call merge_items"
nl|'\n'
name|'daemon'
op|'='
name|'replicator'
op|'.'
name|'ContainerReplicator'
op|'('
op|'{'
string|"'max_diffs'"
op|':'
number|'10'
op|'}'
op|')'
newline|'\n'
comment|'# replicate'
nl|'\n'
name|'part'
op|','
name|'node'
op|'='
name|'self'
op|'.'
name|'_get_broker_part_node'
op|'('
name|'remote_broker'
op|')'
newline|'\n'
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_replication_info'
op|'('
op|')'
newline|'\n'
name|'success'
op|'='
name|'daemon'
op|'.'
name|'_repl_to_node'
op|'('
name|'node'
op|','
name|'broker'
op|','
name|'part'
op|','
name|'info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'success'
op|')'
newline|'\n'
comment|'# back off on the PUTs during replication...'
nl|'\n'
name|'FakeReplConnection'
op|'='
name|'test_db_replicator'
op|'.'
name|'attach_fake_replication_rpc'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'rpc'
op|','
name|'replicate_hook'
op|'='
name|'None'
op|')'
newline|'\n'
name|'db_replicator'
op|'.'
name|'ReplConnection'
op|'='
name|'FakeReplConnection'
newline|'\n'
comment|'# retry replication'
nl|'\n'
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_replication_info'
op|'('
op|')'
newline|'\n'
name|'success'
op|'='
name|'daemon'
op|'.'
name|'_repl_to_node'
op|'('
name|'node'
op|','
name|'broker'
op|','
name|'part'
op|','
name|'info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'success'
op|')'
newline|'\n'
comment|'# row merge'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'diff'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'diff_capped'"
op|']'
op|')'
newline|'\n'
name|'local_info'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
nl|'\n'
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'remote_info'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
nl|'\n'
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'for'
name|'k'
op|','
name|'v'
name|'in'
name|'local_info'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'k'
op|'=='
string|"'id'"
op|':'
newline|'\n'
indent|'                '
name|'continue'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'remote_info'
op|'['
name|'k'
op|']'
op|','
name|'v'
op|','
nl|'\n'
string|'"mismatch remote %s %r != %r"'
op|'%'
op|'('
nl|'\n'
name|'k'
op|','
name|'remote_info'
op|'['
name|'k'
op|']'
op|','
name|'v'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_diff_capped_sync
dedent|''
dedent|''
name|'def'
name|'test_diff_capped_sync'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ts'
op|'='
op|'('
name|'Timestamp'
op|'('
name|'t'
op|')'
op|'.'
name|'internal'
name|'for'
name|'t'
name|'in'
nl|'\n'
name|'itertools'
op|'.'
name|'count'
op|'('
name|'int'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
op|')'
newline|'\n'
name|'put_timestamp'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
comment|'# start off with with a local db that is way behind'
nl|'\n'
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'put_timestamp'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
number|'50'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'broker'
op|'.'
name|'put_object'
op|'('
nl|'\n'
string|"'o%s'"
op|'%'
name|'i'
op|','
name|'next'
op|'('
name|'ts'
op|')'
op|','
number|'0'
op|','
string|"'content-type-old'"
op|','
string|"'etag'"
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
name|'broker'
op|'.'
name|'storage_policy_index'
op|')'
newline|'\n'
comment|'# remote primary db has all the new bits...'
nl|'\n'
dedent|''
name|'remote_broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'put_timestamp'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
number|'100'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'remote_broker'
op|'.'
name|'put_object'
op|'('
nl|'\n'
string|"'o%s'"
op|'%'
name|'i'
op|','
name|'next'
op|'('
name|'ts'
op|')'
op|','
number|'0'
op|','
string|"'content-type-new'"
op|','
string|"'etag'"
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
name|'remote_broker'
op|'.'
name|'storage_policy_index'
op|')'
newline|'\n'
comment|"# except there's *one* tiny thing in our local broker that's newer"
nl|'\n'
dedent|''
name|'broker'
op|'.'
name|'put_object'
op|'('
nl|'\n'
string|"'o101'"
op|','
name|'next'
op|'('
name|'ts'
op|')'
op|','
number|'0'
op|','
string|"'content-type-new'"
op|','
string|"'etag'"
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
name|'broker'
op|'.'
name|'storage_policy_index'
op|')'
newline|'\n'
nl|'\n'
comment|'# setup daemon with smaller per_diff and max_diffs'
nl|'\n'
name|'part'
op|','
name|'node'
op|'='
name|'self'
op|'.'
name|'_get_broker_part_node'
op|'('
name|'broker'
op|')'
newline|'\n'
name|'daemon'
op|'='
name|'self'
op|'.'
name|'_get_daemon'
op|'('
name|'node'
op|','
name|'conf_updates'
op|'='
op|'{'
string|"'per_diff'"
op|':'
number|'10'
op|','
nl|'\n'
string|"'max_diffs'"
op|':'
number|'3'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'daemon'
op|'.'
name|'per_diff'
op|','
number|'10'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'daemon'
op|'.'
name|'max_diffs'
op|','
number|'3'
op|')'
newline|'\n'
comment|'# run once and verify diff capped'
nl|'\n'
name|'self'
op|'.'
name|'_run_once'
op|'('
name|'node'
op|','
name|'daemon'
op|'='
name|'daemon'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'diff'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'diff_capped'"
op|']'
op|')'
newline|'\n'
comment|'# run again and verify fully synced'
nl|'\n'
name|'self'
op|'.'
name|'_run_once'
op|'('
name|'node'
op|','
name|'daemon'
op|'='
name|'daemon'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'diff'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'diff_capped'"
op|']'
op|')'
newline|'\n'
comment|"# now that we're synced the new item should be in remote db"
nl|'\n'
name|'remote_names'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'item'
name|'in'
name|'remote_broker'
op|'.'
name|'list_objects_iter'
op|'('
number|'500'
op|','
string|"''"
op|','
string|"''"
op|','
string|"''"
op|','
string|"''"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'name'
op|','
name|'ts'
op|','
name|'size'
op|','
name|'content_type'
op|','
name|'etag'
op|'='
name|'item'
newline|'\n'
name|'remote_names'
op|'.'
name|'add'
op|'('
name|'name'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'content_type'
op|','
string|"'content-type-new'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'o101'"
name|'in'
name|'remote_names'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'remote_names'
op|')'
op|','
number|'101'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'remote_broker'
op|'.'
name|'get_info'
op|'('
op|')'
op|'['
string|"'object_count'"
op|']'
op|','
number|'101'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_status_change
dedent|''
name|'def'
name|'test_sync_status_change'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# setup a local container'
nl|'\n'
indent|'        '
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'put_timestamp'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'put_timestamp'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# setup remote container'
nl|'\n'
name|'remote_broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'put_timestamp'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# delete local container'
nl|'\n'
name|'broker'
op|'.'
name|'delete_db'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
newline|'\n'
comment|'# replicate'
nl|'\n'
name|'daemon'
op|'='
name|'replicator'
op|'.'
name|'ContainerReplicator'
op|'('
op|'{'
op|'}'
op|')'
newline|'\n'
name|'part'
op|','
name|'node'
op|'='
name|'self'
op|'.'
name|'_get_broker_part_node'
op|'('
name|'remote_broker'
op|')'
newline|'\n'
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_replication_info'
op|'('
op|')'
newline|'\n'
name|'success'
op|'='
name|'daemon'
op|'.'
name|'_repl_to_node'
op|'('
name|'node'
op|','
name|'broker'
op|','
name|'part'
op|','
name|'info'
op|')'
newline|'\n'
comment|'# nothing to do'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'success'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'no_change'"
op|']'
op|')'
newline|'\n'
comment|'# status in sync'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'remote_broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
op|')'
newline|'\n'
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'remote_info'
op|'='
name|'remote_broker'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'Timestamp'
op|'('
name|'remote_info'
op|'['
string|"'status_changed_at'"
op|']'
op|')'
op|'>'
nl|'\n'
name|'Timestamp'
op|'('
name|'remote_info'
op|'['
string|"'put_timestamp'"
op|']'
op|')'
op|','
nl|'\n'
string|"'remote status_changed_at (%s) is not '"
nl|'\n'
string|"'greater than put_timestamp (%s)'"
op|'%'
op|'('
nl|'\n'
name|'remote_info'
op|'['
string|"'status_changed_at'"
op|']'
op|','
nl|'\n'
name|'remote_info'
op|'['
string|"'put_timestamp'"
op|']'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'Timestamp'
op|'('
name|'remote_info'
op|'['
string|"'status_changed_at'"
op|']'
op|')'
op|'>'
nl|'\n'
name|'Timestamp'
op|'('
name|'info'
op|'['
string|"'status_changed_at'"
op|']'
op|')'
op|','
nl|'\n'
string|"'remote status_changed_at (%s) is not '"
nl|'\n'
string|"'greater than local status_changed_at (%s)'"
op|'%'
op|'('
nl|'\n'
name|'remote_info'
op|'['
string|"'status_changed_at'"
op|']'
op|','
nl|'\n'
name|'info'
op|'['
string|"'status_changed_at'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'contextmanager'
newline|'\n'
DECL|member|_wrap_merge_timestamps
name|'def'
name|'_wrap_merge_timestamps'
op|'('
name|'self'
op|','
name|'broker'
op|','
name|'calls'
op|')'
op|':'
newline|'\n'
DECL|function|fake_merge_timestamps
indent|'        '
name|'def'
name|'fake_merge_timestamps'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'calls'
op|'.'
name|'append'
op|'('
name|'args'
op|'['
number|'0'
op|']'
op|')'
newline|'\n'
name|'orig_merge_timestamps'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'orig_merge_timestamps'
op|'='
name|'broker'
op|'.'
name|'merge_timestamps'
newline|'\n'
name|'broker'
op|'.'
name|'merge_timestamps'
op|'='
name|'fake_merge_timestamps'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'yield'
name|'True'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'broker'
op|'.'
name|'merge_timestamps'
op|'='
name|'orig_merge_timestamps'
newline|'\n'
nl|'\n'
DECL|member|test_sync_merge_timestamps
dedent|''
dedent|''
name|'def'
name|'test_sync_merge_timestamps'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ts'
op|'='
op|'('
name|'Timestamp'
op|'('
name|'t'
op|')'
op|'.'
name|'internal'
name|'for'
name|'t'
name|'in'
nl|'\n'
name|'itertools'
op|'.'
name|'count'
op|'('
name|'int'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
op|')'
newline|'\n'
comment|'# setup a local container'
nl|'\n'
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'put_timestamp'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'put_timestamp'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# setup remote container'
nl|'\n'
name|'remote_broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
newline|'\n'
name|'remote_put_timestamp'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'remote_put_timestamp'
op|','
name|'POLICIES'
op|'.'
name|'default'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# replicate, expect call to merge_timestamps on remote and local'
nl|'\n'
name|'daemon'
op|'='
name|'replicator'
op|'.'
name|'ContainerReplicator'
op|'('
op|'{'
op|'}'
op|')'
newline|'\n'
name|'part'
op|','
name|'node'
op|'='
name|'self'
op|'.'
name|'_get_broker_part_node'
op|'('
name|'remote_broker'
op|')'
newline|'\n'
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_replication_info'
op|'('
op|')'
newline|'\n'
name|'local_calls'
op|'='
op|'['
op|']'
newline|'\n'
name|'remote_calls'
op|'='
op|'['
op|']'
newline|'\n'
name|'with'
name|'self'
op|'.'
name|'_wrap_merge_timestamps'
op|'('
name|'broker'
op|','
name|'local_calls'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'self'
op|'.'
name|'_wrap_merge_timestamps'
op|'('
name|'broker'
op|','
name|'remote_calls'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'success'
op|'='
name|'daemon'
op|'.'
name|'_repl_to_node'
op|'('
name|'node'
op|','
name|'broker'
op|','
name|'part'
op|','
name|'info'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'success'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'len'
op|'('
name|'remote_calls'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'len'
op|'('
name|'local_calls'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'remote_put_timestamp'
op|','
nl|'\n'
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
op|'['
string|"'put_timestamp'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'remote_put_timestamp'
op|','
nl|'\n'
name|'remote_broker'
op|'.'
name|'get_info'
op|'('
op|')'
op|'['
string|"'put_timestamp'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# replicate again, no changes so expect no calls to merge_timestamps'
nl|'\n'
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_replication_info'
op|'('
op|')'
newline|'\n'
name|'local_calls'
op|'='
op|'['
op|']'
newline|'\n'
name|'remote_calls'
op|'='
op|'['
op|']'
newline|'\n'
name|'with'
name|'self'
op|'.'
name|'_wrap_merge_timestamps'
op|'('
name|'broker'
op|','
name|'local_calls'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'self'
op|'.'
name|'_wrap_merge_timestamps'
op|'('
name|'broker'
op|','
name|'remote_calls'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'success'
op|'='
name|'daemon'
op|'.'
name|'_repl_to_node'
op|'('
name|'node'
op|','
name|'broker'
op|','
name|'part'
op|','
name|'info'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'success'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'len'
op|'('
name|'remote_calls'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'len'
op|'('
name|'local_calls'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'remote_put_timestamp'
op|','
nl|'\n'
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
op|'['
string|"'put_timestamp'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'remote_put_timestamp'
op|','
nl|'\n'
name|'remote_broker'
op|'.'
name|'get_info'
op|'('
op|')'
op|'['
string|"'put_timestamp'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_bogus_db_quarantines
dedent|''
name|'def'
name|'test_sync_bogus_db_quarantines'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ts'
op|'='
op|'('
name|'Timestamp'
op|'('
name|'t'
op|')'
op|'.'
name|'internal'
name|'for'
name|'t'
name|'in'
nl|'\n'
name|'itertools'
op|'.'
name|'count'
op|'('
name|'int'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
op|')'
newline|'\n'
name|'policy'
op|'='
name|'random'
op|'.'
name|'choice'
op|'('
name|'list'
op|'('
name|'POLICIES'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'local_broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'local_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
nl|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
nl|'\n'
name|'db_path'
op|'='
name|'local_broker'
op|'.'
name|'db_file'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'db_path'
op|')'
op|')'
comment|'# sanity check'
newline|'\n'
name|'old_inode'
op|'='
name|'os'
op|'.'
name|'stat'
op|'('
name|'db_path'
op|')'
op|'.'
name|'st_ino'
newline|'\n'
nl|'\n'
name|'_orig_get_info'
op|'='
name|'backend'
op|'.'
name|'ContainerBroker'
op|'.'
name|'get_info'
newline|'\n'
nl|'\n'
DECL|function|fail_like_bad_db
name|'def'
name|'fail_like_bad_db'
op|'('
name|'broker'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'broker'
op|'.'
name|'db_file'
op|'=='
name|'local_broker'
op|'.'
name|'db_file'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'sqlite3'
op|'.'
name|'OperationalError'
op|'('
string|'"no such table: container_info"'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'_orig_get_info'
op|'('
name|'broker'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'part'
op|','
name|'node'
op|'='
name|'self'
op|'.'
name|'_get_broker_part_node'
op|'('
name|'remote_broker'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.backend.ContainerBroker.get_info'"
op|','
nl|'\n'
name|'fail_like_bad_db'
op|')'
op|':'
newline|'\n'
comment|'# Have the remote node replicate to local; local should see its'
nl|'\n'
comment|"# corrupt DB, quarantine it, and act like the DB wasn't ever there"
nl|'\n'
comment|'# in the first place.'
nl|'\n'
indent|'            '
name|'daemon'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
name|'node'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'db_path'
op|')'
op|')'
newline|'\n'
comment|"# Make sure we didn't just keep the old DB, but quarantined it and"
nl|'\n'
comment|'# made a fresh copy.'
nl|'\n'
name|'new_inode'
op|'='
name|'os'
op|'.'
name|'stat'
op|'('
name|'db_path'
op|')'
op|'.'
name|'st_ino'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'old_inode'
op|','
name|'new_inode'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'failure'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_replication_scenarios
dedent|''
name|'def'
name|'_replication_scenarios'
op|'('
name|'self'
op|','
op|'*'
name|'scenarios'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'remote_wins'
op|'='
name|'kwargs'
op|'.'
name|'get'
op|'('
string|"'remote_wins'"
op|','
name|'False'
op|')'
newline|'\n'
comment|'# these tests are duplicated because of the differences in replication'
nl|'\n'
comment|'# when row counts cause full rsync vs. merge'
nl|'\n'
name|'scenarios'
op|'='
name|'scenarios'
name|'or'
op|'('
nl|'\n'
string|"'no_row'"
op|','
string|"'local_row'"
op|','
string|"'remote_row'"
op|','
string|"'both_rows'"
op|')'
newline|'\n'
name|'for'
name|'scenario_name'
name|'in'
name|'scenarios'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|'='
name|'itertools'
op|'.'
name|'count'
op|'('
name|'int'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'policy'
op|'='
name|'random'
op|'.'
name|'choice'
op|'('
name|'list'
op|'('
name|'POLICIES'
op|')'
op|')'
newline|'\n'
name|'remote_policy'
op|'='
name|'random'
op|'.'
name|'choice'
op|'('
nl|'\n'
op|'['
name|'p'
name|'for'
name|'p'
name|'in'
name|'POLICIES'
name|'if'
name|'p'
name|'is'
name|'not'
name|'policy'
op|']'
op|')'
newline|'\n'
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'remote_broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
newline|'\n'
name|'yield'
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
newline|'\n'
comment|'# variations on different replication scenarios'
nl|'\n'
name|'variations'
op|'='
op|'{'
nl|'\n'
string|"'no_row'"
op|':'
op|'('
op|')'
op|','
nl|'\n'
string|"'local_row'"
op|':'
op|'('
name|'broker'
op|','
op|')'
op|','
nl|'\n'
string|"'remote_row'"
op|':'
op|'('
name|'remote_broker'
op|','
op|')'
op|','
nl|'\n'
string|"'both_rows'"
op|':'
op|'('
name|'broker'
op|','
name|'remote_broker'
op|')'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'dbs'
op|'='
name|'variations'
op|'['
name|'scenario_name'
op|']'
newline|'\n'
name|'obj_ts'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'for'
name|'db'
name|'in'
name|'dbs'
op|':'
newline|'\n'
indent|'                '
name|'db'
op|'.'
name|'put_object'
op|'('
string|"'/a/c/o'"
op|','
name|'obj_ts'
op|','
number|'0'
op|','
string|"'content-type'"
op|','
string|"'etag'"
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
name|'db'
op|'.'
name|'storage_policy_index'
op|')'
newline|'\n'
comment|'# replicate'
nl|'\n'
dedent|''
name|'part'
op|','
name|'node'
op|'='
name|'self'
op|'.'
name|'_get_broker_part_node'
op|'('
name|'broker'
op|')'
newline|'\n'
name|'daemon'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
name|'node'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'failure'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# in sync'
nl|'\n'
name|'local_info'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
nl|'\n'
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'remote_info'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
nl|'\n'
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'if'
name|'remote_wins'
op|':'
newline|'\n'
indent|'                '
name|'expected'
op|'='
name|'remote_policy'
op|'.'
name|'idx'
newline|'\n'
name|'err'
op|'='
string|"'local policy did not change to match remote '"
string|"'for replication row scenario %s'"
op|'%'
name|'scenario_name'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'expected'
op|'='
name|'policy'
op|'.'
name|'idx'
newline|'\n'
name|'err'
op|'='
string|"'local policy changed to match remote '"
string|"'for replication row scenario %s'"
op|'%'
name|'scenario_name'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'local_info'
op|'['
string|"'storage_policy_index'"
op|']'
op|','
name|'expected'
op|','
name|'err'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'remote_info'
op|'['
string|"'storage_policy_index'"
op|']'
op|','
nl|'\n'
name|'local_info'
op|'['
string|"'storage_policy_index'"
op|']'
op|')'
newline|'\n'
name|'test_db_replicator'
op|'.'
name|'TestReplicatorSync'
op|'.'
name|'tearDown'
op|'('
name|'self'
op|')'
newline|'\n'
name|'test_db_replicator'
op|'.'
name|'TestReplicatorSync'
op|'.'
name|'setUp'
op|'('
name|'self'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_local_create_policy_over_newer_remote_create
dedent|''
dedent|''
name|'def'
name|'test_sync_local_create_policy_over_newer_remote_create'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_local_create_policy_over_newer_remote_delete
dedent|''
dedent|''
name|'def'
name|'test_sync_local_create_policy_over_newer_remote_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create older "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# delete "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_local_create_policy_over_older_remote_delete
dedent|''
dedent|''
name|'def'
name|'test_sync_local_create_policy_over_older_remote_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# remote_row & both_rows cases are covered by'
nl|'\n'
comment|'# "test_sync_remote_half_delete_policy_over_newer_local_create"'
nl|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
nl|'\n'
string|"'no_row'"
op|','
string|"'local_row'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create older "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# delete older "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_local_half_delete_policy_over_newer_remote_create
dedent|''
dedent|''
name|'def'
name|'test_sync_local_half_delete_policy_over_newer_remote_create'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# no_row & remote_row cases are covered by'
nl|'\n'
comment|'# "test_sync_remote_create_policy_over_older_local_delete"'
nl|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
string|"'local_row'"
op|','
string|"'both_rows'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create older "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# half delete older "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_local_recreate_policy_over_newer_remote_create
dedent|''
dedent|''
name|'def'
name|'test_sync_local_recreate_policy_over_newer_remote_create'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# older recreate "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'recreate_timestamp'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'update_put_timestamp'
op|'('
name|'recreate_timestamp'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'update_status_changed_at'
op|'('
name|'recreate_timestamp'
op|')'
newline|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_local_recreate_policy_over_older_remote_create
dedent|''
dedent|''
name|'def'
name|'test_sync_local_recreate_policy_over_older_remote_create'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create older "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# recreate "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'recreate_timestamp'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'update_put_timestamp'
op|'('
name|'recreate_timestamp'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'update_status_changed_at'
op|'('
name|'recreate_timestamp'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_local_recreate_policy_over_newer_remote_delete
dedent|''
dedent|''
name|'def'
name|'test_sync_local_recreate_policy_over_newer_remote_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# recreate "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'recreate_timestamp'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'update_put_timestamp'
op|'('
name|'recreate_timestamp'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'update_status_changed_at'
op|'('
name|'recreate_timestamp'
op|')'
newline|'\n'
comment|'# older delete "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_local_recreate_policy_over_older_remote_delete
dedent|''
dedent|''
name|'def'
name|'test_sync_local_recreate_policy_over_older_remote_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# older delete "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
comment|'# recreate "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'recreate_timestamp'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'update_put_timestamp'
op|'('
name|'recreate_timestamp'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'update_status_changed_at'
op|'('
name|'recreate_timestamp'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_local_recreate_policy_over_older_remote_recreate
dedent|''
dedent|''
name|'def'
name|'test_sync_local_recreate_policy_over_older_remote_recreate'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# older recreate "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'remote_recreate_timestamp'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'update_put_timestamp'
op|'('
name|'remote_recreate_timestamp'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'update_status_changed_at'
op|'('
name|'remote_recreate_timestamp'
op|')'
newline|'\n'
comment|'# recreate "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'local_recreate_timestamp'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'update_put_timestamp'
op|'('
name|'local_recreate_timestamp'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'update_status_changed_at'
op|'('
name|'local_recreate_timestamp'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_remote_create_policy_over_newer_local_create
dedent|''
dedent|''
name|'def'
name|'test_sync_remote_create_policy_over_newer_local_create'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
name|'remote_wins'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create older "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_remote_create_policy_over_newer_local_delete
dedent|''
dedent|''
name|'def'
name|'test_sync_remote_create_policy_over_newer_local_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
name|'remote_wins'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create older "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# delete "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_remote_create_policy_over_older_local_delete
dedent|''
dedent|''
name|'def'
name|'test_sync_remote_create_policy_over_older_local_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# local_row & both_rows cases are covered by'
nl|'\n'
comment|'# "test_sync_local_half_delete_policy_over_newer_remote_create"'
nl|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
nl|'\n'
string|"'no_row'"
op|','
string|"'remote_row'"
op|','
name|'remote_wins'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create older "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# delete older "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_remote_half_delete_policy_over_newer_local_create
dedent|''
dedent|''
name|'def'
name|'test_sync_remote_half_delete_policy_over_newer_local_create'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# no_row & both_rows cases are covered by'
nl|'\n'
comment|'# "test_sync_local_create_policy_over_older_remote_delete"'
nl|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
string|"'remote_row'"
op|','
string|"'both_rows'"
op|','
nl|'\n'
name|'remote_wins'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create older "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# half delete older "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_remote_recreate_policy_over_newer_local_create
dedent|''
dedent|''
name|'def'
name|'test_sync_remote_recreate_policy_over_newer_local_create'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
name|'remote_wins'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# older recreate "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'recreate_timestamp'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'update_put_timestamp'
op|'('
name|'recreate_timestamp'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'update_status_changed_at'
op|'('
name|'recreate_timestamp'
op|')'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_remote_recreate_policy_over_older_local_create
dedent|''
dedent|''
name|'def'
name|'test_sync_remote_recreate_policy_over_older_local_create'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
name|'remote_wins'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create older "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# recreate "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'recreate_timestamp'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'update_put_timestamp'
op|'('
name|'recreate_timestamp'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'update_status_changed_at'
op|'('
name|'recreate_timestamp'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_remote_recreate_policy_over_newer_local_delete
dedent|''
dedent|''
name|'def'
name|'test_sync_remote_recreate_policy_over_newer_local_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
name|'remote_wins'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# recreate "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'remote_recreate_timestamp'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'update_put_timestamp'
op|'('
name|'remote_recreate_timestamp'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'update_status_changed_at'
op|'('
name|'remote_recreate_timestamp'
op|')'
newline|'\n'
comment|'# older delete "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_remote_recreate_policy_over_older_local_delete
dedent|''
dedent|''
name|'def'
name|'test_sync_remote_recreate_policy_over_older_local_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
name|'remote_wins'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# older delete "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
comment|'# recreate "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'remote_recreate_timestamp'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'update_put_timestamp'
op|'('
name|'remote_recreate_timestamp'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'update_status_changed_at'
op|'('
name|'remote_recreate_timestamp'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_remote_recreate_policy_over_older_local_recreate
dedent|''
dedent|''
name|'def'
name|'test_sync_remote_recreate_policy_over_older_local_recreate'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'setup'
name|'in'
name|'self'
op|'.'
name|'_replication_scenarios'
op|'('
name|'remote_wins'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ts'
op|','
name|'policy'
op|','
name|'remote_policy'
op|','
name|'broker'
op|','
name|'remote_broker'
op|'='
name|'setup'
newline|'\n'
comment|'# create older "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# older recreate "local" broker'
nl|'\n'
name|'broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'local_recreate_timestamp'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'update_put_timestamp'
op|'('
name|'local_recreate_timestamp'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'update_status_changed_at'
op|'('
name|'local_recreate_timestamp'
op|')'
newline|'\n'
comment|'# recreate "remote" broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'delete_db'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'remote_recreate_timestamp'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'update_put_timestamp'
op|'('
name|'remote_recreate_timestamp'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'update_status_changed_at'
op|'('
name|'remote_recreate_timestamp'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_to_remote_with_misplaced
dedent|''
dedent|''
name|'def'
name|'test_sync_to_remote_with_misplaced'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ts'
op|'='
op|'('
name|'Timestamp'
op|'('
name|'t'
op|')'
op|'.'
name|'internal'
name|'for'
name|'t'
name|'in'
nl|'\n'
name|'itertools'
op|'.'
name|'count'
op|'('
name|'int'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
op|')'
newline|'\n'
comment|'# create "local" broker'
nl|'\n'
name|'policy'
op|'='
name|'random'
op|'.'
name|'choice'
op|'('
name|'list'
op|'('
name|'POLICIES'
op|')'
op|')'
newline|'\n'
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
nl|'\n'
comment|'# create "remote" broker'
nl|'\n'
name|'remote_policy'
op|'='
name|'random'
op|'.'
name|'choice'
op|'('
op|'['
name|'p'
name|'for'
name|'p'
name|'in'
name|'POLICIES'
name|'if'
name|'p'
name|'is'
name|'not'
nl|'\n'
name|'policy'
op|']'
op|')'
newline|'\n'
name|'remote_broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
comment|'# add misplaced row to remote_broker'
nl|'\n'
name|'remote_broker'
op|'.'
name|'put_object'
op|'('
nl|'\n'
string|"'/a/c/o'"
op|','
name|'next'
op|'('
name|'ts'
op|')'
op|','
number|'0'
op|','
string|"'content-type'"
op|','
nl|'\n'
string|"'etag'"
op|','
name|'storage_policy_index'
op|'='
name|'remote_broker'
op|'.'
name|'storage_policy_index'
op|')'
newline|'\n'
comment|'# since this row matches policy index or remote, it shows up in count'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'remote_broker'
op|'.'
name|'get_info'
op|'('
op|')'
op|'['
string|"'object_count'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
op|']'
op|','
name|'remote_broker'
op|'.'
name|'get_misplaced_since'
op|'('
op|'-'
number|'1'
op|','
number|'1'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# replicate'
nl|'\n'
name|'part'
op|','
name|'node'
op|'='
name|'self'
op|'.'
name|'_get_broker_part_node'
op|'('
name|'broker'
op|')'
newline|'\n'
name|'daemon'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
name|'node'
op|')'
newline|'\n'
comment|'# since our local broker has no rows to push it logs as no_change'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'no_change'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
op|'['
string|"'object_count'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|"# remote broker updates it's policy index; this makes the remote"
nl|'\n'
comment|"# broker's object count change"
nl|'\n'
name|'info'
op|'='
name|'remote_broker'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'expectations'
op|'='
op|'{'
nl|'\n'
string|"'object_count'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
name|'policy'
op|'.'
name|'idx'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'for'
name|'key'
op|','
name|'value'
name|'in'
name|'expectations'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'info'
op|'['
name|'key'
op|']'
op|','
name|'value'
op|')'
newline|'\n'
comment|'# but it also knows those objects are misplaced now'
nl|'\n'
dedent|''
name|'misplaced'
op|'='
name|'remote_broker'
op|'.'
name|'get_misplaced_since'
op|'('
op|'-'
number|'1'
op|','
number|'100'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'misplaced'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
comment|'# we also pushed out to node 3 with rsync'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'rsync'"
op|']'
op|')'
newline|'\n'
name|'third_broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'2'
op|')'
newline|'\n'
name|'info'
op|'='
name|'third_broker'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'for'
name|'key'
op|','
name|'value'
name|'in'
name|'expectations'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'info'
op|'['
name|'key'
op|']'
op|','
name|'value'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_misplaced_rows_replicate_and_enqueue
dedent|''
dedent|''
name|'def'
name|'test_misplaced_rows_replicate_and_enqueue'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ts'
op|'='
op|'('
name|'Timestamp'
op|'('
name|'t'
op|')'
op|'.'
name|'internal'
name|'for'
name|'t'
name|'in'
nl|'\n'
name|'itertools'
op|'.'
name|'count'
op|'('
name|'int'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
op|')'
newline|'\n'
name|'policy'
op|'='
name|'random'
op|'.'
name|'choice'
op|'('
name|'list'
op|'('
name|'POLICIES'
op|')'
op|')'
newline|'\n'
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
name|'remote_policy'
op|'='
name|'random'
op|'.'
name|'choice'
op|'('
op|'['
name|'p'
name|'for'
name|'p'
name|'in'
name|'POLICIES'
name|'if'
name|'p'
name|'is'
name|'not'
nl|'\n'
name|'policy'
op|']'
op|')'
newline|'\n'
name|'remote_broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
nl|'\n'
comment|'# add a misplaced row to *local* broker'
nl|'\n'
name|'obj_put_timestamp'
op|'='
name|'next'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'put_object'
op|'('
nl|'\n'
string|"'o'"
op|','
name|'obj_put_timestamp'
op|','
number|'0'
op|','
string|"'content-type'"
op|','
nl|'\n'
string|"'etag'"
op|','
name|'storage_policy_index'
op|'='
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
name|'misplaced'
op|'='
name|'broker'
op|'.'
name|'get_misplaced_since'
op|'('
op|'-'
number|'1'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'misplaced'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
comment|"# since this row is misplaced it doesn't show up in count"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
op|'['
string|"'object_count'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# replicate'
nl|'\n'
name|'part'
op|','
name|'node'
op|'='
name|'self'
op|'.'
name|'_get_broker_part_node'
op|'('
name|'broker'
op|')'
newline|'\n'
name|'daemon'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
name|'node'
op|')'
newline|'\n'
comment|'# push to remote, and third node was missing (also maybe reconciler)'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
number|'2'
op|'<'
name|'daemon'
op|'.'
name|'stats'
op|'['
string|"'rsync'"
op|']'
op|'<='
number|'3'
op|')'
newline|'\n'
nl|'\n'
comment|'# grab the rsynced instance of remote_broker'
nl|'\n'
name|'remote_broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
comment|'# remote has misplaced rows too now'
nl|'\n'
name|'misplaced'
op|'='
name|'remote_broker'
op|'.'
name|'get_misplaced_since'
op|'('
op|'-'
number|'1'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'misplaced'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
comment|'# and the correct policy_index and object_count'
nl|'\n'
name|'info'
op|'='
name|'remote_broker'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'expectations'
op|'='
op|'{'
nl|'\n'
string|"'object_count'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
name|'policy'
op|'.'
name|'idx'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'for'
name|'key'
op|','
name|'value'
name|'in'
name|'expectations'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'info'
op|'['
name|'key'
op|']'
op|','
name|'value'
op|')'
newline|'\n'
nl|'\n'
comment|'# and we should have also enqeued these rows in the reconciler'
nl|'\n'
dedent|''
name|'reconciler'
op|'='
name|'daemon'
op|'.'
name|'get_reconciler_broker'
op|'('
name|'misplaced'
op|'['
number|'0'
op|']'
op|'['
string|"'created_at'"
op|']'
op|')'
newline|'\n'
comment|'# but it may not be on the same node as us anymore though...'
nl|'\n'
name|'reconciler'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
name|'reconciler'
op|'.'
name|'account'
op|','
nl|'\n'
name|'reconciler'
op|'.'
name|'container'
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'reconciler'
op|'.'
name|'get_info'
op|'('
op|')'
op|'['
string|"'object_count'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'objects'
op|'='
name|'reconciler'
op|'.'
name|'list_objects_iter'
op|'('
nl|'\n'
number|'1'
op|','
string|"''"
op|','
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
name|'storage_policy_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'objects'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'expected'
op|'='
op|'('
string|"'%s:/a/c/o'"
op|'%'
name|'remote_policy'
op|'.'
name|'idx'
op|','
name|'obj_put_timestamp'
op|','
number|'0'
op|','
nl|'\n'
string|"'application/x-put'"
op|','
name|'obj_put_timestamp'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'objects'
op|'['
number|'0'
op|']'
op|','
name|'expected'
op|')'
newline|'\n'
nl|'\n'
comment|'# having safely enqueued to the reconciler we can advance'
nl|'\n'
comment|'# our sync pointer'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'broker'
op|'.'
name|'get_reconciler_sync'
op|'('
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multiple_out_sync_reconciler_enqueue_normalize
dedent|''
name|'def'
name|'test_multiple_out_sync_reconciler_enqueue_normalize'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ts'
op|'='
op|'('
name|'Timestamp'
op|'('
name|'t'
op|')'
op|'.'
name|'internal'
name|'for'
name|'t'
name|'in'
nl|'\n'
name|'itertools'
op|'.'
name|'count'
op|'('
name|'int'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
op|')'
newline|'\n'
name|'policy'
op|'='
name|'random'
op|'.'
name|'choice'
op|'('
name|'list'
op|'('
name|'POLICIES'
op|')'
op|')'
newline|'\n'
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
name|'remote_policy'
op|'='
name|'random'
op|'.'
name|'choice'
op|'('
op|'['
name|'p'
name|'for'
name|'p'
name|'in'
name|'POLICIES'
name|'if'
name|'p'
name|'is'
name|'not'
nl|'\n'
name|'policy'
op|']'
op|')'
newline|'\n'
name|'remote_broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'1'
op|')'
newline|'\n'
name|'remote_broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
name|'remote_policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
nl|'\n'
comment|'# add some rows to brokers'
nl|'\n'
name|'for'
name|'db'
name|'in'
op|'('
name|'broker'
op|','
name|'remote_broker'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'p'
name|'in'
op|'('
name|'policy'
op|','
name|'remote_policy'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'db'
op|'.'
name|'put_object'
op|'('
string|"'o-%s'"
op|'%'
name|'p'
op|'.'
name|'name'
op|','
name|'next'
op|'('
name|'ts'
op|')'
op|','
number|'0'
op|','
string|"'content-type'"
op|','
nl|'\n'
string|"'etag'"
op|','
name|'storage_policy_index'
op|'='
name|'p'
op|'.'
name|'idx'
op|')'
newline|'\n'
dedent|''
name|'db'
op|'.'
name|'_commit_puts'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'expected_policy_stats'
op|'='
op|'{'
nl|'\n'
name|'policy'
op|'.'
name|'idx'
op|':'
op|'{'
string|"'object_count'"
op|':'
number|'1'
op|','
string|"'bytes_used'"
op|':'
number|'0'
op|'}'
op|','
nl|'\n'
name|'remote_policy'
op|'.'
name|'idx'
op|':'
op|'{'
string|"'object_count'"
op|':'
number|'1'
op|','
string|"'bytes_used'"
op|':'
number|'0'
op|'}'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'for'
name|'db'
name|'in'
op|'('
name|'broker'
op|','
name|'remote_broker'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'policy_stats'
op|'='
name|'db'
op|'.'
name|'get_policy_stats'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'policy_stats'
op|','
name|'expected_policy_stats'
op|')'
newline|'\n'
nl|'\n'
comment|'# each db has 2 rows, 4 total'
nl|'\n'
dedent|''
name|'all_items'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'db'
name|'in'
op|'('
name|'broker'
op|','
name|'remote_broker'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'items'
op|'='
name|'db'
op|'.'
name|'get_items_since'
op|'('
op|'-'
number|'1'
op|','
number|'4'
op|')'
newline|'\n'
name|'all_items'
op|'.'
name|'update'
op|'('
nl|'\n'
op|'('
name|'item'
op|'['
string|"'name'"
op|']'
op|','
name|'item'
op|'['
string|"'created_at'"
op|']'
op|')'
name|'for'
name|'item'
name|'in'
name|'items'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'4'
op|','
name|'len'
op|'('
name|'all_items'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# replicate both ways'
nl|'\n'
name|'part'
op|','
name|'node'
op|'='
name|'self'
op|'.'
name|'_get_broker_part_node'
op|'('
name|'broker'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_run_once'
op|'('
name|'node'
op|')'
newline|'\n'
name|'part'
op|','
name|'node'
op|'='
name|'self'
op|'.'
name|'_get_broker_part_node'
op|'('
name|'remote_broker'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_run_once'
op|'('
name|'node'
op|')'
newline|'\n'
nl|'\n'
comment|'# only the latest timestamps should survive'
nl|'\n'
name|'most_recent_items'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'name'
op|','
name|'timestamp'
name|'in'
name|'all_items'
op|':'
newline|'\n'
indent|'            '
name|'most_recent_items'
op|'['
name|'name'
op|']'
op|'='
name|'max'
op|'('
nl|'\n'
name|'timestamp'
op|','
name|'most_recent_items'
op|'.'
name|'get'
op|'('
name|'name'
op|','
op|'-'
number|'1'
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'len'
op|'('
name|'most_recent_items'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'db'
name|'in'
op|'('
name|'broker'
op|','
name|'remote_broker'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'items'
op|'='
name|'db'
op|'.'
name|'get_items_since'
op|'('
op|'-'
number|'1'
op|','
number|'4'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'items'
op|')'
op|','
name|'len'
op|'('
name|'most_recent_items'
op|')'
op|')'
newline|'\n'
name|'for'
name|'item'
name|'in'
name|'items'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'most_recent_items'
op|'['
name|'item'
op|'['
string|"'name'"
op|']'
op|']'
op|','
nl|'\n'
name|'item'
op|'['
string|"'created_at'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# and the reconciler also collapses updates'
nl|'\n'
dedent|''
dedent|''
name|'reconciler_containers'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'item'
name|'in'
name|'all_items'
op|':'
newline|'\n'
indent|'            '
name|'_name'
op|','
name|'timestamp'
op|'='
name|'item'
newline|'\n'
name|'reconciler_containers'
op|'.'
name|'add'
op|'('
nl|'\n'
name|'get_reconciler_container_name'
op|'('
name|'timestamp'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'reconciler_items'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'reconciler_container'
name|'in'
name|'reconciler_containers'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'node_index'
name|'in'
name|'range'
op|'('
number|'3'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'reconciler'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
name|'MISPLACED_OBJECTS_ACCOUNT'
op|','
nl|'\n'
name|'reconciler_container'
op|','
nl|'\n'
name|'node_index'
op|'='
name|'node_index'
op|')'
newline|'\n'
name|'items'
op|'='
name|'reconciler'
op|'.'
name|'get_items_since'
op|'('
op|'-'
number|'1'
op|','
number|'4'
op|')'
newline|'\n'
name|'reconciler_items'
op|'.'
name|'update'
op|'('
nl|'\n'
op|'('
name|'item'
op|'['
string|"'name'"
op|']'
op|','
name|'item'
op|'['
string|"'created_at'"
op|']'
op|')'
name|'for'
name|'item'
name|'in'
name|'items'
op|')'
newline|'\n'
comment|"# they can't *both* be in the wrong policy ;)"
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'len'
op|'('
name|'reconciler_items'
op|')'
op|')'
newline|'\n'
name|'for'
name|'reconciler_name'
op|','
name|'timestamp'
name|'in'
name|'reconciler_items'
op|':'
newline|'\n'
indent|'            '
name|'_policy_index'
op|','
name|'path'
op|'='
name|'reconciler_name'
op|'.'
name|'split'
op|'('
string|"':'"
op|','
number|'1'
op|')'
newline|'\n'
name|'a'
op|','
name|'c'
op|','
name|'name'
op|'='
name|'path'
op|'.'
name|'lstrip'
op|'('
string|"'/'"
op|')'
op|'.'
name|'split'
op|'('
string|"'/'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'most_recent_items'
op|'['
name|'name'
op|']'
op|','
name|'timestamp'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'contextmanager'
newline|'\n'
DECL|member|_wrap_update_reconciler_sync
name|'def'
name|'_wrap_update_reconciler_sync'
op|'('
name|'self'
op|','
name|'broker'
op|','
name|'calls'
op|')'
op|':'
newline|'\n'
DECL|function|wrapper_function
indent|'        '
name|'def'
name|'wrapper_function'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'calls'
op|'.'
name|'append'
op|'('
name|'args'
op|')'
newline|'\n'
name|'orig_function'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'orig_function'
op|'='
name|'broker'
op|'.'
name|'update_reconciler_sync'
newline|'\n'
name|'broker'
op|'.'
name|'update_reconciler_sync'
op|'='
name|'wrapper_function'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'yield'
name|'True'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'broker'
op|'.'
name|'update_reconciler_sync'
op|'='
name|'orig_function'
newline|'\n'
nl|'\n'
DECL|member|test_post_replicate_hook
dedent|''
dedent|''
name|'def'
name|'test_post_replicate_hook'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ts'
op|'='
op|'('
name|'Timestamp'
op|'('
name|'t'
op|')'
op|'.'
name|'internal'
name|'for'
name|'t'
name|'in'
nl|'\n'
name|'itertools'
op|'.'
name|'count'
op|'('
name|'int'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
op|')'
newline|'\n'
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_broker'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
name|'node_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'next'
op|'('
name|'ts'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'put_object'
op|'('
string|"'foo'"
op|','
name|'next'
op|'('
name|'ts'
op|')'
op|','
number|'0'
op|','
string|"'text/plain'"
op|','
string|"'xyz'"
op|','
name|'deleted'
op|'='
number|'0'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'0'
op|')'
newline|'\n'
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_replication_info'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'info'
op|'['
string|"'max_row'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'-'
number|'1'
op|','
name|'broker'
op|'.'
name|'get_reconciler_sync'
op|'('
op|')'
op|')'
newline|'\n'
name|'daemon'
op|'='
name|'replicator'
op|'.'
name|'ContainerReplicator'
op|'('
op|'{'
op|'}'
op|')'
newline|'\n'
name|'calls'
op|'='
op|'['
op|']'
newline|'\n'
name|'with'
name|'self'
op|'.'
name|'_wrap_update_reconciler_sync'
op|'('
name|'broker'
op|','
name|'calls'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'daemon'
op|'.'
name|'_post_replicate_hook'
op|'('
name|'broker'
op|','
name|'info'
op|','
op|'['
op|']'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'len'
op|'('
name|'calls'
op|')'
op|')'
newline|'\n'
comment|'# repeated call to _post_replicate_hook with no change to info'
nl|'\n'
comment|'# should not call update_reconciler_sync'
nl|'\n'
name|'calls'
op|'='
op|'['
op|']'
newline|'\n'
name|'with'
name|'self'
op|'.'
name|'_wrap_update_reconciler_sync'
op|'('
name|'broker'
op|','
name|'calls'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'daemon'
op|'.'
name|'_post_replicate_hook'
op|'('
name|'broker'
op|','
name|'info'
op|','
op|'['
op|']'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'len'
op|'('
name|'calls'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'__name__'
op|'=='
string|"'__main__'"
op|':'
newline|'\n'
indent|'    '
name|'unittest'
op|'.'
name|'main'
op|'('
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit

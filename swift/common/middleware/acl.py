begin_unit
comment|'# Copyright (c) 2010-2012 OpenStack Foundation'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'json'
newline|'\n'
nl|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'urlparse'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|clean_acl
name|'def'
name|'clean_acl'
op|'('
name|'name'
op|','
name|'value'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Returns a cleaned ACL header value, validating that it meets the formatting\n    requirements for standard Swift ACL strings.\n\n    The ACL format is::\n\n        [item[,item...]]\n\n    Each item can be a group name to give access to or a referrer designation\n    to grant or deny based on the HTTP Referer header.\n\n    The referrer designation format is::\n\n        .r:[-]value\n\n    The ``.r`` can also be ``.ref``, ``.referer``, or ``.referrer``; though it\n    will be shortened to just ``.r`` for decreased character count usage.\n\n    The value can be ``*`` to specify any referrer host is allowed access, a\n    specific host name like ``www.example.com``, or if it has a leading period\n    ``.`` or leading ``*.`` it is a domain name specification, like\n    ``.example.com`` or ``*.example.com``. The leading minus sign ``-``\n    indicates referrer hosts that should be denied access.\n\n    Referrer access is applied in the order they are specified. For example,\n    .r:.example.com,.r:-thief.example.com would allow all hosts ending with\n    .example.com except for the specific host thief.example.com.\n\n    Example valid ACLs::\n\n        .r:*\n        .r:*,.r:-.thief.com\n        .r:*,.r:.example.com,.r:-thief.example.com\n        .r:*,.r:-.thief.com,bobs_account,sues_account:sue\n        bobs_account,sues_account:sue\n\n    Example invalid ACLs::\n\n        .r:\n        .r:-\n\n    By default, allowing read access via .r will not allow listing objects in\n    the container -- just retrieving objects from the container. To turn on\n    listings, use the .rlistings directive.\n\n    Also, .r designations aren\'t allowed in headers whose names include the\n    word \'write\'.\n\n    ACLs that are "messy" will be cleaned up. Examples:\n\n    ======================  ======================\n    Original                Cleaned\n    ----------------------  ----------------------\n    ``bob, sue``            ``bob,sue``\n    ``bob , sue``           ``bob,sue``\n    ``bob,,,sue``           ``bob,sue``\n    ``.referrer : *``       ``.r:*``\n    ``.ref:*.example.com``  ``.r:.example.com``\n    ``.r:*, .rlistings``    ``.r:*,.rlistings``\n    ======================  ======================\n\n    :param name: The name of the header being cleaned, such as X-Container-Read\n                 or X-Container-Write.\n    :param value: The value of the header being cleaned.\n    :returns: The value, cleaned of extraneous formatting.\n    :raises ValueError: If the value does not meet the ACL formatting\n                        requirements; the error message will indicate why.\n    """'
newline|'\n'
name|'name'
op|'='
name|'name'
op|'.'
name|'lower'
op|'('
op|')'
newline|'\n'
name|'values'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'raw_value'
name|'in'
name|'value'
op|'.'
name|'split'
op|'('
string|"','"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'raw_value'
op|'='
name|'raw_value'
op|'.'
name|'strip'
op|'('
op|')'
newline|'\n'
name|'if'
name|'not'
name|'raw_value'
op|':'
newline|'\n'
indent|'            '
name|'continue'
newline|'\n'
dedent|''
name|'if'
string|"':'"
name|'not'
name|'in'
name|'raw_value'
op|':'
newline|'\n'
indent|'            '
name|'values'
op|'.'
name|'append'
op|'('
name|'raw_value'
op|')'
newline|'\n'
name|'continue'
newline|'\n'
dedent|''
name|'first'
op|','
name|'second'
op|'='
op|'('
name|'v'
op|'.'
name|'strip'
op|'('
op|')'
name|'for'
name|'v'
name|'in'
name|'raw_value'
op|'.'
name|'split'
op|'('
string|"':'"
op|','
number|'1'
op|')'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'first'
name|'or'
name|'not'
name|'first'
op|'.'
name|'startswith'
op|'('
string|"'.'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'values'
op|'.'
name|'append'
op|'('
name|'raw_value'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'first'
name|'in'
op|'('
string|"'.r'"
op|','
string|"'.ref'"
op|','
string|"'.referer'"
op|','
string|"'.referrer'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
string|"'write'"
name|'in'
name|'name'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'ValueError'
op|'('
string|"'Referrers not allowed in write ACL: '"
nl|'\n'
string|"'%s'"
op|'%'
name|'repr'
op|'('
name|'raw_value'
op|')'
op|')'
newline|'\n'
dedent|''
name|'negate'
op|'='
name|'False'
newline|'\n'
name|'if'
name|'second'
name|'and'
name|'second'
op|'.'
name|'startswith'
op|'('
string|"'-'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'negate'
op|'='
name|'True'
newline|'\n'
name|'second'
op|'='
name|'second'
op|'['
number|'1'
op|':'
op|']'
op|'.'
name|'strip'
op|'('
op|')'
newline|'\n'
dedent|''
name|'if'
name|'second'
name|'and'
name|'second'
op|'!='
string|"'*'"
name|'and'
name|'second'
op|'.'
name|'startswith'
op|'('
string|"'*'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'second'
op|'='
name|'second'
op|'['
number|'1'
op|':'
op|']'
op|'.'
name|'strip'
op|'('
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'second'
name|'or'
name|'second'
op|'=='
string|"'.'"
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'ValueError'
op|'('
string|"'No host/domain value after referrer '"
nl|'\n'
string|"'designation in ACL: %s'"
op|'%'
name|'repr'
op|'('
name|'raw_value'
op|')'
op|')'
newline|'\n'
dedent|''
name|'values'
op|'.'
name|'append'
op|'('
string|"'.r:%s%s'"
op|'%'
op|'('
string|"'-'"
name|'if'
name|'negate'
name|'else'
string|"''"
op|','
name|'second'
op|')'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'ValueError'
op|'('
string|"'Unknown designator %s in ACL: %s'"
op|'%'
nl|'\n'
op|'('
name|'repr'
op|'('
name|'first'
op|')'
op|','
name|'repr'
op|'('
name|'raw_value'
op|')'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
string|"','"
op|'.'
name|'join'
op|'('
name|'values'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|format_acl_v1
dedent|''
name|'def'
name|'format_acl_v1'
op|'('
name|'groups'
op|'='
name|'None'
op|','
name|'referrers'
op|'='
name|'None'
op|','
name|'header_name'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Returns a standard Swift ACL string for the given inputs.\n\n    Caller is responsible for ensuring that :referrers: parameter is only given\n    if the ACL is being generated for X-Container-Read.  (X-Container-Write\n    and the account ACL headers don\'t support referrers.)\n\n    :param groups: a list of groups (and/or members in most auth systems) to\n                   grant access\n    :param referrers: a list of referrer designations (without the leading .r:)\n    :param header_name: (optional) header name of the ACL we\'re preparing, for\n                        clean_acl; if None, returned ACL won\'t be cleaned\n    :returns: a Swift ACL string for use in X-Container-{Read,Write},\n              X-Account-Access-Control, etc.\n    """'
newline|'\n'
name|'groups'
op|','
name|'referrers'
op|'='
name|'groups'
name|'or'
op|'['
op|']'
op|','
name|'referrers'
name|'or'
op|'['
op|']'
newline|'\n'
name|'referrers'
op|'='
op|'['
string|"'.r:%s'"
op|'%'
name|'r'
name|'for'
name|'r'
name|'in'
name|'referrers'
op|']'
newline|'\n'
name|'result'
op|'='
string|"','"
op|'.'
name|'join'
op|'('
name|'groups'
op|'+'
name|'referrers'
op|')'
newline|'\n'
name|'return'
op|'('
name|'clean_acl'
op|'('
name|'header_name'
op|','
name|'result'
op|')'
name|'if'
name|'header_name'
name|'else'
name|'result'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|format_acl_v2
dedent|''
name|'def'
name|'format_acl_v2'
op|'('
name|'acl_dict'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Returns a version-2 Swift ACL JSON string.\n\n    HTTP headers for Version 2 ACLs have the following form:\n      Header-Name: {"arbitrary":"json","encoded":"string"}\n\n    JSON will be forced ASCII (containing six-char \\uNNNN sequences rather\n    than UTF-8; UTF-8 is valid JSON but clients vary in their support for\n    UTF-8 headers), and without extraneous whitespace.\n\n    Advantages over V1: forward compatibility (new keys don\'t cause parsing\n    exceptions); Unicode support; no reserved words (you can have a user\n    named .rlistings if you want).\n\n    :param acl_dict: dict of arbitrary data to put in the ACL; see specific\n                     auth systems such as tempauth for supported values\n    :returns: a JSON string which encodes the ACL\n    """'
newline|'\n'
name|'return'
name|'json'
op|'.'
name|'dumps'
op|'('
name|'acl_dict'
op|','
name|'ensure_ascii'
op|'='
name|'True'
op|','
name|'separators'
op|'='
op|'('
string|"','"
op|','
string|"':'"
op|')'
op|','
nl|'\n'
name|'sort_keys'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|format_acl
dedent|''
name|'def'
name|'format_acl'
op|'('
name|'version'
op|'='
number|'1'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Compatibility wrapper to help migrate ACL syntax from version 1 to 2.\n    Delegates to the appropriate version-specific format_acl method, defaulting\n    to version 1 for backward compatibility.\n\n    :param kwargs: keyword args appropriate for the selected ACL syntax version\n                   (see :func:`format_acl_v1` or :func:`format_acl_v2`)\n    """'
newline|'\n'
name|'if'
name|'version'
op|'=='
number|'1'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'format_acl_v1'
op|'('
nl|'\n'
name|'groups'
op|'='
name|'kwargs'
op|'.'
name|'get'
op|'('
string|"'groups'"
op|')'
op|','
name|'referrers'
op|'='
name|'kwargs'
op|'.'
name|'get'
op|'('
string|"'referrers'"
op|')'
op|','
nl|'\n'
name|'header_name'
op|'='
name|'kwargs'
op|'.'
name|'get'
op|'('
string|"'header_name'"
op|')'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'version'
op|'=='
number|'2'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'format_acl_v2'
op|'('
name|'kwargs'
op|'.'
name|'get'
op|'('
string|"'acl_dict'"
op|')'
op|')'
newline|'\n'
dedent|''
name|'raise'
name|'ValueError'
op|'('
string|'"Invalid ACL version: %r"'
op|'%'
name|'version'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|parse_acl_v1
dedent|''
name|'def'
name|'parse_acl_v1'
op|'('
name|'acl_string'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Parses a standard Swift ACL string into a referrers list and groups list.\n\n    See :func:`clean_acl` for documentation of the standard Swift ACL format.\n\n    :param acl_string: The standard Swift ACL string to parse.\n    :returns: A tuple of (referrers, groups) where referrers is a list of\n              referrer designations (without the leading .r:) and groups is a\n              list of groups to allow access.\n    """'
newline|'\n'
name|'referrers'
op|'='
op|'['
op|']'
newline|'\n'
name|'groups'
op|'='
op|'['
op|']'
newline|'\n'
name|'if'
name|'acl_string'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'value'
name|'in'
name|'acl_string'
op|'.'
name|'split'
op|'('
string|"','"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'value'
op|'.'
name|'startswith'
op|'('
string|"'.r:'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'referrers'
op|'.'
name|'append'
op|'('
name|'value'
op|'['
name|'len'
op|'('
string|"'.r:'"
op|')'
op|':'
op|']'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'groups'
op|'.'
name|'append'
op|'('
name|'value'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'return'
name|'referrers'
op|','
name|'groups'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|parse_acl_v2
dedent|''
name|'def'
name|'parse_acl_v2'
op|'('
name|'data'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Parses a version-2 Swift ACL string and returns a dict of ACL info.\n\n    :param data: string containing the ACL data in JSON format\n    :returns: A dict (possibly empty) containing ACL info, e.g.:\n              {"groups": [...], "referrers": [...]}\n    :returns: None if data is None, is not valid JSON or does not parse\n        as a dict\n    :returns: empty dictionary if data is an empty string\n    """'
newline|'\n'
name|'if'
name|'data'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'if'
name|'data'
name|'is'
string|"''"
op|':'
newline|'\n'
indent|'        '
name|'return'
op|'{'
op|'}'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'result'
op|'='
name|'json'
op|'.'
name|'loads'
op|'('
name|'data'
op|')'
newline|'\n'
name|'return'
op|'('
name|'result'
name|'if'
name|'type'
op|'('
name|'result'
op|')'
name|'is'
name|'dict'
name|'else'
name|'None'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'None'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|parse_acl
dedent|''
dedent|''
name|'def'
name|'parse_acl'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Compatibility wrapper to help migrate ACL syntax from version 1 to 2.\n    Delegates to the appropriate version-specific parse_acl method, attempting\n    to determine the version from the types of args/kwargs.\n\n    :param args: positional args for the selected ACL syntax version\n    :param kwargs: keyword args for the selected ACL syntax version\n                   (see :func:`parse_acl_v1` or :func:`parse_acl_v2`)\n    :returns: the return value of :func:`parse_acl_v1` or :func:`parse_acl_v2`\n    """'
newline|'\n'
name|'version'
op|'='
name|'kwargs'
op|'.'
name|'pop'
op|'('
string|"'version'"
op|','
name|'None'
op|')'
newline|'\n'
name|'if'
name|'version'
name|'in'
op|'('
number|'1'
op|','
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'parse_acl_v1'
op|'('
op|'*'
name|'args'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'version'
op|'=='
number|'2'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'parse_acl_v2'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'ValueError'
op|'('
string|"'Unknown ACL version: parse_acl(%r, %r)'"
op|'%'
nl|'\n'
op|'('
name|'args'
op|','
name|'kwargs'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|referrer_allowed
dedent|''
dedent|''
name|'def'
name|'referrer_allowed'
op|'('
name|'referrer'
op|','
name|'referrer_acl'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Returns True if the referrer should be allowed based on the referrer_acl\n    list (as returned by :func:`parse_acl`).\n\n    See :func:`clean_acl` for documentation of the standard Swift ACL format.\n\n    :param referrer: The value of the HTTP Referer header.\n    :param referrer_acl: The list of referrer designations as returned by\n                         :func:`parse_acl`.\n    :returns: True if the referrer should be allowed; False if not.\n    """'
newline|'\n'
name|'allow'
op|'='
name|'False'
newline|'\n'
name|'if'
name|'referrer_acl'
op|':'
newline|'\n'
indent|'        '
name|'rhost'
op|'='
name|'urlparse'
op|'('
name|'referrer'
name|'or'
string|"''"
op|')'
op|'.'
name|'hostname'
name|'or'
string|"'unknown'"
newline|'\n'
name|'for'
name|'mhost'
name|'in'
name|'referrer_acl'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'mhost'
op|'.'
name|'startswith'
op|'('
string|"'-'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'mhost'
op|'='
name|'mhost'
op|'['
number|'1'
op|':'
op|']'
newline|'\n'
name|'if'
name|'mhost'
op|'=='
name|'rhost'
name|'or'
op|'('
name|'mhost'
op|'.'
name|'startswith'
op|'('
string|"'.'"
op|')'
name|'and'
nl|'\n'
name|'rhost'
op|'.'
name|'endswith'
op|'('
name|'mhost'
op|')'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'allow'
op|'='
name|'False'
newline|'\n'
dedent|''
dedent|''
name|'elif'
name|'mhost'
op|'=='
string|"'*'"
name|'or'
name|'mhost'
op|'=='
name|'rhost'
name|'or'
op|'('
name|'mhost'
op|'.'
name|'startswith'
op|'('
string|"'.'"
op|')'
name|'and'
name|'rhost'
op|'.'
name|'endswith'
op|'('
name|'mhost'
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'allow'
op|'='
name|'True'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'return'
name|'allow'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|acls_from_account_info
dedent|''
name|'def'
name|'acls_from_account_info'
op|'('
name|'info'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Extract the account ACLs from the given account_info, and return the ACLs.\n\n    :param info: a dict of the form returned by get_account_info\n    :returns: None (no ACL system metadata is set), or a dict of the form::\n       {\'admin\': [...], \'read-write\': [...], \'read-only\': [...]}\n\n    :raises ValueError: on a syntactically invalid header\n    """'
newline|'\n'
name|'acl'
op|'='
name|'parse_acl'
op|'('
nl|'\n'
name|'version'
op|'='
number|'2'
op|','
name|'data'
op|'='
name|'info'
op|'.'
name|'get'
op|'('
string|"'sysmeta'"
op|','
op|'{'
op|'}'
op|')'
op|'.'
name|'get'
op|'('
string|"'core-access-control'"
op|')'
op|')'
newline|'\n'
name|'if'
name|'acl'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'admin_members'
op|'='
name|'acl'
op|'.'
name|'get'
op|'('
string|"'admin'"
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'readwrite_members'
op|'='
name|'acl'
op|'.'
name|'get'
op|'('
string|"'read-write'"
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'readonly_members'
op|'='
name|'acl'
op|'.'
name|'get'
op|'('
string|"'read-only'"
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'any'
op|'('
op|'('
name|'admin_members'
op|','
name|'readwrite_members'
op|','
name|'readonly_members'
op|')'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'return'
op|'{'
nl|'\n'
string|"'admin'"
op|':'
name|'admin_members'
op|','
nl|'\n'
string|"'read-write'"
op|':'
name|'readwrite_members'
op|','
nl|'\n'
string|"'read-only'"
op|':'
name|'readonly_members'
op|','
nl|'\n'
op|'}'
newline|'\n'
dedent|''
endmarker|''
end_unit

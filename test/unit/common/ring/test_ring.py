begin_unit
comment|'# Copyright (c) 2010-2012 OpenStack Foundation'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'array'
newline|'\n'
name|'import'
name|'six'
op|'.'
name|'moves'
op|'.'
name|'cPickle'
name|'as'
name|'pickle'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'unittest'
newline|'\n'
name|'import'
name|'stat'
newline|'\n'
name|'from'
name|'contextlib'
name|'import'
name|'closing'
newline|'\n'
name|'from'
name|'gzip'
name|'import'
name|'GzipFile'
newline|'\n'
name|'from'
name|'tempfile'
name|'import'
name|'mkdtemp'
newline|'\n'
name|'from'
name|'shutil'
name|'import'
name|'rmtree'
newline|'\n'
name|'from'
name|'time'
name|'import'
name|'sleep'
op|','
name|'time'
newline|'\n'
name|'import'
name|'random'
newline|'\n'
nl|'\n'
name|'from'
name|'six'
op|'.'
name|'moves'
name|'import'
name|'range'
newline|'\n'
nl|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'ring'
op|','
name|'utils'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'ring'
name|'import'
name|'utils'
name|'as'
name|'ring_utils'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|TestRingBase
name|'class'
name|'TestRingBase'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_orig_hash_suffix'
op|'='
name|'utils'
op|'.'
name|'HASH_PATH_SUFFIX'
newline|'\n'
name|'self'
op|'.'
name|'_orig_hash_prefix'
op|'='
name|'utils'
op|'.'
name|'HASH_PATH_PREFIX'
newline|'\n'
name|'utils'
op|'.'
name|'HASH_PATH_SUFFIX'
op|'='
string|"'endcap'"
newline|'\n'
name|'utils'
op|'.'
name|'HASH_PATH_PREFIX'
op|'='
string|"''"
newline|'\n'
nl|'\n'
DECL|member|tearDown
dedent|''
name|'def'
name|'tearDown'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'utils'
op|'.'
name|'HASH_PATH_SUFFIX'
op|'='
name|'self'
op|'.'
name|'_orig_hash_suffix'
newline|'\n'
name|'utils'
op|'.'
name|'HASH_PATH_PREFIX'
op|'='
name|'self'
op|'.'
name|'_orig_hash_prefix'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|TestRingData
dedent|''
dedent|''
name|'class'
name|'TestRingData'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'testdir'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'dirname'
op|'('
name|'__file__'
op|')'
op|','
string|"'ring_data'"
op|')'
newline|'\n'
name|'rmtree'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'ignore_errors'
op|'='
number|'1'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'mkdir'
op|'('
name|'self'
op|'.'
name|'testdir'
op|')'
newline|'\n'
nl|'\n'
DECL|member|tearDown
dedent|''
name|'def'
name|'tearDown'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rmtree'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'ignore_errors'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|assert_ring_data_equal
dedent|''
name|'def'
name|'assert_ring_data_equal'
op|'('
name|'self'
op|','
name|'rd_expected'
op|','
name|'rd_got'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rd_expected'
op|'.'
name|'_replica2part2dev_id'
op|','
nl|'\n'
name|'rd_got'
op|'.'
name|'_replica2part2dev_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rd_expected'
op|'.'
name|'devs'
op|','
name|'rd_got'
op|'.'
name|'devs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rd_expected'
op|'.'
name|'_part_shift'
op|','
name|'rd_got'
op|'.'
name|'_part_shift'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_attrs
dedent|''
name|'def'
name|'test_attrs'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'r2p2d'
op|'='
op|'['
op|'['
number|'0'
op|','
number|'1'
op|','
number|'0'
op|','
number|'1'
op|']'
op|','
op|'['
number|'0'
op|','
number|'1'
op|','
number|'0'
op|','
number|'1'
op|']'
op|']'
newline|'\n'
name|'d'
op|'='
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'10.1.1.0'"
op|','
string|"'port'"
op|':'
number|'7000'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
string|"'port'"
op|':'
number|'7000'
op|'}'
op|']'
newline|'\n'
name|'s'
op|'='
number|'30'
newline|'\n'
name|'rd'
op|'='
name|'ring'
op|'.'
name|'RingData'
op|'('
name|'r2p2d'
op|','
name|'d'
op|','
name|'s'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rd'
op|'.'
name|'_replica2part2dev_id'
op|','
name|'r2p2d'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rd'
op|'.'
name|'devs'
op|','
name|'d'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rd'
op|'.'
name|'_part_shift'
op|','
name|'s'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_can_load_pickled_ring_data
dedent|''
name|'def'
name|'test_can_load_pickled_ring_data'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rd'
op|'='
name|'ring'
op|'.'
name|'RingData'
op|'('
nl|'\n'
op|'['
op|'['
number|'0'
op|','
number|'1'
op|','
number|'0'
op|','
number|'1'
op|']'
op|','
op|'['
number|'0'
op|','
number|'1'
op|','
number|'0'
op|','
number|'1'
op|']'
op|']'
op|','
nl|'\n'
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'10.1.1.0'"
op|','
string|"'port'"
op|':'
number|'7000'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
string|"'port'"
op|':'
number|'7000'
op|'}'
op|']'
op|','
nl|'\n'
number|'30'
op|')'
newline|'\n'
name|'ring_fname'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
string|"'foo.ring.gz'"
op|')'
newline|'\n'
name|'for'
name|'p'
name|'in'
name|'range'
op|'('
name|'pickle'
op|'.'
name|'HIGHEST_PROTOCOL'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'closing'
op|'('
name|'GzipFile'
op|'('
name|'ring_fname'
op|','
string|"'wb'"
op|')'
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'                '
name|'pickle'
op|'.'
name|'dump'
op|'('
name|'rd'
op|','
name|'f'
op|','
name|'protocol'
op|'='
name|'p'
op|')'
newline|'\n'
dedent|''
name|'meta_only'
op|'='
name|'ring'
op|'.'
name|'RingData'
op|'.'
name|'load'
op|'('
name|'ring_fname'
op|','
name|'metadata_only'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'10.1.1.0'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'7000'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'7000'
op|'}'
op|','
nl|'\n'
op|']'
op|','
name|'meta_only'
op|'.'
name|'devs'
op|')'
newline|'\n'
comment|"# Pickled rings can't load only metadata, so you get it all"
nl|'\n'
name|'self'
op|'.'
name|'assert_ring_data_equal'
op|'('
name|'rd'
op|','
name|'meta_only'
op|')'
newline|'\n'
name|'ring_data'
op|'='
name|'ring'
op|'.'
name|'RingData'
op|'.'
name|'load'
op|'('
name|'ring_fname'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assert_ring_data_equal'
op|'('
name|'rd'
op|','
name|'ring_data'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_roundtrip_serialization
dedent|''
dedent|''
name|'def'
name|'test_roundtrip_serialization'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ring_fname'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
string|"'foo.ring.gz'"
op|')'
newline|'\n'
name|'rd'
op|'='
name|'ring'
op|'.'
name|'RingData'
op|'('
nl|'\n'
op|'['
name|'array'
op|'.'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'0'
op|','
number|'1'
op|','
number|'0'
op|','
number|'1'
op|']'
op|')'
op|','
name|'array'
op|'.'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'0'
op|','
number|'1'
op|','
number|'0'
op|','
number|'1'
op|']'
op|')'
op|']'
op|','
nl|'\n'
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|'}'
op|','
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|'}'
op|']'
op|','
number|'30'
op|')'
newline|'\n'
name|'rd'
op|'.'
name|'save'
op|'('
name|'ring_fname'
op|')'
newline|'\n'
name|'meta_only'
op|'='
name|'ring'
op|'.'
name|'RingData'
op|'.'
name|'load'
op|'('
name|'ring_fname'
op|','
name|'metadata_only'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'1'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'1'
op|'}'
op|','
nl|'\n'
op|']'
op|','
name|'meta_only'
op|'.'
name|'devs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
op|']'
op|','
name|'meta_only'
op|'.'
name|'_replica2part2dev_id'
op|')'
newline|'\n'
name|'rd2'
op|'='
name|'ring'
op|'.'
name|'RingData'
op|'.'
name|'load'
op|'('
name|'ring_fname'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assert_ring_data_equal'
op|'('
name|'rd'
op|','
name|'rd2'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_deterministic_serialization
dedent|''
name|'def'
name|'test_deterministic_serialization'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Two identical rings should produce identical .gz files on disk.\n        """'
newline|'\n'
name|'os'
op|'.'
name|'mkdir'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
string|"'1'"
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'mkdir'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
string|"'2'"
op|')'
op|')'
newline|'\n'
comment|'# These have to have the same filename (not full path,'
nl|'\n'
comment|'# obviously) since the filename gets encoded in the gzip data.'
nl|'\n'
name|'ring_fname1'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
string|"'1'"
op|','
string|"'the.ring.gz'"
op|')'
newline|'\n'
name|'ring_fname2'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
string|"'2'"
op|','
string|"'the.ring.gz'"
op|')'
newline|'\n'
name|'rd'
op|'='
name|'ring'
op|'.'
name|'RingData'
op|'('
nl|'\n'
op|'['
name|'array'
op|'.'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'0'
op|','
number|'1'
op|','
number|'0'
op|','
number|'1'
op|']'
op|')'
op|','
name|'array'
op|'.'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'0'
op|','
number|'1'
op|','
number|'0'
op|','
number|'1'
op|']'
op|')'
op|']'
op|','
nl|'\n'
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|'}'
op|','
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|'}'
op|']'
op|','
number|'30'
op|')'
newline|'\n'
name|'rd'
op|'.'
name|'save'
op|'('
name|'ring_fname1'
op|')'
newline|'\n'
name|'rd'
op|'.'
name|'save'
op|'('
name|'ring_fname2'
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
name|'ring_fname1'
op|')'
name|'as'
name|'ring1'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'open'
op|'('
name|'ring_fname2'
op|')'
name|'as'
name|'ring2'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'ring1'
op|'.'
name|'read'
op|'('
op|')'
op|','
name|'ring2'
op|'.'
name|'read'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_permissions
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_permissions'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ring_fname'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
string|"'stat.ring.gz'"
op|')'
newline|'\n'
name|'rd'
op|'='
name|'ring'
op|'.'
name|'RingData'
op|'('
nl|'\n'
op|'['
name|'array'
op|'.'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'0'
op|','
number|'1'
op|','
number|'0'
op|','
number|'1'
op|']'
op|')'
op|','
name|'array'
op|'.'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'0'
op|','
number|'1'
op|','
number|'0'
op|','
number|'1'
op|']'
op|')'
op|']'
op|','
nl|'\n'
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|'}'
op|','
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'1'
op|'}'
op|']'
op|','
number|'30'
op|')'
newline|'\n'
name|'rd'
op|'.'
name|'save'
op|'('
name|'ring_fname'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'oct'
op|'('
name|'stat'
op|'.'
name|'S_IMODE'
op|'('
name|'os'
op|'.'
name|'stat'
op|'('
name|'ring_fname'
op|')'
op|'.'
name|'st_mode'
op|')'
op|')'
op|','
nl|'\n'
string|"'0644'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|TestRing
dedent|''
dedent|''
name|'class'
name|'TestRing'
op|'('
name|'TestRingBase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'TestRing'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'testdir'
op|'='
name|'mkdtemp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'testgz'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
string|"'whatever.ring.gz'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'intended_replica2part2dev_id'
op|'='
op|'['
nl|'\n'
name|'array'
op|'.'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'0'
op|','
number|'1'
op|','
number|'0'
op|','
number|'1'
op|']'
op|')'
op|','
nl|'\n'
name|'array'
op|'.'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'0'
op|','
number|'1'
op|','
number|'0'
op|','
number|'1'
op|']'
op|')'
op|','
nl|'\n'
name|'array'
op|'.'
name|'array'
op|'('
string|"'H'"
op|','
op|'['
number|'3'
op|','
number|'4'
op|','
number|'3'
op|','
number|'4'
op|']'
op|')'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'='
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
string|"'port'"
op|':'
number|'6200'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'10.1.0.1'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'6066'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
string|"'port'"
op|':'
number|'6200'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'10.1.0.2'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'6066'
op|'}'
op|','
nl|'\n'
name|'None'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.2.1'"
op|','
string|"'port'"
op|':'
number|'6200'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'10.2.0.1'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'6066'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.2.2'"
op|','
string|"'port'"
op|':'
number|'6200'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'10.2.0.1'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'6066'
op|'}'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'intended_part_shift'
op|'='
number|'30'
newline|'\n'
name|'self'
op|'.'
name|'intended_reload_time'
op|'='
number|'15'
newline|'\n'
name|'ring'
op|'.'
name|'RingData'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'intended_replica2part2dev_id'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|','
name|'self'
op|'.'
name|'intended_part_shift'
op|')'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'testgz'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'ring'
op|'='
name|'ring'
op|'.'
name|'Ring'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'testdir'
op|','
nl|'\n'
name|'reload_time'
op|'='
name|'self'
op|'.'
name|'intended_reload_time'
op|','
name|'ring_name'
op|'='
string|"'whatever'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|tearDown
dedent|''
name|'def'
name|'tearDown'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'TestRing'
op|','
name|'self'
op|')'
op|'.'
name|'tearDown'
op|'('
op|')'
newline|'\n'
name|'rmtree'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'ignore_errors'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_creation
dedent|''
name|'def'
name|'test_creation'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'_replica2part2dev_id'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_replica2part2dev_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'_part_shift'
op|','
name|'self'
op|'.'
name|'intended_part_shift'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'devs'
op|','
name|'self'
op|'.'
name|'intended_devs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'reload_time'
op|','
name|'self'
op|'.'
name|'intended_reload_time'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'serialized_path'
op|','
name|'self'
op|'.'
name|'testgz'
op|')'
newline|'\n'
comment|'# test invalid endcap'
nl|'\n'
name|'_orig_hash_path_suffix'
op|'='
name|'utils'
op|'.'
name|'HASH_PATH_SUFFIX'
newline|'\n'
name|'_orig_hash_path_prefix'
op|'='
name|'utils'
op|'.'
name|'HASH_PATH_PREFIX'
newline|'\n'
name|'_orig_swift_conf_file'
op|'='
name|'utils'
op|'.'
name|'SWIFT_CONF_FILE'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'utils'
op|'.'
name|'HASH_PATH_SUFFIX'
op|'='
string|"''"
newline|'\n'
name|'utils'
op|'.'
name|'HASH_PATH_PREFIX'
op|'='
string|"''"
newline|'\n'
name|'utils'
op|'.'
name|'SWIFT_CONF_FILE'
op|'='
string|"''"
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'SystemExit'
op|','
name|'ring'
op|'.'
name|'Ring'
op|','
name|'self'
op|'.'
name|'testdir'
op|','
string|"'whatever'"
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'utils'
op|'.'
name|'HASH_PATH_SUFFIX'
op|'='
name|'_orig_hash_path_suffix'
newline|'\n'
name|'utils'
op|'.'
name|'HASH_PATH_PREFIX'
op|'='
name|'_orig_hash_path_prefix'
newline|'\n'
name|'utils'
op|'.'
name|'SWIFT_CONF_FILE'
op|'='
name|'_orig_swift_conf_file'
newline|'\n'
nl|'\n'
DECL|member|test_has_changed
dedent|''
dedent|''
name|'def'
name|'test_has_changed'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'has_changed'
op|'('
op|')'
op|','
name|'False'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'utime'
op|'('
name|'self'
op|'.'
name|'testgz'
op|','
op|'('
name|'time'
op|'('
op|')'
op|'+'
number|'60'
op|','
name|'time'
op|'('
op|')'
op|'+'
number|'60'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'has_changed'
op|'('
op|')'
op|','
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reload
dedent|''
name|'def'
name|'test_reload'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'os'
op|'.'
name|'utime'
op|'('
name|'self'
op|'.'
name|'testgz'
op|','
op|'('
name|'time'
op|'('
op|')'
op|'-'
number|'300'
op|','
name|'time'
op|'('
op|')'
op|'-'
number|'300'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'ring'
op|'='
name|'ring'
op|'.'
name|'Ring'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'reload_time'
op|'='
number|'0.001'
op|','
nl|'\n'
name|'ring_name'
op|'='
string|"'whatever'"
op|')'
newline|'\n'
name|'orig_mtime'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'_mtime'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'devs'
op|')'
op|','
number|'5'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'.'
name|'append'
op|'('
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'3'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
string|"'port'"
op|':'
number|'9876'
op|'}'
op|')'
newline|'\n'
name|'ring'
op|'.'
name|'RingData'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'intended_replica2part2dev_id'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|','
name|'self'
op|'.'
name|'intended_part_shift'
op|')'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'testgz'
op|')'
newline|'\n'
name|'sleep'
op|'('
number|'0.1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'devs'
op|')'
op|','
number|'6'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'_mtime'
op|','
name|'orig_mtime'
op|')'
newline|'\n'
nl|'\n'
name|'os'
op|'.'
name|'utime'
op|'('
name|'self'
op|'.'
name|'testgz'
op|','
op|'('
name|'time'
op|'('
op|')'
op|'-'
number|'300'
op|','
name|'time'
op|'('
op|')'
op|'-'
number|'300'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'ring'
op|'='
name|'ring'
op|'.'
name|'Ring'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'reload_time'
op|'='
number|'0.001'
op|','
nl|'\n'
name|'ring_name'
op|'='
string|"'whatever'"
op|')'
newline|'\n'
name|'orig_mtime'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'_mtime'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'devs'
op|')'
op|','
number|'6'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'.'
name|'append'
op|'('
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'4'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.5.5.5'"
op|','
string|"'port'"
op|':'
number|'9876'
op|'}'
op|')'
newline|'\n'
name|'ring'
op|'.'
name|'RingData'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'intended_replica2part2dev_id'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|','
name|'self'
op|'.'
name|'intended_part_shift'
op|')'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'testgz'
op|')'
newline|'\n'
name|'sleep'
op|'('
number|'0.1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_part_nodes'
op|'('
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'devs'
op|')'
op|','
number|'7'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'_mtime'
op|','
name|'orig_mtime'
op|')'
newline|'\n'
nl|'\n'
name|'os'
op|'.'
name|'utime'
op|'('
name|'self'
op|'.'
name|'testgz'
op|','
op|'('
name|'time'
op|'('
op|')'
op|'-'
number|'300'
op|','
name|'time'
op|'('
op|')'
op|'-'
number|'300'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'ring'
op|'='
name|'ring'
op|'.'
name|'Ring'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'reload_time'
op|'='
number|'0.001'
op|','
nl|'\n'
name|'ring_name'
op|'='
string|"'whatever'"
op|')'
newline|'\n'
name|'orig_mtime'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'_mtime'
newline|'\n'
name|'part'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'devs'
op|')'
op|','
number|'7'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'.'
name|'append'
op|'('
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'5'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.6.6.6'"
op|','
string|"'port'"
op|':'
number|'6200'
op|'}'
op|')'
newline|'\n'
name|'ring'
op|'.'
name|'RingData'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'intended_replica2part2dev_id'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|','
name|'self'
op|'.'
name|'intended_part_shift'
op|')'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'testgz'
op|')'
newline|'\n'
name|'sleep'
op|'('
number|'0.1'
op|')'
newline|'\n'
name|'next'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_more_nodes'
op|'('
name|'part'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'devs'
op|')'
op|','
number|'8'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'_mtime'
op|','
name|'orig_mtime'
op|')'
newline|'\n'
nl|'\n'
name|'os'
op|'.'
name|'utime'
op|'('
name|'self'
op|'.'
name|'testgz'
op|','
op|'('
name|'time'
op|'('
op|')'
op|'-'
number|'300'
op|','
name|'time'
op|'('
op|')'
op|'-'
number|'300'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'ring'
op|'='
name|'ring'
op|'.'
name|'Ring'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'reload_time'
op|'='
number|'0.001'
op|','
nl|'\n'
name|'ring_name'
op|'='
string|"'whatever'"
op|')'
newline|'\n'
name|'orig_mtime'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'_mtime'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'devs'
op|')'
op|','
number|'8'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'.'
name|'append'
op|'('
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'4'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.5.5.5'"
op|','
string|"'port'"
op|':'
number|'6200'
op|'}'
op|')'
newline|'\n'
name|'ring'
op|'.'
name|'RingData'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'intended_replica2part2dev_id'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|','
name|'self'
op|'.'
name|'intended_part_shift'
op|')'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'testgz'
op|')'
newline|'\n'
name|'sleep'
op|'('
number|'0.1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'devs'
op|')'
op|','
number|'9'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'_mtime'
op|','
name|'orig_mtime'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reload_without_replication
dedent|''
name|'def'
name|'test_reload_without_replication'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'replication_less_devs'
op|'='
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'1.0'
op|','
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6200'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'1.0'
op|','
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6200'
op|'}'
op|','
nl|'\n'
name|'None'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'1.0'
op|','
string|"'ip'"
op|':'
string|"'10.1.2.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6200'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'1.0'
op|','
string|"'ip'"
op|':'
string|"'10.1.2.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6200'
op|'}'
op|']'
newline|'\n'
name|'intended_devs'
op|'='
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
string|"'port'"
op|':'
number|'6200'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'10.1.1.1'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'6200'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
string|"'port'"
op|':'
number|'6200'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'10.1.1.1'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'6200'
op|'}'
op|','
nl|'\n'
name|'None'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.2.1'"
op|','
string|"'port'"
op|':'
number|'6200'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'10.1.2.1'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'6200'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.2.2'"
op|','
string|"'port'"
op|':'
number|'6200'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'10.1.2.2'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'6200'
op|'}'
op|']'
newline|'\n'
name|'testgz'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
string|"'without_replication.ring.gz'"
op|')'
newline|'\n'
name|'ring'
op|'.'
name|'RingData'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'intended_replica2part2dev_id'
op|','
nl|'\n'
name|'replication_less_devs'
op|','
name|'self'
op|'.'
name|'intended_part_shift'
op|')'
op|'.'
name|'save'
op|'('
name|'testgz'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'ring'
op|'='
name|'ring'
op|'.'
name|'Ring'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'testdir'
op|','
nl|'\n'
name|'reload_time'
op|'='
name|'self'
op|'.'
name|'intended_reload_time'
op|','
nl|'\n'
name|'ring_name'
op|'='
string|"'without_replication'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'devs'
op|','
name|'intended_devs'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reload_old_style_pickled_ring
dedent|''
name|'def'
name|'test_reload_old_style_pickled_ring'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'devs'
op|'='
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'1.0'
op|','
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6200'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'1.0'
op|','
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6200'
op|'}'
op|','
nl|'\n'
name|'None'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'1.0'
op|','
string|"'ip'"
op|':'
string|"'10.1.2.1'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6200'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'1.0'
op|','
string|"'ip'"
op|':'
string|"'10.1.2.2'"
op|','
nl|'\n'
string|"'port'"
op|':'
number|'6200'
op|'}'
op|']'
newline|'\n'
name|'intended_devs'
op|'='
op|'['
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
string|"'port'"
op|':'
number|'6200'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'10.1.1.1'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'6200'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.1.1'"
op|','
string|"'port'"
op|':'
number|'6200'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'10.1.1.1'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'6200'
op|'}'
op|','
nl|'\n'
name|'None'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.2.1'"
op|','
string|"'port'"
op|':'
number|'6200'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'10.1.2.1'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'6200'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'region'"
op|':'
number|'1'
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'10.1.2.2'"
op|','
string|"'port'"
op|':'
number|'6200'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
string|"'10.1.2.2'"
op|','
nl|'\n'
string|"'replication_port'"
op|':'
number|'6200'
op|'}'
op|']'
newline|'\n'
nl|'\n'
comment|'# simulate an old-style pickled ring'
nl|'\n'
name|'testgz'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
nl|'\n'
string|"'without_replication_or_region.ring.gz'"
op|')'
newline|'\n'
name|'ring_data'
op|'='
name|'ring'
op|'.'
name|'RingData'
op|'('
name|'self'
op|'.'
name|'intended_replica2part2dev_id'
op|','
nl|'\n'
name|'devs'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_part_shift'
op|')'
newline|'\n'
comment|"# an old-style pickled ring won't have region data"
nl|'\n'
name|'for'
name|'dev'
name|'in'
name|'ring_data'
op|'.'
name|'devs'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'dev'
op|':'
newline|'\n'
indent|'                '
name|'del'
name|'dev'
op|'['
string|'"region"'
op|']'
newline|'\n'
dedent|''
dedent|''
name|'gz_file'
op|'='
name|'GzipFile'
op|'('
name|'testgz'
op|','
string|"'wb'"
op|')'
newline|'\n'
name|'pickle'
op|'.'
name|'dump'
op|'('
name|'ring_data'
op|','
name|'gz_file'
op|','
name|'protocol'
op|'='
number|'2'
op|')'
newline|'\n'
name|'gz_file'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'ring'
op|'='
name|'ring'
op|'.'
name|'Ring'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'testdir'
op|','
nl|'\n'
name|'reload_time'
op|'='
name|'self'
op|'.'
name|'intended_reload_time'
op|','
nl|'\n'
name|'ring_name'
op|'='
string|"'without_replication_or_region'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'ring'
op|'.'
name|'devs'
op|','
name|'intended_devs'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_part
dedent|''
name|'def'
name|'test_get_part'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'part1'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_part'
op|'('
string|"'a'"
op|')'
newline|'\n'
name|'nodes1'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_part_nodes'
op|'('
name|'part1'
op|')'
newline|'\n'
name|'part2'
op|','
name|'nodes2'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part1'
op|','
name|'part2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'nodes1'
op|','
name|'nodes2'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_part_nodes
dedent|''
name|'def'
name|'test_get_part_nodes'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'part'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'nodes'
op|','
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_part_nodes'
op|'('
name|'part'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_nodes
dedent|''
name|'def'
name|'test_get_nodes'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Yes, these tests are deliberately very fragile. We want to make sure'
nl|'\n'
comment|'# that if someones changes the results the ring produces, they know it.'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'TypeError'
op|','
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|')'
newline|'\n'
name|'part'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'nodes'
op|','
op|'['
name|'dict'
op|'('
name|'node'
op|','
name|'index'
op|'='
name|'i'
op|')'
name|'for'
name|'i'
op|','
name|'node'
name|'in'
nl|'\n'
name|'enumerate'
op|'('
op|'['
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'3'
op|']'
op|']'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'part'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|'('
string|"'a1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'nodes'
op|','
op|'['
name|'dict'
op|'('
name|'node'
op|','
name|'index'
op|'='
name|'i'
op|')'
name|'for'
name|'i'
op|','
name|'node'
name|'in'
nl|'\n'
name|'enumerate'
op|'('
op|'['
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'3'
op|']'
op|']'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'part'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|'('
string|"'a4'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'nodes'
op|','
op|'['
name|'dict'
op|'('
name|'node'
op|','
name|'index'
op|'='
name|'i'
op|')'
name|'for'
name|'i'
op|','
name|'node'
name|'in'
nl|'\n'
name|'enumerate'
op|'('
op|'['
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'1'
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'4'
op|']'
op|']'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'part'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|'('
string|"'aa'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'nodes'
op|','
op|'['
name|'dict'
op|'('
name|'node'
op|','
name|'index'
op|'='
name|'i'
op|')'
name|'for'
name|'i'
op|','
name|'node'
name|'in'
nl|'\n'
name|'enumerate'
op|'('
op|'['
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'1'
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'4'
op|']'
op|']'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'part'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|','
string|"'c1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'nodes'
op|','
op|'['
name|'dict'
op|'('
name|'node'
op|','
name|'index'
op|'='
name|'i'
op|')'
name|'for'
name|'i'
op|','
name|'node'
name|'in'
nl|'\n'
name|'enumerate'
op|'('
op|'['
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'3'
op|']'
op|']'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'part'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|','
string|"'c0'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part'
op|','
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'nodes'
op|','
op|'['
name|'dict'
op|'('
name|'node'
op|','
name|'index'
op|'='
name|'i'
op|')'
name|'for'
name|'i'
op|','
name|'node'
name|'in'
nl|'\n'
name|'enumerate'
op|'('
op|'['
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'1'
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'4'
op|']'
op|']'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'part'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|','
string|"'c3'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'nodes'
op|','
op|'['
name|'dict'
op|'('
name|'node'
op|','
name|'index'
op|'='
name|'i'
op|')'
name|'for'
name|'i'
op|','
name|'node'
name|'in'
nl|'\n'
name|'enumerate'
op|'('
op|'['
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'3'
op|']'
op|']'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'part'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|','
string|"'c2'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'nodes'
op|','
op|'['
name|'dict'
op|'('
name|'node'
op|','
name|'index'
op|'='
name|'i'
op|')'
name|'for'
name|'i'
op|','
name|'node'
name|'in'
nl|'\n'
name|'enumerate'
op|'('
op|'['
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'3'
op|']'
op|']'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'part'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'nodes'
op|','
op|'['
name|'dict'
op|'('
name|'node'
op|','
name|'index'
op|'='
name|'i'
op|')'
name|'for'
name|'i'
op|','
name|'node'
name|'in'
nl|'\n'
name|'enumerate'
op|'('
op|'['
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'1'
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'4'
op|']'
op|']'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'part'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o5'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'nodes'
op|','
op|'['
name|'dict'
op|'('
name|'node'
op|','
name|'index'
op|'='
name|'i'
op|')'
name|'for'
name|'i'
op|','
name|'node'
name|'in'
nl|'\n'
name|'enumerate'
op|'('
op|'['
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'3'
op|']'
op|']'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'part'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o0'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'nodes'
op|','
op|'['
name|'dict'
op|'('
name|'node'
op|','
name|'index'
op|'='
name|'i'
op|')'
name|'for'
name|'i'
op|','
name|'node'
name|'in'
nl|'\n'
name|'enumerate'
op|'('
op|'['
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'3'
op|']'
op|']'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'part'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'ring'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o2'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'nodes'
op|','
op|'['
name|'dict'
op|'('
name|'node'
op|','
name|'index'
op|'='
name|'i'
op|')'
name|'for'
name|'i'
op|','
name|'node'
name|'in'
nl|'\n'
name|'enumerate'
op|'('
op|'['
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'intended_devs'
op|'['
number|'3'
op|']'
op|']'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|add_dev_to_ring
dedent|''
name|'def'
name|'add_dev_to_ring'
op|'('
name|'self'
op|','
name|'new_dev'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'ring'
op|'.'
name|'devs'
op|'.'
name|'append'
op|'('
name|'new_dev'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'ring'
op|'.'
name|'_rebuild_tier_data'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_more_nodes
dedent|''
name|'def'
name|'test_get_more_nodes'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Yes, these tests are deliberately very fragile. We want to make sure'
nl|'\n'
comment|'# that if someone changes the results the ring produces, they know it.'
nl|'\n'
indent|'        '
name|'exp_part'
op|'='
number|'6'
newline|'\n'
name|'exp_devs'
op|'='
op|'['
number|'71'
op|','
number|'77'
op|','
number|'30'
op|']'
newline|'\n'
name|'exp_zones'
op|'='
name|'set'
op|'('
op|'['
number|'6'
op|','
number|'3'
op|','
number|'7'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'exp_handoffs'
op|'='
op|'['
number|'99'
op|','
number|'43'
op|','
number|'94'
op|','
number|'13'
op|','
number|'1'
op|','
number|'49'
op|','
number|'60'
op|','
number|'72'
op|','
number|'27'
op|','
number|'68'
op|','
number|'78'
op|','
number|'26'
op|','
number|'21'
op|','
number|'9'
op|','
nl|'\n'
number|'51'
op|','
number|'105'
op|','
number|'47'
op|','
number|'89'
op|','
number|'65'
op|','
number|'82'
op|','
number|'34'
op|','
number|'98'
op|','
number|'38'
op|','
number|'85'
op|','
number|'16'
op|','
number|'4'
op|','
number|'59'
op|','
nl|'\n'
number|'102'
op|','
number|'40'
op|','
number|'90'
op|','
number|'20'
op|','
number|'8'
op|','
number|'54'
op|','
number|'66'
op|','
number|'80'
op|','
number|'25'
op|','
number|'14'
op|','
number|'2'
op|','
number|'50'
op|','
number|'12'
op|','
number|'0'
op|','
nl|'\n'
number|'48'
op|','
number|'70'
op|','
number|'76'
op|','
number|'32'
op|','
number|'107'
op|','
number|'45'
op|','
number|'87'
op|','
number|'101'
op|','
number|'44'
op|','
number|'93'
op|','
number|'100'
op|','
number|'42'
op|','
number|'95'
op|','
nl|'\n'
number|'106'
op|','
number|'46'
op|','
number|'88'
op|','
number|'97'
op|','
number|'37'
op|','
number|'86'
op|','
number|'96'
op|','
number|'36'
op|','
number|'84'
op|','
number|'17'
op|','
number|'5'
op|','
number|'57'
op|','
number|'63'
op|','
nl|'\n'
number|'81'
op|','
number|'33'
op|','
number|'67'
op|','
number|'79'
op|','
number|'24'
op|','
number|'15'
op|','
number|'3'
op|','
number|'58'
op|','
number|'69'
op|','
number|'75'
op|','
number|'31'
op|','
number|'61'
op|','
number|'74'
op|','
number|'29'
op|','
nl|'\n'
number|'23'
op|','
number|'10'
op|','
number|'52'
op|','
number|'22'
op|','
number|'11'
op|','
number|'53'
op|','
number|'64'
op|','
number|'83'
op|','
number|'35'
op|','
number|'62'
op|','
number|'73'
op|','
number|'28'
op|','
number|'18'
op|','
number|'6'
op|','
nl|'\n'
number|'56'
op|','
number|'104'
op|','
number|'39'
op|','
number|'91'
op|','
number|'103'
op|','
number|'41'
op|','
number|'92'
op|','
number|'19'
op|','
number|'7'
op|','
number|'55'
op|']'
newline|'\n'
nl|'\n'
name|'exp_first_handoffs'
op|'='
op|'['
number|'23'
op|','
number|'64'
op|','
number|'105'
op|','
number|'102'
op|','
number|'67'
op|','
number|'17'
op|','
number|'99'
op|','
number|'65'
op|','
number|'69'
op|','
number|'97'
op|','
number|'15'
op|','
nl|'\n'
number|'17'
op|','
number|'24'
op|','
number|'98'
op|','
number|'66'
op|','
number|'65'
op|','
number|'69'
op|','
number|'18'
op|','
number|'104'
op|','
number|'105'
op|','
number|'16'
op|','
number|'107'
op|','
nl|'\n'
number|'100'
op|','
number|'15'
op|','
number|'14'
op|','
number|'19'
op|','
number|'102'
op|','
number|'105'
op|','
number|'63'
op|','
number|'104'
op|','
number|'99'
op|','
number|'12'
op|','
number|'107'
op|','
nl|'\n'
number|'99'
op|','
number|'16'
op|','
number|'105'
op|','
number|'71'
op|','
number|'15'
op|','
number|'15'
op|','
number|'63'
op|','
number|'63'
op|','
number|'99'
op|','
number|'21'
op|','
number|'68'
op|','
number|'20'
op|','
nl|'\n'
number|'64'
op|','
number|'96'
op|','
number|'21'
op|','
number|'98'
op|','
number|'19'
op|','
number|'68'
op|','
number|'99'
op|','
number|'15'
op|','
number|'69'
op|','
number|'62'
op|','
number|'100'
op|','
number|'96'
op|','
nl|'\n'
number|'102'
op|','
number|'17'
op|','
number|'62'
op|','
number|'13'
op|','
number|'61'
op|','
number|'102'
op|','
number|'105'
op|','
number|'22'
op|','
number|'16'
op|','
number|'21'
op|','
number|'18'
op|','
nl|'\n'
number|'21'
op|','
number|'100'
op|','
number|'20'
op|','
number|'16'
op|','
number|'21'
op|','
number|'106'
op|','
number|'66'
op|','
number|'106'
op|','
number|'16'
op|','
number|'99'
op|','
number|'16'
op|','
nl|'\n'
number|'22'
op|','
number|'62'
op|','
number|'60'
op|','
number|'99'
op|','
number|'69'
op|','
number|'18'
op|','
number|'23'
op|','
number|'104'
op|','
number|'98'
op|','
number|'106'
op|','
number|'61'
op|','
nl|'\n'
number|'21'
op|','
number|'23'
op|','
number|'23'
op|','
number|'16'
op|','
number|'67'
op|','
number|'71'
op|','
number|'101'
op|','
number|'16'
op|','
number|'64'
op|','
number|'66'
op|','
number|'70'
op|','
number|'15'
op|','
nl|'\n'
number|'102'
op|','
number|'63'
op|','
number|'19'
op|','
number|'98'
op|','
number|'18'
op|','
number|'106'
op|','
number|'101'
op|','
number|'100'
op|','
number|'62'
op|','
number|'63'
op|','
number|'98'
op|','
nl|'\n'
number|'18'
op|','
number|'13'
op|','
number|'97'
op|','
number|'23'
op|','
number|'22'
op|','
number|'100'
op|','
number|'13'
op|','
number|'14'
op|','
number|'67'
op|','
number|'96'
op|','
number|'14'
op|','
nl|'\n'
number|'105'
op|','
number|'97'
op|','
number|'71'
op|','
number|'64'
op|','
number|'96'
op|','
number|'22'
op|','
number|'65'
op|','
number|'66'
op|','
number|'98'
op|','
number|'19'
op|','
number|'105'
op|','
nl|'\n'
number|'98'
op|','
number|'97'
op|','
number|'21'
op|','
number|'15'
op|','
number|'69'
op|','
number|'100'
op|','
number|'98'
op|','
number|'106'
op|','
number|'65'
op|','
number|'66'
op|','
number|'97'
op|','
nl|'\n'
number|'62'
op|','
number|'22'
op|','
number|'68'
op|','
number|'63'
op|','
number|'61'
op|','
number|'67'
op|','
number|'67'
op|','
number|'20'
op|','
number|'105'
op|','
number|'106'
op|','
number|'105'
op|','
nl|'\n'
number|'18'
op|','
number|'71'
op|','
number|'100'
op|','
number|'17'
op|','
number|'62'
op|','
number|'60'
op|','
number|'13'
op|','
number|'103'
op|','
number|'99'
op|','
number|'101'
op|','
number|'96'
op|','
nl|'\n'
number|'97'
op|','
number|'16'
op|','
number|'60'
op|','
number|'21'
op|','
number|'14'
op|','
number|'20'
op|','
number|'12'
op|','
number|'60'
op|','
number|'69'
op|','
number|'104'
op|','
number|'65'
op|','
number|'65'
op|','
nl|'\n'
number|'17'
op|','
number|'16'
op|','
number|'67'
op|','
number|'13'
op|','
number|'64'
op|','
number|'15'
op|','
number|'16'
op|','
number|'68'
op|','
number|'96'
op|','
number|'21'
op|','
number|'104'
op|','
number|'66'
op|','
nl|'\n'
number|'96'
op|','
number|'105'
op|','
number|'58'
op|','
number|'105'
op|','
number|'103'
op|','
number|'21'
op|','
number|'96'
op|','
number|'60'
op|','
number|'16'
op|','
number|'96'
op|','
number|'21'
op|','
nl|'\n'
number|'71'
op|','
number|'16'
op|','
number|'99'
op|','
number|'101'
op|','
number|'63'
op|','
number|'62'
op|','
number|'103'
op|','
number|'18'
op|','
number|'102'
op|','
number|'60'
op|','
number|'17'
op|','
nl|'\n'
number|'19'
op|','
number|'106'
op|','
number|'97'
op|','
number|'14'
op|','
number|'99'
op|','
number|'68'
op|','
number|'102'
op|','
number|'13'
op|','
number|'70'
op|','
number|'103'
op|','
number|'21'
op|','
nl|'\n'
number|'22'
op|','
number|'19'
op|','
number|'61'
op|','
number|'103'
op|','
number|'23'
op|','
number|'104'
op|','
number|'65'
op|','
number|'62'
op|','
number|'68'
op|','
number|'16'
op|','
number|'65'
op|','
nl|'\n'
number|'15'
op|','
number|'102'
op|','
number|'102'
op|','
number|'71'
op|','
number|'99'
op|','
number|'63'
op|','
number|'67'
op|','
number|'19'
op|','
number|'23'
op|','
number|'15'
op|','
number|'69'
op|','
nl|'\n'
number|'107'
op|','
number|'14'
op|','
number|'13'
op|','
number|'64'
op|','
number|'13'
op|','
number|'105'
op|','
number|'15'
op|','
number|'98'
op|','
number|'69'
op|']'
newline|'\n'
nl|'\n'
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'next_dev_id'
op|'='
number|'0'
newline|'\n'
name|'for'
name|'zone'
name|'in'
name|'range'
op|'('
number|'1'
op|','
number|'10'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'server'
name|'in'
name|'range'
op|'('
number|'1'
op|','
number|'5'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'for'
name|'device'
name|'in'
name|'range'
op|'('
number|'1'
op|','
number|'4'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
name|'next_dev_id'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'1.2.%d.%d'"
op|'%'
op|'('
name|'zone'
op|','
name|'server'
op|')'
op|','
nl|'\n'
string|"'port'"
op|':'
number|'1234'
op|'+'
name|'device'
op|','
nl|'\n'
string|"'zone'"
op|':'
name|'zone'
op|','
string|"'region'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'weight'"
op|':'
number|'1.0'
op|'}'
op|')'
newline|'\n'
name|'next_dev_id'
op|'+='
number|'1'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'testgz'
op|')'
newline|'\n'
name|'r'
op|'='
name|'ring'
op|'.'
name|'Ring'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'ring_name'
op|'='
string|"'whatever'"
op|')'
newline|'\n'
nl|'\n'
comment|'# every part has the same number of handoffs'
nl|'\n'
name|'part_handoff_counts'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'r'
op|'.'
name|'partition_count'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'part_handoff_counts'
op|'.'
name|'add'
op|'('
name|'len'
op|'('
name|'list'
op|'('
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'part'
op|')'
op|')'
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_handoff_counts'
op|','
op|'{'
number|'105'
op|'}'
op|')'
newline|'\n'
comment|'# which less the primaries - is every device in the ring'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'list'
op|'('
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|')'
op|')'
op|'-'
name|'rb'
op|'.'
name|'replicas'
op|','
number|'105'
op|')'
newline|'\n'
nl|'\n'
name|'part'
op|','
name|'devs'
op|'='
name|'r'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|')'
newline|'\n'
name|'primary_zones'
op|'='
name|'set'
op|'('
op|'['
name|'d'
op|'['
string|"'zone'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part'
op|','
name|'exp_part'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'d'
op|'['
string|"'id'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|']'
op|','
name|'exp_devs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'primary_zones'
op|','
name|'exp_zones'
op|')'
newline|'\n'
name|'devs'
op|'='
name|'list'
op|'('
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'part'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'devs'
op|')'
op|','
name|'len'
op|'('
name|'exp_handoffs'
op|')'
op|')'
newline|'\n'
name|'dev_ids'
op|'='
op|'['
name|'d'
op|'['
string|"'id'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dev_ids'
op|','
name|'exp_handoffs'
op|')'
newline|'\n'
nl|'\n'
comment|'# The first 6 replicas plus the 3 primary nodes should cover all 9'
nl|'\n'
comment|'# zones in this test'
nl|'\n'
name|'seen_zones'
op|'='
name|'set'
op|'('
name|'primary_zones'
op|')'
newline|'\n'
name|'seen_zones'
op|'.'
name|'update'
op|'('
op|'['
name|'d'
op|'['
string|"'zone'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|'['
op|':'
number|'6'
op|']'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'seen_zones'
op|','
name|'set'
op|'('
name|'range'
op|'('
number|'1'
op|','
number|'10'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# The first handoff nodes for each partition in the ring'
nl|'\n'
name|'devs'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'r'
op|'.'
name|'partition_count'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'devs'
op|'.'
name|'append'
op|'('
name|'next'
op|'('
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'part'
op|')'
op|')'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'devs'
op|','
name|'exp_first_handoffs'
op|')'
newline|'\n'
nl|'\n'
comment|'# Add a new device we can handoff to.'
nl|'\n'
name|'zone'
op|'='
number|'5'
newline|'\n'
name|'server'
op|'='
number|'0'
newline|'\n'
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
name|'next_dev_id'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'1.2.%d.%d'"
op|'%'
op|'('
name|'zone'
op|','
name|'server'
op|')'
op|','
nl|'\n'
string|"'port'"
op|':'
number|'1234'
op|','
string|"'zone'"
op|':'
name|'zone'
op|','
string|"'region'"
op|':'
number|'0'
op|','
string|"'weight'"
op|':'
number|'1.0'
op|'}'
op|')'
newline|'\n'
name|'next_dev_id'
op|'+='
number|'1'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'num_parts_changed'
op|','
name|'_balance'
op|','
name|'_removed_dev'
op|'='
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'2'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'testgz'
op|')'
newline|'\n'
name|'r'
op|'='
name|'ring'
op|'.'
name|'Ring'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'ring_name'
op|'='
string|"'whatever'"
op|')'
newline|'\n'
nl|'\n'
comment|'# so now we expect the device list to be longer by one device'
nl|'\n'
name|'part_handoff_counts'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'r'
op|'.'
name|'partition_count'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'part_handoff_counts'
op|'.'
name|'add'
op|'('
name|'len'
op|'('
name|'list'
op|'('
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'part'
op|')'
op|')'
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_handoff_counts'
op|','
op|'{'
number|'106'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'list'
op|'('
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|')'
op|')'
op|'-'
name|'rb'
op|'.'
name|'replicas'
op|','
number|'106'
op|')'
newline|'\n'
comment|"# I don't think there's any special reason this dev goes at this index"
nl|'\n'
name|'exp_handoffs'
op|'.'
name|'insert'
op|'('
number|'27'
op|','
name|'rb'
op|'.'
name|'devs'
op|'['
op|'-'
number|'1'
op|']'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# We would change expectations here, but in this part only the added'
nl|'\n'
comment|'# device changed at all.'
nl|'\n'
name|'part'
op|','
name|'devs'
op|'='
name|'r'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|')'
newline|'\n'
name|'primary_zones'
op|'='
name|'set'
op|'('
op|'['
name|'d'
op|'['
string|"'zone'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part'
op|','
name|'exp_part'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'d'
op|'['
string|"'id'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|']'
op|','
name|'exp_devs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'primary_zones'
op|','
name|'exp_zones'
op|')'
newline|'\n'
name|'devs'
op|'='
name|'list'
op|'('
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'part'
op|')'
op|')'
newline|'\n'
name|'dev_ids'
op|'='
op|'['
name|'d'
op|'['
string|"'id'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'dev_ids'
op|')'
op|','
name|'len'
op|'('
name|'exp_handoffs'
op|')'
op|')'
newline|'\n'
name|'for'
name|'index'
op|','
name|'dev'
name|'in'
name|'enumerate'
op|'('
name|'dev_ids'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'dev'
op|','
name|'exp_handoffs'
op|'['
name|'index'
op|']'
op|','
nl|'\n'
string|"'handoff differs at position %d\\n%s\\n%s'"
op|'%'
op|'('
nl|'\n'
name|'index'
op|','
name|'dev_ids'
op|'['
name|'index'
op|':'
op|']'
op|','
name|'exp_handoffs'
op|'['
name|'index'
op|':'
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# The handoffs still cover all the non-primary zones first'
nl|'\n'
dedent|''
name|'seen_zones'
op|'='
name|'set'
op|'('
name|'primary_zones'
op|')'
newline|'\n'
name|'seen_zones'
op|'.'
name|'update'
op|'('
op|'['
name|'d'
op|'['
string|"'zone'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|'['
op|':'
number|'6'
op|']'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'seen_zones'
op|','
name|'set'
op|'('
name|'range'
op|'('
number|'1'
op|','
number|'10'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# Change expectations for the rest of the parts'
nl|'\n'
name|'devs'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'r'
op|'.'
name|'partition_count'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'devs'
op|'.'
name|'append'
op|'('
name|'next'
op|'('
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'part'
op|')'
op|')'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'changed_first_handoff'
op|'='
number|'0'
newline|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'r'
op|'.'
name|'partition_count'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'devs'
op|'['
name|'part'
op|']'
op|'!='
name|'exp_first_handoffs'
op|'['
name|'part'
op|']'
op|':'
newline|'\n'
indent|'                '
name|'changed_first_handoff'
op|'+='
number|'1'
newline|'\n'
name|'exp_first_handoffs'
op|'['
name|'part'
op|']'
op|'='
name|'devs'
op|'['
name|'part'
op|']'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'devs'
op|','
name|'exp_first_handoffs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'changed_first_handoff'
op|','
name|'num_parts_changed'
op|')'
newline|'\n'
nl|'\n'
comment|'# Remove a device - no need to fluff min_part_hours.'
nl|'\n'
name|'rb'
op|'.'
name|'remove_dev'
op|'('
number|'0'
op|')'
newline|'\n'
name|'num_parts_changed'
op|','
name|'_balance'
op|','
name|'_removed_dev'
op|'='
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'testgz'
op|')'
newline|'\n'
name|'r'
op|'='
name|'ring'
op|'.'
name|'Ring'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'ring_name'
op|'='
string|"'whatever'"
op|')'
newline|'\n'
nl|'\n'
comment|'# so now we expect the device list to be shorter by one device'
nl|'\n'
name|'part_handoff_counts'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'r'
op|'.'
name|'partition_count'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'part_handoff_counts'
op|'.'
name|'add'
op|'('
name|'len'
op|'('
name|'list'
op|'('
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'part'
op|')'
op|')'
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part_handoff_counts'
op|','
op|'{'
number|'105'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'list'
op|'('
name|'rb'
op|'.'
name|'_iter_devs'
op|'('
op|')'
op|')'
op|')'
op|'-'
name|'rb'
op|'.'
name|'replicas'
op|','
number|'105'
op|')'
newline|'\n'
nl|'\n'
comment|'# Change expectations for our part'
nl|'\n'
name|'exp_handoffs'
op|'.'
name|'remove'
op|'('
number|'0'
op|')'
newline|'\n'
name|'first_matches'
op|'='
number|'0'
newline|'\n'
name|'total_changed'
op|'='
number|'0'
newline|'\n'
name|'devs'
op|'='
name|'list'
op|'('
name|'d'
op|'['
string|"'id'"
op|']'
name|'for'
name|'d'
name|'in'
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'exp_part'
op|')'
op|')'
newline|'\n'
name|'for'
name|'i'
op|','
name|'part'
name|'in'
name|'enumerate'
op|'('
name|'devs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'exp_handoffs'
op|'['
name|'i'
op|']'
op|'!='
name|'devs'
op|'['
name|'i'
op|']'
op|':'
newline|'\n'
indent|'                '
name|'total_changed'
op|'+='
number|'1'
newline|'\n'
name|'exp_handoffs'
op|'['
name|'i'
op|']'
op|'='
name|'devs'
op|'['
name|'i'
op|']'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'total_changed'
op|':'
newline|'\n'
indent|'                '
name|'first_matches'
op|'+='
number|'1'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'devs'
op|','
name|'exp_handoffs'
op|')'
newline|'\n'
comment|'# the first 21 handoffs were the same across the rebalance'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'first_matches'
op|','
number|'21'
op|')'
newline|'\n'
comment|'# but as you dig deeper some of the differences show up'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'total_changed'
op|','
number|'41'
op|')'
newline|'\n'
nl|'\n'
comment|'# Change expectations for the rest of the parts'
nl|'\n'
name|'devs'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'r'
op|'.'
name|'partition_count'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'devs'
op|'.'
name|'append'
op|'('
name|'next'
op|'('
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'part'
op|')'
op|')'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'changed_first_handoff'
op|'='
number|'0'
newline|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'r'
op|'.'
name|'partition_count'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'devs'
op|'['
name|'part'
op|']'
op|'!='
name|'exp_first_handoffs'
op|'['
name|'part'
op|']'
op|':'
newline|'\n'
indent|'                '
name|'changed_first_handoff'
op|'+='
number|'1'
newline|'\n'
name|'exp_first_handoffs'
op|'['
name|'part'
op|']'
op|'='
name|'devs'
op|'['
name|'part'
op|']'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'devs'
op|','
name|'exp_first_handoffs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'changed_first_handoff'
op|','
name|'num_parts_changed'
op|')'
newline|'\n'
nl|'\n'
comment|'# Test'
nl|'\n'
name|'part'
op|','
name|'devs'
op|'='
name|'r'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|')'
newline|'\n'
name|'primary_zones'
op|'='
name|'set'
op|'('
op|'['
name|'d'
op|'['
string|"'zone'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part'
op|','
name|'exp_part'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'d'
op|'['
string|"'id'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|']'
op|','
name|'exp_devs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'primary_zones'
op|','
name|'exp_zones'
op|')'
newline|'\n'
name|'devs'
op|'='
name|'list'
op|'('
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'part'
op|')'
op|')'
newline|'\n'
name|'dev_ids'
op|'='
op|'['
name|'d'
op|'['
string|"'id'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'dev_ids'
op|')'
op|','
name|'len'
op|'('
name|'exp_handoffs'
op|')'
op|')'
newline|'\n'
name|'for'
name|'index'
op|','
name|'dev'
name|'in'
name|'enumerate'
op|'('
name|'dev_ids'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'dev'
op|','
name|'exp_handoffs'
op|'['
name|'index'
op|']'
op|','
nl|'\n'
string|"'handoff differs at position %d\\n%s\\n%s'"
op|'%'
op|'('
nl|'\n'
name|'index'
op|','
name|'dev_ids'
op|'['
name|'index'
op|':'
op|']'
op|','
name|'exp_handoffs'
op|'['
name|'index'
op|':'
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'seen_zones'
op|'='
name|'set'
op|'('
name|'primary_zones'
op|')'
newline|'\n'
name|'seen_zones'
op|'.'
name|'update'
op|'('
op|'['
name|'d'
op|'['
string|"'zone'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|'['
op|':'
number|'6'
op|']'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'seen_zones'
op|','
name|'set'
op|'('
name|'range'
op|'('
number|'1'
op|','
number|'10'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'devs'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'r'
op|'.'
name|'partition_count'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'devs'
op|'.'
name|'append'
op|'('
name|'next'
op|'('
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'part'
op|')'
op|')'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'r'
op|'.'
name|'partition_count'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'devs'
op|'['
name|'part'
op|']'
op|','
name|'exp_first_handoffs'
op|'['
name|'part'
op|']'
op|','
nl|'\n'
string|"'handoff for partitition %d is now device id %d'"
op|'%'
op|'('
nl|'\n'
name|'part'
op|','
name|'devs'
op|'['
name|'part'
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# Add a partial replica'
nl|'\n'
dedent|''
name|'rb'
op|'.'
name|'set_replicas'
op|'('
number|'3.5'
op|')'
newline|'\n'
name|'num_parts_changed'
op|','
name|'_balance'
op|','
name|'_removed_dev'
op|'='
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'164'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'testgz'
op|')'
newline|'\n'
name|'r'
op|'='
name|'ring'
op|'.'
name|'Ring'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'ring_name'
op|'='
string|"'whatever'"
op|')'
newline|'\n'
nl|'\n'
comment|'# Change expectations'
nl|'\n'
nl|'\n'
comment|'# We have another replica now'
nl|'\n'
name|'exp_devs'
op|'.'
name|'append'
op|'('
number|'90'
op|')'
newline|'\n'
name|'exp_zones'
op|'.'
name|'add'
op|'('
number|'8'
op|')'
newline|'\n'
comment|'# and therefore one less handoff'
nl|'\n'
name|'exp_handoffs'
op|'='
name|'exp_handoffs'
op|'['
op|':'
op|'-'
number|'1'
op|']'
newline|'\n'
comment|'# Caused some major changes in the sequence of handoffs for our test'
nl|'\n'
comment|'# partition, but at least the first stayed the same.'
nl|'\n'
name|'devs'
op|'='
name|'list'
op|'('
name|'d'
op|'['
string|"'id'"
op|']'
name|'for'
name|'d'
name|'in'
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'exp_part'
op|')'
op|')'
newline|'\n'
name|'first_matches'
op|'='
number|'0'
newline|'\n'
name|'total_changed'
op|'='
number|'0'
newline|'\n'
name|'for'
name|'i'
op|','
name|'part'
name|'in'
name|'enumerate'
op|'('
name|'devs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'exp_handoffs'
op|'['
name|'i'
op|']'
op|'!='
name|'devs'
op|'['
name|'i'
op|']'
op|':'
newline|'\n'
indent|'                '
name|'total_changed'
op|'+='
number|'1'
newline|'\n'
name|'exp_handoffs'
op|'['
name|'i'
op|']'
op|'='
name|'devs'
op|'['
name|'i'
op|']'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'total_changed'
op|':'
newline|'\n'
indent|'                '
name|'first_matches'
op|'+='
number|'1'
newline|'\n'
comment|'# most seeds seem to throw out first handoff stabilization with'
nl|'\n'
comment|'# replica_count change'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'first_matches'
op|','
number|'2'
op|')'
newline|'\n'
comment|'# and lots of other handoff changes...'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'total_changed'
op|','
number|'95'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'devs'
op|','
name|'exp_handoffs'
op|')'
newline|'\n'
nl|'\n'
comment|'# Change expectations for the rest of the parts'
nl|'\n'
name|'devs'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'r'
op|'.'
name|'partition_count'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'devs'
op|'.'
name|'append'
op|'('
name|'next'
op|'('
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'part'
op|')'
op|')'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'changed_first_handoff'
op|'='
number|'0'
newline|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'r'
op|'.'
name|'partition_count'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'devs'
op|'['
name|'part'
op|']'
op|'!='
name|'exp_first_handoffs'
op|'['
name|'part'
op|']'
op|':'
newline|'\n'
indent|'                '
name|'changed_first_handoff'
op|'+='
number|'1'
newline|'\n'
name|'exp_first_handoffs'
op|'['
name|'part'
op|']'
op|'='
name|'devs'
op|'['
name|'part'
op|']'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'devs'
op|','
name|'exp_first_handoffs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertLessEqual'
op|'('
name|'changed_first_handoff'
op|','
name|'num_parts_changed'
op|')'
newline|'\n'
nl|'\n'
comment|'# Test'
nl|'\n'
name|'part'
op|','
name|'devs'
op|'='
name|'r'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|')'
newline|'\n'
name|'primary_zones'
op|'='
name|'set'
op|'('
op|'['
name|'d'
op|'['
string|"'zone'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part'
op|','
name|'exp_part'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'d'
op|'['
string|"'id'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|']'
op|','
name|'exp_devs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'primary_zones'
op|','
name|'exp_zones'
op|')'
newline|'\n'
name|'devs'
op|'='
name|'list'
op|'('
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'part'
op|')'
op|')'
newline|'\n'
name|'dev_ids'
op|'='
op|'['
name|'d'
op|'['
string|"'id'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'dev_ids'
op|')'
op|','
name|'len'
op|'('
name|'exp_handoffs'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'index'
op|','
name|'dev'
name|'in'
name|'enumerate'
op|'('
name|'dev_ids'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'dev'
op|','
name|'exp_handoffs'
op|'['
name|'index'
op|']'
op|','
nl|'\n'
string|"'handoff differs at position %d\\n%s\\n%s'"
op|'%'
op|'('
nl|'\n'
name|'index'
op|','
name|'dev_ids'
op|'['
name|'index'
op|':'
op|']'
op|','
name|'exp_handoffs'
op|'['
name|'index'
op|':'
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'seen_zones'
op|'='
name|'set'
op|'('
name|'primary_zones'
op|')'
newline|'\n'
name|'seen_zones'
op|'.'
name|'update'
op|'('
op|'['
name|'d'
op|'['
string|"'zone'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|'['
op|':'
number|'6'
op|']'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'seen_zones'
op|','
name|'set'
op|'('
name|'range'
op|'('
number|'1'
op|','
number|'10'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'devs'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'r'
op|'.'
name|'partition_count'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'devs'
op|'.'
name|'append'
op|'('
name|'next'
op|'('
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'part'
op|')'
op|')'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'for'
name|'part'
name|'in'
name|'range'
op|'('
name|'r'
op|'.'
name|'partition_count'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'devs'
op|'['
name|'part'
op|']'
op|','
name|'exp_first_handoffs'
op|'['
name|'part'
op|']'
op|','
nl|'\n'
string|"'handoff for partitition %d is now device id %d'"
op|'%'
op|'('
nl|'\n'
name|'part'
op|','
name|'devs'
op|'['
name|'part'
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# One last test of a partial replica partition'
nl|'\n'
dedent|''
name|'exp_part2'
op|'='
number|'136'
newline|'\n'
name|'exp_devs2'
op|'='
op|'['
number|'70'
op|','
number|'76'
op|','
number|'32'
op|']'
newline|'\n'
name|'exp_zones2'
op|'='
name|'set'
op|'('
op|'['
number|'3'
op|','
number|'6'
op|','
number|'7'
op|']'
op|')'
newline|'\n'
name|'exp_handoffs2'
op|'='
op|'['
number|'89'
op|','
number|'97'
op|','
number|'37'
op|','
number|'53'
op|','
number|'20'
op|','
number|'1'
op|','
number|'86'
op|','
number|'64'
op|','
number|'102'
op|','
number|'40'
op|','
number|'90'
op|','
number|'60'
op|','
number|'72'
op|','
nl|'\n'
number|'27'
op|','
number|'99'
op|','
number|'68'
op|','
number|'78'
op|','
number|'26'
op|','
number|'105'
op|','
number|'45'
op|','
number|'42'
op|','
number|'95'
op|','
number|'22'
op|','
number|'13'
op|','
number|'49'
op|','
number|'55'
op|','
nl|'\n'
number|'11'
op|','
number|'8'
op|','
number|'83'
op|','
number|'16'
op|','
number|'4'
op|','
number|'59'
op|','
number|'33'
op|','
number|'108'
op|','
number|'61'
op|','
number|'74'
op|','
number|'29'
op|','
number|'88'
op|','
number|'66'
op|','
nl|'\n'
number|'80'
op|','
number|'25'
op|','
number|'100'
op|','
number|'39'
op|','
number|'67'
op|','
number|'79'
op|','
number|'24'
op|','
number|'65'
op|','
number|'96'
op|','
number|'36'
op|','
number|'84'
op|','
number|'54'
op|','
number|'21'
op|','
nl|'\n'
number|'63'
op|','
number|'81'
op|','
number|'56'
op|','
number|'71'
op|','
number|'77'
op|','
number|'30'
op|','
number|'48'
op|','
number|'23'
op|','
number|'10'
op|','
number|'52'
op|','
number|'82'
op|','
number|'34'
op|','
number|'17'
op|','
nl|'\n'
number|'107'
op|','
number|'87'
op|','
number|'104'
op|','
number|'5'
op|','
number|'35'
op|','
number|'2'
op|','
number|'50'
op|','
number|'43'
op|','
number|'62'
op|','
number|'73'
op|','
number|'28'
op|','
number|'18'
op|','
number|'14'
op|','
nl|'\n'
number|'98'
op|','
number|'38'
op|','
number|'85'
op|','
number|'15'
op|','
number|'57'
op|','
number|'9'
op|','
number|'51'
op|','
number|'12'
op|','
number|'6'
op|','
number|'91'
op|','
number|'3'
op|','
number|'103'
op|','
number|'41'
op|','
number|'92'
op|','
nl|'\n'
number|'47'
op|','
number|'75'
op|','
number|'44'
op|','
number|'69'
op|','
number|'101'
op|','
number|'93'
op|','
number|'106'
op|','
number|'46'
op|','
number|'94'
op|','
number|'31'
op|','
number|'19'
op|','
number|'7'
op|','
number|'58'
op|']'
newline|'\n'
nl|'\n'
name|'part2'
op|','
name|'devs2'
op|'='
name|'r'
op|'.'
name|'get_nodes'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o2'"
op|')'
newline|'\n'
name|'primary_zones2'
op|'='
name|'set'
op|'('
op|'['
name|'d'
op|'['
string|"'zone'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs2'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'part2'
op|','
name|'exp_part2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'d'
op|'['
string|"'id'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs2'
op|']'
op|','
name|'exp_devs2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'primary_zones2'
op|','
name|'exp_zones2'
op|')'
newline|'\n'
name|'devs2'
op|'='
name|'list'
op|'('
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'part2'
op|')'
op|')'
newline|'\n'
name|'dev_ids2'
op|'='
op|'['
name|'d'
op|'['
string|"'id'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs2'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'dev_ids2'
op|')'
op|','
name|'len'
op|'('
name|'exp_handoffs2'
op|')'
op|')'
newline|'\n'
name|'for'
name|'index'
op|','
name|'dev'
name|'in'
name|'enumerate'
op|'('
name|'dev_ids2'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'dev'
op|','
name|'exp_handoffs2'
op|'['
name|'index'
op|']'
op|','
nl|'\n'
string|"'handoff differs at position %d\\n%s\\n%s'"
op|'%'
op|'('
nl|'\n'
name|'index'
op|','
name|'dev_ids2'
op|'['
name|'index'
op|':'
op|']'
op|','
name|'exp_handoffs2'
op|'['
name|'index'
op|':'
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'seen_zones'
op|'='
name|'set'
op|'('
name|'primary_zones2'
op|')'
newline|'\n'
name|'seen_zones'
op|'.'
name|'update'
op|'('
op|'['
name|'d'
op|'['
string|"'zone'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs2'
op|'['
op|':'
number|'6'
op|']'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'seen_zones'
op|','
name|'set'
op|'('
name|'range'
op|'('
number|'1'
op|','
number|'10'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# Test distribution across regions'
nl|'\n'
name|'rb'
op|'.'
name|'set_replicas'
op|'('
number|'3'
op|')'
newline|'\n'
name|'for'
name|'region'
name|'in'
name|'range'
op|'('
number|'1'
op|','
number|'5'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'rb'
op|'.'
name|'add_dev'
op|'('
op|'{'
string|"'id'"
op|':'
name|'next_dev_id'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'1.%d.1.%d'"
op|'%'
op|'('
name|'region'
op|','
name|'server'
op|')'
op|','
string|"'port'"
op|':'
number|'1234'
op|','
nl|'\n'
comment|'# 108.0 is the weight of all devices created prior to'
nl|'\n'
comment|'# this test in region 0; this way all regions have'
nl|'\n'
comment|'# equal combined weight'
nl|'\n'
string|"'zone'"
op|':'
number|'1'
op|','
string|"'region'"
op|':'
name|'region'
op|','
string|"'weight'"
op|':'
number|'108.0'
op|'}'
op|')'
newline|'\n'
name|'next_dev_id'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'pretend_min_part_hours_passed'
op|'('
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'testgz'
op|')'
newline|'\n'
name|'r'
op|'='
name|'ring'
op|'.'
name|'Ring'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'ring_name'
op|'='
string|"'whatever'"
op|')'
newline|'\n'
nl|'\n'
comment|"# There's 5 regions now, so the primary nodes + first 2 handoffs"
nl|'\n'
comment|'# should span all 5 regions'
nl|'\n'
name|'part'
op|','
name|'devs'
op|'='
name|'r'
op|'.'
name|'get_nodes'
op|'('
string|"'a1'"
op|','
string|"'c1'"
op|','
string|"'o1'"
op|')'
newline|'\n'
name|'primary_regions'
op|'='
name|'set'
op|'('
op|'['
name|'d'
op|'['
string|"'region'"
op|']'
name|'for'
name|'d'
name|'in'
name|'devs'
op|']'
op|')'
newline|'\n'
name|'primary_zones'
op|'='
name|'set'
op|'('
op|'['
op|'('
name|'d'
op|'['
string|"'region'"
op|']'
op|','
name|'d'
op|'['
string|"'zone'"
op|']'
op|')'
name|'for'
name|'d'
name|'in'
name|'devs'
op|']'
op|')'
newline|'\n'
name|'more_devs'
op|'='
name|'list'
op|'('
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'part'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'seen_regions'
op|'='
name|'set'
op|'('
name|'primary_regions'
op|')'
newline|'\n'
name|'seen_regions'
op|'.'
name|'update'
op|'('
op|'['
name|'d'
op|'['
string|"'region'"
op|']'
name|'for'
name|'d'
name|'in'
name|'more_devs'
op|'['
op|':'
number|'2'
op|']'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'seen_regions'
op|','
name|'set'
op|'('
name|'range'
op|'('
number|'0'
op|','
number|'5'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# There are 13 zones now, so the first 13 nodes should all have'
nl|'\n'
comment|"# distinct zones (that's r0z0, r0z1, ..., r0z8, r1z1, r2z1, r3z1, and"
nl|'\n'
comment|'# r4z1).'
nl|'\n'
name|'seen_zones'
op|'='
name|'set'
op|'('
name|'primary_zones'
op|')'
newline|'\n'
name|'seen_zones'
op|'.'
name|'update'
op|'('
op|'['
op|'('
name|'d'
op|'['
string|"'region'"
op|']'
op|','
name|'d'
op|'['
string|"'zone'"
op|']'
op|')'
name|'for'
name|'d'
name|'in'
name|'more_devs'
op|'['
op|':'
number|'10'
op|']'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'13'
op|','
name|'len'
op|'('
name|'seen_zones'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|"# Here's a brittle canary-in-the-coalmine test to make sure the region"
nl|'\n'
comment|"# handoff computation didn't change accidentally"
nl|'\n'
name|'exp_handoffs'
op|'='
op|'['
number|'111'
op|','
number|'112'
op|','
number|'35'
op|','
number|'58'
op|','
number|'62'
op|','
number|'74'
op|','
number|'20'
op|','
number|'105'
op|','
number|'41'
op|','
number|'90'
op|','
number|'53'
op|','
number|'6'
op|','
number|'3'
op|','
nl|'\n'
number|'67'
op|','
number|'55'
op|','
number|'76'
op|','
number|'108'
op|','
number|'32'
op|','
number|'12'
op|','
number|'80'
op|','
number|'38'
op|','
number|'85'
op|','
number|'94'
op|','
number|'42'
op|','
number|'27'
op|','
number|'99'
op|','
nl|'\n'
number|'50'
op|','
number|'47'
op|','
number|'70'
op|','
number|'87'
op|','
number|'26'
op|','
number|'9'
op|','
number|'15'
op|','
number|'97'
op|','
number|'102'
op|','
number|'81'
op|','
number|'23'
op|','
number|'65'
op|','
number|'33'
op|','
nl|'\n'
number|'77'
op|','
number|'34'
op|','
number|'4'
op|','
number|'75'
op|','
number|'8'
op|','
number|'5'
op|','
number|'30'
op|','
number|'13'
op|','
number|'73'
op|','
number|'36'
op|','
number|'92'
op|','
number|'54'
op|','
number|'51'
op|','
number|'72'
op|','
nl|'\n'
number|'78'
op|','
number|'66'
op|','
number|'1'
op|','
number|'48'
op|','
number|'14'
op|','
number|'93'
op|','
number|'95'
op|','
number|'88'
op|','
number|'86'
op|','
number|'84'
op|','
number|'106'
op|','
number|'60'
op|','
number|'101'
op|','
nl|'\n'
number|'57'
op|','
number|'43'
op|','
number|'89'
op|','
number|'59'
op|','
number|'79'
op|','
number|'46'
op|','
number|'61'
op|','
number|'52'
op|','
number|'44'
op|','
number|'45'
op|','
number|'37'
op|','
number|'68'
op|','
number|'25'
op|','
nl|'\n'
number|'100'
op|','
number|'49'
op|','
number|'24'
op|','
number|'16'
op|','
number|'71'
op|','
number|'96'
op|','
number|'21'
op|','
number|'107'
op|','
number|'98'
op|','
number|'64'
op|','
number|'39'
op|','
number|'18'
op|','
number|'29'
op|','
nl|'\n'
number|'103'
op|','
number|'91'
op|','
number|'22'
op|','
number|'63'
op|','
number|'69'
op|','
number|'28'
op|','
number|'56'
op|','
number|'11'
op|','
number|'82'
op|','
number|'10'
op|','
number|'17'
op|','
number|'19'
op|','
number|'7'
op|','
nl|'\n'
number|'40'
op|','
number|'83'
op|','
number|'104'
op|','
number|'31'
op|']'
newline|'\n'
name|'dev_ids'
op|'='
op|'['
name|'d'
op|'['
string|"'id'"
op|']'
name|'for'
name|'d'
name|'in'
name|'more_devs'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'dev_ids'
op|')'
op|','
name|'len'
op|'('
name|'exp_handoffs'
op|')'
op|')'
newline|'\n'
name|'for'
name|'index'
op|','
name|'dev_id'
name|'in'
name|'enumerate'
op|'('
name|'dev_ids'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'dev_id'
op|','
name|'exp_handoffs'
op|'['
name|'index'
op|']'
op|','
nl|'\n'
string|"'handoff differs at position %d\\n%s\\n%s'"
op|'%'
op|'('
nl|'\n'
name|'index'
op|','
name|'dev_ids'
op|'['
name|'index'
op|':'
op|']'
op|','
name|'exp_handoffs'
op|'['
name|'index'
op|':'
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_more_nodes_with_zero_weight_region
dedent|''
dedent|''
name|'def'
name|'test_get_more_nodes_with_zero_weight_region'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rb'
op|'='
name|'ring'
op|'.'
name|'RingBuilder'
op|'('
number|'8'
op|','
number|'3'
op|','
number|'1'
op|')'
newline|'\n'
name|'devs'
op|'='
op|'['
nl|'\n'
name|'ring_utils'
op|'.'
name|'parse_add_value'
op|'('
name|'v'
op|')'
name|'for'
name|'v'
name|'in'
op|'['
nl|'\n'
string|"'r1z1-127.0.0.1:6200/d1'"
op|','
nl|'\n'
string|"'r1z1-127.0.0.1:6201/d2'"
op|','
nl|'\n'
string|"'r1z1-127.0.0.1:6202/d3'"
op|','
nl|'\n'
string|"'r1z1-127.0.0.1:6203/d4'"
op|','
nl|'\n'
string|"'r1z2-127.0.0.2:6200/d1'"
op|','
nl|'\n'
string|"'r1z2-127.0.0.2:6201/d2'"
op|','
nl|'\n'
string|"'r1z2-127.0.0.2:6202/d3'"
op|','
nl|'\n'
string|"'r1z2-127.0.0.2:6203/d4'"
op|','
nl|'\n'
string|"'r2z1-127.0.1.1:6200/d1'"
op|','
nl|'\n'
string|"'r2z1-127.0.1.1:6201/d2'"
op|','
nl|'\n'
string|"'r2z1-127.0.1.1:6202/d3'"
op|','
nl|'\n'
string|"'r2z1-127.0.1.1:6203/d4'"
op|','
nl|'\n'
string|"'r2z2-127.0.1.2:6200/d1'"
op|','
nl|'\n'
string|"'r2z2-127.0.1.2:6201/d2'"
op|','
nl|'\n'
string|"'r2z2-127.0.1.2:6202/d3'"
op|','
nl|'\n'
string|"'r2z2-127.0.1.2:6203/d4'"
op|','
nl|'\n'
op|']'
nl|'\n'
op|']'
newline|'\n'
name|'for'
name|'dev'
name|'in'
name|'devs'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'dev'
op|'['
string|"'region'"
op|']'
op|'=='
number|'2'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'['
string|"'weight'"
op|']'
op|'='
number|'0.0'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'['
string|"'weight'"
op|']'
op|'='
number|'1.0'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'add_dev'
op|'('
name|'dev'
op|')'
newline|'\n'
dedent|''
name|'rb'
op|'.'
name|'rebalance'
op|'('
name|'seed'
op|'='
number|'1'
op|')'
newline|'\n'
name|'rb'
op|'.'
name|'get_ring'
op|'('
op|')'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'testgz'
op|')'
newline|'\n'
name|'r'
op|'='
name|'ring'
op|'.'
name|'Ring'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'ring_name'
op|'='
string|"'whatever'"
op|')'
newline|'\n'
nl|'\n'
DECL|class|CountingRingTable
name|'class'
name|'CountingRingTable'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|__init__
indent|'            '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'table'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'table'
op|'='
name|'table'
newline|'\n'
name|'self'
op|'.'
name|'count'
op|'='
number|'0'
newline|'\n'
nl|'\n'
DECL|member|__iter__
dedent|''
name|'def'
name|'__iter__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'_iter'
op|'='
name|'iter'
op|'('
name|'self'
op|'.'
name|'table'
op|')'
newline|'\n'
name|'return'
name|'self'
newline|'\n'
nl|'\n'
DECL|member|__next__
dedent|''
name|'def'
name|'__next__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'count'
op|'+='
number|'1'
newline|'\n'
name|'return'
name|'next'
op|'('
name|'self'
op|'.'
name|'_iter'
op|')'
newline|'\n'
nl|'\n'
comment|'# complete the api'
nl|'\n'
DECL|variable|next
dedent|''
name|'next'
op|'='
name|'__next__'
newline|'\n'
nl|'\n'
DECL|member|__getitem__
name|'def'
name|'__getitem__'
op|'('
name|'self'
op|','
name|'key'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'self'
op|'.'
name|'table'
op|'['
name|'key'
op|']'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'counting_table'
op|'='
name|'CountingRingTable'
op|'('
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|')'
newline|'\n'
name|'r'
op|'.'
name|'_replica2part2dev_id'
op|'='
name|'counting_table'
newline|'\n'
nl|'\n'
name|'part'
op|'='
name|'random'
op|'.'
name|'randint'
op|'('
number|'0'
op|','
name|'r'
op|'.'
name|'partition_count'
op|')'
newline|'\n'
name|'node_iter'
op|'='
name|'r'
op|'.'
name|'get_more_nodes'
op|'('
name|'part'
op|')'
newline|'\n'
name|'next'
op|'('
name|'node_iter'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'5'
op|','
name|'counting_table'
op|'.'
name|'count'
op|')'
newline|'\n'
comment|'# sanity'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'r'
op|'.'
name|'_num_regions'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'r'
op|'.'
name|'_num_zones'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'__name__'
op|'=='
string|"'__main__'"
op|':'
newline|'\n'
indent|'    '
name|'unittest'
op|'.'
name|'main'
op|'('
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit

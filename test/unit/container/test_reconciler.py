begin_unit
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'json'
newline|'\n'
name|'import'
name|'contextlib'
newline|'\n'
name|'import'
name|'mock'
newline|'\n'
name|'import'
name|'operator'
newline|'\n'
name|'import'
name|'time'
newline|'\n'
name|'import'
name|'unittest'
newline|'\n'
name|'import'
name|'urllib'
newline|'\n'
name|'import'
name|'socket'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'errno'
newline|'\n'
name|'import'
name|'itertools'
newline|'\n'
name|'import'
name|'random'
newline|'\n'
nl|'\n'
name|'from'
name|'collections'
name|'import'
name|'defaultdict'
newline|'\n'
name|'from'
name|'datetime'
name|'import'
name|'datetime'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'container'
name|'import'
name|'reconciler'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'container'
op|'.'
name|'server'
name|'import'
name|'gen_resp_headers'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'direct_client'
name|'import'
name|'ClientException'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'swob'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'split_path'
op|','
name|'Timestamp'
newline|'\n'
nl|'\n'
name|'from'
name|'test'
op|'.'
name|'unit'
name|'import'
name|'debug_logger'
op|','
name|'FakeRing'
op|','
name|'fake_http_connect'
newline|'\n'
name|'from'
name|'test'
op|'.'
name|'unit'
op|'.'
name|'common'
op|'.'
name|'middleware'
op|'.'
name|'helpers'
name|'import'
name|'FakeSwift'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|timestamp_to_last_modified
name|'def'
name|'timestamp_to_last_modified'
op|'('
name|'timestamp'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'return'
name|'datetime'
op|'.'
name|'fromtimestamp'
op|'('
nl|'\n'
name|'float'
op|'('
name|'Timestamp'
op|'('
name|'timestamp'
op|')'
op|')'
op|')'
op|'.'
name|'strftime'
op|'('
string|"'%Y-%m-%dT%H:%M:%S.%f'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|container_resp_headers
dedent|''
name|'def'
name|'container_resp_headers'
op|'('
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'return'
name|'swob'
op|'.'
name|'HeaderKeyDict'
op|'('
name|'gen_resp_headers'
op|'('
name|'kwargs'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|FakeStoragePolicySwift
dedent|''
name|'class'
name|'FakeStoragePolicySwift'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'storage_policy'
op|'='
name|'defaultdict'
op|'('
name|'FakeSwift'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi_map'
op|'='
op|'{'
op|'}'
newline|'\n'
nl|'\n'
DECL|member|__getattribute__
dedent|''
name|'def'
name|'__getattribute__'
op|'('
name|'self'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'object'
op|'.'
name|'__getattribute__'
op|'('
name|'self'
op|','
name|'name'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'AttributeError'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'getattr'
op|'('
name|'self'
op|'.'
name|'storage_policy'
op|'['
name|'None'
op|']'
op|','
name|'name'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__call__
dedent|''
dedent|''
name|'def'
name|'__call__'
op|'('
name|'self'
op|','
name|'env'
op|','
name|'start_response'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'method'
op|'='
name|'env'
op|'['
string|"'REQUEST_METHOD'"
op|']'
newline|'\n'
name|'path'
op|'='
name|'env'
op|'['
string|"'PATH_INFO'"
op|']'
newline|'\n'
name|'_'
op|','
name|'acc'
op|','
name|'cont'
op|','
name|'obj'
op|'='
name|'split_path'
op|'('
name|'env'
op|'['
string|"'PATH_INFO'"
op|']'
op|','
number|'0'
op|','
number|'4'
op|','
nl|'\n'
name|'rest_with_last'
op|'='
name|'True'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'obj'
op|':'
newline|'\n'
indent|'            '
name|'policy_index'
op|'='
name|'None'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'policy_index'
op|'='
name|'self'
op|'.'
name|'_mock_oldest_spi_map'
op|'.'
name|'get'
op|'('
name|'cont'
op|','
number|'0'
op|')'
newline|'\n'
comment|'# allow backend policy override'
nl|'\n'
name|'if'
string|"'HTTP_X_BACKEND_STORAGE_POLICY_INDEX'"
name|'in'
name|'env'
op|':'
newline|'\n'
indent|'                '
name|'policy_index'
op|'='
name|'int'
op|'('
name|'env'
op|'['
string|"'HTTP_X_BACKEND_STORAGE_POLICY_INDEX'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'storage_policy'
op|'['
name|'policy_index'
op|']'
op|'.'
name|'__call__'
op|'('
nl|'\n'
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'KeyError'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'method'
op|'=='
string|"'PUT'"
op|':'
newline|'\n'
indent|'            '
name|'resp_class'
op|'='
name|'swob'
op|'.'
name|'HTTPCreated'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'resp_class'
op|'='
name|'swob'
op|'.'
name|'HTTPNotFound'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'storage_policy'
op|'['
name|'policy_index'
op|']'
op|'.'
name|'register'
op|'('
nl|'\n'
name|'method'
op|','
name|'path'
op|','
name|'resp_class'
op|','
op|'{'
op|'}'
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
name|'return'
name|'self'
op|'.'
name|'storage_policy'
op|'['
name|'policy_index'
op|']'
op|'.'
name|'__call__'
op|'('
nl|'\n'
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|FakeInternalClient
dedent|''
dedent|''
name|'class'
name|'FakeInternalClient'
op|'('
name|'reconciler'
op|'.'
name|'InternalClient'
op|')'
op|':'
newline|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'listings'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'app'
op|'='
name|'FakeStoragePolicySwift'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'user_agent'
op|'='
string|"'fake-internal-client'"
newline|'\n'
name|'self'
op|'.'
name|'request_tries'
op|'='
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'parse'
op|'('
name|'listings'
op|')'
newline|'\n'
nl|'\n'
DECL|member|parse
dedent|''
name|'def'
name|'parse'
op|'('
name|'self'
op|','
name|'listings'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'accounts'
op|'='
name|'defaultdict'
op|'('
name|'lambda'
op|':'
name|'defaultdict'
op|'('
name|'list'
op|')'
op|')'
newline|'\n'
name|'for'
name|'item'
op|','
name|'timestamp'
name|'in'
name|'listings'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
comment|'# XXX this interface is stupid'
nl|'\n'
indent|'            '
name|'if'
name|'isinstance'
op|'('
name|'timestamp'
op|','
name|'tuple'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'timestamp'
op|','
name|'content_type'
op|'='
name|'timestamp'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'timestamp'
op|','
name|'content_type'
op|'='
name|'timestamp'
op|','
string|"'application/x-put'"
newline|'\n'
dedent|''
name|'storage_policy_index'
op|','
name|'path'
op|'='
name|'item'
newline|'\n'
name|'account'
op|','
name|'container_name'
op|','
name|'obj_name'
op|'='
name|'split_path'
op|'('
nl|'\n'
name|'path'
op|'.'
name|'encode'
op|'('
string|"'utf-8'"
op|')'
op|','
number|'0'
op|','
number|'3'
op|','
name|'rest_with_last'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'accounts'
op|'['
name|'account'
op|']'
op|'['
name|'container_name'
op|']'
op|'.'
name|'append'
op|'('
nl|'\n'
op|'('
name|'obj_name'
op|','
name|'storage_policy_index'
op|','
name|'timestamp'
op|','
name|'content_type'
op|')'
op|')'
newline|'\n'
dedent|''
name|'for'
name|'account_name'
op|','
name|'containers'
name|'in'
name|'self'
op|'.'
name|'accounts'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'con'
name|'in'
name|'containers'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'accounts'
op|'['
name|'account_name'
op|']'
op|'['
name|'con'
op|']'
op|'.'
name|'sort'
op|'('
name|'key'
op|'='
name|'lambda'
name|'t'
op|':'
name|'t'
op|'['
number|'0'
op|']'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'for'
name|'account'
op|','
name|'containers'
name|'in'
name|'self'
op|'.'
name|'accounts'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'account_listing_data'
op|'='
op|'['
op|']'
newline|'\n'
name|'account_path'
op|'='
string|"'/v1/%s'"
op|'%'
name|'account'
newline|'\n'
name|'for'
name|'container'
op|','
name|'objects'
name|'in'
name|'containers'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'container_path'
op|'='
name|'account_path'
op|'+'
string|"'/'"
op|'+'
name|'container'
newline|'\n'
name|'container_listing_data'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'entry'
name|'in'
name|'objects'
op|':'
newline|'\n'
indent|'                    '
op|'('
name|'obj_name'
op|','
name|'storage_policy_index'
op|','
nl|'\n'
name|'timestamp'
op|','
name|'content_type'
op|')'
op|'='
name|'entry'
newline|'\n'
name|'if'
name|'storage_policy_index'
name|'is'
name|'None'
name|'and'
name|'not'
name|'obj_name'
op|':'
newline|'\n'
comment|'# empty container'
nl|'\n'
indent|'                        '
name|'continue'
newline|'\n'
dedent|''
name|'obj_path'
op|'='
name|'container_path'
op|'+'
string|"'/'"
op|'+'
name|'obj_name'
newline|'\n'
name|'ts'
op|'='
name|'Timestamp'
op|'('
name|'timestamp'
op|')'
newline|'\n'
name|'headers'
op|'='
op|'{'
string|"'X-Timestamp'"
op|':'
name|'ts'
op|'.'
name|'normal'
op|','
nl|'\n'
string|"'X-Backend-Timestamp'"
op|':'
name|'ts'
op|'.'
name|'internal'
op|'}'
newline|'\n'
comment|'# register object response'
nl|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'storage_policy'
op|'['
name|'storage_policy_index'
op|']'
op|'.'
name|'register'
op|'('
nl|'\n'
string|"'GET'"
op|','
name|'obj_path'
op|','
name|'swob'
op|'.'
name|'HTTPOk'
op|','
name|'headers'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'storage_policy'
op|'['
name|'storage_policy_index'
op|']'
op|'.'
name|'register'
op|'('
nl|'\n'
string|"'DELETE'"
op|','
name|'obj_path'
op|','
name|'swob'
op|'.'
name|'HTTPNoContent'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
comment|'# container listing entry'
nl|'\n'
name|'last_modified'
op|'='
name|'timestamp_to_last_modified'
op|'('
name|'timestamp'
op|')'
newline|'\n'
name|'obj_data'
op|'='
op|'{'
nl|'\n'
string|"'bytes'"
op|':'
number|'0'
op|','
nl|'\n'
comment|'# listing data is unicode'
nl|'\n'
string|"'name'"
op|':'
name|'obj_name'
op|'.'
name|'decode'
op|'('
string|"'utf-8'"
op|')'
op|','
nl|'\n'
string|"'last_modified'"
op|':'
name|'last_modified'
op|','
nl|'\n'
string|"'hash'"
op|':'
name|'timestamp'
op|','
nl|'\n'
string|"'content_type'"
op|':'
name|'content_type'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'container_listing_data'
op|'.'
name|'append'
op|'('
name|'obj_data'
op|')'
newline|'\n'
dedent|''
name|'container_listing_data'
op|'.'
name|'sort'
op|'('
name|'key'
op|'='
name|'operator'
op|'.'
name|'itemgetter'
op|'('
string|"'name'"
op|')'
op|')'
newline|'\n'
comment|'# register container listing response'
nl|'\n'
name|'container_headers'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'container_qry_string'
op|'='
string|"'?format=json&marker=&end_marker='"
newline|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'register'
op|'('
string|"'GET'"
op|','
name|'container_path'
op|'+'
name|'container_qry_string'
op|','
nl|'\n'
name|'swob'
op|'.'
name|'HTTPOk'
op|','
name|'container_headers'
op|','
nl|'\n'
name|'json'
op|'.'
name|'dumps'
op|'('
name|'container_listing_data'
op|')'
op|')'
newline|'\n'
name|'if'
name|'container_listing_data'
op|':'
newline|'\n'
indent|'                    '
name|'obj_name'
op|'='
name|'container_listing_data'
op|'['
op|'-'
number|'1'
op|']'
op|'['
string|"'name'"
op|']'
newline|'\n'
comment|'# client should quote and encode marker'
nl|'\n'
name|'end_qry_string'
op|'='
string|"'?format=json&marker=%s&end_marker='"
op|'%'
op|'('
nl|'\n'
name|'urllib'
op|'.'
name|'quote'
op|'('
name|'obj_name'
op|'.'
name|'encode'
op|'('
string|"'utf-8'"
op|')'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'register'
op|'('
string|"'GET'"
op|','
name|'container_path'
op|'+'
name|'end_qry_string'
op|','
nl|'\n'
name|'swob'
op|'.'
name|'HTTPOk'
op|','
name|'container_headers'
op|','
nl|'\n'
name|'json'
op|'.'
name|'dumps'
op|'('
op|'['
op|']'
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'app'
op|'.'
name|'register'
op|'('
string|"'DELETE'"
op|','
name|'container_path'
op|','
nl|'\n'
name|'swob'
op|'.'
name|'HTTPConflict'
op|','
op|'{'
op|'}'
op|','
string|"''"
op|')'
newline|'\n'
comment|'# simple account listing entry'
nl|'\n'
name|'container_data'
op|'='
op|'{'
string|"'name'"
op|':'
name|'container'
op|'}'
newline|'\n'
name|'account_listing_data'
op|'.'
name|'append'
op|'('
name|'container_data'
op|')'
newline|'\n'
comment|'# register account response'
nl|'\n'
dedent|''
name|'account_listing_data'
op|'.'
name|'sort'
op|'('
name|'key'
op|'='
name|'operator'
op|'.'
name|'itemgetter'
op|'('
string|"'name'"
op|')'
op|')'
newline|'\n'
name|'account_headers'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'account_qry_string'
op|'='
string|"'?format=json&marker=&end_marker='"
newline|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'register'
op|'('
string|"'GET'"
op|','
name|'account_path'
op|'+'
name|'account_qry_string'
op|','
nl|'\n'
name|'swob'
op|'.'
name|'HTTPOk'
op|','
name|'account_headers'
op|','
nl|'\n'
name|'json'
op|'.'
name|'dumps'
op|'('
name|'account_listing_data'
op|')'
op|')'
newline|'\n'
name|'end_qry_string'
op|'='
string|"'?format=json&marker=%s&end_marker='"
op|'%'
op|'('
nl|'\n'
name|'urllib'
op|'.'
name|'quote'
op|'('
name|'account_listing_data'
op|'['
op|'-'
number|'1'
op|']'
op|'['
string|"'name'"
op|']'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'register'
op|'('
string|"'GET'"
op|','
name|'account_path'
op|'+'
name|'end_qry_string'
op|','
nl|'\n'
name|'swob'
op|'.'
name|'HTTPOk'
op|','
name|'account_headers'
op|','
nl|'\n'
name|'json'
op|'.'
name|'dumps'
op|'('
op|'['
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|TestReconcilerUtils
dedent|''
dedent|''
dedent|''
name|'class'
name|'TestReconcilerUtils'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'fake_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'reconciler'
op|'.'
name|'direct_get_container_policy_index'
op|'.'
name|'reset'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_parse_raw_obj
dedent|''
name|'def'
name|'test_parse_raw_obj'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'got'
op|'='
name|'reconciler'
op|'.'
name|'parse_raw_obj'
op|'('
op|'{'
nl|'\n'
string|"'name'"
op|':'
string|'"2:/AUTH_bob/con/obj"'
op|','
nl|'\n'
string|"'hash'"
op|':'
name|'Timestamp'
op|'('
number|'2017551.49350'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
string|"'last_modified'"
op|':'
name|'timestamp_to_last_modified'
op|'('
number|'2017551.49352'
op|')'
op|','
nl|'\n'
string|"'content_type'"
op|':'
string|"'application/x-delete'"
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'got'
op|'['
string|"'q_policy_index'"
op|']'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'got'
op|'['
string|"'account'"
op|']'
op|','
string|"'AUTH_bob'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'got'
op|'['
string|"'container'"
op|']'
op|','
string|"'con'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'got'
op|'['
string|"'obj'"
op|']'
op|','
string|"'obj'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'got'
op|'['
string|"'q_ts'"
op|']'
op|','
number|'2017551.49350'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'got'
op|'['
string|"'q_record'"
op|']'
op|','
number|'2017551.49352'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'got'
op|'['
string|"'q_op'"
op|']'
op|','
string|"'DELETE'"
op|')'
newline|'\n'
nl|'\n'
name|'got'
op|'='
name|'reconciler'
op|'.'
name|'parse_raw_obj'
op|'('
op|'{'
nl|'\n'
string|"'name'"
op|':'
string|'"1:/AUTH_bob/con/obj"'
op|','
nl|'\n'
string|"'hash'"
op|':'
name|'Timestamp'
op|'('
number|'1234.20190'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
string|"'last_modified'"
op|':'
name|'timestamp_to_last_modified'
op|'('
number|'1234.20192'
op|')'
op|','
nl|'\n'
string|"'content_type'"
op|':'
string|"'application/x-put'"
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'got'
op|'['
string|"'q_policy_index'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'got'
op|'['
string|"'account'"
op|']'
op|','
string|"'AUTH_bob'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'got'
op|'['
string|"'container'"
op|']'
op|','
string|"'con'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'got'
op|'['
string|"'obj'"
op|']'
op|','
string|"'obj'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'got'
op|'['
string|"'q_ts'"
op|']'
op|','
number|'0000001234.20190'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'got'
op|'['
string|"'q_record'"
op|']'
op|','
number|'0000001234.20192'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'got'
op|'['
string|"'q_op'"
op|']'
op|','
string|"'PUT'"
op|')'
newline|'\n'
nl|'\n'
comment|'# negative test'
nl|'\n'
name|'obj_info'
op|'='
op|'{'
nl|'\n'
string|"'name'"
op|':'
string|'"1:/AUTH_bob/con/obj"'
op|','
nl|'\n'
string|"'hash'"
op|':'
name|'Timestamp'
op|'('
number|'1234.20190'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
string|"'last_modified'"
op|':'
name|'timestamp_to_last_modified'
op|'('
number|'1234.20192'
op|')'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'reconciler'
op|'.'
name|'parse_raw_obj'
op|','
name|'obj_info'
op|')'
newline|'\n'
name|'obj_info'
op|'['
string|"'content_type'"
op|']'
op|'='
string|"'foo'"
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'reconciler'
op|'.'
name|'parse_raw_obj'
op|','
name|'obj_info'
op|')'
newline|'\n'
name|'obj_info'
op|'['
string|"'content_type'"
op|']'
op|'='
string|"'appliation/x-post'"
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'reconciler'
op|'.'
name|'parse_raw_obj'
op|','
name|'obj_info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'reconciler'
op|'.'
name|'parse_raw_obj'
op|','
nl|'\n'
op|'{'
string|"'name'"
op|':'
string|"'bogus'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'reconciler'
op|'.'
name|'parse_raw_obj'
op|','
nl|'\n'
op|'{'
string|"'name'"
op|':'
string|"'-1:/AUTH_test/container'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'reconciler'
op|'.'
name|'parse_raw_obj'
op|','
nl|'\n'
op|'{'
string|"'name'"
op|':'
string|"'asdf:/AUTH_test/c/obj'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'KeyError'
op|','
name|'reconciler'
op|'.'
name|'parse_raw_obj'
op|','
nl|'\n'
op|'{'
string|"'name'"
op|':'
string|"'0:/AUTH_test/c/obj'"
op|','
nl|'\n'
string|"'content_type'"
op|':'
string|"'application/x-put'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_container_policy_index
dedent|''
name|'def'
name|'test_get_container_policy_index'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ts'
op|'='
name|'itertools'
op|'.'
name|'count'
op|'('
name|'int'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'mock_path'
op|'='
string|"'swift.container.reconciler.direct_head_container'"
newline|'\n'
name|'stub_resp_headers'
op|'='
op|'['
nl|'\n'
name|'container_resp_headers'
op|'('
nl|'\n'
name|'status_changed_at'
op|'='
name|'Timestamp'
op|'('
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'0'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
name|'container_resp_headers'
op|'('
nl|'\n'
name|'status_changed_at'
op|'='
name|'Timestamp'
op|'('
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'1'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
name|'container_resp_headers'
op|'('
nl|'\n'
name|'status_changed_at'
op|'='
name|'Timestamp'
op|'('
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'0'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'for'
name|'permutation'
name|'in'
name|'itertools'
op|'.'
name|'permutations'
op|'('
op|'('
number|'0'
op|','
number|'1'
op|','
number|'2'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'reconciler'
op|'.'
name|'direct_get_container_policy_index'
op|'.'
name|'reset'
op|'('
op|')'
newline|'\n'
name|'resp_headers'
op|'='
op|'['
name|'stub_resp_headers'
op|'['
name|'i'
op|']'
name|'for'
name|'i'
name|'in'
name|'permutation'
op|']'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|')'
name|'as'
name|'direct_head'
op|':'
newline|'\n'
indent|'                '
name|'direct_head'
op|'.'
name|'side_effect'
op|'='
name|'resp_headers'
newline|'\n'
name|'oldest_spi'
op|'='
name|'reconciler'
op|'.'
name|'direct_get_container_policy_index'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'con'"
op|')'
newline|'\n'
dedent|''
name|'test_values'
op|'='
op|'['
op|'('
name|'info'
op|'['
string|"'x-storage-policy-index'"
op|']'
op|','
nl|'\n'
name|'info'
op|'['
string|"'x-backend-status-changed-at'"
op|']'
op|')'
name|'for'
nl|'\n'
name|'info'
name|'in'
name|'resp_headers'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'oldest_spi'
op|','
number|'0'
op|','
nl|'\n'
string|'"oldest policy index wrong "'
nl|'\n'
string|'"for permutation %r"'
op|'%'
name|'test_values'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_container_policy_index_with_error
dedent|''
dedent|''
name|'def'
name|'test_get_container_policy_index_with_error'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ts'
op|'='
name|'itertools'
op|'.'
name|'count'
op|'('
name|'int'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'mock_path'
op|'='
string|"'swift.container.reconciler.direct_head_container'"
newline|'\n'
name|'stub_resp_headers'
op|'='
op|'['
nl|'\n'
name|'container_resp_headers'
op|'('
nl|'\n'
name|'status_change_at'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'2'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
name|'container_resp_headers'
op|'('
nl|'\n'
name|'status_changed_at'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'1'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
comment|'# old timestamp, but 500 should be ignored...'
nl|'\n'
name|'ClientException'
op|'('
nl|'\n'
string|"'Container Server blew up'"
op|','
nl|'\n'
name|'http_status'
op|'='
number|'500'
op|','
name|'http_reason'
op|'='
string|"'Server Error'"
op|','
nl|'\n'
name|'http_headers'
op|'='
name|'container_resp_headers'
op|'('
nl|'\n'
name|'status_changed_at'
op|'='
name|'Timestamp'
op|'('
number|'0'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'0'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'random'
op|'.'
name|'shuffle'
op|'('
name|'stub_resp_headers'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|')'
name|'as'
name|'direct_head'
op|':'
newline|'\n'
indent|'            '
name|'direct_head'
op|'.'
name|'side_effect'
op|'='
name|'stub_resp_headers'
newline|'\n'
name|'oldest_spi'
op|'='
name|'reconciler'
op|'.'
name|'direct_get_container_policy_index'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'con'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'oldest_spi'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_container_policy_index_with_socket_error
dedent|''
name|'def'
name|'test_get_container_policy_index_with_socket_error'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ts'
op|'='
name|'itertools'
op|'.'
name|'count'
op|'('
name|'int'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'mock_path'
op|'='
string|"'swift.container.reconciler.direct_head_container'"
newline|'\n'
name|'stub_resp_headers'
op|'='
op|'['
nl|'\n'
name|'container_resp_headers'
op|'('
nl|'\n'
name|'status_changed_at'
op|'='
name|'Timestamp'
op|'('
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'1'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
name|'container_resp_headers'
op|'('
nl|'\n'
name|'status_changed_at'
op|'='
name|'Timestamp'
op|'('
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'0'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
name|'socket'
op|'.'
name|'error'
op|'('
name|'errno'
op|'.'
name|'ECONNREFUSED'
op|','
name|'os'
op|'.'
name|'strerror'
op|'('
name|'errno'
op|'.'
name|'ECONNREFUSED'
op|')'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'random'
op|'.'
name|'shuffle'
op|'('
name|'stub_resp_headers'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|')'
name|'as'
name|'direct_head'
op|':'
newline|'\n'
indent|'            '
name|'direct_head'
op|'.'
name|'side_effect'
op|'='
name|'stub_resp_headers'
newline|'\n'
name|'oldest_spi'
op|'='
name|'reconciler'
op|'.'
name|'direct_get_container_policy_index'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'con'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'oldest_spi'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_container_policy_index_with_too_many_errors
dedent|''
name|'def'
name|'test_get_container_policy_index_with_too_many_errors'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ts'
op|'='
name|'itertools'
op|'.'
name|'count'
op|'('
name|'int'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'mock_path'
op|'='
string|"'swift.container.reconciler.direct_head_container'"
newline|'\n'
name|'stub_resp_headers'
op|'='
op|'['
nl|'\n'
name|'container_resp_headers'
op|'('
nl|'\n'
name|'status_changed_at'
op|'='
name|'Timestamp'
op|'('
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'0'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
name|'socket'
op|'.'
name|'error'
op|'('
name|'errno'
op|'.'
name|'ECONNREFUSED'
op|','
name|'os'
op|'.'
name|'strerror'
op|'('
name|'errno'
op|'.'
name|'ECONNREFUSED'
op|')'
op|')'
op|','
nl|'\n'
name|'ClientException'
op|'('
nl|'\n'
string|"'Container Server blew up'"
op|','
nl|'\n'
name|'http_status'
op|'='
number|'500'
op|','
name|'http_reason'
op|'='
string|"'Server Error'"
op|','
nl|'\n'
name|'http_headers'
op|'='
name|'container_resp_headers'
op|'('
nl|'\n'
name|'status_changed_at'
op|'='
name|'Timestamp'
op|'('
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'1'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'random'
op|'.'
name|'shuffle'
op|'('
name|'stub_resp_headers'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|')'
name|'as'
name|'direct_head'
op|':'
newline|'\n'
indent|'            '
name|'direct_head'
op|'.'
name|'side_effect'
op|'='
name|'stub_resp_headers'
newline|'\n'
name|'oldest_spi'
op|'='
name|'reconciler'
op|'.'
name|'direct_get_container_policy_index'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'con'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'oldest_spi'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_container_policy_index_for_deleted
dedent|''
name|'def'
name|'test_get_container_policy_index_for_deleted'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_path'
op|'='
string|"'swift.container.reconciler.direct_head_container'"
newline|'\n'
name|'headers'
op|'='
name|'container_resp_headers'
op|'('
nl|'\n'
name|'status_changed_at'
op|'='
name|'Timestamp'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'1'
op|','
nl|'\n'
op|')'
newline|'\n'
name|'stub_resp_headers'
op|'='
op|'['
nl|'\n'
name|'ClientException'
op|'('
nl|'\n'
string|"'Container Not Found'"
op|','
nl|'\n'
name|'http_status'
op|'='
number|'404'
op|','
name|'http_reason'
op|'='
string|"'Not Found'"
op|','
nl|'\n'
name|'http_headers'
op|'='
name|'headers'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
name|'ClientException'
op|'('
nl|'\n'
string|"'Container Not Found'"
op|','
nl|'\n'
name|'http_status'
op|'='
number|'404'
op|','
name|'http_reason'
op|'='
string|"'Not Found'"
op|','
nl|'\n'
name|'http_headers'
op|'='
name|'headers'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
name|'ClientException'
op|'('
nl|'\n'
string|"'Container Not Found'"
op|','
nl|'\n'
name|'http_status'
op|'='
number|'404'
op|','
name|'http_reason'
op|'='
string|"'Not Found'"
op|','
nl|'\n'
name|'http_headers'
op|'='
name|'headers'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'random'
op|'.'
name|'shuffle'
op|'('
name|'stub_resp_headers'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|')'
name|'as'
name|'direct_head'
op|':'
newline|'\n'
indent|'            '
name|'direct_head'
op|'.'
name|'side_effect'
op|'='
name|'stub_resp_headers'
newline|'\n'
name|'oldest_spi'
op|'='
name|'reconciler'
op|'.'
name|'direct_get_container_policy_index'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'con'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'oldest_spi'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_container_policy_index_for_recently_deleted
dedent|''
name|'def'
name|'test_get_container_policy_index_for_recently_deleted'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ts'
op|'='
name|'itertools'
op|'.'
name|'count'
op|'('
name|'int'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'mock_path'
op|'='
string|"'swift.container.reconciler.direct_head_container'"
newline|'\n'
name|'stub_resp_headers'
op|'='
op|'['
nl|'\n'
name|'ClientException'
op|'('
nl|'\n'
string|"'Container Not Found'"
op|','
nl|'\n'
name|'http_status'
op|'='
number|'404'
op|','
name|'http_reason'
op|'='
string|"'Not Found'"
op|','
nl|'\n'
name|'http_headers'
op|'='
name|'container_resp_headers'
op|'('
nl|'\n'
name|'put_timestamp'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'delete_timestamp'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'status_changed_at'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'0'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
name|'ClientException'
op|'('
nl|'\n'
string|"'Container Not Found'"
op|','
nl|'\n'
name|'http_status'
op|'='
number|'404'
op|','
name|'http_reason'
op|'='
string|"'Not Found'"
op|','
nl|'\n'
name|'http_headers'
op|'='
name|'container_resp_headers'
op|'('
nl|'\n'
name|'put_timestamp'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'delete_timestamp'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'status_changed_at'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'1'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
name|'ClientException'
op|'('
nl|'\n'
string|"'Container Not Found'"
op|','
nl|'\n'
name|'http_status'
op|'='
number|'404'
op|','
name|'http_reason'
op|'='
string|"'Not Found'"
op|','
nl|'\n'
name|'http_headers'
op|'='
name|'container_resp_headers'
op|'('
nl|'\n'
name|'put_timestamp'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'delete_timestamp'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'status_changed_at'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'2'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'random'
op|'.'
name|'shuffle'
op|'('
name|'stub_resp_headers'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|')'
name|'as'
name|'direct_head'
op|':'
newline|'\n'
indent|'            '
name|'direct_head'
op|'.'
name|'side_effect'
op|'='
name|'stub_resp_headers'
newline|'\n'
name|'oldest_spi'
op|'='
name|'reconciler'
op|'.'
name|'direct_get_container_policy_index'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'con'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'oldest_spi'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_container_policy_index_for_recently_recreated
dedent|''
name|'def'
name|'test_get_container_policy_index_for_recently_recreated'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ts'
op|'='
name|'itertools'
op|'.'
name|'count'
op|'('
name|'int'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'mock_path'
op|'='
string|"'swift.container.reconciler.direct_head_container'"
newline|'\n'
name|'stub_resp_headers'
op|'='
op|'['
nl|'\n'
comment|'# old put, no recreate'
nl|'\n'
name|'container_resp_headers'
op|'('
nl|'\n'
name|'delete_timestamp'
op|'='
number|'0'
op|','
nl|'\n'
name|'put_timestamp'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'status_changed_at'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'0'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
comment|'# recently deleted'
nl|'\n'
name|'ClientException'
op|'('
nl|'\n'
string|"'Container Not Found'"
op|','
nl|'\n'
name|'http_status'
op|'='
number|'404'
op|','
name|'http_reason'
op|'='
string|"'Not Found'"
op|','
nl|'\n'
name|'http_headers'
op|'='
name|'container_resp_headers'
op|'('
nl|'\n'
name|'put_timestamp'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'delete_timestamp'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'status_changed_at'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'1'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
comment|'# recently recreated'
nl|'\n'
name|'container_resp_headers'
op|'('
nl|'\n'
name|'delete_timestamp'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'put_timestamp'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'status_changed_at'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'2'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'random'
op|'.'
name|'shuffle'
op|'('
name|'stub_resp_headers'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|')'
name|'as'
name|'direct_head'
op|':'
newline|'\n'
indent|'            '
name|'direct_head'
op|'.'
name|'side_effect'
op|'='
name|'stub_resp_headers'
newline|'\n'
name|'oldest_spi'
op|'='
name|'reconciler'
op|'.'
name|'direct_get_container_policy_index'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'con'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'oldest_spi'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_container_policy_index_for_recently_split_brain
dedent|''
name|'def'
name|'test_get_container_policy_index_for_recently_split_brain'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ts'
op|'='
name|'itertools'
op|'.'
name|'count'
op|'('
name|'int'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'mock_path'
op|'='
string|"'swift.container.reconciler.direct_head_container'"
newline|'\n'
name|'stub_resp_headers'
op|'='
op|'['
nl|'\n'
comment|'# oldest put'
nl|'\n'
name|'container_resp_headers'
op|'('
nl|'\n'
name|'delete_timestamp'
op|'='
number|'0'
op|','
nl|'\n'
name|'put_timestamp'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'status_changed_at'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'0'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
comment|'# old recreate'
nl|'\n'
name|'container_resp_headers'
op|'('
nl|'\n'
name|'delete_timestamp'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'put_timestamp'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'status_changed_at'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'1'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
comment|'# recently put'
nl|'\n'
name|'container_resp_headers'
op|'('
nl|'\n'
name|'delete_timestamp'
op|'='
number|'0'
op|','
nl|'\n'
name|'put_timestamp'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'status_changed_at'
op|'='
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'2'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'random'
op|'.'
name|'shuffle'
op|'('
name|'stub_resp_headers'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|')'
name|'as'
name|'direct_head'
op|':'
newline|'\n'
indent|'            '
name|'direct_head'
op|'.'
name|'side_effect'
op|'='
name|'stub_resp_headers'
newline|'\n'
name|'oldest_spi'
op|'='
name|'reconciler'
op|'.'
name|'direct_get_container_policy_index'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'con'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'oldest_spi'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_container_policy_index_cache
dedent|''
name|'def'
name|'test_get_container_policy_index_cache'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'now'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'ts'
op|'='
name|'itertools'
op|'.'
name|'count'
op|'('
name|'int'
op|'('
name|'now'
op|')'
op|')'
newline|'\n'
name|'mock_path'
op|'='
string|"'swift.container.reconciler.direct_head_container'"
newline|'\n'
name|'stub_resp_headers'
op|'='
op|'['
nl|'\n'
name|'container_resp_headers'
op|'('
nl|'\n'
name|'status_changed_at'
op|'='
name|'Timestamp'
op|'('
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'0'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
name|'container_resp_headers'
op|'('
nl|'\n'
name|'status_changed_at'
op|'='
name|'Timestamp'
op|'('
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'1'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
name|'container_resp_headers'
op|'('
nl|'\n'
name|'status_changed_at'
op|'='
name|'Timestamp'
op|'('
name|'ts'
op|'.'
name|'next'
op|'('
op|')'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
number|'0'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'random'
op|'.'
name|'shuffle'
op|'('
name|'stub_resp_headers'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|')'
name|'as'
name|'direct_head'
op|':'
newline|'\n'
indent|'            '
name|'direct_head'
op|'.'
name|'side_effect'
op|'='
name|'stub_resp_headers'
newline|'\n'
name|'oldest_spi'
op|'='
name|'reconciler'
op|'.'
name|'direct_get_container_policy_index'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'con'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'oldest_spi'
op|','
number|'0'
op|')'
newline|'\n'
comment|'# re-mock with errors'
nl|'\n'
name|'stub_resp_headers'
op|'='
op|'['
nl|'\n'
name|'socket'
op|'.'
name|'error'
op|'('
name|'errno'
op|'.'
name|'ECONNREFUSED'
op|','
name|'os'
op|'.'
name|'strerror'
op|'('
name|'errno'
op|'.'
name|'ECONNREFUSED'
op|')'
op|')'
op|','
nl|'\n'
name|'socket'
op|'.'
name|'error'
op|'('
name|'errno'
op|'.'
name|'ECONNREFUSED'
op|','
name|'os'
op|'.'
name|'strerror'
op|'('
name|'errno'
op|'.'
name|'ECONNREFUSED'
op|')'
op|')'
op|','
nl|'\n'
name|'socket'
op|'.'
name|'error'
op|'('
name|'errno'
op|'.'
name|'ECONNREFUSED'
op|','
name|'os'
op|'.'
name|'strerror'
op|'('
name|'errno'
op|'.'
name|'ECONNREFUSED'
op|')'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'time.time'"
op|','
name|'new'
op|'='
name|'lambda'
op|':'
name|'now'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|')'
name|'as'
name|'direct_head'
op|':'
newline|'\n'
indent|'                '
name|'direct_head'
op|'.'
name|'side_effect'
op|'='
name|'stub_resp_headers'
newline|'\n'
name|'oldest_spi'
op|'='
name|'reconciler'
op|'.'
name|'direct_get_container_policy_index'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'con'"
op|')'
newline|'\n'
comment|'# still cached'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'oldest_spi'
op|','
number|'0'
op|')'
newline|'\n'
comment|'# propel time forward'
nl|'\n'
name|'the_future'
op|'='
name|'now'
op|'+'
number|'31'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'time.time'"
op|','
name|'new'
op|'='
name|'lambda'
op|':'
name|'the_future'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|')'
name|'as'
name|'direct_head'
op|':'
newline|'\n'
indent|'                '
name|'direct_head'
op|'.'
name|'side_effect'
op|'='
name|'stub_resp_headers'
newline|'\n'
name|'oldest_spi'
op|'='
name|'reconciler'
op|'.'
name|'direct_get_container_policy_index'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'con'"
op|')'
newline|'\n'
comment|'# expired'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'oldest_spi'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_direct_delete_container_entry
dedent|''
name|'def'
name|'test_direct_delete_container_entry'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_path'
op|'='
string|"'swift.common.direct_client.http_connect'"
newline|'\n'
name|'connect_args'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
DECL|function|test_connect
name|'def'
name|'test_connect'
op|'('
name|'ipaddr'
op|','
name|'port'
op|','
name|'device'
op|','
name|'partition'
op|','
name|'method'
op|','
name|'path'
op|','
nl|'\n'
name|'headers'
op|'='
name|'None'
op|','
name|'query_string'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'connect_args'
op|'.'
name|'append'
op|'('
op|'{'
nl|'\n'
string|"'ipaddr'"
op|':'
name|'ipaddr'
op|','
string|"'port'"
op|':'
name|'port'
op|','
string|"'device'"
op|':'
name|'device'
op|','
nl|'\n'
string|"'partition'"
op|':'
name|'partition'
op|','
string|"'method'"
op|':'
name|'method'
op|','
string|"'path'"
op|':'
name|'path'
op|','
nl|'\n'
string|"'headers'"
op|':'
name|'headers'
op|','
string|"'query_string'"
op|':'
name|'query_string'
op|'}'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'x_timestamp'
op|'='
name|'Timestamp'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
newline|'\n'
name|'headers'
op|'='
op|'{'
string|"'x-timestamp'"
op|':'
name|'x_timestamp'
op|'.'
name|'internal'
op|'}'
newline|'\n'
name|'fake_hc'
op|'='
name|'fake_http_connect'
op|'('
number|'200'
op|','
number|'200'
op|','
number|'200'
op|','
name|'give_connect'
op|'='
name|'test_connect'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|','
name|'fake_hc'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'reconciler'
op|'.'
name|'direct_delete_container_entry'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|','
name|'headers'
op|'='
name|'headers'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'connect_args'
op|')'
op|','
number|'3'
op|')'
newline|'\n'
name|'for'
name|'args'
name|'in'
name|'connect_args'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'args'
op|'['
string|"'method'"
op|']'
op|','
string|"'DELETE'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'args'
op|'['
string|"'path'"
op|']'
op|','
string|"'/a/c/o'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'args'
op|'['
string|"'headers'"
op|']'
op|'.'
name|'get'
op|'('
string|"'x-timestamp'"
op|')'
op|','
nl|'\n'
name|'headers'
op|'['
string|"'x-timestamp'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_direct_delete_container_entry_with_errors
dedent|''
dedent|''
name|'def'
name|'test_direct_delete_container_entry_with_errors'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# setup mock direct_delete'
nl|'\n'
indent|'        '
name|'mock_path'
op|'='
string|"'swift.container.reconciler.direct_delete_container_object'"
newline|'\n'
name|'stub_resp'
op|'='
op|'['
nl|'\n'
name|'None'
op|','
nl|'\n'
name|'socket'
op|'.'
name|'error'
op|'('
name|'errno'
op|'.'
name|'ECONNREFUSED'
op|','
name|'os'
op|'.'
name|'strerror'
op|'('
name|'errno'
op|'.'
name|'ECONNREFUSED'
op|')'
op|')'
op|','
nl|'\n'
name|'ClientException'
op|'('
nl|'\n'
string|"'Container Server blew up'"
op|','
nl|'\n'
string|"'10.0.0.12'"
op|','
number|'6001'
op|','
string|"'sdj'"
op|','
number|'404'
op|','
string|"'Not Found'"
nl|'\n'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'mock_direct_delete'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'mock_direct_delete'
op|'.'
name|'side_effect'
op|'='
name|'stub_resp'
newline|'\n'
nl|'\n'
name|'with'
name|'contextlib'
op|'.'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|','
name|'mock_direct_delete'
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'eventlet.greenpool.DEBUG'"
op|','
name|'False'
op|')'
op|','
nl|'\n'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'rv'
op|'='
name|'reconciler'
op|'.'
name|'direct_delete_container_entry'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'rv'
op|','
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'mock_direct_delete'
op|'.'
name|'mock_calls'
op|')'
op|','
number|'3'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_to_reconciler_queue
dedent|''
name|'def'
name|'test_add_to_reconciler_queue'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_path'
op|'='
string|"'swift.common.direct_client.http_connect'"
newline|'\n'
name|'connect_args'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
DECL|function|test_connect
name|'def'
name|'test_connect'
op|'('
name|'ipaddr'
op|','
name|'port'
op|','
name|'device'
op|','
name|'partition'
op|','
name|'method'
op|','
name|'path'
op|','
nl|'\n'
name|'headers'
op|'='
name|'None'
op|','
name|'query_string'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'connect_args'
op|'.'
name|'append'
op|'('
op|'{'
nl|'\n'
string|"'ipaddr'"
op|':'
name|'ipaddr'
op|','
string|"'port'"
op|':'
name|'port'
op|','
string|"'device'"
op|':'
name|'device'
op|','
nl|'\n'
string|"'partition'"
op|':'
name|'partition'
op|','
string|"'method'"
op|':'
name|'method'
op|','
string|"'path'"
op|':'
name|'path'
op|','
nl|'\n'
string|"'headers'"
op|':'
name|'headers'
op|','
string|"'query_string'"
op|':'
name|'query_string'
op|'}'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'fake_hc'
op|'='
name|'fake_http_connect'
op|'('
number|'200'
op|','
number|'200'
op|','
number|'200'
op|','
name|'give_connect'
op|'='
name|'test_connect'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|','
name|'fake_hc'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ret'
op|'='
name|'reconciler'
op|'.'
name|'add_to_reconciler_queue'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|','
number|'17'
op|','
number|'5948918.63946'
op|','
string|"'DELETE'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'ret'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'ret'
op|','
name|'str'
op|'('
name|'int'
op|'('
number|'5948918.63946'
op|'//'
number|'3600'
op|'*'
number|'3600'
op|')'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'connect_args'
op|')'
op|','
number|'3'
op|')'
newline|'\n'
name|'connect_args'
op|'.'
name|'sort'
op|'('
name|'key'
op|'='
name|'lambda'
name|'a'
op|':'
op|'('
name|'a'
op|'['
string|"'ipaddr'"
op|']'
op|','
name|'a'
op|'['
string|"'port'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'required_headers'
op|'='
op|'('
string|"'x-content-type'"
op|','
string|"'x-etag'"
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'args'
name|'in'
name|'connect_args'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'args'
op|'['
string|"'headers'"
op|']'
op|'['
string|"'X-Timestamp'"
op|']'
op|','
string|"'5948918.63946'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'args'
op|'['
string|"'path'"
op|']'
op|','
nl|'\n'
string|"'/.misplaced_objects/5947200/17:/a/c/o'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'args'
op|'['
string|"'headers'"
op|']'
op|'['
string|"'X-Content-Type'"
op|']'
op|','
nl|'\n'
string|"'application/x-delete'"
op|')'
newline|'\n'
name|'for'
name|'header'
name|'in'
name|'required_headers'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assert_'
op|'('
name|'header'
name|'in'
name|'args'
op|'['
string|"'headers'"
op|']'
op|','
nl|'\n'
string|"'%r was missing request headers %r'"
op|'%'
op|'('
nl|'\n'
name|'header'
op|','
name|'args'
op|'['
string|"'headers'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_to_reconciler_queue_force
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_add_to_reconciler_queue_force'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_path'
op|'='
string|"'swift.common.direct_client.http_connect'"
newline|'\n'
name|'connect_args'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
DECL|function|test_connect
name|'def'
name|'test_connect'
op|'('
name|'ipaddr'
op|','
name|'port'
op|','
name|'device'
op|','
name|'partition'
op|','
name|'method'
op|','
name|'path'
op|','
nl|'\n'
name|'headers'
op|'='
name|'None'
op|','
name|'query_string'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'connect_args'
op|'.'
name|'append'
op|'('
op|'{'
nl|'\n'
string|"'ipaddr'"
op|':'
name|'ipaddr'
op|','
string|"'port'"
op|':'
name|'port'
op|','
string|"'device'"
op|':'
name|'device'
op|','
nl|'\n'
string|"'partition'"
op|':'
name|'partition'
op|','
string|"'method'"
op|':'
name|'method'
op|','
string|"'path'"
op|':'
name|'path'
op|','
nl|'\n'
string|"'headers'"
op|':'
name|'headers'
op|','
string|"'query_string'"
op|':'
name|'query_string'
op|'}'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'fake_hc'
op|'='
name|'fake_http_connect'
op|'('
number|'200'
op|','
number|'200'
op|','
number|'200'
op|','
name|'give_connect'
op|'='
name|'test_connect'
op|')'
newline|'\n'
name|'now'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'with'
name|'contextlib'
op|'.'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|','
name|'fake_hc'
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.reconciler.time.time'"
op|','
nl|'\n'
name|'lambda'
op|':'
name|'now'
op|')'
op|','
nl|'\n'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ret'
op|'='
name|'reconciler'
op|'.'
name|'add_to_reconciler_queue'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|','
number|'17'
op|','
number|'5948918.63946'
op|','
string|"'PUT'"
op|','
nl|'\n'
name|'force'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'ret'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'ret'
op|','
name|'str'
op|'('
name|'int'
op|'('
number|'5948918.63946'
op|'//'
number|'3600'
op|'*'
number|'3600'
op|')'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'connect_args'
op|')'
op|','
number|'3'
op|')'
newline|'\n'
name|'connect_args'
op|'.'
name|'sort'
op|'('
name|'key'
op|'='
name|'lambda'
name|'a'
op|':'
op|'('
name|'a'
op|'['
string|"'ipaddr'"
op|']'
op|','
name|'a'
op|'['
string|"'port'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'required_headers'
op|'='
op|'('
string|"'x-size'"
op|','
string|"'x-content-type'"
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'args'
name|'in'
name|'connect_args'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'args'
op|'['
string|"'headers'"
op|']'
op|'['
string|"'X-Timestamp'"
op|']'
op|','
nl|'\n'
name|'Timestamp'
op|'('
name|'now'
op|')'
op|'.'
name|'internal'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'args'
op|'['
string|"'headers'"
op|']'
op|'['
string|"'X-Etag'"
op|']'
op|','
string|"'5948918.63946'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'args'
op|'['
string|"'path'"
op|']'
op|','
nl|'\n'
string|"'/.misplaced_objects/5947200/17:/a/c/o'"
op|')'
newline|'\n'
name|'for'
name|'header'
name|'in'
name|'required_headers'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assert_'
op|'('
name|'header'
name|'in'
name|'args'
op|'['
string|"'headers'"
op|']'
op|','
nl|'\n'
string|"'%r was missing request headers %r'"
op|'%'
op|'('
nl|'\n'
name|'header'
op|','
name|'args'
op|'['
string|"'headers'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_to_reconciler_queue_fails
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_add_to_reconciler_queue_fails'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_path'
op|'='
string|"'swift.common.direct_client.http_connect'"
newline|'\n'
nl|'\n'
name|'fake_connects'
op|'='
op|'['
name|'fake_http_connect'
op|'('
number|'200'
op|')'
op|','
nl|'\n'
name|'fake_http_connect'
op|'('
number|'200'
op|','
name|'raise_timeout_exc'
op|'='
name|'True'
op|')'
op|','
nl|'\n'
name|'fake_http_connect'
op|'('
number|'507'
op|')'
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_hc
name|'def'
name|'fake_hc'
op|'('
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'fake_connects'
op|'.'
name|'pop'
op|'('
op|')'
op|'('
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|','
name|'fake_hc'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ret'
op|'='
name|'reconciler'
op|'.'
name|'add_to_reconciler_queue'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|','
number|'17'
op|','
number|'5948918.63946'
op|','
string|"'PUT'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'ret'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_to_reconciler_queue_socket_error
dedent|''
name|'def'
name|'test_add_to_reconciler_queue_socket_error'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_path'
op|'='
string|"'swift.common.direct_client.http_connect'"
newline|'\n'
nl|'\n'
name|'exc'
op|'='
name|'socket'
op|'.'
name|'error'
op|'('
name|'errno'
op|'.'
name|'ECONNREFUSED'
op|','
nl|'\n'
name|'os'
op|'.'
name|'strerror'
op|'('
name|'errno'
op|'.'
name|'ECONNREFUSED'
op|')'
op|')'
newline|'\n'
name|'fake_connects'
op|'='
op|'['
name|'fake_http_connect'
op|'('
number|'200'
op|')'
op|','
nl|'\n'
name|'fake_http_connect'
op|'('
number|'200'
op|','
name|'raise_timeout_exc'
op|'='
name|'True'
op|')'
op|','
nl|'\n'
name|'fake_http_connect'
op|'('
number|'500'
op|','
name|'raise_exc'
op|'='
name|'exc'
op|')'
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_hc
name|'def'
name|'fake_hc'
op|'('
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'fake_connects'
op|'.'
name|'pop'
op|'('
op|')'
op|'('
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'mock_path'
op|','
name|'fake_hc'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ret'
op|'='
name|'reconciler'
op|'.'
name|'add_to_reconciler_queue'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_ring'
op|','
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|','
number|'17'
op|','
number|'5948918.63946'
op|','
string|"'DELETE'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'ret'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|listing_qs
dedent|''
dedent|''
name|'def'
name|'listing_qs'
op|'('
name|'marker'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'return'
string|'"?format=json&marker=%s&end_marker="'
op|'%'
name|'urllib'
op|'.'
name|'quote'
op|'('
name|'marker'
op|'.'
name|'encode'
op|'('
string|"'utf-8'"
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|TestReconciler
dedent|''
name|'class'
name|'TestReconciler'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|variable|maxDiff
indent|'    '
name|'maxDiff'
op|'='
name|'None'
newline|'\n'
nl|'\n'
DECL|member|setUp
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'logger'
op|'='
name|'debug_logger'
op|'('
op|')'
newline|'\n'
name|'conf'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.reconciler.InternalClient'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'reconciler'
op|'='
name|'reconciler'
op|'.'
name|'ContainerReconciler'
op|'('
name|'conf'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'logger'
op|'='
name|'self'
op|'.'
name|'logger'
newline|'\n'
name|'self'
op|'.'
name|'start_interval'
op|'='
name|'int'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'//'
number|'3600'
op|'*'
number|'3600'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'current_container_path'
op|'='
string|"'/v1/.misplaced_objects/%d'"
op|'%'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'start_interval'
op|')'
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
newline|'\n'
nl|'\n'
DECL|member|_mock_listing
dedent|''
name|'def'
name|'_mock_listing'
op|'('
name|'self'
op|','
name|'objects'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'swift'
op|'='
name|'FakeInternalClient'
op|'('
name|'objects'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'='
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'swift'
op|'.'
name|'app'
newline|'\n'
nl|'\n'
DECL|member|_mock_oldest_spi
dedent|''
name|'def'
name|'_mock_oldest_spi'
op|'('
name|'self'
op|','
name|'container_oldest_spi_map'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'_mock_oldest_spi_map'
op|'='
name|'container_oldest_spi_map'
newline|'\n'
nl|'\n'
DECL|member|_run_once
dedent|''
name|'def'
name|'_run_once'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Helper method to run the reconciler once with appropriate direct-client\n        mocks in place.\n\n        Returns the list of direct-deleted container entries in the format\n        [(acc1, con1, obj1), ...]\n        """'
newline|'\n'
nl|'\n'
DECL|function|mock_oldest_spi
name|'def'
name|'mock_oldest_spi'
op|'('
name|'ring'
op|','
name|'account'
op|','
name|'container_name'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'_mock_oldest_spi_map'
op|'.'
name|'get'
op|'('
name|'container_name'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'items'
op|'='
op|'{'
nl|'\n'
string|"'direct_get_container_policy_index'"
op|':'
name|'mock_oldest_spi'
op|','
nl|'\n'
string|"'direct_delete_container_entry'"
op|':'
name|'mock'
op|'.'
name|'DEFAULT'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
name|'mock_time_iter'
op|'='
name|'itertools'
op|'.'
name|'count'
op|'('
name|'self'
op|'.'
name|'start_interval'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'multiple'
op|'('
name|'reconciler'
op|','
op|'**'
name|'items'
op|')'
name|'as'
name|'mocks'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'mock_delete_container_entry'
op|'='
name|'mocks'
op|'['
string|"'direct_delete_container_entry'"
op|']'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'time.time'"
op|','
name|'mock_time_iter'
op|'.'
name|'next'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'return'
op|'['
name|'c'
op|'['
number|'1'
op|']'
op|'['
number|'1'
op|':'
number|'4'
op|']'
name|'for'
name|'c'
name|'in'
nl|'\n'
name|'mocks'
op|'['
string|"'direct_delete_container_entry'"
op|']'
op|'.'
name|'mock_calls'
op|']'
newline|'\n'
nl|'\n'
DECL|member|test_invalid_queue_name
dedent|''
name|'def'
name|'test_invalid_queue_name'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/3600/bogus"'
op|')'
op|':'
number|'3618.84187'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
comment|'# we try to find something useful'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'3600'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'bogus'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# but only get the bogus record'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'invalid_record'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# and just leave it on the queue'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'deleted_container_entries'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_invalid_queue_name_marches_onward
dedent|''
name|'def'
name|'test_invalid_queue_name_marches_onward'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|"# there's something useful there on the queue"
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/3600/00000bogus"'
op|')'
op|':'
number|'3600.0000'
op|','
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/3600/1:/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3618.84187'
op|','
nl|'\n'
op|'('
number|'1'
op|','
string|'"/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3618.84187'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'1'
op|'}'
op|')'
comment|'# already in the right spot!'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
comment|'# we get all the queue entries we can'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'3600'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# and one is garbage'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'invalid_record'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# but the other is workable'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'noop_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# so pop the queue for that one'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
nl|'\n'
op|'['
op|'('
string|"'.misplaced_objects'"
op|','
string|"'3600'"
op|','
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_queue_name_with_policy_index_delimiter_in_name
dedent|''
name|'def'
name|'test_queue_name_with_policy_index_delimiter_in_name'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'q_path'
op|'='
string|"'.misplaced_objects/3600'"
newline|'\n'
name|'obj_path'
op|'='
string|'"AUTH_bob/c:sneaky/o1:sneaky"'
newline|'\n'
comment|"# there's something useful there on the queue"
nl|'\n'
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/%s/1:/%s"'
op|'%'
op|'('
name|'q_path'
op|','
name|'obj_path'
op|')'
op|')'
op|':'
number|'3618.84187'
op|','
nl|'\n'
op|'('
number|'1'
op|','
string|"'/%s'"
op|'%'
name|'obj_path'
op|')'
op|':'
number|'3618.84187'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
comment|'# we find the misplaced object'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'misplaced_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'3600'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/%s'"
op|'%'
name|'obj_path'
op|')'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# move it'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/%s'"
op|'%'
name|'obj_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'DELETE'"
op|','
string|"'/v1/%s'"
op|'%'
name|'obj_path'
op|')'
op|']'
op|')'
newline|'\n'
name|'delete_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/%s'"
op|'%'
name|'obj_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'PUT'"
op|','
string|"'/v1/%s'"
op|'%'
name|'obj_path'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# clean up the source'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# we DELETE the object from the wrong place with source_ts + offset 1'
nl|'\n'
comment|'# timestamp to make sure the change takes effect'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'delete_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'3618.84187'
op|','
name|'offset'
op|'='
number|'1'
op|')'
op|'.'
name|'internal'
op|')'
newline|'\n'
comment|'# and pop the queue for that one'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
op|'['
op|'('
nl|'\n'
string|"'.misplaced_objects'"
op|','
string|"'3600'"
op|','
string|"'1:/%s'"
op|'%'
name|'obj_path'
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_unable_to_direct_get_oldest_storage_policy
dedent|''
name|'def'
name|'test_unable_to_direct_get_oldest_storage_policy'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/3600/1:/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3618.84187'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
comment|'# the reconciler gets "None" if we can\'t quorum the container'
nl|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
name|'None'
op|'}'
op|')'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
comment|'# we look for misplaced objects'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'3600'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
comment|"# but can't really say where to go looking"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'unavailable_container'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|"# we don't clean up anything"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_object'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
comment|'# and we definately should not pop_queue'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'deleted_container_entries'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'retry'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_move
dedent|''
name|'def'
name|'test_object_move'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/3600/1:/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3618.84187'
op|','
nl|'\n'
op|'('
number|'1'
op|','
string|'"/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3618.84187'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# found a misplaced object'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'misplaced_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'3600'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# moves it'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|','
nl|'\n'
op|'('
string|"'DELETE'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
name|'delete_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|','
nl|'\n'
op|'('
string|"'PUT'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
name|'put_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
comment|'# we PUT the object in the right place with q_ts + offset 2'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'put_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'3618.84187'
op|','
name|'offset'
op|'='
number|'2'
op|')'
op|')'
newline|'\n'
comment|'# cleans up the old'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# we DELETE the object from the wrong place with source_ts + offset 1'
nl|'\n'
comment|'# timestamp to make sure the change takes effect'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'delete_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'3618.84187'
op|','
name|'offset'
op|'='
number|'1'
op|')'
op|')'
newline|'\n'
comment|"# and when we're done, we pop the entry from the queue"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
nl|'\n'
op|'['
op|'('
string|"'.misplaced_objects'"
op|','
string|"'3600'"
op|','
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_move_the_other_direction
dedent|''
name|'def'
name|'test_object_move_the_other_direction'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/3600/0:/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3618.84187'
op|','
nl|'\n'
op|'('
number|'0'
op|','
string|'"/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3618.84187'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# found a misplaced object'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'misplaced_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'3600'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'0:/AUTH_bob/c/o1'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# moves it'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|','
comment|'# 2'
nl|'\n'
op|'('
string|"'DELETE'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
comment|'# 4'
newline|'\n'
name|'delete_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|','
comment|'# 1'
nl|'\n'
op|'('
string|"'PUT'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
comment|'# 3'
newline|'\n'
name|'put_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
comment|'# we PUT the object in the right place with q_ts + offset 2'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'put_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'3618.84187'
op|','
name|'offset'
op|'='
number|'2'
op|')'
op|'.'
name|'internal'
op|')'
newline|'\n'
comment|'# cleans up the old'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# we DELETE the object from the wrong place with source_ts + offset 1'
nl|'\n'
comment|'# timestamp to make sure the change takes effect'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'delete_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'3618.84187'
op|','
name|'offset'
op|'='
number|'1'
op|')'
op|'.'
name|'internal'
op|')'
newline|'\n'
comment|"# and when we're done, we pop the entry from the queue"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
nl|'\n'
op|'['
op|'('
string|"'.misplaced_objects'"
op|','
string|"'3600'"
op|','
string|"'0:/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_move_with_unicode_and_spaces
dedent|''
name|'def'
name|'test_object_move_with_unicode_and_spaces'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# the "name" in listings and the unicode string passed to all'
nl|'\n'
comment|'# functions where we call them with (account, container, obj)'
nl|'\n'
indent|'        '
name|'obj_name'
op|'='
string|'u"AUTH_bob/c \\u062a/o1 \\u062a"'
newline|'\n'
comment|'# anytime we talk about a call made to swift for a path'
nl|'\n'
name|'obj_path'
op|'='
name|'obj_name'
op|'.'
name|'encode'
op|'('
string|"'utf-8'"
op|')'
newline|'\n'
comment|'# this mock expects unquoted unicode because it handles container'
nl|'\n'
comment|'# listings as well as paths'
nl|'\n'
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/3600/1:/%s"'
op|'%'
name|'obj_name'
op|')'
op|':'
number|'3618.84187'
op|','
nl|'\n'
op|'('
number|'1'
op|','
string|'"/%s"'
op|'%'
name|'obj_name'
op|')'
op|':'
number|'3618.84187'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# found a misplaced object'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'misplaced_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# listing_qs encodes and quotes - so give it name'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'3600'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/%s'"
op|'%'
name|'obj_name'
op|')'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# moves it'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# these calls are to the real path'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/%s'"
op|'%'
name|'obj_path'
op|')'
op|','
comment|'# 2'
nl|'\n'
op|'('
string|"'DELETE'"
op|','
string|"'/v1/%s'"
op|'%'
name|'obj_path'
op|')'
op|']'
op|')'
comment|'# 4'
newline|'\n'
name|'delete_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/%s'"
op|'%'
name|'obj_path'
op|')'
op|','
comment|'# 1'
nl|'\n'
op|'('
string|"'PUT'"
op|','
string|"'/v1/%s'"
op|'%'
name|'obj_path'
op|')'
op|']'
op|')'
comment|'# 3'
newline|'\n'
name|'put_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
comment|'# we PUT the object in the right place with q_ts + offset 2'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'put_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'3618.84187'
op|','
name|'offset'
op|'='
number|'2'
op|')'
op|'.'
name|'internal'
op|')'
newline|'\n'
comment|'# cleans up the old'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# we DELETE the object from the wrong place with source_ts + offset 1'
nl|'\n'
comment|'# timestamp to make sure the change takes effect'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'delete_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'3618.84187'
op|','
name|'offset'
op|'='
number|'1'
op|')'
op|'.'
name|'internal'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'delete_headers'
op|'.'
name|'get'
op|'('
string|"'X-Backend-Storage-Policy-Index'"
op|')'
op|','
string|"'1'"
op|')'
newline|'\n'
comment|"# and when we're done, we pop the entry from the queue"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|"# this mock recieved the name, it's encoded down in buffered_http"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
nl|'\n'
op|'['
op|'('
string|"'.misplaced_objects'"
op|','
string|"'3600'"
op|','
string|"'1:/%s'"
op|'%'
name|'obj_name'
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_delete
dedent|''
name|'def'
name|'test_object_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'q_ts'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/3600/1:/AUTH_bob/c/o1"'
op|')'
op|':'
op|'('
nl|'\n'
name|'Timestamp'
op|'('
name|'q_ts'
op|')'
op|'.'
name|'internal'
op|','
string|"'application/x-delete'"
op|')'
op|','
nl|'\n'
comment|'# object exists in "correct" storage policy - slightly older'
nl|'\n'
op|'('
number|'0'
op|','
string|'"/AUTH_bob/c/o1"'
op|')'
op|':'
name|'Timestamp'
op|'('
name|'q_ts'
op|'-'
number|'1'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
comment|'# the tombstone exists in the enqueued storage policy'
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'register'
op|'('
nl|'\n'
string|"'GET'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|','
name|'swob'
op|'.'
name|'HTTPNotFound'
op|','
nl|'\n'
op|'{'
string|"'X-Backend-Timestamp'"
op|':'
name|'Timestamp'
op|'('
name|'q_ts'
op|')'
op|'.'
name|'internal'
op|'}'
op|')'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# found a misplaced object'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'misplaced_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'3600'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# delete it'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'delete_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'delete_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|','
nl|'\n'
op|'('
string|"'DELETE'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
name|'delete_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|','
nl|'\n'
op|'('
string|"'DELETE'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
name|'reconcile_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
comment|'# we DELETE the object in the right place with q_ts + offset 2'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'reconcile_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
name|'q_ts'
op|','
name|'offset'
op|'='
number|'2'
op|')'
op|'.'
name|'internal'
op|')'
newline|'\n'
comment|'# cleans up the old'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# we DELETE the object from the wrong place with source_ts + offset 1'
nl|'\n'
comment|'# timestamp to make sure the change takes effect'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'delete_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
name|'q_ts'
op|','
name|'offset'
op|'='
number|'1'
op|')'
op|')'
newline|'\n'
comment|"# and when we're done, we pop the entry from the queue"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
nl|'\n'
op|'['
op|'('
string|"'.misplaced_objects'"
op|','
string|"'3600'"
op|','
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_enqueued_for_the_correct_dest_noop
dedent|''
name|'def'
name|'test_object_enqueued_for_the_correct_dest_noop'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/3600/1:/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3618.84187'
op|','
nl|'\n'
op|'('
number|'1'
op|','
string|'"/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3618.84187'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'1'
op|'}'
op|')'
comment|'# already in the right spot!'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# nothing to see here'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'noop_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'3600'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# so we just pop the queue'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
nl|'\n'
op|'['
op|'('
string|"'.misplaced_objects'"
op|','
string|"'3600'"
op|','
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_move_src_object_newer_than_queue_entry
dedent|''
name|'def'
name|'test_object_move_src_object_newer_than_queue_entry'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# setup the cluster'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/3600/1:/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3600.123456'
op|','
nl|'\n'
op|'('
number|'1'
op|','
string|"'/AUTH_bob/c/o1'"
op|')'
op|':'
number|'3600.234567'
op|','
comment|'# slightly newer'
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
comment|'# destination'
newline|'\n'
comment|'# turn the crank'
nl|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# found a misplaced object'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'misplaced_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'3600'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# proceed with the move'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|','
comment|'# 2'
nl|'\n'
op|'('
string|"'DELETE'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
comment|'# 4'
newline|'\n'
name|'delete_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|','
comment|'# 1'
nl|'\n'
op|'('
string|"'PUT'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
comment|'# 3'
newline|'\n'
comment|'# .. with source timestamp + offset 2'
nl|'\n'
name|'put_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'put_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'3600.234567'
op|','
name|'offset'
op|'='
number|'2'
op|')'
op|')'
newline|'\n'
comment|'# src object is cleaned up'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# ... with q_ts + offset 1'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'delete_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'3600.123456'
op|','
name|'offset'
op|'='
number|'1'
op|')'
op|')'
newline|'\n'
comment|'# and queue is popped'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
nl|'\n'
op|'['
op|'('
string|"'.misplaced_objects'"
op|','
string|"'3600'"
op|','
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_move_src_object_older_than_queue_entry
dedent|''
name|'def'
name|'test_object_move_src_object_older_than_queue_entry'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# should be some sort of retry case'
nl|'\n'
indent|'        '
name|'q_ts'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'container'
op|'='
name|'str'
op|'('
name|'int'
op|'('
name|'q_ts'
op|'//'
number|'3600'
op|'*'
number|'3600'
op|')'
op|')'
newline|'\n'
name|'q_path'
op|'='
string|"'.misplaced_objects/%s'"
op|'%'
name|'container'
newline|'\n'
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/%s/1:/AUTH_bob/c/o1"'
op|'%'
name|'q_path'
op|')'
op|':'
name|'q_ts'
op|','
nl|'\n'
op|'('
number|'1'
op|','
string|"'/AUTH_bob/c/o1'"
op|')'
op|':'
name|'q_ts'
op|'-'
number|'0.00001'
op|','
comment|'# slightly older'
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# found a misplaced object'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'misplaced_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/%s'"
op|'%'
name|'q_path'
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/%s'"
op|'%'
name|'q_path'
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
name|'container'
op|')'
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
comment|'# but no object copy is attempted'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'unavailable_source'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_attempt'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
comment|'# src object is un-modified'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_attempt'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
comment|"# queue is un-changed, we'll have to retry"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'retry'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_src_object_unavailable_with_slightly_newer_tombstone
dedent|''
name|'def'
name|'test_src_object_unavailable_with_slightly_newer_tombstone'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# should be some sort of retry case'
nl|'\n'
indent|'        '
name|'q_ts'
op|'='
name|'float'
op|'('
name|'Timestamp'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'container'
op|'='
name|'str'
op|'('
name|'int'
op|'('
name|'q_ts'
op|'//'
number|'3600'
op|'*'
number|'3600'
op|')'
op|')'
newline|'\n'
name|'q_path'
op|'='
string|"'.misplaced_objects/%s'"
op|'%'
name|'container'
newline|'\n'
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/%s/1:/AUTH_bob/c/o1"'
op|'%'
name|'q_path'
op|')'
op|':'
name|'q_ts'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'register'
op|'('
nl|'\n'
string|"'GET'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|','
name|'swob'
op|'.'
name|'HTTPNotFound'
op|','
nl|'\n'
op|'{'
string|"'X-Backend-Timestamp'"
op|':'
name|'Timestamp'
op|'('
name|'q_ts'
op|','
name|'offset'
op|'='
number|'2'
op|')'
op|'.'
name|'internal'
op|'}'
op|')'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# found a misplaced object'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'misplaced_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/%s'"
op|'%'
name|'q_path'
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/%s'"
op|'%'
name|'q_path'
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
name|'container'
op|')'
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
comment|'# but no object copy is attempted'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'unavailable_source'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_attempt'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
comment|'# src object is un-modified'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_attempt'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
comment|"# queue is un-changed, we'll have to retry"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'retry'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_src_object_unavailable_server_error
dedent|''
name|'def'
name|'test_src_object_unavailable_server_error'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# should be some sort of retry case'
nl|'\n'
indent|'        '
name|'q_ts'
op|'='
name|'float'
op|'('
name|'Timestamp'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'container'
op|'='
name|'str'
op|'('
name|'int'
op|'('
name|'q_ts'
op|'//'
number|'3600'
op|'*'
number|'3600'
op|')'
op|')'
newline|'\n'
name|'q_path'
op|'='
string|"'.misplaced_objects/%s'"
op|'%'
name|'container'
newline|'\n'
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/%s/1:/AUTH_bob/c/o1"'
op|'%'
name|'q_path'
op|')'
op|':'
name|'q_ts'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'register'
op|'('
nl|'\n'
string|"'GET'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|','
name|'swob'
op|'.'
name|'HTTPServiceUnavailable'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# found a misplaced object'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'misplaced_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/%s'"
op|'%'
name|'q_path'
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/%s'"
op|'%'
name|'q_path'
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
name|'container'
op|')'
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
comment|'# but no object copy is attempted'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'unavailable_source'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_attempt'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
comment|'# src object is un-modified'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_attempt'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
comment|"# queue is un-changed, we'll have to retry"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'retry'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_move_fails_cleanup
dedent|''
name|'def'
name|'test_object_move_fails_cleanup'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# setup the cluster'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/3600/1:/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3600.123456'
op|','
nl|'\n'
op|'('
number|'1'
op|','
string|"'/AUTH_bob/c/o1'"
op|')'
op|':'
number|'3600.123457'
op|','
comment|'# slightly newer'
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
comment|'# destination'
newline|'\n'
nl|'\n'
comment|'# make the DELETE blow up'
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'register'
op|'('
nl|'\n'
string|"'DELETE'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|','
name|'swob'
op|'.'
name|'HTTPServiceUnavailable'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
comment|'# turn the crank'
nl|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# found a misplaced object'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'misplaced_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'3600'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# proceed with the move'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|','
comment|'# 2'
nl|'\n'
op|'('
string|"'DELETE'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
comment|'# 4'
newline|'\n'
name|'delete_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|','
comment|'# 1'
nl|'\n'
op|'('
string|"'PUT'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
comment|'# 3'
newline|'\n'
comment|'# .. with source timestamp + offset 2'
nl|'\n'
name|'put_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'put_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'3600.123457'
op|','
name|'offset'
op|'='
number|'2'
op|')'
op|')'
newline|'\n'
comment|'# we try to cleanup'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# ... with q_ts + offset 1'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'delete_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'3600.12346'
op|','
name|'offset'
op|'='
number|'1'
op|')'
op|')'
newline|'\n'
comment|'# but cleanup fails!'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_failed'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# so the queue is not popped'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
op|'['
op|']'
op|')'
newline|'\n'
comment|"# and we'll have to retry"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'retry'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_move_src_object_is_forever_gone
dedent|''
name|'def'
name|'test_object_move_src_object_is_forever_gone'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# oh boy, hate to be here - this is an oldy'
nl|'\n'
indent|'        '
name|'q_ts'
op|'='
name|'self'
op|'.'
name|'start_interval'
op|'-'
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'reclaim_age'
op|'-'
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/3600/1:/AUTH_bob/c/o1"'
op|')'
op|':'
name|'q_ts'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# found a misplaced object'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'misplaced_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'3600'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
comment|"# but it's gone :\\"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'lost_source'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
comment|"# gah, look, even if it was out there somewhere - we've been at this"
nl|'\n'
comment|"# two weeks and haven't found it.  We can't just keep looking forever,"
nl|'\n'
comment|"# so... we're done"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
nl|'\n'
op|'['
op|'('
string|"'.misplaced_objects'"
op|','
string|"'3600'"
op|','
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
comment|"# dunno if this is helpful, but FWIW we don't throw tombstones?"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_attempt'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'success'"
op|']'
op|','
number|'1'
op|')'
comment|'# lol'
newline|'\n'
nl|'\n'
DECL|member|test_object_move_dest_already_moved
dedent|''
name|'def'
name|'test_object_move_dest_already_moved'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/3600/1:/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3679.2019'
op|','
nl|'\n'
op|'('
number|'1'
op|','
string|'"/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3679.2019'
op|','
nl|'\n'
op|'('
number|'0'
op|','
string|'"/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3679.2019'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# we look for misplaced objects'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'3600'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# but we found it already in the right place!'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'found_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
comment|'# so no attempt to read the source is made, but we do cleanup'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'DELETE'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
name|'delete_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'headers'
op|'['
number|'0'
op|']'
newline|'\n'
comment|'# rather we just clean up the dark matter'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'delete_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'3679.2019'
op|','
name|'offset'
op|'='
number|'1'
op|')'
op|')'
newline|'\n'
comment|'# and wipe our hands of it'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
nl|'\n'
op|'['
op|'('
string|"'.misplaced_objects'"
op|','
string|"'3600'"
op|','
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_move_dest_object_newer_than_queue_entry
dedent|''
name|'def'
name|'test_object_move_dest_object_newer_than_queue_entry'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/3600/1:/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3679.2019'
op|','
nl|'\n'
op|'('
number|'1'
op|','
string|'"/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3679.2019'
op|','
nl|'\n'
op|'('
number|'0'
op|','
string|'"/AUTH_bob/c/o1"'
op|')'
op|':'
number|'3679.2019'
op|'+'
number|'0.00001'
op|','
comment|'# slightly newer'
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# we look for misplaced objects...'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'3600'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/3600'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# but we found it already in the right place!'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'found_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
comment|'# so not attempt to read is made, but we do cleanup'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_attempt'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'DELETE'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
name|'delete_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'headers'
op|'['
number|'0'
op|']'
newline|'\n'
comment|'# rather we just clean up the dark matter'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'delete_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'3679.2019'
op|','
name|'offset'
op|'='
number|'1'
op|')'
op|')'
newline|'\n'
comment|'# and since we cleaned up the old object, so this counts as done'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
nl|'\n'
op|'['
op|'('
string|"'.misplaced_objects'"
op|','
string|"'3600'"
op|','
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_move_dest_object_older_than_queue_entry
dedent|''
name|'def'
name|'test_object_move_dest_object_older_than_queue_entry'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/36000/1:/AUTH_bob/c/o1"'
op|')'
op|':'
number|'36123.38393'
op|','
nl|'\n'
op|'('
number|'1'
op|','
string|'"/AUTH_bob/c/o1"'
op|')'
op|':'
number|'36123.38393'
op|','
nl|'\n'
op|'('
number|'0'
op|','
string|'"/AUTH_bob/c/o1"'
op|')'
op|':'
number|'36123.38393'
op|'-'
number|'0.00001'
op|','
comment|'# slightly older'
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# we found a misplaced object'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'misplaced_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'36000'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/36000'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/36000'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# and since our version is *newer*, we overwrite'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|','
comment|'# 2'
nl|'\n'
op|'('
string|"'DELETE'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
comment|'# 4'
newline|'\n'
name|'delete_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|','
comment|'# 1'
nl|'\n'
op|'('
string|"'PUT'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
comment|'# 3'
newline|'\n'
comment|'# ... with a q_ts + offset 2'
nl|'\n'
name|'put_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'put_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'36123.38393'
op|','
name|'offset'
op|'='
number|'2'
op|')'
op|')'
newline|'\n'
comment|'# then clean the dark matter'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# ... with a q_ts + offset 1'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'delete_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'36123.38393'
op|','
name|'offset'
op|'='
number|'1'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# and pop the queue'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
nl|'\n'
op|'['
op|'('
string|"'.misplaced_objects'"
op|','
string|"'36000'"
op|','
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'success'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_move_put_fails
dedent|''
name|'def'
name|'test_object_move_put_fails'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# setup the cluster'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/36000/1:/AUTH_bob/c/o1"'
op|')'
op|':'
number|'36123.383925'
op|','
nl|'\n'
op|'('
number|'1'
op|','
string|'"/AUTH_bob/c/o1"'
op|')'
op|':'
number|'36123.383925'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# make the put to dest fail!'
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'register'
op|'('
nl|'\n'
string|"'PUT'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|','
name|'swob'
op|'.'
name|'HTTPServiceUnavailable'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# turn the crank'
nl|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# we find a misplaced object'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'misplaced_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'36000'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/36000'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/36000'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# and try to move it, but it fails'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
comment|'# 2'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|','
comment|'# 1'
nl|'\n'
op|'('
string|"'PUT'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
comment|'# 3'
newline|'\n'
name|'put_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
comment|'# ...with q_ts + offset 2 (20-microseconds)'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'put_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'36123.383925'
op|','
name|'offset'
op|'='
number|'2'
op|')'
op|')'
newline|'\n'
comment|'# but it failed'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_success'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_failed'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|"# ... so we don't clean up the source"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_attempt'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
comment|"# and we don't pop the queue"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'unhandled_errors'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'retry'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_move_put_blows_up_crazy_town
dedent|''
name|'def'
name|'test_object_move_put_blows_up_crazy_town'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# setup the cluster'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/36000/1:/AUTH_bob/c/o1"'
op|')'
op|':'
number|'36123.383925'
op|','
nl|'\n'
op|'('
number|'1'
op|','
string|'"/AUTH_bob/c/o1"'
op|')'
op|':'
number|'36123.383925'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# make the put to dest blow up crazy town'
nl|'\n'
DECL|function|blow_up
name|'def'
name|'blow_up'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'Exception'
op|'('
string|"'kaboom!'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'register'
op|'('
nl|'\n'
string|"'PUT'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|','
name|'blow_up'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# turn the crank'
nl|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# we find a misplaced object'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'misplaced_object'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"'36000'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/36000'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/36000'"
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_bob/c/o1'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
comment|'# and attempt to move it'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'copy_attempt'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
comment|'# 2'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|','
comment|'# 1'
nl|'\n'
op|'('
string|"'PUT'"
op|','
string|"'/v1/AUTH_bob/c/o1'"
op|')'
op|']'
op|')'
comment|'# 3'
newline|'\n'
name|'put_headers'
op|'='
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'headers'
op|'['
number|'1'
op|']'
newline|'\n'
comment|'# ...with q_ts + offset 2 (20-microseconds)'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'put_headers'
op|'.'
name|'get'
op|'('
string|"'X-Timestamp'"
op|')'
op|','
nl|'\n'
name|'Timestamp'
op|'('
number|'36123.383925'
op|','
name|'offset'
op|'='
number|'2'
op|')'
op|')'
newline|'\n'
comment|'# but it blows up hard'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'unhandled_error'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|"# so we don't cleanup"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'cleanup_attempt'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
comment|"# and we don't pop the queue"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'pop_queue'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'retry'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_move_no_such_object_no_tombstone_recent
dedent|''
name|'def'
name|'test_object_move_no_such_object_no_tombstone_recent'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'q_ts'
op|'='
name|'float'
op|'('
name|'Timestamp'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'container'
op|'='
name|'str'
op|'('
name|'int'
op|'('
name|'q_ts'
op|'//'
number|'3600'
op|'*'
number|'3600'
op|')'
op|')'
newline|'\n'
name|'q_path'
op|'='
string|"'.misplaced_objects/%s'"
op|'%'
name|'container'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/%s/1:/AUTH_jeb/c/o1"'
op|'%'
name|'q_path'
op|')'
op|':'
name|'q_ts'
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/%s'"
op|'%'
name|'container'
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/%s'"
op|'%'
name|'container'
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_jeb/c/o1'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
name|'container'
op|')'
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/AUTH_jeb/c/o1'"
op|')'
op|']'
op|','
nl|'\n'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/AUTH_jeb/c/o1'"
op|')'
op|']'
op|','
nl|'\n'
op|')'
newline|'\n'
comment|'# the queue entry is recent enough that there could easily be'
nl|'\n'
comment|"# tombstones on offline nodes or something, so we'll just leave it"
nl|'\n'
comment|'# here and try again later'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_move_no_such_object_no_tombstone_ancient
dedent|''
name|'def'
name|'test_object_move_no_such_object_no_tombstone_ancient'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'queue_ts'
op|'='
name|'float'
op|'('
name|'Timestamp'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
op|'-'
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'reclaim_age'
op|'*'
number|'1.1'
newline|'\n'
name|'container'
op|'='
name|'str'
op|'('
name|'int'
op|'('
name|'queue_ts'
op|'//'
number|'3600'
op|'*'
number|'3600'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
nl|'\n'
name|'None'
op|','
string|'"/.misplaced_objects/%s/1:/AUTH_jeb/c/o1"'
op|'%'
name|'container'
nl|'\n'
op|')'
op|':'
name|'queue_ts'
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_oldest_spi'
op|'('
op|'{'
string|"'c'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
name|'container'
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/%s'"
op|'%'
name|'container'
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/%s'"
op|'%'
name|'container'
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'1:/AUTH_jeb/c/o1'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'0'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'HEAD'"
op|','
string|"'/v1/AUTH_jeb/c/o1'"
op|')'
op|']'
op|','
nl|'\n'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
number|'1'
op|']'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
string|"'/v1/AUTH_jeb/c/o1'"
op|')'
op|']'
op|','
nl|'\n'
op|')'
newline|'\n'
nl|'\n'
comment|'# the queue entry is old enough that the tombstones, if any, have'
nl|'\n'
comment|"# probably been reaped, so we'll just give up"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'deleted_container_entries'
op|','
nl|'\n'
op|'['
op|'('
string|"'.misplaced_objects'"
op|','
name|'container'
op|','
string|"'1:/AUTH_jeb/c/o1'"
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_delete_old_empty_queue_containers
dedent|''
name|'def'
name|'test_delete_old_empty_queue_containers'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ts'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'-'
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'reclaim_age'
op|'*'
number|'1.1'
newline|'\n'
name|'container'
op|'='
name|'str'
op|'('
name|'int'
op|'('
name|'ts'
op|'//'
number|'3600'
op|'*'
number|'3600'
op|')'
op|')'
newline|'\n'
name|'older_ts'
op|'='
name|'ts'
op|'-'
number|'3600'
newline|'\n'
name|'older_container'
op|'='
name|'str'
op|'('
name|'int'
op|'('
name|'older_ts'
op|'//'
number|'3600'
op|'*'
number|'3600'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/%s/"'
op|'%'
name|'container'
op|')'
op|':'
number|'0'
op|','
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/%s/something"'
op|'%'
name|'older_container'
op|')'
op|':'
number|'0'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
name|'container'
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/%s'"
op|'%'
name|'container'
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'DELETE'"
op|','
string|"'/v1/.misplaced_objects/%s'"
op|'%'
name|'container'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/%s'"
op|'%'
name|'older_container'
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/%s'"
op|'%'
name|'older_container'
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"'something'"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|'['
string|"'invalid_record'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_iter_over_old_containers_in_reverse
dedent|''
name|'def'
name|'test_iter_over_old_containers_in_reverse'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'step'
op|'='
name|'reconciler'
op|'.'
name|'MISPLACED_OBJECTS_CONTAINER_DIVISOR'
newline|'\n'
name|'now'
op|'='
name|'self'
op|'.'
name|'start_interval'
newline|'\n'
name|'containers'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
number|'10'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'container_ts'
op|'='
name|'int'
op|'('
name|'now'
op|'-'
name|'step'
op|'*'
name|'i'
op|')'
newline|'\n'
name|'container_name'
op|'='
name|'str'
op|'('
name|'container_ts'
op|'//'
number|'3600'
op|'*'
number|'3600'
op|')'
newline|'\n'
name|'containers'
op|'.'
name|'append'
op|'('
name|'container_name'
op|')'
newline|'\n'
comment|'# add some old containers too'
nl|'\n'
dedent|''
name|'now'
op|'-='
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'reclaim_age'
newline|'\n'
name|'old_containers'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
number|'10'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'container_ts'
op|'='
name|'int'
op|'('
name|'now'
op|'-'
name|'step'
op|'*'
name|'i'
op|')'
newline|'\n'
name|'container_name'
op|'='
name|'str'
op|'('
name|'container_ts'
op|'//'
number|'3600'
op|'*'
number|'3600'
op|')'
newline|'\n'
name|'old_containers'
op|'.'
name|'append'
op|'('
name|'container_name'
op|')'
newline|'\n'
dedent|''
name|'containers'
op|'.'
name|'sort'
op|'('
op|')'
newline|'\n'
name|'old_containers'
op|'.'
name|'sort'
op|'('
op|')'
newline|'\n'
name|'all_containers'
op|'='
name|'old_containers'
op|'+'
name|'containers'
newline|'\n'
name|'self'
op|'.'
name|'_mock_listing'
op|'('
name|'dict'
op|'('
op|'('
nl|'\n'
op|'('
name|'None'
op|','
string|'"/.misplaced_objects/%s/"'
op|'%'
name|'container'
op|')'
op|','
number|'0'
nl|'\n'
op|')'
name|'for'
name|'container'
name|'in'
name|'all_containers'
op|')'
op|')'
newline|'\n'
name|'deleted_container_entries'
op|'='
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'deleted_container_entries'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'last_container'
op|'='
name|'all_containers'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
name|'account_listing_calls'
op|'='
op|'['
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
name|'last_container'
op|')'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'new_container_calls'
op|'='
op|'['
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/%s'"
op|'%'
name|'container'
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
name|'for'
name|'container'
name|'in'
name|'reversed'
op|'('
name|'containers'
op|')'
nl|'\n'
op|']'
op|'['
number|'1'
op|':'
op|']'
comment|"# current_container get's skipped the second time around..."
newline|'\n'
name|'old_container_listings'
op|'='
op|'['
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects/%s'"
op|'%'
name|'container'
op|'+'
nl|'\n'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
name|'for'
name|'container'
name|'in'
name|'reversed'
op|'('
name|'old_containers'
op|')'
nl|'\n'
op|']'
newline|'\n'
name|'old_container_deletes'
op|'='
op|'['
nl|'\n'
op|'('
string|"'DELETE'"
op|','
string|"'/v1/.misplaced_objects/%s'"
op|'%'
name|'container'
op|')'
nl|'\n'
name|'for'
name|'container'
name|'in'
name|'reversed'
op|'('
name|'old_containers'
op|')'
nl|'\n'
op|']'
newline|'\n'
name|'old_container_calls'
op|'='
name|'list'
op|'('
name|'itertools'
op|'.'
name|'chain'
op|'('
op|'*'
name|'zip'
op|'('
nl|'\n'
name|'old_container_listings'
op|','
name|'old_container_deletes'
op|')'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|']'
op|'+'
nl|'\n'
name|'account_listing_calls'
op|'+'
name|'new_container_calls'
op|'+'
nl|'\n'
name|'old_container_calls'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_error_in_iter_containers
dedent|''
name|'def'
name|'test_error_in_iter_containers'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# make the listing return an error'
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
name|'None'
op|']'
op|'.'
name|'register'
op|'('
nl|'\n'
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|','
nl|'\n'
name|'swob'
op|'.'
name|'HTTPServiceUnavailable'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
name|'errors'
op|'='
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'logger'
op|'.'
name|'get_lines_for_level'
op|'('
string|"'error'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'errors'
op|','
op|'['
nl|'\n'
string|"'Error listing containers in account '"
nl|'\n'
string|"'.misplaced_objects (Unexpected response: '"
nl|'\n'
string|"'503 Service Unavailable)'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_unhandled_exception_in_reconcile
dedent|''
name|'def'
name|'test_unhandled_exception_in_reconcile'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_mock_listing'
op|'('
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# make the listing blow up'
nl|'\n'
DECL|function|blow_up
name|'def'
name|'blow_up'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'Exception'
op|'('
string|"'kaboom!'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'storage_policy'
op|'['
name|'None'
op|']'
op|'.'
name|'register'
op|'('
nl|'\n'
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|','
nl|'\n'
name|'blow_up'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_run_once'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'fake_swift'
op|'.'
name|'calls'
op|','
nl|'\n'
op|'['
op|'('
string|"'GET'"
op|','
name|'self'
op|'.'
name|'current_container_path'
op|')'
op|','
nl|'\n'
op|'('
string|"'GET'"
op|','
string|"'/v1/.misplaced_objects'"
op|'+'
name|'listing_qs'
op|'('
string|"''"
op|')'
op|')'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'stats'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
name|'errors'
op|'='
name|'self'
op|'.'
name|'reconciler'
op|'.'
name|'logger'
op|'.'
name|'get_lines_for_level'
op|'('
string|"'error'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'errors'
op|','
nl|'\n'
op|'['
string|"'Unhandled Exception trying to reconcile: '"
op|']'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'__name__'
op|'=='
string|"'__main__'"
op|':'
newline|'\n'
indent|'    '
name|'unittest'
op|'.'
name|'main'
op|'('
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit

begin_unit
comment|'# Copyright (c) 2010-2012 OpenStack Foundation'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'json'
newline|'\n'
name|'from'
name|'time'
name|'import'
name|'time'
newline|'\n'
nl|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'public'
op|','
name|'get_hmac'
op|','
name|'get_swift_info'
op|','
name|'streq_const_time'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'proxy'
op|'.'
name|'controllers'
op|'.'
name|'base'
name|'import'
name|'Controller'
op|','
name|'delay_denial'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'swob'
name|'import'
name|'HTTPOk'
op|','
name|'HTTPForbidden'
op|','
name|'HTTPUnauthorized'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|InfoController
name|'class'
name|'InfoController'
op|'('
name|'Controller'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""WSGI controller for info requests"""'
newline|'\n'
DECL|variable|server_type
name|'server_type'
op|'='
string|"'Info'"
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'app'
op|','
name|'version'
op|','
name|'expose_info'
op|','
name|'disallowed_sections'
op|','
nl|'\n'
name|'admin_key'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'Controller'
op|'.'
name|'__init__'
op|'('
name|'self'
op|','
name|'app'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'expose_info'
op|'='
name|'expose_info'
newline|'\n'
name|'self'
op|'.'
name|'disallowed_sections'
op|'='
name|'disallowed_sections'
newline|'\n'
name|'self'
op|'.'
name|'admin_key'
op|'='
name|'admin_key'
newline|'\n'
name|'self'
op|'.'
name|'allowed_hmac_methods'
op|'='
op|'{'
nl|'\n'
string|"'HEAD'"
op|':'
op|'['
string|"'HEAD'"
op|','
string|"'GET'"
op|']'
op|','
nl|'\n'
string|"'GET'"
op|':'
op|'['
string|"'GET'"
op|']'
op|'}'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
op|'@'
name|'delay_denial'
newline|'\n'
DECL|member|GET
name|'def'
name|'GET'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'GETorHEAD'
op|'('
name|'req'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
op|'@'
name|'delay_denial'
newline|'\n'
DECL|member|HEAD
name|'def'
name|'HEAD'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'GETorHEAD'
op|'('
name|'req'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
op|'@'
name|'delay_denial'
newline|'\n'
DECL|member|OPTIONS
name|'def'
name|'OPTIONS'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'HTTPOk'
op|'('
name|'request'
op|'='
name|'req'
op|','
name|'headers'
op|'='
op|'{'
string|"'Allow'"
op|':'
string|"'HEAD, GET, OPTIONS'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|GETorHEAD
dedent|''
name|'def'
name|'GETorHEAD'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handler for HTTP GET/HEAD requests."""'
newline|'\n'
string|'"""\n        Handles requests to /info\n        Should return a WSGI-style callable (such as swob.Response).\n\n        :param req: swob.Request object\n        """'
newline|'\n'
name|'if'
name|'not'
name|'self'
op|'.'
name|'expose_info'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPForbidden'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'admin_request'
op|'='
name|'False'
newline|'\n'
name|'sig'
op|'='
name|'req'
op|'.'
name|'params'
op|'.'
name|'get'
op|'('
string|"'swiftinfo_sig'"
op|','
string|"''"
op|')'
newline|'\n'
name|'expires'
op|'='
name|'req'
op|'.'
name|'params'
op|'.'
name|'get'
op|'('
string|"'swiftinfo_expires'"
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'sig'
op|'!='
string|"''"
name|'or'
name|'expires'
op|'!='
string|"''"
op|':'
newline|'\n'
indent|'            '
name|'admin_request'
op|'='
name|'True'
newline|'\n'
name|'if'
name|'not'
name|'self'
op|'.'
name|'admin_key'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPForbidden'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'expires'
op|'='
name|'int'
op|'('
name|'expires'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPUnauthorized'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'expires'
op|'<'
name|'time'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPUnauthorized'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'valid_sigs'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'method'
name|'in'
name|'self'
op|'.'
name|'allowed_hmac_methods'
op|'['
name|'req'
op|'.'
name|'method'
op|']'
op|':'
newline|'\n'
indent|'                '
name|'valid_sigs'
op|'.'
name|'append'
op|'('
name|'get_hmac'
op|'('
name|'method'
op|','
nl|'\n'
string|"'/info'"
op|','
nl|'\n'
name|'expires'
op|','
nl|'\n'
name|'self'
op|'.'
name|'admin_key'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|"# While it's true that any() will short-circuit, this doesn't"
nl|'\n'
comment|'# affect the timing-attack resistance since the only way this will'
nl|'\n'
comment|'# short-circuit is when a valid signature is passed in.'
nl|'\n'
dedent|''
name|'is_valid_hmac'
op|'='
name|'any'
op|'('
name|'streq_const_time'
op|'('
name|'valid_sig'
op|','
name|'sig'
op|')'
nl|'\n'
name|'for'
name|'valid_sig'
name|'in'
name|'valid_sigs'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'is_valid_hmac'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPUnauthorized'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'headers'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'if'
string|"'Origin'"
name|'in'
name|'req'
op|'.'
name|'headers'
op|':'
newline|'\n'
indent|'            '
name|'headers'
op|'['
string|"'Access-Control-Allow-Origin'"
op|']'
op|'='
name|'req'
op|'.'
name|'headers'
op|'['
string|"'Origin'"
op|']'
newline|'\n'
name|'headers'
op|'['
string|"'Access-Control-Expose-Headers'"
op|']'
op|'='
string|"', '"
op|'.'
name|'join'
op|'('
nl|'\n'
op|'['
string|"'x-trans-id'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'info'
op|'='
name|'json'
op|'.'
name|'dumps'
op|'('
name|'get_swift_info'
op|'('
nl|'\n'
name|'admin'
op|'='
name|'admin_request'
op|','
name|'disallowed_sections'
op|'='
name|'self'
op|'.'
name|'disallowed_sections'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'return'
name|'HTTPOk'
op|'('
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'headers'
op|'='
name|'headers'
op|','
nl|'\n'
name|'body'
op|'='
name|'info'
op|','
nl|'\n'
name|'content_type'
op|'='
string|"'application/json; charset=UTF-8'"
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit

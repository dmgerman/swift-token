begin_unit
comment|'# Copyright (c) 2010 OpenStack, LLC.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
name|'from'
name|'__future__'
name|'import'
name|'with_statement'
newline|'\n'
nl|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'time'
newline|'\n'
name|'import'
name|'traceback'
newline|'\n'
name|'from'
name|'urllib'
name|'import'
name|'unquote'
newline|'\n'
name|'from'
name|'xml'
op|'.'
name|'sax'
name|'import'
name|'saxutils'
newline|'\n'
name|'from'
name|'datetime'
name|'import'
name|'datetime'
newline|'\n'
nl|'\n'
name|'import'
name|'simplejson'
newline|'\n'
name|'from'
name|'eventlet'
op|'.'
name|'timeout'
name|'import'
name|'Timeout'
newline|'\n'
name|'from'
name|'webob'
name|'import'
name|'Request'
op|','
name|'Response'
newline|'\n'
name|'from'
name|'webob'
op|'.'
name|'exc'
name|'import'
name|'HTTPAccepted'
op|','
name|'HTTPBadRequest'
op|','
name|'HTTPConflict'
op|','
name|'HTTPCreated'
op|','
name|'HTTPInternalServerError'
op|','
name|'HTTPNoContent'
op|','
name|'HTTPNotFound'
op|','
name|'HTTPPreconditionFailed'
op|','
name|'HTTPMethodNotAllowed'
newline|'\n'
nl|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'db'
name|'import'
name|'ContainerBroker'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'get_logger'
op|','
name|'get_param'
op|','
name|'hash_path'
op|','
name|'normalize_timestamp'
op|','
name|'storage_directory'
op|','
name|'split_path'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'constraints'
name|'import'
name|'CONTAINER_LISTING_LIMIT'
op|','
name|'check_mount'
op|','
name|'check_float'
op|','
name|'check_utf8'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'bufferedhttp'
name|'import'
name|'http_connect'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'exceptions'
name|'import'
name|'ConnectionTimeout'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'db_replicator'
name|'import'
name|'ReplicatorRpc'
newline|'\n'
nl|'\n'
DECL|variable|DATADIR
name|'DATADIR'
op|'='
string|"'containers'"
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ContainerController
name|'class'
name|'ContainerController'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""WSGI Controller for the container server."""'
newline|'\n'
nl|'\n'
comment|'# Ensure these are all lowercase'
nl|'\n'
DECL|variable|save_headers
name|'save_headers'
op|'='
op|'['
string|"'x-container-read'"
op|','
string|"'x-container-write'"
op|']'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'conf'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'logger'
op|'='
name|'get_logger'
op|'('
name|'conf'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'root'
op|'='
name|'conf'
op|'.'
name|'get'
op|'('
string|"'devices'"
op|','
string|"'/srv/node/'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mount_check'
op|'='
name|'conf'
op|'.'
name|'get'
op|'('
string|"'mount_check'"
op|','
string|"'true'"
op|')'
op|'.'
name|'lower'
op|'('
op|')'
name|'in'
op|'('
string|"'true'"
op|','
string|"'t'"
op|','
string|"'1'"
op|','
string|"'on'"
op|','
string|"'yes'"
op|','
string|"'y'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'node_timeout'
op|'='
name|'int'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'node_timeout'"
op|','
number|'3'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'conn_timeout'
op|'='
name|'float'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'conn_timeout'"
op|','
number|'0.5'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'replicator_rpc'
op|'='
name|'ReplicatorRpc'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'DATADIR'
op|','
nl|'\n'
name|'ContainerBroker'
op|','
name|'self'
op|'.'
name|'mount_check'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_container_broker
dedent|''
name|'def'
name|'_get_container_broker'
op|'('
name|'self'
op|','
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Get a DB broker for the container.\n\n        :param drive: drive that holds the container\n        :param part: partition the container is in\n        :param account: account name\n        :param container: container name\n        :returns: ContainerBroker object\n        """'
newline|'\n'
name|'hsh'
op|'='
name|'hash_path'
op|'('
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'db_dir'
op|'='
name|'storage_directory'
op|'('
name|'DATADIR'
op|','
name|'part'
op|','
name|'hsh'
op|')'
newline|'\n'
name|'db_path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|','
name|'db_dir'
op|','
name|'hsh'
op|'+'
string|"'.db'"
op|')'
newline|'\n'
name|'return'
name|'ContainerBroker'
op|'('
name|'db_path'
op|','
name|'account'
op|'='
name|'account'
op|','
name|'container'
op|'='
name|'container'
op|','
nl|'\n'
name|'logger'
op|'='
name|'self'
op|'.'
name|'logger'
op|')'
newline|'\n'
nl|'\n'
DECL|member|account_update
dedent|''
name|'def'
name|'account_update'
op|'('
name|'self'
op|','
name|'req'
op|','
name|'account'
op|','
name|'container'
op|','
name|'broker'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Update the account server with latest container info.\n\n        :param req: webob.Request object\n        :param account: account name\n        :param container: container name\n        :param borker: container DB broker object\n        :returns: if the account request returns a 404 error code,\n                  HTTPNotFound response object, otherwise None.\n        """'
newline|'\n'
name|'account_host'
op|'='
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Account-Host'"
op|')'
newline|'\n'
name|'account_partition'
op|'='
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Account-Partition'"
op|')'
newline|'\n'
name|'account_device'
op|'='
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Account-Device'"
op|')'
newline|'\n'
name|'if'
name|'all'
op|'('
op|'['
name|'account_host'
op|','
name|'account_partition'
op|','
name|'account_device'
op|']'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'account_ip'
op|','
name|'account_port'
op|'='
name|'account_host'
op|'.'
name|'split'
op|'('
string|"':'"
op|')'
newline|'\n'
name|'new_path'
op|'='
string|"'/'"
op|'+'
string|"'/'"
op|'.'
name|'join'
op|'('
op|'['
name|'account'
op|','
name|'container'
op|']'
op|')'
newline|'\n'
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'account_headers'
op|'='
op|'{'
string|"'x-put-timestamp'"
op|':'
name|'info'
op|'['
string|"'put_timestamp'"
op|']'
op|','
nl|'\n'
string|"'x-delete-timestamp'"
op|':'
name|'info'
op|'['
string|"'delete_timestamp'"
op|']'
op|','
nl|'\n'
string|"'x-object-count'"
op|':'
name|'info'
op|'['
string|"'object_count'"
op|']'
op|','
nl|'\n'
string|"'x-bytes-used'"
op|':'
name|'info'
op|'['
string|"'bytes_used'"
op|']'
op|','
nl|'\n'
string|"'x-cf-trans-id'"
op|':'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Cf-Trans-Id'"
op|','
string|"'-'"
op|')'
op|'}'
newline|'\n'
name|'if'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-account-override-deleted'"
op|','
string|"'no'"
op|')'
op|'.'
name|'lower'
op|'('
op|')'
op|'=='
string|"'yes'"
op|':'
newline|'\n'
indent|'                '
name|'account_headers'
op|'['
string|"'x-account-override-deleted'"
op|']'
op|'='
string|"'yes'"
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'with'
name|'ConnectionTimeout'
op|'('
name|'self'
op|'.'
name|'conn_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'conn'
op|'='
name|'http_connect'
op|'('
name|'account_ip'
op|','
name|'account_port'
op|','
nl|'\n'
name|'account_device'
op|','
name|'account_partition'
op|','
string|"'PUT'"
op|','
name|'new_path'
op|','
nl|'\n'
name|'account_headers'
op|')'
newline|'\n'
dedent|''
name|'with'
name|'Timeout'
op|'('
name|'self'
op|'.'
name|'node_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'account_response'
op|'='
name|'conn'
op|'.'
name|'getresponse'
op|'('
op|')'
newline|'\n'
name|'account_response'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'if'
name|'account_response'
op|'.'
name|'status'
op|'=='
number|'404'
op|':'
newline|'\n'
indent|'                        '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'account_response'
op|'.'
name|'status'
op|'<'
number|'200'
name|'or'
name|'account_response'
op|'.'
name|'status'
op|'>'
number|'299'
op|':'
newline|'\n'
indent|'                        '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'('
string|"'ERROR Account update failed '"
nl|'\n'
string|"'with %s:%s/%s transaction %s (will retry '"
nl|'\n'
string|"'later): Response %s %s'"
op|'%'
op|'('
name|'account_ip'
op|','
nl|'\n'
name|'account_port'
op|','
name|'account_device'
op|','
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-cf-trans-id'"
op|')'
op|','
nl|'\n'
name|'account_response'
op|'.'
name|'status'
op|','
nl|'\n'
name|'account_response'
op|'.'
name|'reason'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'exception'
op|'('
string|"'ERROR account update failed with '"
nl|'\n'
string|"'%s:%s/%s transaction %s (will retry later)'"
op|'%'
nl|'\n'
op|'('
name|'account_ip'
op|','
name|'account_port'
op|','
name|'account_device'
op|','
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-cf-trans-id'"
op|','
string|"'-'"
op|')'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'None'
newline|'\n'
nl|'\n'
DECL|member|DELETE
dedent|''
name|'def'
name|'DELETE'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handle HTTP DELETE request."""'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|'='
name|'split_path'
op|'('
nl|'\n'
name|'unquote'
op|'('
name|'req'
op|'.'
name|'path'
op|')'
op|','
number|'4'
op|','
number|'5'
op|','
name|'True'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|','
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'body'
op|'='
name|'str'
op|'('
name|'err'
op|')'
op|','
name|'content_type'
op|'='
string|"'text/plain'"
op|','
nl|'\n'
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'if'
string|"'x-timestamp'"
name|'not'
name|'in'
name|'req'
op|'.'
name|'headers'
name|'or'
name|'not'
name|'check_float'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-timestamp'"
op|']'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'body'
op|'='
string|"'Missing timestamp'"
op|','
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'content_type'
op|'='
string|"'text/plain'"
op|')'
newline|'\n'
dedent|''
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'Response'
op|'('
name|'status'
op|'='
string|"'507 %s is not mounted'"
op|'%'
name|'drive'
op|')'
newline|'\n'
dedent|''
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_container_broker'
op|'('
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'broker'
op|'.'
name|'db_file'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
op|')'
newline|'\n'
dedent|''
name|'if'
name|'obj'
op|':'
comment|'# delete object'
newline|'\n'
indent|'            '
name|'broker'
op|'.'
name|'delete_object'
op|'('
name|'obj'
op|','
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-timestamp'"
op|')'
op|')'
newline|'\n'
name|'return'
name|'HTTPNoContent'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|'# delete container'
nl|'\n'
indent|'            '
name|'if'
name|'not'
name|'broker'
op|'.'
name|'empty'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPConflict'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'existed'
op|'='
name|'float'
op|'('
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
op|'['
string|"'put_timestamp'"
op|']'
op|')'
name|'and'
name|'not'
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'delete_db'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'X-Timestamp'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPConflict'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'resp'
op|'='
name|'self'
op|'.'
name|'account_update'
op|'('
name|'req'
op|','
name|'account'
op|','
name|'container'
op|','
name|'broker'
op|')'
newline|'\n'
name|'if'
name|'resp'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'resp'
newline|'\n'
dedent|''
name|'if'
name|'existed'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPNoContent'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'HTTPAccepted'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
DECL|member|PUT
dedent|''
dedent|''
name|'def'
name|'PUT'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handle HTTP PUT request."""'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|'='
name|'split_path'
op|'('
nl|'\n'
name|'unquote'
op|'('
name|'req'
op|'.'
name|'path'
op|')'
op|','
number|'4'
op|','
number|'5'
op|','
name|'True'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|','
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'body'
op|'='
name|'str'
op|'('
name|'err'
op|')'
op|','
name|'content_type'
op|'='
string|"'text/plain'"
op|','
nl|'\n'
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'if'
string|"'x-timestamp'"
name|'not'
name|'in'
name|'req'
op|'.'
name|'headers'
name|'or'
name|'not'
name|'check_float'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-timestamp'"
op|']'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'body'
op|'='
string|"'Missing timestamp'"
op|','
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'content_type'
op|'='
string|"'text/plain'"
op|')'
newline|'\n'
dedent|''
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'Response'
op|'('
name|'status'
op|'='
string|"'507 %s is not mounted'"
op|'%'
name|'drive'
op|')'
newline|'\n'
dedent|''
name|'timestamp'
op|'='
name|'normalize_timestamp'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-timestamp'"
op|']'
op|')'
newline|'\n'
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_container_broker'
op|'('
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'if'
name|'obj'
op|':'
comment|'# put container object'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'broker'
op|'.'
name|'db_file'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPNotFound'
op|'('
op|')'
newline|'\n'
dedent|''
name|'broker'
op|'.'
name|'put_object'
op|'('
name|'obj'
op|','
name|'timestamp'
op|','
name|'int'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-size'"
op|']'
op|')'
op|','
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-content-type'"
op|']'
op|','
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-etag'"
op|']'
op|')'
newline|'\n'
name|'return'
name|'HTTPCreated'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
comment|'# put container'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'broker'
op|'.'
name|'db_file'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'timestamp'
op|')'
newline|'\n'
name|'created'
op|'='
name|'True'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'created'
op|'='
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'update_put_timestamp'
op|'('
name|'timestamp'
op|')'
newline|'\n'
name|'if'
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'return'
name|'HTTPConflict'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'metadata'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'metadata'
op|'.'
name|'update'
op|'('
op|'('
name|'key'
op|','
op|'('
name|'value'
op|','
name|'timestamp'
op|')'
op|')'
nl|'\n'
name|'for'
name|'key'
op|','
name|'value'
name|'in'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'iteritems'
op|'('
op|')'
nl|'\n'
name|'if'
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
name|'in'
name|'self'
op|'.'
name|'save_headers'
name|'or'
nl|'\n'
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
op|'.'
name|'startswith'
op|'('
string|"'x-container-meta-'"
op|')'
op|')'
newline|'\n'
name|'if'
name|'metadata'
op|':'
newline|'\n'
indent|'                '
name|'broker'
op|'.'
name|'update_metadata'
op|'('
name|'metadata'
op|')'
newline|'\n'
dedent|''
name|'resp'
op|'='
name|'self'
op|'.'
name|'account_update'
op|'('
name|'req'
op|','
name|'account'
op|','
name|'container'
op|','
name|'broker'
op|')'
newline|'\n'
name|'if'
name|'resp'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'resp'
newline|'\n'
dedent|''
name|'if'
name|'created'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPCreated'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPAccepted'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
DECL|member|HEAD
dedent|''
dedent|''
dedent|''
name|'def'
name|'HEAD'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handle HTTP HEAD request."""'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|'='
name|'split_path'
op|'('
nl|'\n'
name|'unquote'
op|'('
name|'req'
op|'.'
name|'path'
op|')'
op|','
number|'4'
op|','
number|'5'
op|','
name|'True'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|','
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'body'
op|'='
name|'str'
op|'('
name|'err'
op|')'
op|','
name|'content_type'
op|'='
string|"'text/plain'"
op|','
nl|'\n'
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'Response'
op|'('
name|'status'
op|'='
string|"'507 %s is not mounted'"
op|'%'
name|'drive'
op|')'
newline|'\n'
dedent|''
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_container_broker'
op|'('
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'pending_timeout'
op|'='
number|'0.1'
newline|'\n'
name|'broker'
op|'.'
name|'stale_reads_ok'
op|'='
name|'True'
newline|'\n'
name|'if'
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'headers'
op|'='
op|'{'
nl|'\n'
string|"'X-Container-Object-Count'"
op|':'
name|'info'
op|'['
string|"'object_count'"
op|']'
op|','
nl|'\n'
string|"'X-Container-Bytes-Used'"
op|':'
name|'info'
op|'['
string|"'bytes_used'"
op|']'
op|','
nl|'\n'
string|"'X-Timestamp'"
op|':'
name|'info'
op|'['
string|"'created_at'"
op|']'
op|','
nl|'\n'
string|"'X-PUT-Timestamp'"
op|':'
name|'info'
op|'['
string|"'put_timestamp'"
op|']'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'headers'
op|'.'
name|'update'
op|'('
op|'('
name|'key'
op|','
name|'value'
op|')'
nl|'\n'
name|'for'
name|'key'
op|','
op|'('
name|'value'
op|','
name|'timestamp'
op|')'
name|'in'
name|'broker'
op|'.'
name|'metadata'
op|'.'
name|'iteritems'
op|'('
op|')'
nl|'\n'
name|'if'
name|'value'
op|'!='
string|"''"
op|')'
newline|'\n'
name|'return'
name|'HTTPNoContent'
op|'('
name|'request'
op|'='
name|'req'
op|','
name|'headers'
op|'='
name|'headers'
op|')'
newline|'\n'
nl|'\n'
DECL|member|GET
dedent|''
name|'def'
name|'GET'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handle HTTP GET request."""'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|'='
name|'split_path'
op|'('
nl|'\n'
name|'unquote'
op|'('
name|'req'
op|'.'
name|'path'
op|')'
op|','
number|'4'
op|','
number|'5'
op|','
name|'True'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|','
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'body'
op|'='
name|'str'
op|'('
name|'err'
op|')'
op|','
name|'content_type'
op|'='
string|"'text/plain'"
op|','
nl|'\n'
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'Response'
op|'('
name|'status'
op|'='
string|"'507 %s is not mounted'"
op|'%'
name|'drive'
op|')'
newline|'\n'
dedent|''
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_container_broker'
op|'('
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'pending_timeout'
op|'='
number|'0.1'
newline|'\n'
name|'broker'
op|'.'
name|'stale_reads_ok'
op|'='
name|'True'
newline|'\n'
name|'if'
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'resp_headers'
op|'='
op|'{'
nl|'\n'
string|"'X-Container-Object-Count'"
op|':'
name|'info'
op|'['
string|"'object_count'"
op|']'
op|','
nl|'\n'
string|"'X-Container-Bytes-Used'"
op|':'
name|'info'
op|'['
string|"'bytes_used'"
op|']'
op|','
nl|'\n'
string|"'X-Timestamp'"
op|':'
name|'info'
op|'['
string|"'created_at'"
op|']'
op|','
nl|'\n'
string|"'X-PUT-Timestamp'"
op|':'
name|'info'
op|'['
string|"'put_timestamp'"
op|']'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'resp_headers'
op|'.'
name|'update'
op|'('
op|'('
name|'key'
op|','
name|'value'
op|')'
nl|'\n'
name|'for'
name|'key'
op|','
op|'('
name|'value'
op|','
name|'timestamp'
op|')'
name|'in'
name|'broker'
op|'.'
name|'metadata'
op|'.'
name|'iteritems'
op|'('
op|')'
nl|'\n'
name|'if'
name|'value'
op|'!='
string|"''"
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'path'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'path'"
op|')'
newline|'\n'
name|'prefix'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'prefix'"
op|')'
newline|'\n'
name|'delimiter'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'delimiter'"
op|')'
newline|'\n'
name|'if'
name|'delimiter'
name|'and'
op|'('
name|'len'
op|'('
name|'delimiter'
op|')'
op|'>'
number|'1'
name|'or'
name|'ord'
op|'('
name|'delimiter'
op|')'
op|'>'
number|'254'
op|')'
op|':'
newline|'\n'
comment|'# delimiters can be made more flexible later'
nl|'\n'
indent|'                '
name|'return'
name|'HTTPPreconditionFailed'
op|'('
name|'body'
op|'='
string|"'Bad delimiter'"
op|')'
newline|'\n'
dedent|''
name|'marker'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'marker'"
op|','
string|"''"
op|')'
newline|'\n'
name|'limit'
op|'='
name|'CONTAINER_LISTING_LIMIT'
newline|'\n'
name|'given_limit'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'limit'"
op|')'
newline|'\n'
name|'if'
name|'given_limit'
name|'and'
name|'given_limit'
op|'.'
name|'isdigit'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'limit'
op|'='
name|'int'
op|'('
name|'given_limit'
op|')'
newline|'\n'
name|'if'
name|'limit'
op|'>'
name|'CONTAINER_LISTING_LIMIT'
op|':'
newline|'\n'
indent|'                    '
name|'return'
name|'HTTPPreconditionFailed'
op|'('
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'body'
op|'='
string|"'Maximum limit is %d'"
op|'%'
name|'CONTAINER_LISTING_LIMIT'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'query_format'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'format'"
op|')'
newline|'\n'
dedent|''
name|'except'
name|'UnicodeDecodeError'
op|','
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'body'
op|'='
string|"'parameters not utf8'"
op|','
nl|'\n'
name|'content_type'
op|'='
string|"'text/plain'"
op|','
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'query_format'
op|':'
newline|'\n'
indent|'            '
name|'req'
op|'.'
name|'accept'
op|'='
string|"'application/%s'"
op|'%'
name|'query_format'
op|'.'
name|'lower'
op|'('
op|')'
newline|'\n'
dedent|''
name|'out_content_type'
op|'='
name|'req'
op|'.'
name|'accept'
op|'.'
name|'best_match'
op|'('
nl|'\n'
op|'['
string|"'text/plain'"
op|','
string|"'application/json'"
op|','
nl|'\n'
string|"'application/xml'"
op|','
string|"'text/xml'"
op|']'
op|','
nl|'\n'
name|'default_match'
op|'='
string|"'text/plain'"
op|')'
newline|'\n'
name|'container_list'
op|'='
name|'broker'
op|'.'
name|'list_objects_iter'
op|'('
name|'limit'
op|','
name|'marker'
op|','
name|'prefix'
op|','
nl|'\n'
name|'delimiter'
op|','
name|'path'
op|')'
newline|'\n'
name|'if'
name|'out_content_type'
op|'=='
string|"'application/json'"
op|':'
newline|'\n'
indent|'            '
name|'json_pattern'
op|'='
op|'['
string|'\'"name":%s\''
op|','
string|'\'"hash":"%s"\''
op|','
string|'\'"bytes":%s\''
op|','
nl|'\n'
string|'\'"content_type":%s, "last_modified":"%s"\''
op|']'
newline|'\n'
name|'json_pattern'
op|'='
string|"'{'"
op|'+'
string|"','"
op|'.'
name|'join'
op|'('
name|'json_pattern'
op|')'
op|'+'
string|"'}'"
newline|'\n'
name|'json_out'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
op|'('
name|'name'
op|','
name|'created_at'
op|','
name|'size'
op|','
name|'content_type'
op|','
name|'etag'
op|')'
name|'in'
name|'container_list'
op|':'
newline|'\n'
comment|'# escape name and format date here'
nl|'\n'
indent|'                '
name|'name'
op|'='
name|'simplejson'
op|'.'
name|'dumps'
op|'('
name|'name'
op|')'
newline|'\n'
name|'created_at'
op|'='
name|'datetime'
op|'.'
name|'utcfromtimestamp'
op|'('
nl|'\n'
name|'float'
op|'('
name|'created_at'
op|')'
op|')'
op|'.'
name|'isoformat'
op|'('
op|')'
newline|'\n'
name|'if'
name|'content_type'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'                    '
name|'json_out'
op|'.'
name|'append'
op|'('
string|'\'{"subdir":%s}\''
op|'%'
name|'name'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'content_type'
op|'='
name|'simplejson'
op|'.'
name|'dumps'
op|'('
name|'content_type'
op|')'
newline|'\n'
name|'json_out'
op|'.'
name|'append'
op|'('
name|'json_pattern'
op|'%'
op|'('
name|'name'
op|','
nl|'\n'
name|'etag'
op|','
nl|'\n'
name|'size'
op|','
nl|'\n'
name|'content_type'
op|','
nl|'\n'
name|'created_at'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'container_list'
op|'='
string|"'['"
op|'+'
string|"','"
op|'.'
name|'join'
op|'('
name|'json_out'
op|')'
op|'+'
string|"']'"
newline|'\n'
dedent|''
name|'elif'
name|'out_content_type'
op|'.'
name|'endswith'
op|'('
string|"'/xml'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'xml_output'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
op|'('
name|'name'
op|','
name|'created_at'
op|','
name|'size'
op|','
name|'content_type'
op|','
name|'etag'
op|')'
name|'in'
name|'container_list'
op|':'
newline|'\n'
comment|'# escape name and format date here'
nl|'\n'
indent|'                '
name|'name'
op|'='
name|'saxutils'
op|'.'
name|'escape'
op|'('
name|'name'
op|')'
newline|'\n'
name|'created_at'
op|'='
name|'datetime'
op|'.'
name|'utcfromtimestamp'
op|'('
nl|'\n'
name|'float'
op|'('
name|'created_at'
op|')'
op|')'
op|'.'
name|'isoformat'
op|'('
op|')'
newline|'\n'
name|'if'
name|'content_type'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'                    '
name|'xml_output'
op|'.'
name|'append'
op|'('
string|'\'<subdir name="%s" />\''
op|'%'
name|'name'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'content_type'
op|'='
name|'saxutils'
op|'.'
name|'escape'
op|'('
name|'content_type'
op|')'
newline|'\n'
name|'xml_output'
op|'.'
name|'append'
op|'('
string|"'<object><name>%s</name><hash>%s</hash>'"
string|"'<bytes>%d</bytes><content_type>%s</content_type>'"
string|"'<last_modified>%s</last_modified></object>'"
op|'%'
op|'('
name|'name'
op|','
name|'etag'
op|','
name|'size'
op|','
name|'content_type'
op|','
name|'created_at'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'container_list'
op|'='
string|"''"
op|'.'
name|'join'
op|'('
op|'['
nl|'\n'
string|'\'<?xml version="1.0" encoding="UTF-8"?>\\n\''
op|','
nl|'\n'
string|"'<container name=%s>'"
op|'%'
name|'saxutils'
op|'.'
name|'quoteattr'
op|'('
name|'container'
op|')'
op|','
nl|'\n'
string|"''"
op|'.'
name|'join'
op|'('
name|'xml_output'
op|')'
op|','
string|"'</container>'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'container_list'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPNoContent'
op|'('
name|'request'
op|'='
name|'req'
op|','
name|'headers'
op|'='
name|'resp_headers'
op|')'
newline|'\n'
dedent|''
name|'container_list'
op|'='
string|"'\\n'"
op|'.'
name|'join'
op|'('
name|'r'
op|'['
number|'0'
op|']'
name|'for'
name|'r'
name|'in'
name|'container_list'
op|')'
op|'+'
string|"'\\n'"
newline|'\n'
dedent|''
name|'ret'
op|'='
name|'Response'
op|'('
name|'body'
op|'='
name|'container_list'
op|','
name|'request'
op|'='
name|'req'
op|','
name|'headers'
op|'='
name|'resp_headers'
op|')'
newline|'\n'
name|'ret'
op|'.'
name|'content_type'
op|'='
name|'out_content_type'
newline|'\n'
name|'ret'
op|'.'
name|'charset'
op|'='
string|"'utf8'"
newline|'\n'
name|'return'
name|'ret'
newline|'\n'
nl|'\n'
DECL|member|REPLICATE
dedent|''
name|'def'
name|'REPLICATE'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Handle HTTP REPLICATE request (json-encoded RPC calls for replication.)\n        """'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'post_args'
op|'='
name|'split_path'
op|'('
name|'unquote'
op|'('
name|'req'
op|'.'
name|'path'
op|')'
op|','
number|'3'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|','
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'body'
op|'='
name|'str'
op|'('
name|'err'
op|')'
op|','
name|'content_type'
op|'='
string|"'text/plain'"
op|','
nl|'\n'
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'drive'
op|','
name|'partition'
op|','
name|'hash'
op|'='
name|'post_args'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'Response'
op|'('
name|'status'
op|'='
string|"'507 %s is not mounted'"
op|'%'
name|'drive'
op|')'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'args'
op|'='
name|'simplejson'
op|'.'
name|'load'
op|'('
name|'req'
op|'.'
name|'body_file'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|','
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'body'
op|'='
name|'str'
op|'('
name|'err'
op|')'
op|','
name|'content_type'
op|'='
string|"'text/plain'"
op|')'
newline|'\n'
dedent|''
name|'ret'
op|'='
name|'self'
op|'.'
name|'replicator_rpc'
op|'.'
name|'dispatch'
op|'('
name|'post_args'
op|','
name|'args'
op|')'
newline|'\n'
name|'ret'
op|'.'
name|'request'
op|'='
name|'req'
newline|'\n'
name|'return'
name|'ret'
newline|'\n'
nl|'\n'
DECL|member|POST
dedent|''
name|'def'
name|'POST'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handle HTTP POST request."""'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|'='
name|'split_path'
op|'('
name|'unquote'
op|'('
name|'req'
op|'.'
name|'path'
op|')'
op|','
number|'4'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|','
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'body'
op|'='
name|'str'
op|'('
name|'err'
op|')'
op|','
name|'content_type'
op|'='
string|"'text/plain'"
op|','
nl|'\n'
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'if'
string|"'x-timestamp'"
name|'not'
name|'in'
name|'req'
op|'.'
name|'headers'
name|'or'
name|'not'
name|'check_float'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-timestamp'"
op|']'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'body'
op|'='
string|"'Missing or bad timestamp'"
op|','
nl|'\n'
name|'request'
op|'='
name|'req'
op|','
name|'content_type'
op|'='
string|"'text/plain'"
op|')'
newline|'\n'
dedent|''
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'Response'
op|'('
name|'status'
op|'='
string|"'507 %s is not mounted'"
op|'%'
name|'drive'
op|')'
newline|'\n'
dedent|''
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_container_broker'
op|'('
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'if'
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'timestamp'
op|'='
name|'normalize_timestamp'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-timestamp'"
op|']'
op|')'
newline|'\n'
name|'metadata'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'metadata'
op|'.'
name|'update'
op|'('
op|'('
name|'key'
op|','
op|'('
name|'value'
op|','
name|'timestamp'
op|')'
op|')'
nl|'\n'
name|'for'
name|'key'
op|','
name|'value'
name|'in'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'iteritems'
op|'('
op|')'
nl|'\n'
name|'if'
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
name|'in'
name|'self'
op|'.'
name|'save_headers'
name|'or'
nl|'\n'
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
op|'.'
name|'startswith'
op|'('
string|"'x-container-meta-'"
op|')'
op|')'
newline|'\n'
name|'if'
name|'metadata'
op|':'
newline|'\n'
indent|'            '
name|'broker'
op|'.'
name|'update_metadata'
op|'('
name|'metadata'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'HTTPNoContent'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__call__
dedent|''
name|'def'
name|'__call__'
op|'('
name|'self'
op|','
name|'env'
op|','
name|'start_response'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'start_time'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'req'
op|'='
name|'Request'
op|'('
name|'env'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'check_utf8'
op|'('
name|'req'
op|'.'
name|'path_info'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'res'
op|'='
name|'HTTPPreconditionFailed'
op|'('
name|'body'
op|'='
string|"'Invalid UTF8'"
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'hasattr'
op|'('
name|'self'
op|','
name|'req'
op|'.'
name|'method'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'res'
op|'='
name|'getattr'
op|'('
name|'self'
op|','
name|'req'
op|'.'
name|'method'
op|')'
op|'('
name|'req'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'res'
op|'='
name|'HTTPMethodNotAllowed'
op|'('
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'exception'
op|'('
string|"'ERROR __call__ error with %s %s '"
nl|'\n'
string|"'transaction %s'"
op|'%'
op|'('
name|'env'
op|'.'
name|'get'
op|'('
string|"'REQUEST_METHOD'"
op|','
string|"'-'"
op|')'
op|','
nl|'\n'
name|'env'
op|'.'
name|'get'
op|'('
string|"'PATH_INFO'"
op|','
string|"'-'"
op|')'
op|','
name|'env'
op|'.'
name|'get'
op|'('
string|"'HTTP_X_CF_TRANS_ID'"
op|','
nl|'\n'
string|"'-'"
op|')'
op|')'
op|')'
newline|'\n'
name|'res'
op|'='
name|'HTTPInternalServerError'
op|'('
name|'body'
op|'='
name|'traceback'
op|'.'
name|'format_exc'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'trans_time'
op|'='
string|"'%.4f'"
op|'%'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'-'
name|'start_time'
op|')'
newline|'\n'
name|'log_message'
op|'='
string|'\'%s - - [%s] "%s %s" %s %s "%s" "%s" "%s" %s\''
op|'%'
op|'('
nl|'\n'
name|'req'
op|'.'
name|'remote_addr'
op|','
nl|'\n'
name|'time'
op|'.'
name|'strftime'
op|'('
string|"'%d/%b/%Y:%H:%M:%S +0000'"
op|','
nl|'\n'
name|'time'
op|'.'
name|'gmtime'
op|'('
op|')'
op|')'
op|','
nl|'\n'
name|'req'
op|'.'
name|'method'
op|','
name|'req'
op|'.'
name|'path'
op|','
nl|'\n'
name|'res'
op|'.'
name|'status'
op|'.'
name|'split'
op|'('
op|')'
op|'['
number|'0'
op|']'
op|','
name|'res'
op|'.'
name|'content_length'
name|'or'
string|"'-'"
op|','
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-cf-trans-id'"
op|','
string|"'-'"
op|')'
op|','
nl|'\n'
name|'req'
op|'.'
name|'referer'
name|'or'
string|"'-'"
op|','
name|'req'
op|'.'
name|'user_agent'
name|'or'
string|"'-'"
op|','
nl|'\n'
name|'trans_time'
op|')'
newline|'\n'
name|'if'
name|'req'
op|'.'
name|'method'
op|'.'
name|'upper'
op|'('
op|')'
op|'=='
string|"'REPLICATE'"
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'debug'
op|'('
name|'log_message'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'info'
op|'('
name|'log_message'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'res'
op|'('
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|app_factory
dedent|''
dedent|''
name|'def'
name|'app_factory'
op|'('
name|'global_conf'
op|','
op|'**'
name|'local_conf'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""paste.deploy app factory for creating WSGI container server apps"""'
newline|'\n'
name|'conf'
op|'='
name|'global_conf'
op|'.'
name|'copy'
op|'('
op|')'
newline|'\n'
name|'conf'
op|'.'
name|'update'
op|'('
name|'local_conf'
op|')'
newline|'\n'
name|'return'
name|'ContainerController'
op|'('
name|'conf'
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit

begin_unit
comment|'# Copyright (c) 2013 OpenStack Foundation.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
string|'"""\n``account_quotas`` is a middleware which blocks write requests (PUT, POST) if a\ngiven account quota (in bytes) is exceeded while DELETE requests are still\nallowed.\n\n``account_quotas`` uses the ``x-account-meta-quota-bytes`` metadata entry to\nstore the quota. Write requests to this metadata entry are only permitted for\nresellers. There is no quota limit if ``x-account-meta-quota-bytes`` is not\nset.\n\nThe ``account_quotas`` middleware should be added to the pipeline in your\n``/etc/swift/proxy-server.conf`` file just after any auth middleware.\nFor example::\n\n    [pipeline:main]\n    pipeline = catch_errors cache tempauth account_quotas proxy-server\n\n    [filter:account_quotas]\n    use = egg:swift#account_quotas\n\nTo set the quota on an account::\n\n    swift -A http://127.0.0.1:8080/auth/v1.0 -U account:reseller -K secret \\\npost -m quota-bytes:10000\n\nRemove the quota::\n\n    swift -A http://127.0.0.1:8080/auth/v1.0 -U account:reseller -K secret \\\npost -m quota-bytes:\n\nThe same limitations apply for the account quotas as for the container quotas.\n\nFor example, when uploading an object without a content-length header the proxy\nserver doesn\'t know the final size of the currently uploaded object and the\nupload will be allowed if the current account size is within the quota.\nDue to the eventual consistency further uploads might be possible until the\naccount size has been updated.\n"""'
newline|'\n'
nl|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'swob'
name|'import'
name|'HTTPForbidden'
op|','
name|'HTTPBadRequest'
op|','
name|'HTTPRequestEntityTooLarge'
op|','
name|'wsgify'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'register_swift_info'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'proxy'
op|'.'
name|'controllers'
op|'.'
name|'base'
name|'import'
name|'get_account_info'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|AccountQuotaMiddleware
name|'class'
name|'AccountQuotaMiddleware'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Account quota middleware\n\n    See above for a full description.\n\n    """'
newline|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'app'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'app'
op|'='
name|'app'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'wsgify'
newline|'\n'
DECL|member|__call__
name|'def'
name|'__call__'
op|'('
name|'self'
op|','
name|'request'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'        '
name|'if'
name|'request'
op|'.'
name|'method'
name|'not'
name|'in'
op|'('
string|'"POST"'
op|','
string|'"PUT"'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'app'
newline|'\n'
nl|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'ver'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|'='
name|'request'
op|'.'
name|'split_path'
op|'('
nl|'\n'
number|'2'
op|','
number|'4'
op|','
name|'rest_with_last'
op|'='
name|'True'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'app'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'not'
name|'container'
op|':'
newline|'\n'
comment|'# account request, so we pay attention to the quotas'
nl|'\n'
indent|'            '
name|'new_quota'
op|'='
name|'request'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
nl|'\n'
string|"'X-Account-Meta-Quota-Bytes'"
op|')'
newline|'\n'
name|'remove_quota'
op|'='
name|'request'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
nl|'\n'
string|"'X-Remove-Account-Meta-Quota-Bytes'"
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|'# container or object request; even if the quota headers are set'
nl|'\n'
comment|"# in the request, they're meaningless"
nl|'\n'
indent|'            '
name|'new_quota'
op|'='
name|'remove_quota'
op|'='
name|'None'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'remove_quota'
op|':'
newline|'\n'
indent|'            '
name|'new_quota'
op|'='
number|'0'
comment|'# X-Remove dominates if both are present'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'request'
op|'.'
name|'environ'
op|'.'
name|'get'
op|'('
string|"'reseller_request'"
op|')'
name|'is'
name|'True'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'new_quota'
name|'and'
name|'not'
name|'new_quota'
op|'.'
name|'isdigit'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPBadRequest'
op|'('
op|')'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'app'
newline|'\n'
nl|'\n'
comment|'# deny quota set for non-reseller'
nl|'\n'
dedent|''
name|'if'
name|'new_quota'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPForbidden'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'request'
op|'.'
name|'method'
op|'=='
string|'"POST"'
name|'or'
name|'not'
name|'obj'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'app'
newline|'\n'
nl|'\n'
dedent|''
name|'content_length'
op|'='
op|'('
name|'request'
op|'.'
name|'content_length'
name|'or'
number|'0'
op|')'
newline|'\n'
nl|'\n'
name|'account_info'
op|'='
name|'get_account_info'
op|'('
name|'request'
op|'.'
name|'environ'
op|','
name|'self'
op|'.'
name|'app'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'account_info'
name|'or'
name|'not'
name|'account_info'
op|'['
string|"'bytes'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'app'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'quota'
op|'='
name|'int'
op|'('
name|'account_info'
op|'['
string|"'meta'"
op|']'
op|'.'
name|'get'
op|'('
string|"'quota-bytes'"
op|','
op|'-'
number|'1'
op|')'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'app'
newline|'\n'
dedent|''
name|'if'
name|'quota'
op|'<'
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'app'
newline|'\n'
nl|'\n'
dedent|''
name|'new_size'
op|'='
name|'int'
op|'('
name|'account_info'
op|'['
string|"'bytes'"
op|']'
op|')'
op|'+'
name|'content_length'
newline|'\n'
name|'if'
name|'quota'
op|'<'
name|'new_size'
op|':'
newline|'\n'
indent|'            '
name|'resp'
op|'='
name|'HTTPRequestEntityTooLarge'
op|'('
name|'body'
op|'='
string|"'Upload exceeds quota.'"
op|')'
newline|'\n'
name|'if'
string|"'swift.authorize'"
name|'in'
name|'request'
op|'.'
name|'environ'
op|':'
newline|'\n'
indent|'                '
name|'orig_authorize'
op|'='
name|'request'
op|'.'
name|'environ'
op|'['
string|"'swift.authorize'"
op|']'
newline|'\n'
nl|'\n'
DECL|function|reject_authorize
name|'def'
name|'reject_authorize'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'aresp'
op|'='
name|'orig_authorize'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
name|'if'
name|'aresp'
op|':'
newline|'\n'
indent|'                        '
name|'return'
name|'aresp'
newline|'\n'
dedent|''
name|'return'
name|'resp'
newline|'\n'
dedent|''
name|'request'
op|'.'
name|'environ'
op|'['
string|"'swift.authorize'"
op|']'
op|'='
name|'reject_authorize'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'resp'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'return'
name|'self'
op|'.'
name|'app'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|filter_factory
dedent|''
dedent|''
name|'def'
name|'filter_factory'
op|'('
name|'global_conf'
op|','
op|'**'
name|'local_conf'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Returns a WSGI filter app for use with paste.deploy."""'
newline|'\n'
name|'register_swift_info'
op|'('
string|"'account_quotas'"
op|')'
newline|'\n'
nl|'\n'
DECL|function|account_quota_filter
name|'def'
name|'account_quota_filter'
op|'('
name|'app'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'AccountQuotaMiddleware'
op|'('
name|'app'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'account_quota_filter'
newline|'\n'
dedent|''
endmarker|''
end_unit

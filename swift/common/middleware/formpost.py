begin_unit
comment|'# Copyright (c) 2011 OpenStack Foundation'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
string|'"""\nFormPost Middleware\n\nTranslates a browser form post into a regular Swift object PUT.\n\nThe format of the form is::\n\n    <form action="<swift-url>" method="POST"\n          enctype="multipart/form-data">\n      <input type="hidden" name="redirect" value="<redirect-url>" />\n      <input type="hidden" name="max_file_size" value="<bytes>" />\n      <input type="hidden" name="max_file_count" value="<count>" />\n      <input type="hidden" name="expires" value="<unix-timestamp>" />\n      <input type="hidden" name="signature" value="<hmac>" />\n      <input type="file" name="file1" /><br />\n      <input type="submit" />\n    </form>\n\nOptionally, if you want the uploaded files to be temporary you can set\nx-delete-at or x-delete-after attributes by adding one of these as a\nform input::\n\n    <input type="hidden" name="x_delete_at" value="<unix-timestamp>" />\n    <input type="hidden" name="x_delete_after" value="<seconds>" />\n\nThe <swift-url> is the URL of the Swift destination, such as::\n\n    https://swift-cluster.example.com/v1/AUTH_account/container/object_prefix\n\nThe name of each file uploaded will be appended to the <swift-url>\ngiven. So, you can upload directly to the root of container with a\nurl like::\n\n    https://swift-cluster.example.com/v1/AUTH_account/container/\n\nOptionally, you can include an object prefix to better separate\ndifferent users\' uploads, such as::\n\n    https://swift-cluster.example.com/v1/AUTH_account/container/object_prefix\n\nNote the form method must be POST and the enctype must be set as\n"multipart/form-data".\n\nThe redirect attribute is the URL to redirect the browser to after the upload\ncompletes. This is an optional parameter. If you are uploading the form via an\nXMLHttpRequest the redirect should not be included. The URL will have status\nand message query parameters added to it, indicating the HTTP status code for\nthe upload (2xx is success) and a possible message for further information if\nthere was an error (such as "max_file_size exceeded").\n\nThe max_file_size attribute must be included and indicates the\nlargest single file upload that can be done, in bytes.\n\nThe max_file_count attribute must be included and indicates the\nmaximum number of files that can be uploaded with the form. Include\nadditional ``<input type="file" name="filexx" />`` attributes if\ndesired.\n\nThe expires attribute is the Unix timestamp before which the form\nmust be submitted before it is invalidated.\n\nThe signature attribute is the HMAC-SHA1 signature of the form. Here is\nsample code for computing the signature::\n\n    import hmac\n    from hashlib import sha1\n    from time import time\n    path = \'/v1/account/container/object_prefix\'\n    redirect = \'https://srv.com/some-page\'  # set to \'\' if redirect not in form\n    max_file_size = 104857600\n    max_file_count = 10\n    expires = int(time() + 600)\n    key = \'mykey\'\n    hmac_body = \'%s\\\\n%s\\\\n%s\\\\n%s\\\\n%s\' % (path, redirect,\n        max_file_size, max_file_count, expires)\n    signature = hmac.new(key, hmac_body, sha1).hexdigest()\n\nThe key is the value of either the account (X-Account-Meta-Temp-URL-Key,\nX-Account-Meta-Temp-Url-Key-2) or the container\n(X-Container-Meta-Temp-URL-Key, X-Container-Meta-Temp-Url-Key-2) TempURL keys.\n\nBe certain to use the full path, from the /v1/ onward.\nNote that x_delete_at and x_delete_after are not used in signature generation\nas they are both optional attributes.\n\nThe command line tool ``swift-form-signature`` may be used (mostly\njust when testing) to compute expires and signature.\n\nAlso note that the file attributes must be after the other attributes\nin order to be processed correctly. If attributes come after the\nfile, they won\'t be sent with the subrequest (there is no way to\nparse all the attributes on the server-side without reading the whole\nthing into memory -- to service many requests, some with large files,\nthere just isn\'t enough memory on the server, so attributes following\nthe file are simply ignored).\n"""'
newline|'\n'
nl|'\n'
DECL|variable|__all__
name|'__all__'
op|'='
op|'['
string|"'FormPost'"
op|','
string|"'filter_factory'"
op|','
string|"'READ_CHUNK_SIZE'"
op|','
string|"'MAX_VALUE_LENGTH'"
op|']'
newline|'\n'
nl|'\n'
name|'import'
name|'hmac'
newline|'\n'
name|'from'
name|'hashlib'
name|'import'
name|'sha1'
newline|'\n'
name|'from'
name|'time'
name|'import'
name|'time'
newline|'\n'
nl|'\n'
name|'from'
name|'six'
op|'.'
name|'moves'
op|'.'
name|'urllib'
op|'.'
name|'parse'
name|'import'
name|'quote'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'exceptions'
name|'import'
name|'MimeInvalid'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'middleware'
op|'.'
name|'tempurl'
name|'import'
name|'get_tempurl_keys_from_metadata'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'streq_const_time'
op|','
name|'register_swift_info'
op|','
name|'parse_content_disposition'
op|','
name|'parse_mime_headers'
op|','
name|'iter_multipart_mime_documents'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'wsgi'
name|'import'
name|'make_pre_authed_env'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'swob'
name|'import'
name|'HTTPUnauthorized'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'proxy'
op|'.'
name|'controllers'
op|'.'
name|'base'
name|'import'
name|'get_account_info'
op|','
name|'get_container_info'
newline|'\n'
nl|'\n'
nl|'\n'
comment|'#: The size of data to read from the form at any given time.'
nl|'\n'
DECL|variable|READ_CHUNK_SIZE
name|'READ_CHUNK_SIZE'
op|'='
number|'4096'
newline|'\n'
nl|'\n'
comment|"#: The maximum size of any attribute's value. Any additional data will be"
nl|'\n'
comment|'#: truncated.'
nl|'\n'
DECL|variable|MAX_VALUE_LENGTH
name|'MAX_VALUE_LENGTH'
op|'='
number|'4096'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|FormInvalid
name|'class'
name|'FormInvalid'
op|'('
name|'Exception'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'pass'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|FormUnauthorized
dedent|''
name|'class'
name|'FormUnauthorized'
op|'('
name|'Exception'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'pass'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|_CappedFileLikeObject
dedent|''
name|'class'
name|'_CappedFileLikeObject'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    A file-like object wrapping another file-like object that raises\n    an EOFError if the amount of data read exceeds a given\n    max_file_size.\n\n    :param fp: The file-like object to wrap.\n    :param max_file_size: The maximum bytes to read before raising an\n                          EOFError.\n    """'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'fp'
op|','
name|'max_file_size'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'fp'
op|'='
name|'fp'
newline|'\n'
name|'self'
op|'.'
name|'max_file_size'
op|'='
name|'max_file_size'
newline|'\n'
name|'self'
op|'.'
name|'amount_read'
op|'='
number|'0'
newline|'\n'
name|'self'
op|'.'
name|'file_size_exceeded'
op|'='
name|'False'
newline|'\n'
nl|'\n'
DECL|member|read
dedent|''
name|'def'
name|'read'
op|'('
name|'self'
op|','
name|'size'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ret'
op|'='
name|'self'
op|'.'
name|'fp'
op|'.'
name|'read'
op|'('
name|'size'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'amount_read'
op|'+='
name|'len'
op|'('
name|'ret'
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'amount_read'
op|'>'
name|'self'
op|'.'
name|'max_file_size'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'file_size_exceeded'
op|'='
name|'True'
newline|'\n'
name|'raise'
name|'EOFError'
op|'('
string|"'max_file_size exceeded'"
op|')'
newline|'\n'
dedent|''
name|'return'
name|'ret'
newline|'\n'
nl|'\n'
DECL|member|readline
dedent|''
name|'def'
name|'readline'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ret'
op|'='
name|'self'
op|'.'
name|'fp'
op|'.'
name|'readline'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'amount_read'
op|'+='
name|'len'
op|'('
name|'ret'
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'amount_read'
op|'>'
name|'self'
op|'.'
name|'max_file_size'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'file_size_exceeded'
op|'='
name|'True'
newline|'\n'
name|'raise'
name|'EOFError'
op|'('
string|"'max_file_size exceeded'"
op|')'
newline|'\n'
dedent|''
name|'return'
name|'ret'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|FormPost
dedent|''
dedent|''
name|'class'
name|'FormPost'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    FormPost Middleware\n\n    See above for a full description.\n\n    The proxy logs created for any subrequests made will have swift.source set\n    to "FP".\n\n    :param app: The next WSGI filter or app in the paste.deploy\n                chain.\n    :param conf: The configuration dict for the middleware.\n    """'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'app'
op|','
name|'conf'
op|')'
op|':'
newline|'\n'
comment|'#: The next WSGI application/filter in the paste.deploy pipeline.'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'app'
op|'='
name|'app'
newline|'\n'
comment|'#: The filter configuration dict.'
nl|'\n'
name|'self'
op|'.'
name|'conf'
op|'='
name|'conf'
newline|'\n'
nl|'\n'
DECL|member|__call__
dedent|''
name|'def'
name|'__call__'
op|'('
name|'self'
op|','
name|'env'
op|','
name|'start_response'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Main hook into the WSGI paste.deploy filter/app pipeline.\n\n        :param env: The WSGI environment dict.\n        :param start_response: The WSGI start_response hook.\n        :returns: Response as per WSGI.\n        """'
newline|'\n'
name|'if'
name|'env'
op|'['
string|"'REQUEST_METHOD'"
op|']'
op|'=='
string|"'POST'"
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'content_type'
op|','
name|'attrs'
op|'='
name|'parse_content_disposition'
op|'('
name|'env'
op|'.'
name|'get'
op|'('
string|"'CONTENT_TYPE'"
op|')'
name|'or'
string|"''"
op|')'
newline|'\n'
name|'if'
name|'content_type'
op|'=='
string|"'multipart/form-data'"
name|'and'
string|"'boundary'"
name|'in'
name|'attrs'
op|':'
newline|'\n'
indent|'                    '
name|'http_user_agent'
op|'='
string|'"%s FormPost"'
op|'%'
op|'('
nl|'\n'
name|'env'
op|'.'
name|'get'
op|'('
string|"'HTTP_USER_AGENT'"
op|','
string|"''"
op|')'
op|')'
newline|'\n'
name|'env'
op|'['
string|"'HTTP_USER_AGENT'"
op|']'
op|'='
name|'http_user_agent'
op|'.'
name|'strip'
op|'('
op|')'
newline|'\n'
name|'status'
op|','
name|'headers'
op|','
name|'body'
op|'='
name|'self'
op|'.'
name|'_translate_form'
op|'('
nl|'\n'
name|'env'
op|','
name|'attrs'
op|'['
string|"'boundary'"
op|']'
op|')'
newline|'\n'
name|'start_response'
op|'('
name|'status'
op|','
name|'headers'
op|')'
newline|'\n'
name|'return'
op|'['
name|'body'
op|']'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'MimeInvalid'
op|':'
newline|'\n'
indent|'                '
name|'body'
op|'='
string|"'FormPost: invalid starting boundary'"
newline|'\n'
name|'start_response'
op|'('
nl|'\n'
string|"'400 Bad Request'"
op|','
nl|'\n'
op|'('
op|'('
string|"'Content-Type'"
op|','
string|"'text/plain'"
op|')'
op|','
nl|'\n'
op|'('
string|"'Content-Length'"
op|','
name|'str'
op|'('
name|'len'
op|'('
name|'body'
op|')'
op|')'
op|')'
op|')'
op|')'
newline|'\n'
name|'return'
op|'['
name|'body'
op|']'
newline|'\n'
dedent|''
name|'except'
op|'('
name|'FormInvalid'
op|','
name|'EOFError'
op|')'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'body'
op|'='
string|"'FormPost: %s'"
op|'%'
name|'err'
newline|'\n'
name|'start_response'
op|'('
nl|'\n'
string|"'400 Bad Request'"
op|','
nl|'\n'
op|'('
op|'('
string|"'Content-Type'"
op|','
string|"'text/plain'"
op|')'
op|','
nl|'\n'
op|'('
string|"'Content-Length'"
op|','
name|'str'
op|'('
name|'len'
op|'('
name|'body'
op|')'
op|')'
op|')'
op|')'
op|')'
newline|'\n'
name|'return'
op|'['
name|'body'
op|']'
newline|'\n'
dedent|''
name|'except'
name|'FormUnauthorized'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'message'
op|'='
string|"'FormPost: %s'"
op|'%'
name|'str'
op|'('
name|'err'
op|')'
op|'.'
name|'title'
op|'('
op|')'
newline|'\n'
name|'return'
name|'HTTPUnauthorized'
op|'('
name|'body'
op|'='
name|'message'
op|')'
op|'('
nl|'\n'
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'self'
op|'.'
name|'app'
op|'('
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_translate_form
dedent|''
name|'def'
name|'_translate_form'
op|'('
name|'self'
op|','
name|'env'
op|','
name|'boundary'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Translates the form data into subrequests and issues a\n        response.\n\n        :param env: The WSGI environment dict.\n        :param boundary: The MIME type boundary to look for.\n        :returns: status_line, headers_list, body\n        """'
newline|'\n'
name|'keys'
op|'='
name|'self'
op|'.'
name|'_get_keys'
op|'('
name|'env'
op|')'
newline|'\n'
name|'status'
op|'='
name|'message'
op|'='
string|"''"
newline|'\n'
name|'attributes'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'subheaders'
op|'='
op|'['
op|']'
newline|'\n'
name|'file_count'
op|'='
number|'0'
newline|'\n'
name|'for'
name|'fp'
name|'in'
name|'iter_multipart_mime_documents'
op|'('
nl|'\n'
name|'env'
op|'['
string|"'wsgi.input'"
op|']'
op|','
name|'boundary'
op|','
name|'read_chunk_size'
op|'='
name|'READ_CHUNK_SIZE'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'hdrs'
op|'='
name|'parse_mime_headers'
op|'('
name|'fp'
op|')'
newline|'\n'
name|'disp'
op|','
name|'attrs'
op|'='
name|'parse_content_disposition'
op|'('
nl|'\n'
name|'hdrs'
op|'.'
name|'get'
op|'('
string|"'Content-Disposition'"
op|','
string|"''"
op|')'
op|')'
newline|'\n'
name|'if'
name|'disp'
op|'=='
string|"'form-data'"
name|'and'
name|'attrs'
op|'.'
name|'get'
op|'('
string|"'filename'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'file_count'
op|'+='
number|'1'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'if'
name|'file_count'
op|'>'
name|'int'
op|'('
name|'attributes'
op|'.'
name|'get'
op|'('
string|"'max_file_count'"
op|')'
name|'or'
number|'0'
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'status'
op|'='
string|"'400 Bad Request'"
newline|'\n'
name|'message'
op|'='
string|"'max file count exceeded'"
newline|'\n'
name|'break'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'FormInvalid'
op|'('
string|"'max_file_count not an integer'"
op|')'
newline|'\n'
dedent|''
name|'attributes'
op|'['
string|"'filename'"
op|']'
op|'='
name|'attrs'
op|'['
string|"'filename'"
op|']'
name|'or'
string|"'filename'"
newline|'\n'
name|'if'
string|"'content-type'"
name|'not'
name|'in'
name|'attributes'
name|'and'
string|"'content-type'"
name|'in'
name|'hdrs'
op|':'
newline|'\n'
indent|'                    '
name|'attributes'
op|'['
string|"'content-type'"
op|']'
op|'='
name|'hdrs'
op|'['
string|"'Content-Type'"
op|']'
name|'or'
string|"'application/octet-stream'"
newline|'\n'
dedent|''
name|'status'
op|','
name|'subheaders'
op|','
name|'message'
op|'='
name|'self'
op|'.'
name|'_perform_subrequest'
op|'('
name|'env'
op|','
name|'attributes'
op|','
name|'fp'
op|','
name|'keys'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'status'
op|'.'
name|'startswith'
op|'('
string|"'2'"
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'break'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'data'
op|'='
string|"''"
newline|'\n'
name|'mxln'
op|'='
name|'MAX_VALUE_LENGTH'
newline|'\n'
name|'while'
name|'mxln'
op|':'
newline|'\n'
indent|'                    '
name|'chunk'
op|'='
name|'fp'
op|'.'
name|'read'
op|'('
name|'mxln'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'chunk'
op|':'
newline|'\n'
indent|'                        '
name|'break'
newline|'\n'
dedent|''
name|'mxln'
op|'-='
name|'len'
op|'('
name|'chunk'
op|')'
newline|'\n'
name|'data'
op|'+='
name|'chunk'
newline|'\n'
dedent|''
name|'while'
name|'fp'
op|'.'
name|'read'
op|'('
name|'READ_CHUNK_SIZE'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'pass'
newline|'\n'
dedent|''
name|'if'
string|"'name'"
name|'in'
name|'attrs'
op|':'
newline|'\n'
indent|'                    '
name|'attributes'
op|'['
name|'attrs'
op|'['
string|"'name'"
op|']'
op|'.'
name|'lower'
op|'('
op|')'
op|']'
op|'='
name|'data'
op|'.'
name|'rstrip'
op|'('
string|"'\\r\\n--'"
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'if'
name|'not'
name|'status'
op|':'
newline|'\n'
indent|'            '
name|'status'
op|'='
string|"'400 Bad Request'"
newline|'\n'
name|'message'
op|'='
string|"'no files to process'"
newline|'\n'
nl|'\n'
dedent|''
name|'headers'
op|'='
op|'['
op|'('
name|'k'
op|','
name|'v'
op|')'
name|'for'
name|'k'
op|','
name|'v'
name|'in'
name|'subheaders'
nl|'\n'
name|'if'
name|'k'
op|'.'
name|'lower'
op|'('
op|')'
op|'.'
name|'startswith'
op|'('
string|"'access-control'"
op|')'
op|']'
newline|'\n'
nl|'\n'
name|'redirect'
op|'='
name|'attributes'
op|'.'
name|'get'
op|'('
string|"'redirect'"
op|')'
newline|'\n'
name|'if'
name|'not'
name|'redirect'
op|':'
newline|'\n'
indent|'            '
name|'body'
op|'='
name|'status'
newline|'\n'
name|'if'
name|'message'
op|':'
newline|'\n'
indent|'                '
name|'body'
op|'='
name|'status'
op|'+'
string|"'\\r\\nFormPost: '"
op|'+'
name|'message'
op|'.'
name|'title'
op|'('
op|')'
newline|'\n'
dedent|''
name|'headers'
op|'.'
name|'extend'
op|'('
op|'['
op|'('
string|"'Content-Type'"
op|','
string|"'text/plain'"
op|')'
op|','
nl|'\n'
op|'('
string|"'Content-Length'"
op|','
name|'len'
op|'('
name|'body'
op|')'
op|')'
op|']'
op|')'
newline|'\n'
name|'return'
name|'status'
op|','
name|'headers'
op|','
name|'body'
newline|'\n'
dedent|''
name|'status'
op|'='
name|'status'
op|'.'
name|'split'
op|'('
string|"' '"
op|','
number|'1'
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'if'
string|"'?'"
name|'in'
name|'redirect'
op|':'
newline|'\n'
indent|'            '
name|'redirect'
op|'+='
string|"'&'"
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'redirect'
op|'+='
string|"'?'"
newline|'\n'
dedent|''
name|'redirect'
op|'+='
string|"'status=%s&message=%s'"
op|'%'
op|'('
name|'quote'
op|'('
name|'status'
op|')'
op|','
name|'quote'
op|'('
name|'message'
op|')'
op|')'
newline|'\n'
name|'body'
op|'='
string|'\'<html><body><p><a href="%s">\''
string|"'Click to continue...</a></p></body></html>'"
op|'%'
name|'redirect'
newline|'\n'
name|'headers'
op|'.'
name|'extend'
op|'('
nl|'\n'
op|'['
op|'('
string|"'Location'"
op|','
name|'redirect'
op|')'
op|','
op|'('
string|"'Content-Length'"
op|','
name|'str'
op|'('
name|'len'
op|'('
name|'body'
op|')'
op|')'
op|')'
op|']'
op|')'
newline|'\n'
name|'return'
string|"'303 See Other'"
op|','
name|'headers'
op|','
name|'body'
newline|'\n'
nl|'\n'
DECL|member|_perform_subrequest
dedent|''
name|'def'
name|'_perform_subrequest'
op|'('
name|'self'
op|','
name|'orig_env'
op|','
name|'attributes'
op|','
name|'fp'
op|','
name|'keys'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Performs the subrequest and returns the response.\n\n        :param orig_env: The WSGI environment dict; will only be used\n                         to form a new env for the subrequest.\n        :param attributes: dict of the attributes of the form so far.\n        :param fp: The file-like object containing the request body.\n        :param keys: The account keys to validate the signature with.\n        :returns: (status_line, headers_list, message)\n        """'
newline|'\n'
name|'if'
name|'not'
name|'keys'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'FormUnauthorized'
op|'('
string|"'invalid signature'"
op|')'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'max_file_size'
op|'='
name|'int'
op|'('
name|'attributes'
op|'.'
name|'get'
op|'('
string|"'max_file_size'"
op|')'
name|'or'
number|'0'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'FormInvalid'
op|'('
string|"'max_file_size not an integer'"
op|')'
newline|'\n'
dedent|''
name|'subenv'
op|'='
name|'make_pre_authed_env'
op|'('
name|'orig_env'
op|','
string|"'PUT'"
op|','
name|'agent'
op|'='
name|'None'
op|','
nl|'\n'
name|'swift_source'
op|'='
string|"'FP'"
op|')'
newline|'\n'
name|'if'
string|"'QUERY_STRING'"
name|'in'
name|'subenv'
op|':'
newline|'\n'
indent|'            '
name|'del'
name|'subenv'
op|'['
string|"'QUERY_STRING'"
op|']'
newline|'\n'
dedent|''
name|'subenv'
op|'['
string|"'HTTP_TRANSFER_ENCODING'"
op|']'
op|'='
string|"'chunked'"
newline|'\n'
name|'subenv'
op|'['
string|"'wsgi.input'"
op|']'
op|'='
name|'_CappedFileLikeObject'
op|'('
name|'fp'
op|','
name|'max_file_size'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'subenv'
op|'['
string|"'PATH_INFO'"
op|']'
op|'.'
name|'endswith'
op|'('
string|"'/'"
op|')'
name|'and'
name|'subenv'
op|'['
string|"'PATH_INFO'"
op|']'
op|'.'
name|'count'
op|'('
string|"'/'"
op|')'
op|'<'
number|'4'
op|':'
newline|'\n'
indent|'            '
name|'subenv'
op|'['
string|"'PATH_INFO'"
op|']'
op|'+='
string|"'/'"
newline|'\n'
dedent|''
name|'subenv'
op|'['
string|"'PATH_INFO'"
op|']'
op|'+='
name|'attributes'
op|'['
string|"'filename'"
op|']'
name|'or'
string|"'filename'"
newline|'\n'
name|'if'
string|"'x_delete_at'"
name|'in'
name|'attributes'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'subenv'
op|'['
string|"'HTTP_X_DELETE_AT'"
op|']'
op|'='
name|'int'
op|'('
name|'attributes'
op|'['
string|"'x_delete_at'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'FormInvalid'
op|'('
string|"'x_delete_at not an integer: '"
nl|'\n'
string|"'Unix timestamp required.'"
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
string|"'x_delete_after'"
name|'in'
name|'attributes'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'subenv'
op|'['
string|"'HTTP_X_DELETE_AFTER'"
op|']'
op|'='
name|'int'
op|'('
nl|'\n'
name|'attributes'
op|'['
string|"'x_delete_after'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'FormInvalid'
op|'('
string|"'x_delete_after not an integer: '"
nl|'\n'
string|"'Number of seconds required.'"
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
string|"'content-type'"
name|'in'
name|'attributes'
op|':'
newline|'\n'
indent|'            '
name|'subenv'
op|'['
string|"'CONTENT_TYPE'"
op|']'
op|'='
name|'attributes'
op|'['
string|"'content-type'"
op|']'
name|'or'
string|"'application/octet-stream'"
newline|'\n'
dedent|''
name|'elif'
string|"'CONTENT_TYPE'"
name|'in'
name|'subenv'
op|':'
newline|'\n'
indent|'            '
name|'del'
name|'subenv'
op|'['
string|"'CONTENT_TYPE'"
op|']'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'int'
op|'('
name|'attributes'
op|'.'
name|'get'
op|'('
string|"'expires'"
op|')'
name|'or'
number|'0'
op|')'
op|'<'
name|'time'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'FormUnauthorized'
op|'('
string|"'form expired'"
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'FormInvalid'
op|'('
string|"'expired not an integer'"
op|')'
newline|'\n'
dedent|''
name|'hmac_body'
op|'='
string|"'%s\\n%s\\n%s\\n%s\\n%s'"
op|'%'
op|'('
nl|'\n'
name|'orig_env'
op|'['
string|"'PATH_INFO'"
op|']'
op|','
nl|'\n'
name|'attributes'
op|'.'
name|'get'
op|'('
string|"'redirect'"
op|')'
name|'or'
string|"''"
op|','
nl|'\n'
name|'attributes'
op|'.'
name|'get'
op|'('
string|"'max_file_size'"
op|')'
name|'or'
string|"'0'"
op|','
nl|'\n'
name|'attributes'
op|'.'
name|'get'
op|'('
string|"'max_file_count'"
op|')'
name|'or'
string|"'0'"
op|','
nl|'\n'
name|'attributes'
op|'.'
name|'get'
op|'('
string|"'expires'"
op|')'
name|'or'
string|"'0'"
op|')'
newline|'\n'
nl|'\n'
name|'has_valid_sig'
op|'='
name|'False'
newline|'\n'
name|'for'
name|'key'
name|'in'
name|'keys'
op|':'
newline|'\n'
indent|'            '
name|'sig'
op|'='
name|'hmac'
op|'.'
name|'new'
op|'('
name|'key'
op|','
name|'hmac_body'
op|','
name|'sha1'
op|')'
op|'.'
name|'hexdigest'
op|'('
op|')'
newline|'\n'
name|'if'
name|'streq_const_time'
op|'('
name|'sig'
op|','
op|'('
name|'attributes'
op|'.'
name|'get'
op|'('
string|"'signature'"
op|')'
name|'or'
nl|'\n'
string|"'invalid'"
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'has_valid_sig'
op|'='
name|'True'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'not'
name|'has_valid_sig'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'FormUnauthorized'
op|'('
string|"'invalid signature'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'substatus'
op|'='
op|'['
name|'None'
op|']'
newline|'\n'
name|'subheaders'
op|'='
op|'['
name|'None'
op|']'
newline|'\n'
nl|'\n'
name|'wsgi_input'
op|'='
name|'subenv'
op|'['
string|"'wsgi.input'"
op|']'
newline|'\n'
nl|'\n'
DECL|function|_start_response
name|'def'
name|'_start_response'
op|'('
name|'status'
op|','
name|'headers'
op|','
name|'exc_info'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'wsgi_input'
op|'.'
name|'file_size_exceeded'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'EOFError'
op|'('
string|'"max_file_size exceeded"'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'substatus'
op|'['
number|'0'
op|']'
op|'='
name|'status'
newline|'\n'
name|'subheaders'
op|'['
number|'0'
op|']'
op|'='
name|'headers'
newline|'\n'
nl|'\n'
dedent|''
name|'i'
op|'='
name|'iter'
op|'('
name|'self'
op|'.'
name|'app'
op|'('
name|'subenv'
op|','
name|'_start_response'
op|')'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'next'
op|'('
name|'i'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'StopIteration'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'return'
name|'substatus'
op|'['
number|'0'
op|']'
op|','
name|'subheaders'
op|'['
number|'0'
op|']'
op|','
string|"''"
newline|'\n'
nl|'\n'
DECL|member|_get_keys
dedent|''
name|'def'
name|'_get_keys'
op|'('
name|'self'
op|','
name|'env'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Returns the X-[Account|Container]-Meta-Temp-URL-Key[-2] header values\n        for the account or container, or an empty list if none are set.\n\n        Returns 0-4 elements depending on how many keys are set in the\n        account\'s or container\'s metadata.\n\n        Also validate that the request\n        path indicates a valid container; if not, no keys will be returned.\n\n        :param env: The WSGI environment for the request.\n        :returns: list of tempurl keys\n        """'
newline|'\n'
name|'parts'
op|'='
name|'env'
op|'['
string|"'PATH_INFO'"
op|']'
op|'.'
name|'split'
op|'('
string|"'/'"
op|','
number|'4'
op|')'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'parts'
op|')'
op|'<'
number|'4'
name|'or'
name|'parts'
op|'['
number|'0'
op|']'
name|'or'
name|'parts'
op|'['
number|'1'
op|']'
op|'!='
string|"'v1'"
name|'or'
name|'not'
name|'parts'
op|'['
number|'2'
op|']'
name|'or'
name|'not'
name|'parts'
op|'['
number|'3'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'['
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'account_info'
op|'='
name|'get_account_info'
op|'('
name|'env'
op|','
name|'self'
op|'.'
name|'app'
op|','
name|'swift_source'
op|'='
string|"'FP'"
op|')'
newline|'\n'
name|'account_keys'
op|'='
name|'get_tempurl_keys_from_metadata'
op|'('
name|'account_info'
op|'['
string|"'meta'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'container_info'
op|'='
name|'get_container_info'
op|'('
name|'env'
op|','
name|'self'
op|'.'
name|'app'
op|','
name|'swift_source'
op|'='
string|"'FP'"
op|')'
newline|'\n'
name|'container_keys'
op|'='
name|'get_tempurl_keys_from_metadata'
op|'('
nl|'\n'
name|'container_info'
op|'.'
name|'get'
op|'('
string|"'meta'"
op|','
op|'['
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'return'
name|'account_keys'
op|'+'
name|'container_keys'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|filter_factory
dedent|''
dedent|''
name|'def'
name|'filter_factory'
op|'('
name|'global_conf'
op|','
op|'**'
name|'local_conf'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Returns the WSGI filter for use with paste.deploy."""'
newline|'\n'
name|'conf'
op|'='
name|'global_conf'
op|'.'
name|'copy'
op|'('
op|')'
newline|'\n'
name|'conf'
op|'.'
name|'update'
op|'('
name|'local_conf'
op|')'
newline|'\n'
nl|'\n'
name|'register_swift_info'
op|'('
string|"'formpost'"
op|')'
newline|'\n'
nl|'\n'
name|'return'
name|'lambda'
name|'app'
op|':'
name|'FormPost'
op|'('
name|'app'
op|','
name|'conf'
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit

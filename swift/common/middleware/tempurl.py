begin_unit
comment|'# Copyright (c) 2011-2014 Greg Holt'
nl|'\n'
comment|'# Copyright (c) 2012-2013 John Dickinson'
nl|'\n'
comment|'# Copyright (c) 2012 Felipe Reyes'
nl|'\n'
comment|'# Copyright (c) 2012 Peter Portante'
nl|'\n'
comment|'# Copyright (c) 2012 Victor Rodionov'
nl|'\n'
comment|'# Copyright (c) 2013-2014 Samuel Merritt'
nl|'\n'
comment|'# Copyright (c) 2013 Chuck Thier'
nl|'\n'
comment|'# Copyright (c) 2013 David Goetz'
nl|'\n'
comment|'# Copyright (c) 2013 Dirk Mueller'
nl|'\n'
comment|'# Copyright (c) 2013 Donagh McCabe'
nl|'\n'
comment|'# Copyright (c) 2013 Fabien Boucher'
nl|'\n'
comment|'# Copyright (c) 2013 Greg Lange'
nl|'\n'
comment|'# Copyright (c) 2013 Kun Huang'
nl|'\n'
comment|'# Copyright (c) 2013 Richard Hawkins'
nl|'\n'
comment|'# Copyright (c) 2013 Tong Li'
nl|'\n'
comment|'# Copyright (c) 2013 ZhiQiang Fan'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
string|'"""\nTempURL Middleware\n\nAllows the creation of URLs to provide temporary access to objects.\n\nFor example, a website may wish to provide a link to download a large\nobject in Swift, but the Swift account has no public access. The\nwebsite can generate a URL that will provide GET access for a limited\ntime to the resource. When the web browser user clicks on the link,\nthe browser will download the object directly from Swift, obviating\nthe need for the website to act as a proxy for the request.\n\nIf the user were to share the link with all his friends, or\naccidentally post it on a forum, etc. the direct access would be\nlimited to the expiration time set when the website created the link.\n\n------------\nClient Usage\n------------\n\nTo create such temporary URLs, first an ``X-Account-Meta-Temp-URL-Key``\nheader must be set on the Swift account. Then, an HMAC-SHA1 (RFC 2104)\nsignature is generated using the HTTP method to allow (``GET``, ``PUT``,\n``DELETE``, etc.), the Unix timestamp the access should be allowed until,\nthe full path to the object, and the key set on the account.\n\nFor example, here is code generating the signature for a ``GET`` for 60\nseconds on ``/v1/AUTH_account/container/object``::\n\n    import hmac\n    from hashlib import sha1\n    from time import time\n    method = \'GET\'\n    expires = int(time() + 60)\n    path = \'/v1/AUTH_account/container/object\'\n    key = \'mykey\'\n    hmac_body = \'%s\\\\n%s\\\\n%s\' % (method, expires, path)\n    sig = hmac.new(key, hmac_body, sha1).hexdigest()\n\nBe certain to use the full path, from the ``/v1/`` onward.\n\nLet\'s say ``sig`` ends up equaling\n``da39a3ee5e6b4b0d3255bfef95601890afd80709`` and ``expires`` ends up\n``1323479485``. Then, for example, the website could provide a link to::\n\n    https://swift-cluster.example.com/v1/AUTH_account/container/object?\n    temp_url_sig=da39a3ee5e6b4b0d3255bfef95601890afd80709&\n    temp_url_expires=1323479485\n\nAny alteration of the resource path or query arguments would result in\n``401 Unauthorized``. Similarly, a ``PUT`` where ``GET`` was the allowed method\nwould be rejected with ``401 Unauthorized``. However, ``HEAD`` is allowed if\n``GET``, ``PUT``, or ``POST`` is allowed.\n\nUsing this in combination with browser form post translation\nmiddleware could also allow direct-from-browser uploads to specific\nlocations in Swift.\n\nTempURL supports both account and container level keys.  Each allows up to two\nkeys to be set, allowing key rotation without invalidating all existing\ntemporary URLs.  Account keys are specified by ``X-Account-Meta-Temp-URL-Key``\nand ``X-Account-Meta-Temp-URL-Key-2``, while container keys are specified by\n``X-Container-Meta-Temp-URL-Key`` and ``X-Container-Meta-Temp-URL-Key-2``.\nSignatures are checked against account and container keys, if\npresent.\n\nWith ``GET`` TempURLs, a ``Content-Disposition`` header will be set on the\nresponse so that browsers will interpret this as a file attachment to\nbe saved. The filename chosen is based on the object name, but you\ncan override this with a filename query parameter. Modifying the\nabove example::\n\n    https://swift-cluster.example.com/v1/AUTH_account/container/object?\n    temp_url_sig=da39a3ee5e6b4b0d3255bfef95601890afd80709&\n    temp_url_expires=1323479485&filename=My+Test+File.pdf\n\nIf you do not want the object to be downloaded, you can cause\n``Content-Disposition: inline`` to be set on the response by adding the\n``inline`` parameter to the query string, like so::\n\n    https://swift-cluster.example.com/v1/AUTH_account/container/object?\n    temp_url_sig=da39a3ee5e6b4b0d3255bfef95601890afd80709&\n    temp_url_expires=1323479485&inline\n\n---------------------\nCluster Configuration\n---------------------\n\nThis middleware understands the following configuration settings:\n\n``incoming_remove_headers``\n    A whitespace-delimited list of the headers to remove from\n    incoming requests. Names may optionally end with ``*`` to\n    indicate a prefix match. ``incoming_allow_headers`` is a\n    list of exceptions to these removals.\n    Default: ``x-timestamp``\n\n``incoming_allow_headers``\n    A whitespace-delimited list of the headers allowed as\n    exceptions to ``incoming_remove_headers``. Names may\n    optionally end with ``*`` to indicate a prefix match.\n\n    Default: None\n\n``outgoing_remove_headers``\n    A whitespace-delimited list of the headers to remove from\n    outgoing responses. Names may optionally end with ``*`` to\n    indicate a prefix match. ``outgoing_allow_headers`` is a\n    list of exceptions to these removals.\n\n    Default: ``x-object-meta-*``\n\n``outgoing_allow_headers``\n    A whitespace-delimited list of the headers allowed as\n    exceptions to ``outgoing_remove_headers``. Names may\n    optionally end with ``*`` to indicate a prefix match.\n\n    Default: ``x-object-meta-public-*``\n\n``methods``\n    A whitespace delimited list of request methods that are\n    allowed to be used with a temporary URL.\n\n    Default: ``GET HEAD PUT POST DELETE``\n\n"""'
newline|'\n'
nl|'\n'
DECL|variable|__all__
name|'__all__'
op|'='
op|'['
string|"'TempURL'"
op|','
string|"'filter_factory'"
op|','
nl|'\n'
string|"'DEFAULT_INCOMING_REMOVE_HEADERS'"
op|','
nl|'\n'
string|"'DEFAULT_INCOMING_ALLOW_HEADERS'"
op|','
nl|'\n'
string|"'DEFAULT_OUTGOING_REMOVE_HEADERS'"
op|','
nl|'\n'
string|"'DEFAULT_OUTGOING_ALLOW_HEADERS'"
op|']'
newline|'\n'
nl|'\n'
nl|'\n'
name|'from'
name|'os'
op|'.'
name|'path'
name|'import'
name|'basename'
newline|'\n'
name|'from'
name|'time'
name|'import'
name|'time'
newline|'\n'
nl|'\n'
name|'from'
name|'six'
op|'.'
name|'moves'
op|'.'
name|'urllib'
op|'.'
name|'parse'
name|'import'
name|'parse_qs'
newline|'\n'
name|'from'
name|'six'
op|'.'
name|'moves'
op|'.'
name|'urllib'
op|'.'
name|'parse'
name|'import'
name|'urlencode'
newline|'\n'
nl|'\n'
name|'from'
name|'swift'
op|'.'
name|'proxy'
op|'.'
name|'controllers'
op|'.'
name|'base'
name|'import'
name|'get_account_info'
op|','
name|'get_container_info'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'swob'
name|'import'
name|'HeaderKeyDict'
op|','
name|'header_to_environ_key'
op|','
name|'HTTPUnauthorized'
op|','
name|'HTTPBadRequest'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'split_path'
op|','
name|'get_valid_utf8_str'
op|','
name|'register_swift_info'
op|','
name|'get_hmac'
op|','
name|'streq_const_time'
op|','
name|'quote'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|DISALLOWED_INCOMING_HEADERS
name|'DISALLOWED_INCOMING_HEADERS'
op|'='
string|"'x-object-manifest'"
newline|'\n'
nl|'\n'
comment|'#: Default headers to remove from incoming requests. Simply a whitespace'
nl|'\n'
comment|"#: delimited list of header names and names can optionally end with '*' to"
nl|'\n'
comment|'#: indicate a prefix match. DEFAULT_INCOMING_ALLOW_HEADERS is a list of'
nl|'\n'
comment|'#: exceptions to these removals.'
nl|'\n'
DECL|variable|DEFAULT_INCOMING_REMOVE_HEADERS
name|'DEFAULT_INCOMING_REMOVE_HEADERS'
op|'='
string|"'x-timestamp'"
newline|'\n'
nl|'\n'
comment|'#: Default headers as exceptions to DEFAULT_INCOMING_REMOVE_HEADERS. Simply a'
nl|'\n'
comment|'#: whitespace delimited list of header names and names can optionally end with'
nl|'\n'
comment|"#: '*' to indicate a prefix match."
nl|'\n'
DECL|variable|DEFAULT_INCOMING_ALLOW_HEADERS
name|'DEFAULT_INCOMING_ALLOW_HEADERS'
op|'='
string|"''"
newline|'\n'
nl|'\n'
comment|'#: Default headers to remove from outgoing responses. Simply a whitespace'
nl|'\n'
comment|"#: delimited list of header names and names can optionally end with '*' to"
nl|'\n'
comment|'#: indicate a prefix match. DEFAULT_OUTGOING_ALLOW_HEADERS is a list of'
nl|'\n'
comment|'#: exceptions to these removals.'
nl|'\n'
DECL|variable|DEFAULT_OUTGOING_REMOVE_HEADERS
name|'DEFAULT_OUTGOING_REMOVE_HEADERS'
op|'='
string|"'x-object-meta-*'"
newline|'\n'
nl|'\n'
comment|'#: Default headers as exceptions to DEFAULT_OUTGOING_REMOVE_HEADERS. Simply a'
nl|'\n'
comment|'#: whitespace delimited list of header names and names can optionally end with'
nl|'\n'
comment|"#: '*' to indicate a prefix match."
nl|'\n'
DECL|variable|DEFAULT_OUTGOING_ALLOW_HEADERS
name|'DEFAULT_OUTGOING_ALLOW_HEADERS'
op|'='
string|"'x-object-meta-public-*'"
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|CONTAINER_SCOPE
name|'CONTAINER_SCOPE'
op|'='
string|"'container'"
newline|'\n'
DECL|variable|ACCOUNT_SCOPE
name|'ACCOUNT_SCOPE'
op|'='
string|"'account'"
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|get_tempurl_keys_from_metadata
name|'def'
name|'get_tempurl_keys_from_metadata'
op|'('
name|'meta'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Extracts the tempurl keys from metadata.\n\n    :param meta: account metadata\n    :returns: list of keys found (possibly empty if no keys set)\n\n    Example:\n      meta = get_account_info(...)[\'meta\']\n      keys = get_tempurl_keys_from_metadata(meta)\n    """'
newline|'\n'
name|'return'
op|'['
name|'get_valid_utf8_str'
op|'('
name|'value'
op|')'
name|'for'
name|'key'
op|','
name|'value'
name|'in'
name|'meta'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
name|'in'
op|'('
string|"'temp-url-key'"
op|','
string|"'temp-url-key-2'"
op|')'
op|']'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|disposition_format
dedent|''
name|'def'
name|'disposition_format'
op|'('
name|'filename'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'return'
string|'\'\'\'attachment; filename="%s"; filename*=UTF-8\'\'%s\'\'\''
op|'%'
op|'('
nl|'\n'
name|'quote'
op|'('
name|'filename'
op|','
name|'safe'
op|'='
string|"' /'"
op|')'
op|','
name|'quote'
op|'('
name|'filename'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|authorize_same_account
dedent|''
name|'def'
name|'authorize_same_account'
op|'('
name|'account_to_match'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|function|auth_callback_same_account
indent|'    '
name|'def'
name|'auth_callback_same_account'
op|'('
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'_ver'
op|','
name|'acc'
op|','
name|'_rest'
op|'='
name|'req'
op|'.'
name|'split_path'
op|'('
number|'2'
op|','
number|'3'
op|','
name|'True'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPUnauthorized'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'acc'
op|'=='
name|'account_to_match'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPUnauthorized'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'return'
name|'auth_callback_same_account'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|authorize_same_container
dedent|''
name|'def'
name|'authorize_same_container'
op|'('
name|'account_to_match'
op|','
name|'container_to_match'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|function|auth_callback_same_container
indent|'    '
name|'def'
name|'auth_callback_same_container'
op|'('
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'_ver'
op|','
name|'acc'
op|','
name|'con'
op|','
name|'_rest'
op|'='
name|'req'
op|'.'
name|'split_path'
op|'('
number|'3'
op|','
number|'4'
op|','
name|'True'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPUnauthorized'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'acc'
op|'=='
name|'account_to_match'
name|'and'
name|'con'
op|'=='
name|'container_to_match'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPUnauthorized'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'return'
name|'auth_callback_same_container'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|TempURL
dedent|''
name|'class'
name|'TempURL'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    WSGI Middleware to grant temporary URLs specific access to Swift\n    resources. See the overview for more information.\n\n    The proxy logs created for any subrequests made will have swift.source set\n    to "TU".\n\n    :param app: The next WSGI filter or app in the paste.deploy\n                chain.\n    :param conf: The configuration dict for the middleware.\n    """'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'app'
op|','
name|'conf'
op|')'
op|':'
newline|'\n'
comment|'#: The next WSGI application/filter in the paste.deploy pipeline.'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'app'
op|'='
name|'app'
newline|'\n'
comment|'#: The filter configuration dict.'
nl|'\n'
name|'self'
op|'.'
name|'conf'
op|'='
name|'conf'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'disallowed_headers'
op|'='
name|'set'
op|'('
nl|'\n'
name|'header_to_environ_key'
op|'('
name|'h'
op|')'
nl|'\n'
name|'for'
name|'h'
name|'in'
name|'DISALLOWED_INCOMING_HEADERS'
op|'.'
name|'split'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'headers'
op|'='
op|'['
name|'header_to_environ_key'
op|'('
name|'h'
op|')'
nl|'\n'
name|'for'
name|'h'
name|'in'
name|'conf'
op|'.'
name|'get'
op|'('
string|"'incoming_remove_headers'"
op|','
nl|'\n'
name|'DEFAULT_INCOMING_REMOVE_HEADERS'
op|'.'
name|'split'
op|'('
op|')'
op|')'
op|']'
newline|'\n'
comment|'#: Headers to remove from incoming requests. Uppercase WSGI env style,'
nl|'\n'
comment|'#: like `HTTP_X_PRIVATE`.'
nl|'\n'
name|'self'
op|'.'
name|'incoming_remove_headers'
op|'='
op|'['
name|'h'
name|'for'
name|'h'
name|'in'
name|'headers'
name|'if'
name|'h'
op|'['
op|'-'
number|'1'
op|']'
op|'!='
string|"'*'"
op|']'
newline|'\n'
comment|'#: Header with match prefixes to remove from incoming requests.'
nl|'\n'
comment|'#: Uppercase WSGI env style, like `HTTP_X_SENSITIVE_*`.'
nl|'\n'
name|'self'
op|'.'
name|'incoming_remove_headers_startswith'
op|'='
op|'['
name|'h'
op|'['
op|':'
op|'-'
number|'1'
op|']'
name|'for'
name|'h'
name|'in'
name|'headers'
name|'if'
name|'h'
op|'['
op|'-'
number|'1'
op|']'
op|'=='
string|"'*'"
op|']'
newline|'\n'
nl|'\n'
name|'headers'
op|'='
op|'['
name|'header_to_environ_key'
op|'('
name|'h'
op|')'
nl|'\n'
name|'for'
name|'h'
name|'in'
name|'conf'
op|'.'
name|'get'
op|'('
string|"'incoming_allow_headers'"
op|','
nl|'\n'
name|'DEFAULT_INCOMING_ALLOW_HEADERS'
op|'.'
name|'split'
op|'('
op|')'
op|')'
op|']'
newline|'\n'
comment|'#: Headers to allow in incoming requests. Uppercase WSGI env style,'
nl|'\n'
comment|'#: like `HTTP_X_MATCHES_REMOVE_PREFIX_BUT_OKAY`.'
nl|'\n'
name|'self'
op|'.'
name|'incoming_allow_headers'
op|'='
op|'['
name|'h'
name|'for'
name|'h'
name|'in'
name|'headers'
name|'if'
name|'h'
op|'['
op|'-'
number|'1'
op|']'
op|'!='
string|"'*'"
op|']'
newline|'\n'
comment|'#: Header with match prefixes to allow in incoming requests. Uppercase'
nl|'\n'
comment|'#: WSGI env style, like `HTTP_X_MATCHES_REMOVE_PREFIX_BUT_OKAY_*`.'
nl|'\n'
name|'self'
op|'.'
name|'incoming_allow_headers_startswith'
op|'='
op|'['
name|'h'
op|'['
op|':'
op|'-'
number|'1'
op|']'
name|'for'
name|'h'
name|'in'
name|'headers'
name|'if'
name|'h'
op|'['
op|'-'
number|'1'
op|']'
op|'=='
string|"'*'"
op|']'
newline|'\n'
nl|'\n'
name|'headers'
op|'='
op|'['
name|'h'
op|'.'
name|'title'
op|'('
op|')'
nl|'\n'
name|'for'
name|'h'
name|'in'
name|'conf'
op|'.'
name|'get'
op|'('
string|"'outgoing_remove_headers'"
op|','
nl|'\n'
name|'DEFAULT_OUTGOING_REMOVE_HEADERS'
op|'.'
name|'split'
op|'('
op|')'
op|')'
op|']'
newline|'\n'
comment|'#: Headers to remove from outgoing responses. Lowercase, like'
nl|'\n'
comment|'#: `x-account-meta-temp-url-key`.'
nl|'\n'
name|'self'
op|'.'
name|'outgoing_remove_headers'
op|'='
op|'['
name|'h'
name|'for'
name|'h'
name|'in'
name|'headers'
name|'if'
name|'h'
op|'['
op|'-'
number|'1'
op|']'
op|'!='
string|"'*'"
op|']'
newline|'\n'
comment|'#: Header with match prefixes to remove from outgoing responses.'
nl|'\n'
comment|'#: Lowercase, like `x-account-meta-private-*`.'
nl|'\n'
name|'self'
op|'.'
name|'outgoing_remove_headers_startswith'
op|'='
op|'['
name|'h'
op|'['
op|':'
op|'-'
number|'1'
op|']'
name|'for'
name|'h'
name|'in'
name|'headers'
name|'if'
name|'h'
op|'['
op|'-'
number|'1'
op|']'
op|'=='
string|"'*'"
op|']'
newline|'\n'
nl|'\n'
name|'headers'
op|'='
op|'['
name|'h'
op|'.'
name|'title'
op|'('
op|')'
nl|'\n'
name|'for'
name|'h'
name|'in'
name|'conf'
op|'.'
name|'get'
op|'('
string|"'outgoing_allow_headers'"
op|','
nl|'\n'
name|'DEFAULT_OUTGOING_ALLOW_HEADERS'
op|'.'
name|'split'
op|'('
op|')'
op|')'
op|']'
newline|'\n'
comment|'#: Headers to allow in outgoing responses. Lowercase, like'
nl|'\n'
comment|'#: `x-matches-remove-prefix-but-okay`.'
nl|'\n'
name|'self'
op|'.'
name|'outgoing_allow_headers'
op|'='
op|'['
name|'h'
name|'for'
name|'h'
name|'in'
name|'headers'
name|'if'
name|'h'
op|'['
op|'-'
number|'1'
op|']'
op|'!='
string|"'*'"
op|']'
newline|'\n'
comment|'#: Header with match prefixes to allow in outgoing responses.'
nl|'\n'
comment|'#: Lowercase, like `x-matches-remove-prefix-but-okay-*`.'
nl|'\n'
name|'self'
op|'.'
name|'outgoing_allow_headers_startswith'
op|'='
op|'['
name|'h'
op|'['
op|':'
op|'-'
number|'1'
op|']'
name|'for'
name|'h'
name|'in'
name|'headers'
name|'if'
name|'h'
op|'['
op|'-'
number|'1'
op|']'
op|'=='
string|"'*'"
op|']'
newline|'\n'
comment|'#: HTTP user agent to use for subrequests.'
nl|'\n'
name|'self'
op|'.'
name|'agent'
op|'='
string|"'%(orig)s TempURL'"
newline|'\n'
nl|'\n'
DECL|member|__call__
dedent|''
name|'def'
name|'__call__'
op|'('
name|'self'
op|','
name|'env'
op|','
name|'start_response'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Main hook into the WSGI paste.deploy filter/app pipeline.\n\n        :param env: The WSGI environment dict.\n        :param start_response: The WSGI start_response hook.\n        :returns: Response as per WSGI.\n        """'
newline|'\n'
name|'if'
name|'env'
op|'['
string|"'REQUEST_METHOD'"
op|']'
op|'=='
string|"'OPTIONS'"
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'app'
op|'('
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
dedent|''
name|'info'
op|'='
name|'self'
op|'.'
name|'_get_temp_url_info'
op|'('
name|'env'
op|')'
newline|'\n'
name|'temp_url_sig'
op|','
name|'temp_url_expires'
op|','
name|'filename'
op|','
name|'inline_disposition'
op|'='
name|'info'
newline|'\n'
name|'if'
name|'temp_url_sig'
name|'is'
name|'None'
name|'and'
name|'temp_url_expires'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'app'
op|'('
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'temp_url_sig'
name|'or'
name|'not'
name|'temp_url_expires'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'_invalid'
op|'('
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
dedent|''
name|'account'
op|','
name|'container'
op|'='
name|'self'
op|'.'
name|'_get_account_and_container'
op|'('
name|'env'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'account'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'_invalid'
op|'('
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
dedent|''
name|'keys'
op|'='
name|'self'
op|'.'
name|'_get_keys'
op|'('
name|'env'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'keys'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'_invalid'
op|'('
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'env'
op|'['
string|"'REQUEST_METHOD'"
op|']'
op|'=='
string|"'HEAD'"
op|':'
newline|'\n'
indent|'            '
name|'hmac_vals'
op|'='
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_get_hmacs'
op|'('
name|'env'
op|','
name|'temp_url_expires'
op|','
name|'keys'
op|')'
op|'+'
nl|'\n'
name|'self'
op|'.'
name|'_get_hmacs'
op|'('
name|'env'
op|','
name|'temp_url_expires'
op|','
name|'keys'
op|','
nl|'\n'
name|'request_method'
op|'='
string|"'GET'"
op|')'
op|'+'
nl|'\n'
name|'self'
op|'.'
name|'_get_hmacs'
op|'('
name|'env'
op|','
name|'temp_url_expires'
op|','
name|'keys'
op|','
nl|'\n'
name|'request_method'
op|'='
string|"'POST'"
op|')'
op|'+'
nl|'\n'
name|'self'
op|'.'
name|'_get_hmacs'
op|'('
name|'env'
op|','
name|'temp_url_expires'
op|','
name|'keys'
op|','
nl|'\n'
name|'request_method'
op|'='
string|"'PUT'"
op|')'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'hmac_vals'
op|'='
name|'self'
op|'.'
name|'_get_hmacs'
op|'('
name|'env'
op|','
name|'temp_url_expires'
op|','
name|'keys'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'is_valid_hmac'
op|'='
name|'False'
newline|'\n'
name|'hmac_scope'
op|'='
name|'None'
newline|'\n'
name|'for'
name|'hmac'
op|','
name|'scope'
name|'in'
name|'hmac_vals'
op|':'
newline|'\n'
comment|"# While it's true that we short-circuit, this doesn't affect the"
nl|'\n'
comment|'# timing-attack resistance since the only way this will'
nl|'\n'
comment|'# short-circuit is when a valid signature is passed in.'
nl|'\n'
indent|'            '
name|'if'
name|'streq_const_time'
op|'('
name|'temp_url_sig'
op|','
name|'hmac'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'is_valid_hmac'
op|'='
name|'True'
newline|'\n'
name|'hmac_scope'
op|'='
name|'scope'
newline|'\n'
name|'break'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'not'
name|'is_valid_hmac'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'_invalid'
op|'('
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
comment|'# disallowed headers prevent accidently allowing upload of a pointer'
nl|'\n'
comment|'# to data that the PUT tempurl would not otherwise allow access for.'
nl|'\n'
comment|'# It should be safe to provide a GET tempurl for data that an'
nl|'\n'
comment|'# untrusted client just uploaded with a PUT tempurl.'
nl|'\n'
dedent|''
name|'resp'
op|'='
name|'self'
op|'.'
name|'_clean_disallowed_headers'
op|'('
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
name|'if'
name|'resp'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'resp'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_clean_incoming_headers'
op|'('
name|'env'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'hmac_scope'
op|'=='
name|'ACCOUNT_SCOPE'
op|':'
newline|'\n'
indent|'            '
name|'env'
op|'['
string|"'swift.authorize'"
op|']'
op|'='
name|'authorize_same_account'
op|'('
name|'account'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'env'
op|'['
string|"'swift.authorize'"
op|']'
op|'='
name|'authorize_same_container'
op|'('
name|'account'
op|','
nl|'\n'
name|'container'
op|')'
newline|'\n'
dedent|''
name|'env'
op|'['
string|"'swift.authorize_override'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'env'
op|'['
string|"'REMOTE_USER'"
op|']'
op|'='
string|"'.wsgi.tempurl'"
newline|'\n'
name|'qs'
op|'='
op|'{'
string|"'temp_url_sig'"
op|':'
name|'temp_url_sig'
op|','
nl|'\n'
string|"'temp_url_expires'"
op|':'
name|'temp_url_expires'
op|'}'
newline|'\n'
name|'if'
name|'filename'
op|':'
newline|'\n'
indent|'            '
name|'qs'
op|'['
string|"'filename'"
op|']'
op|'='
name|'filename'
newline|'\n'
dedent|''
name|'env'
op|'['
string|"'QUERY_STRING'"
op|']'
op|'='
name|'urlencode'
op|'('
name|'qs'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_start_response
name|'def'
name|'_start_response'
op|'('
name|'status'
op|','
name|'headers'
op|','
name|'exc_info'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'headers'
op|'='
name|'self'
op|'.'
name|'_clean_outgoing_headers'
op|'('
name|'headers'
op|')'
newline|'\n'
name|'if'
name|'env'
op|'['
string|"'REQUEST_METHOD'"
op|']'
op|'=='
string|"'GET'"
name|'and'
name|'status'
op|'['
number|'0'
op|']'
op|'=='
string|"'2'"
op|':'
newline|'\n'
comment|'# figure out the right value for content-disposition'
nl|'\n'
comment|'# 1) use the value from the query string'
nl|'\n'
comment|'# 2) use the value from the object metadata'
nl|'\n'
comment|'# 3) use the object name (default)'
nl|'\n'
indent|'                '
name|'out_headers'
op|'='
op|'['
op|']'
newline|'\n'
name|'existing_disposition'
op|'='
name|'None'
newline|'\n'
name|'for'
name|'h'
op|','
name|'v'
name|'in'
name|'headers'
op|':'
newline|'\n'
indent|'                    '
name|'if'
name|'h'
op|'.'
name|'lower'
op|'('
op|')'
op|'!='
string|"'content-disposition'"
op|':'
newline|'\n'
indent|'                        '
name|'out_headers'
op|'.'
name|'append'
op|'('
op|'('
name|'h'
op|','
name|'v'
op|')'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                        '
name|'existing_disposition'
op|'='
name|'v'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'inline_disposition'
op|':'
newline|'\n'
indent|'                    '
name|'disposition_value'
op|'='
string|"'inline'"
newline|'\n'
dedent|''
name|'elif'
name|'filename'
op|':'
newline|'\n'
indent|'                    '
name|'disposition_value'
op|'='
name|'disposition_format'
op|'('
name|'filename'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'existing_disposition'
op|':'
newline|'\n'
indent|'                    '
name|'disposition_value'
op|'='
name|'existing_disposition'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'name'
op|'='
name|'basename'
op|'('
name|'env'
op|'['
string|"'PATH_INFO'"
op|']'
op|'.'
name|'rstrip'
op|'('
string|"'/'"
op|')'
op|')'
newline|'\n'
name|'disposition_value'
op|'='
name|'disposition_format'
op|'('
name|'name'
op|')'
newline|'\n'
comment|"# this is probably just paranoia, I couldn't actually get a"
nl|'\n'
comment|'# newline into existing_disposition'
nl|'\n'
dedent|''
name|'value'
op|'='
name|'disposition_value'
op|'.'
name|'replace'
op|'('
string|"'\\n'"
op|','
string|"'%0A'"
op|')'
newline|'\n'
name|'out_headers'
op|'.'
name|'append'
op|'('
op|'('
string|"'Content-Disposition'"
op|','
name|'value'
op|')'
op|')'
newline|'\n'
name|'headers'
op|'='
name|'out_headers'
newline|'\n'
dedent|''
name|'return'
name|'start_response'
op|'('
name|'status'
op|','
name|'headers'
op|','
name|'exc_info'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'app'
op|'('
name|'env'
op|','
name|'_start_response'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_account_and_container
dedent|''
name|'def'
name|'_get_account_and_container'
op|'('
name|'self'
op|','
name|'env'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Returns just the account and container for the request, if it\'s an\n        object request and one of the configured methods; otherwise, None is\n        returned.\n\n        :param env: The WSGI environment for the request.\n        :returns: (Account str, container str) or (None, None).\n        """'
newline|'\n'
name|'if'
name|'env'
op|'['
string|"'REQUEST_METHOD'"
op|']'
name|'in'
name|'self'
op|'.'
name|'conf'
op|'['
string|"'methods'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'ver'
op|','
name|'acc'
op|','
name|'cont'
op|','
name|'obj'
op|'='
name|'split_path'
op|'('
name|'env'
op|'['
string|"'PATH_INFO'"
op|']'
op|','
number|'4'
op|','
number|'4'
op|','
name|'True'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'('
name|'None'
op|','
name|'None'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'ver'
op|'=='
string|"'v1'"
name|'and'
name|'obj'
op|'.'
name|'strip'
op|'('
string|"'/'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'('
name|'acc'
op|','
name|'cont'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
op|'('
name|'None'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_temp_url_info
dedent|''
name|'def'
name|'_get_temp_url_info'
op|'('
name|'self'
op|','
name|'env'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Returns the provided temporary URL parameters (sig, expires),\n        if given and syntactically valid. Either sig or expires could\n        be None if not provided. If provided, expires is also\n        converted to an int if possible or 0 if not, and checked for\n        expiration (returns 0 if expired).\n\n        :param env: The WSGI environment for the request.\n        :returns: (sig, expires, filename, inline) as described above.\n        """'
newline|'\n'
name|'temp_url_sig'
op|'='
name|'temp_url_expires'
op|'='
name|'filename'
op|'='
name|'inline'
op|'='
name|'None'
newline|'\n'
name|'qs'
op|'='
name|'parse_qs'
op|'('
name|'env'
op|'.'
name|'get'
op|'('
string|"'QUERY_STRING'"
op|','
string|"''"
op|')'
op|','
name|'keep_blank_values'
op|'='
name|'True'
op|')'
newline|'\n'
name|'if'
string|"'temp_url_sig'"
name|'in'
name|'qs'
op|':'
newline|'\n'
indent|'            '
name|'temp_url_sig'
op|'='
name|'qs'
op|'['
string|"'temp_url_sig'"
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
dedent|''
name|'if'
string|"'temp_url_expires'"
name|'in'
name|'qs'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'temp_url_expires'
op|'='
name|'int'
op|'('
name|'qs'
op|'['
string|"'temp_url_expires'"
op|']'
op|'['
number|'0'
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'                '
name|'temp_url_expires'
op|'='
number|'0'
newline|'\n'
dedent|''
name|'if'
name|'temp_url_expires'
op|'<'
name|'time'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'temp_url_expires'
op|'='
number|'0'
newline|'\n'
dedent|''
dedent|''
name|'if'
string|"'filename'"
name|'in'
name|'qs'
op|':'
newline|'\n'
indent|'            '
name|'filename'
op|'='
name|'qs'
op|'['
string|"'filename'"
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
dedent|''
name|'if'
string|"'inline'"
name|'in'
name|'qs'
op|':'
newline|'\n'
indent|'            '
name|'inline'
op|'='
name|'True'
newline|'\n'
dedent|''
name|'return'
name|'temp_url_sig'
op|','
name|'temp_url_expires'
op|','
name|'filename'
op|','
name|'inline'
newline|'\n'
nl|'\n'
DECL|member|_get_keys
dedent|''
name|'def'
name|'_get_keys'
op|'('
name|'self'
op|','
name|'env'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Returns the X-[Account|Container]-Meta-Temp-URL-Key[-2] header values\n        for the account or container, or an empty list if none are set. Each\n        value comes as a 2-tuple (key, scope), where scope is either\n        CONTAINER_SCOPE or ACCOUNT_SCOPE.\n\n        Returns 0-4 elements depending on how many keys are set in the\n        account\'s or container\'s metadata.\n\n        :param env: The WSGI environment for the request.\n        :returns: [\n            (X-Account-Meta-Temp-URL-Key str value, ACCOUNT_SCOPE) if set,\n            (X-Account-Meta-Temp-URL-Key-2 str value, ACCOUNT_SCOPE if set,\n            (X-Container-Meta-Temp-URL-Key str value, CONTAINER_SCOPE) if set,\n            (X-Container-Meta-Temp-URL-Key-2 str value, CONTAINER_SCOPE if set,\n        ]\n        """'
newline|'\n'
name|'account_info'
op|'='
name|'get_account_info'
op|'('
name|'env'
op|','
name|'self'
op|'.'
name|'app'
op|','
name|'swift_source'
op|'='
string|"'TU'"
op|')'
newline|'\n'
name|'account_keys'
op|'='
name|'get_tempurl_keys_from_metadata'
op|'('
name|'account_info'
op|'['
string|"'meta'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'container_info'
op|'='
name|'get_container_info'
op|'('
name|'env'
op|','
name|'self'
op|'.'
name|'app'
op|','
name|'swift_source'
op|'='
string|"'TU'"
op|')'
newline|'\n'
name|'container_keys'
op|'='
name|'get_tempurl_keys_from_metadata'
op|'('
nl|'\n'
name|'container_info'
op|'.'
name|'get'
op|'('
string|"'meta'"
op|','
op|'['
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'return'
op|'('
op|'['
op|'('
name|'ak'
op|','
name|'ACCOUNT_SCOPE'
op|')'
name|'for'
name|'ak'
name|'in'
name|'account_keys'
op|']'
op|'+'
nl|'\n'
op|'['
op|'('
name|'ck'
op|','
name|'CONTAINER_SCOPE'
op|')'
name|'for'
name|'ck'
name|'in'
name|'container_keys'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_hmacs
dedent|''
name|'def'
name|'_get_hmacs'
op|'('
name|'self'
op|','
name|'env'
op|','
name|'expires'
op|','
name|'scoped_keys'
op|','
name|'request_method'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        :param env: The WSGI environment for the request.\n        :param expires: Unix timestamp as an int for when the URL\n                        expires.\n        :param scoped_keys: (key, scope) tuples like _get_keys() returns\n        :param request_method: Optional override of the request in\n                               the WSGI env. For example, if a HEAD\n                               does not match, you may wish to\n                               override with GET to still allow the\n                               HEAD.\n\n        :returns: a list of (hmac, scope) 2-tuples\n        """'
newline|'\n'
name|'if'
name|'not'
name|'request_method'
op|':'
newline|'\n'
indent|'            '
name|'request_method'
op|'='
name|'env'
op|'['
string|"'REQUEST_METHOD'"
op|']'
newline|'\n'
dedent|''
name|'return'
op|'['
nl|'\n'
op|'('
name|'get_hmac'
op|'('
name|'request_method'
op|','
name|'env'
op|'['
string|"'PATH_INFO'"
op|']'
op|','
name|'expires'
op|','
name|'key'
op|')'
op|','
name|'scope'
op|')'
nl|'\n'
name|'for'
op|'('
name|'key'
op|','
name|'scope'
op|')'
name|'in'
name|'scoped_keys'
op|']'
newline|'\n'
nl|'\n'
DECL|member|_invalid
dedent|''
name|'def'
name|'_invalid'
op|'('
name|'self'
op|','
name|'env'
op|','
name|'start_response'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Performs the necessary steps to indicate a WSGI 401\n        Unauthorized response to the request.\n\n        :param env: The WSGI environment for the request.\n        :param start_response: The WSGI start_response hook.\n        :returns: 401 response as per WSGI.\n        """'
newline|'\n'
name|'if'
name|'env'
op|'['
string|"'REQUEST_METHOD'"
op|']'
op|'=='
string|"'HEAD'"
op|':'
newline|'\n'
indent|'            '
name|'body'
op|'='
name|'None'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'body'
op|'='
string|"'401 Unauthorized: Temp URL invalid\\n'"
newline|'\n'
dedent|''
name|'return'
name|'HTTPUnauthorized'
op|'('
name|'body'
op|'='
name|'body'
op|')'
op|'('
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_clean_disallowed_headers
dedent|''
name|'def'
name|'_clean_disallowed_headers'
op|'('
name|'self'
op|','
name|'env'
op|','
name|'start_response'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Validate the absense of disallowed headers for "unsafe" operations.\n\n        :returns: None for safe operations or swob.HTTPBadResponse if the\n                  request includes disallowed headers.\n        """'
newline|'\n'
name|'if'
name|'env'
op|'['
string|"'REQUEST_METHOD'"
op|']'
name|'in'
op|'('
string|"'GET'"
op|','
string|"'HEAD'"
op|','
string|"'OPTIONS'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
newline|'\n'
dedent|''
name|'for'
name|'h'
name|'in'
name|'env'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'h'
name|'in'
name|'self'
op|'.'
name|'disallowed_headers'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPBadRequest'
op|'('
nl|'\n'
name|'body'
op|'='
string|"'The header %r is not allowed in this tempurl'"
op|'%'
nl|'\n'
name|'h'
op|'['
name|'len'
op|'('
string|"'HTTP_'"
op|')'
op|':'
op|']'
op|'.'
name|'title'
op|'('
op|')'
op|'.'
name|'replace'
op|'('
string|"'_'"
op|','
string|"'-'"
op|')'
op|')'
op|'('
nl|'\n'
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_clean_incoming_headers
dedent|''
dedent|''
dedent|''
name|'def'
name|'_clean_incoming_headers'
op|'('
name|'self'
op|','
name|'env'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Removes any headers from the WSGI environment as per the\n        middleware configuration for incoming requests.\n\n        :param env: The WSGI environment for the request.\n        """'
newline|'\n'
name|'for'
name|'h'
name|'in'
name|'env'
op|'.'
name|'keys'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'h'
name|'in'
name|'self'
op|'.'
name|'incoming_allow_headers'
op|':'
newline|'\n'
indent|'                '
name|'continue'
newline|'\n'
dedent|''
name|'for'
name|'p'
name|'in'
name|'self'
op|'.'
name|'incoming_allow_headers_startswith'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'h'
op|'.'
name|'startswith'
op|'('
name|'p'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'break'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'h'
name|'in'
name|'self'
op|'.'
name|'incoming_remove_headers'
op|':'
newline|'\n'
indent|'                    '
name|'del'
name|'env'
op|'['
name|'h'
op|']'
newline|'\n'
name|'continue'
newline|'\n'
dedent|''
name|'for'
name|'p'
name|'in'
name|'self'
op|'.'
name|'incoming_remove_headers_startswith'
op|':'
newline|'\n'
indent|'                    '
name|'if'
name|'h'
op|'.'
name|'startswith'
op|'('
name|'p'
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'del'
name|'env'
op|'['
name|'h'
op|']'
newline|'\n'
name|'break'
newline|'\n'
nl|'\n'
DECL|member|_clean_outgoing_headers
dedent|''
dedent|''
dedent|''
dedent|''
dedent|''
name|'def'
name|'_clean_outgoing_headers'
op|'('
name|'self'
op|','
name|'headers'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Removes any headers as per the middleware configuration for\n        outgoing responses.\n\n        :param headers: A WSGI start_response style list of headers,\n                        [(\'header1\', \'value), (\'header2\', \'value),\n                         ...]\n        :returns: The same headers list, but with some headers\n                  removed as per the middlware configuration for\n                  outgoing responses.\n        """'
newline|'\n'
name|'headers'
op|'='
name|'HeaderKeyDict'
op|'('
name|'headers'
op|')'
newline|'\n'
name|'for'
name|'h'
name|'in'
name|'headers'
op|'.'
name|'keys'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'h'
name|'in'
name|'self'
op|'.'
name|'outgoing_allow_headers'
op|':'
newline|'\n'
indent|'                '
name|'continue'
newline|'\n'
dedent|''
name|'for'
name|'p'
name|'in'
name|'self'
op|'.'
name|'outgoing_allow_headers_startswith'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'h'
op|'.'
name|'startswith'
op|'('
name|'p'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'break'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'h'
name|'in'
name|'self'
op|'.'
name|'outgoing_remove_headers'
op|':'
newline|'\n'
indent|'                    '
name|'del'
name|'headers'
op|'['
name|'h'
op|']'
newline|'\n'
name|'continue'
newline|'\n'
dedent|''
name|'for'
name|'p'
name|'in'
name|'self'
op|'.'
name|'outgoing_remove_headers_startswith'
op|':'
newline|'\n'
indent|'                    '
name|'if'
name|'h'
op|'.'
name|'startswith'
op|'('
name|'p'
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'del'
name|'headers'
op|'['
name|'h'
op|']'
newline|'\n'
name|'break'
newline|'\n'
dedent|''
dedent|''
dedent|''
dedent|''
name|'return'
name|'headers'
op|'.'
name|'items'
op|'('
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|filter_factory
dedent|''
dedent|''
name|'def'
name|'filter_factory'
op|'('
name|'global_conf'
op|','
op|'**'
name|'local_conf'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Returns the WSGI filter for use with paste.deploy."""'
newline|'\n'
name|'conf'
op|'='
name|'global_conf'
op|'.'
name|'copy'
op|'('
op|')'
newline|'\n'
name|'conf'
op|'.'
name|'update'
op|'('
name|'local_conf'
op|')'
newline|'\n'
nl|'\n'
name|'defaults'
op|'='
op|'{'
nl|'\n'
string|"'methods'"
op|':'
string|"'GET HEAD PUT POST DELETE'"
op|','
nl|'\n'
string|"'incoming_remove_headers'"
op|':'
name|'DEFAULT_INCOMING_REMOVE_HEADERS'
op|','
nl|'\n'
string|"'incoming_allow_headers'"
op|':'
name|'DEFAULT_INCOMING_ALLOW_HEADERS'
op|','
nl|'\n'
string|"'outgoing_remove_headers'"
op|':'
name|'DEFAULT_OUTGOING_REMOVE_HEADERS'
op|','
nl|'\n'
string|"'outgoing_allow_headers'"
op|':'
name|'DEFAULT_OUTGOING_ALLOW_HEADERS'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'info_conf'
op|'='
op|'{'
name|'k'
op|':'
name|'conf'
op|'.'
name|'get'
op|'('
name|'k'
op|','
name|'v'
op|')'
op|'.'
name|'split'
op|'('
op|')'
name|'for'
name|'k'
op|','
name|'v'
name|'in'
name|'defaults'
op|'.'
name|'items'
op|'('
op|')'
op|'}'
newline|'\n'
name|'register_swift_info'
op|'('
string|"'tempurl'"
op|','
op|'**'
name|'info_conf'
op|')'
newline|'\n'
name|'conf'
op|'.'
name|'update'
op|'('
name|'info_conf'
op|')'
newline|'\n'
nl|'\n'
name|'return'
name|'lambda'
name|'app'
op|':'
name|'TempURL'
op|'('
name|'app'
op|','
name|'conf'
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit

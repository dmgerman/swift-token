begin_unit
comment|'# Copyright (c) 2010 OpenStack, LLC.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
name|'from'
name|'__future__'
name|'import'
name|'with_statement'
newline|'\n'
name|'import'
name|'errno'
newline|'\n'
name|'import'
name|'mimetypes'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'socket'
newline|'\n'
name|'import'
name|'time'
newline|'\n'
name|'from'
name|'ConfigParser'
name|'import'
name|'ConfigParser'
op|','
name|'NoOptionError'
newline|'\n'
name|'from'
name|'urllib'
name|'import'
name|'unquote'
op|','
name|'quote'
newline|'\n'
name|'import'
name|'uuid'
newline|'\n'
name|'import'
name|'sys'
newline|'\n'
name|'import'
name|'functools'
newline|'\n'
nl|'\n'
name|'from'
name|'eventlet'
op|'.'
name|'timeout'
name|'import'
name|'Timeout'
newline|'\n'
name|'from'
name|'webob'
op|'.'
name|'exc'
name|'import'
name|'HTTPAccepted'
op|','
name|'HTTPBadRequest'
op|','
name|'HTTPConflict'
op|','
name|'HTTPCreated'
op|','
name|'HTTPLengthRequired'
op|','
name|'HTTPMethodNotAllowed'
op|','
name|'HTTPNoContent'
op|','
name|'HTTPNotFound'
op|','
name|'HTTPNotModified'
op|','
name|'HTTPPreconditionFailed'
op|','
name|'HTTPRequestTimeout'
op|','
name|'HTTPServiceUnavailable'
op|','
name|'HTTPUnauthorized'
op|','
name|'HTTPUnprocessableEntity'
op|','
name|'HTTPRequestEntityTooLarge'
op|','
name|'HTTPServerError'
op|','
name|'status_map'
newline|'\n'
name|'from'
name|'webob'
name|'import'
name|'Request'
op|','
name|'Response'
newline|'\n'
nl|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'ring'
name|'import'
name|'Ring'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'get_logger'
op|','
name|'normalize_timestamp'
op|','
name|'split_path'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'bufferedhttp'
name|'import'
name|'http_connect'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'healthcheck'
name|'import'
name|'HealthCheckController'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'constraints'
name|'import'
name|'check_object_creation'
op|','
name|'check_metadata'
op|','
name|'MAX_FILE_SIZE'
op|','
name|'check_xml_encodable'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'exceptions'
name|'import'
name|'ChunkReadTimeout'
op|','
name|'ChunkWriteTimeout'
op|','
name|'ConnectionTimeout'
newline|'\n'
nl|'\n'
DECL|variable|MAX_CONTAINER_NAME_LENGTH
name|'MAX_CONTAINER_NAME_LENGTH'
op|'='
number|'256'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|update_headers
name|'def'
name|'update_headers'
op|'('
name|'response'
op|','
name|'headers'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Helper function to update headers in the response.\n\n    :param response: webob.Response object\n    :param headers: dictionary headers\n    """'
newline|'\n'
name|'if'
name|'hasattr'
op|'('
name|'headers'
op|','
string|"'items'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'headers'
op|'='
name|'headers'
op|'.'
name|'items'
op|'('
op|')'
newline|'\n'
dedent|''
name|'for'
name|'name'
op|','
name|'value'
name|'in'
name|'headers'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'name'
op|'=='
string|"'etag'"
op|':'
newline|'\n'
indent|'            '
name|'response'
op|'.'
name|'headers'
op|'['
name|'name'
op|']'
op|'='
name|'value'
op|'.'
name|'replace'
op|'('
string|'\'"\''
op|','
string|"''"
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'name'
name|'not'
name|'in'
op|'('
string|"'date'"
op|','
string|"'content-length'"
op|','
string|"'content-type'"
op|','
nl|'\n'
string|"'connection'"
op|','
string|"'x-timestamp'"
op|','
string|"'x-put-timestamp'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'response'
op|'.'
name|'headers'
op|'['
name|'name'
op|']'
op|'='
name|'value'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|public
dedent|''
dedent|''
dedent|''
name|'def'
name|'public'
op|'('
name|'func'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Decorator to declare which methods are public accessible as HTTP requests\n\n    :param func: function to make public\n    """'
newline|'\n'
name|'func'
op|'.'
name|'publicly_accessible'
op|'='
name|'True'
newline|'\n'
nl|'\n'
op|'@'
name|'functools'
op|'.'
name|'wraps'
op|'('
name|'func'
op|')'
newline|'\n'
DECL|function|wrapped
name|'def'
name|'wrapped'
op|'('
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'func'
op|'('
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'wrapped'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|Controller
dedent|''
name|'class'
name|'Controller'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Base WSGI controller class for the proxy"""'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'app'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'account_name'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'app'
op|'='
name|'app'
newline|'\n'
name|'self'
op|'.'
name|'trans_id'
op|'='
string|"'-'"
newline|'\n'
nl|'\n'
DECL|member|error_increment
dedent|''
name|'def'
name|'error_increment'
op|'('
name|'self'
op|','
name|'node'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Handles incrementing error counts when talking to nodes.\n\n        :param node: dictionary of node to increment the error count for\n        """'
newline|'\n'
name|'node'
op|'['
string|"'errors'"
op|']'
op|'='
name|'node'
op|'.'
name|'get'
op|'('
string|"'errors'"
op|','
number|'0'
op|')'
op|'+'
number|'1'
newline|'\n'
name|'node'
op|'['
string|"'last_error'"
op|']'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|error_occurred
dedent|''
name|'def'
name|'error_occurred'
op|'('
name|'self'
op|','
name|'node'
op|','
name|'msg'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Handle logging, and handling of errors.\n\n        :param node: dictionary of node to handle errors for\n        :param msg: error message\n        """'
newline|'\n'
name|'self'
op|'.'
name|'error_increment'
op|'('
name|'node'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'('
nl|'\n'
string|"'%s %s:%s'"
op|'%'
op|'('
name|'msg'
op|','
name|'node'
op|'['
string|"'ip'"
op|']'
op|','
name|'node'
op|'['
string|"'port'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|exception_occurred
dedent|''
name|'def'
name|'exception_occurred'
op|'('
name|'self'
op|','
name|'node'
op|','
name|'typ'
op|','
name|'additional_info'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Handle logging of generic exceptions.\n\n        :param node: dictionary of node to log the error for\n        :param typ: server type\n        :param additional_info: additional information to log\n        """'
newline|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'exception'
op|'('
nl|'\n'
string|"'ERROR with %s server %s:%s/%s transaction %s re: %s'"
op|'%'
op|'('
name|'typ'
op|','
nl|'\n'
name|'node'
op|'['
string|"'ip'"
op|']'
op|','
name|'node'
op|'['
string|"'port'"
op|']'
op|','
name|'node'
op|'['
string|"'device'"
op|']'
op|','
name|'self'
op|'.'
name|'trans_id'
op|','
nl|'\n'
name|'additional_info'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|error_limited
dedent|''
name|'def'
name|'error_limited'
op|'('
name|'self'
op|','
name|'node'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Check if the node is currently error limited.\n\n        :param node: dictionary of node to check\n        :returns: True if error limited, False otherwise\n        """'
newline|'\n'
name|'now'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'if'
name|'not'
string|"'errors'"
name|'in'
name|'node'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'False'
newline|'\n'
dedent|''
name|'if'
string|"'last_error'"
name|'in'
name|'node'
name|'and'
name|'node'
op|'['
string|"'last_error'"
op|']'
op|'<'
name|'now'
op|'-'
name|'self'
op|'.'
name|'app'
op|'.'
name|'error_suppression_interval'
op|':'
newline|'\n'
indent|'            '
name|'del'
name|'node'
op|'['
string|"'last_error'"
op|']'
newline|'\n'
name|'if'
string|"'errors'"
name|'in'
name|'node'
op|':'
newline|'\n'
indent|'                '
name|'del'
name|'node'
op|'['
string|"'errors'"
op|']'
newline|'\n'
dedent|''
name|'return'
name|'False'
newline|'\n'
dedent|''
name|'limited'
op|'='
name|'node'
op|'['
string|"'errors'"
op|']'
op|'>'
name|'self'
op|'.'
name|'app'
op|'.'
name|'error_suppression_limit'
newline|'\n'
name|'if'
name|'limited'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'debug'
op|'('
nl|'\n'
string|"'Node error limited %s:%s (%s)'"
op|'%'
op|'('
nl|'\n'
name|'node'
op|'['
string|"'ip'"
op|']'
op|','
name|'node'
op|'['
string|"'port'"
op|']'
op|','
name|'node'
op|'['
string|"'device'"
op|']'
op|')'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'limited'
newline|'\n'
nl|'\n'
DECL|member|error_limit
dedent|''
name|'def'
name|'error_limit'
op|'('
name|'self'
op|','
name|'node'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Mark a node as error limited.\n\n        :param node: dictionary of node to error limit\n        """'
newline|'\n'
name|'node'
op|'['
string|"'errors'"
op|']'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'error_suppression_limit'
op|'+'
number|'1'
newline|'\n'
name|'node'
op|'['
string|"'last_error'"
op|']'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|account_info
dedent|''
name|'def'
name|'account_info'
op|'('
name|'self'
op|','
name|'account'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Get account information, and also verify that the account exists.\n\n        :param account: name of the account to get the info for\n        :returns: tuple of (account partition, account nodes) or (None, None)\n                  if it does not exist\n        """'
newline|'\n'
name|'partition'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|'.'
name|'get_nodes'
op|'('
name|'account'
op|')'
newline|'\n'
name|'path'
op|'='
string|"'/%s'"
op|'%'
name|'account'
newline|'\n'
name|'cache_key'
op|'='
string|"'account%s'"
op|'%'
name|'path'
newline|'\n'
comment|'# 0 = no responses, 200 = found, 404 = not found, -1 = mixed responses'
nl|'\n'
name|'if'
name|'self'
op|'.'
name|'app'
op|'.'
name|'memcache'
op|'.'
name|'get'
op|'('
name|'cache_key'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'partition'
op|','
name|'nodes'
newline|'\n'
dedent|''
name|'result_code'
op|'='
number|'0'
newline|'\n'
name|'attempts_left'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|'.'
name|'replica_count'
newline|'\n'
name|'headers'
op|'='
op|'{'
string|"'x-cf-trans-id'"
op|':'
name|'self'
op|'.'
name|'trans_id'
op|'}'
newline|'\n'
name|'for'
name|'node'
name|'in'
name|'self'
op|'.'
name|'iter_nodes'
op|'('
name|'partition'
op|','
name|'nodes'
op|','
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'self'
op|'.'
name|'error_limited'
op|'('
name|'node'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'continue'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'with'
name|'ConnectionTimeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'conn_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'conn'
op|'='
name|'http_connect'
op|'('
name|'node'
op|'['
string|"'ip'"
op|']'
op|','
name|'node'
op|'['
string|"'port'"
op|']'
op|','
nl|'\n'
name|'node'
op|'['
string|"'device'"
op|']'
op|','
name|'partition'
op|','
string|"'HEAD'"
op|','
name|'path'
op|','
name|'headers'
op|')'
newline|'\n'
dedent|''
name|'with'
name|'Timeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'node_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'resp'
op|'='
name|'conn'
op|'.'
name|'getresponse'
op|'('
op|')'
newline|'\n'
name|'body'
op|'='
name|'resp'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'if'
number|'200'
op|'<='
name|'resp'
op|'.'
name|'status'
op|'<='
number|'299'
op|':'
newline|'\n'
indent|'                        '
name|'result_code'
op|'='
number|'200'
newline|'\n'
name|'break'
newline|'\n'
dedent|''
name|'elif'
name|'resp'
op|'.'
name|'status'
op|'=='
number|'404'
op|':'
newline|'\n'
indent|'                        '
name|'result_code'
op|'='
number|'404'
name|'if'
name|'not'
name|'result_code'
name|'else'
op|'-'
number|'1'
newline|'\n'
dedent|''
name|'elif'
name|'resp'
op|'.'
name|'status'
op|'=='
number|'507'
op|':'
newline|'\n'
indent|'                        '
name|'self'
op|'.'
name|'error_limit'
op|'('
name|'node'
op|')'
newline|'\n'
name|'continue'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                        '
name|'result_code'
op|'='
op|'-'
number|'1'
newline|'\n'
name|'attempts_left'
op|'-='
number|'1'
newline|'\n'
name|'if'
name|'attempts_left'
op|'<='
number|'0'
op|':'
newline|'\n'
indent|'                            '
name|'break'
newline|'\n'
dedent|''
dedent|''
dedent|''
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'exception_occurred'
op|'('
name|'node'
op|','
string|"'Account'"
op|','
nl|'\n'
string|"'Trying to get account info for %s'"
op|'%'
name|'path'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'result_code'
op|'=='
number|'200'
op|':'
newline|'\n'
indent|'            '
name|'cache_timeout'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'recheck_account_existence'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'cache_timeout'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'recheck_account_existence'
op|'*'
number|'0.1'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'app'
op|'.'
name|'memcache'
op|'.'
name|'set'
op|'('
name|'cache_key'
op|','
name|'result_code'
op|','
name|'timeout'
op|'='
name|'cache_timeout'
op|')'
newline|'\n'
name|'if'
name|'result_code'
op|'=='
number|'200'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'partition'
op|','
name|'nodes'
newline|'\n'
dedent|''
name|'return'
op|'('
name|'None'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|container_info
dedent|''
name|'def'
name|'container_info'
op|'('
name|'self'
op|','
name|'account'
op|','
name|'container'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Get container information and thusly verify container existance.\n        This will also make a call to account_info to verify that the\n        account exists.\n\n        :param account: account name for the container\n        :param container: container name to look up\n        :returns: tuple of (container partition, container nodes) or\n                           (None, None) if the container does not exist\n        """'
newline|'\n'
name|'partition'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'container_ring'
op|'.'
name|'get_nodes'
op|'('
nl|'\n'
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'path'
op|'='
string|"'/%s/%s'"
op|'%'
op|'('
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'cache_key'
op|'='
string|"'container%s'"
op|'%'
name|'path'
newline|'\n'
comment|'# 0 = no responses, 200 = found, 404 = not found, -1 = mixed responses'
nl|'\n'
name|'if'
name|'self'
op|'.'
name|'app'
op|'.'
name|'memcache'
op|'.'
name|'get'
op|'('
name|'cache_key'
op|')'
op|'=='
number|'200'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'partition'
op|','
name|'nodes'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'self'
op|'.'
name|'account_info'
op|'('
name|'account'
op|')'
op|'['
number|'1'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'('
name|'None'
op|','
name|'None'
op|')'
newline|'\n'
dedent|''
name|'result_code'
op|'='
number|'0'
newline|'\n'
name|'attempts_left'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'container_ring'
op|'.'
name|'replica_count'
newline|'\n'
name|'headers'
op|'='
op|'{'
string|"'x-cf-trans-id'"
op|':'
name|'self'
op|'.'
name|'trans_id'
op|'}'
newline|'\n'
name|'for'
name|'node'
name|'in'
name|'self'
op|'.'
name|'iter_nodes'
op|'('
name|'partition'
op|','
name|'nodes'
op|','
name|'self'
op|'.'
name|'app'
op|'.'
name|'container_ring'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'self'
op|'.'
name|'error_limited'
op|'('
name|'node'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'continue'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'with'
name|'ConnectionTimeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'conn_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'conn'
op|'='
name|'http_connect'
op|'('
name|'node'
op|'['
string|"'ip'"
op|']'
op|','
name|'node'
op|'['
string|"'port'"
op|']'
op|','
nl|'\n'
name|'node'
op|'['
string|"'device'"
op|']'
op|','
name|'partition'
op|','
string|"'HEAD'"
op|','
name|'path'
op|','
name|'headers'
op|')'
newline|'\n'
dedent|''
name|'with'
name|'Timeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'node_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'resp'
op|'='
name|'conn'
op|'.'
name|'getresponse'
op|'('
op|')'
newline|'\n'
name|'body'
op|'='
name|'resp'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'if'
number|'200'
op|'<='
name|'resp'
op|'.'
name|'status'
op|'<='
number|'299'
op|':'
newline|'\n'
indent|'                        '
name|'result_code'
op|'='
number|'200'
newline|'\n'
name|'break'
newline|'\n'
dedent|''
name|'elif'
name|'resp'
op|'.'
name|'status'
op|'=='
number|'404'
op|':'
newline|'\n'
indent|'                        '
name|'result_code'
op|'='
number|'404'
name|'if'
name|'not'
name|'result_code'
name|'else'
op|'-'
number|'1'
newline|'\n'
dedent|''
name|'elif'
name|'resp'
op|'.'
name|'status'
op|'=='
number|'507'
op|':'
newline|'\n'
indent|'                        '
name|'self'
op|'.'
name|'error_limit'
op|'('
name|'node'
op|')'
newline|'\n'
name|'continue'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                        '
name|'result_code'
op|'='
op|'-'
number|'1'
newline|'\n'
name|'attempts_left'
op|'-='
number|'1'
newline|'\n'
name|'if'
name|'attempts_left'
op|'<='
number|'0'
op|':'
newline|'\n'
indent|'                            '
name|'break'
newline|'\n'
dedent|''
dedent|''
dedent|''
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'exception_occurred'
op|'('
name|'node'
op|','
string|"'Container'"
op|','
nl|'\n'
string|"'Trying to get container info for %s'"
op|'%'
name|'path'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'result_code'
op|'=='
number|'200'
op|':'
newline|'\n'
indent|'            '
name|'cache_timeout'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'recheck_container_existence'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'cache_timeout'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'recheck_container_existence'
op|'*'
number|'0.1'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'app'
op|'.'
name|'memcache'
op|'.'
name|'set'
op|'('
name|'cache_key'
op|','
name|'result_code'
op|','
name|'timeout'
op|'='
name|'cache_timeout'
op|')'
newline|'\n'
name|'if'
name|'result_code'
op|'=='
number|'200'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'partition'
op|','
name|'nodes'
newline|'\n'
dedent|''
name|'return'
op|'('
name|'None'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|iter_nodes
dedent|''
name|'def'
name|'iter_nodes'
op|'('
name|'self'
op|','
name|'partition'
op|','
name|'nodes'
op|','
name|'ring'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Node iterator that will first iterate over the normal nodes for a\n        partition and then the handoff partitions for the node.\n\n        :param partition: partition to iterate nodes for\n        :param nodes: list of node dicts from the ring\n        :param ring: ring to get handoff nodes from\n        """'
newline|'\n'
name|'for'
name|'node'
name|'in'
name|'nodes'
op|':'
newline|'\n'
indent|'            '
name|'yield'
name|'node'
newline|'\n'
dedent|''
name|'for'
name|'node'
name|'in'
name|'ring'
op|'.'
name|'get_more_nodes'
op|'('
name|'partition'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'yield'
name|'node'
newline|'\n'
nl|'\n'
DECL|member|get_update_nodes
dedent|''
dedent|''
name|'def'
name|'get_update_nodes'
op|'('
name|'self'
op|','
name|'partition'
op|','
name|'nodes'
op|','
name|'ring'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'""" Returns ring.replica_count nodes; the nodes will not be error\n            limited, if possible. """'
newline|'\n'
string|'"""\n        Attempt to get a non error limited list of nodes.\n\n        :param partition: partition for the nodes\n        :param nodes: list of node dicts for the partition\n        :param ring: ring to get handoff nodes from\n        :returns: list of node dicts that are not error limited (if possible)\n        """'
newline|'\n'
nl|'\n'
comment|"# make a copy so we don't modify caller's list"
nl|'\n'
name|'nodes'
op|'='
name|'list'
op|'('
name|'nodes'
op|')'
newline|'\n'
name|'update_nodes'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'node'
name|'in'
name|'self'
op|'.'
name|'iter_nodes'
op|'('
name|'partition'
op|','
name|'nodes'
op|','
name|'ring'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'self'
op|'.'
name|'error_limited'
op|'('
name|'node'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'continue'
newline|'\n'
dedent|''
name|'update_nodes'
op|'.'
name|'append'
op|'('
name|'node'
op|')'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'update_nodes'
op|')'
op|'>='
name|'ring'
op|'.'
name|'replica_count'
op|':'
newline|'\n'
indent|'                '
name|'break'
newline|'\n'
dedent|''
dedent|''
name|'while'
name|'len'
op|'('
name|'update_nodes'
op|')'
op|'<'
name|'ring'
op|'.'
name|'replica_count'
op|':'
newline|'\n'
indent|'            '
name|'node'
op|'='
name|'nodes'
op|'.'
name|'pop'
op|'('
op|')'
newline|'\n'
name|'if'
name|'node'
name|'not'
name|'in'
name|'update_nodes'
op|':'
newline|'\n'
indent|'                '
name|'update_nodes'
op|'.'
name|'append'
op|'('
name|'node'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'update_nodes'
newline|'\n'
nl|'\n'
DECL|member|best_response
dedent|''
name|'def'
name|'best_response'
op|'('
name|'self'
op|','
name|'req'
op|','
name|'statuses'
op|','
name|'reasons'
op|','
name|'bodies'
op|','
name|'server_type'
op|','
nl|'\n'
name|'etag'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Given a list of responses from several servers, choose the best to\n        return to the API.\n\n        :param req: webob.Request object\n        :param statuses: list of statuses returned\n        :param reasons: list of reasons for each status\n        :param bodies: bodies of each response\n        :param server_type: type of server the responses came from\n        :param etag: etag\n        :returns: webob.Response object with the correct status, body, etc. set\n        """'
newline|'\n'
name|'resp'
op|'='
name|'Response'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'statuses'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'hundred'
name|'in'
op|'('
number|'200'
op|','
number|'300'
op|','
number|'400'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'hstatuses'
op|'='
op|'['
name|'s'
name|'for'
name|'s'
name|'in'
name|'statuses'
name|'if'
name|'hundred'
op|'<='
name|'s'
op|'<'
name|'hundred'
op|'+'
number|'100'
op|']'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'hstatuses'
op|')'
op|'>'
name|'len'
op|'('
name|'statuses'
op|')'
op|'/'
number|'2'
op|':'
newline|'\n'
indent|'                    '
name|'status'
op|'='
name|'max'
op|'('
name|'hstatuses'
op|')'
newline|'\n'
name|'status_index'
op|'='
name|'statuses'
op|'.'
name|'index'
op|'('
name|'status'
op|')'
newline|'\n'
name|'resp'
op|'.'
name|'status'
op|'='
string|"'%s %s'"
op|'%'
op|'('
name|'status'
op|','
name|'reasons'
op|'['
name|'status_index'
op|']'
op|')'
newline|'\n'
name|'resp'
op|'.'
name|'body'
op|'='
name|'bodies'
op|'['
name|'status_index'
op|']'
newline|'\n'
name|'resp'
op|'.'
name|'content_type'
op|'='
string|"'text/plain'"
newline|'\n'
name|'if'
name|'etag'
op|':'
newline|'\n'
indent|'                        '
name|'resp'
op|'.'
name|'headers'
op|'['
string|"'etag'"
op|']'
op|'='
name|'etag'
op|'.'
name|'strip'
op|'('
string|'\'"\''
op|')'
newline|'\n'
dedent|''
name|'return'
name|'resp'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'('
string|"'%s returning 503 for %s, transaction %s'"
op|'%'
nl|'\n'
op|'('
name|'server_type'
op|','
name|'statuses'
op|','
name|'self'
op|'.'
name|'trans_id'
op|')'
op|')'
newline|'\n'
name|'resp'
op|'.'
name|'status'
op|'='
string|"'503 Internal Server Error'"
newline|'\n'
name|'return'
name|'resp'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
DECL|member|GET
name|'def'
name|'GET'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handler for HTTP GET requests."""'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'GETorHEAD'
op|'('
name|'req'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
DECL|member|HEAD
name|'def'
name|'HEAD'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handler for HTTP HEAD requests."""'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'GETorHEAD'
op|'('
name|'req'
op|')'
newline|'\n'
nl|'\n'
DECL|member|GETorHEAD_base
dedent|''
name|'def'
name|'GETorHEAD_base'
op|'('
name|'self'
op|','
name|'req'
op|','
name|'server_type'
op|','
name|'partition'
op|','
name|'nodes'
op|','
name|'path'
op|','
nl|'\n'
name|'attempts'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Base handler for HTTP GET or HEAD requests.\n\n        :param req: webob.Request object\n        :param server_type: server type\n        :param partition: partition\n        :param nodes: nodes\n        :param path: path for the request\n        :param attempts: number of attempts to try\n        :returns: webob.Response object\n        """'
newline|'\n'
name|'statuses'
op|'='
op|'['
op|']'
newline|'\n'
name|'reasons'
op|'='
op|'['
op|']'
newline|'\n'
name|'bodies'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'node'
name|'in'
name|'nodes'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'len'
op|'('
name|'statuses'
op|')'
op|'>='
name|'attempts'
op|':'
newline|'\n'
indent|'                '
name|'break'
newline|'\n'
dedent|''
name|'if'
name|'self'
op|'.'
name|'error_limited'
op|'('
name|'node'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'continue'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'with'
name|'ConnectionTimeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'conn_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'conn'
op|'='
name|'http_connect'
op|'('
name|'node'
op|'['
string|"'ip'"
op|']'
op|','
name|'node'
op|'['
string|"'port'"
op|']'
op|','
nl|'\n'
name|'node'
op|'['
string|"'device'"
op|']'
op|','
name|'partition'
op|','
name|'req'
op|'.'
name|'method'
op|','
name|'path'
op|','
nl|'\n'
name|'headers'
op|'='
name|'req'
op|'.'
name|'headers'
op|','
nl|'\n'
name|'query_string'
op|'='
name|'req'
op|'.'
name|'query_string'
op|')'
newline|'\n'
dedent|''
name|'with'
name|'Timeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'node_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'source'
op|'='
name|'conn'
op|'.'
name|'getresponse'
op|'('
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'exception_occurred'
op|'('
name|'node'
op|','
name|'server_type'
op|','
nl|'\n'
string|"'Trying to %s %s'"
op|'%'
op|'('
name|'req'
op|'.'
name|'method'
op|','
name|'req'
op|'.'
name|'path'
op|')'
op|')'
newline|'\n'
name|'continue'
newline|'\n'
dedent|''
name|'if'
name|'source'
op|'.'
name|'status'
op|'=='
number|'507'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'error_limit'
op|'('
name|'node'
op|')'
newline|'\n'
name|'continue'
newline|'\n'
dedent|''
name|'if'
number|'200'
op|'<='
name|'source'
op|'.'
name|'status'
op|'<='
number|'399'
op|':'
newline|'\n'
comment|"# 404 if we know we don't have a synced copy"
nl|'\n'
indent|'                '
name|'if'
name|'not'
name|'float'
op|'('
name|'source'
op|'.'
name|'getheader'
op|'('
string|"'X-PUT-Timestamp'"
op|','
string|"'1'"
op|')'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'statuses'
op|'.'
name|'append'
op|'('
number|'404'
op|')'
newline|'\n'
name|'reasons'
op|'.'
name|'append'
op|'('
string|"''"
op|')'
newline|'\n'
name|'bodies'
op|'.'
name|'append'
op|'('
string|"''"
op|')'
newline|'\n'
name|'source'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'continue'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'req'
op|'.'
name|'method'
op|'=='
string|"'GET'"
name|'and'
name|'source'
op|'.'
name|'status'
name|'in'
op|'('
number|'200'
op|','
number|'206'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|function|file_iter
indent|'                '
name|'def'
name|'file_iter'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'try'
op|':'
newline|'\n'
indent|'                        '
name|'while'
name|'True'
op|':'
newline|'\n'
indent|'                            '
name|'with'
name|'ChunkReadTimeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'node_timeout'
op|')'
op|':'
newline|'\n'
indent|'                                '
name|'chunk'
op|'='
name|'source'
op|'.'
name|'read'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'object_chunk_size'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'chunk'
op|':'
newline|'\n'
indent|'                                '
name|'break'
newline|'\n'
dedent|''
name|'yield'
name|'chunk'
newline|'\n'
name|'req'
op|'.'
name|'sent_size'
op|'+='
name|'len'
op|'('
name|'chunk'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'GeneratorExit'
op|':'
newline|'\n'
indent|'                        '
name|'req'
op|'.'
name|'client_disconnect'
op|'='
name|'True'
newline|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'info'
op|'('
nl|'\n'
string|"'Client disconnected on read transaction %s'"
op|'%'
nl|'\n'
name|'self'
op|'.'
name|'trans_id'
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'                        '
name|'self'
op|'.'
name|'exception_occurred'
op|'('
name|'node'
op|','
string|"'Object'"
op|','
nl|'\n'
string|"'Trying to read during GET of %s'"
op|'%'
name|'req'
op|'.'
name|'path'
op|')'
newline|'\n'
name|'raise'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'res'
op|'='
name|'Response'
op|'('
name|'app_iter'
op|'='
name|'file_iter'
op|'('
op|')'
op|','
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'conditional_response'
op|'='
name|'True'
op|')'
newline|'\n'
name|'update_headers'
op|'('
name|'res'
op|','
name|'source'
op|'.'
name|'getheaders'
op|'('
op|')'
op|')'
newline|'\n'
name|'res'
op|'.'
name|'status'
op|'='
name|'source'
op|'.'
name|'status'
newline|'\n'
name|'res'
op|'.'
name|'content_length'
op|'='
name|'source'
op|'.'
name|'getheader'
op|'('
string|"'Content-Length'"
op|')'
newline|'\n'
name|'if'
name|'source'
op|'.'
name|'getheader'
op|'('
string|"'Content-Type'"
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'res'
op|'.'
name|'charset'
op|'='
name|'None'
newline|'\n'
name|'res'
op|'.'
name|'content_type'
op|'='
name|'source'
op|'.'
name|'getheader'
op|'('
string|"'Content-Type'"
op|')'
newline|'\n'
dedent|''
name|'return'
name|'res'
newline|'\n'
dedent|''
name|'elif'
number|'200'
op|'<='
name|'source'
op|'.'
name|'status'
op|'<='
number|'399'
op|':'
newline|'\n'
indent|'                '
name|'res'
op|'='
name|'status_map'
op|'['
name|'source'
op|'.'
name|'status'
op|']'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
name|'update_headers'
op|'('
name|'res'
op|','
name|'source'
op|'.'
name|'getheaders'
op|'('
op|')'
op|')'
newline|'\n'
name|'if'
name|'req'
op|'.'
name|'method'
op|'=='
string|"'HEAD'"
op|':'
newline|'\n'
indent|'                    '
name|'res'
op|'.'
name|'content_length'
op|'='
name|'source'
op|'.'
name|'getheader'
op|'('
string|"'Content-Length'"
op|')'
newline|'\n'
name|'if'
name|'source'
op|'.'
name|'getheader'
op|'('
string|"'Content-Type'"
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'res'
op|'.'
name|'charset'
op|'='
name|'None'
newline|'\n'
name|'res'
op|'.'
name|'content_type'
op|'='
name|'source'
op|'.'
name|'getheader'
op|'('
string|"'Content-Type'"
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'res'
newline|'\n'
dedent|''
name|'statuses'
op|'.'
name|'append'
op|'('
name|'source'
op|'.'
name|'status'
op|')'
newline|'\n'
name|'reasons'
op|'.'
name|'append'
op|'('
name|'source'
op|'.'
name|'reason'
op|')'
newline|'\n'
name|'bodies'
op|'.'
name|'append'
op|'('
name|'source'
op|'.'
name|'read'
op|'('
op|')'
op|')'
newline|'\n'
name|'if'
name|'source'
op|'.'
name|'status'
op|'>='
number|'500'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'error_occurred'
op|'('
name|'node'
op|','
string|"'ERROR %d %s From %s Server'"
op|'%'
nl|'\n'
op|'('
name|'source'
op|'.'
name|'status'
op|','
name|'bodies'
op|'['
op|'-'
number|'1'
op|']'
op|'['
op|':'
number|'1024'
op|']'
op|','
name|'server_type'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'self'
op|'.'
name|'best_response'
op|'('
name|'req'
op|','
name|'statuses'
op|','
name|'reasons'
op|','
name|'bodies'
op|','
nl|'\n'
string|"'%s %s'"
op|'%'
op|'('
name|'server_type'
op|','
name|'req'
op|'.'
name|'method'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ObjectController
dedent|''
dedent|''
name|'class'
name|'ObjectController'
op|'('
name|'Controller'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""WSGI controller for object requests."""'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'app'
op|','
name|'account_name'
op|','
name|'container_name'
op|','
name|'object_name'
op|','
nl|'\n'
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'Controller'
op|'.'
name|'__init__'
op|'('
name|'self'
op|','
name|'app'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'account_name'
op|'='
name|'unquote'
op|'('
name|'account_name'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'container_name'
op|'='
name|'unquote'
op|'('
name|'container_name'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'object_name'
op|'='
name|'unquote'
op|'('
name|'object_name'
op|')'
newline|'\n'
nl|'\n'
DECL|member|node_post_or_delete
dedent|''
name|'def'
name|'node_post_or_delete'
op|'('
name|'self'
op|','
name|'req'
op|','
name|'partition'
op|','
name|'node'
op|','
name|'path'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Handle common POST/DELETE functionality\n\n        :param req: webob.Request object\n        :param partition: partition for the object\n        :param node: node dictionary for the object\n        :param path: path to send for the request\n        """'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'error_limited'
op|'('
name|'node'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
number|'500'
op|','
string|"''"
op|','
string|"''"
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'ConnectionTimeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'conn_timeout'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'conn'
op|'='
name|'http_connect'
op|'('
name|'node'
op|'['
string|"'ip'"
op|']'
op|','
name|'node'
op|'['
string|"'port'"
op|']'
op|','
name|'node'
op|'['
string|"'device'"
op|']'
op|','
nl|'\n'
name|'partition'
op|','
name|'req'
op|'.'
name|'method'
op|','
name|'path'
op|','
name|'req'
op|'.'
name|'headers'
op|')'
newline|'\n'
dedent|''
name|'with'
name|'Timeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'node_timeout'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'response'
op|'='
name|'conn'
op|'.'
name|'getresponse'
op|'('
op|')'
newline|'\n'
name|'body'
op|'='
name|'response'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'if'
name|'response'
op|'.'
name|'status'
op|'=='
number|'507'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'error_limit'
op|'('
name|'node'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'response'
op|'.'
name|'status'
op|'>='
number|'500'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'error_occurred'
op|'('
name|'node'
op|','
nl|'\n'
string|"'ERROR %d %s From Object Server'"
op|'%'
nl|'\n'
op|'('
name|'response'
op|'.'
name|'status'
op|','
name|'body'
op|'['
op|':'
number|'1024'
op|']'
op|')'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'response'
op|'.'
name|'status'
op|','
name|'response'
op|'.'
name|'reason'
op|','
name|'body'
newline|'\n'
dedent|''
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'exception_occurred'
op|'('
name|'node'
op|','
string|"'Object'"
op|','
nl|'\n'
string|"'Trying to %s %s'"
op|'%'
op|'('
name|'req'
op|'.'
name|'method'
op|','
name|'req'
op|'.'
name|'path'
op|')'
op|')'
newline|'\n'
dedent|''
name|'return'
number|'500'
op|','
string|"''"
op|','
string|"''"
newline|'\n'
nl|'\n'
DECL|member|GETorHEAD
dedent|''
name|'def'
name|'GETorHEAD'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handle HTTP GET or HEAD requests."""'
newline|'\n'
name|'partition'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'object_ring'
op|'.'
name|'get_nodes'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'account_name'
op|','
name|'self'
op|'.'
name|'container_name'
op|','
name|'self'
op|'.'
name|'object_name'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'GETorHEAD_base'
op|'('
name|'req'
op|','
string|"'Object'"
op|','
name|'partition'
op|','
nl|'\n'
name|'self'
op|'.'
name|'iter_nodes'
op|'('
name|'partition'
op|','
name|'nodes'
op|','
name|'self'
op|'.'
name|'app'
op|'.'
name|'object_ring'
op|')'
op|','
nl|'\n'
name|'req'
op|'.'
name|'path_info'
op|','
name|'self'
op|'.'
name|'app'
op|'.'
name|'object_ring'
op|'.'
name|'replica_count'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
DECL|member|POST
name|'def'
name|'POST'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""HTTP POST request handler."""'
newline|'\n'
name|'error_response'
op|'='
name|'check_metadata'
op|'('
name|'req'
op|')'
newline|'\n'
name|'if'
name|'error_response'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'error_response'
newline|'\n'
dedent|''
name|'container_partition'
op|','
name|'containers'
op|'='
name|'self'
op|'.'
name|'container_info'
op|'('
name|'self'
op|'.'
name|'account_name'
op|','
name|'self'
op|'.'
name|'container_name'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'containers'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'containers'
op|'='
name|'self'
op|'.'
name|'get_update_nodes'
op|'('
name|'container_partition'
op|','
name|'containers'
op|','
nl|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'container_ring'
op|')'
newline|'\n'
name|'partition'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'object_ring'
op|'.'
name|'get_nodes'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'account_name'
op|','
name|'self'
op|'.'
name|'container_name'
op|','
name|'self'
op|'.'
name|'object_name'
op|')'
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'X-Timestamp'"
op|']'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
newline|'\n'
name|'statuses'
op|'='
op|'['
op|']'
newline|'\n'
name|'reasons'
op|'='
op|'['
op|']'
newline|'\n'
name|'bodies'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'node'
name|'in'
name|'self'
op|'.'
name|'iter_nodes'
op|'('
name|'partition'
op|','
name|'nodes'
op|','
name|'self'
op|'.'
name|'app'
op|'.'
name|'object_ring'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'container'
op|'='
name|'containers'
op|'.'
name|'pop'
op|'('
op|')'
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'X-Container-Host'"
op|']'
op|'='
string|"'%(ip)s:%(port)s'"
op|'%'
name|'container'
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'X-Container-Partition'"
op|']'
op|'='
name|'container_partition'
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'X-Container-Device'"
op|']'
op|'='
name|'container'
op|'['
string|"'device'"
op|']'
newline|'\n'
name|'status'
op|','
name|'reason'
op|','
name|'body'
op|'='
name|'self'
op|'.'
name|'node_post_or_delete'
op|'('
name|'req'
op|','
name|'partition'
op|','
name|'node'
op|','
name|'req'
op|'.'
name|'path_info'
op|')'
newline|'\n'
name|'if'
number|'200'
op|'<='
name|'status'
op|'<'
number|'300'
name|'or'
number|'400'
op|'<='
name|'status'
op|'<'
number|'500'
op|':'
newline|'\n'
indent|'                '
name|'statuses'
op|'.'
name|'append'
op|'('
name|'status'
op|')'
newline|'\n'
name|'reasons'
op|'.'
name|'append'
op|'('
name|'reason'
op|')'
newline|'\n'
name|'bodies'
op|'.'
name|'append'
op|'('
name|'body'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'containers'
op|'.'
name|'insert'
op|'('
number|'0'
op|','
name|'container'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'containers'
op|':'
newline|'\n'
indent|'                '
name|'break'
newline|'\n'
dedent|''
dedent|''
name|'while'
name|'len'
op|'('
name|'statuses'
op|')'
op|'<'
name|'len'
op|'('
name|'nodes'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'statuses'
op|'.'
name|'append'
op|'('
number|'503'
op|')'
newline|'\n'
name|'reasons'
op|'.'
name|'append'
op|'('
string|"''"
op|')'
newline|'\n'
name|'bodies'
op|'.'
name|'append'
op|'('
string|"''"
op|')'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'best_response'
op|'('
name|'req'
op|','
name|'statuses'
op|','
name|'reasons'
op|','
nl|'\n'
name|'bodies'
op|','
string|"'Object POST'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
DECL|member|PUT
name|'def'
name|'PUT'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""HTTP PUT request handler."""'
newline|'\n'
name|'container_partition'
op|','
name|'containers'
op|'='
name|'self'
op|'.'
name|'container_info'
op|'('
name|'self'
op|'.'
name|'account_name'
op|','
name|'self'
op|'.'
name|'container_name'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'containers'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'containers'
op|'='
name|'self'
op|'.'
name|'get_update_nodes'
op|'('
name|'container_partition'
op|','
name|'containers'
op|','
nl|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'container_ring'
op|')'
newline|'\n'
name|'partition'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'object_ring'
op|'.'
name|'get_nodes'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'account_name'
op|','
name|'self'
op|'.'
name|'container_name'
op|','
name|'self'
op|'.'
name|'object_name'
op|')'
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'X-Timestamp'"
op|']'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
newline|'\n'
comment|'# this is a temporary hook for migrations to set PUT timestamps'
nl|'\n'
name|'if'
string|"'!Migration-Timestamp!'"
name|'in'
name|'req'
op|'.'
name|'headers'
op|':'
newline|'\n'
indent|'            '
name|'req'
op|'.'
name|'headers'
op|'['
string|"'X-Timestamp'"
op|']'
op|'='
name|'normalize_timestamp'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'!Migration-Timestamp!'"
op|']'
op|')'
newline|'\n'
comment|"# Sometimes the 'content-type' header exists, but is set to None."
nl|'\n'
dedent|''
name|'if'
name|'not'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'content-type'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'guessed_type'
op|','
name|'_'
op|'='
name|'mimetypes'
op|'.'
name|'guess_type'
op|'('
name|'req'
op|'.'
name|'path_info'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'guessed_type'
op|':'
newline|'\n'
indent|'                '
name|'req'
op|'.'
name|'headers'
op|'['
string|"'Content-Type'"
op|']'
op|'='
string|"'application/octet-stream'"
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'req'
op|'.'
name|'headers'
op|'['
string|"'Content-Type'"
op|']'
op|'='
name|'guessed_type'
newline|'\n'
dedent|''
dedent|''
name|'error_response'
op|'='
name|'check_object_creation'
op|'('
name|'req'
op|','
name|'self'
op|'.'
name|'object_name'
op|')'
newline|'\n'
name|'if'
name|'error_response'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'error_response'
newline|'\n'
dedent|''
name|'conns'
op|'='
op|'['
op|']'
newline|'\n'
name|'data_source'
op|'='
name|'iter'
op|'('
name|'lambda'
op|':'
name|'req'
op|'.'
name|'body_file'
op|'.'
name|'read'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'client_chunk_size'
op|')'
op|','
string|"''"
op|')'
newline|'\n'
name|'source_header'
op|'='
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Copy-From'"
op|')'
newline|'\n'
name|'if'
name|'source_header'
op|':'
newline|'\n'
indent|'            '
name|'source_header'
op|'='
name|'unquote'
op|'('
name|'source_header'
op|')'
newline|'\n'
name|'acct'
op|'='
name|'req'
op|'.'
name|'path_info'
op|'.'
name|'split'
op|'('
string|"'/'"
op|','
number|'2'
op|')'
op|'['
number|'1'
op|']'
newline|'\n'
name|'if'
name|'not'
name|'source_header'
op|'.'
name|'startswith'
op|'('
string|"'/'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'source_header'
op|'='
string|"'/'"
op|'+'
name|'source_header'
newline|'\n'
dedent|''
name|'source_header'
op|'='
string|"'/'"
op|'+'
name|'acct'
op|'+'
name|'source_header'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'src_container_name'
op|','
name|'src_obj_name'
op|'='
name|'source_header'
op|'.'
name|'split'
op|'('
string|"'/'"
op|','
number|'3'
op|')'
op|'['
number|'2'
op|':'
op|']'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPPreconditionFailed'
op|'('
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'body'
op|'='
string|"'X-Copy-From header must be of the form'"
nl|'\n'
string|"'container/object'"
op|')'
newline|'\n'
dedent|''
name|'source_req'
op|'='
name|'Request'
op|'.'
name|'blank'
op|'('
name|'source_header'
op|')'
newline|'\n'
name|'orig_obj_name'
op|'='
name|'self'
op|'.'
name|'object_name'
newline|'\n'
name|'orig_container_name'
op|'='
name|'self'
op|'.'
name|'container_name'
newline|'\n'
name|'self'
op|'.'
name|'object_name'
op|'='
name|'src_obj_name'
newline|'\n'
name|'self'
op|'.'
name|'container_name'
op|'='
name|'src_container_name'
newline|'\n'
name|'source_resp'
op|'='
name|'self'
op|'.'
name|'GET'
op|'('
name|'source_req'
op|')'
newline|'\n'
name|'if'
name|'source_resp'
op|'.'
name|'status_int'
op|'>='
number|'300'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'source_resp'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'object_name'
op|'='
name|'orig_obj_name'
newline|'\n'
name|'self'
op|'.'
name|'container_name'
op|'='
name|'orig_container_name'
newline|'\n'
name|'data_source'
op|'='
name|'source_resp'
op|'.'
name|'app_iter'
newline|'\n'
name|'new_req'
op|'='
name|'Request'
op|'.'
name|'blank'
op|'('
name|'req'
op|'.'
name|'path_info'
op|','
nl|'\n'
name|'environ'
op|'='
name|'req'
op|'.'
name|'environ'
op|','
name|'headers'
op|'='
name|'req'
op|'.'
name|'headers'
op|')'
newline|'\n'
name|'new_req'
op|'.'
name|'content_length'
op|'='
name|'source_resp'
op|'.'
name|'content_length'
newline|'\n'
name|'new_req'
op|'.'
name|'etag'
op|'='
name|'source_resp'
op|'.'
name|'etag'
newline|'\n'
name|'new_req'
op|'.'
name|'headers'
op|'['
string|"'X-Copy-From'"
op|']'
op|'='
name|'source_header'
op|'.'
name|'split'
op|'('
string|"'/'"
op|','
number|'2'
op|')'
op|'['
number|'2'
op|']'
newline|'\n'
name|'for'
name|'k'
op|','
name|'v'
name|'in'
name|'source_resp'
op|'.'
name|'headers'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'k'
op|'.'
name|'lower'
op|'('
op|')'
op|'.'
name|'startswith'
op|'('
string|"'x-object-meta-'"
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'new_req'
op|'.'
name|'headers'
op|'['
name|'k'
op|']'
op|'='
name|'v'
newline|'\n'
dedent|''
dedent|''
name|'for'
name|'k'
op|','
name|'v'
name|'in'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'k'
op|'.'
name|'lower'
op|'('
op|')'
op|'.'
name|'startswith'
op|'('
string|"'x-object-meta-'"
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'new_req'
op|'.'
name|'headers'
op|'['
name|'k'
op|']'
op|'='
name|'v'
newline|'\n'
dedent|''
dedent|''
name|'req'
op|'='
name|'new_req'
newline|'\n'
dedent|''
name|'for'
name|'node'
name|'in'
name|'self'
op|'.'
name|'iter_nodes'
op|'('
name|'partition'
op|','
name|'nodes'
op|','
name|'self'
op|'.'
name|'app'
op|'.'
name|'object_ring'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'container'
op|'='
name|'containers'
op|'.'
name|'pop'
op|'('
op|')'
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'X-Container-Host'"
op|']'
op|'='
string|"'%(ip)s:%(port)s'"
op|'%'
name|'container'
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'X-Container-Partition'"
op|']'
op|'='
name|'container_partition'
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'X-Container-Device'"
op|']'
op|'='
name|'container'
op|'['
string|"'device'"
op|']'
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'Expect'"
op|']'
op|'='
string|"'100-continue'"
newline|'\n'
name|'resp'
op|'='
name|'conn'
op|'='
name|'None'
newline|'\n'
name|'if'
name|'not'
name|'self'
op|'.'
name|'error_limited'
op|'('
name|'node'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'with'
name|'ConnectionTimeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'conn_timeout'
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'conn'
op|'='
name|'http_connect'
op|'('
name|'node'
op|'['
string|"'ip'"
op|']'
op|','
name|'node'
op|'['
string|"'port'"
op|']'
op|','
nl|'\n'
name|'node'
op|'['
string|"'device'"
op|']'
op|','
name|'partition'
op|','
string|"'PUT'"
op|','
nl|'\n'
name|'req'
op|'.'
name|'path_info'
op|','
name|'req'
op|'.'
name|'headers'
op|')'
newline|'\n'
name|'conn'
op|'.'
name|'node'
op|'='
name|'node'
newline|'\n'
dedent|''
name|'with'
name|'Timeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'node_timeout'
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'resp'
op|'='
name|'conn'
op|'.'
name|'getexpect'
op|'('
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'exception_occurred'
op|'('
name|'node'
op|','
string|"'Object'"
op|','
nl|'\n'
string|"'Expect: 100-continue on %s'"
op|'%'
name|'req'
op|'.'
name|'path'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'conn'
name|'and'
name|'resp'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'resp'
op|'.'
name|'status'
op|'=='
number|'100'
op|':'
newline|'\n'
indent|'                    '
name|'conns'
op|'.'
name|'append'
op|'('
name|'conn'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'containers'
op|':'
newline|'\n'
indent|'                        '
name|'break'
newline|'\n'
dedent|''
name|'continue'
newline|'\n'
dedent|''
name|'elif'
name|'resp'
op|'.'
name|'status'
op|'=='
number|'507'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'error_limit'
op|'('
name|'node'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'containers'
op|'.'
name|'insert'
op|'('
number|'0'
op|','
name|'container'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'conns'
op|')'
op|'<='
name|'len'
op|'('
name|'nodes'
op|')'
op|'/'
number|'2'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'('
nl|'\n'
string|"'Object PUT returning 503, %s/%s required connections, '"
nl|'\n'
string|"'transaction %s'"
op|'%'
nl|'\n'
op|'('
name|'len'
op|'('
name|'conns'
op|')'
op|','
name|'len'
op|'('
name|'nodes'
op|')'
op|'/'
number|'2'
op|'+'
number|'1'
op|','
name|'self'
op|'.'
name|'trans_id'
op|')'
op|')'
newline|'\n'
name|'return'
name|'HTTPServiceUnavailable'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'req'
op|'.'
name|'creation_size'
op|'='
number|'0'
newline|'\n'
name|'while'
name|'True'
op|':'
newline|'\n'
indent|'                '
name|'with'
name|'ChunkReadTimeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'client_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'try'
op|':'
newline|'\n'
indent|'                        '
name|'chunk'
op|'='
name|'data_source'
op|'.'
name|'next'
op|'('
op|')'
newline|'\n'
dedent|''
name|'except'
name|'StopIteration'
op|':'
newline|'\n'
indent|'                        '
name|'if'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'transfer-encoding'"
op|')'
op|':'
newline|'\n'
indent|'                            '
name|'chunk'
op|'='
string|"''"
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                            '
name|'break'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'len_chunk'
op|'='
name|'len'
op|'('
name|'chunk'
op|')'
newline|'\n'
name|'req'
op|'.'
name|'creation_size'
op|'+='
name|'len_chunk'
newline|'\n'
name|'if'
name|'req'
op|'.'
name|'creation_size'
op|'>'
name|'MAX_FILE_SIZE'
op|':'
newline|'\n'
indent|'                    '
name|'req'
op|'.'
name|'creation_size'
op|'='
number|'0'
newline|'\n'
name|'return'
name|'HTTPRequestEntityTooLarge'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'for'
name|'conn'
name|'in'
name|'conns'
op|':'
newline|'\n'
indent|'                    '
name|'try'
op|':'
newline|'\n'
indent|'                        '
name|'with'
name|'ChunkWriteTimeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'node_timeout'
op|')'
op|':'
newline|'\n'
indent|'                            '
name|'if'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'transfer-encoding'"
op|')'
op|':'
newline|'\n'
indent|'                                '
name|'conn'
op|'.'
name|'send'
op|'('
string|"'%x\\r\\n%s\\r\\n'"
op|'%'
op|'('
name|'len_chunk'
op|','
name|'chunk'
op|')'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                                '
name|'conn'
op|'.'
name|'send'
op|'('
name|'chunk'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'                        '
name|'self'
op|'.'
name|'exception_occurred'
op|'('
name|'conn'
op|'.'
name|'node'
op|','
string|"'Object'"
op|','
nl|'\n'
string|"'Trying to write to %s'"
op|'%'
name|'req'
op|'.'
name|'path'
op|')'
newline|'\n'
name|'conns'
op|'.'
name|'remove'
op|'('
name|'conn'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'transfer-encoding'"
op|')'
name|'and'
name|'chunk'
op|'=='
string|"''"
op|':'
newline|'\n'
indent|'                    '
name|'break'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'except'
name|'ChunkReadTimeout'
op|','
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'info'
op|'('
nl|'\n'
string|"'ERROR Client read timeout (%ss)'"
op|'%'
name|'err'
op|'.'
name|'seconds'
op|')'
newline|'\n'
name|'return'
name|'HTTPRequestTimeout'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'exception'
op|'('
nl|'\n'
string|"'ERROR Exception causing client disconnect'"
op|')'
newline|'\n'
name|'return'
name|'Response'
op|'('
name|'status'
op|'='
string|"'499 Client Disconnect'"
op|')'
newline|'\n'
dedent|''
name|'if'
name|'req'
op|'.'
name|'content_length'
name|'and'
name|'req'
op|'.'
name|'creation_size'
op|'<'
name|'req'
op|'.'
name|'content_length'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'info'
op|'('
nl|'\n'
string|"'Client disconnected without sending enough data %s'"
op|'%'
nl|'\n'
name|'self'
op|'.'
name|'trans_id'
op|')'
newline|'\n'
name|'return'
name|'Response'
op|'('
name|'status'
op|'='
string|"'499 Client Disconnect'"
op|')'
newline|'\n'
dedent|''
name|'statuses'
op|'='
op|'['
op|']'
newline|'\n'
name|'reasons'
op|'='
op|'['
op|']'
newline|'\n'
name|'bodies'
op|'='
op|'['
op|']'
newline|'\n'
name|'etags'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'conn'
name|'in'
name|'conns'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'with'
name|'Timeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'node_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'response'
op|'='
name|'conn'
op|'.'
name|'getresponse'
op|'('
op|')'
newline|'\n'
name|'statuses'
op|'.'
name|'append'
op|'('
name|'response'
op|'.'
name|'status'
op|')'
newline|'\n'
name|'reasons'
op|'.'
name|'append'
op|'('
name|'response'
op|'.'
name|'reason'
op|')'
newline|'\n'
name|'bodies'
op|'.'
name|'append'
op|'('
name|'response'
op|'.'
name|'read'
op|'('
op|')'
op|')'
newline|'\n'
name|'if'
name|'response'
op|'.'
name|'status'
op|'>='
number|'500'
op|':'
newline|'\n'
indent|'                        '
name|'self'
op|'.'
name|'error_occurred'
op|'('
name|'conn'
op|'.'
name|'node'
op|','
nl|'\n'
string|"'ERROR %d %s From Object Server re: %s'"
op|'%'
nl|'\n'
op|'('
name|'response'
op|'.'
name|'status'
op|','
name|'bodies'
op|'['
op|'-'
number|'1'
op|']'
op|'['
op|':'
number|'1024'
op|']'
op|','
name|'req'
op|'.'
name|'path'
op|')'
op|')'
newline|'\n'
dedent|''
name|'elif'
number|'200'
op|'<='
name|'response'
op|'.'
name|'status'
op|'<'
number|'300'
op|':'
newline|'\n'
indent|'                        '
name|'etags'
op|'.'
name|'add'
op|'('
name|'response'
op|'.'
name|'getheader'
op|'('
string|"'etag'"
op|')'
op|'.'
name|'strip'
op|'('
string|'\'"\''
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'exception_occurred'
op|'('
name|'conn'
op|'.'
name|'node'
op|','
string|"'Object'"
op|','
nl|'\n'
string|"'Trying to get final status of PUT to %s'"
op|'%'
name|'req'
op|'.'
name|'path'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'len'
op|'('
name|'etags'
op|')'
op|'>'
number|'1'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPUnprocessableEntity'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'etag'
op|'='
name|'len'
op|'('
name|'etags'
op|')'
name|'and'
name|'etags'
op|'.'
name|'pop'
op|'('
op|')'
name|'or'
name|'None'
newline|'\n'
name|'while'
name|'len'
op|'('
name|'statuses'
op|')'
op|'<'
name|'len'
op|'('
name|'nodes'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'statuses'
op|'.'
name|'append'
op|'('
number|'503'
op|')'
newline|'\n'
name|'reasons'
op|'.'
name|'append'
op|'('
string|"''"
op|')'
newline|'\n'
name|'bodies'
op|'.'
name|'append'
op|'('
string|"''"
op|')'
newline|'\n'
dedent|''
name|'resp'
op|'='
name|'self'
op|'.'
name|'best_response'
op|'('
name|'req'
op|','
name|'statuses'
op|','
name|'reasons'
op|','
name|'bodies'
op|','
string|"'Object PUT'"
op|','
nl|'\n'
name|'etag'
op|'='
name|'etag'
op|')'
newline|'\n'
name|'if'
string|"'x-copy-from'"
name|'in'
name|'req'
op|'.'
name|'headers'
op|':'
newline|'\n'
indent|'            '
name|'resp'
op|'.'
name|'headers'
op|'['
string|"'X-Copied-From'"
op|']'
op|'='
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-copy-from'"
op|']'
newline|'\n'
name|'for'
name|'k'
op|','
name|'v'
name|'in'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'k'
op|'.'
name|'lower'
op|'('
op|')'
op|'.'
name|'startswith'
op|'('
string|"'x-object-meta-'"
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'resp'
op|'.'
name|'headers'
op|'['
name|'k'
op|']'
op|'='
name|'v'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'resp'
op|'.'
name|'last_modified'
op|'='
name|'float'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'X-Timestamp'"
op|']'
op|')'
newline|'\n'
name|'return'
name|'resp'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
DECL|member|DELETE
name|'def'
name|'DELETE'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""HTTP DELETE request handler."""'
newline|'\n'
name|'container_partition'
op|','
name|'containers'
op|'='
name|'self'
op|'.'
name|'container_info'
op|'('
name|'self'
op|'.'
name|'account_name'
op|','
name|'self'
op|'.'
name|'container_name'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'containers'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'containers'
op|'='
name|'self'
op|'.'
name|'get_update_nodes'
op|'('
name|'container_partition'
op|','
name|'containers'
op|','
nl|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'container_ring'
op|')'
newline|'\n'
name|'partition'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'object_ring'
op|'.'
name|'get_nodes'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'account_name'
op|','
name|'self'
op|'.'
name|'container_name'
op|','
name|'self'
op|'.'
name|'object_name'
op|')'
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'X-Timestamp'"
op|']'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
newline|'\n'
name|'statuses'
op|'='
op|'['
op|']'
newline|'\n'
name|'reasons'
op|'='
op|'['
op|']'
newline|'\n'
name|'bodies'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'node'
name|'in'
name|'self'
op|'.'
name|'iter_nodes'
op|'('
name|'partition'
op|','
name|'nodes'
op|','
name|'self'
op|'.'
name|'app'
op|'.'
name|'object_ring'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'container'
op|'='
name|'containers'
op|'.'
name|'pop'
op|'('
op|')'
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'X-Container-Host'"
op|']'
op|'='
string|"'%(ip)s:%(port)s'"
op|'%'
name|'container'
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'X-Container-Partition'"
op|']'
op|'='
name|'container_partition'
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'X-Container-Device'"
op|']'
op|'='
name|'container'
op|'['
string|"'device'"
op|']'
newline|'\n'
name|'status'
op|','
name|'reason'
op|','
name|'body'
op|'='
name|'self'
op|'.'
name|'node_post_or_delete'
op|'('
name|'req'
op|','
name|'partition'
op|','
name|'node'
op|','
name|'req'
op|'.'
name|'path_info'
op|')'
newline|'\n'
name|'if'
number|'200'
op|'<='
name|'status'
op|'<'
number|'300'
name|'or'
number|'400'
op|'<='
name|'status'
op|'<'
number|'500'
op|':'
newline|'\n'
indent|'                '
name|'statuses'
op|'.'
name|'append'
op|'('
name|'status'
op|')'
newline|'\n'
name|'reasons'
op|'.'
name|'append'
op|'('
name|'reason'
op|')'
newline|'\n'
name|'bodies'
op|'.'
name|'append'
op|'('
name|'body'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'containers'
op|'.'
name|'insert'
op|'('
number|'0'
op|','
name|'container'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'containers'
op|':'
newline|'\n'
indent|'                '
name|'break'
newline|'\n'
dedent|''
dedent|''
name|'while'
name|'len'
op|'('
name|'statuses'
op|')'
op|'<'
name|'len'
op|'('
name|'nodes'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'statuses'
op|'.'
name|'append'
op|'('
number|'503'
op|')'
newline|'\n'
name|'reasons'
op|'.'
name|'append'
op|'('
string|"''"
op|')'
newline|'\n'
name|'bodies'
op|'.'
name|'append'
op|'('
string|"''"
op|')'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'best_response'
op|'('
name|'req'
op|','
name|'statuses'
op|','
name|'reasons'
op|','
name|'bodies'
op|','
nl|'\n'
string|"'Object DELETE'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
DECL|member|COPY
name|'def'
name|'COPY'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""HTTP COPY request handler."""'
newline|'\n'
name|'dest'
op|'='
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'Destination'"
op|')'
newline|'\n'
name|'if'
name|'not'
name|'dest'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPPreconditionFailed'
op|'('
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'body'
op|'='
string|"'Destination header required'"
op|')'
newline|'\n'
dedent|''
name|'dest'
op|'='
name|'unquote'
op|'('
name|'dest'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'dest'
op|'.'
name|'startswith'
op|'('
string|"'/'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'dest'
op|'='
string|"'/'"
op|'+'
name|'dest'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'_'
op|','
name|'dest_container'
op|','
name|'dest_object'
op|'='
name|'dest'
op|'.'
name|'split'
op|'('
string|"'/'"
op|','
number|'3'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPPreconditionFailed'
op|'('
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'body'
op|'='
string|"'Destination header must be of the form '"
nl|'\n'
string|"'container/object'"
op|')'
newline|'\n'
dedent|''
name|'new_source'
op|'='
string|"'/'"
op|'+'
name|'self'
op|'.'
name|'container_name'
op|'+'
string|"'/'"
op|'+'
name|'self'
op|'.'
name|'object_name'
newline|'\n'
name|'self'
op|'.'
name|'container_name'
op|'='
name|'dest_container'
newline|'\n'
name|'self'
op|'.'
name|'object_name'
op|'='
name|'dest_object'
newline|'\n'
name|'new_headers'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'k'
op|','
name|'v'
name|'in'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'new_headers'
op|'['
name|'k'
op|']'
op|'='
name|'v'
newline|'\n'
dedent|''
name|'new_headers'
op|'['
string|"'X-Copy-From'"
op|']'
op|'='
name|'new_source'
newline|'\n'
name|'new_headers'
op|'['
string|"'Content-Length'"
op|']'
op|'='
number|'0'
newline|'\n'
name|'del'
name|'new_headers'
op|'['
string|"'Destination'"
op|']'
newline|'\n'
name|'new_path'
op|'='
string|"'/'"
op|'+'
name|'self'
op|'.'
name|'account_name'
op|'+'
name|'dest'
newline|'\n'
name|'new_req'
op|'='
name|'Request'
op|'.'
name|'blank'
op|'('
name|'new_path'
op|','
nl|'\n'
name|'environ'
op|'='
op|'{'
string|"'REQUEST_METHOD'"
op|':'
string|"'PUT'"
op|'}'
op|','
name|'headers'
op|'='
name|'new_headers'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'PUT'
op|'('
name|'new_req'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ContainerController
dedent|''
dedent|''
name|'class'
name|'ContainerController'
op|'('
name|'Controller'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""WSGI controller for container requests"""'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'app'
op|','
name|'account_name'
op|','
name|'container_name'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'Controller'
op|'.'
name|'__init__'
op|'('
name|'self'
op|','
name|'app'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'account_name'
op|'='
name|'unquote'
op|'('
name|'account_name'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'container_name'
op|'='
name|'unquote'
op|'('
name|'container_name'
op|')'
newline|'\n'
nl|'\n'
DECL|member|GETorHEAD
dedent|''
name|'def'
name|'GETorHEAD'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handler for HTTP GET/HEAD requests."""'
newline|'\n'
name|'if'
name|'not'
name|'self'
op|'.'
name|'account_info'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
op|'['
number|'1'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'part'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'container_ring'
op|'.'
name|'get_nodes'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'account_name'
op|','
name|'self'
op|'.'
name|'container_name'
op|')'
newline|'\n'
name|'resp'
op|'='
name|'self'
op|'.'
name|'GETorHEAD_base'
op|'('
name|'req'
op|','
string|"'Container'"
op|','
name|'part'
op|','
name|'nodes'
op|','
nl|'\n'
name|'req'
op|'.'
name|'path_info'
op|','
name|'self'
op|'.'
name|'app'
op|'.'
name|'container_ring'
op|'.'
name|'replica_count'
op|')'
newline|'\n'
name|'return'
name|'resp'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
DECL|member|PUT
name|'def'
name|'PUT'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""HTTP PUT request handler."""'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'self'
op|'.'
name|'container_name'
op|')'
op|'>'
name|'MAX_CONTAINER_NAME_LENGTH'
op|':'
newline|'\n'
indent|'            '
name|'resp'
op|'='
name|'HTTPBadRequest'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
name|'resp'
op|'.'
name|'body'
op|'='
string|"'Container name length of %d longer than %d'"
op|'%'
op|'('
name|'len'
op|'('
name|'self'
op|'.'
name|'container_name'
op|')'
op|','
name|'MAX_CONTAINER_NAME_LENGTH'
op|')'
newline|'\n'
name|'return'
name|'resp'
newline|'\n'
dedent|''
name|'account_partition'
op|','
name|'accounts'
op|'='
name|'self'
op|'.'
name|'account_info'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'accounts'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'accounts'
op|'='
name|'self'
op|'.'
name|'get_update_nodes'
op|'('
name|'account_partition'
op|','
name|'accounts'
op|','
nl|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|')'
newline|'\n'
name|'container_partition'
op|','
name|'containers'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'container_ring'
op|'.'
name|'get_nodes'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'account_name'
op|','
name|'self'
op|'.'
name|'container_name'
op|')'
newline|'\n'
name|'headers'
op|'='
op|'{'
string|"'X-Timestamp'"
op|':'
name|'normalize_timestamp'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|','
nl|'\n'
string|"'x-cf-trans-id'"
op|':'
name|'self'
op|'.'
name|'trans_id'
op|'}'
newline|'\n'
name|'statuses'
op|'='
op|'['
op|']'
newline|'\n'
name|'reasons'
op|'='
op|'['
op|']'
newline|'\n'
name|'bodies'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'node'
name|'in'
name|'self'
op|'.'
name|'iter_nodes'
op|'('
name|'container_partition'
op|','
name|'containers'
op|','
nl|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'container_ring'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'self'
op|'.'
name|'error_limited'
op|'('
name|'node'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'continue'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'account'
op|'='
name|'accounts'
op|'.'
name|'pop'
op|'('
op|')'
newline|'\n'
name|'headers'
op|'['
string|"'X-Account-Host'"
op|']'
op|'='
string|"'%(ip)s:%(port)s'"
op|'%'
name|'account'
newline|'\n'
name|'headers'
op|'['
string|"'X-Account-Partition'"
op|']'
op|'='
name|'account_partition'
newline|'\n'
name|'headers'
op|'['
string|"'X-Account-Device'"
op|']'
op|'='
name|'account'
op|'['
string|"'device'"
op|']'
newline|'\n'
name|'with'
name|'ConnectionTimeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'conn_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'conn'
op|'='
name|'http_connect'
op|'('
name|'node'
op|'['
string|"'ip'"
op|']'
op|','
name|'node'
op|'['
string|"'port'"
op|']'
op|','
nl|'\n'
name|'node'
op|'['
string|"'device'"
op|']'
op|','
name|'container_partition'
op|','
string|"'PUT'"
op|','
nl|'\n'
name|'req'
op|'.'
name|'path_info'
op|','
name|'headers'
op|')'
newline|'\n'
dedent|''
name|'with'
name|'Timeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'node_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'source'
op|'='
name|'conn'
op|'.'
name|'getresponse'
op|'('
op|')'
newline|'\n'
name|'body'
op|'='
name|'source'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'if'
number|'200'
op|'<='
name|'source'
op|'.'
name|'status'
op|'<'
number|'300'
name|'or'
number|'400'
op|'<='
name|'source'
op|'.'
name|'status'
op|'<'
number|'500'
op|':'
newline|'\n'
indent|'                        '
name|'statuses'
op|'.'
name|'append'
op|'('
name|'source'
op|'.'
name|'status'
op|')'
newline|'\n'
name|'reasons'
op|'.'
name|'append'
op|'('
name|'source'
op|'.'
name|'reason'
op|')'
newline|'\n'
name|'bodies'
op|'.'
name|'append'
op|'('
name|'body'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                        '
name|'if'
name|'source'
op|'.'
name|'status'
op|'=='
number|'507'
op|':'
newline|'\n'
indent|'                            '
name|'self'
op|'.'
name|'error_limit'
op|'('
name|'node'
op|')'
newline|'\n'
dedent|''
name|'accounts'
op|'.'
name|'insert'
op|'('
number|'0'
op|','
name|'account'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'                '
name|'accounts'
op|'.'
name|'insert'
op|'('
number|'0'
op|','
name|'account'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'exception_occurred'
op|'('
name|'node'
op|','
string|"'Container'"
op|','
nl|'\n'
string|"'Trying to PUT to %s'"
op|'%'
name|'req'
op|'.'
name|'path'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'accounts'
op|':'
newline|'\n'
indent|'                '
name|'break'
newline|'\n'
dedent|''
dedent|''
name|'while'
name|'len'
op|'('
name|'statuses'
op|')'
op|'<'
name|'len'
op|'('
name|'containers'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'statuses'
op|'.'
name|'append'
op|'('
number|'503'
op|')'
newline|'\n'
name|'reasons'
op|'.'
name|'append'
op|'('
string|"''"
op|')'
newline|'\n'
name|'bodies'
op|'.'
name|'append'
op|'('
string|"''"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'app'
op|'.'
name|'memcache'
op|'.'
name|'delete'
op|'('
string|"'container%s'"
op|'%'
name|'req'
op|'.'
name|'path_info'
op|'.'
name|'rstrip'
op|'('
string|"'/'"
op|')'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'best_response'
op|'('
name|'req'
op|','
name|'statuses'
op|','
name|'reasons'
op|','
name|'bodies'
op|','
nl|'\n'
string|"'Container PUT'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
DECL|member|DELETE
name|'def'
name|'DELETE'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""HTTP DELETE request handler."""'
newline|'\n'
name|'account_partition'
op|','
name|'accounts'
op|'='
name|'self'
op|'.'
name|'account_info'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'accounts'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'accounts'
op|'='
name|'self'
op|'.'
name|'get_update_nodes'
op|'('
name|'account_partition'
op|','
name|'accounts'
op|','
nl|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|')'
newline|'\n'
name|'container_partition'
op|','
name|'containers'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'container_ring'
op|'.'
name|'get_nodes'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'account_name'
op|','
name|'self'
op|'.'
name|'container_name'
op|')'
newline|'\n'
name|'headers'
op|'='
op|'{'
string|"'X-Timestamp'"
op|':'
name|'normalize_timestamp'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|','
nl|'\n'
string|"'x-cf-trans-id'"
op|':'
name|'self'
op|'.'
name|'trans_id'
op|'}'
newline|'\n'
name|'statuses'
op|'='
op|'['
op|']'
newline|'\n'
name|'reasons'
op|'='
op|'['
op|']'
newline|'\n'
name|'bodies'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'node'
name|'in'
name|'self'
op|'.'
name|'iter_nodes'
op|'('
name|'container_partition'
op|','
name|'containers'
op|','
nl|'\n'
name|'self'
op|'.'
name|'app'
op|'.'
name|'container_ring'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'self'
op|'.'
name|'error_limited'
op|'('
name|'node'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'continue'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'account'
op|'='
name|'accounts'
op|'.'
name|'pop'
op|'('
op|')'
newline|'\n'
name|'headers'
op|'['
string|"'X-Account-Host'"
op|']'
op|'='
string|"'%(ip)s:%(port)s'"
op|'%'
name|'account'
newline|'\n'
name|'headers'
op|'['
string|"'X-Account-Partition'"
op|']'
op|'='
name|'account_partition'
newline|'\n'
name|'headers'
op|'['
string|"'X-Account-Device'"
op|']'
op|'='
name|'account'
op|'['
string|"'device'"
op|']'
newline|'\n'
name|'with'
name|'ConnectionTimeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'conn_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'conn'
op|'='
name|'http_connect'
op|'('
name|'node'
op|'['
string|"'ip'"
op|']'
op|','
name|'node'
op|'['
string|"'port'"
op|']'
op|','
nl|'\n'
name|'node'
op|'['
string|"'device'"
op|']'
op|','
name|'container_partition'
op|','
string|"'DELETE'"
op|','
nl|'\n'
name|'req'
op|'.'
name|'path_info'
op|','
name|'headers'
op|')'
newline|'\n'
dedent|''
name|'with'
name|'Timeout'
op|'('
name|'self'
op|'.'
name|'app'
op|'.'
name|'node_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'source'
op|'='
name|'conn'
op|'.'
name|'getresponse'
op|'('
op|')'
newline|'\n'
name|'body'
op|'='
name|'source'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'if'
number|'200'
op|'<='
name|'source'
op|'.'
name|'status'
op|'<'
number|'300'
name|'or'
number|'400'
op|'<='
name|'source'
op|'.'
name|'status'
op|'<'
number|'500'
op|':'
newline|'\n'
indent|'                        '
name|'statuses'
op|'.'
name|'append'
op|'('
name|'source'
op|'.'
name|'status'
op|')'
newline|'\n'
name|'reasons'
op|'.'
name|'append'
op|'('
name|'source'
op|'.'
name|'reason'
op|')'
newline|'\n'
name|'bodies'
op|'.'
name|'append'
op|'('
name|'body'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                        '
name|'if'
name|'source'
op|'.'
name|'status'
op|'=='
number|'507'
op|':'
newline|'\n'
indent|'                            '
name|'self'
op|'.'
name|'error_limit'
op|'('
name|'node'
op|')'
newline|'\n'
dedent|''
name|'accounts'
op|'.'
name|'insert'
op|'('
number|'0'
op|','
name|'account'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'                '
name|'accounts'
op|'.'
name|'insert'
op|'('
number|'0'
op|','
name|'account'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'exception_occurred'
op|'('
name|'node'
op|','
string|"'Container'"
op|','
nl|'\n'
string|"'Trying to DELETE %s'"
op|'%'
name|'req'
op|'.'
name|'path'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'accounts'
op|':'
newline|'\n'
indent|'                '
name|'break'
newline|'\n'
dedent|''
dedent|''
name|'while'
name|'len'
op|'('
name|'statuses'
op|')'
op|'<'
name|'len'
op|'('
name|'containers'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'statuses'
op|'.'
name|'append'
op|'('
number|'503'
op|')'
newline|'\n'
name|'reasons'
op|'.'
name|'append'
op|'('
string|"''"
op|')'
newline|'\n'
name|'bodies'
op|'.'
name|'append'
op|'('
string|"''"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'app'
op|'.'
name|'memcache'
op|'.'
name|'delete'
op|'('
string|"'container%s'"
op|'%'
name|'req'
op|'.'
name|'path_info'
op|'.'
name|'rstrip'
op|'('
string|"'/'"
op|')'
op|')'
newline|'\n'
name|'resp'
op|'='
name|'self'
op|'.'
name|'best_response'
op|'('
name|'req'
op|','
name|'statuses'
op|','
name|'reasons'
op|','
name|'bodies'
op|','
nl|'\n'
string|"'Container DELETE'"
op|')'
newline|'\n'
name|'if'
number|'200'
op|'<='
name|'resp'
op|'.'
name|'status_int'
op|'<='
number|'299'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'status'
name|'in'
name|'statuses'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'status'
op|'<'
number|'200'
name|'or'
name|'status'
op|'>'
number|'299'
op|':'
newline|'\n'
comment|"# If even one node doesn't do the delete, we can't be sure"
nl|'\n'
comment|'# what the outcome will be once everything is in sync; so'
nl|'\n'
comment|'# we 503.'
nl|'\n'
indent|'                    '
name|'self'
op|'.'
name|'app'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'('
string|"'Returning 503 because not all '"
nl|'\n'
string|"'container nodes confirmed DELETE, transaction %s'"
op|'%'
nl|'\n'
name|'self'
op|'.'
name|'trans_id'
op|')'
newline|'\n'
name|'return'
name|'HTTPServiceUnavailable'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'if'
name|'resp'
op|'.'
name|'status_int'
op|'=='
number|'202'
op|':'
comment|'# Indicates no server had the container'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'resp'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|AccountController
dedent|''
dedent|''
name|'class'
name|'AccountController'
op|'('
name|'Controller'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""WSGI controller for account requests"""'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'app'
op|','
name|'account_name'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'Controller'
op|'.'
name|'__init__'
op|'('
name|'self'
op|','
name|'app'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'account_name'
op|'='
name|'unquote'
op|'('
name|'account_name'
op|')'
newline|'\n'
nl|'\n'
DECL|member|GETorHEAD
dedent|''
name|'def'
name|'GETorHEAD'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handler for HTTP GET/HEAD requests."""'
newline|'\n'
name|'partition'
op|','
name|'nodes'
op|'='
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|'.'
name|'get_nodes'
op|'('
name|'self'
op|'.'
name|'account_name'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'GETorHEAD_base'
op|'('
name|'req'
op|','
string|"'Account'"
op|','
name|'partition'
op|','
name|'nodes'
op|','
nl|'\n'
name|'req'
op|'.'
name|'path_info'
op|'.'
name|'rstrip'
op|'('
string|"'/'"
op|')'
op|','
name|'self'
op|'.'
name|'app'
op|'.'
name|'account_ring'
op|'.'
name|'replica_count'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|BaseApplication
dedent|''
dedent|''
name|'class'
name|'BaseApplication'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Base WSGI application for the proxy server"""'
newline|'\n'
nl|'\n'
DECL|variable|log_name
name|'log_name'
op|'='
string|"'base_application'"
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'conf'
op|','
name|'memcache'
op|','
name|'logger'
op|'='
name|'None'
op|','
name|'account_ring'
op|'='
name|'None'
op|','
nl|'\n'
name|'container_ring'
op|'='
name|'None'
op|','
name|'object_ring'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'logger'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'logger'
op|'='
name|'logger'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'logger'
op|'='
name|'get_logger'
op|'('
name|'conf'
op|','
name|'self'
op|'.'
name|'log_name'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'conf'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'conf'
op|'='
op|'{'
op|'}'
newline|'\n'
dedent|''
name|'swift_dir'
op|'='
name|'conf'
op|'.'
name|'get'
op|'('
string|"'swift_dir'"
op|','
string|"'/etc/swift'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'node_timeout'
op|'='
name|'int'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'node_timeout'"
op|','
number|'10'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'conn_timeout'
op|'='
name|'float'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'conn_timeout'"
op|','
number|'0.5'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'client_timeout'
op|'='
name|'int'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'client_timeout'"
op|','
number|'60'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'object_chunk_size'
op|'='
name|'int'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'object_chunk_size'"
op|','
number|'65536'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'client_chunk_size'
op|'='
name|'int'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'client_chunk_size'"
op|','
number|'65536'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'log_headers'
op|'='
name|'conf'
op|'.'
name|'get'
op|'('
string|"'log_headers'"
op|')'
op|'=='
string|"'True'"
newline|'\n'
name|'self'
op|'.'
name|'error_suppression_interval'
op|'='
name|'int'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'error_suppression_interval'"
op|','
number|'60'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'error_suppression_limit'
op|'='
name|'int'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'error_suppression_limit'"
op|','
number|'10'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'recheck_container_existence'
op|'='
name|'int'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'recheck_container_existence'"
op|','
number|'60'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'recheck_account_existence'
op|'='
name|'int'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'recheck_account_existence'"
op|','
number|'60'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'resellers_conf'
op|'='
name|'ConfigParser'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'resellers_conf'
op|'.'
name|'read'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'swift_dir'
op|','
string|"'resellers.conf'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'object_ring'
op|'='
name|'object_ring'
name|'or'
name|'Ring'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'swift_dir'
op|','
string|"'object.ring.gz'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'container_ring'
op|'='
name|'container_ring'
name|'or'
name|'Ring'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'swift_dir'
op|','
string|"'container.ring.gz'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'account_ring'
op|'='
name|'account_ring'
name|'or'
name|'Ring'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'swift_dir'
op|','
string|"'account.ring.gz'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'memcache'
op|'='
name|'memcache'
newline|'\n'
name|'self'
op|'.'
name|'rate_limit'
op|'='
name|'float'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'rate_limit'"
op|','
number|'20000.0'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'account_rate_limit'
op|'='
name|'float'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'account_rate_limit'"
op|','
number|'200.0'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'rate_limit_whitelist'
op|'='
op|'['
name|'x'
op|'.'
name|'strip'
op|'('
op|')'
name|'for'
name|'x'
name|'in'
nl|'\n'
name|'conf'
op|'.'
name|'get'
op|'('
string|"'rate_limit_account_whitelist'"
op|','
string|"''"
op|')'
op|'.'
name|'split'
op|'('
string|"','"
op|')'
nl|'\n'
name|'if'
name|'x'
op|'.'
name|'strip'
op|'('
op|')'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'rate_limit_blacklist'
op|'='
op|'['
name|'x'
op|'.'
name|'strip'
op|'('
op|')'
name|'for'
name|'x'
name|'in'
nl|'\n'
name|'conf'
op|'.'
name|'get'
op|'('
string|"'rate_limit_account_blacklist'"
op|','
string|"''"
op|')'
op|'.'
name|'split'
op|'('
string|"','"
op|')'
nl|'\n'
name|'if'
name|'x'
op|'.'
name|'strip'
op|'('
op|')'
op|']'
newline|'\n'
nl|'\n'
DECL|member|get_controller
dedent|''
name|'def'
name|'get_controller'
op|'('
name|'self'
op|','
name|'path'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Get the controller to handle a request.\n\n        :param path: path from request\n        :returns: tuple of (controller class, path dictionary)\n        """'
newline|'\n'
name|'version'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|'='
name|'split_path'
op|'('
name|'path'
op|','
number|'1'
op|','
number|'4'
op|','
name|'True'
op|')'
newline|'\n'
name|'d'
op|'='
name|'dict'
op|'('
name|'version'
op|'='
name|'version'
op|','
nl|'\n'
name|'account_name'
op|'='
name|'account'
op|','
nl|'\n'
name|'container_name'
op|'='
name|'container'
op|','
nl|'\n'
name|'object_name'
op|'='
name|'obj'
op|')'
newline|'\n'
name|'if'
name|'obj'
name|'and'
name|'container'
name|'and'
name|'account'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'ObjectController'
op|','
name|'d'
newline|'\n'
dedent|''
name|'elif'
name|'container'
name|'and'
name|'account'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'ContainerController'
op|','
name|'d'
newline|'\n'
dedent|''
name|'elif'
name|'account'
name|'and'
name|'not'
name|'container'
name|'and'
name|'not'
name|'obj'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'AccountController'
op|','
name|'d'
newline|'\n'
dedent|''
name|'elif'
name|'version'
name|'and'
name|'version'
op|'=='
string|"'healthcheck'"
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HealthCheckController'
op|','
name|'d'
newline|'\n'
dedent|''
name|'return'
name|'None'
op|','
name|'d'
newline|'\n'
nl|'\n'
DECL|member|__call__
dedent|''
name|'def'
name|'__call__'
op|'('
name|'self'
op|','
name|'env'
op|','
name|'start_response'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        WSGI entry point.\n        Wraps env in webob.Request object and passes it down.\n\n        :param env: WSGI environment dictionary\n        :param start_response: WSGI callable\n        """'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'req'
op|'='
name|'self'
op|'.'
name|'update_request'
op|'('
name|'Request'
op|'('
name|'env'
op|')'
op|')'
newline|'\n'
name|'if'
string|"'eventlet.posthooks'"
name|'in'
name|'env'
op|':'
newline|'\n'
indent|'                '
name|'env'
op|'['
string|"'eventlet.posthooks'"
op|']'
op|'.'
name|'append'
op|'('
nl|'\n'
op|'('
name|'self'
op|'.'
name|'posthooklogger'
op|','
op|'('
name|'req'
op|','
op|')'
op|','
op|'{'
op|'}'
op|')'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'handle_request'
op|'('
name|'req'
op|')'
op|'('
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|'# Lack of posthook support means that we have to log on the'
nl|'\n'
comment|'# start of the response, rather than after all the data has'
nl|'\n'
comment|'# been sent. This prevents logging client disconnects'
nl|'\n'
comment|'# differently than full transmissions.'
nl|'\n'
indent|'                '
name|'response'
op|'='
name|'self'
op|'.'
name|'handle_request'
op|'('
name|'req'
op|')'
op|'('
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'posthooklogger'
op|'('
name|'env'
op|','
name|'req'
op|')'
newline|'\n'
name|'return'
name|'response'
newline|'\n'
dedent|''
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'            '
name|'print'
string|'"EXCEPTION IN __call__: %s"'
op|'%'
name|'env'
newline|'\n'
name|'start_response'
op|'('
string|"'500 Server Error'"
op|','
nl|'\n'
op|'['
op|'('
string|"'Content-Type'"
op|','
string|"'text/plain'"
op|')'
op|']'
op|')'
newline|'\n'
name|'return'
op|'['
string|"'Internal server error.\\n'"
op|']'
newline|'\n'
nl|'\n'
DECL|member|posthooklogger
dedent|''
dedent|''
name|'def'
name|'posthooklogger'
op|'('
name|'self'
op|','
name|'env'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'pass'
newline|'\n'
nl|'\n'
DECL|member|update_request
dedent|''
name|'def'
name|'update_request'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'req'
op|'.'
name|'creation_size'
op|'='
string|"'-'"
newline|'\n'
name|'req'
op|'.'
name|'sent_size'
op|'='
number|'0'
newline|'\n'
name|'req'
op|'.'
name|'client_disconnect'
op|'='
name|'False'
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-cf-trans-id'"
op|']'
op|'='
string|"'tx'"
op|'+'
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|')'
newline|'\n'
name|'if'
string|"'x-storage-token'"
name|'in'
name|'req'
op|'.'
name|'headers'
name|'and'
string|"'x-auth-token'"
name|'not'
name|'in'
name|'req'
op|'.'
name|'headers'
op|':'
newline|'\n'
indent|'            '
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-auth-token'"
op|']'
op|'='
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-storage-token'"
op|']'
newline|'\n'
dedent|''
name|'return'
name|'req'
newline|'\n'
nl|'\n'
DECL|member|handle_request
dedent|''
name|'def'
name|'handle_request'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Entry point for proxy server.\n        Should return a WSGI-style callable (such as webob.Response).\n\n        :param req: webob.Request object\n        """'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'controller'
op|','
name|'path_parts'
op|'='
name|'self'
op|'.'
name|'get_controller'
op|'('
name|'req'
op|'.'
name|'path'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'controller'
op|'=='
name|'HealthCheckController'
op|':'
newline|'\n'
indent|'                '
name|'controller'
op|'='
name|'controller'
op|'('
name|'self'
op|','
op|'**'
name|'path_parts'
op|')'
newline|'\n'
name|'controller'
op|'.'
name|'trans_id'
op|'='
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-cf-trans-id'"
op|','
string|"'-'"
op|')'
newline|'\n'
name|'if'
name|'req'
op|'.'
name|'method'
op|'=='
string|"'GET'"
op|':'
newline|'\n'
indent|'                    '
name|'return'
name|'controller'
op|'.'
name|'GET'
op|'('
name|'req'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'HTTPMethodNotAllowed'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'not'
name|'check_xml_encodable'
op|'('
name|'req'
op|'.'
name|'path_info'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPPreconditionFailed'
op|'('
name|'request'
op|'='
name|'req'
op|','
name|'body'
op|'='
string|"'Invalid UTF8'"
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'controller'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPPreconditionFailed'
op|'('
name|'request'
op|'='
name|'req'
op|','
name|'body'
op|'='
string|"'Bad URL'"
op|')'
newline|'\n'
dedent|''
name|'rate_limit_allowed_err_resp'
op|'='
name|'self'
op|'.'
name|'check_rate_limit'
op|'('
name|'req'
op|','
name|'path_parts'
op|')'
newline|'\n'
name|'if'
name|'rate_limit_allowed_err_resp'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'rate_limit_allowed_err_resp'
newline|'\n'
nl|'\n'
dedent|''
name|'controller'
op|'='
name|'controller'
op|'('
name|'self'
op|','
op|'**'
name|'path_parts'
op|')'
newline|'\n'
name|'controller'
op|'.'
name|'trans_id'
op|'='
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-cf-trans-id'"
op|','
string|"'-'"
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'handler'
op|'='
name|'getattr'
op|'('
name|'controller'
op|','
name|'req'
op|'.'
name|'method'
op|')'
newline|'\n'
name|'if'
name|'getattr'
op|'('
name|'handler'
op|','
string|"'publicly_accessible'"
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'if'
name|'path_parts'
op|'['
string|"'version'"
op|']'
op|':'
newline|'\n'
indent|'                        '
name|'req'
op|'.'
name|'path_info_pop'
op|'('
op|')'
newline|'\n'
dedent|''
name|'return'
name|'handler'
op|'('
name|'req'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'AttributeError'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPMethodNotAllowed'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'exception'
op|'('
string|"'ERROR Unhandled exception in request'"
op|')'
newline|'\n'
name|'return'
name|'HTTPServerError'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
DECL|member|check_rate_limit
dedent|''
dedent|''
name|'def'
name|'check_rate_limit'
op|'('
name|'self'
op|','
name|'req'
op|','
name|'path_parts'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Check for rate limiting."""'
newline|'\n'
name|'return'
name|'None'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|Application
dedent|''
dedent|''
name|'class'
name|'Application'
op|'('
name|'BaseApplication'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""WSGI application for the proxy server."""'
newline|'\n'
nl|'\n'
DECL|variable|log_name
name|'log_name'
op|'='
string|"'proxy'"
newline|'\n'
nl|'\n'
DECL|member|handle_request
name|'def'
name|'handle_request'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Wraps the BaseApplication.handle_request and logs the request.\n        """'
newline|'\n'
name|'req'
op|'.'
name|'start_time'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'req'
op|'.'
name|'response'
op|'='
name|'super'
op|'('
name|'Application'
op|','
name|'self'
op|')'
op|'.'
name|'handle_request'
op|'('
name|'req'
op|')'
newline|'\n'
name|'return'
name|'req'
op|'.'
name|'response'
newline|'\n'
nl|'\n'
DECL|member|posthooklogger
dedent|''
name|'def'
name|'posthooklogger'
op|'('
name|'self'
op|','
name|'env'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'response'
op|'='
name|'req'
op|'.'
name|'response'
newline|'\n'
name|'trans_time'
op|'='
string|"'%.4f'"
op|'%'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'-'
name|'req'
op|'.'
name|'start_time'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'response'
op|'.'
name|'content_length'
name|'and'
name|'response'
op|'.'
name|'app_iter'
name|'and'
name|'hasattr'
op|'('
name|'response'
op|'.'
name|'app_iter'
op|','
string|"'__len__'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'response'
op|'.'
name|'content_length'
op|'='
name|'sum'
op|'('
name|'map'
op|'('
name|'len'
op|','
name|'response'
op|'.'
name|'app_iter'
op|')'
op|')'
newline|'\n'
dedent|''
name|'the_request'
op|'='
name|'quote'
op|'('
name|'unquote'
op|'('
name|'req'
op|'.'
name|'path'
op|')'
op|')'
newline|'\n'
name|'if'
name|'req'
op|'.'
name|'query_string'
op|':'
newline|'\n'
indent|'            '
name|'the_request'
op|'='
name|'the_request'
op|'+'
string|"'?'"
op|'+'
name|'req'
op|'.'
name|'query_string'
newline|'\n'
comment|'# remote user for zeus'
nl|'\n'
dedent|''
name|'client'
op|'='
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-cluster-client-ip'"
op|')'
newline|'\n'
name|'if'
name|'not'
name|'client'
name|'and'
string|"'x-forwarded-for'"
name|'in'
name|'req'
op|'.'
name|'headers'
op|':'
newline|'\n'
comment|'# remote user for other lbs'
nl|'\n'
indent|'            '
name|'client'
op|'='
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-forwarded-for'"
op|']'
op|'.'
name|'split'
op|'('
string|"','"
op|')'
op|'['
number|'0'
op|']'
op|'.'
name|'strip'
op|'('
op|')'
newline|'\n'
dedent|''
name|'raw_in'
op|'='
name|'req'
op|'.'
name|'content_length'
name|'or'
number|'0'
newline|'\n'
name|'if'
name|'req'
op|'.'
name|'creation_size'
op|'!='
string|"'-'"
op|':'
newline|'\n'
indent|'            '
name|'raw_in'
op|'='
name|'req'
op|'.'
name|'creation_size'
newline|'\n'
dedent|''
name|'raw_out'
op|'='
number|'0'
newline|'\n'
name|'if'
name|'req'
op|'.'
name|'method'
op|'!='
string|"'HEAD'"
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'response'
op|'.'
name|'content_length'
op|':'
newline|'\n'
indent|'                '
name|'raw_out'
op|'='
name|'response'
op|'.'
name|'content_length'
newline|'\n'
dedent|''
name|'if'
name|'req'
op|'.'
name|'sent_size'
name|'or'
name|'req'
op|'.'
name|'client_disconnect'
op|':'
newline|'\n'
indent|'                '
name|'raw_out'
op|'='
name|'req'
op|'.'
name|'sent_size'
newline|'\n'
dedent|''
dedent|''
name|'logged_headers'
op|'='
name|'None'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'log_headers'
op|':'
newline|'\n'
indent|'            '
name|'logged_headers'
op|'='
string|"'\\n'"
op|'.'
name|'join'
op|'('
string|"'%s: %s'"
op|'%'
op|'('
name|'k'
op|','
name|'v'
op|')'
nl|'\n'
name|'for'
name|'k'
op|','
name|'v'
name|'in'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'items'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
name|'status_int'
op|'='
name|'req'
op|'.'
name|'client_disconnect'
name|'and'
number|'499'
name|'or'
name|'response'
op|'.'
name|'status_int'
newline|'\n'
name|'self'
op|'.'
name|'logger'
op|'.'
name|'info'
op|'('
string|"' '"
op|'.'
name|'join'
op|'('
name|'quote'
op|'('
name|'str'
op|'('
name|'x'
op|')'
op|')'
name|'for'
name|'x'
name|'in'
op|'('
nl|'\n'
name|'client'
name|'or'
string|"'-'"
op|','
nl|'\n'
name|'req'
op|'.'
name|'remote_addr'
name|'or'
string|"'-'"
op|','
nl|'\n'
name|'time'
op|'.'
name|'strftime'
op|'('
string|"'%d/%b/%Y/%H/%M/%S'"
op|','
name|'time'
op|'.'
name|'gmtime'
op|'('
op|')'
op|')'
op|','
nl|'\n'
name|'req'
op|'.'
name|'method'
op|','
nl|'\n'
name|'the_request'
op|','
nl|'\n'
name|'req'
op|'.'
name|'environ'
op|'['
string|"'SERVER_PROTOCOL'"
op|']'
op|','
nl|'\n'
name|'status_int'
op|','
nl|'\n'
name|'req'
op|'.'
name|'referer'
name|'or'
string|"'-'"
op|','
nl|'\n'
name|'req'
op|'.'
name|'user_agent'
name|'or'
string|"'-'"
op|','
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-auth-token'"
op|','
string|"'-'"
op|')'
op|','
nl|'\n'
name|'raw_in'
name|'or'
string|"'-'"
op|','
nl|'\n'
name|'raw_out'
name|'or'
string|"'-'"
op|','
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'etag'"
op|','
string|"'-'"
op|')'
op|','
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-cf-trans-id'"
op|','
string|"'-'"
op|')'
op|','
nl|'\n'
name|'logged_headers'
name|'or'
string|"'-'"
op|','
nl|'\n'
name|'trans_time'
op|','
nl|'\n'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|check_rate_limit
dedent|''
name|'def'
name|'check_rate_limit'
op|'('
name|'self'
op|','
name|'req'
op|','
name|'path_parts'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Check for rate limiting.\n\n        :param req: webob.Request object\n        :param path_parts: parsed path dictionary\n        """'
newline|'\n'
name|'if'
name|'path_parts'
op|'['
string|"'account_name'"
op|']'
name|'in'
name|'self'
op|'.'
name|'rate_limit_blacklist'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'('
string|"'Returning 497 because of blacklisting'"
op|')'
newline|'\n'
name|'return'
name|'Response'
op|'('
name|'status'
op|'='
string|"'497 Blacklisted'"
op|','
nl|'\n'
name|'body'
op|'='
string|"'Your account has been blacklisted'"
op|','
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'path_parts'
op|'['
string|"'account_name'"
op|']'
name|'not'
name|'in'
name|'self'
op|'.'
name|'rate_limit_whitelist'
op|':'
newline|'\n'
indent|'            '
name|'current_second'
op|'='
name|'time'
op|'.'
name|'strftime'
op|'('
string|"'%x%H%M%S'"
op|')'
newline|'\n'
name|'general_rate_limit_key'
op|'='
string|"'%s%s'"
op|'%'
op|'('
name|'path_parts'
op|'['
string|"'account_name'"
op|']'
op|','
nl|'\n'
name|'current_second'
op|')'
newline|'\n'
name|'ops_count'
op|'='
name|'self'
op|'.'
name|'memcache'
op|'.'
name|'incr'
op|'('
name|'general_rate_limit_key'
op|','
name|'timeout'
op|'='
number|'2'
op|')'
newline|'\n'
name|'if'
name|'ops_count'
op|'>'
name|'self'
op|'.'
name|'rate_limit'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'('
nl|'\n'
string|"'Returning 498 because of ops rate limiting'"
op|')'
newline|'\n'
name|'return'
name|'Response'
op|'('
name|'status'
op|'='
string|"'498 Rate Limited'"
op|','
nl|'\n'
name|'body'
op|'='
string|"'Slow down'"
op|','
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'elif'
op|'('
name|'path_parts'
op|'['
string|"'container_name'"
op|']'
nl|'\n'
name|'and'
name|'not'
name|'path_parts'
op|'['
string|"'object_name'"
op|']'
op|')'
name|'or'
op|'('
name|'path_parts'
op|'['
string|"'account_name'"
op|']'
nl|'\n'
name|'and'
name|'not'
name|'path_parts'
op|'['
string|"'container_name'"
op|']'
op|')'
op|':'
newline|'\n'
comment|'# further limit operations on a single account or container'
nl|'\n'
indent|'                '
name|'rate_limit_key'
op|'='
string|"'%s%s%s'"
op|'%'
op|'('
name|'path_parts'
op|'['
string|"'account_name'"
op|']'
op|','
nl|'\n'
name|'path_parts'
op|'['
string|"'container_name'"
op|']'
name|'or'
string|"'-'"
op|','
nl|'\n'
name|'current_second'
op|')'
newline|'\n'
name|'ops_count'
op|'='
name|'self'
op|'.'
name|'memcache'
op|'.'
name|'incr'
op|'('
name|'rate_limit_key'
op|','
name|'timeout'
op|'='
number|'2'
op|')'
newline|'\n'
name|'if'
name|'ops_count'
op|'>'
name|'self'
op|'.'
name|'account_rate_limit'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'('
nl|'\n'
string|"'Returning 498 because of account and container'"
nl|'\n'
string|"' rate limiting'"
op|')'
newline|'\n'
name|'return'
name|'Response'
op|'('
name|'status'
op|'='
string|"'498 Rate Limited'"
op|','
nl|'\n'
name|'body'
op|'='
string|"'Slow down'"
op|','
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'return'
name|'None'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit

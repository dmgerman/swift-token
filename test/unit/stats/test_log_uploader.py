begin_unit
comment|'# Copyright (c) 2010-2011 OpenStack, LLC.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'unittest'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'from'
name|'datetime'
name|'import'
name|'datetime'
newline|'\n'
name|'from'
name|'tempfile'
name|'import'
name|'mkdtemp'
newline|'\n'
name|'from'
name|'shutil'
name|'import'
name|'rmtree'
newline|'\n'
name|'from'
name|'functools'
name|'import'
name|'partial'
newline|'\n'
name|'from'
name|'collections'
name|'import'
name|'defaultdict'
newline|'\n'
name|'import'
name|'random'
newline|'\n'
name|'import'
name|'string'
newline|'\n'
nl|'\n'
name|'from'
name|'test'
op|'.'
name|'unit'
name|'import'
name|'temptree'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'stats'
name|'import'
name|'log_uploader'
newline|'\n'
nl|'\n'
name|'import'
name|'logging'
newline|'\n'
name|'logging'
op|'.'
name|'basicConfig'
op|'('
name|'level'
op|'='
name|'logging'
op|'.'
name|'DEBUG'
op|')'
newline|'\n'
DECL|variable|LOGGER
name|'LOGGER'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'COMPRESSED_DATA'
op|'='
string|"'\\x1f\\x8b\\x08\\x08\\x87\\xa5zM\\x02\\xffdata\\x00KI,I\\x04\\x00c'"
DECL|variable|COMPRESSED_DATA
string|"'\\xf3\\xf3\\xad\\x04\\x00\\x00\\x00'"
newline|'\n'
nl|'\n'
name|'access_regex'
op|'='
string|"'''\n    ^\n    (?P<year>[0-9]{4})\n    (?P<month>[0-1][0-9])\n    (?P<day>[0-3][0-9])\n    (?P<hour>[0-2][0-9])\n    .*$\n    '''"
newline|'\n'
nl|'\n'
DECL|function|mock_appconfig
name|'def'
name|'mock_appconfig'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'pass'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|MockInternalProxy
dedent|''
name|'class'
name|'MockInternalProxy'
op|'('
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'pass'
newline|'\n'
nl|'\n'
DECL|member|create_container
dedent|''
name|'def'
name|'create_container'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'True'
newline|'\n'
nl|'\n'
DECL|member|upload_file
dedent|''
name|'def'
name|'upload_file'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'True'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|_orig_LogUploader
dedent|''
dedent|''
name|'_orig_LogUploader'
op|'='
name|'log_uploader'
op|'.'
name|'LogUploader'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|MockLogUploader
name|'class'
name|'MockLogUploader'
op|'('
name|'_orig_LogUploader'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'conf'
op|','
name|'logger'
op|'='
name|'LOGGER'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'conf'
op|'['
string|"'swift_account'"
op|']'
op|'='
name|'conf'
op|'.'
name|'get'
op|'('
string|"'swift_account'"
op|','
string|"''"
op|')'
newline|'\n'
name|'conf'
op|'['
string|"'container_name'"
op|']'
op|'='
name|'conf'
op|'.'
name|'get'
op|'('
string|"'container_name'"
op|','
string|"''"
op|')'
newline|'\n'
name|'conf'
op|'['
string|"'new_log_cutoff'"
op|']'
op|'='
name|'conf'
op|'.'
name|'get'
op|'('
string|"'new_log_cutoff'"
op|','
string|"'0'"
op|')'
newline|'\n'
name|'conf'
op|'['
string|"'source_filename_format'"
op|']'
op|'='
name|'conf'
op|'.'
name|'get'
op|'('
nl|'\n'
string|"'source_filename_format'"
op|','
name|'conf'
op|'.'
name|'get'
op|'('
string|"'filename_format'"
op|')'
op|')'
newline|'\n'
name|'log_uploader'
op|'.'
name|'LogUploader'
op|'.'
name|'__init__'
op|'('
name|'self'
op|','
name|'conf'
op|','
string|"'plugin'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'logger'
op|'='
name|'logger'
newline|'\n'
name|'self'
op|'.'
name|'uploaded_files'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
DECL|member|upload_one_log
dedent|''
name|'def'
name|'upload_one_log'
op|'('
name|'self'
op|','
name|'filename'
op|','
name|'year'
op|','
name|'month'
op|','
name|'day'
op|','
name|'hour'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'d'
op|'='
op|'{'
string|"'year'"
op|':'
name|'year'
op|','
string|"'month'"
op|':'
name|'month'
op|','
string|"'day'"
op|':'
name|'day'
op|','
string|"'hour'"
op|':'
name|'hour'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'uploaded_files'
op|'.'
name|'append'
op|'('
op|'('
name|'filename'
op|','
name|'d'
op|')'
op|')'
newline|'\n'
name|'_orig_LogUploader'
op|'.'
name|'upload_one_log'
op|'('
name|'self'
op|','
name|'filename'
op|','
name|'year'
op|','
name|'month'
op|','
nl|'\n'
name|'day'
op|','
name|'hour'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|TestLogUploader
dedent|''
dedent|''
name|'class'
name|'TestLogUploader'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# mock internal proxy'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'_orig_InternalProxy'
op|'='
name|'log_uploader'
op|'.'
name|'InternalProxy'
newline|'\n'
name|'self'
op|'.'
name|'_orig_appconfig'
op|'='
name|'log_uploader'
op|'.'
name|'appconfig'
newline|'\n'
name|'log_uploader'
op|'.'
name|'InternalProxy'
op|'='
name|'MockInternalProxy'
newline|'\n'
name|'log_uploader'
op|'.'
name|'appconfig'
op|'='
name|'mock_appconfig'
newline|'\n'
nl|'\n'
DECL|member|tearDown
dedent|''
name|'def'
name|'tearDown'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'log_uploader'
op|'.'
name|'appconfig'
op|'='
name|'self'
op|'.'
name|'_orig_appconfig'
newline|'\n'
name|'log_uploader'
op|'.'
name|'InternalProxy'
op|'='
name|'self'
op|'.'
name|'_orig_InternalProxy'
newline|'\n'
nl|'\n'
DECL|member|test_bad_pattern_in_config
dedent|''
name|'def'
name|'test_bad_pattern_in_config'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'files'
op|'='
op|'['
name|'datetime'
op|'.'
name|'now'
op|'('
op|')'
op|'.'
name|'strftime'
op|'('
string|"'%Y%m%d%H'"
op|')'
op|']'
newline|'\n'
name|'with'
name|'temptree'
op|'('
name|'files'
op|','
name|'contents'
op|'='
op|'['
name|'COMPRESSED_DATA'
op|']'
op|'*'
name|'len'
op|'('
name|'files'
op|')'
op|')'
name|'as'
name|'t'
op|':'
newline|'\n'
comment|'# invalid pattern'
nl|'\n'
indent|'            '
name|'conf'
op|'='
op|'{'
string|"'log_dir'"
op|':'
name|'t'
op|','
nl|'\n'
string|"'source_filename_pattern'"
op|':'
string|"'%Y%m%d%h'"
op|'}'
comment|'# should be %H'
newline|'\n'
name|'uploader'
op|'='
name|'MockLogUploader'
op|'('
name|'conf'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'SystemExit'
op|','
name|'uploader'
op|'.'
name|'upload_all_logs'
op|')'
newline|'\n'
nl|'\n'
name|'conf'
op|'='
op|'{'
string|"'log_dir'"
op|':'
name|'t'
op|','
string|"'source_filename_pattern'"
op|':'
name|'access_regex'
op|'}'
newline|'\n'
name|'uploader'
op|'='
name|'MockLogUploader'
op|'('
name|'conf'
op|')'
newline|'\n'
name|'uploader'
op|'.'
name|'upload_all_logs'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'uploader'
op|'.'
name|'uploaded_files'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_pattern_upload_all_logs
dedent|''
dedent|''
name|'def'
name|'test_pattern_upload_all_logs'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
nl|'\n'
comment|'# test empty dir'
nl|'\n'
indent|'        '
name|'with'
name|'temptree'
op|'('
op|'['
op|']'
op|')'
name|'as'
name|'t'
op|':'
newline|'\n'
indent|'            '
name|'conf'
op|'='
op|'{'
string|"'log_dir'"
op|':'
name|'t'
op|'}'
newline|'\n'
name|'uploader'
op|'='
name|'MockLogUploader'
op|'('
name|'conf'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'SystemExit'
op|','
name|'uploader'
op|'.'
name|'run_once'
op|')'
newline|'\n'
nl|'\n'
DECL|function|get_random_length_str
dedent|''
name|'def'
name|'get_random_length_str'
op|'('
name|'max_len'
op|'='
number|'10'
op|','
name|'chars'
op|'='
name|'string'
op|'.'
name|'ascii_letters'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
string|"''"
op|'.'
name|'join'
op|'('
name|'random'
op|'.'
name|'choice'
op|'('
name|'chars'
op|')'
name|'for'
name|'x'
name|'in'
nl|'\n'
name|'range'
op|'('
name|'random'
op|'.'
name|'randint'
op|'('
number|'1'
op|','
name|'max_len'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'template'
op|'='
string|"'prefix_%(random)s_%(digits)s.blah.'"
string|"'%(datestr)s%(hour)0.2d00-%(next_hour)0.2d00-%(number)s.gz'"
newline|'\n'
name|'pattern'
op|'='
string|"'''prefix_.*_[0-9]+\\.blah\\.\n                     (?P<year>[0-9]{4})\n                     (?P<month>[0-1][0-9])\n                     (?P<day>[0-3][0-9])\n                     (?P<hour>[0-2][0-9])00-[0-9]{2}00\n                     -[0-9]?[0-9]\\.gz'''"
newline|'\n'
name|'files_that_should_match'
op|'='
op|'['
op|']'
newline|'\n'
comment|'# add some files that match'
nl|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
number|'24'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'fname'
op|'='
name|'template'
op|'%'
op|'{'
nl|'\n'
string|"'random'"
op|':'
name|'get_random_length_str'
op|'('
op|')'
op|','
nl|'\n'
string|"'digits'"
op|':'
name|'get_random_length_str'
op|'('
number|'16'
op|','
name|'string'
op|'.'
name|'digits'
op|')'
op|','
nl|'\n'
string|"'datestr'"
op|':'
name|'datetime'
op|'.'
name|'now'
op|'('
op|')'
op|'.'
name|'strftime'
op|'('
string|"'%Y%m%d'"
op|')'
op|','
nl|'\n'
string|"'hour'"
op|':'
name|'i'
op|','
nl|'\n'
string|"'next_hour'"
op|':'
name|'i'
op|'+'
number|'1'
op|','
nl|'\n'
string|"'number'"
op|':'
name|'random'
op|'.'
name|'randint'
op|'('
number|'0'
op|','
number|'20'
op|')'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'files_that_should_match'
op|'.'
name|'append'
op|'('
name|'fname'
op|')'
newline|'\n'
nl|'\n'
comment|"# add some files that don't match"
nl|'\n'
dedent|''
name|'files'
op|'='
name|'list'
op|'('
name|'files_that_should_match'
op|')'
newline|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
number|'24'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'fname'
op|'='
name|'template'
op|'%'
op|'{'
nl|'\n'
string|"'random'"
op|':'
name|'get_random_length_str'
op|'('
op|')'
op|','
nl|'\n'
string|"'digits'"
op|':'
name|'get_random_length_str'
op|'('
number|'16'
op|','
name|'string'
op|'.'
name|'digits'
op|')'
op|','
nl|'\n'
string|"'datestr'"
op|':'
name|'datetime'
op|'.'
name|'now'
op|'('
op|')'
op|'.'
name|'strftime'
op|'('
string|"'%Y%m'"
op|')'
op|','
nl|'\n'
string|"'hour'"
op|':'
name|'i'
op|','
nl|'\n'
string|"'next_hour'"
op|':'
name|'i'
op|'+'
number|'1'
op|','
nl|'\n'
string|"'number'"
op|':'
name|'random'
op|'.'
name|'randint'
op|'('
number|'0'
op|','
number|'20'
op|')'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'files'
op|'.'
name|'append'
op|'('
name|'fname'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'for'
name|'fname'
name|'in'
name|'files'
op|':'
newline|'\n'
indent|'            '
name|'print'
name|'fname'
newline|'\n'
nl|'\n'
dedent|''
name|'with'
name|'temptree'
op|'('
name|'files'
op|','
name|'contents'
op|'='
op|'['
name|'COMPRESSED_DATA'
op|']'
op|'*'
name|'len'
op|'('
name|'files'
op|')'
op|')'
name|'as'
name|'t'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'os'
op|'.'
name|'listdir'
op|'('
name|'t'
op|')'
op|')'
op|','
number|'48'
op|')'
newline|'\n'
name|'conf'
op|'='
op|'{'
string|"'source_filename_pattern'"
op|':'
name|'pattern'
op|','
string|"'log_dir'"
op|':'
name|'t'
op|'}'
newline|'\n'
name|'uploader'
op|'='
name|'MockLogUploader'
op|'('
name|'conf'
op|')'
newline|'\n'
name|'uploader'
op|'.'
name|'run_once'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'os'
op|'.'
name|'listdir'
op|'('
name|'t'
op|')'
op|')'
op|','
number|'24'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'uploader'
op|'.'
name|'uploaded_files'
op|')'
op|','
number|'24'
op|')'
newline|'\n'
name|'files_that_were_uploaded'
op|'='
name|'set'
op|'('
name|'x'
op|'['
number|'0'
op|']'
name|'for'
name|'x'
name|'in'
nl|'\n'
name|'uploader'
op|'.'
name|'uploaded_files'
op|')'
newline|'\n'
name|'for'
name|'f'
name|'in'
name|'files_that_should_match'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assert_'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'t'
op|','
name|'f'
op|')'
name|'in'
name|'files_that_were_uploaded'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_log_cutoff
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_log_cutoff'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'files'
op|'='
op|'['
name|'datetime'
op|'.'
name|'now'
op|'('
op|')'
op|'.'
name|'strftime'
op|'('
string|"'%Y%m%d%H'"
op|')'
op|']'
newline|'\n'
name|'with'
name|'temptree'
op|'('
name|'files'
op|')'
name|'as'
name|'t'
op|':'
newline|'\n'
indent|'            '
name|'conf'
op|'='
op|'{'
string|"'log_dir'"
op|':'
name|'t'
op|','
string|"'new_log_cutoff'"
op|':'
string|"'7200'"
op|','
nl|'\n'
string|"'source_filename_pattern'"
op|':'
name|'access_regex'
op|'}'
newline|'\n'
name|'uploader'
op|'='
name|'MockLogUploader'
op|'('
name|'conf'
op|')'
newline|'\n'
name|'uploader'
op|'.'
name|'run_once'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'uploader'
op|'.'
name|'uploaded_files'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
name|'conf'
op|'='
op|'{'
string|"'log_dir'"
op|':'
name|'t'
op|','
string|"'new_log_cutoff'"
op|':'
string|"'0'"
op|','
nl|'\n'
string|"'source_filename_pattern'"
op|':'
name|'access_regex'
op|'}'
newline|'\n'
name|'uploader'
op|'='
name|'MockLogUploader'
op|'('
name|'conf'
op|')'
newline|'\n'
name|'uploader'
op|'.'
name|'run_once'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'uploader'
op|'.'
name|'uploaded_files'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_container_fail
dedent|''
dedent|''
name|'def'
name|'test_create_container_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'files'
op|'='
op|'['
name|'datetime'
op|'.'
name|'now'
op|'('
op|')'
op|'.'
name|'strftime'
op|'('
string|"'%Y%m%d%H'"
op|')'
op|']'
newline|'\n'
name|'conf'
op|'='
op|'{'
string|"'source_filename_pattern'"
op|':'
name|'access_regex'
op|'}'
newline|'\n'
name|'with'
name|'temptree'
op|'('
name|'files'
op|')'
name|'as'
name|'t'
op|':'
newline|'\n'
indent|'            '
name|'conf'
op|'['
string|"'log_dir'"
op|']'
op|'='
name|'t'
newline|'\n'
name|'uploader'
op|'='
name|'MockLogUploader'
op|'('
name|'conf'
op|')'
newline|'\n'
name|'uploader'
op|'.'
name|'run_once'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'uploader'
op|'.'
name|'uploaded_files'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'with'
name|'temptree'
op|'('
name|'files'
op|')'
name|'as'
name|'t'
op|':'
newline|'\n'
indent|'            '
name|'conf'
op|'['
string|"'log_dir'"
op|']'
op|'='
name|'t'
newline|'\n'
name|'uploader'
op|'='
name|'MockLogUploader'
op|'('
name|'conf'
op|')'
newline|'\n'
comment|'# mock create_container to fail'
nl|'\n'
name|'uploader'
op|'.'
name|'internal_proxy'
op|'.'
name|'create_container'
op|'='
name|'lambda'
op|'*'
name|'args'
op|':'
name|'False'
newline|'\n'
name|'uploader'
op|'.'
name|'run_once'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'uploader'
op|'.'
name|'uploaded_files'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_unlink_log
dedent|''
dedent|''
name|'def'
name|'test_unlink_log'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'files'
op|'='
op|'['
name|'datetime'
op|'.'
name|'now'
op|'('
op|')'
op|'.'
name|'strftime'
op|'('
string|"'%Y%m%d%H'"
op|')'
op|']'
newline|'\n'
name|'with'
name|'temptree'
op|'('
name|'files'
op|','
name|'contents'
op|'='
op|'['
name|'COMPRESSED_DATA'
op|']'
op|')'
name|'as'
name|'t'
op|':'
newline|'\n'
indent|'            '
name|'conf'
op|'='
op|'{'
string|"'log_dir'"
op|':'
name|'t'
op|','
string|"'unlink_log'"
op|':'
string|"'false'"
op|','
nl|'\n'
string|"'source_filename_pattern'"
op|':'
name|'access_regex'
op|'}'
newline|'\n'
name|'uploader'
op|'='
name|'MockLogUploader'
op|'('
name|'conf'
op|')'
newline|'\n'
name|'uploader'
op|'.'
name|'run_once'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'uploader'
op|'.'
name|'uploaded_files'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# file still there'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'os'
op|'.'
name|'listdir'
op|'('
name|'t'
op|')'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'conf'
op|'='
op|'{'
string|"'log_dir'"
op|':'
name|'t'
op|','
string|"'unlink_log'"
op|':'
string|"'true'"
op|','
nl|'\n'
string|"'source_filename_pattern'"
op|':'
name|'access_regex'
op|'}'
newline|'\n'
name|'uploader'
op|'='
name|'MockLogUploader'
op|'('
name|'conf'
op|')'
newline|'\n'
name|'uploader'
op|'.'
name|'run_once'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'uploader'
op|'.'
name|'uploaded_files'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
comment|'# file gone'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'os'
op|'.'
name|'listdir'
op|'('
name|'t'
op|')'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_upload_file_failed
dedent|''
dedent|''
name|'def'
name|'test_upload_file_failed'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'files'
op|'='
op|'['
string|"'plugin-%s'"
op|'%'
name|'datetime'
op|'.'
name|'now'
op|'('
op|')'
op|'.'
name|'strftime'
op|'('
string|"'%Y%m%d%H'"
op|')'
op|']'
newline|'\n'
name|'with'
name|'temptree'
op|'('
name|'files'
op|','
name|'contents'
op|'='
op|'['
name|'COMPRESSED_DATA'
op|']'
op|')'
name|'as'
name|'t'
op|':'
newline|'\n'
indent|'            '
name|'conf'
op|'='
op|'{'
string|"'log_dir'"
op|':'
name|'t'
op|','
string|"'unlink_log'"
op|':'
string|"'true'"
op|','
nl|'\n'
string|"'source_filename_pattern'"
op|':'
name|'access_regex'
op|'}'
newline|'\n'
name|'uploader'
op|'='
name|'MockLogUploader'
op|'('
name|'conf'
op|')'
newline|'\n'
nl|'\n'
comment|'# mock upload_file to fail, and clean up mock'
nl|'\n'
DECL|function|mock_upload_file
name|'def'
name|'mock_upload_file'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'uploader'
op|'.'
name|'uploaded_files'
op|'.'
name|'pop'
op|'('
op|')'
newline|'\n'
name|'return'
name|'False'
newline|'\n'
dedent|''
name|'uploader'
op|'.'
name|'internal_proxy'
op|'.'
name|'upload_file'
op|'='
name|'mock_upload_file'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'SystemExit'
op|','
name|'uploader'
op|'.'
name|'run_once'
op|')'
newline|'\n'
comment|'# file still there'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'os'
op|'.'
name|'listdir'
op|'('
name|'t'
op|')'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
name|'if'
name|'__name__'
op|'=='
string|"'__main__'"
op|':'
newline|'\n'
indent|'    '
name|'unittest'
op|'.'
name|'main'
op|'('
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit

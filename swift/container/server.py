begin_unit
comment|'# Copyright (c) 2010-2012 OpenStack Foundation'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'json'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'time'
newline|'\n'
name|'import'
name|'traceback'
newline|'\n'
name|'from'
name|'swift'
name|'import'
name|'gettext_'
name|'as'
name|'_'
newline|'\n'
name|'from'
name|'xml'
op|'.'
name|'etree'
op|'.'
name|'cElementTree'
name|'import'
name|'Element'
op|','
name|'SubElement'
op|','
name|'tostring'
newline|'\n'
nl|'\n'
name|'from'
name|'eventlet'
name|'import'
name|'Timeout'
newline|'\n'
nl|'\n'
name|'import'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'db'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'container'
op|'.'
name|'sync_store'
name|'import'
name|'ContainerSyncStore'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'container'
op|'.'
name|'backend'
name|'import'
name|'ContainerBroker'
op|','
name|'DATADIR'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'container'
op|'.'
name|'replicator'
name|'import'
name|'ContainerReplicatorRpc'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'db'
name|'import'
name|'DatabaseAlreadyExists'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'container_sync_realms'
name|'import'
name|'ContainerSyncRealms'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'request_helpers'
name|'import'
name|'get_param'
op|','
name|'get_listing_content_type'
op|','
name|'split_and_validate_path'
op|','
name|'is_sys_or_user_meta'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'get_logger'
op|','
name|'hash_path'
op|','
name|'public'
op|','
name|'Timestamp'
op|','
name|'storage_directory'
op|','
name|'validate_sync_to'
op|','
name|'config_true_value'
op|','
name|'timing_stats'
op|','
name|'replication'
op|','
name|'override_bytes_from_content_type'
op|','
name|'get_log_line'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'constraints'
name|'import'
name|'check_mount'
op|','
name|'valid_timestamp'
op|','
name|'check_utf8'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'constraints'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'bufferedhttp'
name|'import'
name|'http_connect'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'exceptions'
name|'import'
name|'ConnectionTimeout'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'http'
name|'import'
name|'HTTP_NOT_FOUND'
op|','
name|'is_success'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'storage_policy'
name|'import'
name|'POLICIES'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'base_storage_server'
name|'import'
name|'BaseStorageServer'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'swob'
name|'import'
name|'HTTPAccepted'
op|','
name|'HTTPBadRequest'
op|','
name|'HTTPConflict'
op|','
name|'HTTPCreated'
op|','
name|'HTTPInternalServerError'
op|','
name|'HTTPNoContent'
op|','
name|'HTTPNotFound'
op|','
name|'HTTPPreconditionFailed'
op|','
name|'HTTPMethodNotAllowed'
op|','
name|'Request'
op|','
name|'Response'
op|','
name|'HTTPInsufficientStorage'
op|','
name|'HTTPException'
op|','
name|'HeaderKeyDict'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|gen_resp_headers
name|'def'
name|'gen_resp_headers'
op|'('
name|'info'
op|','
name|'is_deleted'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Convert container info dict to headers.\n    """'
newline|'\n'
comment|'# backend headers are always included'
nl|'\n'
name|'headers'
op|'='
op|'{'
nl|'\n'
string|"'X-Backend-Timestamp'"
op|':'
name|'Timestamp'
op|'('
name|'info'
op|'.'
name|'get'
op|'('
string|"'created_at'"
op|','
number|'0'
op|')'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
string|"'X-Backend-PUT-Timestamp'"
op|':'
name|'Timestamp'
op|'('
name|'info'
op|'.'
name|'get'
op|'('
nl|'\n'
string|"'put_timestamp'"
op|','
number|'0'
op|')'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
string|"'X-Backend-DELETE-Timestamp'"
op|':'
name|'Timestamp'
op|'('
nl|'\n'
name|'info'
op|'.'
name|'get'
op|'('
string|"'delete_timestamp'"
op|','
number|'0'
op|')'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
string|"'X-Backend-Status-Changed-At'"
op|':'
name|'Timestamp'
op|'('
nl|'\n'
name|'info'
op|'.'
name|'get'
op|'('
string|"'status_changed_at'"
op|','
number|'0'
op|')'
op|')'
op|'.'
name|'internal'
op|','
nl|'\n'
string|"'X-Backend-Storage-Policy-Index'"
op|':'
name|'info'
op|'.'
name|'get'
op|'('
string|"'storage_policy_index'"
op|','
number|'0'
op|')'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'if'
name|'not'
name|'is_deleted'
op|':'
newline|'\n'
comment|'# base container info on deleted containers is not exposed to client'
nl|'\n'
indent|'        '
name|'headers'
op|'.'
name|'update'
op|'('
op|'{'
nl|'\n'
string|"'X-Container-Object-Count'"
op|':'
name|'info'
op|'.'
name|'get'
op|'('
string|"'object_count'"
op|','
number|'0'
op|')'
op|','
nl|'\n'
string|"'X-Container-Bytes-Used'"
op|':'
name|'info'
op|'.'
name|'get'
op|'('
string|"'bytes_used'"
op|','
number|'0'
op|')'
op|','
nl|'\n'
string|"'X-Timestamp'"
op|':'
name|'Timestamp'
op|'('
name|'info'
op|'.'
name|'get'
op|'('
string|"'created_at'"
op|','
number|'0'
op|')'
op|')'
op|'.'
name|'normal'
op|','
nl|'\n'
string|"'X-PUT-Timestamp'"
op|':'
name|'Timestamp'
op|'('
nl|'\n'
name|'info'
op|'.'
name|'get'
op|'('
string|"'put_timestamp'"
op|','
number|'0'
op|')'
op|')'
op|'.'
name|'normal'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'headers'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ContainerController
dedent|''
name|'class'
name|'ContainerController'
op|'('
name|'BaseStorageServer'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""WSGI Controller for the container server."""'
newline|'\n'
nl|'\n'
comment|'# Ensure these are all lowercase'
nl|'\n'
DECL|variable|save_headers
name|'save_headers'
op|'='
op|'['
string|"'x-container-read'"
op|','
string|"'x-container-write'"
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|','
string|"'x-container-sync-to'"
op|']'
newline|'\n'
DECL|variable|server_type
name|'server_type'
op|'='
string|"'container-server'"
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'conf'
op|','
name|'logger'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'ContainerController'
op|','
name|'self'
op|')'
op|'.'
name|'__init__'
op|'('
name|'conf'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'logger'
op|'='
name|'logger'
name|'or'
name|'get_logger'
op|'('
name|'conf'
op|','
name|'log_route'
op|'='
string|"'container-server'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'log_requests'
op|'='
name|'config_true_value'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'log_requests'"
op|','
string|"'true'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'root'
op|'='
name|'conf'
op|'.'
name|'get'
op|'('
string|"'devices'"
op|','
string|"'/srv/node'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mount_check'
op|'='
name|'config_true_value'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'mount_check'"
op|','
string|"'true'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'node_timeout'
op|'='
name|'float'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'node_timeout'"
op|','
number|'3'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'conn_timeout'
op|'='
name|'float'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'conn_timeout'"
op|','
number|'0.5'
op|')'
op|')'
newline|'\n'
comment|'#: ContainerSyncCluster instance for validating sync-to values.'
nl|'\n'
name|'self'
op|'.'
name|'realms_conf'
op|'='
name|'ContainerSyncRealms'
op|'('
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
nl|'\n'
name|'conf'
op|'.'
name|'get'
op|'('
string|"'swift_dir'"
op|','
string|"'/etc/swift'"
op|')'
op|','
nl|'\n'
string|"'container-sync-realms.conf'"
op|')'
op|','
nl|'\n'
name|'self'
op|'.'
name|'logger'
op|')'
newline|'\n'
comment|"#: The list of hosts we're allowed to send syncs to. This can be"
nl|'\n'
comment|'#: overridden by data in self.realms_conf'
nl|'\n'
name|'self'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
nl|'\n'
name|'h'
op|'.'
name|'strip'
op|'('
op|')'
nl|'\n'
name|'for'
name|'h'
name|'in'
name|'conf'
op|'.'
name|'get'
op|'('
string|"'allowed_sync_hosts'"
op|','
string|"'127.0.0.1'"
op|')'
op|'.'
name|'split'
op|'('
string|"','"
op|')'
nl|'\n'
name|'if'
name|'h'
op|'.'
name|'strip'
op|'('
op|')'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'replicator_rpc'
op|'='
name|'ContainerReplicatorRpc'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'root'
op|','
name|'DATADIR'
op|','
name|'ContainerBroker'
op|','
name|'self'
op|'.'
name|'mount_check'
op|','
nl|'\n'
name|'logger'
op|'='
name|'self'
op|'.'
name|'logger'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'auto_create_account_prefix'
op|'='
name|'conf'
op|'.'
name|'get'
op|'('
string|"'auto_create_account_prefix'"
op|')'
name|'or'
string|"'.'"
newline|'\n'
name|'if'
name|'config_true_value'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'allow_versions'"
op|','
string|"'f'"
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'save_headers'
op|'.'
name|'append'
op|'('
string|"'x-versions-location'"
op|')'
newline|'\n'
dedent|''
name|'swift'
op|'.'
name|'common'
op|'.'
name|'db'
op|'.'
name|'DB_PREALLOCATION'
op|'='
name|'config_true_value'
op|'('
name|'conf'
op|'.'
name|'get'
op|'('
string|"'db_preallocation'"
op|','
string|"'f'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'sync_store'
op|'='
name|'ContainerSyncStore'
op|'('
name|'self'
op|'.'
name|'root'
op|','
nl|'\n'
name|'self'
op|'.'
name|'logger'
op|','
nl|'\n'
name|'self'
op|'.'
name|'mount_check'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_container_broker
dedent|''
name|'def'
name|'_get_container_broker'
op|'('
name|'self'
op|','
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Get a DB broker for the container.\n\n        :param drive: drive that holds the container\n        :param part: partition the container is in\n        :param account: account name\n        :param container: container name\n        :returns: ContainerBroker object\n        """'
newline|'\n'
name|'hsh'
op|'='
name|'hash_path'
op|'('
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'db_dir'
op|'='
name|'storage_directory'
op|'('
name|'DATADIR'
op|','
name|'part'
op|','
name|'hsh'
op|')'
newline|'\n'
name|'db_path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|','
name|'db_dir'
op|','
name|'hsh'
op|'+'
string|"'.db'"
op|')'
newline|'\n'
name|'kwargs'
op|'.'
name|'setdefault'
op|'('
string|"'account'"
op|','
name|'account'
op|')'
newline|'\n'
name|'kwargs'
op|'.'
name|'setdefault'
op|'('
string|"'container'"
op|','
name|'container'
op|')'
newline|'\n'
name|'kwargs'
op|'.'
name|'setdefault'
op|'('
string|"'logger'"
op|','
name|'self'
op|'.'
name|'logger'
op|')'
newline|'\n'
name|'return'
name|'ContainerBroker'
op|'('
name|'db_path'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_and_validate_policy_index
dedent|''
name|'def'
name|'get_and_validate_policy_index'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Validate that the index supplied maps to a policy.\n\n        :returns: policy index from request, or None if not present\n        :raises: HTTPBadRequest if the supplied index is bogus\n        """'
newline|'\n'
nl|'\n'
name|'policy_index'
op|'='
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Backend-Storage-Policy-Index'"
op|','
name|'None'
op|')'
newline|'\n'
name|'if'
name|'policy_index'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
nl|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'policy_index'
op|'='
name|'int'
op|'('
name|'policy_index'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'HTTPBadRequest'
op|'('
nl|'\n'
name|'request'
op|'='
name|'req'
op|','
name|'content_type'
op|'='
string|'"text/plain"'
op|','
nl|'\n'
name|'body'
op|'='
op|'('
string|'"Invalid X-Storage-Policy-Index %r"'
op|'%'
name|'policy_index'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'policy'
op|'='
name|'POLICIES'
op|'.'
name|'get_by_index'
op|'('
name|'policy_index'
op|')'
newline|'\n'
name|'if'
name|'policy'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'HTTPBadRequest'
op|'('
nl|'\n'
name|'request'
op|'='
name|'req'
op|','
name|'content_type'
op|'='
string|'"text/plain"'
op|','
nl|'\n'
name|'body'
op|'='
op|'('
string|'"Invalid X-Storage-Policy-Index %r"'
op|'%'
name|'policy_index'
op|')'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'int'
op|'('
name|'policy'
op|')'
newline|'\n'
nl|'\n'
DECL|member|account_update
dedent|''
name|'def'
name|'account_update'
op|'('
name|'self'
op|','
name|'req'
op|','
name|'account'
op|','
name|'container'
op|','
name|'broker'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Update the account server(s) with latest container info.\n\n        :param req: swob.Request object\n        :param account: account name\n        :param container: container name\n        :param broker: container DB broker object\n        :returns: if all the account requests return a 404 error code,\n                  HTTPNotFound response object,\n                  if the account cannot be updated due to a malformed header,\n                  an HTTPBadRequest response object,\n                  otherwise None.\n        """'
newline|'\n'
name|'account_hosts'
op|'='
op|'['
name|'h'
op|'.'
name|'strip'
op|'('
op|')'
name|'for'
name|'h'
name|'in'
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Account-Host'"
op|','
string|"''"
op|')'
op|'.'
name|'split'
op|'('
string|"','"
op|')'
op|']'
newline|'\n'
name|'account_devices'
op|'='
op|'['
name|'d'
op|'.'
name|'strip'
op|'('
op|')'
name|'for'
name|'d'
name|'in'
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Account-Device'"
op|','
string|"''"
op|')'
op|'.'
name|'split'
op|'('
string|"','"
op|')'
op|']'
newline|'\n'
name|'account_partition'
op|'='
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Account-Partition'"
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'account_hosts'
op|')'
op|'!='
name|'len'
op|'('
name|'account_devices'
op|')'
op|':'
newline|'\n'
comment|"# This shouldn't happen unless there's a bug in the proxy,"
nl|'\n'
comment|'# but if there is, we want to know about it.'
nl|'\n'
indent|'            '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|"'ERROR Account update failed: different  '"
nl|'\n'
string|"'numbers of hosts and devices in request: '"
nl|'\n'
string|'\'"%s" vs "%s"\''
op|')'
op|'%'
nl|'\n'
op|'('
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Account-Host'"
op|','
string|"''"
op|')'
op|','
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'X-Account-Device'"
op|','
string|"''"
op|')'
op|')'
op|')'
newline|'\n'
name|'return'
name|'HTTPBadRequest'
op|'('
name|'req'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'account_partition'
op|':'
newline|'\n'
comment|'# zip is lazy on py3, but we need a list, so force evaluation.'
nl|'\n'
comment|"# On py2 it's an extra list copy, but the list is so small"
nl|'\n'
comment|'# (one element per replica in account ring, usually 3) that it'
nl|'\n'
comment|"# doesn't matter."
nl|'\n'
indent|'            '
name|'updates'
op|'='
name|'list'
op|'('
name|'zip'
op|'('
name|'account_hosts'
op|','
name|'account_devices'
op|')'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'updates'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'account_404s'
op|'='
number|'0'
newline|'\n'
nl|'\n'
name|'for'
name|'account_host'
op|','
name|'account_device'
name|'in'
name|'updates'
op|':'
newline|'\n'
indent|'            '
name|'account_ip'
op|','
name|'account_port'
op|'='
name|'account_host'
op|'.'
name|'rsplit'
op|'('
string|"':'"
op|','
number|'1'
op|')'
newline|'\n'
name|'new_path'
op|'='
string|"'/'"
op|'+'
string|"'/'"
op|'.'
name|'join'
op|'('
op|'['
name|'account'
op|','
name|'container'
op|']'
op|')'
newline|'\n'
name|'info'
op|'='
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
newline|'\n'
name|'account_headers'
op|'='
name|'HeaderKeyDict'
op|'('
op|'{'
nl|'\n'
string|"'x-put-timestamp'"
op|':'
name|'info'
op|'['
string|"'put_timestamp'"
op|']'
op|','
nl|'\n'
string|"'x-delete-timestamp'"
op|':'
name|'info'
op|'['
string|"'delete_timestamp'"
op|']'
op|','
nl|'\n'
string|"'x-object-count'"
op|':'
name|'info'
op|'['
string|"'object_count'"
op|']'
op|','
nl|'\n'
string|"'x-bytes-used'"
op|':'
name|'info'
op|'['
string|"'bytes_used'"
op|']'
op|','
nl|'\n'
string|"'x-trans-id'"
op|':'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-trans-id'"
op|','
string|"'-'"
op|')'
op|','
nl|'\n'
string|"'X-Backend-Storage-Policy-Index'"
op|':'
name|'info'
op|'['
string|"'storage_policy_index'"
op|']'
op|','
nl|'\n'
string|"'user-agent'"
op|':'
string|"'container-server %s'"
op|'%'
name|'os'
op|'.'
name|'getpid'
op|'('
op|')'
op|','
nl|'\n'
string|"'referer'"
op|':'
name|'req'
op|'.'
name|'as_referer'
op|'('
op|')'
op|'}'
op|')'
newline|'\n'
name|'if'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-account-override-deleted'"
op|','
string|"'no'"
op|')'
op|'.'
name|'lower'
op|'('
op|')'
op|'=='
string|"'yes'"
op|':'
newline|'\n'
indent|'                '
name|'account_headers'
op|'['
string|"'x-account-override-deleted'"
op|']'
op|'='
string|"'yes'"
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'with'
name|'ConnectionTimeout'
op|'('
name|'self'
op|'.'
name|'conn_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'conn'
op|'='
name|'http_connect'
op|'('
nl|'\n'
name|'account_ip'
op|','
name|'account_port'
op|','
name|'account_device'
op|','
nl|'\n'
name|'account_partition'
op|','
string|"'PUT'"
op|','
name|'new_path'
op|','
name|'account_headers'
op|')'
newline|'\n'
dedent|''
name|'with'
name|'Timeout'
op|'('
name|'self'
op|'.'
name|'node_timeout'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'account_response'
op|'='
name|'conn'
op|'.'
name|'getresponse'
op|'('
op|')'
newline|'\n'
name|'account_response'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'if'
name|'account_response'
op|'.'
name|'status'
op|'=='
name|'HTTP_NOT_FOUND'
op|':'
newline|'\n'
indent|'                        '
name|'account_404s'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'elif'
name|'not'
name|'is_success'
op|'('
name|'account_response'
op|'.'
name|'status'
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
nl|'\n'
string|"'ERROR Account update failed '"
nl|'\n'
string|"'with %(ip)s:%(port)s/%(device)s (will retry '"
nl|'\n'
string|"'later): Response %(status)s %(reason)s'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'ip'"
op|':'
name|'account_ip'
op|','
string|"'port'"
op|':'
name|'account_port'
op|','
nl|'\n'
string|"'device'"
op|':'
name|'account_device'
op|','
nl|'\n'
string|"'status'"
op|':'
name|'account_response'
op|'.'
name|'status'
op|','
nl|'\n'
string|"'reason'"
op|':'
name|'account_response'
op|'.'
name|'reason'
op|'}'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'except'
op|'('
name|'Exception'
op|','
name|'Timeout'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'exception'
op|'('
name|'_'
op|'('
nl|'\n'
string|"'ERROR account update failed with '"
nl|'\n'
string|"'%(ip)s:%(port)s/%(device)s (will retry later)'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'ip'"
op|':'
name|'account_ip'
op|','
string|"'port'"
op|':'
name|'account_port'
op|','
nl|'\n'
string|"'device'"
op|':'
name|'account_device'
op|'}'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'updates'
name|'and'
name|'account_404s'
op|'=='
name|'len'
op|'('
name|'updates'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'req'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
nl|'\n'
DECL|member|_update_sync_store
dedent|''
dedent|''
name|'def'
name|'_update_sync_store'
op|'('
name|'self'
op|','
name|'broker'
op|','
name|'method'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'sync_store'
op|'.'
name|'update_sync_store'
op|'('
name|'broker'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'exception'
op|'('
string|"'Failed to update sync_store %s during %s'"
op|'%'
nl|'\n'
op|'('
name|'broker'
op|'.'
name|'db_file'
op|','
name|'method'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'public'
newline|'\n'
op|'@'
name|'timing_stats'
op|'('
op|')'
newline|'\n'
DECL|member|DELETE
name|'def'
name|'DELETE'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handle HTTP DELETE request."""'
newline|'\n'
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|'='
name|'split_and_validate_path'
op|'('
nl|'\n'
name|'req'
op|','
number|'4'
op|','
number|'5'
op|','
name|'True'
op|')'
newline|'\n'
name|'req_timestamp'
op|'='
name|'valid_timestamp'
op|'('
name|'req'
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPInsufficientStorage'
op|'('
name|'drive'
op|'='
name|'drive'
op|','
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
comment|'# policy index is only relevant for delete_obj (and transitively for'
nl|'\n'
comment|'# auto create accounts)'
nl|'\n'
dedent|''
name|'obj_policy_index'
op|'='
name|'self'
op|'.'
name|'get_and_validate_policy_index'
op|'('
name|'req'
op|')'
name|'or'
number|'0'
newline|'\n'
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_container_broker'
op|'('
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'if'
name|'account'
op|'.'
name|'startswith'
op|'('
name|'self'
op|'.'
name|'auto_create_account_prefix'
op|')'
name|'and'
name|'obj'
name|'and'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'broker'
op|'.'
name|'db_file'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'req_timestamp'
op|'.'
name|'internal'
op|','
name|'obj_policy_index'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'DatabaseAlreadyExists'
op|':'
newline|'\n'
indent|'                '
name|'pass'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'broker'
op|'.'
name|'db_file'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
op|')'
newline|'\n'
dedent|''
name|'if'
name|'obj'
op|':'
comment|'# delete object'
newline|'\n'
indent|'            '
name|'broker'
op|'.'
name|'delete_object'
op|'('
name|'obj'
op|','
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-timestamp'"
op|')'
op|','
nl|'\n'
name|'obj_policy_index'
op|')'
newline|'\n'
name|'return'
name|'HTTPNoContent'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|'# delete container'
nl|'\n'
indent|'            '
name|'if'
name|'not'
name|'broker'
op|'.'
name|'empty'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPConflict'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'existed'
op|'='
name|'Timestamp'
op|'('
name|'broker'
op|'.'
name|'get_info'
op|'('
op|')'
op|'['
string|"'put_timestamp'"
op|']'
op|')'
name|'and'
name|'not'
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
newline|'\n'
name|'broker'
op|'.'
name|'delete_db'
op|'('
name|'req_timestamp'
op|'.'
name|'internal'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPConflict'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_update_sync_store'
op|'('
name|'broker'
op|','
string|"'DELETE'"
op|')'
newline|'\n'
name|'resp'
op|'='
name|'self'
op|'.'
name|'account_update'
op|'('
name|'req'
op|','
name|'account'
op|','
name|'container'
op|','
name|'broker'
op|')'
newline|'\n'
name|'if'
name|'resp'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'resp'
newline|'\n'
dedent|''
name|'if'
name|'existed'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPNoContent'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'HTTPNotFound'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|_update_or_create
dedent|''
dedent|''
name|'def'
name|'_update_or_create'
op|'('
name|'self'
op|','
name|'req'
op|','
name|'broker'
op|','
name|'timestamp'
op|','
name|'new_container_policy'
op|','
nl|'\n'
name|'requested_policy_index'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Create new database broker or update timestamps for existing database.\n\n        :param req: the swob request object\n        :param broker: the broker instance for the container\n        :param timestamp: internalized timestamp\n        :param new_container_policy: the storage policy index to use\n                                     when creating the container\n        :param requested_policy_index: the storage policy index sent in the\n                                       request, may be None\n\n        :returns: created, a bool, if database did not previously exist\n        """'
newline|'\n'
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'broker'
op|'.'
name|'db_file'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'timestamp'
op|','
name|'new_container_policy'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'DatabaseAlreadyExists'
op|':'
newline|'\n'
indent|'                '
name|'pass'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'True'
comment|'# created'
newline|'\n'
dedent|''
dedent|''
name|'recreated'
op|'='
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
newline|'\n'
name|'if'
name|'recreated'
op|':'
newline|'\n'
comment|'# only set storage policy on deleted containers'
nl|'\n'
indent|'            '
name|'broker'
op|'.'
name|'set_storage_policy_index'
op|'('
name|'new_container_policy'
op|','
nl|'\n'
name|'timestamp'
op|'='
name|'timestamp'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'requested_policy_index'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
comment|'# validate requested policy with existing container'
nl|'\n'
indent|'            '
name|'if'
name|'requested_policy_index'
op|'!='
name|'broker'
op|'.'
name|'storage_policy_index'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'HTTPConflict'
op|'('
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'headers'
op|'='
op|'{'
string|"'x-backend-storage-policy-index'"
op|':'
nl|'\n'
name|'broker'
op|'.'
name|'storage_policy_index'
op|'}'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'broker'
op|'.'
name|'update_put_timestamp'
op|'('
name|'timestamp'
op|')'
newline|'\n'
name|'if'
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'HTTPConflict'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'recreated'
op|':'
newline|'\n'
indent|'            '
name|'broker'
op|'.'
name|'update_status_changed_at'
op|'('
name|'timestamp'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'recreated'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
op|'@'
name|'timing_stats'
op|'('
op|')'
newline|'\n'
DECL|member|PUT
name|'def'
name|'PUT'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handle HTTP PUT request."""'
newline|'\n'
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|'='
name|'split_and_validate_path'
op|'('
nl|'\n'
name|'req'
op|','
number|'4'
op|','
number|'5'
op|','
name|'True'
op|')'
newline|'\n'
name|'req_timestamp'
op|'='
name|'valid_timestamp'
op|'('
name|'req'
op|')'
newline|'\n'
name|'if'
string|"'x-container-sync-to'"
name|'in'
name|'req'
op|'.'
name|'headers'
op|':'
newline|'\n'
indent|'            '
name|'err'
op|','
name|'sync_to'
op|','
name|'realm'
op|','
name|'realm_key'
op|'='
name|'validate_sync_to'
op|'('
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-container-sync-to'"
op|']'
op|','
name|'self'
op|'.'
name|'allowed_sync_hosts'
op|','
nl|'\n'
name|'self'
op|'.'
name|'realms_conf'
op|')'
newline|'\n'
name|'if'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'err'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPInsufficientStorage'
op|'('
name|'drive'
op|'='
name|'drive'
op|','
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'requested_policy_index'
op|'='
name|'self'
op|'.'
name|'get_and_validate_policy_index'
op|'('
name|'req'
op|')'
newline|'\n'
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_container_broker'
op|'('
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'if'
name|'obj'
op|':'
comment|'# put container object'
newline|'\n'
comment|'# obj put expects the policy_index header, default is for'
nl|'\n'
comment|'# legacy support during upgrade.'
nl|'\n'
indent|'            '
name|'obj_policy_index'
op|'='
name|'requested_policy_index'
name|'or'
number|'0'
newline|'\n'
name|'if'
name|'account'
op|'.'
name|'startswith'
op|'('
name|'self'
op|'.'
name|'auto_create_account_prefix'
op|')'
name|'and'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'broker'
op|'.'
name|'db_file'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'broker'
op|'.'
name|'initialize'
op|'('
name|'req_timestamp'
op|'.'
name|'internal'
op|','
name|'obj_policy_index'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'DatabaseAlreadyExists'
op|':'
newline|'\n'
indent|'                    '
name|'pass'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'broker'
op|'.'
name|'db_file'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPNotFound'
op|'('
op|')'
newline|'\n'
dedent|''
name|'broker'
op|'.'
name|'put_object'
op|'('
name|'obj'
op|','
name|'req_timestamp'
op|'.'
name|'internal'
op|','
nl|'\n'
name|'int'
op|'('
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-size'"
op|']'
op|')'
op|','
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-content-type'"
op|']'
op|','
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-etag'"
op|']'
op|','
number|'0'
op|','
nl|'\n'
name|'obj_policy_index'
op|')'
newline|'\n'
name|'return'
name|'HTTPCreated'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
comment|'# put container'
newline|'\n'
indent|'            '
name|'if'
name|'requested_policy_index'
name|'is'
name|'None'
op|':'
newline|'\n'
comment|'# use the default index sent by the proxy if available'
nl|'\n'
indent|'                '
name|'new_container_policy'
op|'='
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
nl|'\n'
string|"'X-Backend-Storage-Policy-Default'"
op|','
name|'int'
op|'('
name|'POLICIES'
op|'.'
name|'default'
op|')'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'new_container_policy'
op|'='
name|'requested_policy_index'
newline|'\n'
dedent|''
name|'created'
op|'='
name|'self'
op|'.'
name|'_update_or_create'
op|'('
name|'req'
op|','
name|'broker'
op|','
nl|'\n'
name|'req_timestamp'
op|'.'
name|'internal'
op|','
nl|'\n'
name|'new_container_policy'
op|','
nl|'\n'
name|'requested_policy_index'
op|')'
newline|'\n'
name|'metadata'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'metadata'
op|'.'
name|'update'
op|'('
nl|'\n'
op|'('
name|'key'
op|','
op|'('
name|'value'
op|','
name|'req_timestamp'
op|'.'
name|'internal'
op|')'
op|')'
nl|'\n'
name|'for'
name|'key'
op|','
name|'value'
name|'in'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
name|'in'
name|'self'
op|'.'
name|'save_headers'
name|'or'
nl|'\n'
name|'is_sys_or_user_meta'
op|'('
string|"'container'"
op|','
name|'key'
op|')'
op|')'
newline|'\n'
name|'if'
string|"'X-Container-Sync-To'"
name|'in'
name|'metadata'
op|':'
newline|'\n'
indent|'                '
name|'if'
string|"'X-Container-Sync-To'"
name|'not'
name|'in'
name|'broker'
op|'.'
name|'metadata'
name|'or'
name|'metadata'
op|'['
string|"'X-Container-Sync-To'"
op|']'
op|'['
number|'0'
op|']'
op|'!='
name|'broker'
op|'.'
name|'metadata'
op|'['
string|"'X-Container-Sync-To'"
op|']'
op|'['
number|'0'
op|']'
op|':'
newline|'\n'
indent|'                    '
name|'broker'
op|'.'
name|'set_x_container_sync_points'
op|'('
op|'-'
number|'1'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'broker'
op|'.'
name|'update_metadata'
op|'('
name|'metadata'
op|','
name|'validate_metadata'
op|'='
name|'True'
op|')'
newline|'\n'
name|'if'
name|'metadata'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'_update_sync_store'
op|'('
name|'broker'
op|','
string|"'PUT'"
op|')'
newline|'\n'
dedent|''
name|'resp'
op|'='
name|'self'
op|'.'
name|'account_update'
op|'('
name|'req'
op|','
name|'account'
op|','
name|'container'
op|','
name|'broker'
op|')'
newline|'\n'
name|'if'
name|'resp'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'resp'
newline|'\n'
dedent|''
name|'if'
name|'created'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPCreated'
op|'('
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'headers'
op|'='
op|'{'
string|"'x-backend-storage-policy-index'"
op|':'
nl|'\n'
name|'broker'
op|'.'
name|'storage_policy_index'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPAccepted'
op|'('
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'headers'
op|'='
op|'{'
string|"'x-backend-storage-policy-index'"
op|':'
nl|'\n'
name|'broker'
op|'.'
name|'storage_policy_index'
op|'}'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
op|'@'
name|'public'
newline|'\n'
op|'@'
name|'timing_stats'
op|'('
name|'sample_rate'
op|'='
number|'0.1'
op|')'
newline|'\n'
DECL|member|HEAD
name|'def'
name|'HEAD'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handle HTTP HEAD request."""'
newline|'\n'
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|'='
name|'split_and_validate_path'
op|'('
nl|'\n'
name|'req'
op|','
number|'4'
op|','
number|'5'
op|','
name|'True'
op|')'
newline|'\n'
name|'out_content_type'
op|'='
name|'get_listing_content_type'
op|'('
name|'req'
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPInsufficientStorage'
op|'('
name|'drive'
op|'='
name|'drive'
op|','
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_container_broker'
op|'('
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
nl|'\n'
name|'pending_timeout'
op|'='
number|'0.1'
op|','
nl|'\n'
name|'stale_reads_ok'
op|'='
name|'True'
op|')'
newline|'\n'
name|'info'
op|','
name|'is_deleted'
op|'='
name|'broker'
op|'.'
name|'get_info_is_deleted'
op|'('
op|')'
newline|'\n'
name|'headers'
op|'='
name|'gen_resp_headers'
op|'('
name|'info'
op|','
name|'is_deleted'
op|'='
name|'is_deleted'
op|')'
newline|'\n'
name|'if'
name|'is_deleted'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|','
name|'headers'
op|'='
name|'headers'
op|')'
newline|'\n'
dedent|''
name|'headers'
op|'.'
name|'update'
op|'('
nl|'\n'
op|'('
name|'key'
op|','
name|'value'
op|')'
nl|'\n'
name|'for'
name|'key'
op|','
op|'('
name|'value'
op|','
name|'timestamp'
op|')'
name|'in'
name|'broker'
op|'.'
name|'metadata'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'value'
op|'!='
string|"''"
name|'and'
op|'('
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
name|'in'
name|'self'
op|'.'
name|'save_headers'
name|'or'
nl|'\n'
name|'is_sys_or_user_meta'
op|'('
string|"'container'"
op|','
name|'key'
op|')'
op|')'
op|')'
newline|'\n'
name|'headers'
op|'['
string|"'Content-Type'"
op|']'
op|'='
name|'out_content_type'
newline|'\n'
name|'return'
name|'HTTPNoContent'
op|'('
name|'request'
op|'='
name|'req'
op|','
name|'headers'
op|'='
name|'headers'
op|','
name|'charset'
op|'='
string|"'utf-8'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|update_data_record
dedent|''
name|'def'
name|'update_data_record'
op|'('
name|'self'
op|','
name|'record'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Perform any mutations to container listing records that are common to\n        all serialization formats, and returns it as a dict.\n\n        Converts created time to iso timestamp.\n        Replaces size with \'swift_bytes\' content type parameter.\n\n        :params record: object entry record\n        :returns: modified record\n        """'
newline|'\n'
op|'('
name|'name'
op|','
name|'created'
op|','
name|'size'
op|','
name|'content_type'
op|','
name|'etag'
op|')'
op|'='
name|'record'
op|'['
op|':'
number|'5'
op|']'
newline|'\n'
name|'if'
name|'content_type'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'subdir'"
op|':'
name|'name'
op|'}'
newline|'\n'
dedent|''
name|'response'
op|'='
op|'{'
string|"'bytes'"
op|':'
name|'size'
op|','
string|"'hash'"
op|':'
name|'etag'
op|','
string|"'name'"
op|':'
name|'name'
op|','
nl|'\n'
string|"'content_type'"
op|':'
name|'content_type'
op|'}'
newline|'\n'
name|'response'
op|'['
string|"'last_modified'"
op|']'
op|'='
name|'Timestamp'
op|'('
name|'created'
op|')'
op|'.'
name|'isoformat'
newline|'\n'
name|'override_bytes_from_content_type'
op|'('
name|'response'
op|','
name|'logger'
op|'='
name|'self'
op|'.'
name|'logger'
op|')'
newline|'\n'
name|'return'
name|'response'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
op|'@'
name|'timing_stats'
op|'('
op|')'
newline|'\n'
DECL|member|GET
name|'def'
name|'GET'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handle HTTP GET request."""'
newline|'\n'
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|'='
name|'split_and_validate_path'
op|'('
nl|'\n'
name|'req'
op|','
number|'4'
op|','
number|'5'
op|','
name|'True'
op|')'
newline|'\n'
name|'path'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'path'"
op|')'
newline|'\n'
name|'prefix'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'prefix'"
op|')'
newline|'\n'
name|'delimiter'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'delimiter'"
op|')'
newline|'\n'
name|'if'
name|'delimiter'
name|'and'
op|'('
name|'len'
op|'('
name|'delimiter'
op|')'
op|'>'
number|'1'
name|'or'
name|'ord'
op|'('
name|'delimiter'
op|')'
op|'>'
number|'254'
op|')'
op|':'
newline|'\n'
comment|'# delimiters can be made more flexible later'
nl|'\n'
indent|'            '
name|'return'
name|'HTTPPreconditionFailed'
op|'('
name|'body'
op|'='
string|"'Bad delimiter'"
op|')'
newline|'\n'
dedent|''
name|'marker'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'marker'"
op|','
string|"''"
op|')'
newline|'\n'
name|'end_marker'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'end_marker'"
op|')'
newline|'\n'
name|'limit'
op|'='
name|'constraints'
op|'.'
name|'CONTAINER_LISTING_LIMIT'
newline|'\n'
name|'given_limit'
op|'='
name|'get_param'
op|'('
name|'req'
op|','
string|"'limit'"
op|')'
newline|'\n'
name|'reverse'
op|'='
name|'config_true_value'
op|'('
name|'get_param'
op|'('
name|'req'
op|','
string|"'reverse'"
op|')'
op|')'
newline|'\n'
name|'if'
name|'given_limit'
name|'and'
name|'given_limit'
op|'.'
name|'isdigit'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'limit'
op|'='
name|'int'
op|'('
name|'given_limit'
op|')'
newline|'\n'
name|'if'
name|'limit'
op|'>'
name|'constraints'
op|'.'
name|'CONTAINER_LISTING_LIMIT'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPPreconditionFailed'
op|'('
nl|'\n'
name|'request'
op|'='
name|'req'
op|','
nl|'\n'
name|'body'
op|'='
string|"'Maximum limit is %d'"
nl|'\n'
op|'%'
name|'constraints'
op|'.'
name|'CONTAINER_LISTING_LIMIT'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'out_content_type'
op|'='
name|'get_listing_content_type'
op|'('
name|'req'
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPInsufficientStorage'
op|'('
name|'drive'
op|'='
name|'drive'
op|','
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_container_broker'
op|'('
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|','
nl|'\n'
name|'pending_timeout'
op|'='
number|'0.1'
op|','
nl|'\n'
name|'stale_reads_ok'
op|'='
name|'True'
op|')'
newline|'\n'
name|'info'
op|','
name|'is_deleted'
op|'='
name|'broker'
op|'.'
name|'get_info_is_deleted'
op|'('
op|')'
newline|'\n'
name|'resp_headers'
op|'='
name|'gen_resp_headers'
op|'('
name|'info'
op|','
name|'is_deleted'
op|'='
name|'is_deleted'
op|')'
newline|'\n'
name|'if'
name|'is_deleted'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|','
name|'headers'
op|'='
name|'resp_headers'
op|')'
newline|'\n'
dedent|''
name|'container_list'
op|'='
name|'broker'
op|'.'
name|'list_objects_iter'
op|'('
nl|'\n'
name|'limit'
op|','
name|'marker'
op|','
name|'end_marker'
op|','
name|'prefix'
op|','
name|'delimiter'
op|','
name|'path'
op|','
nl|'\n'
name|'storage_policy_index'
op|'='
name|'info'
op|'['
string|"'storage_policy_index'"
op|']'
op|','
name|'reverse'
op|'='
name|'reverse'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'create_listing'
op|'('
name|'req'
op|','
name|'out_content_type'
op|','
name|'info'
op|','
name|'resp_headers'
op|','
nl|'\n'
name|'broker'
op|'.'
name|'metadata'
op|','
name|'container_list'
op|','
name|'container'
op|')'
newline|'\n'
nl|'\n'
DECL|member|create_listing
dedent|''
name|'def'
name|'create_listing'
op|'('
name|'self'
op|','
name|'req'
op|','
name|'out_content_type'
op|','
name|'info'
op|','
name|'resp_headers'
op|','
nl|'\n'
name|'metadata'
op|','
name|'container_list'
op|','
name|'container'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'key'
op|','
op|'('
name|'value'
op|','
name|'timestamp'
op|')'
name|'in'
name|'metadata'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'value'
name|'and'
op|'('
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
name|'in'
name|'self'
op|'.'
name|'save_headers'
name|'or'
nl|'\n'
name|'is_sys_or_user_meta'
op|'('
string|"'container'"
op|','
name|'key'
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'resp_headers'
op|'['
name|'key'
op|']'
op|'='
name|'value'
newline|'\n'
dedent|''
dedent|''
name|'ret'
op|'='
name|'Response'
op|'('
name|'request'
op|'='
name|'req'
op|','
name|'headers'
op|'='
name|'resp_headers'
op|','
nl|'\n'
name|'content_type'
op|'='
name|'out_content_type'
op|','
name|'charset'
op|'='
string|"'utf-8'"
op|')'
newline|'\n'
name|'if'
name|'out_content_type'
op|'=='
string|"'application/json'"
op|':'
newline|'\n'
indent|'            '
name|'ret'
op|'.'
name|'body'
op|'='
name|'json'
op|'.'
name|'dumps'
op|'('
op|'['
name|'self'
op|'.'
name|'update_data_record'
op|'('
name|'record'
op|')'
nl|'\n'
name|'for'
name|'record'
name|'in'
name|'container_list'
op|']'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'out_content_type'
op|'.'
name|'endswith'
op|'('
string|"'/xml'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'doc'
op|'='
name|'Element'
op|'('
string|"'container'"
op|','
name|'name'
op|'='
name|'container'
op|'.'
name|'decode'
op|'('
string|"'utf-8'"
op|')'
op|')'
newline|'\n'
name|'for'
name|'obj'
name|'in'
name|'container_list'
op|':'
newline|'\n'
indent|'                '
name|'record'
op|'='
name|'self'
op|'.'
name|'update_data_record'
op|'('
name|'obj'
op|')'
newline|'\n'
name|'if'
string|"'subdir'"
name|'in'
name|'record'
op|':'
newline|'\n'
indent|'                    '
name|'name'
op|'='
name|'record'
op|'['
string|"'subdir'"
op|']'
op|'.'
name|'decode'
op|'('
string|"'utf-8'"
op|')'
newline|'\n'
name|'sub'
op|'='
name|'SubElement'
op|'('
name|'doc'
op|','
string|"'subdir'"
op|','
name|'name'
op|'='
name|'name'
op|')'
newline|'\n'
name|'SubElement'
op|'('
name|'sub'
op|','
string|"'name'"
op|')'
op|'.'
name|'text'
op|'='
name|'name'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'obj_element'
op|'='
name|'SubElement'
op|'('
name|'doc'
op|','
string|"'object'"
op|')'
newline|'\n'
name|'for'
name|'field'
name|'in'
op|'['
string|'"name"'
op|','
string|'"hash"'
op|','
string|'"bytes"'
op|','
string|'"content_type"'
op|','
nl|'\n'
string|'"last_modified"'
op|']'
op|':'
newline|'\n'
indent|'                        '
name|'SubElement'
op|'('
name|'obj_element'
op|','
name|'field'
op|')'
op|'.'
name|'text'
op|'='
name|'str'
op|'('
nl|'\n'
name|'record'
op|'.'
name|'pop'
op|'('
name|'field'
op|')'
op|')'
op|'.'
name|'decode'
op|'('
string|"'utf-8'"
op|')'
newline|'\n'
dedent|''
name|'for'
name|'field'
name|'in'
name|'sorted'
op|'('
name|'record'
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'SubElement'
op|'('
name|'obj_element'
op|','
name|'field'
op|')'
op|'.'
name|'text'
op|'='
name|'str'
op|'('
nl|'\n'
name|'record'
op|'['
name|'field'
op|']'
op|')'
op|'.'
name|'decode'
op|'('
string|"'utf-8'"
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'ret'
op|'.'
name|'body'
op|'='
name|'tostring'
op|'('
name|'doc'
op|','
name|'encoding'
op|'='
string|"'UTF-8'"
op|')'
op|'.'
name|'replace'
op|'('
nl|'\n'
string|'"<?xml version=\'1.0\' encoding=\'UTF-8\'?>"'
op|','
nl|'\n'
string|'\'<?xml version="1.0" encoding="UTF-8"?>\''
op|','
number|'1'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'container_list'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPNoContent'
op|'('
name|'request'
op|'='
name|'req'
op|','
name|'headers'
op|'='
name|'resp_headers'
op|')'
newline|'\n'
dedent|''
name|'ret'
op|'.'
name|'body'
op|'='
string|"'\\n'"
op|'.'
name|'join'
op|'('
name|'rec'
op|'['
number|'0'
op|']'
name|'for'
name|'rec'
name|'in'
name|'container_list'
op|')'
op|'+'
string|"'\\n'"
newline|'\n'
dedent|''
name|'return'
name|'ret'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
op|'@'
name|'replication'
newline|'\n'
op|'@'
name|'timing_stats'
op|'('
name|'sample_rate'
op|'='
number|'0.01'
op|')'
newline|'\n'
DECL|member|REPLICATE
name|'def'
name|'REPLICATE'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Handle HTTP REPLICATE request (json-encoded RPC calls for replication.)\n        """'
newline|'\n'
name|'post_args'
op|'='
name|'split_and_validate_path'
op|'('
name|'req'
op|','
number|'3'
op|')'
newline|'\n'
name|'drive'
op|','
name|'partition'
op|','
name|'hash'
op|'='
name|'post_args'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPInsufficientStorage'
op|'('
name|'drive'
op|'='
name|'drive'
op|','
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'args'
op|'='
name|'json'
op|'.'
name|'load'
op|'('
name|'req'
op|'.'
name|'environ'
op|'['
string|"'wsgi.input'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'body'
op|'='
name|'str'
op|'('
name|'err'
op|')'
op|','
name|'content_type'
op|'='
string|"'text/plain'"
op|')'
newline|'\n'
dedent|''
name|'ret'
op|'='
name|'self'
op|'.'
name|'replicator_rpc'
op|'.'
name|'dispatch'
op|'('
name|'post_args'
op|','
name|'args'
op|')'
newline|'\n'
name|'ret'
op|'.'
name|'request'
op|'='
name|'req'
newline|'\n'
name|'return'
name|'ret'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'public'
newline|'\n'
op|'@'
name|'timing_stats'
op|'('
op|')'
newline|'\n'
DECL|member|POST
name|'def'
name|'POST'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handle HTTP POST request."""'
newline|'\n'
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|'='
name|'split_and_validate_path'
op|'('
name|'req'
op|','
number|'4'
op|')'
newline|'\n'
name|'req_timestamp'
op|'='
name|'valid_timestamp'
op|'('
name|'req'
op|')'
newline|'\n'
name|'if'
string|"'x-container-sync-to'"
name|'in'
name|'req'
op|'.'
name|'headers'
op|':'
newline|'\n'
indent|'            '
name|'err'
op|','
name|'sync_to'
op|','
name|'realm'
op|','
name|'realm_key'
op|'='
name|'validate_sync_to'
op|'('
nl|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'x-container-sync-to'"
op|']'
op|','
name|'self'
op|'.'
name|'allowed_sync_hosts'
op|','
nl|'\n'
name|'self'
op|'.'
name|'realms_conf'
op|')'
newline|'\n'
name|'if'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'HTTPBadRequest'
op|'('
name|'err'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'self'
op|'.'
name|'mount_check'
name|'and'
name|'not'
name|'check_mount'
op|'('
name|'self'
op|'.'
name|'root'
op|','
name|'drive'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPInsufficientStorage'
op|'('
name|'drive'
op|'='
name|'drive'
op|','
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'broker'
op|'='
name|'self'
op|'.'
name|'_get_container_broker'
op|'('
name|'drive'
op|','
name|'part'
op|','
name|'account'
op|','
name|'container'
op|')'
newline|'\n'
name|'if'
name|'broker'
op|'.'
name|'is_deleted'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'HTTPNotFound'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
dedent|''
name|'broker'
op|'.'
name|'update_put_timestamp'
op|'('
name|'req_timestamp'
op|'.'
name|'internal'
op|')'
newline|'\n'
name|'metadata'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'metadata'
op|'.'
name|'update'
op|'('
nl|'\n'
op|'('
name|'key'
op|','
op|'('
name|'value'
op|','
name|'req_timestamp'
op|'.'
name|'internal'
op|')'
op|')'
nl|'\n'
name|'for'
name|'key'
op|','
name|'value'
name|'in'
name|'req'
op|'.'
name|'headers'
op|'.'
name|'items'
op|'('
op|')'
nl|'\n'
name|'if'
name|'key'
op|'.'
name|'lower'
op|'('
op|')'
name|'in'
name|'self'
op|'.'
name|'save_headers'
name|'or'
nl|'\n'
name|'is_sys_or_user_meta'
op|'('
string|"'container'"
op|','
name|'key'
op|')'
op|')'
newline|'\n'
name|'if'
name|'metadata'
op|':'
newline|'\n'
indent|'            '
name|'if'
string|"'X-Container-Sync-To'"
name|'in'
name|'metadata'
op|':'
newline|'\n'
indent|'                '
name|'if'
string|"'X-Container-Sync-To'"
name|'not'
name|'in'
name|'broker'
op|'.'
name|'metadata'
name|'or'
name|'metadata'
op|'['
string|"'X-Container-Sync-To'"
op|']'
op|'['
number|'0'
op|']'
op|'!='
name|'broker'
op|'.'
name|'metadata'
op|'['
string|"'X-Container-Sync-To'"
op|']'
op|'['
number|'0'
op|']'
op|':'
newline|'\n'
indent|'                    '
name|'broker'
op|'.'
name|'set_x_container_sync_points'
op|'('
op|'-'
number|'1'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'broker'
op|'.'
name|'update_metadata'
op|'('
name|'metadata'
op|','
name|'validate_metadata'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_update_sync_store'
op|'('
name|'broker'
op|','
string|"'POST'"
op|')'
newline|'\n'
dedent|''
name|'return'
name|'HTTPNoContent'
op|'('
name|'request'
op|'='
name|'req'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__call__
dedent|''
name|'def'
name|'__call__'
op|'('
name|'self'
op|','
name|'env'
op|','
name|'start_response'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'start_time'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'req'
op|'='
name|'Request'
op|'('
name|'env'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'logger'
op|'.'
name|'txn_id'
op|'='
name|'req'
op|'.'
name|'headers'
op|'.'
name|'get'
op|'('
string|"'x-trans-id'"
op|','
name|'None'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'check_utf8'
op|'('
name|'req'
op|'.'
name|'path_info'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'res'
op|'='
name|'HTTPPreconditionFailed'
op|'('
name|'body'
op|'='
string|"'Invalid UTF8 or contains NULL'"
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
comment|"# disallow methods which have not been marked 'public'"
nl|'\n'
indent|'                '
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'if'
name|'req'
op|'.'
name|'method'
name|'not'
name|'in'
name|'self'
op|'.'
name|'allowed_methods'
op|':'
newline|'\n'
indent|'                        '
name|'raise'
name|'AttributeError'
op|'('
string|"'Not allowed method.'"
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'AttributeError'
op|':'
newline|'\n'
indent|'                    '
name|'res'
op|'='
name|'HTTPMethodNotAllowed'
op|'('
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'method'
op|'='
name|'getattr'
op|'('
name|'self'
op|','
name|'req'
op|'.'
name|'method'
op|')'
newline|'\n'
name|'res'
op|'='
name|'method'
op|'('
name|'req'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'HTTPException'
name|'as'
name|'error_response'
op|':'
newline|'\n'
indent|'                '
name|'res'
op|'='
name|'error_response'
newline|'\n'
dedent|''
name|'except'
op|'('
name|'Exception'
op|','
name|'Timeout'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'exception'
op|'('
name|'_'
op|'('
nl|'\n'
string|"'ERROR __call__ error with %(method)s %(path)s '"
op|')'
op|','
nl|'\n'
op|'{'
string|"'method'"
op|':'
name|'req'
op|'.'
name|'method'
op|','
string|"'path'"
op|':'
name|'req'
op|'.'
name|'path'
op|'}'
op|')'
newline|'\n'
name|'res'
op|'='
name|'HTTPInternalServerError'
op|'('
name|'body'
op|'='
name|'traceback'
op|'.'
name|'format_exc'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'self'
op|'.'
name|'log_requests'
op|':'
newline|'\n'
indent|'            '
name|'trans_time'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'-'
name|'start_time'
newline|'\n'
name|'log_message'
op|'='
name|'get_log_line'
op|'('
name|'req'
op|','
name|'res'
op|','
name|'trans_time'
op|','
string|"''"
op|')'
newline|'\n'
name|'if'
name|'req'
op|'.'
name|'method'
op|'.'
name|'upper'
op|'('
op|')'
op|'=='
string|"'REPLICATE'"
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'debug'
op|'('
name|'log_message'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'logger'
op|'.'
name|'info'
op|'('
name|'log_message'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'res'
op|'('
name|'env'
op|','
name|'start_response'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|app_factory
dedent|''
dedent|''
name|'def'
name|'app_factory'
op|'('
name|'global_conf'
op|','
op|'**'
name|'local_conf'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""paste.deploy app factory for creating WSGI container server apps"""'
newline|'\n'
name|'conf'
op|'='
name|'global_conf'
op|'.'
name|'copy'
op|'('
op|')'
newline|'\n'
name|'conf'
op|'.'
name|'update'
op|'('
name|'local_conf'
op|')'
newline|'\n'
name|'return'
name|'ContainerController'
op|'('
name|'conf'
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit

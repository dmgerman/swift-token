begin_unit
comment|'# Copyright (c) 2010-2013 OpenStack Foundation'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
name|'from'
name|'collections'
name|'import'
name|'defaultdict'
newline|'\n'
name|'import'
name|'optparse'
newline|'\n'
name|'import'
name|'re'
newline|'\n'
name|'import'
name|'socket'
newline|'\n'
nl|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'expand_ipv6'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|tiers_for_dev
name|'def'
name|'tiers_for_dev'
op|'('
name|'dev'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Returns a tuple of tiers for a given device in ascending order by\n    length.\n\n    :returns: tuple of tiers\n    """'
newline|'\n'
name|'t1'
op|'='
name|'dev'
op|'['
string|"'region'"
op|']'
newline|'\n'
name|'t2'
op|'='
name|'dev'
op|'['
string|"'zone'"
op|']'
newline|'\n'
name|'t3'
op|'='
string|'"{ip}:{port}"'
op|'.'
name|'format'
op|'('
name|'ip'
op|'='
name|'dev'
op|'.'
name|'get'
op|'('
string|"'ip'"
op|')'
op|','
name|'port'
op|'='
name|'dev'
op|'.'
name|'get'
op|'('
string|"'port'"
op|')'
op|')'
newline|'\n'
name|'t4'
op|'='
name|'dev'
op|'['
string|"'id'"
op|']'
newline|'\n'
nl|'\n'
name|'return'
op|'('
op|'('
name|'t1'
op|','
op|')'
op|','
nl|'\n'
op|'('
name|'t1'
op|','
name|'t2'
op|')'
op|','
nl|'\n'
op|'('
name|'t1'
op|','
name|'t2'
op|','
name|'t3'
op|')'
op|','
nl|'\n'
op|'('
name|'t1'
op|','
name|'t2'
op|','
name|'t3'
op|','
name|'t4'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|build_tier_tree
dedent|''
name|'def'
name|'build_tier_tree'
op|'('
name|'devices'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Construct the tier tree from the zone layout.\n\n    The tier tree is a dictionary that maps tiers to their child tiers.\n    A synthetic root node of () is generated so that there\'s one tree,\n    not a forest.\n\n    Example:\n\n    region 1 -+---- zone 1 -+---- 192.168.101.1:6000 -+---- device id 0\n              |             |                         |\n              |             |                         +---- device id 1\n              |             |                         |\n              |             |                         +---- device id 2\n              |             |\n              |             +---- 192.168.101.2:6000 -+---- device id 3\n              |                                       |\n              |                                       +---- device id 4\n              |                                       |\n              |                                       +---- device id 5\n              |\n              +---- zone 2 -+---- 192.168.102.1:6000 -+---- device id 6\n                            |                         |\n                            |                         +---- device id 7\n                            |                         |\n                            |                         +---- device id 8\n                            |\n                            +---- 192.168.102.2:6000 -+---- device id 9\n                                                      |\n                                                      +---- device id 10\n\n\n    region 2 -+---- zone 1 -+---- 192.168.201.1:6000 -+---- device id 12\n                            |                         |\n                            |                         +---- device id 13\n                            |                         |\n                            |                         +---- device id 14\n                            |\n                            +---- 192.168.201.2:6000 -+---- device id 15\n                                                      |\n                                                      +---- device id 16\n                                                      |\n                                                      +---- device id 17\n\n    The tier tree would look like:\n    {\n      (): [(1,), (2,)],\n\n      (1,): [(1, 1), (1, 2)],\n      (2,): [(2, 1)],\n\n      (1, 1): [(1, 1, 192.168.101.1:6000),\n               (1, 1, 192.168.101.2:6000)],\n      (1, 2): [(1, 2, 192.168.102.1:6000),\n               (1, 2, 192.168.102.2:6000)],\n      (2, 1): [(2, 1, 192.168.201.1:6000),\n               (2, 1, 192.168.201.2:6000)],\n\n      (1, 1, 192.168.101.1:6000): [(1, 1, 192.168.101.1:6000, 0),\n                                   (1, 1, 192.168.101.1:6000, 1),\n                                   (1, 1, 192.168.101.1:6000, 2)],\n      (1, 1, 192.168.101.2:6000): [(1, 1, 192.168.101.2:6000, 3),\n                                   (1, 1, 192.168.101.2:6000, 4),\n                                   (1, 1, 192.168.101.2:6000, 5)],\n      (1, 2, 192.168.102.1:6000): [(1, 2, 192.168.102.1:6000, 6),\n                                   (1, 2, 192.168.102.1:6000, 7),\n                                   (1, 2, 192.168.102.1:6000, 8)],\n      (1, 2, 192.168.102.2:6000): [(1, 2, 192.168.102.2:6000, 9),\n                                   (1, 2, 192.168.102.2:6000, 10)],\n      (2, 1, 192.168.201.1:6000): [(2, 1, 192.168.201.1:6000, 12),\n                                   (2, 1, 192.168.201.1:6000, 13),\n                                   (2, 1, 192.168.201.1:6000, 14)],\n      (2, 1, 192.168.201.2:6000): [(2, 1, 192.168.201.2:6000, 15),\n                                   (2, 1, 192.168.201.2:6000, 16),\n                                   (2, 1, 192.168.201.2:6000, 17)],\n    }\n\n    :devices: device dicts from which to generate the tree\n    :returns: tier tree\n\n    """'
newline|'\n'
name|'tier2children'
op|'='
name|'defaultdict'
op|'('
name|'set'
op|')'
newline|'\n'
name|'for'
name|'dev'
name|'in'
name|'devices'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'tier'
name|'in'
name|'tiers_for_dev'
op|'('
name|'dev'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'>'
number|'1'
op|':'
newline|'\n'
indent|'                '
name|'tier2children'
op|'['
name|'tier'
op|'['
number|'0'
op|':'
op|'-'
number|'1'
op|']'
op|']'
op|'.'
name|'add'
op|'('
name|'tier'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'tier2children'
op|'['
op|'('
op|')'
op|']'
op|'.'
name|'add'
op|'('
name|'tier'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'return'
name|'tier2children'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|validate_and_normalize_ip
dedent|''
name|'def'
name|'validate_and_normalize_ip'
op|'('
name|'ip'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Return normalized ip if the ip is a valid ip.\n    Otherwise raise ValueError Exception. The hostname is\n    normalized to all lower case. IPv6-addresses are converted to\n    lowercase and fully expanded.\n    """'
newline|'\n'
comment|'# first convert to lower case'
nl|'\n'
name|'new_ip'
op|'='
name|'ip'
op|'.'
name|'lower'
op|'('
op|')'
newline|'\n'
name|'if'
name|'is_valid_ipv4'
op|'('
name|'new_ip'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'new_ip'
newline|'\n'
dedent|''
name|'elif'
name|'is_valid_ipv6'
op|'('
name|'new_ip'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'expand_ipv6'
op|'('
name|'new_ip'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'ValueError'
op|'('
string|"'Invalid ip %s'"
op|'%'
name|'ip'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|validate_and_normalize_address
dedent|''
dedent|''
name|'def'
name|'validate_and_normalize_address'
op|'('
name|'address'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Return normalized address if the address is a valid ip or hostname.\n    Otherwise raise ValueError Exception. The hostname is\n    normalized to all lower case. IPv6-addresses are converted to\n    lowercase and fully expanded.\n\n    RFC1123 2.1 Host Names and Nubmers\n    DISCUSSION\n        This last requirement is not intended to specify the complete\n        syntactic form for entering a dotted-decimal host number;\n        that is considered to be a user-interface issue.  For\n        example, a dotted-decimal number must be enclosed within\n        "[ ]" brackets for SMTP mail (see Section 5.2.17).  This\n        notation could be made universal within a host system,\n        simplifying the syntactic checking for a dotted-decimal\n        number.\n\n        If a dotted-decimal number can be entered without such\n        identifying delimiters, then a full syntactic check must be\n        made, because a segment of a host domain name is now allowed\n        to begin with a digit and could legally be entirely numeric\n        (see Section 6.1.2.4).  However, a valid host name can never\n        have the dotted-decimal form #.#.#.#, since at least the\n        highest-level component label will be alphabetic.\n    """'
newline|'\n'
name|'new_address'
op|'='
name|'address'
op|'.'
name|'lstrip'
op|'('
string|"'['"
op|')'
op|'.'
name|'rstrip'
op|'('
string|"']'"
op|')'
newline|'\n'
name|'if'
name|'address'
op|'.'
name|'startswith'
op|'('
string|"'['"
op|')'
name|'and'
name|'address'
op|'.'
name|'endswith'
op|'('
string|"']'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'validate_and_normalize_ip'
op|'('
name|'new_address'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'new_address'
op|'='
name|'new_address'
op|'.'
name|'lower'
op|'('
op|')'
newline|'\n'
name|'if'
name|'is_valid_ipv4'
op|'('
name|'new_address'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'new_address'
newline|'\n'
dedent|''
name|'elif'
name|'is_valid_ipv6'
op|'('
name|'new_address'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'expand_ipv6'
op|'('
name|'new_address'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'is_valid_hostname'
op|'('
name|'new_address'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'new_address'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'ValueError'
op|'('
string|"'Invalid address %s'"
op|'%'
name|'address'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|is_valid_ip
dedent|''
dedent|''
name|'def'
name|'is_valid_ip'
op|'('
name|'ip'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Return True if the provided ip is a valid IP-address\n    """'
newline|'\n'
name|'return'
name|'is_valid_ipv4'
op|'('
name|'ip'
op|')'
name|'or'
name|'is_valid_ipv6'
op|'('
name|'ip'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|is_valid_ipv4
dedent|''
name|'def'
name|'is_valid_ipv4'
op|'('
name|'ip'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Return True if the provided ip is a valid IPv4-address\n    """'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'socket'
op|'.'
name|'inet_pton'
op|'('
name|'socket'
op|'.'
name|'AF_INET'
op|','
name|'ip'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'socket'
op|'.'
name|'error'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'False'
newline|'\n'
dedent|''
name|'return'
name|'True'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|is_valid_ipv6
dedent|''
name|'def'
name|'is_valid_ipv6'
op|'('
name|'ip'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Return True if the provided ip is a valid IPv6-address\n    """'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'socket'
op|'.'
name|'inet_pton'
op|'('
name|'socket'
op|'.'
name|'AF_INET6'
op|','
name|'ip'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'socket'
op|'.'
name|'error'
op|':'
comment|'# not a valid address'
newline|'\n'
indent|'        '
name|'return'
name|'False'
newline|'\n'
dedent|''
name|'return'
name|'True'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|is_valid_hostname
dedent|''
name|'def'
name|'is_valid_hostname'
op|'('
name|'hostname'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Return True if the provided hostname is a valid hostname\n    """'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'hostname'
op|')'
op|'<'
number|'1'
name|'or'
name|'len'
op|'('
name|'hostname'
op|')'
op|'>'
number|'255'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'False'
newline|'\n'
dedent|''
name|'if'
name|'hostname'
op|'['
op|'-'
number|'1'
op|']'
op|'=='
string|'"."'
op|':'
newline|'\n'
comment|'# strip exactly one dot from the right, if present'
nl|'\n'
indent|'        '
name|'hostname'
op|'='
name|'hostname'
op|'['
op|':'
op|'-'
number|'1'
op|']'
newline|'\n'
dedent|''
name|'allowed'
op|'='
name|'re'
op|'.'
name|'compile'
op|'('
string|'"(?!-)[A-Z\\d-]{1,63}(?<!-)$"'
op|','
name|'re'
op|'.'
name|'IGNORECASE'
op|')'
newline|'\n'
name|'return'
name|'all'
op|'('
name|'allowed'
op|'.'
name|'match'
op|'('
name|'x'
op|')'
name|'for'
name|'x'
name|'in'
name|'hostname'
op|'.'
name|'split'
op|'('
string|'"."'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|is_local_device
dedent|''
name|'def'
name|'is_local_device'
op|'('
name|'my_ips'
op|','
name|'my_port'
op|','
name|'dev_ip'
op|','
name|'dev_port'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Return True if the provided dev_ip and dev_port are among the IP\n    addresses specified in my_ips and my_port respectively.\n\n    If dev_ip is a hostname then it is first translated to an IP\n    address before checking it against my_ips.\n    """'
newline|'\n'
name|'if'
name|'not'
name|'is_valid_ip'
op|'('
name|'dev_ip'
op|')'
name|'and'
name|'is_valid_hostname'
op|'('
name|'dev_ip'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
comment|'# get the ip for this host; use getaddrinfo so that'
nl|'\n'
comment|'# it works for both ipv4 and ipv6 addresses'
nl|'\n'
indent|'            '
name|'addrinfo'
op|'='
name|'socket'
op|'.'
name|'getaddrinfo'
op|'('
name|'dev_ip'
op|','
name|'dev_port'
op|')'
newline|'\n'
name|'for'
name|'addr'
name|'in'
name|'addrinfo'
op|':'
newline|'\n'
indent|'                '
name|'family'
op|'='
name|'addr'
op|'['
number|'0'
op|']'
newline|'\n'
name|'dev_ip'
op|'='
name|'addr'
op|'['
number|'4'
op|']'
op|'['
number|'0'
op|']'
comment|'# get the ip-address'
newline|'\n'
name|'if'
name|'family'
op|'=='
name|'socket'
op|'.'
name|'AF_INET6'
op|':'
newline|'\n'
indent|'                    '
name|'dev_ip'
op|'='
name|'expand_ipv6'
op|'('
name|'dev_ip'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'dev_ip'
name|'in'
name|'my_ips'
name|'and'
name|'dev_port'
op|'=='
name|'my_port'
op|':'
newline|'\n'
indent|'                    '
name|'return'
name|'True'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'False'
newline|'\n'
dedent|''
name|'except'
name|'socket'
op|'.'
name|'gaierror'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'False'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'dev_ip'
name|'in'
name|'my_ips'
name|'and'
name|'dev_port'
op|'=='
name|'my_port'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|parse_search_value
dedent|''
name|'def'
name|'parse_search_value'
op|'('
name|'search_value'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""The <search-value> can be of the form::\n\n        d<device_id>r<region>z<zone>-<ip>:<port>R<r_ip>:<r_port>/\n         <device_name>_<meta>\n\n    Where <r_ip> and <r_port> are replication ip and port.\n\n    Any part is optional, but you must include at least one part.\n\n    Examples::\n\n        d74              Matches the device id 74\n        r4               Matches devices in region 4\n        z1               Matches devices in zone 1\n        z1-1.2.3.4       Matches devices in zone 1 with the ip 1.2.3.4\n        1.2.3.4          Matches devices in any zone with the ip 1.2.3.4\n        z1:5678          Matches devices in zone 1 using port 5678\n        :5678            Matches devices that use port 5678\n        R5.6.7.8         Matches devices that use replication ip 5.6.7.8\n        R:5678           Matches devices that use replication port 5678\n        1.2.3.4R5.6.7.8  Matches devices that use ip 1.2.3.4 and replication ip\n                         5.6.7.8\n        /sdb1            Matches devices with the device name sdb1\n        _shiny           Matches devices with shiny in the meta data\n        _"snet: 5.6.7.8" Matches devices with snet: 5.6.7.8 in the meta data\n        [::1]            Matches devices in any zone with the ip ::1\n        z1-[::1]:5678    Matches devices in zone 1 with ip ::1 and port 5678\n\n    Most specific example::\n\n        d74r4z1-1.2.3.4:5678/sdb1_"snet: 5.6.7.8"\n\n    Nerd explanation:\n\n        All items require their single character prefix except the ip, in which\n        case the - is optional unless the device id or zone is also included.\n    """'
newline|'\n'
name|'orig_search_value'
op|'='
name|'search_value'
newline|'\n'
name|'match'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'if'
name|'search_value'
op|'.'
name|'startswith'
op|'('
string|"'d'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'i'
op|'='
number|'1'
newline|'\n'
name|'while'
name|'i'
op|'<'
name|'len'
op|'('
name|'search_value'
op|')'
name|'and'
name|'search_value'
op|'['
name|'i'
op|']'
op|'.'
name|'isdigit'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'i'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'match'
op|'['
string|"'id'"
op|']'
op|'='
name|'int'
op|'('
name|'search_value'
op|'['
number|'1'
op|':'
name|'i'
op|']'
op|')'
newline|'\n'
name|'search_value'
op|'='
name|'search_value'
op|'['
name|'i'
op|':'
op|']'
newline|'\n'
dedent|''
name|'if'
name|'search_value'
op|'.'
name|'startswith'
op|'('
string|"'r'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'i'
op|'='
number|'1'
newline|'\n'
name|'while'
name|'i'
op|'<'
name|'len'
op|'('
name|'search_value'
op|')'
name|'and'
name|'search_value'
op|'['
name|'i'
op|']'
op|'.'
name|'isdigit'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'i'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'match'
op|'['
string|"'region'"
op|']'
op|'='
name|'int'
op|'('
name|'search_value'
op|'['
number|'1'
op|':'
name|'i'
op|']'
op|')'
newline|'\n'
name|'search_value'
op|'='
name|'search_value'
op|'['
name|'i'
op|':'
op|']'
newline|'\n'
dedent|''
name|'if'
name|'search_value'
op|'.'
name|'startswith'
op|'('
string|"'z'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'i'
op|'='
number|'1'
newline|'\n'
name|'while'
name|'i'
op|'<'
name|'len'
op|'('
name|'search_value'
op|')'
name|'and'
name|'search_value'
op|'['
name|'i'
op|']'
op|'.'
name|'isdigit'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'i'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'match'
op|'['
string|"'zone'"
op|']'
op|'='
name|'int'
op|'('
name|'search_value'
op|'['
number|'1'
op|':'
name|'i'
op|']'
op|')'
newline|'\n'
name|'search_value'
op|'='
name|'search_value'
op|'['
name|'i'
op|':'
op|']'
newline|'\n'
dedent|''
name|'if'
name|'search_value'
op|'.'
name|'startswith'
op|'('
string|"'-'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'search_value'
op|'='
name|'search_value'
op|'['
number|'1'
op|':'
op|']'
newline|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'search_value'
op|')'
name|'and'
name|'search_value'
op|'['
number|'0'
op|']'
op|'.'
name|'isdigit'
op|'('
op|')'
op|':'
newline|'\n'
indent|'        '
name|'i'
op|'='
number|'1'
newline|'\n'
name|'while'
name|'i'
op|'<'
name|'len'
op|'('
name|'search_value'
op|')'
name|'and'
name|'search_value'
op|'['
name|'i'
op|']'
name|'in'
string|"'0123456789.'"
op|':'
newline|'\n'
indent|'            '
name|'i'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'match'
op|'['
string|"'ip'"
op|']'
op|'='
name|'search_value'
op|'['
op|':'
name|'i'
op|']'
newline|'\n'
name|'search_value'
op|'='
name|'search_value'
op|'['
name|'i'
op|':'
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'len'
op|'('
name|'search_value'
op|')'
name|'and'
name|'search_value'
op|'['
number|'0'
op|']'
op|'=='
string|"'['"
op|':'
newline|'\n'
indent|'        '
name|'i'
op|'='
number|'1'
newline|'\n'
name|'while'
name|'i'
op|'<'
name|'len'
op|'('
name|'search_value'
op|')'
name|'and'
name|'search_value'
op|'['
name|'i'
op|']'
op|'!='
string|"']'"
op|':'
newline|'\n'
indent|'            '
name|'i'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'i'
op|'+='
number|'1'
newline|'\n'
name|'match'
op|'['
string|"'ip'"
op|']'
op|'='
name|'search_value'
op|'['
op|':'
name|'i'
op|']'
op|'.'
name|'lstrip'
op|'('
string|"'['"
op|')'
op|'.'
name|'rstrip'
op|'('
string|"']'"
op|')'
newline|'\n'
name|'search_value'
op|'='
name|'search_value'
op|'['
name|'i'
op|':'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
string|"'ip'"
name|'in'
name|'match'
op|':'
newline|'\n'
comment|'# ipv6 addresses are converted to all lowercase'
nl|'\n'
comment|'# and use the fully expanded representation'
nl|'\n'
indent|'        '
name|'match'
op|'['
string|"'ip'"
op|']'
op|'='
name|'validate_and_normalize_ip'
op|'('
name|'match'
op|'['
string|"'ip'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'search_value'
op|'.'
name|'startswith'
op|'('
string|"':'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'i'
op|'='
number|'1'
newline|'\n'
name|'while'
name|'i'
op|'<'
name|'len'
op|'('
name|'search_value'
op|')'
name|'and'
name|'search_value'
op|'['
name|'i'
op|']'
op|'.'
name|'isdigit'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'i'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'match'
op|'['
string|"'port'"
op|']'
op|'='
name|'int'
op|'('
name|'search_value'
op|'['
number|'1'
op|':'
name|'i'
op|']'
op|')'
newline|'\n'
name|'search_value'
op|'='
name|'search_value'
op|'['
name|'i'
op|':'
op|']'
newline|'\n'
comment|'# replication parameters'
nl|'\n'
dedent|''
name|'if'
name|'search_value'
op|'.'
name|'startswith'
op|'('
string|"'R'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'search_value'
op|'='
name|'search_value'
op|'['
number|'1'
op|':'
op|']'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'search_value'
op|')'
name|'and'
name|'search_value'
op|'['
number|'0'
op|']'
op|'.'
name|'isdigit'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'i'
op|'='
number|'1'
newline|'\n'
name|'while'
op|'('
name|'i'
op|'<'
name|'len'
op|'('
name|'search_value'
op|')'
name|'and'
nl|'\n'
name|'search_value'
op|'['
name|'i'
op|']'
name|'in'
string|"'0123456789.'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'i'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'match'
op|'['
string|"'replication_ip'"
op|']'
op|'='
name|'search_value'
op|'['
op|':'
name|'i'
op|']'
newline|'\n'
name|'search_value'
op|'='
name|'search_value'
op|'['
name|'i'
op|':'
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'len'
op|'('
name|'search_value'
op|')'
name|'and'
name|'search_value'
op|'['
number|'0'
op|']'
op|'=='
string|"'['"
op|':'
newline|'\n'
indent|'            '
name|'i'
op|'='
number|'1'
newline|'\n'
name|'while'
name|'i'
op|'<'
name|'len'
op|'('
name|'search_value'
op|')'
name|'and'
name|'search_value'
op|'['
name|'i'
op|']'
op|'!='
string|"']'"
op|':'
newline|'\n'
indent|'                '
name|'i'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'i'
op|'+='
number|'1'
newline|'\n'
name|'match'
op|'['
string|"'replication_ip'"
op|']'
op|'='
name|'search_value'
op|'['
op|':'
name|'i'
op|']'
op|'.'
name|'lstrip'
op|'('
string|"'['"
op|')'
op|'.'
name|'rstrip'
op|'('
string|"']'"
op|')'
newline|'\n'
name|'search_value'
op|'='
name|'search_value'
op|'['
name|'i'
op|':'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
string|"'replication_ip'"
name|'in'
name|'match'
op|':'
newline|'\n'
comment|'# ipv6 addresses are converted to all lowercase'
nl|'\n'
comment|'# and use the fully expanded representation'
nl|'\n'
indent|'            '
name|'match'
op|'['
string|"'replication_ip'"
op|']'
op|'='
name|'validate_and_normalize_ip'
op|'('
name|'match'
op|'['
string|"'replication_ip'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'search_value'
op|'.'
name|'startswith'
op|'('
string|"':'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'i'
op|'='
number|'1'
newline|'\n'
name|'while'
name|'i'
op|'<'
name|'len'
op|'('
name|'search_value'
op|')'
name|'and'
name|'search_value'
op|'['
name|'i'
op|']'
op|'.'
name|'isdigit'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'i'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'match'
op|'['
string|"'replication_port'"
op|']'
op|'='
name|'int'
op|'('
name|'search_value'
op|'['
number|'1'
op|':'
name|'i'
op|']'
op|')'
newline|'\n'
name|'search_value'
op|'='
name|'search_value'
op|'['
name|'i'
op|':'
op|']'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'search_value'
op|'.'
name|'startswith'
op|'('
string|"'/'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'i'
op|'='
number|'1'
newline|'\n'
name|'while'
name|'i'
op|'<'
name|'len'
op|'('
name|'search_value'
op|')'
name|'and'
name|'search_value'
op|'['
name|'i'
op|']'
op|'!='
string|"'_'"
op|':'
newline|'\n'
indent|'            '
name|'i'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'match'
op|'['
string|"'device'"
op|']'
op|'='
name|'search_value'
op|'['
number|'1'
op|':'
name|'i'
op|']'
newline|'\n'
name|'search_value'
op|'='
name|'search_value'
op|'['
name|'i'
op|':'
op|']'
newline|'\n'
dedent|''
name|'if'
name|'search_value'
op|'.'
name|'startswith'
op|'('
string|"'_'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'match'
op|'['
string|"'meta'"
op|']'
op|'='
name|'search_value'
op|'['
number|'1'
op|':'
op|']'
newline|'\n'
name|'search_value'
op|'='
string|"''"
newline|'\n'
dedent|''
name|'if'
name|'search_value'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'ValueError'
op|'('
string|"'Invalid <search-value>: %s'"
op|'%'
nl|'\n'
name|'repr'
op|'('
name|'orig_search_value'
op|')'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'match'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|parse_search_values_from_opts
dedent|''
name|'def'
name|'parse_search_values_from_opts'
op|'('
name|'opts'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Convert optparse style options into a dictionary for searching.\n\n    :param opts: optparse style options\n    :returns: a dictonary with search values to filter devices,\n              supported parameters are id, region, zone, ip, port,\n              replication_ip, replication_port, device, weight, meta\n    """'
newline|'\n'
nl|'\n'
name|'search_values'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'key'
name|'in'
op|'('
string|"'id'"
op|','
string|"'region'"
op|','
string|"'zone'"
op|','
string|"'ip'"
op|','
string|"'port'"
op|','
string|"'replication_ip'"
op|','
nl|'\n'
string|"'replication_port'"
op|','
string|"'device'"
op|','
string|"'weight'"
op|','
string|"'meta'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'value'
op|'='
name|'getattr'
op|'('
name|'opts'
op|','
name|'key'
op|','
name|'None'
op|')'
newline|'\n'
name|'if'
name|'value'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'key'
op|'=='
string|"'ip'"
name|'or'
name|'key'
op|'=='
string|"'replication_ip'"
op|':'
newline|'\n'
indent|'                '
name|'value'
op|'='
name|'validate_and_normalize_address'
op|'('
name|'value'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'search_values'
op|'['
name|'key'
op|']'
op|'='
name|'value'
newline|'\n'
dedent|''
name|'return'
name|'search_values'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|parse_change_values_from_opts
dedent|''
name|'def'
name|'parse_change_values_from_opts'
op|'('
name|'opts'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Convert optparse style options into a dictionary for changing.\n\n    :param opts: optparse style options\n    :returns: a dictonary with change values to filter devices,\n              supported parameters are ip, port, replication_ip,\n              replication_port\n    """'
newline|'\n'
nl|'\n'
name|'change_values'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'key'
name|'in'
op|'('
string|"'change_ip'"
op|','
string|"'change_port'"
op|','
string|"'change_replication_ip'"
op|','
nl|'\n'
string|"'change_replication_port'"
op|','
string|"'change_device'"
op|','
string|"'change_meta'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'value'
op|'='
name|'getattr'
op|'('
name|'opts'
op|','
name|'key'
op|','
name|'None'
op|')'
newline|'\n'
name|'if'
name|'value'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'key'
op|'=='
string|"'change_ip'"
name|'or'
name|'key'
op|'=='
string|"'change_replication_ip'"
op|':'
newline|'\n'
indent|'                '
name|'value'
op|'='
name|'validate_and_normalize_address'
op|'('
name|'value'
op|')'
newline|'\n'
dedent|''
name|'change_values'
op|'['
name|'key'
op|'.'
name|'replace'
op|'('
string|"'change_'"
op|','
string|"''"
op|')'
op|']'
op|'='
name|'value'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'change_values'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|validate_args
dedent|''
name|'def'
name|'validate_args'
op|'('
name|'argvish'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Build OptionParse and validate it whether the format is new command-line\n    format or not.\n    """'
newline|'\n'
name|'opts'
op|','
name|'args'
op|'='
name|'parse_args'
op|'('
name|'argvish'
op|')'
newline|'\n'
name|'new_cmd_format'
op|'='
name|'opts'
op|'.'
name|'id'
name|'or'
name|'opts'
op|'.'
name|'region'
name|'or'
name|'opts'
op|'.'
name|'zone'
name|'or'
name|'opts'
op|'.'
name|'ip'
name|'or'
name|'opts'
op|'.'
name|'port'
name|'or'
name|'opts'
op|'.'
name|'replication_ip'
name|'or'
name|'opts'
op|'.'
name|'replication_port'
name|'or'
name|'opts'
op|'.'
name|'device'
name|'or'
name|'opts'
op|'.'
name|'weight'
name|'or'
name|'opts'
op|'.'
name|'meta'
newline|'\n'
name|'return'
op|'('
name|'new_cmd_format'
op|','
name|'opts'
op|','
name|'args'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|parse_args
dedent|''
name|'def'
name|'parse_args'
op|'('
name|'argvish'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Build OptionParser and evaluate command line arguments.\n    """'
newline|'\n'
name|'parser'
op|'='
name|'optparse'
op|'.'
name|'OptionParser'
op|'('
op|')'
newline|'\n'
name|'parser'
op|'.'
name|'add_option'
op|'('
string|"'-u'"
op|','
string|"'--id'"
op|','
name|'type'
op|'='
string|'"int"'
op|','
nl|'\n'
name|'help'
op|'='
string|'"Device ID"'
op|')'
newline|'\n'
name|'parser'
op|'.'
name|'add_option'
op|'('
string|"'-r'"
op|','
string|"'--region'"
op|','
name|'type'
op|'='
string|'"int"'
op|','
nl|'\n'
name|'help'
op|'='
string|'"Region"'
op|')'
newline|'\n'
name|'parser'
op|'.'
name|'add_option'
op|'('
string|"'-z'"
op|','
string|"'--zone'"
op|','
name|'type'
op|'='
string|'"int"'
op|','
nl|'\n'
name|'help'
op|'='
string|'"Zone"'
op|')'
newline|'\n'
name|'parser'
op|'.'
name|'add_option'
op|'('
string|"'-i'"
op|','
string|"'--ip'"
op|','
name|'type'
op|'='
string|'"string"'
op|','
nl|'\n'
name|'help'
op|'='
string|'"IP address"'
op|')'
newline|'\n'
name|'parser'
op|'.'
name|'add_option'
op|'('
string|"'-p'"
op|','
string|"'--port'"
op|','
name|'type'
op|'='
string|'"int"'
op|','
nl|'\n'
name|'help'
op|'='
string|'"Port number"'
op|')'
newline|'\n'
name|'parser'
op|'.'
name|'add_option'
op|'('
string|"'-j'"
op|','
string|"'--replication-ip'"
op|','
name|'type'
op|'='
string|'"string"'
op|','
nl|'\n'
name|'help'
op|'='
string|'"Replication IP address"'
op|')'
newline|'\n'
name|'parser'
op|'.'
name|'add_option'
op|'('
string|"'-q'"
op|','
string|"'--replication-port'"
op|','
name|'type'
op|'='
string|'"int"'
op|','
nl|'\n'
name|'help'
op|'='
string|'"Replication port number"'
op|')'
newline|'\n'
name|'parser'
op|'.'
name|'add_option'
op|'('
string|"'-d'"
op|','
string|"'--device'"
op|','
name|'type'
op|'='
string|'"string"'
op|','
nl|'\n'
name|'help'
op|'='
string|'"Device name (e.g. md0, sdb1)"'
op|')'
newline|'\n'
name|'parser'
op|'.'
name|'add_option'
op|'('
string|"'-w'"
op|','
string|"'--weight'"
op|','
name|'type'
op|'='
string|'"float"'
op|','
nl|'\n'
name|'help'
op|'='
string|'"Device weight"'
op|')'
newline|'\n'
name|'parser'
op|'.'
name|'add_option'
op|'('
string|"'-m'"
op|','
string|"'--meta'"
op|','
name|'type'
op|'='
string|'"string"'
op|','
name|'default'
op|'='
string|'""'
op|','
nl|'\n'
name|'help'
op|'='
string|'"Extra device info (just a string)"'
op|')'
newline|'\n'
name|'parser'
op|'.'
name|'add_option'
op|'('
string|"'-I'"
op|','
string|"'--change-ip'"
op|','
name|'type'
op|'='
string|'"string"'
op|','
nl|'\n'
name|'help'
op|'='
string|'"IP address for change"'
op|')'
newline|'\n'
name|'parser'
op|'.'
name|'add_option'
op|'('
string|"'-P'"
op|','
string|"'--change-port'"
op|','
name|'type'
op|'='
string|'"int"'
op|','
nl|'\n'
name|'help'
op|'='
string|'"Port number for change"'
op|')'
newline|'\n'
name|'parser'
op|'.'
name|'add_option'
op|'('
string|"'-J'"
op|','
string|"'--change-replication-ip'"
op|','
name|'type'
op|'='
string|'"string"'
op|','
nl|'\n'
name|'help'
op|'='
string|'"Replication IP address for change"'
op|')'
newline|'\n'
name|'parser'
op|'.'
name|'add_option'
op|'('
string|"'-Q'"
op|','
string|"'--change-replication-port'"
op|','
name|'type'
op|'='
string|'"int"'
op|','
nl|'\n'
name|'help'
op|'='
string|'"Replication port number for change"'
op|')'
newline|'\n'
name|'parser'
op|'.'
name|'add_option'
op|'('
string|"'-D'"
op|','
string|"'--change-device'"
op|','
name|'type'
op|'='
string|'"string"'
op|','
nl|'\n'
name|'help'
op|'='
string|'"Device name (e.g. md0, sdb1) for change"'
op|')'
newline|'\n'
name|'parser'
op|'.'
name|'add_option'
op|'('
string|"'-M'"
op|','
string|"'--change-meta'"
op|','
name|'type'
op|'='
string|'"string"'
op|','
name|'default'
op|'='
string|'""'
op|','
nl|'\n'
name|'help'
op|'='
string|'"Extra device info (just a string) for change"'
op|')'
newline|'\n'
name|'return'
name|'parser'
op|'.'
name|'parse_args'
op|'('
name|'argvish'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|parse_builder_ring_filename_args
dedent|''
name|'def'
name|'parse_builder_ring_filename_args'
op|'('
name|'argvish'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'first_arg'
op|'='
name|'argvish'
op|'['
number|'1'
op|']'
newline|'\n'
name|'if'
name|'first_arg'
op|'.'
name|'endswith'
op|'('
string|"'.ring.gz'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ring_file'
op|'='
name|'first_arg'
newline|'\n'
name|'builder_file'
op|'='
name|'first_arg'
op|'['
op|':'
op|'-'
name|'len'
op|'('
string|"'.ring.gz'"
op|')'
op|']'
op|'+'
string|"'.builder'"
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'builder_file'
op|'='
name|'first_arg'
newline|'\n'
name|'if'
name|'not'
name|'builder_file'
op|'.'
name|'endswith'
op|'('
string|"'.builder'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ring_file'
op|'='
name|'first_arg'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'ring_file'
op|'='
name|'builder_file'
op|'['
op|':'
op|'-'
name|'len'
op|'('
string|"'.builder'"
op|')'
op|']'
newline|'\n'
dedent|''
name|'ring_file'
op|'+='
string|"'.ring.gz'"
newline|'\n'
dedent|''
name|'return'
name|'builder_file'
op|','
name|'ring_file'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|build_dev_from_opts
dedent|''
name|'def'
name|'build_dev_from_opts'
op|'('
name|'opts'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Convert optparse stype options into a device dictionary.\n    """'
newline|'\n'
name|'for'
name|'attribute'
op|','
name|'shortopt'
op|','
name|'longopt'
name|'in'
op|'('
op|'['
string|"'region'"
op|','
string|"'-r'"
op|','
string|"'--region'"
op|']'
op|','
nl|'\n'
op|'['
string|"'zone'"
op|','
string|"'-z'"
op|','
string|"'--zone'"
op|']'
op|','
nl|'\n'
op|'['
string|"'ip'"
op|','
string|"'-i'"
op|','
string|"'--ip'"
op|']'
op|','
nl|'\n'
op|'['
string|"'port'"
op|','
string|"'-p'"
op|','
string|"'--port'"
op|']'
op|','
nl|'\n'
op|'['
string|"'device'"
op|','
string|"'-d'"
op|','
string|"'--device'"
op|']'
op|','
nl|'\n'
op|'['
string|"'weight'"
op|','
string|"'-w'"
op|','
string|"'--weight'"
op|']'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'getattr'
op|'('
name|'opts'
op|','
name|'attribute'
op|','
name|'None'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'ValueError'
op|'('
string|"'Required argument %s/%s not specified.'"
op|'%'
nl|'\n'
op|'('
name|'shortopt'
op|','
name|'longopt'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'ip'
op|'='
name|'validate_and_normalize_address'
op|'('
name|'opts'
op|'.'
name|'ip'
op|')'
newline|'\n'
name|'replication_ip'
op|'='
name|'validate_and_normalize_address'
op|'('
nl|'\n'
op|'('
name|'opts'
op|'.'
name|'replication_ip'
name|'or'
name|'opts'
op|'.'
name|'ip'
op|')'
op|')'
newline|'\n'
name|'replication_port'
op|'='
name|'opts'
op|'.'
name|'replication_port'
name|'or'
name|'opts'
op|'.'
name|'port'
newline|'\n'
nl|'\n'
name|'return'
op|'{'
string|"'region'"
op|':'
name|'opts'
op|'.'
name|'region'
op|','
string|"'zone'"
op|':'
name|'opts'
op|'.'
name|'zone'
op|','
string|"'ip'"
op|':'
name|'ip'
op|','
nl|'\n'
string|"'port'"
op|':'
name|'opts'
op|'.'
name|'port'
op|','
string|"'device'"
op|':'
name|'opts'
op|'.'
name|'device'
op|','
string|"'meta'"
op|':'
name|'opts'
op|'.'
name|'meta'
op|','
nl|'\n'
string|"'replication_ip'"
op|':'
name|'replication_ip'
op|','
nl|'\n'
string|"'replication_port'"
op|':'
name|'replication_port'
op|','
string|"'weight'"
op|':'
name|'opts'
op|'.'
name|'weight'
op|'}'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|dispersion_report
dedent|''
name|'def'
name|'dispersion_report'
op|'('
name|'builder'
op|','
name|'search_filter'
op|'='
name|'None'
op|','
name|'verbose'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'not'
name|'builder'
op|'.'
name|'_dispersion_graph'
op|':'
newline|'\n'
indent|'        '
name|'builder'
op|'.'
name|'_build_dispersion_graph'
op|'('
op|')'
newline|'\n'
dedent|''
name|'max_allowed_replicas'
op|'='
name|'builder'
op|'.'
name|'_build_max_replicas_by_tier'
op|'('
op|')'
newline|'\n'
name|'worst_tier'
op|'='
name|'None'
newline|'\n'
name|'max_dispersion'
op|'='
number|'0.0'
newline|'\n'
name|'sorted_graph'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'tier'
op|','
name|'replica_counts'
name|'in'
name|'sorted'
op|'('
name|'builder'
op|'.'
name|'_dispersion_graph'
op|'.'
name|'items'
op|'('
op|')'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'tier_name'
op|'='
name|'get_tier_name'
op|'('
name|'tier'
op|','
name|'builder'
op|')'
newline|'\n'
name|'if'
name|'search_filter'
name|'and'
name|'not'
name|'re'
op|'.'
name|'match'
op|'('
name|'search_filter'
op|','
name|'tier_name'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'continue'
newline|'\n'
dedent|''
name|'max_replicas'
op|'='
name|'int'
op|'('
name|'max_allowed_replicas'
op|'['
name|'tier'
op|']'
op|')'
newline|'\n'
name|'at_risk_parts'
op|'='
name|'sum'
op|'('
name|'replica_counts'
op|'['
name|'max_replicas'
op|'+'
number|'1'
op|':'
op|']'
op|')'
newline|'\n'
name|'placed_parts'
op|'='
name|'sum'
op|'('
name|'replica_counts'
op|'['
number|'1'
op|':'
op|']'
op|')'
newline|'\n'
name|'tier_dispersion'
op|'='
number|'100.0'
op|'*'
name|'at_risk_parts'
op|'/'
name|'placed_parts'
newline|'\n'
name|'if'
name|'tier_dispersion'
op|'>'
name|'max_dispersion'
op|':'
newline|'\n'
indent|'            '
name|'max_dispersion'
op|'='
name|'tier_dispersion'
newline|'\n'
name|'worst_tier'
op|'='
name|'tier_name'
newline|'\n'
dedent|''
name|'max_dispersion'
op|'='
name|'max'
op|'('
name|'max_dispersion'
op|','
name|'tier_dispersion'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'verbose'
op|':'
newline|'\n'
indent|'            '
name|'continue'
newline|'\n'
nl|'\n'
dedent|''
name|'tier_report'
op|'='
op|'{'
nl|'\n'
string|"'max_replicas'"
op|':'
name|'max_replicas'
op|','
nl|'\n'
string|"'placed_parts'"
op|':'
name|'placed_parts'
op|','
nl|'\n'
string|"'dispersion'"
op|':'
name|'tier_dispersion'
op|','
nl|'\n'
string|"'replicas'"
op|':'
name|'replica_counts'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'sorted_graph'
op|'.'
name|'append'
op|'('
op|'('
name|'tier_name'
op|','
name|'tier_report'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
op|'{'
nl|'\n'
string|"'max_dispersion'"
op|':'
name|'max_dispersion'
op|','
nl|'\n'
string|"'worst_tier'"
op|':'
name|'worst_tier'
op|','
nl|'\n'
string|"'graph'"
op|':'
name|'sorted_graph'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|get_tier_name
dedent|''
name|'def'
name|'get_tier_name'
op|'('
name|'tier'
op|','
name|'builder'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'1'
op|':'
newline|'\n'
indent|'        '
name|'return'
string|'"r%s"'
op|'%'
op|'('
name|'tier'
op|'['
number|'0'
op|']'
op|','
op|')'
newline|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'2'
op|':'
newline|'\n'
indent|'        '
name|'return'
string|'"r%sz%s"'
op|'%'
op|'('
name|'tier'
op|'['
number|'0'
op|']'
op|','
name|'tier'
op|'['
number|'1'
op|']'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'3'
op|':'
newline|'\n'
indent|'        '
name|'return'
string|'"r%sz%s-%s"'
op|'%'
op|'('
name|'tier'
op|'['
number|'0'
op|']'
op|','
name|'tier'
op|'['
number|'1'
op|']'
op|','
name|'tier'
op|'['
number|'2'
op|']'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'tier'
op|')'
op|'=='
number|'4'
op|':'
newline|'\n'
indent|'        '
name|'device'
op|'='
name|'builder'
op|'.'
name|'devs'
op|'['
name|'tier'
op|'['
number|'3'
op|']'
op|']'
name|'or'
op|'{'
op|'}'
newline|'\n'
name|'return'
string|'"r%sz%s-%s/%s"'
op|'%'
op|'('
name|'tier'
op|'['
number|'0'
op|']'
op|','
name|'tier'
op|'['
number|'1'
op|']'
op|','
name|'tier'
op|'['
number|'2'
op|']'
op|','
nl|'\n'
name|'device'
op|'.'
name|'get'
op|'('
string|"'device'"
op|','
string|"'IDd%s'"
op|'%'
name|'tier'
op|'['
number|'3'
op|']'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit

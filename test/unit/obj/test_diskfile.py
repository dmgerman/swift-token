begin_unit
comment|'#-*- coding:utf-8 -*-'
nl|'\n'
comment|'# Copyright (c) 2010-2012 OpenStack Foundation'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
string|'"""Tests for swift.obj.diskfile"""'
newline|'\n'
nl|'\n'
name|'import'
name|'cPickle'
name|'as'
name|'pickle'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'errno'
newline|'\n'
name|'import'
name|'mock'
newline|'\n'
name|'import'
name|'unittest'
newline|'\n'
name|'import'
name|'email'
newline|'\n'
name|'import'
name|'tempfile'
newline|'\n'
name|'import'
name|'uuid'
newline|'\n'
name|'import'
name|'xattr'
newline|'\n'
name|'from'
name|'shutil'
name|'import'
name|'rmtree'
newline|'\n'
name|'from'
name|'time'
name|'import'
name|'time'
newline|'\n'
name|'from'
name|'tempfile'
name|'import'
name|'mkdtemp'
newline|'\n'
name|'from'
name|'hashlib'
name|'import'
name|'md5'
newline|'\n'
name|'from'
name|'contextlib'
name|'import'
name|'closing'
op|','
name|'nested'
newline|'\n'
name|'from'
name|'gzip'
name|'import'
name|'GzipFile'
newline|'\n'
nl|'\n'
name|'from'
name|'eventlet'
name|'import'
name|'tpool'
newline|'\n'
name|'from'
name|'test'
op|'.'
name|'unit'
name|'import'
op|'('
name|'FakeLogger'
op|','
name|'mock'
name|'as'
name|'unit_mock'
op|','
name|'temptree'
op|','
nl|'\n'
name|'patch_policies'
op|','
name|'debug_logger'
op|')'
newline|'\n'
nl|'\n'
name|'from'
name|'swift'
op|'.'
name|'obj'
name|'import'
name|'diskfile'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'utils'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'hash_path'
op|','
name|'mkdirs'
op|','
name|'normalize_timestamp'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'ring'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'exceptions'
name|'import'
name|'DiskFileNotExist'
op|','
name|'DiskFileQuarantined'
op|','
name|'DiskFileDeviceUnavailable'
op|','
name|'DiskFileDeleted'
op|','
name|'DiskFileNotOpen'
op|','
name|'DiskFileError'
op|','
name|'ReplicationLockTimeout'
op|','
name|'PathNotDir'
op|','
name|'DiskFileCollision'
op|','
name|'DiskFileExpired'
op|','
name|'SwiftException'
op|','
name|'DiskFileNoSpace'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'storage_policy'
name|'import'
name|'POLICIES'
op|','
name|'get_policy_string'
newline|'\n'
name|'from'
name|'functools'
name|'import'
name|'partial'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|get_data_dir
name|'get_data_dir'
op|'='
name|'partial'
op|'('
name|'get_policy_string'
op|','
name|'diskfile'
op|'.'
name|'DATADIR_BASE'
op|')'
newline|'\n'
DECL|variable|get_tmp_dir
name|'get_tmp_dir'
op|'='
name|'partial'
op|'('
name|'get_policy_string'
op|','
name|'diskfile'
op|'.'
name|'TMP_BASE'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|_create_test_ring
name|'def'
name|'_create_test_ring'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'testgz'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'path'
op|','
string|"'object.ring.gz'"
op|')'
newline|'\n'
name|'intended_replica2part2dev_id'
op|'='
op|'['
nl|'\n'
op|'['
number|'0'
op|','
number|'1'
op|','
number|'2'
op|','
number|'3'
op|','
number|'4'
op|','
number|'5'
op|','
number|'6'
op|']'
op|','
nl|'\n'
op|'['
number|'1'
op|','
number|'2'
op|','
number|'3'
op|','
number|'0'
op|','
number|'5'
op|','
number|'6'
op|','
number|'4'
op|']'
op|','
nl|'\n'
op|'['
number|'2'
op|','
number|'3'
op|','
number|'0'
op|','
number|'1'
op|','
number|'6'
op|','
number|'4'
op|','
number|'5'
op|']'
op|']'
newline|'\n'
name|'intended_devs'
op|'='
op|'['
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'0'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'zone'"
op|':'
number|'0'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.0'"
op|','
string|"'port'"
op|':'
number|'6000'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'zone'"
op|':'
number|'1'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.1'"
op|','
string|"'port'"
op|':'
number|'6000'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'2'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'zone'"
op|':'
number|'2'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.2'"
op|','
string|"'port'"
op|':'
number|'6000'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'zone'"
op|':'
number|'4'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.3'"
op|','
string|"'port'"
op|':'
number|'6000'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'4'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'zone'"
op|':'
number|'5'
op|','
string|"'ip'"
op|':'
string|"'127.0.0.4'"
op|','
string|"'port'"
op|':'
number|'6000'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'5'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'zone'"
op|':'
number|'6'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'fe80::202:b3ff:fe1e:8329'"
op|','
string|"'port'"
op|':'
number|'6000'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'6'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|','
string|"'zone'"
op|':'
number|'7'
op|','
nl|'\n'
string|"'ip'"
op|':'
string|"'2001:0db8:85a3:0000:0000:8a2e:0370:7334'"
op|','
string|"'port'"
op|':'
number|'6000'
op|'}'
op|']'
newline|'\n'
name|'intended_part_shift'
op|'='
number|'30'
newline|'\n'
name|'intended_reload_time'
op|'='
number|'15'
newline|'\n'
name|'with'
name|'closing'
op|'('
name|'GzipFile'
op|'('
name|'testgz'
op|','
string|"'wb'"
op|')'
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'        '
name|'pickle'
op|'.'
name|'dump'
op|'('
nl|'\n'
name|'ring'
op|'.'
name|'RingData'
op|'('
name|'intended_replica2part2dev_id'
op|','
name|'intended_devs'
op|','
nl|'\n'
name|'intended_part_shift'
op|')'
op|','
nl|'\n'
name|'f'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'ring'
op|'.'
name|'Ring'
op|'('
name|'path'
op|','
name|'ring_name'
op|'='
string|"'object'"
op|','
nl|'\n'
name|'reload_time'
op|'='
name|'intended_reload_time'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
op|'@'
name|'patch_policies'
newline|'\n'
DECL|class|TestDiskFileModuleMethods
name|'class'
name|'TestDiskFileModuleMethods'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'utils'
op|'.'
name|'HASH_PATH_SUFFIX'
op|'='
string|"'endcap'"
newline|'\n'
name|'utils'
op|'.'
name|'HASH_PATH_PREFIX'
op|'='
string|"''"
newline|'\n'
comment|'# Setup a test ring (stolen from common/test_ring.py)'
nl|'\n'
name|'self'
op|'.'
name|'testdir'
op|'='
name|'tempfile'
op|'.'
name|'mkdtemp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'devices'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
string|"'node'"
op|')'
newline|'\n'
name|'rmtree'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'ignore_errors'
op|'='
number|'1'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'mkdir'
op|'('
name|'self'
op|'.'
name|'testdir'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'mkdir'
op|'('
name|'self'
op|'.'
name|'devices'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'existing_device'
op|'='
string|"'sda'"
newline|'\n'
name|'os'
op|'.'
name|'mkdir'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'devices'
op|','
name|'self'
op|'.'
name|'existing_device'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'objects'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'devices'
op|','
name|'self'
op|'.'
name|'existing_device'
op|','
nl|'\n'
string|"'objects'"
op|')'
newline|'\n'
name|'os'
op|'.'
name|'mkdir'
op|'('
name|'self'
op|'.'
name|'objects'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'parts'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'part'
name|'in'
op|'['
string|"'0'"
op|','
string|"'1'"
op|','
string|"'2'"
op|','
string|"'3'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'parts'
op|'['
name|'part'
op|']'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
name|'part'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'mkdir'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
name|'part'
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'ring'
op|'='
name|'_create_test_ring'
op|'('
name|'self'
op|'.'
name|'testdir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'conf'
op|'='
name|'dict'
op|'('
nl|'\n'
name|'swift_dir'
op|'='
name|'self'
op|'.'
name|'testdir'
op|','
name|'devices'
op|'='
name|'self'
op|'.'
name|'devices'
op|','
name|'mount_check'
op|'='
string|"'false'"
op|','
nl|'\n'
name|'timeout'
op|'='
string|"'300'"
op|','
name|'stats_interval'
op|'='
string|"'1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'='
name|'diskfile'
op|'.'
name|'DiskFileManager'
op|'('
name|'self'
op|'.'
name|'conf'
op|','
name|'FakeLogger'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|tearDown
dedent|''
name|'def'
name|'tearDown'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rmtree'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'ignore_errors'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_create_diskfile
dedent|''
name|'def'
name|'_create_diskfile'
op|'('
name|'self'
op|','
name|'policy_idx'
op|'='
number|'0'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile'
op|'('
name|'self'
op|'.'
name|'existing_device'
op|','
nl|'\n'
string|"'0'"
op|','
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|','
nl|'\n'
name|'policy_idx'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_extract_policy_index
dedent|''
name|'def'
name|'test_extract_policy_index'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# good path names'
nl|'\n'
indent|'        '
name|'pn'
op|'='
string|"'objects/0/606/1984527ed7ef6247c78606/1401379842.14643.data'"
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'diskfile'
op|'.'
name|'extract_policy_index'
op|'('
name|'pn'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
name|'pn'
op|'='
string|"'objects-1/0/606/198452b6ef6247c78606/1401379842.14643.data'"
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'diskfile'
op|'.'
name|'extract_policy_index'
op|'('
name|'pn'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'good_path'
op|'='
string|"'/srv/node/sda1/objects-1/1/abc/def/1234.data'"
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
number|'1'
op|','
name|'diskfile'
op|'.'
name|'extract_policy_index'
op|'('
name|'good_path'
op|')'
op|')'
newline|'\n'
name|'good_path'
op|'='
string|"'/srv/node/sda1/objects/1/abc/def/1234.data'"
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
number|'0'
op|','
name|'diskfile'
op|'.'
name|'extract_policy_index'
op|'('
name|'good_path'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# short paths still ok'
nl|'\n'
name|'path'
op|'='
string|"'/srv/node/sda1/objects/1/1234.data'"
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'diskfile'
op|'.'
name|'extract_policy_index'
op|'('
name|'path'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
name|'path'
op|'='
string|"'/srv/node/sda1/objects-1/1/1234.data'"
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'diskfile'
op|'.'
name|'extract_policy_index'
op|'('
name|'path'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
comment|'# leading slash, just in case'
nl|'\n'
name|'pn'
op|'='
string|"'/objects/0/606/1984527ed7ef6247c78606/1401379842.14643.data'"
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'diskfile'
op|'.'
name|'extract_policy_index'
op|'('
name|'pn'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
name|'pn'
op|'='
string|"'/objects-1/0/606/198452b6ef6247c78606/1401379842.14643.data'"
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'diskfile'
op|'.'
name|'extract_policy_index'
op|'('
name|'pn'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
comment|'# bad policy index'
nl|'\n'
name|'pn'
op|'='
string|"'objects-2/0/606/198427efcff042c78606/1401379842.14643.data'"
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'diskfile'
op|'.'
name|'extract_policy_index'
op|'('
name|'pn'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
name|'bad_path'
op|'='
string|"'/srv/node/sda1/objects-t/1/abc/def/1234.data'"
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
nl|'\n'
name|'diskfile'
op|'.'
name|'extract_policy_index'
op|','
name|'bad_path'
op|')'
newline|'\n'
nl|'\n'
comment|'# malformed path (no objects dir or nothing at all)'
nl|'\n'
name|'pn'
op|'='
string|"'XXXX/0/606/1984527ed42b6ef6247c78606/1401379842.14643.data'"
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'diskfile'
op|'.'
name|'extract_policy_index'
op|'('
name|'pn'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'diskfile'
op|'.'
name|'extract_policy_index'
op|'('
string|"''"
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# no datadir base in path'
nl|'\n'
name|'bad_path'
op|'='
string|"'/srv/node/sda1/foo-1/1/abc/def/1234.data'"
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'diskfile'
op|'.'
name|'extract_policy_index'
op|'('
name|'bad_path'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
name|'bad_path'
op|'='
string|"'/srv/node/sda1/obj1/1/abc/def/1234.data'"
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'diskfile'
op|'.'
name|'extract_policy_index'
op|'('
name|'bad_path'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quarantine_renamer
dedent|''
name|'def'
name|'test_quarantine_renamer'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'policy'
name|'in'
name|'POLICIES'
op|':'
newline|'\n'
comment|'# we use this for convenience, not really about a diskfile layout'
nl|'\n'
indent|'            '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_diskfile'
op|'('
name|'policy_idx'
op|'='
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'exp_dir'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'devices'
op|','
string|"'quarantined'"
op|','
nl|'\n'
name|'get_data_dir'
op|'('
name|'policy'
op|'.'
name|'idx'
op|')'
op|','
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'basename'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
op|')'
newline|'\n'
name|'qbit'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|','
string|"'qbit'"
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
name|'qbit'
op|','
string|"'w'"
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'                '
name|'f'
op|'.'
name|'write'
op|'('
string|"'abc'"
op|')'
newline|'\n'
dedent|''
name|'to_dir'
op|'='
name|'diskfile'
op|'.'
name|'quarantine_renamer'
op|'('
name|'self'
op|'.'
name|'devices'
op|','
name|'qbit'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'to_dir'
op|','
name|'exp_dir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'OSError'
op|','
name|'diskfile'
op|'.'
name|'quarantine_renamer'
op|','
nl|'\n'
name|'self'
op|'.'
name|'devices'
op|','
name|'qbit'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_suffix_enoent
dedent|''
dedent|''
name|'def'
name|'test_hash_suffix_enoent'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'PathNotDir'
op|','
name|'diskfile'
op|'.'
name|'hash_suffix'
op|','
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
string|'"doesnotexist"'
op|')'
op|','
number|'101'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_suffix_oserror
dedent|''
name|'def'
name|'test_hash_suffix_oserror'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mocked_os_listdir'
op|'='
name|'mock'
op|'.'
name|'Mock'
op|'('
nl|'\n'
name|'side_effect'
op|'='
name|'OSError'
op|'('
name|'errno'
op|'.'
name|'EACCES'
op|','
name|'os'
op|'.'
name|'strerror'
op|'('
name|'errno'
op|'.'
name|'EACCES'
op|')'
op|')'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|'"os.listdir"'
op|','
name|'mocked_os_listdir'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'OSError'
op|','
name|'diskfile'
op|'.'
name|'hash_suffix'
op|','
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
string|'"doesnotexist"'
op|')'
op|','
number|'101'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_data_dir
dedent|''
dedent|''
name|'def'
name|'test_get_data_dir'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'diskfile'
op|'.'
name|'get_data_dir'
op|'('
number|'0'
op|')'
op|','
name|'diskfile'
op|'.'
name|'DATADIR_BASE'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'diskfile'
op|'.'
name|'get_data_dir'
op|'('
number|'1'
op|')'
op|','
nl|'\n'
name|'diskfile'
op|'.'
name|'DATADIR_BASE'
op|'+'
string|'"-1"'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'diskfile'
op|'.'
name|'get_data_dir'
op|','
string|"'junk'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'diskfile'
op|'.'
name|'get_data_dir'
op|','
number|'99'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_async_dir
dedent|''
name|'def'
name|'test_get_async_dir'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'diskfile'
op|'.'
name|'get_async_dir'
op|'('
number|'0'
op|')'
op|','
nl|'\n'
name|'diskfile'
op|'.'
name|'ASYNCDIR_BASE'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'diskfile'
op|'.'
name|'get_async_dir'
op|'('
number|'1'
op|')'
op|','
nl|'\n'
name|'diskfile'
op|'.'
name|'ASYNCDIR_BASE'
op|'+'
string|'"-1"'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'diskfile'
op|'.'
name|'get_async_dir'
op|','
string|"'junk'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'diskfile'
op|'.'
name|'get_async_dir'
op|','
number|'99'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_tmp_dir
dedent|''
name|'def'
name|'test_get_tmp_dir'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'diskfile'
op|'.'
name|'get_tmp_dir'
op|'('
number|'0'
op|')'
op|','
nl|'\n'
name|'diskfile'
op|'.'
name|'TMP_BASE'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'diskfile'
op|'.'
name|'get_tmp_dir'
op|'('
number|'1'
op|')'
op|','
nl|'\n'
name|'diskfile'
op|'.'
name|'TMP_BASE'
op|'+'
string|'"-1"'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'diskfile'
op|'.'
name|'get_tmp_dir'
op|','
string|"'junk'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'ValueError'
op|','
name|'diskfile'
op|'.'
name|'get_tmp_dir'
op|','
number|'99'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_pickle_async_update_tmp_dir
dedent|''
name|'def'
name|'test_pickle_async_update_tmp_dir'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'policy'
name|'in'
name|'POLICIES'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'int'
op|'('
name|'policy'
op|')'
op|'=='
number|'0'
op|':'
newline|'\n'
indent|'                '
name|'tmp_part'
op|'='
string|"'tmp'"
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'tmp_part'
op|'='
string|"'tmp-%d'"
op|'%'
name|'policy'
newline|'\n'
dedent|''
name|'tmp_path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'devices'
op|','
name|'self'
op|'.'
name|'existing_device'
op|','
name|'tmp_part'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'isdir'
op|'('
name|'tmp_path'
op|')'
op|')'
newline|'\n'
name|'pickle_args'
op|'='
op|'('
name|'self'
op|'.'
name|'existing_device'
op|','
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|','
nl|'\n'
string|"'data'"
op|','
number|'0.0'
op|','
name|'int'
op|'('
name|'policy'
op|')'
op|')'
newline|'\n'
comment|"# async updates don't create their tmpdir on their own"
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'OSError'
op|','
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'pickle_async_update'
op|','
nl|'\n'
op|'*'
name|'pickle_args'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'tmp_path'
op|')'
newline|'\n'
comment|'# now create a async update'
nl|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'pickle_async_update'
op|'('
op|'*'
name|'pickle_args'
op|')'
newline|'\n'
comment|'# check tempdir'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'isdir'
op|'('
name|'tmp_path'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_suffix_hash_dir_is_file_quarantine
dedent|''
dedent|''
name|'def'
name|'test_hash_suffix_hash_dir_is_file_quarantine'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_diskfile'
op|'('
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'dirname'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
op|')'
newline|'\n'
name|'open'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|','
string|"'wb'"
op|')'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'ohash'
op|'='
name|'hash_path'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|')'
newline|'\n'
name|'data_dir'
op|'='
name|'ohash'
op|'['
op|'-'
number|'3'
op|':'
op|']'
newline|'\n'
name|'whole_path_from'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|','
name|'data_dir'
op|')'
newline|'\n'
name|'orig_quarantine_renamer'
op|'='
name|'diskfile'
op|'.'
name|'quarantine_renamer'
newline|'\n'
name|'called'
op|'='
op|'['
name|'False'
op|']'
newline|'\n'
nl|'\n'
DECL|function|wrapped
name|'def'
name|'wrapped'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
number|'0'
op|']'
op|'='
name|'True'
newline|'\n'
name|'return'
name|'orig_quarantine_renamer'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'diskfile'
op|'.'
name|'quarantine_renamer'
op|'='
name|'wrapped'
newline|'\n'
name|'diskfile'
op|'.'
name|'hash_suffix'
op|'('
name|'whole_path_from'
op|','
number|'101'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'diskfile'
op|'.'
name|'quarantine_renamer'
op|'='
name|'orig_quarantine_renamer'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'['
number|'0'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_suffix_one_file
dedent|''
name|'def'
name|'test_hash_suffix_one_file'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_diskfile'
op|'('
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'f'
op|'='
name|'open'
op|'('
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|','
nl|'\n'
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'-'
number|'100'
op|')'
op|'+'
string|"'.ts'"
op|')'
op|','
nl|'\n'
string|"'wb'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'write'
op|'('
string|"'1234567890'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'ohash'
op|'='
name|'hash_path'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|')'
newline|'\n'
name|'data_dir'
op|'='
name|'ohash'
op|'['
op|'-'
number|'3'
op|':'
op|']'
newline|'\n'
name|'whole_path_from'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|','
name|'data_dir'
op|')'
newline|'\n'
name|'diskfile'
op|'.'
name|'hash_suffix'
op|'('
name|'whole_path_from'
op|','
number|'101'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'os'
op|'.'
name|'listdir'
op|'('
name|'self'
op|'.'
name|'parts'
op|'['
string|"'0'"
op|']'
op|')'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'diskfile'
op|'.'
name|'hash_suffix'
op|'('
name|'whole_path_from'
op|','
number|'99'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'os'
op|'.'
name|'listdir'
op|'('
name|'self'
op|'.'
name|'parts'
op|'['
string|"'0'"
op|']'
op|')'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_suffix_oserror_on_hcl
dedent|''
name|'def'
name|'test_hash_suffix_oserror_on_hcl'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_diskfile'
op|'('
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'f'
op|'='
name|'open'
op|'('
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|','
nl|'\n'
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'-'
number|'100'
op|')'
op|'+'
string|"'.ts'"
op|')'
op|','
nl|'\n'
string|"'wb'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'write'
op|'('
string|"'1234567890'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'ohash'
op|'='
name|'hash_path'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|')'
newline|'\n'
name|'data_dir'
op|'='
name|'ohash'
op|'['
op|'-'
number|'3'
op|':'
op|']'
newline|'\n'
name|'whole_path_from'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|','
name|'data_dir'
op|')'
newline|'\n'
name|'state'
op|'='
op|'['
number|'0'
op|']'
newline|'\n'
name|'orig_os_listdir'
op|'='
name|'os'
op|'.'
name|'listdir'
newline|'\n'
nl|'\n'
DECL|function|mock_os_listdir
name|'def'
name|'mock_os_listdir'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
comment|'# We want the first call to os.listdir() to succeed, which is the'
nl|'\n'
comment|'# one directly from hash_suffix() itself, but then we want to fail'
nl|'\n'
comment|'# the next call to os.listdir() which is from'
nl|'\n'
comment|'# hash_cleanup_listdir()'
nl|'\n'
indent|'            '
name|'if'
name|'state'
op|'['
number|'0'
op|']'
op|'=='
number|'1'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'OSError'
op|'('
name|'errno'
op|'.'
name|'EACCES'
op|','
name|'os'
op|'.'
name|'strerror'
op|'('
name|'errno'
op|'.'
name|'EACCES'
op|')'
op|')'
newline|'\n'
dedent|''
name|'state'
op|'['
number|'0'
op|']'
op|'='
number|'1'
newline|'\n'
name|'return'
name|'orig_os_listdir'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.listdir'"
op|','
name|'mock_os_listdir'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'OSError'
op|','
name|'diskfile'
op|'.'
name|'hash_suffix'
op|','
name|'whole_path_from'
op|','
nl|'\n'
number|'101'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_suffix_multi_file_one
dedent|''
dedent|''
name|'def'
name|'test_hash_suffix_multi_file_one'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_diskfile'
op|'('
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'for'
name|'tdiff'
name|'in'
op|'['
number|'1'
op|','
number|'50'
op|','
number|'100'
op|','
number|'500'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'suff'
name|'in'
op|'['
string|"'.meta'"
op|','
string|"'.data'"
op|','
string|"'.ts'"
op|']'
op|':'
newline|'\n'
indent|'                '
name|'f'
op|'='
name|'open'
op|'('
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
nl|'\n'
name|'df'
op|'.'
name|'_datadir'
op|','
nl|'\n'
name|'normalize_timestamp'
op|'('
name|'int'
op|'('
name|'time'
op|'('
op|')'
op|')'
op|'-'
name|'tdiff'
op|')'
op|'+'
name|'suff'
op|')'
op|','
nl|'\n'
string|"'wb'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'write'
op|'('
string|"'1234567890'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'ohash'
op|'='
name|'hash_path'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|')'
newline|'\n'
name|'data_dir'
op|'='
name|'ohash'
op|'['
op|'-'
number|'3'
op|':'
op|']'
newline|'\n'
name|'whole_path_from'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|','
name|'data_dir'
op|')'
newline|'\n'
name|'hsh_path'
op|'='
name|'os'
op|'.'
name|'listdir'
op|'('
name|'whole_path_from'
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'whole_hsh_path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'whole_path_from'
op|','
name|'hsh_path'
op|')'
newline|'\n'
nl|'\n'
name|'diskfile'
op|'.'
name|'hash_suffix'
op|'('
name|'whole_path_from'
op|','
number|'99'
op|')'
newline|'\n'
comment|'# only the tombstone should be left'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'os'
op|'.'
name|'listdir'
op|'('
name|'whole_hsh_path'
op|')'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_suffix_multi_file_two
dedent|''
name|'def'
name|'test_hash_suffix_multi_file_two'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_diskfile'
op|'('
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'for'
name|'tdiff'
name|'in'
op|'['
number|'1'
op|','
number|'50'
op|','
number|'100'
op|','
number|'500'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'suffs'
op|'='
op|'['
string|"'.meta'"
op|','
string|"'.data'"
op|']'
newline|'\n'
name|'if'
name|'tdiff'
op|'>'
number|'50'
op|':'
newline|'\n'
indent|'                '
name|'suffs'
op|'.'
name|'append'
op|'('
string|"'.ts'"
op|')'
newline|'\n'
dedent|''
name|'for'
name|'suff'
name|'in'
name|'suffs'
op|':'
newline|'\n'
indent|'                '
name|'f'
op|'='
name|'open'
op|'('
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
nl|'\n'
name|'df'
op|'.'
name|'_datadir'
op|','
nl|'\n'
name|'normalize_timestamp'
op|'('
name|'int'
op|'('
name|'time'
op|'('
op|')'
op|')'
op|'-'
name|'tdiff'
op|')'
op|'+'
name|'suff'
op|')'
op|','
nl|'\n'
string|"'wb'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'write'
op|'('
string|"'1234567890'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'ohash'
op|'='
name|'hash_path'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|')'
newline|'\n'
name|'data_dir'
op|'='
name|'ohash'
op|'['
op|'-'
number|'3'
op|':'
op|']'
newline|'\n'
name|'whole_path_from'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|','
name|'data_dir'
op|')'
newline|'\n'
name|'hsh_path'
op|'='
name|'os'
op|'.'
name|'listdir'
op|'('
name|'whole_path_from'
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'whole_hsh_path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'whole_path_from'
op|','
name|'hsh_path'
op|')'
newline|'\n'
nl|'\n'
name|'diskfile'
op|'.'
name|'hash_suffix'
op|'('
name|'whole_path_from'
op|','
number|'99'
op|')'
newline|'\n'
comment|'# only the meta and data should be left'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'os'
op|'.'
name|'listdir'
op|'('
name|'whole_hsh_path'
op|')'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_suffix_hsh_path_disappearance
dedent|''
name|'def'
name|'test_hash_suffix_hsh_path_disappearance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'orig_rmdir'
op|'='
name|'os'
op|'.'
name|'rmdir'
newline|'\n'
nl|'\n'
DECL|function|_rmdir
name|'def'
name|'_rmdir'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
comment|"# Done twice to recreate what happens when it doesn't exist."
nl|'\n'
indent|'            '
name|'orig_rmdir'
op|'('
name|'path'
op|')'
newline|'\n'
name|'orig_rmdir'
op|'('
name|'path'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'df'
op|'='
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile'
op|'('
string|"'sda'"
op|','
string|"'0'"
op|','
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'ohash'
op|'='
name|'hash_path'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|')'
newline|'\n'
name|'suffix'
op|'='
name|'ohash'
op|'['
op|'-'
number|'3'
op|':'
op|']'
newline|'\n'
name|'suffix_path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|','
name|'suffix'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.rmdir'"
op|','
name|'_rmdir'
op|')'
op|':'
newline|'\n'
comment|"# If hash_suffix doesn't handle the exception _rmdir will raise,"
nl|'\n'
comment|'# this test will fail.'
nl|'\n'
indent|'            '
name|'diskfile'
op|'.'
name|'hash_suffix'
op|'('
name|'suffix_path'
op|','
number|'123'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_invalidate_hash
dedent|''
dedent|''
name|'def'
name|'test_invalidate_hash'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|function|assertFileData
indent|'        '
name|'def'
name|'assertFileData'
op|'('
name|'file_path'
op|','
name|'data'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'open'
op|'('
name|'file_path'
op|','
string|"'r'"
op|')'
name|'as'
name|'fp'
op|':'
newline|'\n'
indent|'                '
name|'fdata'
op|'='
name|'fp'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'pickle'
op|'.'
name|'loads'
op|'('
name|'fdata'
op|')'
op|','
name|'pickle'
op|'.'
name|'loads'
op|'('
name|'data'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_diskfile'
op|'('
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'ohash'
op|'='
name|'hash_path'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|')'
newline|'\n'
name|'data_dir'
op|'='
name|'ohash'
op|'['
op|'-'
number|'3'
op|':'
op|']'
newline|'\n'
name|'whole_path_from'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|','
name|'data_dir'
op|')'
newline|'\n'
name|'hashes_file'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|','
nl|'\n'
name|'diskfile'
op|'.'
name|'HASH_FILE'
op|')'
newline|'\n'
comment|'# test that non existent file except caught'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'diskfile'
op|'.'
name|'invalidate_hash'
op|'('
name|'whole_path_from'
op|')'
op|','
nl|'\n'
name|'None'
op|')'
newline|'\n'
comment|'# test that hashes get cleared'
nl|'\n'
name|'check_pickle_data'
op|'='
name|'pickle'
op|'.'
name|'dumps'
op|'('
op|'{'
name|'data_dir'
op|':'
name|'None'
op|'}'
op|','
nl|'\n'
name|'diskfile'
op|'.'
name|'PICKLE_PROTOCOL'
op|')'
newline|'\n'
name|'for'
name|'data_hash'
name|'in'
op|'['
op|'{'
name|'data_dir'
op|':'
name|'None'
op|'}'
op|','
op|'{'
name|'data_dir'
op|':'
string|"'abcdefg'"
op|'}'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'open'
op|'('
name|'hashes_file'
op|','
string|"'wb'"
op|')'
name|'as'
name|'fp'
op|':'
newline|'\n'
indent|'                '
name|'pickle'
op|'.'
name|'dump'
op|'('
name|'data_hash'
op|','
name|'fp'
op|','
name|'diskfile'
op|'.'
name|'PICKLE_PROTOCOL'
op|')'
newline|'\n'
dedent|''
name|'diskfile'
op|'.'
name|'invalidate_hash'
op|'('
name|'whole_path_from'
op|')'
newline|'\n'
name|'assertFileData'
op|'('
name|'hashes_file'
op|','
name|'check_pickle_data'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_invalidate_hash_bad_pickle
dedent|''
dedent|''
name|'def'
name|'test_invalidate_hash_bad_pickle'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_diskfile'
op|'('
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'ohash'
op|'='
name|'hash_path'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|')'
newline|'\n'
name|'data_dir'
op|'='
name|'ohash'
op|'['
op|'-'
number|'3'
op|':'
op|']'
newline|'\n'
name|'whole_path_from'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|','
name|'data_dir'
op|')'
newline|'\n'
name|'hashes_file'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|','
nl|'\n'
name|'diskfile'
op|'.'
name|'HASH_FILE'
op|')'
newline|'\n'
name|'for'
name|'data_hash'
name|'in'
op|'['
op|'{'
name|'data_dir'
op|':'
name|'None'
op|'}'
op|','
op|'{'
name|'data_dir'
op|':'
string|"'abcdefg'"
op|'}'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'open'
op|'('
name|'hashes_file'
op|','
string|"'wb'"
op|')'
name|'as'
name|'fp'
op|':'
newline|'\n'
indent|'                '
name|'fp'
op|'.'
name|'write'
op|'('
string|"'bad hash data'"
op|')'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'diskfile'
op|'.'
name|'invalidate_hash'
op|'('
name|'whole_path_from'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'fail'
op|'('
string|'"Unexpected exception raised: %s"'
op|'%'
name|'err'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'pass'
newline|'\n'
nl|'\n'
DECL|member|test_get_hashes
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_get_hashes'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_diskfile'
op|'('
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|','
nl|'\n'
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|')'
op|'+'
string|"'.ts'"
op|')'
op|','
nl|'\n'
string|"'wb'"
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'            '
name|'f'
op|'.'
name|'write'
op|'('
string|"'1234567890'"
op|')'
newline|'\n'
dedent|''
name|'part'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|')'
newline|'\n'
name|'hashed'
op|','
name|'hashes'
op|'='
name|'diskfile'
op|'.'
name|'get_hashes'
op|'('
name|'part'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'hashed'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assert_'
op|'('
string|"'a83'"
name|'in'
name|'hashes'
op|')'
newline|'\n'
name|'hashed'
op|','
name|'hashes'
op|'='
name|'diskfile'
op|'.'
name|'get_hashes'
op|'('
name|'part'
op|','
name|'do_listdir'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'hashed'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assert_'
op|'('
string|"'a83'"
name|'in'
name|'hashes'
op|')'
newline|'\n'
name|'hashed'
op|','
name|'hashes'
op|'='
name|'diskfile'
op|'.'
name|'get_hashes'
op|'('
name|'part'
op|','
name|'recalculate'
op|'='
op|'['
string|"'a83'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'hashed'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assert_'
op|'('
string|"'a83'"
name|'in'
name|'hashes'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_hashes_bad_dir
dedent|''
name|'def'
name|'test_get_hashes_bad_dir'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_diskfile'
op|'('
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|','
string|"'bad'"
op|')'
op|','
string|"'wb'"
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'            '
name|'f'
op|'.'
name|'write'
op|'('
string|"'1234567890'"
op|')'
newline|'\n'
dedent|''
name|'part'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|')'
newline|'\n'
name|'hashed'
op|','
name|'hashes'
op|'='
name|'diskfile'
op|'.'
name|'get_hashes'
op|'('
name|'part'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'hashed'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assert_'
op|'('
string|"'a83'"
name|'in'
name|'hashes'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assert_'
op|'('
string|"'bad'"
name|'not'
name|'in'
name|'hashes'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_hashes_unmodified
dedent|''
name|'def'
name|'test_get_hashes_unmodified'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_diskfile'
op|'('
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|','
nl|'\n'
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|')'
op|'+'
string|"'.ts'"
op|')'
op|','
nl|'\n'
string|"'wb'"
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'            '
name|'f'
op|'.'
name|'write'
op|'('
string|"'1234567890'"
op|')'
newline|'\n'
dedent|''
name|'part'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|')'
newline|'\n'
name|'hashed'
op|','
name|'hashes'
op|'='
name|'diskfile'
op|'.'
name|'get_hashes'
op|'('
name|'part'
op|')'
newline|'\n'
name|'i'
op|'='
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
DECL|function|_getmtime
name|'def'
name|'_getmtime'
op|'('
name|'filename'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'i'
op|'['
number|'0'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'return'
number|'1'
newline|'\n'
dedent|''
name|'with'
name|'unit_mock'
op|'('
op|'{'
string|"'swift.obj.diskfile.getmtime'"
op|':'
name|'_getmtime'
op|'}'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'hashed'
op|','
name|'hashes'
op|'='
name|'diskfile'
op|'.'
name|'get_hashes'
op|'('
nl|'\n'
name|'part'
op|','
name|'recalculate'
op|'='
op|'['
string|"'a83'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'i'
op|'['
number|'0'
op|']'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_hashes_unmodified_norecalc
dedent|''
name|'def'
name|'test_get_hashes_unmodified_norecalc'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_diskfile'
op|'('
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|','
nl|'\n'
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|')'
op|'+'
string|"'.ts'"
op|')'
op|','
nl|'\n'
string|"'wb'"
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'            '
name|'f'
op|'.'
name|'write'
op|'('
string|"'1234567890'"
op|')'
newline|'\n'
dedent|''
name|'part'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|')'
newline|'\n'
name|'hashed'
op|','
name|'hashes_0'
op|'='
name|'diskfile'
op|'.'
name|'get_hashes'
op|'('
name|'part'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'hashed'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'a83'"
name|'in'
name|'hashes_0'
op|')'
newline|'\n'
name|'hashed'
op|','
name|'hashes_1'
op|'='
name|'diskfile'
op|'.'
name|'get_hashes'
op|'('
name|'part'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'hashed'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'a83'"
name|'in'
name|'hashes_0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'hashes_1'
op|','
name|'hashes_0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_hashes_hash_suffix_error
dedent|''
name|'def'
name|'test_get_hashes_hash_suffix_error'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_diskfile'
op|'('
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|','
nl|'\n'
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|')'
op|'+'
string|"'.ts'"
op|')'
op|','
nl|'\n'
string|"'wb'"
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'            '
name|'f'
op|'.'
name|'write'
op|'('
string|"'1234567890'"
op|')'
newline|'\n'
dedent|''
name|'part'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|')'
newline|'\n'
name|'mocked_hash_suffix'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
nl|'\n'
name|'side_effect'
op|'='
name|'OSError'
op|'('
name|'errno'
op|'.'
name|'EACCES'
op|','
name|'os'
op|'.'
name|'strerror'
op|'('
name|'errno'
op|'.'
name|'EACCES'
op|')'
op|')'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.hash_suffix'"
op|','
name|'mocked_hash_suffix'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'hashed'
op|','
name|'hashes'
op|'='
name|'diskfile'
op|'.'
name|'get_hashes'
op|'('
name|'part'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'hashed'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'hashes'
op|','
op|'{'
string|"'a83'"
op|':'
name|'None'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_hashes_unmodified_and_zero_bytes
dedent|''
dedent|''
name|'def'
name|'test_get_hashes_unmodified_and_zero_bytes'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_diskfile'
op|'('
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'part'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|')'
newline|'\n'
name|'open'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'part'
op|','
name|'diskfile'
op|'.'
name|'HASH_FILE'
op|')'
op|','
string|"'w'"
op|')'
newline|'\n'
comment|'# Now the hash file is zero bytes.'
nl|'\n'
name|'i'
op|'='
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
DECL|function|_getmtime
name|'def'
name|'_getmtime'
op|'('
name|'filename'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'i'
op|'['
number|'0'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'return'
number|'1'
newline|'\n'
dedent|''
name|'with'
name|'unit_mock'
op|'('
op|'{'
string|"'swift.obj.diskfile.getmtime'"
op|':'
name|'_getmtime'
op|'}'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'hashed'
op|','
name|'hashes'
op|'='
name|'diskfile'
op|'.'
name|'get_hashes'
op|'('
nl|'\n'
name|'part'
op|','
name|'recalculate'
op|'='
op|'['
op|']'
op|')'
newline|'\n'
comment|'# getmtime will actually not get called.  Initially, the pickle.load'
nl|'\n'
comment|'# will raise an exception first and later, force_rewrite will'
nl|'\n'
comment|'# short-circuit the if clause to determine whether to write out a'
nl|'\n'
comment|'# fresh hashes_file.'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'i'
op|'['
number|'0'
op|']'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'a83'"
name|'in'
name|'hashes'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_hashes_modified
dedent|''
name|'def'
name|'test_get_hashes_modified'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_diskfile'
op|'('
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|','
nl|'\n'
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|')'
op|'+'
string|"'.ts'"
op|')'
op|','
nl|'\n'
string|"'wb'"
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'            '
name|'f'
op|'.'
name|'write'
op|'('
string|"'1234567890'"
op|')'
newline|'\n'
dedent|''
name|'part'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'objects'
op|','
string|"'0'"
op|')'
newline|'\n'
name|'hashed'
op|','
name|'hashes'
op|'='
name|'diskfile'
op|'.'
name|'get_hashes'
op|'('
name|'part'
op|')'
newline|'\n'
name|'i'
op|'='
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
DECL|function|_getmtime
name|'def'
name|'_getmtime'
op|'('
name|'filename'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'i'
op|'['
number|'0'
op|']'
op|'<'
number|'3'
op|':'
newline|'\n'
indent|'                '
name|'i'
op|'['
number|'0'
op|']'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'return'
name|'i'
op|'['
number|'0'
op|']'
newline|'\n'
dedent|''
name|'with'
name|'unit_mock'
op|'('
op|'{'
string|"'swift.obj.diskfile.getmtime'"
op|':'
name|'_getmtime'
op|'}'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'hashed'
op|','
name|'hashes'
op|'='
name|'diskfile'
op|'.'
name|'get_hashes'
op|'('
nl|'\n'
name|'part'
op|','
name|'recalculate'
op|'='
op|'['
string|"'a83'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'i'
op|'['
number|'0'
op|']'
op|','
number|'3'
op|')'
newline|'\n'
nl|'\n'
DECL|member|check_hash_cleanup_listdir
dedent|''
name|'def'
name|'check_hash_cleanup_listdir'
op|'('
name|'self'
op|','
name|'input_files'
op|','
name|'output_files'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'orig_unlink'
op|'='
name|'os'
op|'.'
name|'unlink'
newline|'\n'
name|'file_list'
op|'='
name|'list'
op|'('
name|'input_files'
op|')'
newline|'\n'
nl|'\n'
DECL|function|mock_listdir
name|'def'
name|'mock_listdir'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'list'
op|'('
name|'file_list'
op|')'
newline|'\n'
nl|'\n'
DECL|function|mock_unlink
dedent|''
name|'def'
name|'mock_unlink'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
comment|'# timestamp 1 is a special tag to pretend a file disappeared while'
nl|'\n'
comment|'# working.'
nl|'\n'
indent|'            '
name|'if'
string|"'/0000000001.00000.'"
name|'in'
name|'path'
op|':'
newline|'\n'
comment|'# Using actual os.unlink to reproduce exactly what OSError it'
nl|'\n'
comment|'# raises.'
nl|'\n'
indent|'                '
name|'orig_unlink'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|'.'
name|'hex'
op|')'
newline|'\n'
dedent|''
name|'file_list'
op|'.'
name|'remove'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'basename'
op|'('
name|'path'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'with'
name|'unit_mock'
op|'('
op|'{'
string|"'os.listdir'"
op|':'
name|'mock_listdir'
op|','
string|"'os.unlink'"
op|':'
name|'mock_unlink'
op|'}'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'diskfile'
op|'.'
name|'hash_cleanup_listdir'
op|'('
string|"'/whatever'"
op|')'
op|','
nl|'\n'
name|'output_files'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_cleanup_listdir_purge_data_newer_ts
dedent|''
dedent|''
name|'def'
name|'test_hash_cleanup_listdir_purge_data_newer_ts'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|"# purge .data if there's a newer .ts"
nl|'\n'
indent|'        '
name|'file1'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|')'
op|'+'
string|"'.data'"
newline|'\n'
name|'file2'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'+'
number|'1'
op|')'
op|'+'
string|"'.ts'"
newline|'\n'
name|'file_list'
op|'='
op|'['
name|'file1'
op|','
name|'file2'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'check_hash_cleanup_listdir'
op|'('
name|'file_list'
op|','
op|'['
name|'file2'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_cleanup_listdir_purge_ts_newer_data
dedent|''
name|'def'
name|'test_hash_cleanup_listdir_purge_ts_newer_data'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|"# purge .ts if there's a newer .data"
nl|'\n'
indent|'        '
name|'file1'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|')'
op|'+'
string|"'.ts'"
newline|'\n'
name|'file2'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'+'
number|'1'
op|')'
op|'+'
string|"'.data'"
newline|'\n'
name|'file_list'
op|'='
op|'['
name|'file1'
op|','
name|'file2'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'check_hash_cleanup_listdir'
op|'('
name|'file_list'
op|','
op|'['
name|'file2'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_cleanup_listdir_keep_meta_data_purge_ts
dedent|''
name|'def'
name|'test_hash_cleanup_listdir_keep_meta_data_purge_ts'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# keep .meta and .data if meta newer than data and purge .ts'
nl|'\n'
indent|'        '
name|'file1'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|')'
op|'+'
string|"'.ts'"
newline|'\n'
name|'file2'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'+'
number|'1'
op|')'
op|'+'
string|"'.data'"
newline|'\n'
name|'file3'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'+'
number|'2'
op|')'
op|'+'
string|"'.meta'"
newline|'\n'
name|'file_list'
op|'='
op|'['
name|'file1'
op|','
name|'file2'
op|','
name|'file3'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'check_hash_cleanup_listdir'
op|'('
name|'file_list'
op|','
op|'['
name|'file3'
op|','
name|'file2'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_cleanup_listdir_keep_one_ts
dedent|''
name|'def'
name|'test_hash_cleanup_listdir_keep_one_ts'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# keep only latest of multiple .ts files'
nl|'\n'
indent|'        '
name|'file1'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|')'
op|'+'
string|"'.ts'"
newline|'\n'
name|'file2'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'+'
number|'1'
op|')'
op|'+'
string|"'.ts'"
newline|'\n'
name|'file3'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'+'
number|'2'
op|')'
op|'+'
string|"'.ts'"
newline|'\n'
name|'file_list'
op|'='
op|'['
name|'file1'
op|','
name|'file2'
op|','
name|'file3'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'check_hash_cleanup_listdir'
op|'('
name|'file_list'
op|','
op|'['
name|'file3'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_cleanup_listdir_keep_one_data
dedent|''
name|'def'
name|'test_hash_cleanup_listdir_keep_one_data'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# keep only latest of multiple .data files'
nl|'\n'
indent|'        '
name|'file1'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|')'
op|'+'
string|"'.data'"
newline|'\n'
name|'file2'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'+'
number|'1'
op|')'
op|'+'
string|"'.data'"
newline|'\n'
name|'file3'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'+'
number|'2'
op|')'
op|'+'
string|"'.data'"
newline|'\n'
name|'file_list'
op|'='
op|'['
name|'file1'
op|','
name|'file2'
op|','
name|'file3'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'check_hash_cleanup_listdir'
op|'('
name|'file_list'
op|','
op|'['
name|'file3'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_cleanup_listdir_keep_one_meta
dedent|''
name|'def'
name|'test_hash_cleanup_listdir_keep_one_meta'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# keep only latest of multiple .meta files'
nl|'\n'
indent|'        '
name|'file1'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|')'
op|'+'
string|"'.data'"
newline|'\n'
name|'file2'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'+'
number|'1'
op|')'
op|'+'
string|"'.meta'"
newline|'\n'
name|'file3'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'+'
number|'2'
op|')'
op|'+'
string|"'.meta'"
newline|'\n'
name|'file_list'
op|'='
op|'['
name|'file1'
op|','
name|'file2'
op|','
name|'file3'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'check_hash_cleanup_listdir'
op|'('
name|'file_list'
op|','
op|'['
name|'file3'
op|','
name|'file1'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_cleanup_listdir_ignore_orphaned_ts
dedent|''
name|'def'
name|'test_hash_cleanup_listdir_ignore_orphaned_ts'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# A more recent orphaned .meta file will prevent old .ts files'
nl|'\n'
comment|'# from being cleaned up otherwise'
nl|'\n'
indent|'        '
name|'file1'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|')'
op|'+'
string|"'.ts'"
newline|'\n'
name|'file2'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'+'
number|'1'
op|')'
op|'+'
string|"'.ts'"
newline|'\n'
name|'file3'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'+'
number|'2'
op|')'
op|'+'
string|"'.meta'"
newline|'\n'
name|'file_list'
op|'='
op|'['
name|'file1'
op|','
name|'file2'
op|','
name|'file3'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'check_hash_cleanup_listdir'
op|'('
name|'file_list'
op|','
op|'['
name|'file3'
op|','
name|'file2'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_cleanup_listdir_purge_old_data_only
dedent|''
name|'def'
name|'test_hash_cleanup_listdir_purge_old_data_only'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|"# Oldest .data will be purge, .meta and .ts won't be touched"
nl|'\n'
indent|'        '
name|'file1'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|')'
op|'+'
string|"'.data'"
newline|'\n'
name|'file2'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'+'
number|'1'
op|')'
op|'+'
string|"'.ts'"
newline|'\n'
name|'file3'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'+'
number|'2'
op|')'
op|'+'
string|"'.meta'"
newline|'\n'
name|'file_list'
op|'='
op|'['
name|'file1'
op|','
name|'file2'
op|','
name|'file3'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'check_hash_cleanup_listdir'
op|'('
name|'file_list'
op|','
op|'['
name|'file3'
op|','
name|'file2'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_cleanup_listdir_purge_old_ts
dedent|''
name|'def'
name|'test_hash_cleanup_listdir_purge_old_ts'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# A single old .ts file will be removed'
nl|'\n'
indent|'        '
name|'file1'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'-'
op|'('
name|'diskfile'
op|'.'
name|'ONE_WEEK'
op|'+'
number|'1'
op|')'
op|')'
op|'+'
string|"'.ts'"
newline|'\n'
name|'file_list'
op|'='
op|'['
name|'file1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'check_hash_cleanup_listdir'
op|'('
name|'file_list'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_cleanup_listdir_meta_keeps_old_ts
dedent|''
name|'def'
name|'test_hash_cleanup_listdir_meta_keeps_old_ts'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# An orphaned .meta will not clean up a very old .ts'
nl|'\n'
indent|'        '
name|'file1'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'-'
op|'('
name|'diskfile'
op|'.'
name|'ONE_WEEK'
op|'+'
number|'1'
op|')'
op|')'
op|'+'
string|"'.ts'"
newline|'\n'
name|'file2'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'+'
number|'2'
op|')'
op|'+'
string|"'.meta'"
newline|'\n'
name|'file_list'
op|'='
op|'['
name|'file1'
op|','
name|'file2'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'check_hash_cleanup_listdir'
op|'('
name|'file_list'
op|','
op|'['
name|'file2'
op|','
name|'file1'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_cleanup_listdir_keep_single_old_data
dedent|''
name|'def'
name|'test_hash_cleanup_listdir_keep_single_old_data'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# A single old .data file will not be removed'
nl|'\n'
indent|'        '
name|'file1'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'-'
op|'('
name|'diskfile'
op|'.'
name|'ONE_WEEK'
op|'+'
number|'1'
op|')'
op|')'
op|'+'
string|"'.data'"
newline|'\n'
name|'file_list'
op|'='
op|'['
name|'file1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'check_hash_cleanup_listdir'
op|'('
name|'file_list'
op|','
op|'['
name|'file1'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_cleanup_listdir_keep_single_old_meta
dedent|''
name|'def'
name|'test_hash_cleanup_listdir_keep_single_old_meta'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# A single old .meta file will not be removed'
nl|'\n'
indent|'        '
name|'file1'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'-'
op|'('
name|'diskfile'
op|'.'
name|'ONE_WEEK'
op|'+'
number|'1'
op|')'
op|')'
op|'+'
string|"'.meta'"
newline|'\n'
name|'file_list'
op|'='
op|'['
name|'file1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'check_hash_cleanup_listdir'
op|'('
name|'file_list'
op|','
op|'['
name|'file1'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_cleanup_listdir_disappeared_path
dedent|''
name|'def'
name|'test_hash_cleanup_listdir_disappeared_path'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Next line listing a non-existent dir used to propagate the OSError;'
nl|'\n'
comment|'# now should mute that.'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'diskfile'
op|'.'
name|'hash_cleanup_listdir'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|'.'
name|'hex'
op|')'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_cleanup_listdir_disappeared_before_unlink_1
dedent|''
name|'def'
name|'test_hash_cleanup_listdir_disappeared_before_unlink_1'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Timestamp 1 makes other test routines pretend the file disappeared'
nl|'\n'
comment|'# while working.'
nl|'\n'
indent|'        '
name|'file1'
op|'='
string|"'0000000001.00000.ts'"
newline|'\n'
name|'file_list'
op|'='
op|'['
name|'file1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'check_hash_cleanup_listdir'
op|'('
name|'file_list'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hash_cleanup_listdir_disappeared_before_unlink_2
dedent|''
name|'def'
name|'test_hash_cleanup_listdir_disappeared_before_unlink_2'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Timestamp 1 makes other test routines pretend the file disappeared'
nl|'\n'
comment|'# while working.'
nl|'\n'
indent|'        '
name|'file1'
op|'='
string|"'0000000001.00000.data'"
newline|'\n'
name|'file2'
op|'='
string|"'0000000002.00000.ts'"
newline|'\n'
name|'file_list'
op|'='
op|'['
name|'file1'
op|','
name|'file2'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'check_hash_cleanup_listdir'
op|'('
name|'file_list'
op|','
op|'['
name|'file2'
op|']'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'patch_policies'
newline|'\n'
DECL|class|TestObjectAuditLocationGenerator
name|'class'
name|'TestObjectAuditLocationGenerator'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
DECL|member|_make_file
indent|'    '
name|'def'
name|'_make_file'
op|'('
name|'self'
op|','
name|'path'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'dirname'
op|'('
name|'path'
op|')'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'OSError'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'err'
op|'.'
name|'errno'
op|'!='
name|'errno'
op|'.'
name|'EEXIST'
op|':'
newline|'\n'
indent|'                '
name|'raise'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'with'
name|'open'
op|'('
name|'path'
op|','
string|"'w'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
DECL|member|test_audit_location_class
dedent|''
dedent|''
name|'def'
name|'test_audit_location_class'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'al'
op|'='
name|'diskfile'
op|'.'
name|'AuditLocation'
op|'('
string|"'abc'"
op|','
string|"'123'"
op|','
string|"'_-_'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'al'
op|')'
op|','
string|"'abc'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_finding_of_hashdirs
dedent|''
name|'def'
name|'test_finding_of_hashdirs'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'temptree'
op|'('
op|'['
op|']'
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
comment|'# the good'
nl|'\n'
indent|'            '
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdp"'
op|','
string|'"objects"'
op|','
string|'"1519"'
op|','
string|'"aca"'
op|','
nl|'\n'
string|'"5c1fdc1ffb12e5eaf84edc30d8b67aca"'
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdp"'
op|','
string|'"objects"'
op|','
string|'"1519"'
op|','
string|'"aca"'
op|','
nl|'\n'
string|'"fdfd184d39080020bc8b487f8a7beaca"'
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdp"'
op|','
string|'"objects"'
op|','
string|'"1519"'
op|','
string|'"df2"'
op|','
nl|'\n'
string|'"b0fe7af831cc7b1af5bf486b1c841df2"'
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdp"'
op|','
string|'"objects"'
op|','
string|'"9720"'
op|','
string|'"ca5"'
op|','
nl|'\n'
string|'"4a943bc72c2e647c4675923d58cf4ca5"'
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdq"'
op|','
string|'"objects"'
op|','
string|'"3071"'
op|','
string|'"8eb"'
op|','
nl|'\n'
string|'"fcd938702024c25fef6c32fef05298eb"'
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdp"'
op|','
string|'"objects-1"'
op|','
string|'"9970"'
op|','
string|'"ca5"'
op|','
nl|'\n'
string|'"4a943bc72c2e647c4675923d58cf4ca5"'
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdq"'
op|','
string|'"objects-2"'
op|','
string|'"9971"'
op|','
string|'"8eb"'
op|','
nl|'\n'
string|'"fcd938702024c25fef6c32fef05298eb"'
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdq"'
op|','
string|'"objects-99"'
op|','
string|'"9972"'
op|','
nl|'\n'
string|'"8eb"'
op|','
nl|'\n'
string|'"fcd938702024c25fef6c32fef05298eb"'
op|')'
op|')'
newline|'\n'
comment|'# the bad'
nl|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdq"'
op|','
string|'"objects-"'
op|','
string|'"1135"'
op|','
nl|'\n'
string|'"6c3"'
op|','
nl|'\n'
string|'"fcd938702024c25fef6c32fef05298eb"'
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdq"'
op|','
string|'"objects-fud"'
op|','
string|'"foo"'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_make_file'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdp"'
op|','
string|'"objects"'
op|','
string|'"1519"'
op|','
nl|'\n'
string|'"fed"'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_make_file'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdq"'
op|','
string|'"objects"'
op|','
string|'"9876"'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# the empty'
nl|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdr"'
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sds"'
op|','
string|'"objects"'
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdt"'
op|','
string|'"objects"'
op|','
string|'"9601"'
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdu"'
op|','
string|'"objects"'
op|','
string|'"6499"'
op|','
string|'"f80"'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# the irrelevant'
nl|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdv"'
op|','
string|'"accounts"'
op|','
string|'"77"'
op|','
string|'"421"'
op|','
nl|'\n'
string|'"4b8c86149a6d532f4af018578fd9f421"'
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdw"'
op|','
string|'"containers"'
op|','
string|'"28"'
op|','
string|'"51e"'
op|','
nl|'\n'
string|'"4f9eee668b66c6f0250bfa3c7ab9e51e"'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'logger'
op|'='
name|'debug_logger'
op|'('
op|')'
newline|'\n'
name|'locations'
op|'='
op|'['
op|'('
name|'loc'
op|'.'
name|'path'
op|','
name|'loc'
op|'.'
name|'device'
op|','
name|'loc'
op|'.'
name|'partition'
op|')'
nl|'\n'
name|'for'
name|'loc'
name|'in'
name|'diskfile'
op|'.'
name|'object_audit_location_generator'
op|'('
nl|'\n'
name|'devices'
op|'='
name|'tmpdir'
op|','
name|'mount_check'
op|'='
name|'False'
op|','
nl|'\n'
name|'logger'
op|'='
name|'logger'
op|')'
op|']'
newline|'\n'
name|'locations'
op|'.'
name|'sort'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# expect some warnings about those bad dirs'
nl|'\n'
name|'warnings'
op|'='
name|'logger'
op|'.'
name|'get_lines_for_level'
op|'('
string|"'warning'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'set'
op|'('
name|'warnings'
op|')'
op|','
name|'set'
op|'('
op|'['
nl|'\n'
string|"'Directory objects- does not map to a valid policy'"
op|','
nl|'\n'
string|"'Directory objects-2 does not map to a valid policy'"
op|','
nl|'\n'
string|"'Directory objects-99 does not map to a valid policy'"
op|','
nl|'\n'
string|"'Directory objects-fud does not map to a valid policy'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'['
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdp"'
op|','
string|'"objects-1"'
op|','
string|'"9970"'
op|','
string|'"ca5"'
op|','
nl|'\n'
string|'"4a943bc72c2e647c4675923d58cf4ca5"'
op|')'
op|','
nl|'\n'
string|'"sdp"'
op|','
string|'"9970"'
op|')'
op|','
nl|'\n'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdp"'
op|','
string|'"objects"'
op|','
string|'"1519"'
op|','
string|'"aca"'
op|','
nl|'\n'
string|'"5c1fdc1ffb12e5eaf84edc30d8b67aca"'
op|')'
op|','
nl|'\n'
string|'"sdp"'
op|','
string|'"1519"'
op|')'
op|','
nl|'\n'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdp"'
op|','
string|'"objects"'
op|','
string|'"1519"'
op|','
string|'"aca"'
op|','
nl|'\n'
string|'"fdfd184d39080020bc8b487f8a7beaca"'
op|')'
op|','
nl|'\n'
string|'"sdp"'
op|','
string|'"1519"'
op|')'
op|','
nl|'\n'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdp"'
op|','
string|'"objects"'
op|','
string|'"1519"'
op|','
string|'"df2"'
op|','
nl|'\n'
string|'"b0fe7af831cc7b1af5bf486b1c841df2"'
op|')'
op|','
nl|'\n'
string|'"sdp"'
op|','
string|'"1519"'
op|')'
op|','
nl|'\n'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdp"'
op|','
string|'"objects"'
op|','
string|'"9720"'
op|','
string|'"ca5"'
op|','
nl|'\n'
string|'"4a943bc72c2e647c4675923d58cf4ca5"'
op|')'
op|','
nl|'\n'
string|'"sdp"'
op|','
string|'"9720"'
op|')'
op|','
nl|'\n'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdq"'
op|','
string|'"objects-"'
op|','
string|'"1135"'
op|','
string|'"6c3"'
op|','
nl|'\n'
string|'"fcd938702024c25fef6c32fef05298eb"'
op|')'
op|','
nl|'\n'
string|'"sdq"'
op|','
string|'"1135"'
op|')'
op|','
nl|'\n'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdq"'
op|','
string|'"objects-2"'
op|','
string|'"9971"'
op|','
string|'"8eb"'
op|','
nl|'\n'
string|'"fcd938702024c25fef6c32fef05298eb"'
op|')'
op|','
nl|'\n'
string|'"sdq"'
op|','
string|'"9971"'
op|')'
op|','
nl|'\n'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdq"'
op|','
string|'"objects-99"'
op|','
string|'"9972"'
op|','
string|'"8eb"'
op|','
nl|'\n'
string|'"fcd938702024c25fef6c32fef05298eb"'
op|')'
op|','
nl|'\n'
string|'"sdq"'
op|','
string|'"9972"'
op|')'
op|','
nl|'\n'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdq"'
op|','
string|'"objects"'
op|','
string|'"3071"'
op|','
string|'"8eb"'
op|','
nl|'\n'
string|'"fcd938702024c25fef6c32fef05298eb"'
op|')'
op|','
nl|'\n'
string|'"sdq"'
op|','
string|'"3071"'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'locations'
op|','
name|'expected'
op|')'
newline|'\n'
nl|'\n'
comment|'#now without a logger'
nl|'\n'
name|'locations'
op|'='
op|'['
op|'('
name|'loc'
op|'.'
name|'path'
op|','
name|'loc'
op|'.'
name|'device'
op|','
name|'loc'
op|'.'
name|'partition'
op|')'
nl|'\n'
name|'for'
name|'loc'
name|'in'
name|'diskfile'
op|'.'
name|'object_audit_location_generator'
op|'('
nl|'\n'
name|'devices'
op|'='
name|'tmpdir'
op|','
name|'mount_check'
op|'='
name|'False'
op|')'
op|']'
newline|'\n'
name|'locations'
op|'.'
name|'sort'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'locations'
op|','
name|'expected'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_skipping_unmounted_devices
dedent|''
dedent|''
name|'def'
name|'test_skipping_unmounted_devices'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|mock_ismount
indent|'        '
name|'def'
name|'mock_ismount'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'path'
op|'.'
name|'endswith'
op|'('
string|"'sdp'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.ismount'"
op|','
name|'mock_ismount'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'temptree'
op|'('
op|'['
op|']'
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'                '
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdp"'
op|','
string|'"objects"'
op|','
nl|'\n'
string|'"2607"'
op|','
string|'"df3"'
op|','
nl|'\n'
string|'"ec2871fe724411f91787462f97d30df3"'
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdq"'
op|','
string|'"objects"'
op|','
nl|'\n'
string|'"9785"'
op|','
string|'"a10"'
op|','
nl|'\n'
string|'"4993d582f41be9771505a8d4cb237a10"'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'locations'
op|'='
op|'['
nl|'\n'
op|'('
name|'loc'
op|'.'
name|'path'
op|','
name|'loc'
op|'.'
name|'device'
op|','
name|'loc'
op|'.'
name|'partition'
op|')'
nl|'\n'
name|'for'
name|'loc'
name|'in'
name|'diskfile'
op|'.'
name|'object_audit_location_generator'
op|'('
nl|'\n'
name|'devices'
op|'='
name|'tmpdir'
op|','
name|'mount_check'
op|'='
name|'True'
op|')'
op|']'
newline|'\n'
name|'locations'
op|'.'
name|'sort'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'locations'
op|','
nl|'\n'
op|'['
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdp"'
op|','
string|'"objects"'
op|','
nl|'\n'
string|'"2607"'
op|','
string|'"df3"'
op|','
nl|'\n'
string|'"ec2871fe724411f91787462f97d30df3"'
op|')'
op|','
nl|'\n'
string|'"sdp"'
op|','
string|'"2607"'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# Do it again, this time with a logger.'
nl|'\n'
name|'ml'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'locations'
op|'='
op|'['
nl|'\n'
op|'('
name|'loc'
op|'.'
name|'path'
op|','
name|'loc'
op|'.'
name|'device'
op|','
name|'loc'
op|'.'
name|'partition'
op|')'
nl|'\n'
name|'for'
name|'loc'
name|'in'
name|'diskfile'
op|'.'
name|'object_audit_location_generator'
op|'('
nl|'\n'
name|'devices'
op|'='
name|'tmpdir'
op|','
name|'mount_check'
op|'='
name|'True'
op|','
name|'logger'
op|'='
name|'ml'
op|')'
op|']'
newline|'\n'
name|'ml'
op|'.'
name|'debug'
op|'.'
name|'assert_called_once_with'
op|'('
nl|'\n'
string|"'Skipping %s as it is not mounted'"
op|','
nl|'\n'
string|"'sdq'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_only_catch_expected_errors
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_only_catch_expected_errors'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Crazy exceptions should still escape object_audit_location_generator'
nl|'\n'
comment|"# so that errors get logged and a human can see what's going wrong;"
nl|'\n'
comment|'# only normal FS corruption should be skipped over silently.'
nl|'\n'
nl|'\n'
DECL|function|list_locations
indent|'        '
name|'def'
name|'list_locations'
op|'('
name|'dirname'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'['
op|'('
name|'loc'
op|'.'
name|'path'
op|','
name|'loc'
op|'.'
name|'device'
op|','
name|'loc'
op|'.'
name|'partition'
op|')'
nl|'\n'
name|'for'
name|'loc'
name|'in'
name|'diskfile'
op|'.'
name|'object_audit_location_generator'
op|'('
nl|'\n'
name|'devices'
op|'='
name|'dirname'
op|','
name|'mount_check'
op|'='
name|'False'
op|')'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'real_listdir'
op|'='
name|'os'
op|'.'
name|'listdir'
newline|'\n'
nl|'\n'
DECL|function|splode_if_endswith
name|'def'
name|'splode_if_endswith'
op|'('
name|'suffix'
op|')'
op|':'
newline|'\n'
DECL|function|sploder
indent|'            '
name|'def'
name|'sploder'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'path'
op|'.'
name|'endswith'
op|'('
name|'suffix'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'OSError'
op|'('
name|'errno'
op|'.'
name|'EACCES'
op|','
string|'"don\'t try to ad-lib"'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'return'
name|'real_listdir'
op|'('
name|'path'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'sploder'
newline|'\n'
nl|'\n'
dedent|''
name|'with'
name|'temptree'
op|'('
op|'['
op|']'
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"sdf"'
op|','
string|'"objects"'
op|','
nl|'\n'
string|'"2607"'
op|','
string|'"b54"'
op|','
nl|'\n'
string|'"fe450ec990a88cc4b252b181bab04b54"'
op|')'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.listdir'"
op|','
name|'splode_if_endswith'
op|'('
string|'"sdf/objects"'
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'OSError'
op|','
name|'list_locations'
op|','
name|'tmpdir'
op|')'
newline|'\n'
dedent|''
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.listdir'"
op|','
name|'splode_if_endswith'
op|'('
string|'"2607"'
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'OSError'
op|','
name|'list_locations'
op|','
name|'tmpdir'
op|')'
newline|'\n'
dedent|''
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.listdir'"
op|','
name|'splode_if_endswith'
op|'('
string|'"b54"'
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'OSError'
op|','
name|'list_locations'
op|','
name|'tmpdir'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|TestDiskFileManager
dedent|''
dedent|''
dedent|''
dedent|''
name|'class'
name|'TestDiskFileManager'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'tmpdir'
op|'='
name|'mkdtemp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'testdir'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'tmpdir'
op|','
string|"'tmp_test_obj_server_DiskFile'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'existing_device1'
op|'='
string|"'sda1'"
newline|'\n'
name|'self'
op|'.'
name|'existing_device2'
op|'='
string|"'sda2'"
newline|'\n'
name|'mkdirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'self'
op|'.'
name|'existing_device1'
op|','
string|"'tmp'"
op|')'
op|')'
newline|'\n'
name|'mkdirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'self'
op|'.'
name|'existing_device2'
op|','
string|"'tmp'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_orig_tpool_exc'
op|'='
name|'tpool'
op|'.'
name|'execute'
newline|'\n'
name|'tpool'
op|'.'
name|'execute'
op|'='
name|'lambda'
name|'f'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|':'
name|'f'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'conf'
op|'='
name|'dict'
op|'('
name|'devices'
op|'='
name|'self'
op|'.'
name|'testdir'
op|','
name|'mount_check'
op|'='
string|"'false'"
op|','
nl|'\n'
name|'keep_cache_size'
op|'='
number|'2'
op|'*'
number|'1024'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'='
name|'diskfile'
op|'.'
name|'DiskFileManager'
op|'('
name|'self'
op|'.'
name|'conf'
op|','
name|'FakeLogger'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|tearDown
dedent|''
name|'def'
name|'tearDown'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rmtree'
op|'('
name|'self'
op|'.'
name|'tmpdir'
op|','
name|'ignore_errors'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_construct_dev_path
dedent|''
name|'def'
name|'test_construct_dev_path'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'res_path'
op|'='
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'construct_dev_path'
op|'('
string|"'abc'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'devices'
op|','
string|"'abc'"
op|')'
op|','
name|'res_path'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_pickle_async_update
dedent|''
name|'def'
name|'test_pickle_async_update'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'logger'
op|'.'
name|'increment'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'ts'
op|'='
name|'normalize_timestamp'
op|'('
number|'10000.0'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.write_pickle'"
op|')'
name|'as'
name|'wp'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'pickle_async_update'
op|'('
name|'self'
op|'.'
name|'existing_device1'
op|','
nl|'\n'
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|','
nl|'\n'
name|'dict'
op|'('
name|'a'
op|'='
number|'1'
op|','
name|'b'
op|'='
number|'2'
op|')'
op|','
name|'ts'
op|','
number|'0'
op|')'
newline|'\n'
name|'dp'
op|'='
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'construct_dev_path'
op|'('
name|'self'
op|'.'
name|'existing_device1'
op|')'
newline|'\n'
name|'ohash'
op|'='
name|'diskfile'
op|'.'
name|'hash_path'
op|'('
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|')'
newline|'\n'
name|'wp'
op|'.'
name|'assert_called_with'
op|'('
op|'{'
string|"'a'"
op|':'
number|'1'
op|','
string|"'b'"
op|':'
number|'2'
op|'}'
op|','
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'dp'
op|','
name|'diskfile'
op|'.'
name|'get_async_dir'
op|'('
number|'0'
op|')'
op|','
nl|'\n'
name|'ohash'
op|'['
op|'-'
number|'3'
op|':'
op|']'
op|','
name|'ohash'
op|'+'
string|"'-'"
op|'+'
name|'ts'
op|')'
op|','
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'dp'
op|','
string|"'tmp'"
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'logger'
op|'.'
name|'increment'
op|'.'
name|'assert_called_with'
op|'('
string|"'async_pendings'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_audit_location_generator
dedent|''
name|'def'
name|'test_object_audit_location_generator'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'locations'
op|'='
name|'list'
op|'('
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'object_audit_location_generator'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'locations'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_hashes_bad_dev
dedent|''
name|'def'
name|'test_get_hashes_bad_dev'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'mount_check'
op|'='
name|'True'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.check_mount'"
op|','
nl|'\n'
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'side_effect'
op|'='
op|'['
name|'False'
op|']'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'DiskFileDeviceUnavailable'
op|','
nl|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_hashes'
op|','
string|"'sdb1'"
op|','
string|"'0'"
op|','
string|"'123'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_hashes_w_nothing
dedent|''
dedent|''
name|'def'
name|'test_get_hashes_w_nothing'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'hashes'
op|'='
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_hashes'
op|'('
name|'self'
op|'.'
name|'existing_device1'
op|','
string|"'0'"
op|','
string|"'123'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'hashes'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
comment|'# get_hashes creates the partition path, so call again for code'
nl|'\n'
comment|'# path coverage, ensuring the result is unchanged'
nl|'\n'
name|'hashes'
op|'='
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_hashes'
op|'('
name|'self'
op|'.'
name|'existing_device1'
op|','
string|"'0'"
op|','
string|"'123'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'hashes'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_replication_lock_on
dedent|''
name|'def'
name|'test_replication_lock_on'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Double check settings'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'replication_one_per_device'
op|'='
name|'True'
newline|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'replication_lock_timeout'
op|'='
number|'0.1'
newline|'\n'
name|'dev_path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'self'
op|'.'
name|'existing_device1'
op|')'
newline|'\n'
name|'with'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'replication_lock'
op|'('
name|'dev_path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'lock_exc'
op|'='
name|'None'
newline|'\n'
name|'exc'
op|'='
name|'None'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'with'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'replication_lock'
op|'('
name|'dev_path'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'Exception'
op|'('
nl|'\n'
string|"'%r was not replication locked!'"
op|'%'
name|'dev_path'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'ReplicationLockTimeout'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'lock_exc'
op|'='
name|'err'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'exc'
op|'='
name|'err'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'lock_exc'
name|'is'
name|'not'
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'exc'
name|'is'
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_replication_lock_off
dedent|''
dedent|''
name|'def'
name|'test_replication_lock_off'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Double check settings'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'replication_one_per_device'
op|'='
name|'False'
newline|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'replication_lock_timeout'
op|'='
number|'0.1'
newline|'\n'
name|'dev_path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'self'
op|'.'
name|'existing_device1'
op|')'
newline|'\n'
name|'with'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'replication_lock'
op|'('
name|'dev_path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'lock_exc'
op|'='
name|'None'
newline|'\n'
name|'exc'
op|'='
name|'None'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'with'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'replication_lock'
op|'('
name|'dev_path'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'Exception'
op|'('
nl|'\n'
string|"'%r was not replication locked!'"
op|'%'
name|'dev_path'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'ReplicationLockTimeout'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'lock_exc'
op|'='
name|'err'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'exc'
op|'='
name|'err'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'lock_exc'
name|'is'
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'exc'
name|'is'
name|'not'
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_replication_lock_another_device_fine
dedent|''
dedent|''
name|'def'
name|'test_replication_lock_another_device_fine'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Double check settings'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'replication_one_per_device'
op|'='
name|'True'
newline|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'replication_lock_timeout'
op|'='
number|'0.1'
newline|'\n'
name|'dev_path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'self'
op|'.'
name|'existing_device1'
op|')'
newline|'\n'
name|'dev_path2'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'self'
op|'.'
name|'existing_device2'
op|')'
newline|'\n'
name|'with'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'replication_lock'
op|'('
name|'dev_path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'lock_exc'
op|'='
name|'None'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'with'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'replication_lock'
op|'('
name|'dev_path2'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'pass'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'ReplicationLockTimeout'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'lock_exc'
op|'='
name|'err'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'lock_exc'
name|'is'
name|'None'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
op|'@'
name|'patch_policies'
newline|'\n'
DECL|class|TestDiskFile
name|'class'
name|'TestDiskFile'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Test swift.obj.diskfile.DiskFile"""'
newline|'\n'
nl|'\n'
DECL|member|setUp
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Set up for testing swift.obj.diskfile"""'
newline|'\n'
name|'self'
op|'.'
name|'tmpdir'
op|'='
name|'mkdtemp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'testdir'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'tmpdir'
op|','
string|"'tmp_test_obj_server_DiskFile'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'existing_device'
op|'='
string|"'sda1'"
newline|'\n'
name|'for'
name|'policy'
name|'in'
name|'POLICIES'
op|':'
newline|'\n'
indent|'            '
name|'mkdirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'self'
op|'.'
name|'existing_device'
op|','
nl|'\n'
name|'get_tmp_dir'
op|'('
name|'policy'
op|'.'
name|'idx'
op|')'
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_orig_tpool_exc'
op|'='
name|'tpool'
op|'.'
name|'execute'
newline|'\n'
name|'tpool'
op|'.'
name|'execute'
op|'='
name|'lambda'
name|'f'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|':'
name|'f'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'conf'
op|'='
name|'dict'
op|'('
name|'devices'
op|'='
name|'self'
op|'.'
name|'testdir'
op|','
name|'mount_check'
op|'='
string|"'false'"
op|','
nl|'\n'
name|'keep_cache_size'
op|'='
number|'2'
op|'*'
number|'1024'
op|','
name|'mb_per_sync'
op|'='
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'='
name|'diskfile'
op|'.'
name|'DiskFileManager'
op|'('
name|'self'
op|'.'
name|'conf'
op|','
name|'FakeLogger'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|tearDown
dedent|''
name|'def'
name|'tearDown'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Tear down for testing swift.obj.diskfile"""'
newline|'\n'
name|'rmtree'
op|'('
name|'self'
op|'.'
name|'tmpdir'
op|','
name|'ignore_errors'
op|'='
number|'1'
op|')'
newline|'\n'
name|'tpool'
op|'.'
name|'execute'
op|'='
name|'self'
op|'.'
name|'_orig_tpool_exc'
newline|'\n'
nl|'\n'
DECL|member|_create_ondisk_file
dedent|''
name|'def'
name|'_create_ondisk_file'
op|'('
name|'self'
op|','
name|'df'
op|','
name|'data'
op|','
name|'timestamp'
op|','
name|'metadata'
op|'='
name|'None'
op|','
nl|'\n'
name|'ext'
op|'='
string|"'.data'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mkdirs'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'if'
name|'timestamp'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'timestamp'
op|'='
name|'time'
op|'('
op|')'
newline|'\n'
dedent|''
name|'timestamp'
op|'='
name|'normalize_timestamp'
op|'('
name|'timestamp'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'metadata'
op|':'
newline|'\n'
indent|'            '
name|'metadata'
op|'='
op|'{'
op|'}'
newline|'\n'
dedent|''
name|'if'
string|"'X-Timestamp'"
name|'not'
name|'in'
name|'metadata'
op|':'
newline|'\n'
indent|'            '
name|'metadata'
op|'['
string|"'X-Timestamp'"
op|']'
op|'='
name|'normalize_timestamp'
op|'('
name|'timestamp'
op|')'
newline|'\n'
dedent|''
name|'if'
string|"'ETag'"
name|'not'
name|'in'
name|'metadata'
op|':'
newline|'\n'
indent|'            '
name|'etag'
op|'='
name|'md5'
op|'('
op|')'
newline|'\n'
name|'etag'
op|'.'
name|'update'
op|'('
name|'data'
op|')'
newline|'\n'
name|'metadata'
op|'['
string|"'ETag'"
op|']'
op|'='
name|'etag'
op|'.'
name|'hexdigest'
op|'('
op|')'
newline|'\n'
dedent|''
name|'if'
string|"'name'"
name|'not'
name|'in'
name|'metadata'
op|':'
newline|'\n'
indent|'            '
name|'metadata'
op|'['
string|"'name'"
op|']'
op|'='
string|"'/a/c/o'"
newline|'\n'
dedent|''
name|'if'
string|"'Content-Length'"
name|'not'
name|'in'
name|'metadata'
op|':'
newline|'\n'
indent|'            '
name|'metadata'
op|'['
string|"'Content-Length'"
op|']'
op|'='
name|'str'
op|'('
name|'len'
op|'('
name|'data'
op|')'
op|')'
newline|'\n'
dedent|''
name|'data_file'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|','
name|'timestamp'
op|'+'
name|'ext'
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
name|'data_file'
op|','
string|"'wb'"
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'            '
name|'f'
op|'.'
name|'write'
op|'('
name|'data'
op|')'
newline|'\n'
name|'xattr'
op|'.'
name|'setxattr'
op|'('
name|'f'
op|'.'
name|'fileno'
op|'('
op|')'
op|','
name|'diskfile'
op|'.'
name|'METADATA_KEY'
op|','
nl|'\n'
name|'pickle'
op|'.'
name|'dumps'
op|'('
name|'metadata'
op|','
name|'diskfile'
op|'.'
name|'PICKLE_PROTOCOL'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_simple_get_diskfile
dedent|''
dedent|''
name|'def'
name|'_simple_get_diskfile'
op|'('
name|'self'
op|','
name|'partition'
op|'='
string|"'0'"
op|','
name|'account'
op|'='
string|"'a'"
op|','
name|'container'
op|'='
string|"'c'"
op|','
nl|'\n'
name|'obj'
op|'='
string|"'o'"
op|','
name|'policy_idx'
op|'='
number|'0'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile'
op|'('
name|'self'
op|'.'
name|'existing_device'
op|','
nl|'\n'
name|'partition'
op|','
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|','
nl|'\n'
name|'policy_idx'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_create_test_file
dedent|''
name|'def'
name|'_create_test_file'
op|'('
name|'self'
op|','
name|'data'
op|','
name|'timestamp'
op|'='
name|'None'
op|','
name|'metadata'
op|'='
name|'None'
op|','
nl|'\n'
name|'account'
op|'='
string|"'a'"
op|','
name|'container'
op|'='
string|"'c'"
op|','
name|'obj'
op|'='
string|"'o'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'metadata'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'metadata'
op|'='
op|'{'
op|'}'
newline|'\n'
dedent|''
name|'metadata'
op|'.'
name|'setdefault'
op|'('
string|"'name'"
op|','
string|"'/%s/%s/%s'"
op|'%'
op|'('
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|')'
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
name|'account'
op|'='
name|'account'
op|','
name|'container'
op|'='
name|'container'
op|','
nl|'\n'
name|'obj'
op|'='
name|'obj'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
name|'data'
op|','
name|'timestamp'
op|','
name|'metadata'
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
name|'account'
op|'='
name|'account'
op|','
name|'container'
op|'='
name|'container'
op|','
nl|'\n'
name|'obj'
op|'='
name|'obj'
op|')'
newline|'\n'
name|'df'
op|'.'
name|'open'
op|'('
op|')'
newline|'\n'
name|'return'
name|'df'
newline|'\n'
nl|'\n'
DECL|member|test_open_not_exist
dedent|''
name|'def'
name|'test_open_not_exist'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'DiskFileNotExist'
op|','
name|'df'
op|'.'
name|'open'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_open_expired
dedent|''
name|'def'
name|'test_open_expired'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'DiskFileExpired'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_create_test_file'
op|','
nl|'\n'
string|"'1234567890'"
op|','
name|'metadata'
op|'='
op|'{'
string|"'X-Delete-At'"
op|':'
string|"'0'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_open_not_expired
dedent|''
name|'def'
name|'test_open_not_expired'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_create_test_file'
op|'('
nl|'\n'
string|"'1234567890'"
op|','
name|'metadata'
op|'='
op|'{'
string|"'X-Delete-At'"
op|':'
name|'str'
op|'('
number|'2'
op|'*'
name|'int'
op|'('
name|'time'
op|'('
op|')'
op|')'
op|')'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'SwiftException'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'fail'
op|'('
string|'"Unexpected swift exception raised: %r"'
op|'%'
name|'err'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_metadata
dedent|''
dedent|''
name|'def'
name|'test_get_metadata'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_test_file'
op|'('
string|"'1234567890'"
op|','
name|'timestamp'
op|'='
number|'42'
op|')'
newline|'\n'
name|'md'
op|'='
name|'df'
op|'.'
name|'get_metadata'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'md'
op|'['
string|"'X-Timestamp'"
op|']'
op|','
name|'normalize_timestamp'
op|'('
number|'42'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_read_metadata
dedent|''
name|'def'
name|'test_read_metadata'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_create_test_file'
op|'('
string|"'1234567890'"
op|','
name|'timestamp'
op|'='
number|'42'
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'md'
op|'='
name|'df'
op|'.'
name|'read_metadata'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'md'
op|'['
string|"'X-Timestamp'"
op|']'
op|','
name|'normalize_timestamp'
op|'('
number|'42'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_metadata_not_opened
dedent|''
name|'def'
name|'test_get_metadata_not_opened'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'DiskFileNotOpen'
op|','
name|'df'
op|'.'
name|'get_metadata'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_not_opened
dedent|''
name|'def'
name|'test_not_opened'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'df'
op|':'
newline|'\n'
indent|'                '
name|'pass'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'DiskFileNotOpen'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'fail'
op|'('
string|'"Expected DiskFileNotOpen exception"'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_disk_file_default_disallowed_metadata
dedent|''
dedent|''
name|'def'
name|'test_disk_file_default_disallowed_metadata'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# build an object with some meta (ts 41)'
nl|'\n'
indent|'        '
name|'orig_metadata'
op|'='
op|'{'
string|"'X-Object-Meta-Key1'"
op|':'
string|"'Value1'"
op|','
nl|'\n'
string|"'Content-Type'"
op|':'
string|"'text/garbage'"
op|'}'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
name|'ts'
op|'='
number|'41'
op|','
name|'extra_metadata'
op|'='
name|'orig_metadata'
op|')'
newline|'\n'
name|'with'
name|'df'
op|'.'
name|'open'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEquals'
op|'('
string|"'1024'"
op|','
name|'df'
op|'.'
name|'_metadata'
op|'['
string|"'Content-Length'"
op|']'
op|')'
newline|'\n'
comment|"# write some new metadata (fast POST, don't send orig meta, ts 42)"
nl|'\n'
dedent|''
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'df'
op|'.'
name|'write_metadata'
op|'('
op|'{'
string|"'X-Timestamp'"
op|':'
name|'normalize_timestamp'
op|'('
number|'42'
op|')'
op|','
nl|'\n'
string|"'X-Object-Meta-Key2'"
op|':'
string|"'Value2'"
op|'}'
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'with'
name|'df'
op|'.'
name|'open'
op|'('
op|')'
op|':'
newline|'\n'
comment|'# non-fast-post updateable keys are preserved'
nl|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEquals'
op|'('
string|"'text/garbage'"
op|','
name|'df'
op|'.'
name|'_metadata'
op|'['
string|"'Content-Type'"
op|']'
op|')'
newline|'\n'
comment|'# original fast-post updateable keys are removed'
nl|'\n'
name|'self'
op|'.'
name|'assert_'
op|'('
string|"'X-Object-Meta-Key1'"
name|'not'
name|'in'
name|'df'
op|'.'
name|'_metadata'
op|')'
newline|'\n'
comment|'# new fast-post updateable keys are added'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
string|"'Value2'"
op|','
name|'df'
op|'.'
name|'_metadata'
op|'['
string|"'X-Object-Meta-Key2'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_disk_file_reader_iter
dedent|''
dedent|''
name|'def'
name|'test_disk_file_reader_iter'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_test_file'
op|'('
string|"'1234567890'"
op|')'
newline|'\n'
name|'quarantine_msgs'
op|'='
op|'['
op|']'
newline|'\n'
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
name|'_quarantine_hook'
op|'='
name|'quarantine_msgs'
op|'.'
name|'append'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"''"
op|'.'
name|'join'
op|'('
name|'reader'
op|')'
op|','
string|"'1234567890'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'quarantine_msgs'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_disk_file_reader_iter_w_quarantine
dedent|''
name|'def'
name|'test_disk_file_reader_iter_w_quarantine'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_test_file'
op|'('
string|"'1234567890'"
op|')'
newline|'\n'
nl|'\n'
DECL|function|raise_dfq
name|'def'
name|'raise_dfq'
op|'('
name|'m'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'DiskFileQuarantined'
op|'('
name|'m'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
name|'_quarantine_hook'
op|'='
name|'raise_dfq'
op|')'
newline|'\n'
name|'reader'
op|'.'
name|'_obj_size'
op|'+='
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'DiskFileQuarantined'
op|','
string|"''"
op|'.'
name|'join'
op|','
name|'reader'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_disk_file_app_iter_corners
dedent|''
name|'def'
name|'test_disk_file_app_iter_corners'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_test_file'
op|'('
string|"'1234567890'"
op|')'
newline|'\n'
name|'quarantine_msgs'
op|'='
op|'['
op|']'
newline|'\n'
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
name|'_quarantine_hook'
op|'='
name|'quarantine_msgs'
op|'.'
name|'append'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
string|"''"
op|'.'
name|'join'
op|'('
name|'reader'
op|'.'
name|'app_iter_range'
op|'('
number|'0'
op|','
name|'None'
op|')'
op|')'
op|','
nl|'\n'
string|"'1234567890'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'quarantine_msgs'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'with'
name|'df'
op|'.'
name|'open'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"''"
op|'.'
name|'join'
op|'('
name|'reader'
op|'.'
name|'app_iter_range'
op|'('
number|'5'
op|','
name|'None'
op|')'
op|')'
op|','
string|"'67890'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_disk_file_app_iter_range_w_none
dedent|''
dedent|''
name|'def'
name|'test_disk_file_app_iter_range_w_none'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_test_file'
op|'('
string|"'1234567890'"
op|')'
newline|'\n'
name|'quarantine_msgs'
op|'='
op|'['
op|']'
newline|'\n'
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
name|'_quarantine_hook'
op|'='
name|'quarantine_msgs'
op|'.'
name|'append'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"''"
op|'.'
name|'join'
op|'('
name|'reader'
op|'.'
name|'app_iter_range'
op|'('
name|'None'
op|','
name|'None'
op|')'
op|')'
op|','
nl|'\n'
string|"'1234567890'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'quarantine_msgs'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_disk_file_app_iter_partial_closes
dedent|''
name|'def'
name|'test_disk_file_app_iter_partial_closes'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_test_file'
op|'('
string|"'1234567890'"
op|')'
newline|'\n'
name|'quarantine_msgs'
op|'='
op|'['
op|']'
newline|'\n'
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
name|'_quarantine_hook'
op|'='
name|'quarantine_msgs'
op|'.'
name|'append'
op|')'
newline|'\n'
name|'it'
op|'='
name|'reader'
op|'.'
name|'app_iter_range'
op|'('
number|'0'
op|','
number|'5'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"''"
op|'.'
name|'join'
op|'('
name|'it'
op|')'
op|','
string|"'12345'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'quarantine_msgs'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'reader'
op|'.'
name|'_fp'
name|'is'
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_disk_file_app_iter_ranges
dedent|''
name|'def'
name|'test_disk_file_app_iter_ranges'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_test_file'
op|'('
string|"'012345678911234567892123456789'"
op|')'
newline|'\n'
name|'quarantine_msgs'
op|'='
op|'['
op|']'
newline|'\n'
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
name|'_quarantine_hook'
op|'='
name|'quarantine_msgs'
op|'.'
name|'append'
op|')'
newline|'\n'
name|'it'
op|'='
name|'reader'
op|'.'
name|'app_iter_ranges'
op|'('
op|'['
op|'('
number|'0'
op|','
number|'10'
op|')'
op|','
op|'('
number|'10'
op|','
number|'20'
op|')'
op|','
op|'('
number|'20'
op|','
number|'30'
op|')'
op|']'
op|','
nl|'\n'
string|"'plain/text'"
op|','
nl|'\n'
string|"'\\r\\n--someheader\\r\\n'"
op|','
number|'30'
op|')'
newline|'\n'
name|'value'
op|'='
string|"''"
op|'.'
name|'join'
op|'('
name|'it'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'0123456789'"
name|'in'
name|'value'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'1123456789'"
name|'in'
name|'value'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'2123456789'"
name|'in'
name|'value'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'quarantine_msgs'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_disk_file_app_iter_ranges_w_quarantine
dedent|''
name|'def'
name|'test_disk_file_app_iter_ranges_w_quarantine'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_test_file'
op|'('
string|"'012345678911234567892123456789'"
op|')'
newline|'\n'
name|'quarantine_msgs'
op|'='
op|'['
op|']'
newline|'\n'
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
name|'_quarantine_hook'
op|'='
name|'quarantine_msgs'
op|'.'
name|'append'
op|')'
newline|'\n'
name|'reader'
op|'.'
name|'_obj_size'
op|'+='
number|'1'
newline|'\n'
name|'it'
op|'='
name|'reader'
op|'.'
name|'app_iter_ranges'
op|'('
op|'['
op|'('
number|'0'
op|','
number|'30'
op|')'
op|']'
op|','
nl|'\n'
string|"'plain/text'"
op|','
nl|'\n'
string|"'\\r\\n--someheader\\r\\n'"
op|','
number|'30'
op|')'
newline|'\n'
name|'value'
op|'='
string|"''"
op|'.'
name|'join'
op|'('
name|'it'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'0123456789'"
name|'in'
name|'value'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'1123456789'"
name|'in'
name|'value'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'2123456789'"
name|'in'
name|'value'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'quarantine_msgs'
op|','
nl|'\n'
op|'['
string|'"Bytes read: 30, does not match metadata: 31"'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_disk_file_app_iter_ranges_w_no_etag_quarantine
dedent|''
name|'def'
name|'test_disk_file_app_iter_ranges_w_no_etag_quarantine'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_test_file'
op|'('
string|"'012345678911234567892123456789'"
op|')'
newline|'\n'
name|'quarantine_msgs'
op|'='
op|'['
op|']'
newline|'\n'
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
name|'_quarantine_hook'
op|'='
name|'quarantine_msgs'
op|'.'
name|'append'
op|')'
newline|'\n'
name|'it'
op|'='
name|'reader'
op|'.'
name|'app_iter_ranges'
op|'('
op|'['
op|'('
number|'0'
op|','
number|'10'
op|')'
op|']'
op|','
nl|'\n'
string|"'plain/text'"
op|','
nl|'\n'
string|"'\\r\\n--someheader\\r\\n'"
op|','
number|'30'
op|')'
newline|'\n'
name|'value'
op|'='
string|"''"
op|'.'
name|'join'
op|'('
name|'it'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'0123456789'"
name|'in'
name|'value'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'quarantine_msgs'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_disk_file_app_iter_ranges_edges
dedent|''
name|'def'
name|'test_disk_file_app_iter_ranges_edges'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_test_file'
op|'('
string|"'012345678911234567892123456789'"
op|')'
newline|'\n'
name|'quarantine_msgs'
op|'='
op|'['
op|']'
newline|'\n'
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
name|'_quarantine_hook'
op|'='
name|'quarantine_msgs'
op|'.'
name|'append'
op|')'
newline|'\n'
name|'it'
op|'='
name|'reader'
op|'.'
name|'app_iter_ranges'
op|'('
op|'['
op|'('
number|'3'
op|','
number|'10'
op|')'
op|','
op|'('
number|'0'
op|','
number|'2'
op|')'
op|']'
op|','
string|"'application/whatever'"
op|','
nl|'\n'
string|"'\\r\\n--someheader\\r\\n'"
op|','
number|'30'
op|')'
newline|'\n'
name|'value'
op|'='
string|"''"
op|'.'
name|'join'
op|'('
name|'it'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'3456789'"
name|'in'
name|'value'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'01'"
name|'in'
name|'value'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'quarantine_msgs'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_disk_file_large_app_iter_ranges
dedent|''
name|'def'
name|'test_disk_file_large_app_iter_ranges'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# This test case is to make sure that the disk file app_iter_ranges'
nl|'\n'
comment|'# method all the paths being tested.'
nl|'\n'
indent|'        '
name|'long_str'
op|'='
string|"'01234567890'"
op|'*'
number|'65536'
newline|'\n'
name|'target_strs'
op|'='
op|'['
string|"'3456789'"
op|','
name|'long_str'
op|'['
number|'0'
op|':'
number|'65590'
op|']'
op|']'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_test_file'
op|'('
name|'long_str'
op|')'
newline|'\n'
name|'quarantine_msgs'
op|'='
op|'['
op|']'
newline|'\n'
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
name|'_quarantine_hook'
op|'='
name|'quarantine_msgs'
op|'.'
name|'append'
op|')'
newline|'\n'
name|'it'
op|'='
name|'reader'
op|'.'
name|'app_iter_ranges'
op|'('
op|'['
op|'('
number|'3'
op|','
number|'10'
op|')'
op|','
op|'('
number|'0'
op|','
number|'65590'
op|')'
op|']'
op|','
string|"'plain/text'"
op|','
nl|'\n'
string|"'5e816ff8b8b8e9a5d355497e5d9e0301'"
op|','
number|'655360'
op|')'
newline|'\n'
nl|'\n'
comment|'# The produced string actually missing the MIME headers'
nl|'\n'
comment|'# need to add these headers to make it as real MIME message.'
nl|'\n'
comment|'# The body of the message is produced by method app_iter_ranges'
nl|'\n'
comment|'# off of DiskFile object.'
nl|'\n'
name|'header'
op|'='
string|"''"
op|'.'
name|'join'
op|'('
op|'['
string|"'Content-Type: multipart/byteranges;'"
op|','
nl|'\n'
string|"'boundary='"
op|','
nl|'\n'
string|"'5e816ff8b8b8e9a5d355497e5d9e0301\\r\\n'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'value'
op|'='
name|'header'
op|'+'
string|"''"
op|'.'
name|'join'
op|'('
name|'it'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'quarantine_msgs'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'parts'
op|'='
name|'map'
op|'('
name|'lambda'
name|'p'
op|':'
name|'p'
op|'.'
name|'get_payload'
op|'('
name|'decode'
op|'='
name|'True'
op|')'
op|','
nl|'\n'
name|'email'
op|'.'
name|'message_from_string'
op|'('
name|'value'
op|')'
op|'.'
name|'walk'
op|'('
op|')'
op|')'
op|'['
number|'1'
op|':'
number|'3'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'parts'
op|','
name|'target_strs'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_disk_file_app_iter_ranges_empty
dedent|''
name|'def'
name|'test_disk_file_app_iter_ranges_empty'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# This test case tests when empty value passed into app_iter_ranges'
nl|'\n'
comment|'# When ranges passed into the method is either empty array or None,'
nl|'\n'
comment|'# this method will yield empty string'
nl|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_test_file'
op|'('
string|"'012345678911234567892123456789'"
op|')'
newline|'\n'
name|'quarantine_msgs'
op|'='
op|'['
op|']'
newline|'\n'
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
name|'_quarantine_hook'
op|'='
name|'quarantine_msgs'
op|'.'
name|'append'
op|')'
newline|'\n'
name|'it'
op|'='
name|'reader'
op|'.'
name|'app_iter_ranges'
op|'('
op|'['
op|']'
op|','
string|"'application/whatever'"
op|','
nl|'\n'
string|"'\\r\\n--someheader\\r\\n'"
op|','
number|'100'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"''"
op|'.'
name|'join'
op|'('
name|'it'
op|')'
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'with'
name|'df'
op|'.'
name|'open'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
op|')'
newline|'\n'
name|'it'
op|'='
name|'reader'
op|'.'
name|'app_iter_ranges'
op|'('
name|'None'
op|','
string|"'app/something'"
op|','
nl|'\n'
string|"'\\r\\n--someheader\\r\\n'"
op|','
number|'150'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"''"
op|'.'
name|'join'
op|'('
name|'it'
op|')'
op|','
string|"''"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'quarantine_msgs'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_disk_file_mkstemp_creates_dir
dedent|''
dedent|''
name|'def'
name|'test_disk_file_mkstemp_creates_dir'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'policy'
name|'in'
name|'POLICIES'
op|':'
newline|'\n'
indent|'            '
name|'tmpdir'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'testdir'
op|','
name|'self'
op|'.'
name|'existing_device'
op|','
nl|'\n'
name|'get_tmp_dir'
op|'('
name|'policy'
op|'.'
name|'idx'
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'rmdir'
op|'('
name|'tmpdir'
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
name|'policy_idx'
op|'='
name|'policy'
op|'.'
name|'idx'
op|')'
newline|'\n'
name|'with'
name|'df'
op|'.'
name|'create'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assert_'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'tmpdir'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_open_disk_file
dedent|''
dedent|''
dedent|''
name|'def'
name|'_get_open_disk_file'
op|'('
name|'self'
op|','
name|'invalid_type'
op|'='
name|'None'
op|','
name|'obj_name'
op|'='
string|"'o'"
op|','
name|'fsize'
op|'='
number|'1024'
op|','
nl|'\n'
name|'csize'
op|'='
number|'8'
op|','
name|'mark_deleted'
op|'='
name|'False'
op|','
name|'prealloc'
op|'='
name|'False'
op|','
nl|'\n'
name|'ts'
op|'='
name|'None'
op|','
name|'mount_check'
op|'='
name|'False'
op|','
name|'extra_metadata'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|"'''returns a DiskFile'''"
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
name|'obj'
op|'='
name|'obj_name'
op|')'
newline|'\n'
name|'data'
op|'='
string|"'0'"
op|'*'
name|'fsize'
newline|'\n'
name|'etag'
op|'='
name|'md5'
op|'('
op|')'
newline|'\n'
name|'if'
name|'ts'
op|':'
newline|'\n'
indent|'            '
name|'timestamp'
op|'='
name|'ts'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'timestamp'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'prealloc'
op|':'
newline|'\n'
indent|'            '
name|'prealloc_size'
op|'='
name|'fsize'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'prealloc_size'
op|'='
name|'None'
newline|'\n'
dedent|''
name|'with'
name|'df'
op|'.'
name|'create'
op|'('
name|'size'
op|'='
name|'prealloc_size'
op|')'
name|'as'
name|'writer'
op|':'
newline|'\n'
indent|'            '
name|'upload_size'
op|'='
name|'writer'
op|'.'
name|'write'
op|'('
name|'data'
op|')'
newline|'\n'
name|'etag'
op|'.'
name|'update'
op|'('
name|'data'
op|')'
newline|'\n'
name|'etag'
op|'='
name|'etag'
op|'.'
name|'hexdigest'
op|'('
op|')'
newline|'\n'
name|'metadata'
op|'='
op|'{'
nl|'\n'
string|"'ETag'"
op|':'
name|'etag'
op|','
nl|'\n'
string|"'X-Timestamp'"
op|':'
name|'timestamp'
op|','
nl|'\n'
string|"'Content-Length'"
op|':'
name|'str'
op|'('
name|'upload_size'
op|')'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'metadata'
op|'.'
name|'update'
op|'('
name|'extra_metadata'
name|'or'
op|'{'
op|'}'
op|')'
newline|'\n'
name|'writer'
op|'.'
name|'put'
op|'('
name|'metadata'
op|')'
newline|'\n'
name|'if'
name|'invalid_type'
op|'=='
string|"'ETag'"
op|':'
newline|'\n'
indent|'                '
name|'etag'
op|'='
name|'md5'
op|'('
op|')'
newline|'\n'
name|'etag'
op|'.'
name|'update'
op|'('
string|"'1'"
op|'+'
string|"'0'"
op|'*'
op|'('
name|'fsize'
op|'-'
number|'1'
op|')'
op|')'
newline|'\n'
name|'etag'
op|'='
name|'etag'
op|'.'
name|'hexdigest'
op|'('
op|')'
newline|'\n'
name|'metadata'
op|'['
string|"'ETag'"
op|']'
op|'='
name|'etag'
newline|'\n'
name|'diskfile'
op|'.'
name|'write_metadata'
op|'('
name|'writer'
op|'.'
name|'_fd'
op|','
name|'metadata'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'invalid_type'
op|'=='
string|"'Content-Length'"
op|':'
newline|'\n'
indent|'                '
name|'metadata'
op|'['
string|"'Content-Length'"
op|']'
op|'='
name|'fsize'
op|'-'
number|'1'
newline|'\n'
name|'diskfile'
op|'.'
name|'write_metadata'
op|'('
name|'writer'
op|'.'
name|'_fd'
op|','
name|'metadata'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'invalid_type'
op|'=='
string|"'Bad-Content-Length'"
op|':'
newline|'\n'
indent|'                '
name|'metadata'
op|'['
string|"'Content-Length'"
op|']'
op|'='
string|"'zero'"
newline|'\n'
name|'diskfile'
op|'.'
name|'write_metadata'
op|'('
name|'writer'
op|'.'
name|'_fd'
op|','
name|'metadata'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'invalid_type'
op|'=='
string|"'Missing-Content-Length'"
op|':'
newline|'\n'
indent|'                '
name|'del'
name|'metadata'
op|'['
string|"'Content-Length'"
op|']'
newline|'\n'
name|'diskfile'
op|'.'
name|'write_metadata'
op|'('
name|'writer'
op|'.'
name|'_fd'
op|','
name|'metadata'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'invalid_type'
op|'=='
string|"'Bad-X-Delete-At'"
op|':'
newline|'\n'
indent|'                '
name|'metadata'
op|'['
string|"'X-Delete-At'"
op|']'
op|'='
string|"'bad integer'"
newline|'\n'
name|'diskfile'
op|'.'
name|'write_metadata'
op|'('
name|'writer'
op|'.'
name|'_fd'
op|','
name|'metadata'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'mark_deleted'
op|':'
newline|'\n'
indent|'            '
name|'df'
op|'.'
name|'delete'
op|'('
name|'timestamp'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'data_files'
op|'='
op|'['
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|','
name|'fname'
op|')'
nl|'\n'
name|'for'
name|'fname'
name|'in'
name|'sorted'
op|'('
name|'os'
op|'.'
name|'listdir'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
op|','
nl|'\n'
name|'reverse'
op|'='
name|'True'
op|')'
nl|'\n'
name|'if'
name|'fname'
op|'.'
name|'endswith'
op|'('
string|"'.data'"
op|')'
op|']'
newline|'\n'
name|'if'
name|'invalid_type'
op|'=='
string|"'Corrupt-Xattrs'"
op|':'
newline|'\n'
comment|'# We have to go below read_metadata/write_metadata to get proper'
nl|'\n'
comment|'# corruption.'
nl|'\n'
indent|'            '
name|'meta_xattr'
op|'='
name|'xattr'
op|'.'
name|'getxattr'
op|'('
name|'data_files'
op|'['
number|'0'
op|']'
op|','
string|'"user.swift.metadata"'
op|')'
newline|'\n'
name|'wrong_byte'
op|'='
string|"'X'"
name|'if'
name|'meta_xattr'
op|'['
number|'0'
op|']'
op|'!='
string|"'X'"
name|'else'
string|"'Y'"
newline|'\n'
name|'xattr'
op|'.'
name|'setxattr'
op|'('
name|'data_files'
op|'['
number|'0'
op|']'
op|','
string|'"user.swift.metadata"'
op|','
nl|'\n'
name|'wrong_byte'
op|'+'
name|'meta_xattr'
op|'['
number|'1'
op|':'
op|']'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'invalid_type'
op|'=='
string|"'Truncated-Xattrs'"
op|':'
newline|'\n'
indent|'            '
name|'meta_xattr'
op|'='
name|'xattr'
op|'.'
name|'getxattr'
op|'('
name|'data_files'
op|'['
number|'0'
op|']'
op|','
string|'"user.swift.metadata"'
op|')'
newline|'\n'
name|'xattr'
op|'.'
name|'setxattr'
op|'('
name|'data_files'
op|'['
number|'0'
op|']'
op|','
string|'"user.swift.metadata"'
op|','
nl|'\n'
name|'meta_xattr'
op|'['
op|':'
op|'-'
number|'1'
op|']'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'invalid_type'
op|'=='
string|"'Missing-Name'"
op|':'
newline|'\n'
indent|'            '
name|'md'
op|'='
name|'diskfile'
op|'.'
name|'read_metadata'
op|'('
name|'data_files'
op|'['
number|'0'
op|']'
op|')'
newline|'\n'
name|'del'
name|'md'
op|'['
string|"'name'"
op|']'
newline|'\n'
name|'diskfile'
op|'.'
name|'write_metadata'
op|'('
name|'data_files'
op|'['
number|'0'
op|']'
op|','
name|'md'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'invalid_type'
op|'=='
string|"'Bad-Name'"
op|':'
newline|'\n'
indent|'            '
name|'md'
op|'='
name|'diskfile'
op|'.'
name|'read_metadata'
op|'('
name|'data_files'
op|'['
number|'0'
op|']'
op|')'
newline|'\n'
name|'md'
op|'['
string|"'name'"
op|']'
op|'='
name|'md'
op|'['
string|"'name'"
op|']'
op|'+'
string|"'garbage'"
newline|'\n'
name|'diskfile'
op|'.'
name|'write_metadata'
op|'('
name|'data_files'
op|'['
number|'0'
op|']'
op|','
name|'md'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'conf'
op|'['
string|"'disk_chunk_size'"
op|']'
op|'='
name|'csize'
newline|'\n'
name|'self'
op|'.'
name|'conf'
op|'['
string|"'mount_check'"
op|']'
op|'='
name|'mount_check'
newline|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'='
name|'diskfile'
op|'.'
name|'DiskFileManager'
op|'('
name|'self'
op|'.'
name|'conf'
op|','
name|'FakeLogger'
op|'('
op|')'
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
name|'obj'
op|'='
name|'obj_name'
op|')'
newline|'\n'
name|'df'
op|'.'
name|'open'
op|'('
op|')'
newline|'\n'
name|'if'
name|'invalid_type'
op|'=='
string|"'Zero-Byte'"
op|':'
newline|'\n'
indent|'            '
name|'fp'
op|'='
name|'open'
op|'('
name|'df'
op|'.'
name|'_data_file'
op|','
string|"'w'"
op|')'
newline|'\n'
name|'fp'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
dedent|''
name|'df'
op|'.'
name|'unit_test_len'
op|'='
name|'fsize'
newline|'\n'
name|'return'
name|'df'
newline|'\n'
nl|'\n'
DECL|member|test_keep_cache
dedent|''
name|'def'
name|'test_keep_cache'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
name|'fsize'
op|'='
number|'65'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|'"swift.obj.diskfile.drop_buffer_cache"'
op|')'
name|'as'
name|'foo'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'_'
name|'in'
name|'df'
op|'.'
name|'reader'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'pass'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'foo'
op|'.'
name|'called'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'df'
op|'='
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
name|'fsize'
op|'='
number|'65'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|'"swift.obj.diskfile.drop_buffer_cache"'
op|')'
name|'as'
name|'bar'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'_'
name|'in'
name|'df'
op|'.'
name|'reader'
op|'('
name|'keep_cache'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'pass'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'bar'
op|'.'
name|'called'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'df'
op|'='
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
name|'fsize'
op|'='
number|'65'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|'"swift.obj.diskfile.drop_buffer_cache"'
op|')'
name|'as'
name|'boo'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'_'
name|'in'
name|'df'
op|'.'
name|'reader'
op|'('
name|'keep_cache'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'pass'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'boo'
op|'.'
name|'called'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'df'
op|'='
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
name|'fsize'
op|'='
number|'5'
op|'*'
number|'1024'
op|','
name|'csize'
op|'='
number|'256'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|'"swift.obj.diskfile.drop_buffer_cache"'
op|')'
name|'as'
name|'goo'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'_'
name|'in'
name|'df'
op|'.'
name|'reader'
op|'('
name|'keep_cache'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'pass'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'goo'
op|'.'
name|'called'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quarantine_valids
dedent|''
dedent|''
name|'def'
name|'test_quarantine_valids'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|function|verify
indent|'        '
name|'def'
name|'verify'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'df'
op|'='
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
op|'**'
name|'kwargs'
op|')'
newline|'\n'
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
op|')'
newline|'\n'
name|'for'
name|'chunk'
name|'in'
name|'reader'
op|':'
newline|'\n'
indent|'                    '
name|'pass'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'DiskFileQuarantined'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'fail'
op|'('
nl|'\n'
string|'"Unexpected quarantining occurred: args=%r, kwargs=%r"'
op|'%'
op|'('
nl|'\n'
name|'args'
op|','
name|'kwargs'
op|')'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'verify'
op|'('
name|'obj_name'
op|'='
string|"'1'"
op|')'
newline|'\n'
nl|'\n'
name|'verify'
op|'('
name|'obj_name'
op|'='
string|"'2'"
op|','
name|'csize'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'verify'
op|'('
name|'obj_name'
op|'='
string|"'3'"
op|','
name|'csize'
op|'='
number|'100000'
op|')'
newline|'\n'
nl|'\n'
DECL|member|run_quarantine_invalids
dedent|''
name|'def'
name|'run_quarantine_invalids'
op|'('
name|'self'
op|','
name|'invalid_type'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|function|verify
indent|'        '
name|'def'
name|'verify'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'open_exc'
op|'='
name|'invalid_type'
name|'in'
op|'('
string|"'Content-Length'"
op|','
string|"'Bad-Content-Length'"
op|','
nl|'\n'
string|"'Corrupt-Xattrs'"
op|','
string|"'Truncated-Xattrs'"
op|','
nl|'\n'
string|"'Missing-Name'"
op|','
string|"'Bad-X-Delete-At'"
op|')'
newline|'\n'
name|'open_collision'
op|'='
name|'invalid_type'
op|'=='
string|"'Bad-Name'"
newline|'\n'
name|'reader'
op|'='
name|'None'
newline|'\n'
name|'quarantine_msgs'
op|'='
op|'['
op|']'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'df'
op|'='
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
op|'**'
name|'kwargs'
op|')'
newline|'\n'
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
name|'_quarantine_hook'
op|'='
name|'quarantine_msgs'
op|'.'
name|'append'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'DiskFileQuarantined'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'not'
name|'open_exc'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'fail'
op|'('
nl|'\n'
string|'"Unexpected DiskFileQuarantine raised: %r"'
op|'%'
name|'err'
op|')'
newline|'\n'
dedent|''
name|'return'
newline|'\n'
dedent|''
name|'except'
name|'DiskFileCollision'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'not'
name|'open_collision'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'fail'
op|'('
nl|'\n'
string|'"Unexpected DiskFileCollision raised: %r"'
op|'%'
name|'err'
op|')'
newline|'\n'
dedent|''
name|'return'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'open_exc'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'fail'
op|'('
string|'"Expected DiskFileQuarantine exception"'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'for'
name|'chunk'
name|'in'
name|'reader'
op|':'
newline|'\n'
indent|'                    '
name|'pass'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'DiskFileQuarantined'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'fail'
op|'('
string|'"Unexpected DiskFileQuarantine raised: :%r"'
op|'%'
name|'err'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'not'
name|'open_exc'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'len'
op|'('
name|'quarantine_msgs'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
name|'verify'
op|'('
name|'invalid_type'
op|'='
name|'invalid_type'
op|','
name|'obj_name'
op|'='
string|"'1'"
op|')'
newline|'\n'
nl|'\n'
name|'verify'
op|'('
name|'invalid_type'
op|'='
name|'invalid_type'
op|','
name|'obj_name'
op|'='
string|"'2'"
op|','
name|'csize'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'verify'
op|'('
name|'invalid_type'
op|'='
name|'invalid_type'
op|','
name|'obj_name'
op|'='
string|"'3'"
op|','
name|'csize'
op|'='
number|'100000'
op|')'
newline|'\n'
nl|'\n'
name|'verify'
op|'('
name|'invalid_type'
op|'='
name|'invalid_type'
op|','
name|'obj_name'
op|'='
string|"'4'"
op|')'
newline|'\n'
nl|'\n'
DECL|function|verify_air
name|'def'
name|'verify_air'
op|'('
name|'params'
op|','
name|'start'
op|'='
number|'0'
op|','
name|'adjustment'
op|'='
number|'0'
op|')'
op|':'
newline|'\n'
indent|'            '
string|'"""verify (a)pp (i)ter (r)ange"""'
newline|'\n'
name|'open_exc'
op|'='
name|'invalid_type'
name|'in'
op|'('
string|"'Content-Length'"
op|','
string|"'Bad-Content-Length'"
op|','
nl|'\n'
string|"'Corrupt-Xattrs'"
op|','
string|"'Truncated-Xattrs'"
op|','
nl|'\n'
string|"'Missing-Name'"
op|','
string|"'Bad-X-Delete-At'"
op|')'
newline|'\n'
name|'open_collision'
op|'='
name|'invalid_type'
op|'=='
string|"'Bad-Name'"
newline|'\n'
name|'reader'
op|'='
name|'None'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'df'
op|'='
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
op|'**'
name|'params'
op|')'
newline|'\n'
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
op|')'
newline|'\n'
dedent|''
name|'except'
name|'DiskFileQuarantined'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'not'
name|'open_exc'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'fail'
op|'('
nl|'\n'
string|'"Unexpected DiskFileQuarantine raised: %r"'
op|'%'
name|'err'
op|')'
newline|'\n'
dedent|''
name|'return'
newline|'\n'
dedent|''
name|'except'
name|'DiskFileCollision'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'not'
name|'open_collision'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'fail'
op|'('
nl|'\n'
string|'"Unexpected DiskFileCollision raised: %r"'
op|'%'
name|'err'
op|')'
newline|'\n'
dedent|''
name|'return'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'open_exc'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'fail'
op|'('
string|'"Expected DiskFileQuarantine exception"'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'for'
name|'chunk'
name|'in'
name|'reader'
op|'.'
name|'app_iter_range'
op|'('
nl|'\n'
name|'start'
op|','
nl|'\n'
name|'df'
op|'.'
name|'unit_test_len'
op|'+'
name|'adjustment'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'pass'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'DiskFileQuarantined'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'fail'
op|'('
string|'"Unexpected DiskFileQuarantine raised: :%r"'
op|'%'
name|'err'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'verify_air'
op|'('
name|'dict'
op|'('
name|'invalid_type'
op|'='
name|'invalid_type'
op|','
name|'obj_name'
op|'='
string|"'5'"
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'verify_air'
op|'('
name|'dict'
op|'('
name|'invalid_type'
op|'='
name|'invalid_type'
op|','
name|'obj_name'
op|'='
string|"'6'"
op|')'
op|','
number|'0'
op|','
number|'100'
op|')'
newline|'\n'
nl|'\n'
name|'verify_air'
op|'('
name|'dict'
op|'('
name|'invalid_type'
op|'='
name|'invalid_type'
op|','
name|'obj_name'
op|'='
string|"'7'"
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'verify_air'
op|'('
name|'dict'
op|'('
name|'invalid_type'
op|'='
name|'invalid_type'
op|','
name|'obj_name'
op|'='
string|"'8'"
op|')'
op|','
number|'0'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'verify_air'
op|'('
name|'dict'
op|'('
name|'invalid_type'
op|'='
name|'invalid_type'
op|','
name|'obj_name'
op|'='
string|"'8'"
op|')'
op|','
number|'1'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quarantine_corrupt_xattrs
dedent|''
name|'def'
name|'test_quarantine_corrupt_xattrs'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'run_quarantine_invalids'
op|'('
string|"'Corrupt-Xattrs'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quarantine_truncated_xattrs
dedent|''
name|'def'
name|'test_quarantine_truncated_xattrs'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'run_quarantine_invalids'
op|'('
string|"'Truncated-Xattrs'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quarantine_invalid_etag
dedent|''
name|'def'
name|'test_quarantine_invalid_etag'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'run_quarantine_invalids'
op|'('
string|"'ETag'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quarantine_invalid_missing_name
dedent|''
name|'def'
name|'test_quarantine_invalid_missing_name'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'run_quarantine_invalids'
op|'('
string|"'Missing-Name'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quarantine_invalid_bad_name
dedent|''
name|'def'
name|'test_quarantine_invalid_bad_name'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'run_quarantine_invalids'
op|'('
string|"'Bad-Name'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quarantine_invalid_bad_x_delete_at
dedent|''
name|'def'
name|'test_quarantine_invalid_bad_x_delete_at'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'run_quarantine_invalids'
op|'('
string|"'Bad-X-Delete-At'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quarantine_invalid_content_length
dedent|''
name|'def'
name|'test_quarantine_invalid_content_length'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'run_quarantine_invalids'
op|'('
string|"'Content-Length'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quarantine_invalid_content_length_bad
dedent|''
name|'def'
name|'test_quarantine_invalid_content_length_bad'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'run_quarantine_invalids'
op|'('
string|"'Bad-Content-Length'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quarantine_invalid_zero_byte
dedent|''
name|'def'
name|'test_quarantine_invalid_zero_byte'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'run_quarantine_invalids'
op|'('
string|"'Zero-Byte'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quarantine_deleted_files
dedent|''
name|'def'
name|'test_quarantine_deleted_files'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
name|'invalid_type'
op|'='
string|"'Content-Length'"
op|')'
newline|'\n'
dedent|''
name|'except'
name|'DiskFileQuarantined'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'fail'
op|'('
string|'"Expected DiskFileQuarantined exception"'
op|')'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
name|'invalid_type'
op|'='
string|"'Content-Length'"
op|','
nl|'\n'
name|'mark_deleted'
op|'='
name|'True'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'DiskFileQuarantined'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'fail'
op|'('
string|'"Unexpected DiskFileQuarantined exception"'
nl|'\n'
string|'" encountered: %r"'
op|'%'
name|'err'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'DiskFileNotExist'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'fail'
op|'('
string|'"Expected DiskFileNotExist exception"'
op|')'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
name|'invalid_type'
op|'='
string|"'Content-Length'"
op|','
nl|'\n'
name|'mark_deleted'
op|'='
name|'True'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'DiskFileNotExist'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'fail'
op|'('
string|'"Expected DiskFileNotExist exception"'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quarantine_missing_content_length
dedent|''
dedent|''
name|'def'
name|'test_quarantine_missing_content_length'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertRaises'
op|'('
nl|'\n'
name|'DiskFileQuarantined'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_get_open_disk_file'
op|','
nl|'\n'
name|'invalid_type'
op|'='
string|"'Missing-Content-Length'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quarantine_bad_content_length
dedent|''
name|'def'
name|'test_quarantine_bad_content_length'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertRaises'
op|'('
nl|'\n'
name|'DiskFileQuarantined'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_get_open_disk_file'
op|','
nl|'\n'
name|'invalid_type'
op|'='
string|"'Bad-Content-Length'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quarantine_fstat_oserror
dedent|''
name|'def'
name|'test_quarantine_fstat_oserror'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'invocations'
op|'='
op|'['
number|'0'
op|']'
newline|'\n'
name|'orig_os_fstat'
op|'='
name|'os'
op|'.'
name|'fstat'
newline|'\n'
nl|'\n'
DECL|function|bad_fstat
name|'def'
name|'bad_fstat'
op|'('
name|'fd'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'invocations'
op|'['
number|'0'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'if'
name|'invocations'
op|'['
number|'0'
op|']'
op|'=='
number|'4'
op|':'
newline|'\n'
comment|'# FIXME - yes, this an icky way to get code coverage ... worth'
nl|'\n'
comment|'# it?'
nl|'\n'
indent|'                '
name|'raise'
name|'OSError'
op|'('
op|')'
newline|'\n'
dedent|''
name|'return'
name|'orig_os_fstat'
op|'('
name|'fd'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.fstat'"
op|','
name|'bad_fstat'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertRaises'
op|'('
nl|'\n'
name|'DiskFileQuarantined'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_get_open_disk_file'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quarantine_hashdir_not_a_directory
dedent|''
dedent|''
name|'def'
name|'test_quarantine_hashdir_not_a_directory'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_test_file'
op|'('
string|"'1234567890'"
op|','
name|'account'
op|'='
string|'"abc"'
op|','
nl|'\n'
name|'container'
op|'='
string|"'123'"
op|','
name|'obj'
op|'='
string|"'xyz'"
op|')'
newline|'\n'
name|'hashdir'
op|'='
name|'df'
op|'.'
name|'_datadir'
newline|'\n'
name|'rmtree'
op|'('
name|'hashdir'
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
name|'hashdir'
op|','
string|"'w'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'df'
op|'='
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile'
op|'('
name|'self'
op|'.'
name|'existing_device'
op|','
string|"'0'"
op|','
string|"'abc'"
op|','
string|"'123'"
op|','
nl|'\n'
string|"'xyz'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'DiskFileQuarantined'
op|','
name|'df'
op|'.'
name|'open'
op|')'
newline|'\n'
nl|'\n'
comment|'# make sure the right thing got quarantined; the suffix dir should not'
nl|'\n'
comment|'# have moved, as that could have many objects in it'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'hashdir'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'dirname'
op|'('
name|'hashdir'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_prealloc
dedent|''
name|'def'
name|'test_create_prealloc'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile'
op|'('
name|'self'
op|'.'
name|'existing_device'
op|','
string|"'0'"
op|','
string|"'abc'"
op|','
string|"'123'"
op|','
nl|'\n'
string|"'xyz'"
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|'"swift.obj.diskfile.fallocate"'
op|')'
name|'as'
name|'fa'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'df'
op|'.'
name|'create'
op|'('
name|'size'
op|'='
number|'200'
op|')'
name|'as'
name|'writer'
op|':'
newline|'\n'
indent|'                '
name|'used_fd'
op|'='
name|'writer'
op|'.'
name|'_fd'
newline|'\n'
dedent|''
dedent|''
name|'fa'
op|'.'
name|'assert_called_with'
op|'('
name|'used_fd'
op|','
number|'200'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_prealloc_oserror
dedent|''
name|'def'
name|'test_create_prealloc_oserror'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile'
op|'('
name|'self'
op|'.'
name|'existing_device'
op|','
string|"'0'"
op|','
string|"'abc'"
op|','
string|"'123'"
op|','
nl|'\n'
string|"'xyz'"
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|'"swift.obj.diskfile.fallocate"'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'side_effect'
op|'='
name|'OSError'
op|'('
nl|'\n'
name|'errno'
op|'.'
name|'EACCES'
op|','
name|'os'
op|'.'
name|'strerror'
op|'('
name|'errno'
op|'.'
name|'EACCES'
op|')'
op|')'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'with'
name|'df'
op|'.'
name|'create'
op|'('
name|'size'
op|'='
number|'200'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'pass'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'DiskFileNoSpace'
op|':'
newline|'\n'
indent|'                '
name|'pass'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'fail'
op|'('
string|'"Expected exception DiskFileNoSpace"'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_close_oserror
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_create_close_oserror'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile'
op|'('
name|'self'
op|'.'
name|'existing_device'
op|','
string|"'0'"
op|','
string|"'abc'"
op|','
string|"'123'"
op|','
nl|'\n'
string|"'xyz'"
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|'"swift.obj.diskfile.os.close"'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'side_effect'
op|'='
name|'OSError'
op|'('
nl|'\n'
name|'errno'
op|'.'
name|'EACCES'
op|','
name|'os'
op|'.'
name|'strerror'
op|'('
name|'errno'
op|'.'
name|'EACCES'
op|')'
op|')'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'with'
name|'df'
op|'.'
name|'create'
op|'('
name|'size'
op|'='
number|'200'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'pass'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'Exception'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'fail'
op|'('
string|'"Unexpected exception raised: %r"'
op|'%'
name|'err'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'pass'
newline|'\n'
nl|'\n'
DECL|member|test_write_metadata
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_write_metadata'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_create_test_file'
op|'('
string|"'1234567890'"
op|')'
newline|'\n'
name|'timestamp'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|')'
newline|'\n'
name|'metadata'
op|'='
op|'{'
string|"'X-Timestamp'"
op|':'
name|'timestamp'
op|','
string|"'X-Object-Meta-test'"
op|':'
string|"'data'"
op|'}'
newline|'\n'
name|'df'
op|'.'
name|'write_metadata'
op|'('
name|'metadata'
op|')'
newline|'\n'
name|'dl'
op|'='
name|'os'
op|'.'
name|'listdir'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'dl'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'exp_name'
op|'='
string|"'%s.meta'"
op|'%'
name|'timestamp'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'exp_name'
name|'in'
name|'set'
op|'('
name|'dl'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_delete
dedent|''
name|'def'
name|'test_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
op|')'
newline|'\n'
name|'ts'
op|'='
name|'time'
op|'('
op|')'
newline|'\n'
name|'df'
op|'.'
name|'delete'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'exp_name'
op|'='
string|"'%s.ts'"
op|'%'
name|'str'
op|'('
name|'normalize_timestamp'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'dl'
op|'='
name|'os'
op|'.'
name|'listdir'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'dl'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'exp_name'
name|'in'
name|'set'
op|'('
name|'dl'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_open_deleted
dedent|''
name|'def'
name|'test_open_deleted'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
op|')'
newline|'\n'
name|'ts'
op|'='
name|'time'
op|'('
op|')'
newline|'\n'
name|'df'
op|'.'
name|'delete'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'exp_name'
op|'='
string|"'%s.ts'"
op|'%'
name|'str'
op|'('
name|'normalize_timestamp'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'dl'
op|'='
name|'os'
op|'.'
name|'listdir'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'dl'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'exp_name'
name|'in'
name|'set'
op|'('
name|'dl'
op|')'
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'DiskFileDeleted'
op|','
name|'df'
op|'.'
name|'open'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_open_deleted_with_corrupt_tombstone
dedent|''
name|'def'
name|'test_open_deleted_with_corrupt_tombstone'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
op|')'
newline|'\n'
name|'ts'
op|'='
name|'time'
op|'('
op|')'
newline|'\n'
name|'df'
op|'.'
name|'delete'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'exp_name'
op|'='
string|"'%s.ts'"
op|'%'
name|'str'
op|'('
name|'normalize_timestamp'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'dl'
op|'='
name|'os'
op|'.'
name|'listdir'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'dl'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'exp_name'
name|'in'
name|'set'
op|'('
name|'dl'
op|')'
op|')'
newline|'\n'
comment|"# it's pickle-format, so removing the last byte is sufficient to"
nl|'\n'
comment|'# corrupt it'
nl|'\n'
name|'ts_fullpath'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|','
name|'exp_name'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'ts_fullpath'
op|')'
op|')'
comment|'# sanity check'
newline|'\n'
name|'meta_xattr'
op|'='
name|'xattr'
op|'.'
name|'getxattr'
op|'('
name|'ts_fullpath'
op|','
string|'"user.swift.metadata"'
op|')'
newline|'\n'
name|'xattr'
op|'.'
name|'setxattr'
op|'('
name|'ts_fullpath'
op|','
string|'"user.swift.metadata"'
op|','
name|'meta_xattr'
op|'['
op|':'
op|'-'
number|'1'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'DiskFileNotExist'
op|','
name|'df'
op|'.'
name|'open'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'ts_fullpath'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_from_audit_location
dedent|''
name|'def'
name|'test_from_audit_location'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'hashdir'
op|'='
name|'self'
op|'.'
name|'_create_test_file'
op|'('
nl|'\n'
string|"'blah blah'"
op|','
nl|'\n'
name|'account'
op|'='
string|"'three'"
op|','
name|'container'
op|'='
string|"'blind'"
op|','
name|'obj'
op|'='
string|"'mice'"
op|')'
op|'.'
name|'_datadir'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile_from_audit_location'
op|'('
nl|'\n'
name|'diskfile'
op|'.'
name|'AuditLocation'
op|'('
name|'hashdir'
op|','
name|'self'
op|'.'
name|'existing_device'
op|','
string|"'0'"
op|')'
op|')'
newline|'\n'
name|'df'
op|'.'
name|'open'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'df'
op|'.'
name|'_name'
op|','
string|"'/three/blind/mice'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_from_audit_location_with_mismatched_hash
dedent|''
name|'def'
name|'test_from_audit_location_with_mismatched_hash'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'hashdir'
op|'='
name|'self'
op|'.'
name|'_create_test_file'
op|'('
nl|'\n'
string|"'blah blah'"
op|','
nl|'\n'
name|'account'
op|'='
string|"'this'"
op|','
name|'container'
op|'='
string|"'is'"
op|','
name|'obj'
op|'='
string|"'right'"
op|')'
op|'.'
name|'_datadir'
newline|'\n'
nl|'\n'
name|'datafile'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'hashdir'
op|','
name|'os'
op|'.'
name|'listdir'
op|'('
name|'hashdir'
op|')'
op|'['
number|'0'
op|']'
op|')'
newline|'\n'
name|'meta'
op|'='
name|'diskfile'
op|'.'
name|'read_metadata'
op|'('
name|'datafile'
op|')'
newline|'\n'
name|'meta'
op|'['
string|"'name'"
op|']'
op|'='
string|"'/this/is/wrong'"
newline|'\n'
name|'diskfile'
op|'.'
name|'write_metadata'
op|'('
name|'datafile'
op|','
name|'meta'
op|')'
newline|'\n'
nl|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile_from_audit_location'
op|'('
nl|'\n'
name|'diskfile'
op|'.'
name|'AuditLocation'
op|'('
name|'hashdir'
op|','
name|'self'
op|'.'
name|'existing_device'
op|','
string|"'0'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'DiskFileQuarantined'
op|','
name|'df'
op|'.'
name|'open'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_close_error
dedent|''
name|'def'
name|'test_close_error'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|function|mock_handle_close_quarantine
indent|'        '
name|'def'
name|'mock_handle_close_quarantine'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'Exception'
op|'('
string|'"Bad"'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'df'
op|'='
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
name|'fsize'
op|'='
number|'1024'
op|'*'
number|'1024'
op|'*'
number|'2'
op|','
name|'csize'
op|'='
number|'1024'
op|')'
newline|'\n'
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
op|')'
newline|'\n'
name|'reader'
op|'.'
name|'_handle_close_quarantine'
op|'='
name|'mock_handle_close_quarantine'
newline|'\n'
name|'for'
name|'chunk'
name|'in'
name|'reader'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
comment|'# close is called at the end of the iterator'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'reader'
op|'.'
name|'_fp'
op|','
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'df'
op|'.'
name|'_logger'
op|'.'
name|'log_dict'
op|'['
string|"'error'"
op|']'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_mount_checking
dedent|''
name|'def'
name|'test_mount_checking'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|function|_mock_cm
indent|'        '
name|'def'
name|'_mock_cm'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'False'
newline|'\n'
nl|'\n'
dedent|''
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|'"swift.common.constraints.check_mount"'
op|','
name|'_mock_cm'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertRaises'
op|'('
nl|'\n'
name|'DiskFileDeviceUnavailable'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_get_open_disk_file'
op|','
nl|'\n'
name|'mount_check'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_ondisk_search_loop_ts_meta_data
dedent|''
dedent|''
name|'def'
name|'test_ondisk_search_loop_ts_meta_data'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.ts'"
op|','
name|'timestamp'
op|'='
number|'10'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.ts'"
op|','
name|'timestamp'
op|'='
number|'9'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.meta'"
op|','
name|'timestamp'
op|'='
number|'8'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.meta'"
op|','
name|'timestamp'
op|'='
number|'7'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"'B'"
op|','
name|'ext'
op|'='
string|"'.data'"
op|','
name|'timestamp'
op|'='
number|'6'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"'A'"
op|','
name|'ext'
op|'='
string|"'.data'"
op|','
name|'timestamp'
op|'='
number|'5'
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'df'
op|'.'
name|'open'
op|'('
op|')'
newline|'\n'
dedent|''
name|'except'
name|'DiskFileDeleted'
name|'as'
name|'d'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'d'
op|'.'
name|'timestamp'
op|','
name|'normalize_timestamp'
op|'('
number|'10'
op|')'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'fail'
op|'('
string|'"Expected DiskFileDeleted exception"'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_ondisk_search_loop_meta_ts_data
dedent|''
dedent|''
name|'def'
name|'test_ondisk_search_loop_meta_ts_data'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.meta'"
op|','
name|'timestamp'
op|'='
number|'10'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.meta'"
op|','
name|'timestamp'
op|'='
number|'9'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.ts'"
op|','
name|'timestamp'
op|'='
number|'8'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.ts'"
op|','
name|'timestamp'
op|'='
number|'7'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"'B'"
op|','
name|'ext'
op|'='
string|"'.data'"
op|','
name|'timestamp'
op|'='
number|'6'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"'A'"
op|','
name|'ext'
op|'='
string|"'.data'"
op|','
name|'timestamp'
op|'='
number|'5'
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'df'
op|'.'
name|'open'
op|'('
op|')'
newline|'\n'
dedent|''
name|'except'
name|'DiskFileDeleted'
name|'as'
name|'d'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'d'
op|'.'
name|'timestamp'
op|','
name|'normalize_timestamp'
op|'('
number|'8'
op|')'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'fail'
op|'('
string|'"Expected DiskFileDeleted exception"'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_ondisk_search_loop_meta_data_ts
dedent|''
dedent|''
name|'def'
name|'test_ondisk_search_loop_meta_data_ts'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.meta'"
op|','
name|'timestamp'
op|'='
number|'10'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.meta'"
op|','
name|'timestamp'
op|'='
number|'9'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"'B'"
op|','
name|'ext'
op|'='
string|"'.data'"
op|','
name|'timestamp'
op|'='
number|'8'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"'A'"
op|','
name|'ext'
op|'='
string|"'.data'"
op|','
name|'timestamp'
op|'='
number|'7'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.ts'"
op|','
name|'timestamp'
op|'='
number|'6'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.ts'"
op|','
name|'timestamp'
op|'='
number|'5'
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'with'
name|'df'
op|'.'
name|'open'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'X-Timestamp'"
name|'in'
name|'df'
op|'.'
name|'_metadata'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'df'
op|'.'
name|'_metadata'
op|'['
string|"'X-Timestamp'"
op|']'
op|','
nl|'\n'
name|'normalize_timestamp'
op|'('
number|'10'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'deleted'"
name|'not'
name|'in'
name|'df'
op|'.'
name|'_metadata'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_ondisk_search_loop_data_meta_ts
dedent|''
dedent|''
name|'def'
name|'test_ondisk_search_loop_data_meta_ts'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"'B'"
op|','
name|'ext'
op|'='
string|"'.data'"
op|','
name|'timestamp'
op|'='
number|'10'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"'A'"
op|','
name|'ext'
op|'='
string|"'.data'"
op|','
name|'timestamp'
op|'='
number|'9'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.ts'"
op|','
name|'timestamp'
op|'='
number|'8'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.ts'"
op|','
name|'timestamp'
op|'='
number|'7'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.meta'"
op|','
name|'timestamp'
op|'='
number|'6'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.meta'"
op|','
name|'timestamp'
op|'='
number|'5'
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'with'
name|'df'
op|'.'
name|'open'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'X-Timestamp'"
name|'in'
name|'df'
op|'.'
name|'_metadata'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'df'
op|'.'
name|'_metadata'
op|'['
string|"'X-Timestamp'"
op|']'
op|','
nl|'\n'
name|'normalize_timestamp'
op|'('
number|'10'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'deleted'"
name|'not'
name|'in'
name|'df'
op|'.'
name|'_metadata'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_ondisk_search_loop_wayward_files_ignored
dedent|''
dedent|''
name|'def'
name|'test_ondisk_search_loop_wayward_files_ignored'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"'X'"
op|','
name|'ext'
op|'='
string|"'.bar'"
op|','
name|'timestamp'
op|'='
number|'11'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"'B'"
op|','
name|'ext'
op|'='
string|"'.data'"
op|','
name|'timestamp'
op|'='
number|'10'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"'A'"
op|','
name|'ext'
op|'='
string|"'.data'"
op|','
name|'timestamp'
op|'='
number|'9'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.ts'"
op|','
name|'timestamp'
op|'='
number|'8'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.ts'"
op|','
name|'timestamp'
op|'='
number|'7'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.meta'"
op|','
name|'timestamp'
op|'='
number|'6'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.meta'"
op|','
name|'timestamp'
op|'='
number|'5'
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'with'
name|'df'
op|'.'
name|'open'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'X-Timestamp'"
name|'in'
name|'df'
op|'.'
name|'_metadata'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'df'
op|'.'
name|'_metadata'
op|'['
string|"'X-Timestamp'"
op|']'
op|','
nl|'\n'
name|'normalize_timestamp'
op|'('
number|'10'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'deleted'"
name|'not'
name|'in'
name|'df'
op|'.'
name|'_metadata'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_ondisk_search_loop_listdir_error
dedent|''
dedent|''
name|'def'
name|'test_ondisk_search_loop_listdir_error'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|mock_listdir_exp
name|'def'
name|'mock_listdir_exp'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'OSError'
op|'('
name|'errno'
op|'.'
name|'EACCES'
op|','
name|'os'
op|'.'
name|'strerror'
op|'('
name|'errno'
op|'.'
name|'EACCES'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|'"os.listdir"'
op|','
name|'mock_listdir_exp'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"'X'"
op|','
name|'ext'
op|'='
string|"'.bar'"
op|','
name|'timestamp'
op|'='
number|'11'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"'B'"
op|','
name|'ext'
op|'='
string|"'.data'"
op|','
name|'timestamp'
op|'='
number|'10'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"'A'"
op|','
name|'ext'
op|'='
string|"'.data'"
op|','
name|'timestamp'
op|'='
number|'9'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.ts'"
op|','
name|'timestamp'
op|'='
number|'8'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.ts'"
op|','
name|'timestamp'
op|'='
number|'7'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.meta'"
op|','
name|'timestamp'
op|'='
number|'6'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_ondisk_file'
op|'('
name|'df'
op|','
string|"''"
op|','
name|'ext'
op|'='
string|"'.meta'"
op|','
name|'timestamp'
op|'='
number|'5'
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'DiskFileError'
op|','
name|'df'
op|'.'
name|'open'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_exception_in_handle_close_quarantine
dedent|''
dedent|''
name|'def'
name|'test_exception_in_handle_close_quarantine'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|blow_up
name|'def'
name|'blow_up'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'Exception'
op|'('
string|"'a very special error'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'reader'
op|'='
name|'df'
op|'.'
name|'reader'
op|'('
op|')'
newline|'\n'
name|'reader'
op|'.'
name|'_handle_close_quarantine'
op|'='
name|'blow_up'
newline|'\n'
name|'for'
name|'_'
name|'in'
name|'reader'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'reader'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'log_lines'
op|'='
name|'df'
op|'.'
name|'_logger'
op|'.'
name|'get_lines_for_level'
op|'('
string|"'error'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assert_'
op|'('
string|"'a very special error'"
name|'in'
name|'log_lines'
op|'['
op|'-'
number|'1'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_diskfile_from_hash_dev_path_fail
dedent|''
name|'def'
name|'test_get_diskfile_from_hash_dev_path_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_dev_path'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'return_value'
op|'='
name|'None'
op|')'
newline|'\n'
name|'with'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.DiskFile'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.hash_cleanup_listdir'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.read_metadata'"
op|')'
op|')'
name|'as'
op|'('
name|'dfclass'
op|','
name|'hclistdir'
op|','
name|'readmeta'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'hclistdir'
op|'.'
name|'return_value'
op|'='
op|'['
string|"'1381679759.90941.data'"
op|']'
newline|'\n'
name|'readmeta'
op|'.'
name|'return_value'
op|'='
op|'{'
string|"'name'"
op|':'
string|"'/a/c/o'"
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
nl|'\n'
name|'DiskFileDeviceUnavailable'
op|','
nl|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile_from_hash'
op|','
nl|'\n'
string|"'dev'"
op|','
string|"'9'"
op|','
string|"'9a7175077c01a23ade5956b8a2bba900'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_diskfile_from_hash_not_dir
dedent|''
dedent|''
name|'def'
name|'test_get_diskfile_from_hash_not_dir'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_dev_path'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'return_value'
op|'='
string|"'/srv/dev/'"
op|')'
newline|'\n'
name|'with'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.DiskFile'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.hash_cleanup_listdir'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.read_metadata'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.quarantine_renamer'"
op|')'
op|')'
name|'as'
op|'('
name|'dfclass'
op|','
name|'hclistdir'
op|','
name|'readmeta'
op|','
name|'quarantine_renamer'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'osexc'
op|'='
name|'OSError'
op|'('
op|')'
newline|'\n'
name|'osexc'
op|'.'
name|'errno'
op|'='
name|'errno'
op|'.'
name|'ENOTDIR'
newline|'\n'
name|'hclistdir'
op|'.'
name|'side_effect'
op|'='
name|'osexc'
newline|'\n'
name|'readmeta'
op|'.'
name|'return_value'
op|'='
op|'{'
string|"'name'"
op|':'
string|"'/a/c/o'"
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
nl|'\n'
name|'DiskFileNotExist'
op|','
nl|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile_from_hash'
op|','
nl|'\n'
string|"'dev'"
op|','
string|"'9'"
op|','
string|"'9a7175077c01a23ade5956b8a2bba900'"
op|')'
newline|'\n'
name|'quarantine_renamer'
op|'.'
name|'assert_called_once_with'
op|'('
nl|'\n'
string|"'/srv/dev/'"
op|','
nl|'\n'
string|"'/srv/dev/objects/9/900/9a7175077c01a23ade5956b8a2bba900'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_diskfile_from_hash_no_dir
dedent|''
dedent|''
name|'def'
name|'test_get_diskfile_from_hash_no_dir'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_dev_path'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'return_value'
op|'='
string|"'/srv/dev/'"
op|')'
newline|'\n'
name|'with'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.DiskFile'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.hash_cleanup_listdir'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.read_metadata'"
op|')'
op|')'
name|'as'
op|'('
name|'dfclass'
op|','
name|'hclistdir'
op|','
name|'readmeta'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'osexc'
op|'='
name|'OSError'
op|'('
op|')'
newline|'\n'
name|'osexc'
op|'.'
name|'errno'
op|'='
name|'errno'
op|'.'
name|'ENOENT'
newline|'\n'
name|'hclistdir'
op|'.'
name|'side_effect'
op|'='
name|'osexc'
newline|'\n'
name|'readmeta'
op|'.'
name|'return_value'
op|'='
op|'{'
string|"'name'"
op|':'
string|"'/a/c/o'"
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
nl|'\n'
name|'DiskFileNotExist'
op|','
nl|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile_from_hash'
op|','
nl|'\n'
string|"'dev'"
op|','
string|"'9'"
op|','
string|"'9a7175077c01a23ade5956b8a2bba900'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_diskfile_from_hash_other_oserror
dedent|''
dedent|''
name|'def'
name|'test_get_diskfile_from_hash_other_oserror'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_dev_path'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'return_value'
op|'='
string|"'/srv/dev/'"
op|')'
newline|'\n'
name|'with'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.DiskFile'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.hash_cleanup_listdir'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.read_metadata'"
op|')'
op|')'
name|'as'
op|'('
name|'dfclass'
op|','
name|'hclistdir'
op|','
name|'readmeta'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'osexc'
op|'='
name|'OSError'
op|'('
op|')'
newline|'\n'
name|'hclistdir'
op|'.'
name|'side_effect'
op|'='
name|'osexc'
newline|'\n'
name|'readmeta'
op|'.'
name|'return_value'
op|'='
op|'{'
string|"'name'"
op|':'
string|"'/a/c/o'"
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
nl|'\n'
name|'OSError'
op|','
nl|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile_from_hash'
op|','
nl|'\n'
string|"'dev'"
op|','
string|"'9'"
op|','
string|"'9a7175077c01a23ade5956b8a2bba900'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_diskfile_from_hash_no_actual_files
dedent|''
dedent|''
name|'def'
name|'test_get_diskfile_from_hash_no_actual_files'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_dev_path'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'return_value'
op|'='
string|"'/srv/dev/'"
op|')'
newline|'\n'
name|'with'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.DiskFile'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.hash_cleanup_listdir'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.read_metadata'"
op|')'
op|')'
name|'as'
op|'('
name|'dfclass'
op|','
name|'hclistdir'
op|','
name|'readmeta'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'hclistdir'
op|'.'
name|'return_value'
op|'='
op|'['
op|']'
newline|'\n'
name|'readmeta'
op|'.'
name|'return_value'
op|'='
op|'{'
string|"'name'"
op|':'
string|"'/a/c/o'"
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
nl|'\n'
name|'DiskFileNotExist'
op|','
nl|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile_from_hash'
op|','
nl|'\n'
string|"'dev'"
op|','
string|"'9'"
op|','
string|"'9a7175077c01a23ade5956b8a2bba900'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_diskfile_from_hash_read_metadata_problem
dedent|''
dedent|''
name|'def'
name|'test_get_diskfile_from_hash_read_metadata_problem'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_dev_path'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'return_value'
op|'='
string|"'/srv/dev/'"
op|')'
newline|'\n'
name|'with'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.DiskFile'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.hash_cleanup_listdir'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.read_metadata'"
op|')'
op|')'
name|'as'
op|'('
name|'dfclass'
op|','
name|'hclistdir'
op|','
name|'readmeta'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'hclistdir'
op|'.'
name|'return_value'
op|'='
op|'['
string|"'1381679759.90941.data'"
op|']'
newline|'\n'
name|'readmeta'
op|'.'
name|'side_effect'
op|'='
name|'EOFError'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
nl|'\n'
name|'DiskFileNotExist'
op|','
nl|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile_from_hash'
op|','
nl|'\n'
string|"'dev'"
op|','
string|"'9'"
op|','
string|"'9a7175077c01a23ade5956b8a2bba900'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_diskfile_from_hash_no_meta_name
dedent|''
dedent|''
name|'def'
name|'test_get_diskfile_from_hash_no_meta_name'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_dev_path'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'return_value'
op|'='
string|"'/srv/dev/'"
op|')'
newline|'\n'
name|'with'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.DiskFile'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.hash_cleanup_listdir'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.read_metadata'"
op|')'
op|')'
name|'as'
op|'('
name|'dfclass'
op|','
name|'hclistdir'
op|','
name|'readmeta'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'hclistdir'
op|'.'
name|'return_value'
op|'='
op|'['
string|"'1381679759.90941.data'"
op|']'
newline|'\n'
name|'readmeta'
op|'.'
name|'return_value'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile_from_hash'
op|'('
nl|'\n'
string|"'dev'"
op|','
string|"'9'"
op|','
string|"'9a7175077c01a23ade5956b8a2bba900'"
op|')'
newline|'\n'
dedent|''
name|'except'
name|'DiskFileNotExist'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'exc'
op|'='
name|'err'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'exc'
op|')'
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_diskfile_from_hash_bad_meta_name
dedent|''
dedent|''
name|'def'
name|'test_get_diskfile_from_hash_bad_meta_name'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_dev_path'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'return_value'
op|'='
string|"'/srv/dev/'"
op|')'
newline|'\n'
name|'with'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.DiskFile'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.hash_cleanup_listdir'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.read_metadata'"
op|')'
op|')'
name|'as'
op|'('
name|'dfclass'
op|','
name|'hclistdir'
op|','
name|'readmeta'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'hclistdir'
op|'.'
name|'return_value'
op|'='
op|'['
string|"'1381679759.90941.data'"
op|']'
newline|'\n'
name|'readmeta'
op|'.'
name|'return_value'
op|'='
op|'{'
string|"'name'"
op|':'
string|"'bad'"
op|'}'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile_from_hash'
op|'('
nl|'\n'
string|"'dev'"
op|','
string|"'9'"
op|','
string|"'9a7175077c01a23ade5956b8a2bba900'"
op|')'
newline|'\n'
dedent|''
name|'except'
name|'DiskFileNotExist'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'exc'
op|'='
name|'err'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'exc'
op|')'
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_diskfile_from_hash
dedent|''
dedent|''
name|'def'
name|'test_get_diskfile_from_hash'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_dev_path'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'return_value'
op|'='
string|"'/srv/dev/'"
op|')'
newline|'\n'
name|'with'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.DiskFile'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.hash_cleanup_listdir'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.obj.diskfile.read_metadata'"
op|')'
op|')'
name|'as'
op|'('
name|'dfclass'
op|','
name|'hclistdir'
op|','
name|'readmeta'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'hclistdir'
op|'.'
name|'return_value'
op|'='
op|'['
string|"'1381679759.90941.data'"
op|']'
newline|'\n'
name|'readmeta'
op|'.'
name|'return_value'
op|'='
op|'{'
string|"'name'"
op|':'
string|"'/a/c/o'"
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_diskfile_from_hash'
op|'('
nl|'\n'
string|"'dev'"
op|','
string|"'9'"
op|','
string|"'9a7175077c01a23ade5956b8a2bba900'"
op|')'
newline|'\n'
name|'dfclass'
op|'.'
name|'assert_called_once_with'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|','
string|"'/srv/dev/'"
op|','
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'threadpools'
op|'['
string|"'dev'"
op|']'
op|','
string|"'9'"
op|','
nl|'\n'
string|"'a'"
op|','
string|"'c'"
op|','
string|"'o'"
op|')'
newline|'\n'
name|'hclistdir'
op|'.'
name|'assert_called_once_with'
op|'('
nl|'\n'
string|"'/srv/dev/objects/9/900/9a7175077c01a23ade5956b8a2bba900'"
op|','
nl|'\n'
number|'604800'
op|')'
newline|'\n'
name|'readmeta'
op|'.'
name|'assert_called_once_with'
op|'('
nl|'\n'
string|"'/srv/dev/objects/9/900/9a7175077c01a23ade5956b8a2bba900/'"
nl|'\n'
string|"'1381679759.90941.data'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_listdir_enoent
dedent|''
dedent|''
name|'def'
name|'test_listdir_enoent'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'oserror'
op|'='
name|'OSError'
op|'('
op|')'
newline|'\n'
name|'oserror'
op|'.'
name|'errno'
op|'='
name|'errno'
op|'.'
name|'ENOENT'
newline|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.listdir'"
op|','
name|'side_effect'
op|'='
name|'oserror'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'_listdir'
op|'('
string|"'path'"
op|')'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'.'
name|'mock_calls'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_listdir_other_oserror
dedent|''
dedent|''
name|'def'
name|'test_listdir_other_oserror'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'oserror'
op|'='
name|'OSError'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.listdir'"
op|','
name|'side_effect'
op|'='
name|'oserror'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'_listdir'
op|'('
string|"'path'"
op|')'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'.'
name|'assert_called_once_with'
op|'('
nl|'\n'
string|"'ERROR: Skipping %r due to error with listdir attempt: %s'"
op|','
nl|'\n'
string|"'path'"
op|','
name|'oserror'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_listdir
dedent|''
dedent|''
name|'def'
name|'test_listdir'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.listdir'"
op|','
name|'return_value'
op|'='
op|'['
string|"'abc'"
op|','
string|"'def'"
op|']'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'_listdir'
op|'('
string|"'path'"
op|')'
op|','
op|'['
string|"'abc'"
op|','
string|"'def'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'logger'
op|'.'
name|'error'
op|'.'
name|'mock_calls'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_yield_suffixes_dev_path_fail
dedent|''
dedent|''
name|'def'
name|'test_yield_suffixes_dev_path_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_dev_path'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'return_value'
op|'='
name|'None'
op|')'
newline|'\n'
name|'exc'
op|'='
name|'None'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'list'
op|'('
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'yield_suffixes'
op|'('
string|"'dev'"
op|','
string|"'9'"
op|')'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'DiskFileDeviceUnavailable'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'exc'
op|'='
name|'err'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'exc'
op|')'
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_yield_suffixes
dedent|''
name|'def'
name|'test_yield_suffixes'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'_listdir'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'return_value'
op|'='
op|'['
nl|'\n'
string|"'abc'"
op|','
string|"'def'"
op|','
string|"'ghi'"
op|','
string|"'abcd'"
op|','
string|"'012'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'list'
op|'('
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'yield_suffixes'
op|'('
string|"'dev'"
op|','
string|"'9'"
op|')'
op|')'
op|','
nl|'\n'
op|'['
op|'('
name|'self'
op|'.'
name|'testdir'
op|'+'
string|"'/dev/objects/9/abc'"
op|','
string|"'abc'"
op|')'
op|','
nl|'\n'
op|'('
name|'self'
op|'.'
name|'testdir'
op|'+'
string|"'/dev/objects/9/def'"
op|','
string|"'def'"
op|')'
op|','
nl|'\n'
op|'('
name|'self'
op|'.'
name|'testdir'
op|'+'
string|"'/dev/objects/9/012'"
op|','
string|"'012'"
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_yield_hashes_dev_path_fail
dedent|''
name|'def'
name|'test_yield_hashes_dev_path_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'get_dev_path'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'return_value'
op|'='
name|'None'
op|')'
newline|'\n'
name|'exc'
op|'='
name|'None'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'list'
op|'('
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'yield_hashes'
op|'('
string|"'dev'"
op|','
string|"'9'"
op|')'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'DiskFileDeviceUnavailable'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'exc'
op|'='
name|'err'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'exc'
op|')'
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_yield_hashes_empty
dedent|''
name|'def'
name|'test_yield_hashes_empty'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|_listdir
indent|'        '
name|'def'
name|'_listdir'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'['
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.listdir'"
op|','
name|'_listdir'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'list'
op|'('
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'yield_hashes'
op|'('
string|"'dev'"
op|','
string|"'9'"
op|')'
op|')'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_yield_hashes_empty_suffixes
dedent|''
dedent|''
name|'def'
name|'test_yield_hashes_empty_suffixes'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|_listdir
indent|'        '
name|'def'
name|'_listdir'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'['
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.listdir'"
op|','
name|'_listdir'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'list'
op|'('
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'yield_hashes'
op|'('
string|"'dev'"
op|','
string|"'9'"
op|','
name|'suffixes'
op|'='
op|'['
string|"'456'"
op|']'
op|')'
op|')'
op|','
nl|'\n'
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_yield_hashes
dedent|''
dedent|''
name|'def'
name|'test_yield_hashes'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fresh_ts'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'-'
number|'10'
op|')'
newline|'\n'
name|'fresher_ts'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_listdir
name|'def'
name|'_listdir'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'path'
op|'.'
name|'endswith'
op|'('
string|"'/dev/objects/9'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'['
string|"'abc'"
op|','
string|"'456'"
op|','
string|"'def'"
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'path'
op|'.'
name|'endswith'
op|'('
string|"'/dev/objects/9/abc'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'['
string|"'9373a92d072897b136b3fc06595b4abc'"
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'path'
op|'.'
name|'endswith'
op|'('
nl|'\n'
string|"'/dev/objects/9/abc/9373a92d072897b136b3fc06595b4abc'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'['
name|'fresh_ts'
op|'+'
string|"'.ts'"
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'path'
op|'.'
name|'endswith'
op|'('
string|"'/dev/objects/9/456'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'['
string|"'9373a92d072897b136b3fc06595b0456'"
op|','
nl|'\n'
string|"'9373a92d072897b136b3fc06595b7456'"
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'path'
op|'.'
name|'endswith'
op|'('
nl|'\n'
string|"'/dev/objects/9/456/9373a92d072897b136b3fc06595b0456'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'['
string|"'1383180000.12345.data'"
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'path'
op|'.'
name|'endswith'
op|'('
nl|'\n'
string|"'/dev/objects/9/456/9373a92d072897b136b3fc06595b7456'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'['
name|'fresh_ts'
op|'+'
string|"'.ts'"
op|','
nl|'\n'
name|'fresher_ts'
op|'+'
string|"'.data'"
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'path'
op|'.'
name|'endswith'
op|'('
string|"'/dev/objects/9/def'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'['
op|']'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'Exception'
op|'('
string|"'Unexpected listdir of %r'"
op|'%'
name|'path'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'with'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.listdir'"
op|','
name|'_listdir'
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.unlink'"
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'list'
op|'('
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'yield_hashes'
op|'('
string|"'dev'"
op|','
string|"'9'"
op|')'
op|')'
op|','
nl|'\n'
op|'['
op|'('
name|'self'
op|'.'
name|'testdir'
op|'+'
nl|'\n'
string|"'/dev/objects/9/abc/9373a92d072897b136b3fc06595b4abc'"
op|','
nl|'\n'
string|"'9373a92d072897b136b3fc06595b4abc'"
op|','
name|'fresh_ts'
op|')'
op|','
nl|'\n'
op|'('
name|'self'
op|'.'
name|'testdir'
op|'+'
nl|'\n'
string|"'/dev/objects/9/456/9373a92d072897b136b3fc06595b0456'"
op|','
nl|'\n'
string|"'9373a92d072897b136b3fc06595b0456'"
op|','
string|"'1383180000.12345'"
op|')'
op|','
nl|'\n'
op|'('
name|'self'
op|'.'
name|'testdir'
op|'+'
nl|'\n'
string|"'/dev/objects/9/456/9373a92d072897b136b3fc06595b7456'"
op|','
nl|'\n'
string|"'9373a92d072897b136b3fc06595b7456'"
op|','
name|'fresher_ts'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_yield_hashes_suffixes
dedent|''
dedent|''
name|'def'
name|'test_yield_hashes_suffixes'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fresh_ts'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'-'
number|'10'
op|')'
newline|'\n'
name|'fresher_ts'
op|'='
name|'normalize_timestamp'
op|'('
name|'time'
op|'('
op|')'
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_listdir
name|'def'
name|'_listdir'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'path'
op|'.'
name|'endswith'
op|'('
string|"'/dev/objects/9'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'['
string|"'abc'"
op|','
string|"'456'"
op|','
string|"'def'"
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'path'
op|'.'
name|'endswith'
op|'('
string|"'/dev/objects/9/abc'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'['
string|"'9373a92d072897b136b3fc06595b4abc'"
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'path'
op|'.'
name|'endswith'
op|'('
nl|'\n'
string|"'/dev/objects/9/abc/9373a92d072897b136b3fc06595b4abc'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'['
name|'fresh_ts'
op|'+'
string|"'.ts'"
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'path'
op|'.'
name|'endswith'
op|'('
string|"'/dev/objects/9/456'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'['
string|"'9373a92d072897b136b3fc06595b0456'"
op|','
nl|'\n'
string|"'9373a92d072897b136b3fc06595b7456'"
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'path'
op|'.'
name|'endswith'
op|'('
nl|'\n'
string|"'/dev/objects/9/456/9373a92d072897b136b3fc06595b0456'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'['
string|"'1383180000.12345.data'"
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'path'
op|'.'
name|'endswith'
op|'('
nl|'\n'
string|"'/dev/objects/9/456/9373a92d072897b136b3fc06595b7456'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'['
name|'fresh_ts'
op|'+'
string|"'.ts'"
op|','
nl|'\n'
name|'fresher_ts'
op|'+'
string|"'.data'"
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'path'
op|'.'
name|'endswith'
op|'('
string|"'/dev/objects/9/def'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'['
op|']'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'Exception'
op|'('
string|"'Unexpected listdir of %r'"
op|'%'
name|'path'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'with'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.listdir'"
op|','
name|'_listdir'
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.unlink'"
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'list'
op|'('
name|'self'
op|'.'
name|'df_mgr'
op|'.'
name|'yield_hashes'
op|'('
nl|'\n'
string|"'dev'"
op|','
string|"'9'"
op|','
name|'suffixes'
op|'='
op|'['
string|"'456'"
op|']'
op|')'
op|')'
op|','
nl|'\n'
op|'['
op|'('
name|'self'
op|'.'
name|'testdir'
op|'+'
nl|'\n'
string|"'/dev/objects/9/456/9373a92d072897b136b3fc06595b0456'"
op|','
nl|'\n'
string|"'9373a92d072897b136b3fc06595b0456'"
op|','
string|"'1383180000.12345'"
op|')'
op|','
nl|'\n'
op|'('
name|'self'
op|'.'
name|'testdir'
op|'+'
nl|'\n'
string|"'/dev/objects/9/456/9373a92d072897b136b3fc06595b7456'"
op|','
nl|'\n'
string|"'9373a92d072897b136b3fc06595b7456'"
op|','
name|'fresher_ts'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_diskfile_names
dedent|''
dedent|''
name|'def'
name|'test_diskfile_names'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'df'
op|'.'
name|'account'
op|','
string|"'a'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'df'
op|'.'
name|'container'
op|','
string|"'c'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'df'
op|'.'
name|'obj'
op|','
string|"'o'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_diskfile_content_length_not_open
dedent|''
name|'def'
name|'test_diskfile_content_length_not_open'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'exc'
op|'='
name|'None'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'df'
op|'.'
name|'content_length'
newline|'\n'
dedent|''
name|'except'
name|'DiskFileNotOpen'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'exc'
op|'='
name|'err'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'exc'
op|')'
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_diskfile_content_length_deleted
dedent|''
name|'def'
name|'test_diskfile_content_length_deleted'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
op|')'
newline|'\n'
name|'ts'
op|'='
name|'time'
op|'('
op|')'
newline|'\n'
name|'df'
op|'.'
name|'delete'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'exp_name'
op|'='
string|"'%s.ts'"
op|'%'
name|'str'
op|'('
name|'normalize_timestamp'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'dl'
op|'='
name|'os'
op|'.'
name|'listdir'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'dl'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'exp_name'
name|'in'
name|'set'
op|'('
name|'dl'
op|')'
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'exc'
op|'='
name|'None'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'df'
op|'.'
name|'open'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'df'
op|'.'
name|'content_length'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'DiskFileDeleted'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'exc'
op|'='
name|'err'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'exc'
op|')'
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_diskfile_content_length
dedent|''
name|'def'
name|'test_diskfile_content_length'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'with'
name|'df'
op|'.'
name|'open'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'df'
op|'.'
name|'content_length'
op|','
number|'1024'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_diskfile_timestamp_not_open
dedent|''
dedent|''
name|'def'
name|'test_diskfile_timestamp_not_open'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'exc'
op|'='
name|'None'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'df'
op|'.'
name|'timestamp'
newline|'\n'
dedent|''
name|'except'
name|'DiskFileNotOpen'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'exc'
op|'='
name|'err'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'exc'
op|')'
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_diskfile_timestamp_deleted
dedent|''
name|'def'
name|'test_diskfile_timestamp_deleted'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'df'
op|'='
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
op|')'
newline|'\n'
name|'ts'
op|'='
name|'time'
op|'('
op|')'
newline|'\n'
name|'df'
op|'.'
name|'delete'
op|'('
name|'ts'
op|')'
newline|'\n'
name|'exp_name'
op|'='
string|"'%s.ts'"
op|'%'
name|'str'
op|'('
name|'normalize_timestamp'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'dl'
op|'='
name|'os'
op|'.'
name|'listdir'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'dl'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'exp_name'
name|'in'
name|'set'
op|'('
name|'dl'
op|')'
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'exc'
op|'='
name|'None'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'df'
op|'.'
name|'open'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'df'
op|'.'
name|'timestamp'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'DiskFileDeleted'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'exc'
op|'='
name|'err'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'exc'
op|')'
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_diskfile_timestamp
dedent|''
name|'def'
name|'test_diskfile_timestamp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
name|'ts'
op|'='
string|"'1383181759.12345'"
op|')'
newline|'\n'
name|'df'
op|'='
name|'self'
op|'.'
name|'_simple_get_diskfile'
op|'('
op|')'
newline|'\n'
name|'with'
name|'df'
op|'.'
name|'open'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'df'
op|'.'
name|'timestamp'
op|','
string|"'1383181759.12345'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_error_in_hash_cleanup_listdir
dedent|''
dedent|''
name|'def'
name|'test_error_in_hash_cleanup_listdir'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|function|mock_hcl
indent|'        '
name|'def'
name|'mock_hcl'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'OSError'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'df'
op|'='
name|'self'
op|'.'
name|'_get_open_disk_file'
op|'('
op|')'
newline|'\n'
name|'ts'
op|'='
name|'time'
op|'('
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|'"swift.obj.diskfile.hash_cleanup_listdir"'
op|','
nl|'\n'
name|'mock_hcl'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'df'
op|'.'
name|'delete'
op|'('
name|'ts'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'OSError'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'fail'
op|'('
string|'"OSError raised when it should have been swallowed"'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'exp_name'
op|'='
string|"'%s.ts'"
op|'%'
name|'str'
op|'('
name|'normalize_timestamp'
op|'('
name|'ts'
op|')'
op|')'
newline|'\n'
name|'dl'
op|'='
name|'os'
op|'.'
name|'listdir'
op|'('
name|'df'
op|'.'
name|'_datadir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'dl'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'exp_name'
name|'in'
name|'set'
op|'('
name|'dl'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'__name__'
op|'=='
string|"'__main__'"
op|':'
newline|'\n'
indent|'    '
name|'unittest'
op|'.'
name|'main'
op|'('
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit

begin_unit
nl|'\n'
comment|'# Copyright (c) 2010-2012 OpenStack Foundation'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'unittest'
newline|'\n'
name|'from'
name|'textwrap'
name|'import'
name|'dedent'
newline|'\n'
nl|'\n'
name|'import'
name|'mock'
newline|'\n'
name|'import'
name|'errno'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'utils'
name|'import'
name|'Timestamp'
newline|'\n'
name|'from'
name|'test'
op|'.'
name|'unit'
name|'import'
name|'debug_logger'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'container'
name|'import'
name|'sync'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'db'
name|'import'
name|'DatabaseConnectionError'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
name|'import'
name|'utils'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'wsgi'
name|'import'
name|'ConfigString'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'exceptions'
name|'import'
name|'ClientException'
newline|'\n'
name|'from'
name|'swift'
op|'.'
name|'common'
op|'.'
name|'storage_policy'
name|'import'
name|'StoragePolicy'
newline|'\n'
name|'import'
name|'test'
newline|'\n'
name|'from'
name|'test'
op|'.'
name|'unit'
name|'import'
name|'patch_policies'
op|','
name|'with_tempdir'
newline|'\n'
nl|'\n'
name|'utils'
op|'.'
name|'HASH_PATH_SUFFIX'
op|'='
string|"'endcap'"
newline|'\n'
name|'utils'
op|'.'
name|'HASH_PATH_PREFIX'
op|'='
string|"'endcap'"
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|FakeRing
name|'class'
name|'FakeRing'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'devs'
op|'='
op|'['
op|'{'
string|"'ip'"
op|':'
string|"'10.0.0.%s'"
op|'%'
name|'x'
op|','
string|"'port'"
op|':'
number|'1000'
op|'+'
name|'x'
op|','
string|"'device'"
op|':'
string|"'sda'"
op|'}'
nl|'\n'
name|'for'
name|'x'
name|'in'
name|'range'
op|'('
number|'3'
op|')'
op|']'
newline|'\n'
nl|'\n'
DECL|member|get_nodes
dedent|''
name|'def'
name|'get_nodes'
op|'('
name|'self'
op|','
name|'account'
op|','
name|'container'
op|'='
name|'None'
op|','
name|'obj'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
number|'1'
op|','
name|'list'
op|'('
name|'self'
op|'.'
name|'devs'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|FakeContainerBroker
dedent|''
dedent|''
name|'class'
name|'FakeContainerBroker'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'path'
op|','
name|'metadata'
op|'='
name|'None'
op|','
name|'info'
op|'='
name|'None'
op|','
name|'deleted'
op|'='
name|'False'
op|','
nl|'\n'
name|'items_since'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'db_file'
op|'='
name|'path'
newline|'\n'
name|'self'
op|'.'
name|'db_dir'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'dirname'
op|'('
name|'path'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'metadata'
op|'='
name|'metadata'
name|'if'
name|'metadata'
name|'else'
op|'{'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'info'
op|'='
name|'info'
name|'if'
name|'info'
name|'else'
op|'{'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'deleted'
op|'='
name|'deleted'
newline|'\n'
name|'self'
op|'.'
name|'items_since'
op|'='
name|'items_since'
name|'if'
name|'items_since'
name|'else'
op|'['
op|']'
newline|'\n'
name|'self'
op|'.'
name|'sync_point1'
op|'='
op|'-'
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'sync_point2'
op|'='
op|'-'
number|'1'
newline|'\n'
nl|'\n'
DECL|member|get_info
dedent|''
name|'def'
name|'get_info'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'info'
newline|'\n'
nl|'\n'
DECL|member|is_deleted
dedent|''
name|'def'
name|'is_deleted'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'deleted'
newline|'\n'
nl|'\n'
DECL|member|get_items_since
dedent|''
name|'def'
name|'get_items_since'
op|'('
name|'self'
op|','
name|'sync_point'
op|','
name|'limit'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'sync_point'
op|'<'
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'sync_point'
op|'='
number|'0'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'items_since'
op|'['
name|'sync_point'
op|':'
name|'sync_point'
op|'+'
name|'limit'
op|']'
newline|'\n'
nl|'\n'
DECL|member|set_x_container_sync_points
dedent|''
name|'def'
name|'set_x_container_sync_points'
op|'('
name|'self'
op|','
name|'sync_point1'
op|','
name|'sync_point2'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'sync_point1'
op|'='
name|'sync_point1'
newline|'\n'
name|'self'
op|'.'
name|'sync_point2'
op|'='
name|'sync_point2'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'patch_policies'
op|'('
op|'['
name|'StoragePolicy'
op|'('
number|'0'
op|','
string|"'zero'"
op|','
name|'True'
op|','
name|'object_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
op|')'
op|']'
op|')'
newline|'\n'
DECL|class|TestContainerSync
name|'class'
name|'TestContainerSync'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'logger'
op|'='
name|'debug_logger'
op|'('
string|"'test-container-sync'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_FileLikeIter
dedent|''
name|'def'
name|'test_FileLikeIter'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Retained test to show new FileLikeIter acts just like the removed'
nl|'\n'
comment|'# _Iter2FileLikeObject did.'
nl|'\n'
indent|'        '
name|'flo'
op|'='
name|'sync'
op|'.'
name|'FileLikeIter'
op|'('
name|'iter'
op|'('
op|'['
string|"'123'"
op|','
string|"'4567'"
op|','
string|"'89'"
op|','
string|"'0'"
op|']'
op|')'
op|')'
newline|'\n'
name|'expect'
op|'='
string|"'1234567890'"
newline|'\n'
nl|'\n'
name|'got'
op|'='
name|'flo'
op|'.'
name|'read'
op|'('
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'len'
op|'('
name|'got'
op|')'
op|'<='
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'got'
op|','
name|'expect'
op|'['
op|':'
name|'len'
op|'('
name|'got'
op|')'
op|']'
op|')'
newline|'\n'
name|'expect'
op|'='
name|'expect'
op|'['
name|'len'
op|'('
name|'got'
op|')'
op|':'
op|']'
newline|'\n'
nl|'\n'
name|'got'
op|'='
name|'flo'
op|'.'
name|'read'
op|'('
number|'5'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'len'
op|'('
name|'got'
op|')'
op|'<='
number|'5'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'got'
op|','
name|'expect'
op|'['
op|':'
name|'len'
op|'('
name|'got'
op|')'
op|']'
op|')'
newline|'\n'
name|'expect'
op|'='
name|'expect'
op|'['
name|'len'
op|'('
name|'got'
op|')'
op|':'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'flo'
op|'.'
name|'read'
op|'('
op|')'
op|','
name|'expect'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'flo'
op|'.'
name|'read'
op|'('
op|')'
op|','
string|"''"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'flo'
op|'.'
name|'read'
op|'('
number|'2'
op|')'
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
name|'flo'
op|'='
name|'sync'
op|'.'
name|'FileLikeIter'
op|'('
name|'iter'
op|'('
op|'['
string|"'123'"
op|','
string|"'4567'"
op|','
string|"'89'"
op|','
string|"'0'"
op|']'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'flo'
op|'.'
name|'read'
op|'('
op|')'
op|','
string|"'1234567890'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'flo'
op|'.'
name|'read'
op|'('
op|')'
op|','
string|"''"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'flo'
op|'.'
name|'read'
op|'('
number|'2'
op|')'
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
DECL|member|assertLogMessage
dedent|''
name|'def'
name|'assertLogMessage'
op|'('
name|'self'
op|','
name|'msg_level'
op|','
name|'expected'
op|','
name|'skip'
op|'='
number|'0'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'line'
name|'in'
name|'self'
op|'.'
name|'logger'
op|'.'
name|'get_lines_for_level'
op|'('
name|'msg_level'
op|')'
op|'['
name|'skip'
op|':'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'msg'
op|'='
string|"'expected %r not in %r'"
op|'%'
op|'('
name|'expected'
op|','
name|'line'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'expected'
name|'in'
name|'line'
op|','
name|'msg'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'with_tempdir'
newline|'\n'
DECL|member|test_init
name|'def'
name|'test_init'
op|'('
name|'self'
op|','
name|'tempdir'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ic_conf_path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tempdir'
op|','
string|"'internal-client.conf'"
op|')'
newline|'\n'
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'cs'
op|'.'
name|'container_ring'
name|'is'
name|'cring'
op|')'
newline|'\n'
nl|'\n'
comment|'# specified but not exists will not start'
nl|'\n'
name|'conf'
op|'='
op|'{'
string|"'internal_client_conf_path'"
op|':'
name|'ic_conf_path'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'SystemExit'
op|','
name|'sync'
op|'.'
name|'ContainerSync'
op|','
name|'conf'
op|','
nl|'\n'
name|'container_ring'
op|'='
name|'cring'
op|','
name|'logger'
op|'='
name|'self'
op|'.'
name|'logger'
op|')'
newline|'\n'
nl|'\n'
comment|'# not specified will use default conf'
nl|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
name|'as'
name|'mock_ic'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|','
nl|'\n'
name|'logger'
op|'='
name|'self'
op|'.'
name|'logger'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'cs'
op|'.'
name|'container_ring'
name|'is'
name|'cring'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'mock_ic'
op|'.'
name|'called'
op|')'
newline|'\n'
name|'conf_path'
op|','
name|'name'
op|','
name|'retry'
op|'='
name|'mock_ic'
op|'.'
name|'call_args'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'isinstance'
op|'('
name|'conf_path'
op|','
name|'ConfigString'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'conf_path'
op|'.'
name|'contents'
op|'.'
name|'getvalue'
op|'('
op|')'
op|','
nl|'\n'
name|'dedent'
op|'('
name|'sync'
op|'.'
name|'ic_conf_body'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertLogMessage'
op|'('
string|"'warning'"
op|','
string|"'internal_client_conf_path'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertLogMessage'
op|'('
string|"'warning'"
op|','
string|"'internal-client.conf-sample'"
op|')'
newline|'\n'
nl|'\n'
comment|'# correct'
nl|'\n'
name|'contents'
op|'='
name|'dedent'
op|'('
name|'sync'
op|'.'
name|'ic_conf_body'
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
name|'ic_conf_path'
op|','
string|"'w'"
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'            '
name|'f'
op|'.'
name|'write'
op|'('
name|'contents'
op|')'
newline|'\n'
dedent|''
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
name|'as'
name|'mock_ic'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
name|'conf'
op|','
name|'container_ring'
op|'='
name|'cring'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'cs'
op|'.'
name|'container_ring'
name|'is'
name|'cring'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'mock_ic'
op|'.'
name|'called'
op|')'
newline|'\n'
name|'conf_path'
op|','
name|'name'
op|','
name|'retry'
op|'='
name|'mock_ic'
op|'.'
name|'call_args'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'conf_path'
op|','
name|'ic_conf_path'
op|')'
newline|'\n'
nl|'\n'
name|'sample_conf_filename'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'dirname'
op|'('
name|'test'
op|'.'
name|'__file__'
op|')'
op|','
nl|'\n'
string|"'../etc/internal-client.conf-sample'"
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
name|'sample_conf_filename'
op|')'
name|'as'
name|'sample_conf_file'
op|':'
newline|'\n'
indent|'            '
name|'sample_conf'
op|'='
name|'sample_conf_file'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'contents'
op|','
name|'sample_conf'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_forever
dedent|''
name|'def'
name|'test_run_forever'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# This runs runs_forever with fakes to succeed for two loops, the first'
nl|'\n'
comment|'# causing a report but no interval sleep, the second no report but an'
nl|'\n'
comment|'# interval sleep.'
nl|'\n'
indent|'        '
name|'time_calls'
op|'='
op|'['
number|'0'
op|']'
newline|'\n'
name|'sleep_calls'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_time
name|'def'
name|'fake_time'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'time_calls'
op|'['
number|'0'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'returns'
op|'='
op|'['
number|'1'
op|','
comment|'# Initialized reported time'
nl|'\n'
number|'1'
op|','
comment|'# Start time'
nl|'\n'
number|'3602'
op|','
comment|'# Is it report time (yes)'
nl|'\n'
number|'3602'
op|','
comment|'# Report time'
nl|'\n'
number|'3602'
op|','
comment|'# Elapsed time for "under interval" (no)'
nl|'\n'
number|'3602'
op|','
comment|'# Start time'
nl|'\n'
number|'3603'
op|','
comment|'# Is it report time (no)'
nl|'\n'
number|'3603'
op|']'
comment|'# Elapsed time for "under interval" (yes)'
newline|'\n'
name|'if'
name|'time_calls'
op|'['
number|'0'
op|']'
op|'=='
name|'len'
op|'('
name|'returns'
op|')'
op|'+'
number|'1'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'Exception'
op|'('
string|"'we are now done'"
op|')'
newline|'\n'
dedent|''
name|'return'
name|'returns'
op|'['
name|'time_calls'
op|'['
number|'0'
op|']'
op|'-'
number|'1'
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_sleep
dedent|''
name|'def'
name|'fake_sleep'
op|'('
name|'amount'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'sleep_calls'
op|'.'
name|'append'
op|'('
name|'amount'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'gen_func'
op|'='
op|'('
string|"'swift.container.sync_store.'"
nl|'\n'
string|"'ContainerSyncStore.synced_containers_generator'"
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
op|','
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.time'"
op|','
name|'fake_time'
op|')'
op|','
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.sleep'"
op|','
name|'fake_sleep'
op|')'
op|','
name|'mock'
op|'.'
name|'patch'
op|'('
name|'gen_func'
op|')'
name|'as'
name|'fake_generator'
op|','
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.ContainerBroker'"
op|','
nl|'\n'
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
name|'p'
op|','
name|'info'
op|'='
op|'{'
nl|'\n'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'fake_generator'
op|'.'
name|'side_effect'
op|'='
op|'['
name|'iter'
op|'('
op|'['
string|"'container.db'"
op|']'
op|')'
op|','
nl|'\n'
name|'iter'
op|'('
op|'['
string|"'container.db'"
op|']'
op|')'
op|']'
newline|'\n'
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'cs'
op|'.'
name|'run_forever'
op|'('
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'str'
op|'('
name|'err'
op|')'
op|'!='
string|"'we are now done'"
op|':'
newline|'\n'
indent|'                    '
name|'raise'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'time_calls'
op|','
op|'['
number|'9'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'sleep_calls'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertLessEqual'
op|'('
name|'sleep_calls'
op|'['
number|'0'
op|']'
op|','
name|'cs'
op|'.'
name|'interval'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'interval'
op|'-'
number|'1'
op|','
name|'sleep_calls'
op|'['
number|'1'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'fake_generator'
op|'.'
name|'call_count'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'reported'
op|','
number|'3602'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_once
dedent|''
dedent|''
name|'def'
name|'test_run_once'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# This runs runs_once with fakes twice, the first causing an interim'
nl|'\n'
comment|'# report, the second with no interim report.'
nl|'\n'
indent|'        '
name|'time_calls'
op|'='
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_time
name|'def'
name|'fake_time'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'time_calls'
op|'['
number|'0'
op|']'
op|'+='
number|'1'
newline|'\n'
name|'returns'
op|'='
op|'['
number|'1'
op|','
comment|'# Initialized reported time'
nl|'\n'
number|'1'
op|','
comment|'# Start time'
nl|'\n'
number|'3602'
op|','
comment|'# Is it report time (yes)'
nl|'\n'
number|'3602'
op|','
comment|'# Report time'
nl|'\n'
number|'3602'
op|','
comment|'# End report time'
nl|'\n'
number|'3602'
op|','
comment|'# For elapsed'
nl|'\n'
number|'3602'
op|','
comment|'# Start time'
nl|'\n'
number|'3603'
op|','
comment|'# Is it report time (no)'
nl|'\n'
number|'3604'
op|','
comment|'# End report time'
nl|'\n'
number|'3605'
op|']'
comment|'# For elapsed'
newline|'\n'
name|'if'
name|'time_calls'
op|'['
number|'0'
op|']'
op|'=='
name|'len'
op|'('
name|'returns'
op|')'
op|'+'
number|'1'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'Exception'
op|'('
string|"'we are now done'"
op|')'
newline|'\n'
dedent|''
name|'return'
name|'returns'
op|'['
name|'time_calls'
op|'['
number|'0'
op|']'
op|'-'
number|'1'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'gen_func'
op|'='
op|'('
string|"'swift.container.sync_store.'"
nl|'\n'
string|"'ContainerSyncStore.synced_containers_generator'"
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
op|','
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.time'"
op|','
name|'fake_time'
op|')'
op|','
name|'mock'
op|'.'
name|'patch'
op|'('
name|'gen_func'
op|')'
name|'as'
name|'fake_generator'
op|','
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.ContainerBroker'"
op|','
nl|'\n'
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
name|'p'
op|','
name|'info'
op|'='
op|'{'
nl|'\n'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'fake_generator'
op|'.'
name|'side_effect'
op|'='
op|'['
name|'iter'
op|'('
op|'['
string|"'container.db'"
op|']'
op|')'
op|','
nl|'\n'
name|'iter'
op|'('
op|'['
string|"'container.db'"
op|']'
op|')'
op|']'
newline|'\n'
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'cs'
op|'.'
name|'run_once'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'time_calls'
op|','
op|'['
number|'6'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'fake_generator'
op|'.'
name|'call_count'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'reported'
op|','
number|'3602'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'run_once'
op|'('
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
name|'as'
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'str'
op|'('
name|'err'
op|')'
op|'!='
string|"'we are now done'"
op|':'
newline|'\n'
indent|'                    '
name|'raise'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'time_calls'
op|','
op|'['
number|'10'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'fake_generator'
op|'.'
name|'call_count'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'reported'
op|','
number|'3604'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_container_sync_not_db
dedent|''
dedent|''
name|'def'
name|'test_container_sync_not_db'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_container_sync_missing_db
dedent|''
name|'def'
name|'test_container_sync_missing_db'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'broker'
op|'='
string|"'swift.container.backend.ContainerBroker'"
newline|'\n'
name|'store'
op|'='
string|"'swift.container.sync_store.ContainerSyncStore'"
newline|'\n'
nl|'\n'
comment|'# In this test we call the container_sync instance several'
nl|'\n'
comment|'# times with a missing db in various combinations.'
nl|'\n'
comment|'# Since we use the same ContainerSync instance for all tests'
nl|'\n'
comment|'# its failures counter increases by one with each call.'
nl|'\n'
nl|'\n'
comment|'# Test the case where get_info returns DatabaseConnectionError'
nl|'\n'
comment|'# with DB does not exist, and we succeed in deleting it.'
nl|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'broker'
op|'+'
string|"'.get_info'"
op|')'
name|'as'
name|'fake_get_info'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'store'
op|'+'
string|"'.remove_synced_container'"
op|')'
name|'as'
name|'fake_remove'
op|':'
newline|'\n'
indent|'                '
name|'fake_get_info'
op|'.'
name|'side_effect'
op|'='
name|'DatabaseConnectionError'
op|'('
nl|'\n'
string|"'a'"
op|','
nl|'\n'
string|'"DB doesn\'t exist"'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'fake_remove'
op|'.'
name|'call_count'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'isa.db'"
op|','
name|'fake_remove'
op|'.'
name|'call_args'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|'.'
name|'db_file'
op|')'
newline|'\n'
nl|'\n'
comment|'# Test the case where get_info returns DatabaseConnectionError'
nl|'\n'
comment|'# with DB does not exist, and we fail to delete it.'
nl|'\n'
dedent|''
dedent|''
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'broker'
op|'+'
string|"'.get_info'"
op|')'
name|'as'
name|'fake_get_info'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'store'
op|'+'
string|"'.remove_synced_container'"
op|')'
name|'as'
name|'fake_remove'
op|':'
newline|'\n'
indent|'                '
name|'fake_get_info'
op|'.'
name|'side_effect'
op|'='
name|'DatabaseConnectionError'
op|'('
nl|'\n'
string|"'a'"
op|','
nl|'\n'
string|'"DB doesn\'t exist"'
op|')'
newline|'\n'
name|'fake_remove'
op|'.'
name|'side_effect'
op|'='
name|'OSError'
op|'('
string|"'1'"
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'fake_remove'
op|'.'
name|'call_count'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'isa.db'"
op|','
name|'fake_remove'
op|'.'
name|'call_args'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|'.'
name|'db_file'
op|')'
newline|'\n'
nl|'\n'
comment|'# Test the case where get_info returns DatabaseConnectionError'
nl|'\n'
comment|'# with DB does not exist, and it returns an error != ENOENT.'
nl|'\n'
dedent|''
dedent|''
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'broker'
op|'+'
string|"'.get_info'"
op|')'
name|'as'
name|'fake_get_info'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'store'
op|'+'
string|"'.remove_synced_container'"
op|')'
name|'as'
name|'fake_remove'
op|':'
newline|'\n'
indent|'                '
name|'fake_get_info'
op|'.'
name|'side_effect'
op|'='
name|'DatabaseConnectionError'
op|'('
nl|'\n'
string|"'a'"
op|','
nl|'\n'
string|'"DB doesn\'t exist"'
op|')'
newline|'\n'
name|'fake_remove'
op|'.'
name|'side_effect'
op|'='
name|'OSError'
op|'('
name|'errno'
op|'.'
name|'EPERM'
op|','
string|"'a'"
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'fake_remove'
op|'.'
name|'call_count'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'isa.db'"
op|','
name|'fake_remove'
op|'.'
name|'call_args'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
op|'.'
name|'db_file'
op|')'
newline|'\n'
nl|'\n'
comment|'# Test the case where get_info returns DatabaseConnectionError'
nl|'\n'
comment|'# error different than DB does not exist'
nl|'\n'
dedent|''
dedent|''
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'broker'
op|'+'
string|"'.get_info'"
op|')'
name|'as'
name|'fake_get_info'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
name|'store'
op|'+'
string|"'.remove_synced_container'"
op|')'
name|'as'
name|'fake_remove'
op|':'
newline|'\n'
indent|'                '
name|'fake_get_info'
op|'.'
name|'side_effect'
op|'='
name|'DatabaseConnectionError'
op|'('
string|"'a'"
op|','
string|"'a'"
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'4'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'fake_remove'
op|'.'
name|'call_count'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_container_sync_not_my_db
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_container_sync_not_my_db'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Db could be there due to handoff replication so test that we ignore'
nl|'\n'
comment|'# those.'
nl|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
nl|'\n'
string|"'bind_ip'"
op|':'
string|"'10.0.0.0'"
op|','
nl|'\n'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|')'
newline|'\n'
comment|'# Plumbing test for bind_ip and whataremyips()'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
string|"'10.0.0.0'"
op|']'
op|','
name|'cs'
op|'.'
name|'_myips'
op|')'
newline|'\n'
dedent|''
name|'orig_ContainerBroker'
op|'='
name|'sync'
op|'.'
name|'ContainerBroker'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
comment|'# No match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1'
comment|'# No match'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1'
comment|'# No match'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
comment|'# No match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
comment|'# This complete match will cause the 1 container failure since the'
nl|'\n'
comment|"# broker's info doesn't contain sync point keys"
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'orig_ContainerBroker'
newline|'\n'
nl|'\n'
DECL|member|test_container_sync_deleted
dedent|''
dedent|''
name|'def'
name|'test_container_sync_deleted'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|')'
newline|'\n'
dedent|''
name|'orig_ContainerBroker'
op|'='
name|'sync'
op|'.'
name|'ContainerBroker'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|','
name|'deleted'
op|'='
name|'False'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
comment|'# This complete match will cause the 1 container failure since the'
nl|'\n'
comment|"# broker's info doesn't contain sync point keys"
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|','
name|'deleted'
op|'='
name|'True'
op|')'
newline|'\n'
comment|'# This complete match will not cause any more container failures'
nl|'\n'
comment|'# since the broker indicates deletion'
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'orig_ContainerBroker'
newline|'\n'
nl|'\n'
DECL|member|test_container_sync_no_to_or_key
dedent|''
dedent|''
name|'def'
name|'test_container_sync_no_to_or_key'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|')'
newline|'\n'
dedent|''
name|'orig_ContainerBroker'
op|'='
name|'sync'
op|'.'
name|'ContainerBroker'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
comment|"# This complete match will be skipped since the broker's metadata"
nl|'\n'
comment|'# has no x-container-sync-to or x-container-sync-key'
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|'}'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
comment|"# This complete match will be skipped since the broker's metadata"
nl|'\n'
comment|'# has no x-container-sync-key'
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
comment|"# This complete match will be skipped since the broker's metadata"
nl|'\n'
comment|'# has no x-container-sync-to'
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'3'
op|')'
newline|'\n'
nl|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
op|']'
newline|'\n'
comment|'# This complete match will cause a container failure since the'
nl|'\n'
comment|"# sync-to won't validate as allowed."
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'3'
op|')'
newline|'\n'
nl|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
comment|'# This complete match will succeed completely since the broker'
nl|'\n'
comment|'# get_items_since will return no new rows.'
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'3'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'orig_ContainerBroker'
newline|'\n'
nl|'\n'
DECL|member|test_container_stop_at
dedent|''
dedent|''
name|'def'
name|'test_container_stop_at'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|')'
newline|'\n'
dedent|''
name|'orig_ContainerBroker'
op|'='
name|'sync'
op|'.'
name|'ContainerBroker'
newline|'\n'
name|'orig_time'
op|'='
name|'sync'
op|'.'
name|'time'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'FakeContainerBroker'
op|'('
nl|'\n'
name|'p'
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
string|"'erroneous data'"
op|']'
op|')'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
comment|'# This sync will fail since the items_since data is bad.'
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# Set up fake times to make the sync short-circuit as having taken'
nl|'\n'
comment|'# too long'
nl|'\n'
name|'fake_times'
op|'='
op|'['
nl|'\n'
number|'1.0'
op|','
comment|'# Compute the time to move on'
nl|'\n'
number|'100000.0'
op|','
comment|"# Compute if it's time to move on from first loop"
nl|'\n'
number|'100000.0'
op|']'
comment|"# Compute if it's time to move on from second loop"
newline|'\n'
nl|'\n'
DECL|function|fake_time
name|'def'
name|'fake_time'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'fake_times'
op|'.'
name|'pop'
op|'('
number|'0'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'time'
op|'='
name|'fake_time'
newline|'\n'
comment|"# This same sync won't fail since it will look like it took so long"
nl|'\n'
comment|'# as to be time to move on (before it ever actually tries to do'
nl|'\n'
comment|'# anything).'
nl|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'orig_ContainerBroker'
newline|'\n'
name|'sync'
op|'.'
name|'time'
op|'='
name|'orig_time'
newline|'\n'
nl|'\n'
DECL|member|test_container_first_loop
dedent|''
dedent|''
name|'def'
name|'test_container_first_loop'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_hash_path
dedent|''
name|'def'
name|'fake_hash_path'
op|'('
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|','
name|'raw_digest'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
comment|'# Ensures that no rows match for full syncing, ordinal is 0 and'
nl|'\n'
comment|'# all hashes are 0'
nl|'\n'
indent|'            '
name|'return'
string|"'\\x00'"
op|'*'
number|'16'
newline|'\n'
dedent|''
name|'fcb'
op|'='
name|'FakeContainerBroker'
op|'('
nl|'\n'
string|"'path'"
op|','
nl|'\n'
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
op|'{'
string|"'ROWID'"
op|':'
number|'1'
op|','
string|"'name'"
op|':'
string|"'o'"
op|'}'
op|']'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.ContainerBroker'"
op|','
nl|'\n'
name|'lambda'
name|'p'
op|':'
name|'fcb'
op|')'
op|','
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.hash_path'"
op|','
name|'fake_hash_path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
comment|'# Succeeds because no rows match'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fcb'
op|'.'
name|'sync_point1'
op|','
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fcb'
op|'.'
name|'sync_point2'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_hash_path
dedent|''
name|'def'
name|'fake_hash_path'
op|'('
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|','
name|'raw_digest'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
comment|'# Ensures that all rows match for full syncing, ordinal is 0'
nl|'\n'
comment|'# and all hashes are 1'
nl|'\n'
indent|'            '
name|'return'
string|"'\\x01'"
op|'*'
number|'16'
newline|'\n'
dedent|''
name|'fcb'
op|'='
name|'FakeContainerBroker'
op|'('
string|"'path'"
op|','
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
nl|'\n'
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
nl|'\n'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
nl|'\n'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
op|'{'
string|"'ROWID'"
op|':'
number|'1'
op|','
string|"'name'"
op|':'
string|"'o'"
op|'}'
op|']'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.ContainerBroker'"
op|','
nl|'\n'
name|'lambda'
name|'p'
op|':'
name|'fcb'
op|')'
op|','
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.hash_path'"
op|','
name|'fake_hash_path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
comment|"# Succeeds because the two sync points haven't deviated yet"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fcb'
op|'.'
name|'sync_point1'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fcb'
op|'.'
name|'sync_point2'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'fcb'
op|'='
name|'FakeContainerBroker'
op|'('
nl|'\n'
string|"'path'"
op|','
nl|'\n'
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
op|'{'
string|"'ROWID'"
op|':'
number|'1'
op|','
string|"'name'"
op|':'
string|"'o'"
op|'}'
op|']'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.ContainerBroker'"
op|','
name|'lambda'
name|'p'
op|':'
name|'fcb'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
comment|'# Fails because container_sync_row will fail since the row has no'
nl|'\n'
comment|"# 'deleted' key"
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fcb'
op|'.'
name|'sync_point1'
op|','
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fcb'
op|'.'
name|'sync_point2'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_delete_object
dedent|''
name|'def'
name|'fake_delete_object'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'ClientException'
newline|'\n'
dedent|''
name|'fcb'
op|'='
name|'FakeContainerBroker'
op|'('
nl|'\n'
string|"'path'"
op|','
nl|'\n'
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
op|'{'
string|"'ROWID'"
op|':'
number|'1'
op|','
string|"'name'"
op|':'
string|"'o'"
op|','
string|"'created_at'"
op|':'
string|"'1.2'"
op|','
nl|'\n'
string|"'deleted'"
op|':'
name|'True'
op|'}'
op|']'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.ContainerBroker'"
op|','
nl|'\n'
name|'lambda'
name|'p'
op|':'
name|'fcb'
op|')'
op|','
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.delete_object'"
op|','
nl|'\n'
name|'fake_delete_object'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
comment|'# Fails because delete_object fails'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fcb'
op|'.'
name|'sync_point1'
op|','
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fcb'
op|'.'
name|'sync_point2'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'fcb'
op|'='
name|'FakeContainerBroker'
op|'('
nl|'\n'
string|"'path'"
op|','
nl|'\n'
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
op|'{'
string|"'ROWID'"
op|':'
number|'1'
op|','
string|"'name'"
op|':'
string|"'o'"
op|','
string|"'created_at'"
op|':'
string|"'1.2'"
op|','
nl|'\n'
string|"'deleted'"
op|':'
name|'True'
op|'}'
op|']'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.ContainerBroker'"
op|','
nl|'\n'
name|'lambda'
name|'p'
op|':'
name|'fcb'
op|')'
op|','
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.delete_object'"
op|','
nl|'\n'
name|'lambda'
op|'*'
name|'x'
op|','
op|'**'
name|'y'
op|':'
name|'None'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
comment|'# Succeeds because delete_object succeeds'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fcb'
op|'.'
name|'sync_point1'
op|','
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fcb'
op|'.'
name|'sync_point2'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_container_second_loop
dedent|''
dedent|''
name|'def'
name|'test_container_second_loop'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cring'
op|'='
name|'FakeRing'
op|'('
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'cring'
op|','
nl|'\n'
name|'logger'
op|'='
name|'self'
op|'.'
name|'logger'
op|')'
newline|'\n'
dedent|''
name|'orig_ContainerBroker'
op|'='
name|'sync'
op|'.'
name|'ContainerBroker'
newline|'\n'
name|'orig_hash_path'
op|'='
name|'sync'
op|'.'
name|'hash_path'
newline|'\n'
name|'orig_delete_object'
op|'='
name|'sync'
op|'.'
name|'delete_object'
newline|'\n'
name|'try'
op|':'
newline|'\n'
comment|"# We'll ensure the first loop is always skipped by keeping the two"
nl|'\n'
comment|'# sync points equal'
nl|'\n'
nl|'\n'
DECL|function|fake_hash_path
indent|'            '
name|'def'
name|'fake_hash_path'
op|'('
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|','
name|'raw_digest'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
comment|'# Ensures that no rows match for second loop, ordinal is 0 and'
nl|'\n'
comment|'# all hashes are 1'
nl|'\n'
indent|'                '
name|'return'
string|"'\\x01'"
op|'*'
number|'16'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'hash_path'
op|'='
name|'fake_hash_path'
newline|'\n'
name|'fcb'
op|'='
name|'FakeContainerBroker'
op|'('
nl|'\n'
string|"'path'"
op|','
nl|'\n'
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
op|'{'
string|"'ROWID'"
op|':'
number|'1'
op|','
string|"'name'"
op|':'
string|"'o'"
op|'}'
op|']'
op|')'
newline|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'fcb'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
comment|'# Succeeds because no rows match'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fcb'
op|'.'
name|'sync_point1'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fcb'
op|'.'
name|'sync_point2'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_hash_path
name|'def'
name|'fake_hash_path'
op|'('
name|'account'
op|','
name|'container'
op|','
name|'obj'
op|','
name|'raw_digest'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
comment|'# Ensures that all rows match for second loop, ordinal is 0 and'
nl|'\n'
comment|'# all hashes are 0'
nl|'\n'
indent|'                '
name|'return'
string|"'\\x00'"
op|'*'
number|'16'
newline|'\n'
nl|'\n'
DECL|function|fake_delete_object
dedent|''
name|'def'
name|'fake_delete_object'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'hash_path'
op|'='
name|'fake_hash_path'
newline|'\n'
name|'sync'
op|'.'
name|'delete_object'
op|'='
name|'fake_delete_object'
newline|'\n'
name|'fcb'
op|'='
name|'FakeContainerBroker'
op|'('
nl|'\n'
string|"'path'"
op|','
nl|'\n'
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
op|'{'
string|"'ROWID'"
op|':'
number|'1'
op|','
string|"'name'"
op|':'
string|"'o'"
op|'}'
op|']'
op|')'
newline|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'fcb'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
comment|"# Fails because row is missing 'deleted' key"
nl|'\n'
comment|'# Nevertheless the fault is skipped'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fcb'
op|'.'
name|'sync_point1'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fcb'
op|'.'
name|'sync_point2'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'fcb'
op|'='
name|'FakeContainerBroker'
op|'('
nl|'\n'
string|"'path'"
op|','
nl|'\n'
name|'info'
op|'='
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
nl|'\n'
string|"'storage_policy_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'x_container_sync_point1'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'x_container_sync_point2'"
op|':'
op|'-'
number|'1'
op|'}'
op|','
nl|'\n'
name|'metadata'
op|'='
op|'{'
string|"'x-container-sync-to'"
op|':'
op|'('
string|"'http://127.0.0.1/a/c'"
op|','
number|'1'
op|')'
op|','
nl|'\n'
string|"'x-container-sync-key'"
op|':'
op|'('
string|"'key'"
op|','
number|'1'
op|')'
op|'}'
op|','
nl|'\n'
name|'items_since'
op|'='
op|'['
op|'{'
string|"'ROWID'"
op|':'
number|'1'
op|','
string|"'name'"
op|':'
string|"'o'"
op|','
string|"'created_at'"
op|':'
string|"'1.2'"
op|','
nl|'\n'
string|"'deleted'"
op|':'
name|'True'
op|'}'
op|']'
op|')'
newline|'\n'
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'lambda'
name|'p'
op|':'
name|'fcb'
newline|'\n'
name|'cs'
op|'.'
name|'_myips'
op|'='
op|'['
string|"'10.0.0.0'"
op|']'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'_myport'
op|'='
number|'1000'
comment|'# Match'
newline|'\n'
name|'cs'
op|'.'
name|'allowed_sync_hosts'
op|'='
op|'['
string|"'127.0.0.1'"
op|']'
newline|'\n'
name|'cs'
op|'.'
name|'container_sync'
op|'('
string|"'isa.db'"
op|')'
newline|'\n'
comment|"# Succeeds because row now has 'deleted' key and delete_object"
nl|'\n'
comment|'# succeeds'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_failures'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_skips'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fcb'
op|'.'
name|'sync_point1'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fcb'
op|'.'
name|'sync_point2'
op|','
name|'None'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'ContainerBroker'
op|'='
name|'orig_ContainerBroker'
newline|'\n'
name|'sync'
op|'.'
name|'hash_path'
op|'='
name|'orig_hash_path'
newline|'\n'
name|'sync'
op|'.'
name|'delete_object'
op|'='
name|'orig_delete_object'
newline|'\n'
nl|'\n'
DECL|member|test_container_sync_row_delete
dedent|''
dedent|''
name|'def'
name|'test_container_sync_row_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_container_sync_row_delete'
op|'('
name|'None'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_container_sync_row_delete_using_realms
dedent|''
name|'def'
name|'test_container_sync_row_delete_using_realms'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_container_sync_row_delete'
op|'('
string|"'US'"
op|','
string|"'realm_key'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_container_sync_row_delete
dedent|''
name|'def'
name|'_test_container_sync_row_delete'
op|'('
name|'self'
op|','
name|'realm'
op|','
name|'realm_key'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'orig_uuid'
op|'='
name|'sync'
op|'.'
name|'uuid'
newline|'\n'
name|'orig_delete_object'
op|'='
name|'sync'
op|'.'
name|'delete_object'
newline|'\n'
name|'try'
op|':'
newline|'\n'
DECL|class|FakeUUID
indent|'            '
name|'class'
name|'FakeUUID'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
DECL|class|uuid4
indent|'                '
name|'class'
name|'uuid4'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
DECL|variable|hex
indent|'                    '
name|'hex'
op|'='
string|"'abcdef'"
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'sync'
op|'.'
name|'uuid'
op|'='
name|'FakeUUID'
newline|'\n'
name|'ts_data'
op|'='
name|'Timestamp'
op|'('
number|'1.1'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_delete_object
name|'def'
name|'fake_delete_object'
op|'('
name|'path'
op|','
name|'name'
op|'='
name|'None'
op|','
name|'headers'
op|'='
name|'None'
op|','
name|'proxy'
op|'='
name|'None'
op|','
nl|'\n'
name|'logger'
op|'='
name|'None'
op|','
name|'timeout'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'path'
op|','
string|"'http://sync/to/path'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'name'
op|','
string|"'object'"
op|')'
newline|'\n'
name|'if'
name|'realm'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'headers'
op|','
op|'{'
nl|'\n'
string|"'x-container-sync-auth'"
op|':'
nl|'\n'
string|"'US abcdef a2401ecb1256f469494a0abcb0eb62ffa73eca63'"
op|','
nl|'\n'
string|"'x-timestamp'"
op|':'
name|'ts_data'
op|'.'
name|'internal'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'headers'
op|','
nl|'\n'
op|'{'
string|"'x-container-sync-key'"
op|':'
string|"'key'"
op|','
nl|'\n'
string|"'x-timestamp'"
op|':'
name|'ts_data'
op|'.'
name|'internal'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'proxy'
op|','
string|"'http://proxy'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'timeout'
op|','
number|'5.0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'logger'
op|','
name|'self'
op|'.'
name|'logger'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'delete_object'
op|'='
name|'fake_delete_object'
newline|'\n'
nl|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
op|','
nl|'\n'
name|'logger'
op|'='
name|'self'
op|'.'
name|'logger'
op|')'
newline|'\n'
dedent|''
name|'cs'
op|'.'
name|'http_proxies'
op|'='
op|'['
string|"'http://proxy'"
op|']'
newline|'\n'
comment|'# Success.'
nl|'\n'
comment|'# simulate a row with tombstone at 1.1 and later ctype, meta times'
nl|'\n'
name|'created_at'
op|'='
name|'ts_data'
op|'.'
name|'internal'
op|'+'
string|"'+1388+1388'"
comment|'# last modified = 1.2'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'True'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
name|'created_at'
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|','
nl|'\n'
name|'realm'
op|','
name|'realm_key'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_deletes'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'exc'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_delete_object
name|'def'
name|'fake_delete_object'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'exc'
op|'.'
name|'append'
op|'('
name|'Exception'
op|'('
string|"'test exception'"
op|')'
op|')'
newline|'\n'
name|'raise'
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'delete_object'
op|'='
name|'fake_delete_object'
newline|'\n'
comment|'# Failure because of delete_object exception'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'True'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
string|"'1.2'"
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|','
nl|'\n'
name|'realm'
op|','
name|'realm_key'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_deletes'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'exc'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
op|')'
op|','
string|"'test exception'"
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_delete_object
name|'def'
name|'fake_delete_object'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'exc'
op|'.'
name|'append'
op|'('
name|'ClientException'
op|'('
string|"'test client exception'"
op|')'
op|')'
newline|'\n'
name|'raise'
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'delete_object'
op|'='
name|'fake_delete_object'
newline|'\n'
comment|'# Failure because of delete_object exception'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'True'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
string|"'1.2'"
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|','
nl|'\n'
name|'realm'
op|','
name|'realm_key'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_deletes'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'exc'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
op|')'
op|','
string|"'test client exception'"
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_delete_object
name|'def'
name|'fake_delete_object'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'exc'
op|'.'
name|'append'
op|'('
name|'ClientException'
op|'('
string|"'test client exception'"
op|','
nl|'\n'
name|'http_status'
op|'='
number|'404'
op|')'
op|')'
newline|'\n'
name|'raise'
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'delete_object'
op|'='
name|'fake_delete_object'
newline|'\n'
comment|"# Success because the object wasn't even found"
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'True'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
string|"'1.2'"
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|','
nl|'\n'
name|'realm'
op|','
name|'realm_key'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_deletes'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'exc'
op|')'
op|','
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
op|')'
op|','
string|"'test client exception: 404'"
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'uuid'
op|'='
name|'orig_uuid'
newline|'\n'
name|'sync'
op|'.'
name|'delete_object'
op|'='
name|'orig_delete_object'
newline|'\n'
nl|'\n'
DECL|member|test_container_sync_row_put
dedent|''
dedent|''
name|'def'
name|'test_container_sync_row_put'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_container_sync_row_put'
op|'('
name|'None'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_container_sync_row_put_using_realms
dedent|''
name|'def'
name|'test_container_sync_row_put_using_realms'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_container_sync_row_put'
op|'('
string|"'US'"
op|','
string|"'realm_key'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_container_sync_row_put
dedent|''
name|'def'
name|'_test_container_sync_row_put'
op|'('
name|'self'
op|','
name|'realm'
op|','
name|'realm_key'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'orig_uuid'
op|'='
name|'sync'
op|'.'
name|'uuid'
newline|'\n'
name|'orig_shuffle'
op|'='
name|'sync'
op|'.'
name|'shuffle'
newline|'\n'
name|'orig_put_object'
op|'='
name|'sync'
op|'.'
name|'put_object'
newline|'\n'
name|'try'
op|':'
newline|'\n'
DECL|class|FakeUUID
indent|'            '
name|'class'
name|'FakeUUID'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
DECL|class|uuid4
indent|'                '
name|'class'
name|'uuid4'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
DECL|variable|hex
indent|'                    '
name|'hex'
op|'='
string|"'abcdef'"
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'sync'
op|'.'
name|'uuid'
op|'='
name|'FakeUUID'
newline|'\n'
name|'sync'
op|'.'
name|'shuffle'
op|'='
name|'lambda'
name|'x'
op|':'
name|'x'
newline|'\n'
name|'ts_data'
op|'='
name|'Timestamp'
op|'('
number|'1.1'
op|')'
newline|'\n'
name|'timestamp'
op|'='
name|'Timestamp'
op|'('
number|'1.2'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_put_object
name|'def'
name|'fake_put_object'
op|'('
name|'sync_to'
op|','
name|'name'
op|'='
name|'None'
op|','
name|'headers'
op|'='
name|'None'
op|','
nl|'\n'
name|'contents'
op|'='
name|'None'
op|','
name|'proxy'
op|'='
name|'None'
op|','
name|'logger'
op|'='
name|'None'
op|','
nl|'\n'
name|'timeout'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'sync_to'
op|','
string|"'http://sync/to/path'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'name'
op|','
string|"'object'"
op|')'
newline|'\n'
name|'if'
name|'realm'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'headers'
op|','
op|'{'
nl|'\n'
string|"'x-container-sync-auth'"
op|':'
nl|'\n'
string|"'US abcdef a5fb3cf950738e6e3b364190e246bd7dd21dad3c'"
op|','
nl|'\n'
string|"'x-timestamp'"
op|':'
name|'timestamp'
op|'.'
name|'internal'
op|','
nl|'\n'
string|"'etag'"
op|':'
string|"'etagvalue'"
op|','
nl|'\n'
string|"'other-header'"
op|':'
string|"'other header value'"
op|','
nl|'\n'
string|"'content-type'"
op|':'
string|"'text/plain'"
op|'}'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'headers'
op|','
op|'{'
nl|'\n'
string|"'x-container-sync-key'"
op|':'
string|"'key'"
op|','
nl|'\n'
string|"'x-timestamp'"
op|':'
name|'timestamp'
op|'.'
name|'internal'
op|','
nl|'\n'
string|"'other-header'"
op|':'
string|"'other header value'"
op|','
nl|'\n'
string|"'etag'"
op|':'
string|"'etagvalue'"
op|','
nl|'\n'
string|"'content-type'"
op|':'
string|"'text/plain'"
op|'}'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'contents'
op|'.'
name|'read'
op|'('
op|')'
op|','
string|"'contents'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'proxy'
op|','
string|"'http://proxy'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'timeout'
op|','
number|'5.0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'logger'
op|','
name|'self'
op|'.'
name|'logger'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'put_object'
op|'='
name|'fake_put_object'
newline|'\n'
name|'expected_put_count'
op|'='
number|'0'
newline|'\n'
nl|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
op|'{'
op|'}'
op|','
name|'container_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
op|','
nl|'\n'
name|'logger'
op|'='
name|'self'
op|'.'
name|'logger'
op|')'
newline|'\n'
dedent|''
name|'cs'
op|'.'
name|'http_proxies'
op|'='
op|'['
string|"'http://proxy'"
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_get_object
name|'def'
name|'fake_get_object'
op|'('
name|'acct'
op|','
name|'con'
op|','
name|'obj'
op|','
name|'headers'
op|','
name|'acceptable_statuses'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'headers'
op|'['
string|"'X-Backend-Storage-Policy-Index'"
op|']'
op|','
nl|'\n'
string|"'0'"
op|')'
newline|'\n'
name|'return'
op|'('
number|'200'
op|','
nl|'\n'
op|'{'
string|"'other-header'"
op|':'
string|"'other header value'"
op|','
nl|'\n'
string|"'etag'"
op|':'
string|'\'"etagvalue"\''
op|','
nl|'\n'
string|"'x-timestamp'"
op|':'
name|'timestamp'
op|'.'
name|'internal'
op|','
nl|'\n'
string|"'content-type'"
op|':'
string|"'text/plain; swift_bytes=123'"
op|'}'
op|','
nl|'\n'
name|'iter'
op|'('
string|"'contents'"
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'cs'
op|'.'
name|'swift'
op|'.'
name|'get_object'
op|'='
name|'fake_get_object'
newline|'\n'
comment|'# Success as everything says it worked.'
nl|'\n'
comment|'# simulate a row with data at 1.1 and later ctype, meta times'
nl|'\n'
name|'created_at'
op|'='
name|'ts_data'
op|'.'
name|'internal'
op|'+'
string|"'+1388+1388'"
comment|'# last modified = 1.2'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
name|'created_at'
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|','
nl|'\n'
name|'realm'
op|','
name|'realm_key'
op|')'
op|')'
newline|'\n'
name|'expected_put_count'
op|'+='
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_puts'
op|','
name|'expected_put_count'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_get_object
name|'def'
name|'fake_get_object'
op|'('
name|'acct'
op|','
name|'con'
op|','
name|'obj'
op|','
name|'headers'
op|','
name|'acceptable_statuses'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'headers'
op|'['
string|"'X-Newest'"
op|']'
op|','
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'headers'
op|'['
string|"'X-Backend-Storage-Policy-Index'"
op|']'
op|','
nl|'\n'
string|"'0'"
op|')'
newline|'\n'
name|'return'
op|'('
number|'200'
op|','
nl|'\n'
op|'{'
string|"'date'"
op|':'
string|"'date value'"
op|','
nl|'\n'
string|"'last-modified'"
op|':'
string|"'last modified value'"
op|','
nl|'\n'
string|"'x-timestamp'"
op|':'
name|'timestamp'
op|'.'
name|'internal'
op|','
nl|'\n'
string|"'other-header'"
op|':'
string|"'other header value'"
op|','
nl|'\n'
string|"'etag'"
op|':'
string|'\'"etagvalue"\''
op|','
nl|'\n'
string|"'content-type'"
op|':'
string|"'text/plain; swift_bytes=123'"
op|'}'
op|','
nl|'\n'
name|'iter'
op|'('
string|"'contents'"
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'cs'
op|'.'
name|'swift'
op|'.'
name|'get_object'
op|'='
name|'fake_get_object'
newline|'\n'
comment|"# Success as everything says it worked, also checks 'date' and"
nl|'\n'
comment|"# 'last-modified' headers are removed and that 'etag' header is"
nl|'\n'
comment|'# stripped of double quotes.'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
name|'timestamp'
op|'.'
name|'internal'
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|','
nl|'\n'
name|'realm'
op|','
name|'realm_key'
op|')'
op|')'
newline|'\n'
name|'expected_put_count'
op|'+='
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_puts'
op|','
name|'expected_put_count'
op|')'
newline|'\n'
nl|'\n'
comment|'# Success as everything says it worked, also check that PUT'
nl|'\n'
comment|'# timestamp equals GET timestamp when it is newer than created_at'
nl|'\n'
comment|'# value.'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
string|"'1.1'"
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|','
nl|'\n'
name|'realm'
op|','
name|'realm_key'
op|')'
op|')'
newline|'\n'
name|'expected_put_count'
op|'+='
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_puts'
op|','
name|'expected_put_count'
op|')'
newline|'\n'
nl|'\n'
name|'exc'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_get_object
name|'def'
name|'fake_get_object'
op|'('
name|'acct'
op|','
name|'con'
op|','
name|'obj'
op|','
name|'headers'
op|','
name|'acceptable_statuses'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'headers'
op|'['
string|"'X-Newest'"
op|']'
op|','
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'headers'
op|'['
string|"'X-Backend-Storage-Policy-Index'"
op|']'
op|','
nl|'\n'
string|"'0'"
op|')'
newline|'\n'
name|'exc'
op|'.'
name|'append'
op|'('
name|'Exception'
op|'('
string|"'test exception'"
op|')'
op|')'
newline|'\n'
name|'raise'
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'cs'
op|'.'
name|'swift'
op|'.'
name|'get_object'
op|'='
name|'fake_get_object'
newline|'\n'
comment|'# Fail due to completely unexpected exception'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
name|'timestamp'
op|'.'
name|'internal'
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|','
nl|'\n'
name|'realm'
op|','
name|'realm_key'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_puts'
op|','
name|'expected_put_count'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'exc'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
op|')'
op|','
string|"'test exception'"
op|')'
newline|'\n'
nl|'\n'
name|'exc'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_get_object
name|'def'
name|'fake_get_object'
op|'('
name|'acct'
op|','
name|'con'
op|','
name|'obj'
op|','
name|'headers'
op|','
name|'acceptable_statuses'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'headers'
op|'['
string|"'X-Newest'"
op|']'
op|','
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'headers'
op|'['
string|"'X-Backend-Storage-Policy-Index'"
op|']'
op|','
nl|'\n'
string|"'0'"
op|')'
newline|'\n'
nl|'\n'
name|'exc'
op|'.'
name|'append'
op|'('
name|'ClientException'
op|'('
string|"'test client exception'"
op|')'
op|')'
newline|'\n'
name|'raise'
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'cs'
op|'.'
name|'swift'
op|'.'
name|'get_object'
op|'='
name|'fake_get_object'
newline|'\n'
comment|'# Fail due to all direct_get_object calls failing'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
name|'timestamp'
op|'.'
name|'internal'
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|','
nl|'\n'
name|'realm'
op|','
name|'realm_key'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_puts'
op|','
name|'expected_put_count'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'exc'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'exc'
op|'['
op|'-'
number|'1'
op|']'
op|')'
op|','
string|"'test client exception'"
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_get_object
name|'def'
name|'fake_get_object'
op|'('
name|'acct'
op|','
name|'con'
op|','
name|'obj'
op|','
name|'headers'
op|','
name|'acceptable_statuses'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'headers'
op|'['
string|"'X-Newest'"
op|']'
op|','
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'headers'
op|'['
string|"'X-Backend-Storage-Policy-Index'"
op|']'
op|','
nl|'\n'
string|"'0'"
op|')'
newline|'\n'
name|'return'
op|'('
number|'200'
op|','
op|'{'
string|"'other-header'"
op|':'
string|"'other header value'"
op|','
nl|'\n'
string|"'x-timestamp'"
op|':'
name|'timestamp'
op|'.'
name|'internal'
op|','
nl|'\n'
string|"'etag'"
op|':'
string|'\'"etagvalue"\''
op|'}'
op|','
nl|'\n'
name|'iter'
op|'('
string|"'contents'"
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_put_object
dedent|''
name|'def'
name|'fake_put_object'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'ClientException'
op|'('
string|"'test client exception'"
op|','
name|'http_status'
op|'='
number|'401'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'cs'
op|'.'
name|'swift'
op|'.'
name|'get_object'
op|'='
name|'fake_get_object'
newline|'\n'
name|'sync'
op|'.'
name|'put_object'
op|'='
name|'fake_put_object'
newline|'\n'
comment|'# Fail due to 401'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
name|'timestamp'
op|'.'
name|'internal'
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|','
nl|'\n'
name|'realm'
op|','
name|'realm_key'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_puts'
op|','
name|'expected_put_count'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertLogMessage'
op|'('
string|"'info'"
op|','
string|"'Unauth'"
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_put_object
name|'def'
name|'fake_put_object'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'ClientException'
op|'('
string|"'test client exception'"
op|','
name|'http_status'
op|'='
number|'404'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'put_object'
op|'='
name|'fake_put_object'
newline|'\n'
comment|'# Fail due to 404'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
name|'timestamp'
op|'.'
name|'internal'
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|','
nl|'\n'
name|'realm'
op|','
name|'realm_key'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_puts'
op|','
name|'expected_put_count'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertLogMessage'
op|'('
string|"'info'"
op|','
string|"'Not found'"
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_put_object
name|'def'
name|'fake_put_object'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'ClientException'
op|'('
string|"'test client exception'"
op|','
name|'http_status'
op|'='
number|'503'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'sync'
op|'.'
name|'put_object'
op|'='
name|'fake_put_object'
newline|'\n'
comment|'# Fail due to 503'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'cs'
op|'.'
name|'container_sync_row'
op|'('
nl|'\n'
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'object'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
name|'timestamp'
op|'.'
name|'internal'
op|'}'
op|','
string|"'http://sync/to/path'"
op|','
nl|'\n'
string|"'key'"
op|','
name|'FakeContainerBroker'
op|'('
string|"'broker'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'account'"
op|':'
string|"'a'"
op|','
string|"'container'"
op|':'
string|"'c'"
op|','
string|"'storage_policy_index'"
op|':'
number|'0'
op|'}'
op|','
nl|'\n'
name|'realm'
op|','
name|'realm_key'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'container_puts'
op|','
name|'expected_put_count'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertLogMessage'
op|'('
string|"'error'"
op|','
string|"'ERROR Syncing'"
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sync'
op|'.'
name|'uuid'
op|'='
name|'orig_uuid'
newline|'\n'
name|'sync'
op|'.'
name|'shuffle'
op|'='
name|'orig_shuffle'
newline|'\n'
name|'sync'
op|'.'
name|'put_object'
op|'='
name|'orig_put_object'
newline|'\n'
nl|'\n'
DECL|member|test_select_http_proxy_None
dedent|''
dedent|''
name|'def'
name|'test_select_http_proxy_None'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'        '
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
nl|'\n'
op|'{'
string|"'sync_proxy'"
op|':'
string|"''"
op|'}'
op|','
name|'container_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'select_http_proxy'
op|'('
op|')'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_select_http_proxy_one
dedent|''
name|'def'
name|'test_select_http_proxy_one'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'        '
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
nl|'\n'
op|'{'
string|"'sync_proxy'"
op|':'
string|"'http://one'"
op|'}'
op|','
name|'container_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cs'
op|'.'
name|'select_http_proxy'
op|'('
op|')'
op|','
string|"'http://one'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_select_http_proxy_multiple
dedent|''
name|'def'
name|'test_select_http_proxy_multiple'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'        '
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'swift.container.sync.InternalClient'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'cs'
op|'='
name|'sync'
op|'.'
name|'ContainerSync'
op|'('
nl|'\n'
op|'{'
string|"'sync_proxy'"
op|':'
string|"'http://one,http://two,http://three'"
op|'}'
op|','
nl|'\n'
name|'container_ring'
op|'='
name|'FakeRing'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'set'
op|'('
name|'cs'
op|'.'
name|'http_proxies'
op|')'
op|','
nl|'\n'
name|'set'
op|'('
op|'['
string|"'http://one'"
op|','
string|"'http://two'"
op|','
string|"'http://three'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'__name__'
op|'=='
string|"'__main__'"
op|':'
newline|'\n'
indent|'    '
name|'unittest'
op|'.'
name|'main'
op|'('
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit
